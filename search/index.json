[{"content":"æ¯›ç»ç’ƒé£è¿‡æ•ˆæœ ä¸»è½¨é“å¯¼å…¥ä¸€æ®µè§†é¢‘ç´ æï¼Œç„¶åå¤åˆ¶ä¸»è½¨é“çš„ç´ æï¼Œæ¥ç€å°†å¤åˆ¶çš„ç‰‡æ®µï¼Œè®¾ç½®ä¸ºç”»ä¸­ç”»è½¨é“ã€‚ å°†ç”»ä¸­ç”»è½¨é“çš„è’™å±‚è®¾ç½®ä¸ºé•œé¢ã€‚å°†ä¸»è½¨é“çš„è§†é¢‘çš„é¥±å’Œåº¦è®¾ç½®åˆ°æœ€ä½ã€‚ å°†ç”»ä¸­ç”»è§†é¢‘çš„è’™å±‚é•œé¢çš„è§’åº¦è®¾ç½®ä¸ºåˆé€‚ä½ç½®ã€‚ç„¶åç»™è§†é¢‘ä¸åŒçš„ä½ç½®ï¼Œåˆ†åˆ«æ‹–åŠ¨é•œé¢ä½ç½®ï¼Œç„¶åæ‰“ä¸Šå…³é”®å¸§ä¿¡æ¯ã€‚ æ­¤æ—¶å¯¹ç”»ä¸­ç”»è§†é¢‘æ”¹å˜é€Ÿåº¦ï¼Œè®¾ç½®ä¸æ˜¯åŒ€é€Ÿã€‚ å¤åˆ¶ç”»ä¸­ç”»è§†é¢‘ï¼Œç„¶åå°†å¤åˆ¶å‡ºæ¥çš„è§†é¢‘æ‹–åˆ°ä¸‹é¢è½¨é“å¯¹é½ã€‚ å°†è¢«å¤åˆ¶å‡ºæ¥çš„è§†é¢‘è¿›è¡Œæ›¿æ¢ï¼Œä½¿ç”¨ä¸€ä¸ªé»‘è‰²è§†é¢‘ï¼Œç„¶åå¯¹é»‘è‰²è§†é¢‘çš„å…³é”®å¸§ä½ç½®éƒ½è¿›è¡Œç¾½åŒ–è°ƒæ•´ã€‚ æ–°å¢ä¸€ä¸ªé»‘è‰²è§†é¢‘çš„ç”»ä¸­ç”»è½¨é“ï¼Œå¯¹è¯¥é»‘è‰²è§†é¢‘è®¾ç½®è’™ç‰ˆä¸ºé•œé¢ï¼Œç„¶ååè½¬ä¸‹ï¼Œå°†èŒƒå›´æ‰©å¤§åˆ°é€‚å½“ä½ç½®ã€‚ æœ€åç‚¹å‡»å›¾å±‚ï¼Œå°†ç¬¬äºŒæ­¥åˆ›å»ºçš„ç”»ä¸­ç”»è½¨é“è®¾ç½®åˆ°æœ€å‰é¢ã€‚ ","date":"2026-01-17T22:58:23+08:00","permalink":"http://xiangcman.xyz/p/%E5%89%AA%E6%98%A0%E4%BD%BF%E7%94%A8%E6%80%BB%E7%BB%93/","title":"å‰ªæ˜ ä½¿ç”¨æ€»ç»“"},{"content":"Perfettoä¸­è§‚å¯Ÿçº¿ç¨‹çš„çŠ¶æ€å˜åŒ–å¯ä»¥çŸ¥é“çº¿ç¨‹ï¼ˆä¸»çº¿ç¨‹20566ï¼‰åˆ°åº•å‘ç”Ÿäº†ä»€ä¹ˆï¼Œé¦–å…ˆæ¥çœ‹ä¸‹Perfettoä¸­çº¿ç¨‹çŠ¶æ€è°ƒåº¦é—®é¢˜ã€‚\nsleepæ¡ˆä¾‹ä¸€åˆ†æï¼š å¯ä»¥çœ‹åˆ°è¯¥çº¿ç¨‹æ˜¯è¢«20672æŒæœ‰äº†é”ï¼Œå¯ä»¥æ‰¾åˆ°20672è¿™ä¸ªçº¿ç¨‹åœ¨è¯¥é˜¶æ®µåšäº†ä»€ä¹ˆã€‚\nåœ¨20672çº¿ç¨‹ä¸­ï¼Œä¹Ÿæ˜¯è¢«å…¶å®ƒçº¿ç¨‹å ç”¨äº†é”ï¼Œå®ƒæ˜¯è¢«20671çº¿ç¨‹æŒæœ‰äº†é”ï¼Œè€Œ20671çº¿ç¨‹å®ƒåœ¨ç­‰å¾…HandlerThreadä¸­çš„looperåˆ›å»ºï¼Œæ‰€ä»¥å®ƒä¹Ÿä¼šsleepã€‚workHandlerçº¿ç¨‹(20673)ä¹Ÿå°±æ˜¯åˆšHandlerThreadä¸­æŒ‡å®šçš„çº¿ç¨‹åï¼Œè€ŒworkHandlerçº¿ç¨‹(20673)å®ƒæ˜¯è¢«20672æŒæœ‰äº†é”ã€‚ å½“çº¿ç¨‹å‘ç”Ÿäº†sleepæ—¶å€™ï¼Œè§‚å¯Ÿå½“å‰sleepçº¿ç¨‹åé¢çš„runnableçŠ¶æ€ï¼Œå®ƒè¡¨ç¤ºå½“å‰çº¿ç¨‹å³å°†è¢«cpuè°ƒåº¦ã€‚åœ¨runnableé¢æ¿ä¸­å¯ä»¥çœ‹åˆ°Woken by (maybe interrupt)æ˜¯è¢«è°å”¤èµ·çš„ï¼Œå¯ä»¥ç›´æ¥ç‚¹è¿‡å»ï¼š ä»ä¸»çº¿ç¨‹ï¼ˆ20566ï¼‰çš„sleepçŠ¶æ€çš„woken byä¿¡æ¯ä¸­çœ‹åˆ°å®ƒæ˜¯è¢«workHnadler(20673)æ‰€å”¤é†’çš„ã€‚ç»è¿‡ä¸Šé¢çš„åˆ†æï¼Œæœ€ç»ˆæ˜¯ç”±äº20671ä¸­åˆ›å»ºäº†HandlerThreadå¯¼è‡´ä¸»çº¿ç¨‹sleepäº†4msã€‚ å¦‚æœæƒ³é€šè¿‡å„ä¸ªçŠ¶æ€è¿æ¥æ¥çœ‹çš„è¯ï¼Œå¯ä»¥é€šè¿‡ç‚¹å‡»ä¸»çº¿ç¨‹20566çš„sleepçŠ¶æ€è¯¦ç»†é¢æ¿ä¸­çš„Critical path liteæŸ¥çœ‹å„ä¸ªçº¿ç¨‹çš„è¿è¡Œè¿æ¥æƒ…å†µã€‚ sleepæ¡ˆä¾‹äºŒåˆ†æï¼š è¿™é‡Œæœ‰2msçš„sleepçŠ¶æ€ï¼Œç‚¹å‡»å®ƒåé¢çš„runnableçŠ¶æ€èƒ½çœ‹åˆ°å®ƒæ˜¯è¢«è°å”¤é†’çš„ï¼š å¯ä»¥çœ‹åˆ°å®ƒæ˜¯è¢«ConnecttivityThrçº¿ç¨‹å”¤é†’çš„ï¼Œç‚¹å‡»è¯¥çº¿ç¨‹èƒ½çŸ¥é“å®ƒåœ¨å¹²ä»€ä¹ˆï¼Œä¸Šé¢çš„3msçš„sleepæ˜¯å› ä¸ºçº¿ç¨‹ä¸€ç›´åœ¨è¢«HandlerThreadç»™é˜»å¡ä½äº†ï¼š åœ¨è¿™æ®µæ—¶é—´å†…ï¼Œä¸Šå±‚çº¿ç¨‹ç­‰å¾…ConnectivityThread(HandlerThread)çš„Looperåˆ›å»ºã€‚æ‰€ä»¥åœ¨ä¸Šé¢çº¿ç¨‹ä¸­sleepäº†2msã€‚ sleepæ¡ˆä¾‹ä¸‰åˆ†æï¼š è¿™ä¸ªçº¿ç¨‹åœ¨runnableçŠ¶æ€çš„æ—¶å€™ï¼Œæ˜¯system_serverè¿›ç¨‹ä¸­çš„binderçº¿ç¨‹å”¤é†’çš„çº¿ç¨‹ã€‚ç‚¹åˆ°å¯¹åº”çš„çº¿ç¨‹ç¡®å®å‘ç°åœ¨binder replyè°ƒç”¨ï¼š é€šè¿‡è¯¦ç»†é¢æ¿ä¸­çš„binder transactionèƒ½æ‰¾åˆ°å¯¹åº”çš„clientè°ƒç”¨ï¼š é€šè¿‡btraceçš„sliceä¹Ÿèƒ½è§‚å¯Ÿåˆ°å½“å‰çš„transactionå‘ç”Ÿäº†ä»€ä¹ˆï¼š å®ƒæ˜¯å®¢æˆ·ç«¯ç½‘ç»œç›‘å¬çš„binderè°ƒç”¨ã€‚ sleepæ¡ˆä¾‹å››åˆ†æï¼š æ­¤å¤„å¯ä»¥çœ‹åˆ°çº¿ç¨‹å‡ºç°äº†å¤§æ®µçš„sleepäº†ï¼Œæ˜¯ç”±äºçº¿ç¨‹è¢«CountDownLatchçš„awaitæ–¹æ³•é˜»å¡ä½äº†ï¼Œç‚¹å‡»çº¿ç¨‹çš„sleepçŠ¶æ€åé¢çš„runnableçœ‹ä¸‹æ˜¯è°å”¤é†’çš„ï¼Œç„¶åé€šè¿‡critical path liteèƒ½æ‰¾åˆ°çº¿ç¨‹è°ƒç”¨çš„é¡ºåºã€‚ Uninterruptible Sleep (non-IO)çŠ¶æ€åˆ†æï¼š ä¸å¯ä¸­æ–­ç¡çœ ï¼Œä½†ä¸æ˜¯ç”±I/Oæ“ä½œå¼•èµ·çš„ã€‚ä¸å¯ä¸­æ–­çš„æ„æ€æ˜¯ä¸å¯è¢«ä¿¡å·ï¼ˆSIGKILLé™¤å¤–ï¼‰å”¤é†’ï¼Œå¿…é¡»ç­‰å¾…å†…æ ¸æ“ä½œå®Œæˆï¼Œä¿è¯å†…æ ¸æ•°æ®ä¸€è‡´æ€§ã€‚å¸¸è§åœ¨æˆ‘ä»¬pthread_createæ–¹æ³•ä¼šè¿›å…¥è¯¥çŠ¶æ€ï¼š ä¸ºä»€ä¹ˆpthread_createä¼šè¿›å…¥è¯¥çŠ¶æ€ï¼Ÿ å¯ä»¥çœ‹å‡ºæ¥å½“è°ƒç”¨pthread_createçš„çº¿ç¨‹ä¼šè¿›å…¥åˆ°å†…æ ¸æ€çš„é˜»å¡ã€‚ç­‰å¾…è°ƒåº¦å™¨å”¤é†’æ–°çº¿ç¨‹ã€‚ ","date":"2026-01-08T14:45:24+08:00","permalink":"http://xiangcman.xyz/p/perfetto%E7%BA%BF%E7%A8%8B%E7%8A%B6%E6%80%81%E8%B7%9F%E8%B8%AA/","title":"Perfettoçº¿ç¨‹çŠ¶æ€è·Ÿè¸ª"},{"content":"è·å–è§†é¢‘çš„åˆ†è¾¨ç‡ 1 2 3 4 5 ffprobe -v error \\ -select_streams v:0 \\ -show_entries stream=width,height \\ -of csv=p=0 \\ 2-PNA.mp4 ffprobeæ˜¯é€šè¿‡homebrewå®‰è£…çš„ï¼Œå®ƒä¼šè¾“å‡ºè§†é¢‘çš„åˆ†è¾¨ç‡ã€‚\nå°†è§†é¢‘è½¬åŒ–æˆéŸ³é¢‘ ffmpeg -i input_video.mp4 -vn -acodec mp3 output_audio.mp3\nè·å–è§†é¢‘å¸§ ffmpeg -i è§†é¢‘è·¯å¾„ -vf \u0026ldquo;fps=1\u0026rdquo; è¾“å‡ºçš„å›¾ç‰‡è·¯å¾„\nyt-dlpï¼šè§†é¢‘ä¸‹è½½ å®ƒæ˜¯é€šè¿‡pythonçš„pipå·¥å…·è¿›è¡Œå®‰è£…ã€‚å®˜ç½‘ï¼šhttps://github.com/yt-dlp/yt-dlpï¼Œå…³äºoptionså¯ä»¥çœ‹ä»‹ç»ï¼Œä»¥åŠåœ¨pythonä¸­å¦‚ä½•é…ç½®å‚æ•°ï¼Œå¯ä»¥çœ‹ï¼šhttps://github.com/yt-dlp/yt-dlp/blob/master/yt_dlp/options.py 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 import yt_dlp url = \u0026#34;***\u0026#34;# æŒ‡å®šè¦ä¸‹è½½çš„urlï¼Œå¦‚æœæ˜¯ä¸€ä¸ªåˆé›†çš„urlï¼Œåœ¨ä¸‹è½½çš„æ—¶å€™æ²¡æœ‰æŒ‡å®šæŸä¸€é›†ï¼Œä¼šä¸‹è½½æ‰€æœ‰çš„é›†æ•° ydl_opts = { \u0026#39;playlist_items\u0026#39;: \u0026#39;14\u0026#39;,#æŒ‡å®šä¸‹è½½æŸä¸€é›†,ä¹Ÿå¯ä»¥æŒ‡å®šä¸‹è½½èŒƒå›´ï¼Œåªæœ‰urlä¸ºåˆé›†çš„æ—¶å€™æ‰èµ·ä½œç”¨ \u0026#39;cookiefile\u0026#39;: \u0026#39;cookies.txt\u0026#39;,#æŒ‡å®šcookieæ–‡ä»¶ï¼Œä¸€èˆ¬googleæµè§ˆå™¨é€šè¿‡å®‰è£…get cookies.txtæ’ä»¶ï¼Œæ–¹ä¾¿ä¸‹è½½ä¼šå‘˜è§†é¢‘ \u0026#39;outtmpl\u0026#39;: \u0026#39;è¦ä¸‹è½½çš„çˆ¶æ–‡ä»¶å¤¹/%(playlist_index)02d - %(title)s.%(ext)s\u0026#39;,#æŒ‡å®šä¸‹è½½çš„è·¯å¾„å’Œåå­— \u0026#39;format\u0026#39;: \u0026#39;bestvideo+bestaudio/best\u0026#39;,#æŒ‡å®šä¸‹è½½çš„è§†é¢‘åˆ†è¾¨ç‡å’ŒéŸ³é¢‘çš„é‡‡æ ·ç‡ï¼Œè¿™é‡Œå¦‚æœéŸ³é¢‘å’Œè§†é¢‘åˆ†å¼€çš„ï¼Œå¯ä»¥åªä¸‹è½½éŸ³é¢‘æˆ–è§†é¢‘ \u0026#39;concurrent_fragment_downloads\u0026#39;: 8,#æŒ‡å®šå•é›†ä¸‹è½½çš„çº¿ç¨‹ä¸ªæ•° \u0026#39;ignoreerrors\u0026#39;: True,#æ˜¯å¦å¿½ç•¥ä¸‹è½½å¤±è´¥åç»§ç»­ä¸‹è½½ \u0026#39;merge_output_format\u0026#39;: \u0026#39;mp4\u0026#39;,#æŒ‡å®šéŸ³é¢‘å’Œè§†é¢‘åˆå¹¶åçš„è§†é¢‘ç±»å‹ } with yt_dlp.YoutubeDL(ydl_opts) as ydl: ydl.download([url]) yt-dlp -F urlï¼šå¯ä»¥æŸ¥çœ‹èµ„æºæ”¯æŒå“ªäº›æ ¼å¼ï¼Œæœ‰äº›è§†é¢‘ä¸æ”¯æŒè§†é¢‘å’ŒéŸ³é¢‘åˆ†å¼€ã€‚ æ°´å°å¤„ç†ï¼ˆPython+OpenCVï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 import cv2 import numpy as np from pathlib import Path def get_watermark_coordinates(video_file, frame_number=0): \u0026#34;\u0026#34;\u0026#34; äº¤äº’å¼è·å–æ°´å°åæ ‡ å‚æ•°: video_file: è§†é¢‘æ–‡ä»¶è·¯å¾„ frame_number: è¦åˆ†æçš„å¸§å·ï¼ˆé»˜è®¤ç¬¬ä¸€å¸§ï¼‰ è¿”å›: (x, y, width, height) æˆ– None \u0026#34;\u0026#34;\u0026#34; cap = cv2.VideoCapture(video_file) if not cap.isOpened(): print(f\u0026#34;âŒ æ— æ³•æ‰“å¼€è§†é¢‘: {video_file}\u0026#34;) return None # è·³è½¬åˆ°æŒ‡å®šå¸§ cap.set(cv2.CAP_PROP_POS_FRAMES, frame_number) ret, frame = cap.read() cap.release() if not ret: print(\u0026#34;âŒ æ— æ³•è¯»å–å¸§\u0026#34;) return None # æ˜¾ç¤ºè§†é¢‘ä¿¡æ¯ total_frames = int(cap.get(cv2.CAP_PROP_FRAME_COUNT)) fps = cap.get(cv2.CAP_PROP_FPS) width = int(cap.get(cv2.CAP_PROP_FRAME_WIDTH)) height = int(cap.get(cv2.CAP_PROP_FRAME_HEIGHT)) print(f\u0026#34;è§†é¢‘ä¿¡æ¯: {width}x{height}, {total_frames}å¸§, {fps:.2f}fps\u0026#34;) print(f\u0026#34;å½“å‰å¸§: {frame_number}/{total_frames}\u0026#34;) print(\u0026#34;\\næ“ä½œè¯´æ˜:\u0026#34;) print(\u0026#34;1. åœ¨çª—å£ä¸­æ‹–æ‹½é¼ æ ‡é€‰æ‹©æ°´å°åŒºåŸŸ\u0026#34;) print(\u0026#34;2. æŒ‰ Enter ç¡®è®¤\u0026#34;) print(\u0026#34;3. æŒ‰ ESC å–æ¶ˆ\u0026#34;) # é€‰æ‹© ROIï¼ˆRegion of Interestï¼‰ roi = cv2.selectROI(\u0026#39;é€‰æ‹©æ°´å°åŒºåŸŸ (æŒ‰ Enter ç¡®è®¤, ESC å–æ¶ˆ)\u0026#39;, frame, False) cv2.destroyAllWindows() if roi[2] \u0026gt; 0 and roi[3] \u0026gt; 0: x, y, w, h = roi print(f\u0026#34;\\nâœ… æ°´å°åæ ‡:\u0026#34;) print(f\u0026#34; x (å·¦ä¸Šè§’X): {x}\u0026#34;) print(f\u0026#34; y (å·¦ä¸Šè§’Y): {y}\u0026#34;) print(f\u0026#34; width (å®½åº¦): {w}\u0026#34;) print(f\u0026#34; height (é«˜åº¦): {h}\u0026#34;) print(f\u0026#34;\\nFFmpeg å‘½ä»¤:\u0026#34;) print(f\u0026#39; ffmpeg -i \u0026#34;{video_file}\u0026#34; -vf \u0026#34;delogo=x={x}:y={y}:w={w}:h={h}\u0026#34; output.mp4\u0026#39;) return (x, y, w, h) else: print(\u0026#34;âŒ æœªé€‰æ‹©åŒºåŸŸ\u0026#34;) return None def get_multiple_watermarks(video_file, frame_number=0): \u0026#34;\u0026#34;\u0026#34; é€‰æ‹©å¤šä¸ªæ°´å°åŒºåŸŸ \u0026#34;\u0026#34;\u0026#34; cap = cv2.VideoCapture(video_file) cap.set(cv2.CAP_PROP_POS_FRAMES, frame_number) ret, frame = cap.read() cap.release() if not ret: return [] watermarks = [] frame_copy = frame.copy() print(\u0026#34;é€‰æ‹©æ°´å°åŒºåŸŸï¼ˆå¯ä»¥å¤šæ¬¡é€‰æ‹©ï¼‰\u0026#34;) print(\u0026#34;æŒ‰ Enter ç¡®è®¤å½“å‰é€‰æ‹©ï¼ŒæŒ‰ ESC å®Œæˆæ‰€æœ‰é€‰æ‹©\u0026#34;) while True: roi = cv2.selectROI(\u0026#39;é€‰æ‹©æ°´å°åŒºåŸŸ (Enterç¡®è®¤, ESCå®Œæˆ)\u0026#39;, frame_copy, False) if roi[2] \u0026gt; 0 and roi[3] \u0026gt; 0: x, y, w, h = roi watermarks.append((x, y, w, h)) # åœ¨å›¾åƒä¸Šæ ‡è®°å·²é€‰æ‹©çš„åŒºåŸŸ cv2.rectangle(frame_copy, (x, y), (x+w, y+h), (0, 255, 0), 2) cv2.putText(frame_copy, f\u0026#34;#{len(watermarks)}\u0026#34;, (x, y-10), cv2.FONT_HERSHEY_SIMPLEX, 0.7, (0, 255, 0), 2) print(f\u0026#34;âœ… å·²é€‰æ‹©æ°´å° #{len(watermarks)}: x={x}, y={y}, w={w}, h={h}\u0026#34;) else: break cv2.destroyAllWindows() return watermarks # ä½¿ç”¨ç¤ºä¾‹ if __name__ == \u0026#34;__main__\u0026#34;: video_file = \u0026#34;input.mp4\u0026#34; # è·å–å•ä¸ªæ°´å°åæ ‡ coords = get_watermark_coordinates(video_file, frame_number=0) # è·å–å¤šä¸ªæ°´å°åæ ‡ # watermarks = get_multiple_watermarks(video_file) # for i, (x, y, w, h) in enumerate(watermarks, 1): # print(f\u0026#34;æ°´å° {i}: x={x}, y={y}, w={w}, h={h}\u0026#34;) æ‰§è¡Œä¸Šé¢çš„pythonåï¼Œæ¥ç€ä¼šå¼¹å‡ºäº¤äº’å¼ç•Œé¢ï¼Œæ­¤æ—¶é€‰ä¸­æ°´å°ï¼Œç„¶åå°±ä¼šè¾“å‡ºåæ ‡ä¿¡æ¯ï¼š\n1 2 3 4 5 6 7 8 âœ… æ°´å°åæ ‡: x (å·¦ä¸Šè§’X): 1115 y (å·¦ä¸Šè§’Y): 45 width (å®½åº¦): 333 height (é«˜åº¦): 77 FFmpeg å‘½ä»¤: ffmpeg -i \u0026#34;input.mp4\u0026#34; -vf \u0026#34;delogo=x=1115:y=45:w=333:h=77\u0026#34; output.mp4 æ¥ç€æˆ‘ä»¬æ‰§è¡Œè¯¥ffmpegå‘½ä»¤å°±è¡Œï¼Œä¼šè¾“å‡ºä¸å¸¦æ°´å°çš„è§†é¢‘ã€‚\næ‰¹é‡å»æ°´å° å¦‚æœæƒ³ç»™æŸä¸ªæ–‡ä»¶å¤¹ä¸­çš„è§†é¢‘æ‰¹é‡å»æ°´å°ï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹æ¡ˆä¾‹:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 import subprocess from pathlib import Path # ===== é…ç½®åŒº ===== INPUT_DIR = Path(\u0026#34;ä½ è¦å»æ°´å°çš„ç›®å½•\u0026#34;) OUTPUT_DIR = Path(\u0026#34;è¾“å‡ºå»æ°´å°çš„è§†é¢‘ç›®å½•\u0026#34;) DELOGO_FILTER = \u0026#34;delogo=x=2505:y=108:w=338:h=130\u0026#34; VIDEO_EXTS = {\u0026#34;.mp4\u0026#34;, \u0026#34;.mkv\u0026#34;, \u0026#34;.mov\u0026#34;, \u0026#34;.avi\u0026#34;} # æ”¯æŒçš„è§†é¢‘æ ¼å¼ # ================= def remove_logo(input_video: Path, output_video: Path): cmd = [ \u0026#34;ffmpeg\u0026#34;, \u0026#34;-y\u0026#34;, # è¦†ç›–è¾“å‡ºæ–‡ä»¶ \u0026#34;-i\u0026#34;, str(input_video), \u0026#34;-vf\u0026#34;, DELOGO_FILTER, \u0026#34;-c:a\u0026#34;, \u0026#34;copy\u0026#34;, # éŸ³é¢‘ä¸é‡æ–°ç¼–ç ï¼ˆæ›´å¿«ï¼‰ str(output_video) ] print(f\u0026#34;ğŸ¬ å¤„ç†: {input_video.name}\u0026#34;) subprocess.run(cmd, check=True) def main(): OUTPUT_DIR.mkdir(parents=True, exist_ok=True) videos = [ p for p in INPUT_DIR.iterdir() if p.suffix.lower() in VIDEO_EXTS and p.is_file() ] if not videos: print(\u0026#34;âŒ æœªæ‰¾åˆ°è§†é¢‘æ–‡ä»¶\u0026#34;) return for video in sorted(videos): output_path = OUTPUT_DIR / video.name remove_logo(video, output_path) print(\u0026#34;âœ… å…¨éƒ¨è§†é¢‘å¤„ç†å®Œæˆ\u0026#34;) if __name__ == \u0026#34;__main__\u0026#34;: main() è§†é¢‘æå–åŸå£°/BGM/å»æ‰äººå£°ç­‰ é¦–å…ˆéœ€è¦å®‰è£…demucsçš„è™šæ‹Ÿç¯å¢ƒï¼Œå®‰è£…è™šæ‹Ÿç¯å¢ƒéœ€è¦ç”¨åˆ°pyenvï¼Œé¦–å…ˆå®‰è£…pyenvï¼š\n1 brew install pyenv ç„¶åå½•é…ç½®pyenvçš„pathè·¯å¾„ï¼Œåœ¨zshrcæˆ–bashä¸­é…ç½®ï¼š\n1 2 3 export PYENV_ROOT=\u0026#34;$HOME/.pyenv\u0026#34; export PATH=\u0026#34;$PYENV_ROOT/bin:$PATH\u0026#34; eval \u0026#34;$(pyenv init -)\u0026#34; ç„¶ååŒæ­¥ä¸‹é…ç½®:source ~/.zshrcã€‚ ç„¶åå®‰è£…è™šæ‹Ÿç¯å¢ƒçš„pythonç‰ˆæœ¬ï¼š\n1 pyenv install 3.10.14 æ¥ç€éœ€è¦å®‰è£…pyenv-virtualenvç”¨äºæŒ‡å®šè™šæ‹Ÿç¯å¢ƒçš„åå­—ï¼š\n1 brew install pyenv-virtualenv ç„¶åç»™pyenv-virtualenvæ·»åŠ ä¸Šç¯å¢ƒå˜é‡ï¼š\n1 eval \u0026#34;$(pyenv virtualenv-init -)\u0026#34; æ¥ç€æŒ‡å®šè™šæ‹Ÿç¯å¢ƒçš„åå­—å’Œæ¿€æ´»è™šæ‹Ÿç¯å¢ƒï¼š\n1 2 pyenv virtualenv 3.10.14 demucs-env\\ pyenv activate demucs-env æ­¤æ—¶å°±æ¿€æ´»äº†è™šæ‹Ÿç¯å¢ƒdemucs-envï¼Œæ­¤æ—¶åœ¨å‘½ä»¤è¡Œä¸­èƒ½çœ‹åˆ°è™šæ‹Ÿç¯å¢ƒçš„åå­—ï¼Œå¦‚æœè¦æ–­å¼€è™šæ‹Ÿç¯å¢ƒä½¿ç”¨:pyenv deactivate demucs-envã€‚ æ¥ç€è¦è£…ç›¸å…³çš„ä¾èµ–ç»„ä»¶ï¼Œåˆ†åˆ«æ˜¯ï¼š\n1 2 3 4 pip install numpy==1.26.4 pip install torch==2.2.2 torchaudio==2.2.2 pip install demucs pip install torchcodec å¦‚æœç»ˆç«¯è¿˜æ˜¯è¯†åˆ«ä¸äº†ï¼Œå¯ä»¥åˆ·æ–°ä¸‹ç»ˆç«¯:\n1 hash -r æ­¤æ—¶è¿˜éœ€è¦ffmpegï¼Œè¿™ä¸ªå¯ä»¥é€šè¿‡brew install ffmpegè¿›è¡Œå®‰è£…ã€‚æ‰€æœ‰å®‰è£…å®Œæˆåï¼Œæœ€ååŒæ­¥ä¸‹å‘½ä»¤ï¼šhash -rã€‚è¿™æ ·pythonçš„è™šæ‹Ÿç¯å¢ƒå°±å®‰è£…å®Œæˆäº†ã€‚ æ­¤æ—¶å¯ä»¥é€šè¿‡python3 video_audio_example.py 2å»æ‰§è¡Œå„ç§åŠŸèƒ½ã€‚åŠŸèƒ½éƒ½åœ¨ä¸¤ä¸ªpythonäº‹ä¾‹æ–‡ä»¶å’ŒpythonåŠŸèƒ½æ–‡ä»¶ä¸­ã€‚\nå¸¸ç”¨demucsçš„å‘½ä»¤ï¼š\n1 demucs --two-stems=vocals éŸ³é¢‘è·¯å¾„ æ­¤æ—¶ä¼šåˆ†ç¦»å‡ºéŸ³é¢‘çš„äººå£°å’Œbgmã€‚\nå›¾ç‰‡æ¨¡ç³Šå¤„ç† ç›®å‰å·²çŸ¥çš„é€šè¿‡å¯è§†åŒ–æ·»åŠ æ¨¡ç³Šæ•ˆæœçš„æœ‰tkinterå·¥å…·ï¼Œå…·ä½“å¯è§ä¸‹é¢çš„å®ç°ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 import tkinter as tk from tkinter import filedialog, messagebox, Scale from PIL import Image, ImageTk, ImageFilter, ImageDraw import numpy as np class BlurRegionGUI: \u0026#34;\u0026#34;\u0026#34;å¯è§†åŒ–æ¨¡ç³ŠåŒºåŸŸé€‰æ‹© GUI\u0026#34;\u0026#34;\u0026#34; def __init__(self, root): self.root = root self.root.title(\u0026#34;å›¾ç‰‡åŒºåŸŸæ¨¡ç³Šå·¥å…·\u0026#34;) self.root.geometry(\u0026#34;1200x800\u0026#34;) self.image_path = None self.original_image = None self.display_image = None self.regions = [] # [(x1, y1, x2, y2), ...] self.current_region = None self.start_x = None self.start_y = None self.blur_radius = 15 self.setup_ui() def setup_ui(self): \u0026#34;\u0026#34;\u0026#34;è®¾ç½®UIç•Œé¢\u0026#34;\u0026#34;\u0026#34; # é¡¶éƒ¨æŒ‰é’®æ  button_frame = tk.Frame(self.root) button_frame.pack(pady=10) tk.Button(button_frame, text=\u0026#34;æ‰“å¼€å›¾ç‰‡\u0026#34;, command=self.load_image, width=15, height=2).pack(side=tk.LEFT, padx=5) tk.Button(button_frame, text=\u0026#34;åº”ç”¨æ¨¡ç³Š\u0026#34;, command=self.apply_blur, width=15, height=2).pack(side=tk.LEFT, padx=5) tk.Button(button_frame, text=\u0026#34;é‡ç½®\u0026#34;, command=self.reset_image, width=15, height=2).pack(side=tk.LEFT, padx=5) tk.Button(button_frame, text=\u0026#34;ä¿å­˜\u0026#34;, command=self.save_image, width=15, height=2).pack(side=tk.LEFT, padx=5) tk.Button(button_frame, text=\u0026#34;æ¸…é™¤é€‰æ‹©\u0026#34;, command=self.clear_regions, width=15, height=2).pack(side=tk.LEFT, padx=5) # æ¨¡ç³ŠåŠå¾„è°ƒèŠ‚ radius_frame = tk.Frame(self.root) radius_frame.pack(pady=5) tk.Label(radius_frame, text=\u0026#34;æ¨¡ç³ŠåŠå¾„:\u0026#34;).pack(side=tk.LEFT, padx=5) self.radius_scale = Scale(radius_frame, from_=1, to=50, orient=tk.HORIZONTAL, length=200, command=self.update_blur_radius) self.radius_scale.set(15) self.radius_scale.pack(side=tk.LEFT, padx=5) self.radius_label = tk.Label(radius_frame, text=\u0026#34;15\u0026#34;) self.radius_label.pack(side=tk.LEFT, padx=5) # è¯´æ˜æ–‡å­— info_label = tk.Label(self.root, text=\u0026#34;æ“ä½œè¯´æ˜: é¼ æ ‡å·¦é”®æ‹–æ‹½é€‰æ‹©åŒºåŸŸï¼Œå¯ä»¥å¤šæ¬¡é€‰æ‹©å¤šä¸ªåŒºåŸŸ\u0026#34;, font=(\u0026#34;Arial\u0026#34;, 10)) info_label.pack(pady=5) # å›¾ç‰‡æ˜¾ç¤ºåŒºåŸŸ canvas_frame = tk.Frame(self.root) canvas_frame.pack(fill=tk.BOTH, expand=True, padx=10, pady=10) self.canvas = tk.Canvas(canvas_frame, bg=\u0026#34;gray\u0026#34;, cursor=\u0026#34;crosshair\u0026#34;) self.canvas.pack(fill=tk.BOTH, expand=True) # ç»‘å®šé¼ æ ‡äº‹ä»¶ self.canvas.bind(\u0026#34;\u0026lt;Button-1\u0026gt;\u0026#34;, self.on_mouse_press) self.canvas.bind(\u0026#34;\u0026lt;B1-Motion\u0026gt;\u0026#34;, self.on_mouse_drag) self.canvas.bind(\u0026#34;\u0026lt;ButtonRelease-1\u0026gt;\u0026#34;, self.on_mouse_release) def update_blur_radius(self, value): \u0026#34;\u0026#34;\u0026#34;æ›´æ–°æ¨¡ç³ŠåŠå¾„\u0026#34;\u0026#34;\u0026#34; self.blur_radius = int(float(value)) self.radius_label.config(text=str(self.blur_radius)) def load_image(self): \u0026#34;\u0026#34;\u0026#34;åŠ è½½å›¾ç‰‡\u0026#34;\u0026#34;\u0026#34; file_path = filedialog.askopenfilename( filetypes=[(\u0026#34;output_frame_0001.png\u0026#34;, \u0026#34;*.jpg *.jpeg *.png *.bmp *.gif\u0026#34;)] ) if file_path: self.image_path = file_path self.original_image = Image.open(file_path) self.display_image = self.original_image.copy() self.regions = [] self.display_image_on_canvas() def display_image_on_canvas(self): \u0026#34;\u0026#34;\u0026#34;åœ¨ç”»å¸ƒä¸Šæ˜¾ç¤ºå›¾ç‰‡\u0026#34;\u0026#34;\u0026#34; if self.display_image is None: return # è·å–ç”»å¸ƒå¤§å° canvas_width = self.canvas.winfo_width() canvas_height = self.canvas.winfo_height() if canvas_width \u0026lt;= 1 or canvas_height \u0026lt;= 1: self.root.after(100, self.display_image_on_canvas) return # è®¡ç®—ç¼©æ”¾æ¯”ä¾‹ img_width, img_height = self.display_image.size scale = min(canvas_width / img_width, canvas_height / img_height) # ç¼©æ”¾å›¾ç‰‡ display_width = int(img_width * scale) display_height = int(img_height * scale) display_img = self.display_image.resize((display_width, display_height), Image.Resampling.LANCZOS) # è½¬æ¢ä¸º PhotoImage self.photo = ImageTk.PhotoImage(display_img) # æ¸…é™¤ç”»å¸ƒå¹¶æ˜¾ç¤ºå›¾ç‰‡ self.canvas.delete(\u0026#34;all\u0026#34;) self.canvas.create_image(canvas_width // 2, canvas_height // 2, image=self.photo, anchor=tk.CENTER) # ç»˜åˆ¶å·²é€‰æ‹©çš„åŒºåŸŸ for x1, y1, x2, y2 in self.regions: # è½¬æ¢åæ ‡åˆ°æ˜¾ç¤ºåæ ‡ offset_x = (canvas_width - display_width) // 2 offset_y = (canvas_height - display_height) // 2 self.canvas.create_rectangle( x1 * scale + offset_x, y1 * scale + offset_y, x2 * scale + offset_x, y2 * scale + offset_y, outline=\u0026#34;green\u0026#34;, width=2 ) def on_mouse_press(self, event): \u0026#34;\u0026#34;\u0026#34;é¼ æ ‡æŒ‰ä¸‹\u0026#34;\u0026#34;\u0026#34; self.start_x = event.x self.start_y = event.y def on_mouse_drag(self, event): \u0026#34;\u0026#34;\u0026#34;é¼ æ ‡æ‹–æ‹½\u0026#34;\u0026#34;\u0026#34; if self.start_x is None or self.start_y is None: return # æ¸…é™¤å½“å‰ä¸´æ—¶çŸ©å½¢ self.canvas.delete(\u0026#34;temp_rect\u0026#34;) # ç»˜åˆ¶ä¸´æ—¶çŸ©å½¢ self.canvas.create_rectangle( self.start_x, self.start_y, event.x, event.y, outline=\u0026#34;red\u0026#34;, width=2, tags=\u0026#34;temp_rect\u0026#34; ) def on_mouse_release(self, event): \u0026#34;\u0026#34;\u0026#34;é¼ æ ‡é‡Šæ”¾\u0026#34;\u0026#34;\u0026#34; if self.start_x is None or self.start_y is None: return if self.display_image is None: return # è·å–ç”»å¸ƒå’Œå›¾ç‰‡ä¿¡æ¯ canvas_width = self.canvas.winfo_width() canvas_height = self.canvas.winfo_height() img_width, img_height = self.display_image.size scale = min(canvas_width / img_width, canvas_height / img_height) offset_x = (canvas_width - int(img_width * scale)) // 2 offset_y = (canvas_height - int(img_height * scale)) // 2 # è½¬æ¢åæ ‡åˆ°å›¾ç‰‡åæ ‡ x1 = int((self.start_x - offset_x) / scale) y1 = int((self.start_y - offset_y) / scale) x2 = int((event.x - offset_x) / scale) y2 = int((event.y - offset_y) / scale) # ç¡®ä¿åæ ‡åœ¨å›¾ç‰‡èŒƒå›´å†… x1 = max(0, min(x1, img_width)) y1 = max(0, min(y1, img_height)) x2 = max(0, min(x2, img_width)) y2 = max(0, min(y2, img_height)) # ç¡®ä¿ x1 \u0026lt; x2, y1 \u0026lt; y2 if x1 \u0026gt; x2: x1, x2 = x2, x1 if y1 \u0026gt; y2: y1, y2 = y2, y1 # æ£€æŸ¥åŒºåŸŸæ˜¯å¦æœ‰æ•ˆ if abs(x2 - x1) \u0026gt; 5 and abs(y2 - y1) \u0026gt; 5: self.regions.append((x1, y1, x2, y2)) print(f\u0026#34;å·²é€‰æ‹©åŒºåŸŸ: ({x1}, {y1}) -\u0026gt; ({x2}, {y2})\u0026#34;) self.display_image_on_canvas() self.start_x = None self.start_y = None def apply_blur(self): \u0026#34;\u0026#34;\u0026#34;åº”ç”¨æ¨¡ç³Šæ•ˆæœ\u0026#34;\u0026#34;\u0026#34; if self.original_image is None: messagebox.showwarning(\u0026#34;è­¦å‘Š\u0026#34;, \u0026#34;è¯·å…ˆåŠ è½½å›¾ç‰‡ï¼\u0026#34;) return if not self.regions: messagebox.showwarning(\u0026#34;è­¦å‘Š\u0026#34;, \u0026#34;è¯·å…ˆé€‰æ‹©è¦æ¨¡ç³Šçš„åŒºåŸŸï¼\u0026#34;) return # åˆ›å»ºæ¨¡ç³Šç‰ˆæœ¬ blurred = self.original_image.filter(ImageFilter.GaussianBlur(radius=self.blur_radius)) # åˆ›å»ºé®ç½© mask = Image.new(\u0026#39;L\u0026#39;, self.original_image.size, 0) draw = ImageDraw.Draw(mask) # ç»˜åˆ¶æ‰€æœ‰é€‰æ‹©çš„åŒºåŸŸ for x1, y1, x2, y2 in self.regions: draw.rectangle([x1, y1, x2, y2], fill=255) # åˆæˆ self.display_image = Image.composite(blurred, self.original_image, mask) self.regions = [] # æ¸…ç©ºé€‰æ‹© self.display_image_on_canvas() messagebox.showinfo(\u0026#34;æˆåŠŸ\u0026#34;, \u0026#34;æ¨¡ç³Šæ•ˆæœå·²åº”ç”¨ï¼\u0026#34;) def reset_image(self): \u0026#34;\u0026#34;\u0026#34;é‡ç½®å›¾ç‰‡\u0026#34;\u0026#34;\u0026#34; if self.original_image: self.display_image = self.original_image.copy() self.regions = [] self.display_image_on_canvas() def clear_regions(self): \u0026#34;\u0026#34;\u0026#34;æ¸…é™¤æ‰€æœ‰é€‰æ‹©\u0026#34;\u0026#34;\u0026#34; self.regions = [] self.display_image_on_canvas() def save_image(self): \u0026#34;\u0026#34;\u0026#34;ä¿å­˜å›¾ç‰‡\u0026#34;\u0026#34;\u0026#34; if self.display_image is None: messagebox.showwarning(\u0026#34;è­¦å‘Š\u0026#34;, \u0026#34;æ²¡æœ‰å¯ä¿å­˜çš„å›¾ç‰‡ï¼\u0026#34;) return file_path = filedialog.asksaveasfilename( defaultextension=\u0026#34;.jpg\u0026#34;, filetypes=[(\u0026#34;JPEG\u0026#34;, \u0026#34;*.jpg\u0026#34;), (\u0026#34;PNG\u0026#34;, \u0026#34;*.png\u0026#34;), (\u0026#34;æ‰€æœ‰æ–‡ä»¶\u0026#34;, \u0026#34;*.*\u0026#34;)] ) if file_path: self.display_image.save(file_path) messagebox.showinfo(\u0026#34;æˆåŠŸ\u0026#34;, f\u0026#34;å›¾ç‰‡å·²ä¿å­˜åˆ°: {file_path}\u0026#34;) # ä½¿ç”¨ç¤ºä¾‹ if __name__ == \u0026#39;__main__\u0026#39;: root = tk.Tk() app = BlurRegionGUI(root) root.mainloop() ncmè½¬MP3 https://ncm.worthsee.com/\n","date":"2025-12-31T15:47:30+08:00","permalink":"http://xiangcman.xyz/p/%E8%A7%86%E9%A2%91%E7%9B%B8%E5%85%B3%E5%A4%84%E7%90%86/","title":"è§†é¢‘ç›¸å…³å¤„ç†"},{"content":"Glideå•ä¾‹åˆå§‹åŒ– 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 private static volatile Glide glide; public static Glide get(@NonNull Context context) { if (glide == null) { GeneratedAppGlideModule annotationGeneratedModule = getAnnotationGeneratedGlideModules(context.getApplicationContext()); synchronized (Glide.class) { if (glide == null) { checkAndInitializeGlide(context, annotationGeneratedModule); } } } return glide; } private static volatile boolean isInitializing; static void checkAndInitializeGlide( @NonNull Context context, @Nullable GeneratedAppGlideModule generatedAppGlideModule) { if (isInitializing) { throw new IllegalStateException( \u0026#34;Glide has been called recursively, this is probably an internal library error!\u0026#34;); } isInitializing = true; try { initializeGlide(context, generatedAppGlideModule); } finally { isInitializing = false; } } ä¸Šé¢Glideå¯¹è±¡åˆå§‹åŒ–ä½¿ç”¨DCLåŒé‡é”åˆ¤æ–­ï¼Œå¹¶ä¸”checkAndInitializeGlideæ–¹æ³•ä¸­ä½¿ç”¨äº†isInitializingå˜é‡è¡¨ç¤ºæ˜¯å¦æ­£åœ¨åˆå§‹åŒ–ã€‚è¿™ä¸ªisInitializingå˜é‡è§£å†³å•çº¿ç¨‹é€’å½’è°ƒç”¨Glide.getæ–¹æ³•ä¼šåˆ›å»ºå¤šä¸ªGlideå®ä¾‹ã€‚å› ä¸ºåœ¨DCLæ¨¡å¼ä¸­ï¼Œå•çº¿ç¨‹æ˜¯èƒ½é‡å…¥synchronizedé”çš„ã€‚ä¸ºäº†é¿å…å•çº¿ç¨‹èƒ½å¤šæ¬¡åˆ›å»ºGlideå®ä¾‹ï¼Œæ‰€ä»¥åŠ äº†æ ‡å¿—è¡¨ç¤ºæ˜¯å¦æ­£åœ¨åŠ è½½ã€‚\nBuilderå»ºé€ è€…æ¨¡å¼ å»ºé€ è€…æ¨¡å¼æ˜¯å±äºåˆ›å»ºå‹ä¸­çš„ä¸€ç§ï¼Œç”¨äºåˆ›å»ºå¤æ‚å¯¹è±¡ï¼Œå°†å¯¹è±¡çš„æ„å»ºä¸è¡¨ç¤ºåˆ†ç¦»ï¼Œä»¥ä¾¿ç›¸åŒçš„æ„å»ºè¿‡ç¨‹å¯ä»¥åˆ›å»ºä¸åŒçš„è¡¨ç¤ºã€‚\nGlideBuilder ç”¨äºåˆ›å»ºGlideå¯¹è±¡ï¼Œå› ä¸ºGlideå¯¹è±¡æ¯”è¾ƒå¤æ‚ï¼Œæ‰€ä»¥å°†Glideçš„åˆ›å»ºäº¤ç»™äº†GlideBuilderï¼ŒåŒæ ·çš„æ„å»ºè¿‡ç¨‹ï¼Œå¯ä»¥è¡¨ç¤ºä¸åŒçš„Glideå¯¹è±¡ã€‚æ¯”å¦‚æŒ‡å®šsourceExecutorï¼ˆåŠ è½½ç½‘ç»œèµ„æºçš„çº¿ç¨‹æ± ï¼‰ã€diskCacheExecutorï¼ˆåŠ è½½æœ¬åœ°ç£ç›˜ç¼“å­˜çš„çº¿ç¨‹æ± ï¼‰ç­‰ã€‚ RequestBuilder å®ƒæ˜¯ç»§æ‰¿è‡ªBaseRequestOptionsï¼Œå› æ­¤åœ¨æ„å»ºrequestè¿‡ç¨‹ä¸­ï¼Œå®ƒæ˜¯å……å½“äº†builderåˆ›å»ºæ¨¡å¼æ¥åˆ›å»ºrequestï¼Œæ¯”å¦‚é…ç½®overrideå¤§å°ã€placeholderç­‰ã€‚ åŸå‹æ¨¡å¼ RequestBuilderçš„clone åœ¨RequestBuilderä¸­çš„intoæ–¹æ³•é‡Œé¢æ¯æ¬¡å…ˆcloneä¸€ä»½RequestOptionså‡ºæ¥ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 class RequestBuilder{ public ViewTarget\u0026lt;ImageView, TranscodeType\u0026gt; into(@NonNull ImageView view) { BaseRequestOptions\u0026lt;?\u0026gt; requestOptions = this; if (!requestOptions.isTransformationSet() \u0026amp;\u0026amp; requestOptions.isTransformationAllowed() \u0026amp;\u0026amp; view.getScaleType() != null) { switch (view.getScaleType()) { case CENTER_CROP: requestOptions = requestOptions.clone().optionalCenterCrop(); break; case CENTER_INSIDE: requestOptions = requestOptions.clone().optionalCenterInside(); break; case FIT_CENTER: case FIT_START: case FIT_END: requestOptions = requestOptions.clone().optionalFitCenter(); break; case FIT_XY: requestOptions = requestOptions.clone().optionalCenterInside(); break; case CENTER: case MATRIX: default: } } return into( glideContext.buildImageViewTarget(view, transcodeClass), /* targetListener= */ null, requestOptions, Executors.mainThreadExecutor()); } public T clone() { try { BaseRequestOptions\u0026lt;?\u0026gt; result = (BaseRequestOptions\u0026lt;?\u0026gt;) super.clone(); result.options = new Options(); result.options.putAll(options); result.transformations = new CachedHashCodeArrayMap\u0026lt;\u0026gt;(); result.transformations.putAll(transformations); result.isLocked = false; result.isAutoCloneEnabled = false; return (T) result; } catch (CloneNotSupportedException e) { throw new RuntimeException(e); } } } requestOptionsé€šè¿‡cloneæ–¹æ³•æ„é€ ä¸€ä¸ªæ–°çš„BaseRequestOptionsï¼ŒåŸå‹æ¨¡å¼çš„ä½œç”¨æ˜¯é€šè¿‡å·²æœ‰çš„å¯¹è±¡å±æ€§æ„å»ºä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œå¥½å¤„æ˜¯åˆ›å»ºæ–°å¯¹è±¡æ—¶å¤ç”¨å·²æœ‰é…ç½®ï¼Œé¿å…é‡å¤è®¾ç½®ã€‚æ–°å¯¹è±¡ä¸åŸå¯¹è±¡ç›¸äº’ç‹¬ç«‹ï¼Œäº’ä¸å½±å“ã€‚æ­¤å¤„å¥½å¤„æœ‰å¦‚ä¸‹å‡ ç‚¹ï¼š\næ”¯æŒ RequestBuilder å¤ç”¨ RequestBuilderæ˜¯å¯ä»¥å¤ç”¨çš„ï¼Œå› ä¸ºloadæ–¹æ³•ä¼šè¿”å›requestBuilderï¼Œè€Œintoå¯ä»¥ä½œç”¨åˆ°ä¸åŒçš„imageViewä¸Šï¼Œå¦‚æœå…ˆä½œç”¨åˆ°imageView1ä¸Šï¼Œå®ƒçš„scaleTypeæ˜¯fitCenterï¼Œè€Œååˆä½œç”¨åˆ°imageView2ä¸Šï¼Œæ­¤æ—¶imageViewæ˜¯centerCropæ¨¡å¼å±•ç¤ºã€‚å¦‚æœæ²¡æœ‰cloneçš„è¯ï¼ŒimageView2åŠ è½½å®Œåä¼šå½±å“åˆ°imageView1çš„å±•ç¤ºã€‚å› ä¸ºscaleTypeçš„ä¸åŒä¼šç»™requestOptionsè®¾ç½®strategyå’Œtransformationä¸åŒã€‚ é˜²æ­¢åç»­ä¿®æ”¹å½±å“å·²å‘èµ·çš„è¯·æ±‚ è¿˜æ˜¯æ‹¿ä¸¤ä¸ªå›¾ç‰‡å…±ç”¨ä¸€ä¸ªRequestBuilderæ¥è¯´ï¼Œæ¯”å¦‚imageView1éœ€è¦é€šè¿‡requestOptionsè®¾ç½®override(100,100)çš„å¤§å°ï¼Œæ­¤æ—¶imageView1è¿˜åœ¨è¯·æ±‚ï¼Œè€Œæ­¤æ—¶imageView2é€šè¿‡requestOptionsè®¾ç½®override(200,200)ï¼Œé‚£ä¹ˆæ­¤æ—¶å¦‚æœæ²¡æœ‰cloneå‡ºä¸€ä¸ªæ–°çš„requestOptionsä¼šå¯¼è‡´imageView1åŠ è½½çš„å¤§å°ä¸å¯¹åº”ã€‚ å¤šçº¿ç¨‹å®‰å…¨é—®é¢˜ intoæ–¹æ³•å¦‚æœåœ¨ä¸åŒçš„çº¿ç¨‹è¢«è°ƒç”¨ï¼Œå¦‚æœæ²¡æœ‰cloneå‡ºä¸€ä¸ªæ–°çš„requestOptionsï¼Œé‚£ä¹ˆä¼šå­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚ å·¥å‚æ¨¡å¼ DiskCacheçš„åˆ›å»º glideä¸­ä½¿ç”¨çš„å·¥å‚æ¨¡å¼åˆ†ä¸ºå·¥å‚æ–¹æ³•æ¨¡å¼å’ŒæŠ½è±¡å·¥å‚æ¨¡å¼ï¼Œé¦–å…ˆçœ‹ä¸‹å“ªäº›åœ°æ–¹ç”¨åˆ°äº†å·¥å‚æ–¹æ³•æ¨¡å¼ï¼š\nDiskCacheçš„åˆ›å»º åœ¨GlideBuilderä¸­é»˜è®¤åˆå§‹åŒ–äº†DiskCache.Factoryï¼Œä»–å…¶å®æ˜¯ä¸€ä¸ªInternalCacheDiskCacheFactoryï¼š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 public interface DiskCache { interface Factory { @Nullable DiskCache build(); } } public final class GlideBuilder { private DiskCache.Factory diskCacheFactory; Glide build(){ if (diskCacheFactory == null) { diskCacheFactory = new InternalCacheDiskCacheFactory(context); } } } æ¥ç€å°†diskCacheFactoryç»™åˆ°Engineï¼Œåœ¨Engineä¸­ä¼šå°†diskCacheFactoryç»™åˆ°LazyDiskCacheProviderï¼Œå®ƒæ˜¯å®ç°äº†DecodeJob.DiskCacheProvideræ¥å£ï¼Œå¯ä»¥çœ‹å‡ºæ¥å®ƒæ˜¯åœ¨DecodeJobä¸­éœ€è¦ä½¿ç”¨åˆ°è¯¥DiskCache.Factoryï¼Œæˆ‘ä»¬è®¾è®¡æ¥å£çš„æ—¶å€™ï¼Œéœ€è¦å°†æ¥å£ä¿æŒæœ€å°èŒƒå›´ï¼Œå¦‚æœåªåœ¨å¤–éƒ¨ç±»ä¸­ä½¿ç”¨è¯¥æ¥å£ï¼Œå°†æ¥å£å®šä¹‰åœ¨å¤–éƒ¨ç±»ä¸­ï¼Œä½“ç°äº†è®¾è®¡åŸåˆ™ä¸­çš„å°è£…åŸåˆ™ï¼Œä»è€Œå‡å°‘å¯¹å¤–æš´éœ²ã€‚ç¬¬äºŒç‚¹ä½“ç°äº†é«˜å†…èšåŸåˆ™ï¼Œå°†ç›¸å…³çš„æ¥å£å’Œç±»æ”¾åœ¨ä¸€èµ·ï¼Œæé«˜å†…èšæ€§ã€‚\n1 2 3 4 5 class DecodeJob{ interface DiskCacheProvider { DiskCache getDiskCache(); } } å¹¶ä¸”LazyDiskCacheProviderçš„å®šä¹‰æ˜¯åœ¨Engineä¸­å®šä¹‰ï¼Œè¿™ä¹Ÿä½“ç°äº†é«˜å†…èšå’Œå°è£…åŸåˆ™ï¼Œä¸ä»…æ˜¯æ¥å£ï¼Œç±»ä¸ç±»ä¹‹é—´ä¹Ÿèƒ½ä½“ç°å‡ºæ¥ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 class Engine{ private static class LazyDiskCacheProvider implements DecodeJob.DiskCacheProvider { private final DiskCache.Factory factory; private volatile DiskCache diskCache; LazyDiskCacheProvider(DiskCache.Factory factory) { this.factory = factory; } @Override public DiskCache getDiskCache() { if (diskCache == null) { synchronized (this) { if (diskCache == null) { diskCache = factory.build(); } if (diskCache == null) { diskCache = new DiskCacheAdapter(); } } } return diskCache; } } } LazyDiskCacheProviderä»å­—é¢æ„æ€ä¹Ÿèƒ½çœ‹å‡ºæ¥ï¼Œå®ƒæ˜¯ä¸€ä¸ªå»¶è¿Ÿè·å–DiskCacheçš„å°è£…ç±»ã€‚å¦‚æœæ²¡æœ‰å®ƒï¼Œé‚£å°±å¾—åœ¨Glideåˆå§‹åŒ–çš„æ—¶å€™åˆ›å»ºDiskCacheäº†ã€‚å› ä¸ºDiskCacheæ˜¯ä¸€ä¸ªé‡é‡çº§çš„ç±»ï¼Œé‡Œé¢æ¶‰åŠåˆ°æ–‡ä»¶ç›®å½•çš„åˆ›å»ºç­‰ã€‚å¹¶ä¸”åœ¨LazyDiskCacheProviderä¸­ä¿è¯äº†çº¿ç¨‹å®‰å…¨æ¥åˆ›å»ºDiskCacheã€‚\nRequestOptionsçš„åˆ›å»º å®ƒä¹Ÿæ˜¯é€šè¿‡å·¥å‚æ–¹æ³•æ¨¡å¼æ¥åˆ›å»ºçš„ï¼š 1 2 3 4 5 6 class Glide{ public interface RequestOptionsFactory { @NonNull RequestOptions build(); } } å®ƒæ˜¯åœ¨Glideå¤–éƒ¨ç±»ä¸­å®šä¹‰çš„æ¥å£ï¼Œä¹Ÿæ˜¯å’Œä¸Šé¢ç±»ä¼¼ï¼Œå†æ¥çœ‹ä¸‹å®ƒçš„æ¥å£å®ç°ç±»ï¼š\n1 2 3 4 5 6 7 8 9 10 class GlideBuilder{ private RequestOptionsFactory defaultRequestOptionsFactory = new RequestOptionsFactory() { @NonNull @Override public RequestOptions build() { return new RequestOptions(); } }; } åœ¨Glideåˆ›å»ºçš„æ—¶å€™ï¼Œç›´æ¥æŠŠdefaultRequestOptionsFactoryä¼ ç»™äº†Glideå¯¹è±¡ï¼Œä¹Ÿæ²¡æœ‰åˆ¤æ–­å¤–ç•Œæœ‰æ²¡æœ‰ä¼ å…¥RequestOptionsFactoryï¼Œå¯ä»¥çœ‹å‡ºæ¥å®ƒæ— éœ€å¤–ç•Œè¿›è¡Œæ‰©å±•ï¼Œè¿™ç‚¹å’ŒDiskCache.Factoryä¸å¤ªä¸€æ ·ã€‚ç”±äºRequestOptionsæ˜¯ä¸€ä¸ªè½»é‡çº§çš„ï¼Œæ‰€ä»¥å®ƒä¹Ÿæ— éœ€å»¶è¿Ÿåˆå§‹åŒ–ï¼Œå®ƒæ˜¯åœ¨RequestManageråˆå§‹åŒ–ä¸­è°ƒç”¨GlideContextçš„getDefaultRequestOptionsæ–¹æ³•æ¥åˆ›å»ºçš„ï¼š\n1 2 3 4 5 6 7 8 class GlideContext{ public synchronized RequestOptions getDefaultRequestOptions() { if (defaultRequestOptions == null) { defaultRequestOptions = defaultRequestOptionsFactory.build().lock(); } return defaultRequestOptions; } } Registryçš„åˆ›å»º Registryæ˜¯é€šè¿‡GlideSupplieræ¥å£åˆ›å»ºçš„ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªå·¥å‚æ–¹æ³•æ¨¡å¼ï¼š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 public final class GlideSuppliers { public interface GlideSupplier\u0026lt;T\u0026gt; { T get(); } private GlideSuppliers() {} public static \u0026lt;T\u0026gt; GlideSupplier\u0026lt;T\u0026gt; memorize(final GlideSupplier\u0026lt;T\u0026gt; supplier) { return new GlideSupplier\u0026lt;T\u0026gt;() { private volatile T instance; @Override public T get() { if (instance == null) { synchronized (this) { if (instance == null) { instance = Preconditions.checkNotNull(supplier.get()); } } } return instance; } }; } } ä¹Ÿæ˜¯ä¸€ä¸ªç±»ä¸­å†…éƒ¨æ¥å£ï¼Œä¸è¿‡è¯¥æ¥å£æ˜¯ä¸€ä¸ªæ³›å‹ã€‚å¤–ç•Œéœ€è¦è°ƒç”¨memorizeæ–¹æ³•ï¼Œå¹¶ä¼ å…¥ä¸€ä¸ªGlideSupplierçš„å®ç°ç±»ï¼Œåœ¨å‰é¢ä»‹ç»Registryåˆ›å»ºè¿‡ç¨‹ä¸­ï¼Œå®ƒæ˜¯åœ¨GlideContextçš„getRegistryæ–¹æ³•è¿›è¡Œè·å–çš„ï¼Œè€Œé»˜è®¤æ˜¯è°ƒç”¨memorizeæ–¹æ³•è·å–åˆ°GlideSupplierå¯¹è±¡ï¼Œç­‰åˆ°éœ€è¦Registryæ—¶å€™æ‰ä¼šè°ƒç”¨GlideSupplierçš„getæ–¹æ³•ï¼Œæ˜¾è€Œæ˜“è§è¿™æ˜¯ä¸€ä¸ªå»¶è¿Ÿåˆå§‹åŒ–ï¼Œå¹¶ä¸”è¿™é‡Œä½¿ç”¨äº†é™æ€ä»£ç†ï¼Œå°†Registryçš„æœ€ç»ˆè·å–äº¤ç»™äº†å¤–ç•Œä¼ å…¥çš„Registryã€‚åŒæ—¶åŒ¿åå†…éƒ¨ç±»çš„GlideSupplieré€šè¿‡åŒé‡é”ä¿è¯äº†çº¿ç¨‹å®‰å…¨ï¼Œè¿™é‡Œå…¶å®å’Œä¸Šé¢çš„DiskCacheçš„åˆ›å»ºæœ‰ç‚¹å¼‚æ›²åŒå·¥ä¹‹å¦™ã€‚\nModelLoaderçš„åˆ›å»º ModelLoaderæ˜¯é€šè¿‡ModelLoaderFactoryæ¥å£æ¥åˆ›å»ºçš„ï¼š 1 2 3 4 public interface ModelLoaderFactory\u0026lt;T, Y\u0026gt; { @NonNull ModelLoader\u0026lt;T, Y\u0026gt; build(@NonNull MultiModelLoaderFactory multiFactory); } åœ¨RegistryFactoryä¸­å…ˆæŠŠmodelClassã€dataClassã€ModelLoaderFactoryæ³¨å†Œåˆ°MultiModelLoaderFactoryä¸­ï¼Œç»„è½¬æˆä¸€ä¸ªä¸ªçš„Entryå¯¹è±¡ï¼Œç­‰åˆ°è¦ä½¿ç”¨ModelLoaderæ—¶å€™ï¼Œé€šè¿‡modelClasså’ŒdataClassè¿‡æ»¤å‡ºModelLoaderFactoryï¼Œç„¶åé€šè¿‡ModelLoaderFactoryåˆ›å»ºå‡ºModelLoaderï¼Œæ¥ç€è·å–åˆ°LoadDataï¼Œæœ€åè·å–åˆ°DataFetcherã€‚ åœ¨MultiModelLoaderä¸­è£…è½½äº†ModelLoaderçš„é›†åˆï¼ŒåŒ…å«äº†å¤šä¸ªå­èŠ‚ç‚¹ï¼Œåœ¨è·å–LoadDataçš„æ—¶å€™ä½¿ç”¨äº†è´£ä»»é“¾æ¨¡å¼ï¼Œä¾æ¬¡è®©æ¯ä¸ªModelLoaderå°è¯•è¿›è¡Œè·å–LoadDataï¼ŒåŒæ—¶è¿™é‡Œä¹Ÿä½“ç°å‡ºäº†è¿­ä»£å™¨æ¨¡å¼ã€‚\nDataRewinderçš„åˆ›å»º DataRewinderæ˜¯ä¸€ä¸ªæ•°æ®é‡ç½®å™¨ï¼Œå®ƒä¹Ÿæ˜¯é€šè¿‡æ–¹æ³•å·¥å‚æ¥åˆ›å»ºçš„ 1 2 3 4 5 6 7 8 9 10 11 12 13 public interface DataRewinder\u0026lt;T\u0026gt; { interface Factory\u0026lt;T\u0026gt; { @NonNull DataRewinder\u0026lt;T\u0026gt; build(@NonNull T data); @NonNull Class\u0026lt;T\u0026gt; getDataClass(); } @NonNull T rewindAndGet() throws IOException; } ä¹Ÿæ˜¯åœ¨å¤–éƒ¨æ¥å£ä¸­å®šä¹‰å†…éƒ¨æ¥å£ã€‚åœ¨å‰é¢ä»‹ç»InputStreamè½¬åŒ–æˆFileçš„æ—¶å€™è®²è¿‡ï¼Œå…ˆæŠŠå„ç§DataRewinder.Factoryæ³¨å†Œåˆ°DataRewinderRegistryä¸­ï¼Œç„¶åé€šè¿‡ä¼ å…¥çš„classç±»å‹è·å–åˆ°å¯¹åº”çš„DataRewinder.Factoryï¼Œæ¥ç€é€šè¿‡buildæ–¹æ³•è·å–åˆ°DataRewinderã€‚\nEncoderçš„è·å– Encoderæ˜¯ç¼–ç å™¨çš„æ¥å£ç±»ï¼ŒEncoderçš„åˆ›å»ºè™½ç„¶æ²¡æœ‰ç”¨åˆ°Factoryï¼Œä½†æ˜¯å®ƒæ˜¯å’Œä¸Šé¢DataRewinderçš„åˆ›å»ºå½¢æˆäº†å¯¹æ¯”ï¼ŒEncoderå®ƒæ˜¯ç›´æ¥åœ¨Registryé˜¶æ®µç›´æ¥åŒ…è½¬æˆEntryï¼Œç„¶ååœ¨è·å–çš„æ—¶å€™ç›´æ¥ä»Entryä¸­è·å–åˆ°Encoderã€‚ Encoderä¸ºä»€ä¹ˆå®ƒä¸éœ€è¦Factoryåˆ›å»ºå‘¢ï¼Ÿè€ŒDataRewinderéœ€è¦é€šè¿‡Factoryæ¥åˆ›å»ºï¼Ÿ\nç‰¹æ€§ Encoder DataRewinder çŠ¶æ€ æ— çŠ¶æ€ æœ‰çŠ¶æ€ æ•°æ®ä¾èµ– æ•°æ®é€šè¿‡æ–¹æ³•å‚æ•°ä¼ å…¥ æ•°æ®åœ¨æ„é€ æ—¶æ³¨å…¥ å®ä¾‹å¤ç”¨ âœ… å¯å¤ç”¨ï¼Œä¸€ä¸ªå®ä¾‹å¤„ç†å¤šä¸ªè¯·æ±‚ âŒ æ¯æ¬¡éœ€è¦æ–°å®ä¾‹ ç”Ÿå‘½å‘¨æœŸ åº”ç”¨çº§åˆ«ï¼Œé•¿æœŸå­˜æ´» è¯·æ±‚çº§åˆ«ï¼Œç”¨å®Œé‡Šæ”¾ èµ„æºç®¡ç† ä¸éœ€è¦ cleanup éœ€è¦ cleanup() é‡Šæ”¾èµ„æº æ¯”å¦‚åœ¨å‰é¢è®²çš„å°†åŸå§‹å›¾ç‰‡ä¿å­˜åˆ°æœ¬åœ°çš„æ—¶å€™è¯´è¿‡StreamEncoder:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 public class StreamEncoder implements Encoder\u0026lt;InputStream\u0026gt;{ public boolean encode(@NonNull InputStream data, @NonNull File file, @NonNull Options options) { byte[] buffer = byteArrayPool.get(ArrayPool.STANDARD_BUFFER_SIZE_BYTES, byte[].class); boolean success = false; OutputStream os = new FileOutputStream(file); int read; while ((read = data.read(buffer)) != -1) { os.write(buffer, 0, read); } os.close(); success = true; byteArrayPool.put(buffer); return success; } } å®ƒä¸æŒæœ‰æ•°æ®ï¼Œæ‰€ä»¥æ˜¯æ— çŠ¶æ€çš„ã€‚æ•°æ®æ˜¯é€šè¿‡æ–¹æ³•å‚æ•°ä¼ å…¥ã€‚å¹¶ä¸”StreamEncoderæ˜¯åº”ç”¨çº§åˆ«çš„ï¼Œå®ƒæ— éœ€æ¯æ¬¡è¿›è¡Œåˆ›å»ºã€‚æ‰€ä»¥å®ƒæ— éœ€é€šè¿‡factoryè¿›è¡Œå»¶è¿Ÿåˆå§‹åŒ–ã€‚è€Œåœ¨DataRewinderä¸­å®ƒæ˜¯éœ€è¦æŒæœ‰æ•°æ®çš„ï¼Œæ¯”å¦‚å‰é¢è®²çš„InputStreamRewinderï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 public final class InputStreamRewinder implements DataRewinder\u0026lt;InputStream\u0026gt; { // 5MB. private static final int MARK_READ_LIMIT = 5 * 1024 * 1024; private final RecyclableBufferedInputStream bufferedStream; @Synthetic public InputStreamRewinder(InputStream is, ArrayPool byteArrayPool) { bufferedStream = new RecyclableBufferedInputStream(is, byteArrayPool); bufferedStream.mark(MARK_READ_LIMIT); } @NonNull @Override public InputStream rewindAndGet() throws IOException { bufferedStream.reset(); return bufferedStream; } } å®ƒéœ€è¦æŒæœ‰æ•°æ®ï¼Œå› ä¸ºå®ƒéœ€è¦å¤šæ¬¡å¯¹æµè¿›è¡Œé‡ç½®ä½ç½®ã€‚å¹¶ä¸”æ¯æ¬¡è·å–å›¾ç‰‡éƒ½éœ€è¦åˆ›å»ºä¸€ä¸ªæ–°çš„DataRewinderï¼Œæ‰€ä»¥å®ƒéœ€è¦é€šè¿‡factoryæ¥åˆ›å»ºä¸åŒçš„DataRewinderï¼Œå› ä¸ºå®ƒæ˜¯è·Ÿæ•°æ®ç»‘å®šåœ¨ä¸€å—çš„ï¼Œå› æ­¤ç”¨åˆ°äº†å»¶è¿Ÿåˆå§‹åŒ–ã€‚\nè§£ç (é™æ€ä»£ç†) é¦–å…ˆäº†è§£å‡ ä¸ªæ¦‚å¿µï¼ŒdataClassï¼šæ•°æ®æºç±»å‹ï¼Œæ¯”å¦‚ä»ç½‘ç»œè·å–çš„æ•°æ®ç±»å‹æ˜¯byteBuffer.classç±»å‹ã€‚resourceClassï¼šè§£ç åçš„èµ„æºç±»å‹ï¼Œæ¯”å¦‚bitmapçš„è§£ç ï¼Œå®ƒæ˜¯BitmapDrawable.classï¼Œä¹Ÿå°±æ˜¯bitmapçš„drawableåŒ…è£…ã€‚transcodeClassï¼šæœ€ç»ˆè½¬æ¢ç±»å‹ï¼Œæ¯”å¦‚è¦å±•ç¤ºåˆ°imageViewä¸Šçš„æ—¶å€™ï¼Œæ­¤æ—¶æ˜¯Drawable.classç±»å‹ã€‚ åœ¨æ³¨å†Œçš„æ—¶å€™ï¼Œä¼šæŒ‰ç…§bucketã€dataClassã€resourceClassã€decoderå››ä¸ªå‚æ•°ç»„è½¬æˆEntryï¼Œå¹¶ä¸”è¯¥Entryæ˜¯å®šä¹‰åœ¨ResourceDecoderRegistryçš„ç§æœ‰å†…éƒ¨ç±»ä¸­ã€‚ä¿è¯é«˜å†…èšï¼Œä½è€¦åˆã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 private static class Entry\u0026lt;T, R\u0026gt; { private final Class\u0026lt;T\u0026gt; dataClass; @Synthetic final Class\u0026lt;R\u0026gt; resourceClass; @Synthetic final ResourceDecoder\u0026lt;T, R\u0026gt; decoder; public Entry( @NonNull Class\u0026lt;T\u0026gt; dataClass, @NonNull Class\u0026lt;R\u0026gt; resourceClass, ResourceDecoder\u0026lt;T, R\u0026gt; decoder) { this.dataClass = dataClass; this.resourceClass = resourceClass; this.decoder = decoder; } public boolean handles(@NonNull Class\u0026lt;?\u0026gt; dataClass, @NonNull Class\u0026lt;?\u0026gt; resourceClass) { return this.dataClass.isAssignableFrom(dataClass) \u0026amp;\u0026amp; resourceClass.isAssignableFrom(this.resourceClass); } } æœ€ç»ˆå°†è¿™äº›Entryè£…è½½åˆ°ResourceDecoderRegistryçš„decodersè¿™ä¸ªmapä¸­ã€‚æ¯”å¦‚åœ¨å‰é¢ä»‹ç»çš„BitmapDrawableDecoderï¼Œå®ƒå°±æ˜¯æŒ‰ç…§bucket= \u0026ldquo;BitmapDrawable\u0026rdquo;,dataClass=\u0026ldquo;ByteBuffer.class\u0026rdquo;,resourceClass=\u0026ldquo;BitmapDrawable.class\u0026rdquo;,decoder=BitmapDrawableDecoderç»„æˆçš„entryæ¥è·å–çš„ã€‚å¹¶ä¸”åœ¨BitmapDrawableDecoderä¸­ä½¿ç”¨äº†ä»£ç†æ¨¡å¼ï¼Œå®é™…ä»£ç†åˆ°ByteBufferBitmapDecoderï¼Œæœ€ç»ˆä¼šè°ƒç”¨åˆ°Downsamplerä¸­ã€‚\n","date":"2025-12-16T14:42:28+08:00","permalink":"http://xiangcman.xyz/p/glide%E4%B8%AD%E4%BC%98%E7%A7%80%E4%BB%A3%E7%A0%81%E6%80%BB%E7%BB%93/","title":"Glideä¸­ä¼˜ç§€ä»£ç æ€»ç»“"},{"content":"Glideä¸­ç¼“å­˜åˆ†ä¸ºå†…å­˜ç¼“å­˜å’Œç£ç›˜ç¼“å­˜ï¼Œè€Œå†…å­˜ç¼“å­˜åˆåˆ†ä¸ºå½“å‰æ´»è·ƒçš„ç¼“å­˜å’Œæœªä½¿ç”¨çš„ç¼“å­˜ï¼Œç£ç›˜ç¼“å­˜åˆ†ä¸ºè§£ç åçš„ç¼“å­˜ä»¥åŠåŸå§‹ç¼“å­˜ã€‚å‰é¢æµç¨‹ä¸­ä»‹ç»è¿‡è§£ç å’Œç¼–ç ï¼Œè¿™é‡Œé¢ä»‹ç»è¿‡å¦‚ä½•ä¿å­˜çš„ï¼Œé‚£è·å–æ˜¯ä»€ä¹ˆæ ·çš„ï¼Œæˆ‘ä»¬è¿™èŠ‚å°±åˆ†æä¸‹ã€‚\nä¸€çº§ç¼“å­˜ åœ¨Glideä¸»æµç¨‹ä¸­æœ‰æåˆ°è¿‡å†…å­˜ç¼“å­˜ï¼Œåœ¨ä¸»æµç¨‹ä¸­éƒ½æ˜¯æŒ‰ç…§åŠ è½½ç½‘ç»œæ•°æ®è¿›è¡Œåˆ†æçš„ï¼Œæˆ‘ä»¬ä»Engineçš„loadæ–¹æ³•å¼€å§‹è®²è§£ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 public class Engine{ public \u0026lt;R\u0026gt; LoadStatus load( GlideContext glideContext, Object model, Key signature, int width, int height, Class\u0026lt;?\u0026gt; resourceClass, Class\u0026lt;R\u0026gt; transcodeClass, Priority priority, DiskCacheStrategy diskCacheStrategy, Map\u0026lt;Class\u0026lt;?\u0026gt;, Transformation\u0026lt;?\u0026gt;\u0026gt; transformations, boolean isTransformationRequired, boolean isScaleOnlyOrNoTransform, Options options, boolean isMemoryCacheable, boolean useUnlimitedSourceExecutorPool, boolean useAnimationPool, boolean onlyRetrieveFromCache, ResourceCallback cb, Executor callbackExecutor) { EngineKey key = keyFactory.buildKey( model, signature, width, height, transformations, resourceClass, transcodeClass, options); EngineResource\u0026lt;?\u0026gt; memoryResource = loadFromMemory(key, isMemoryCacheable, startTime); } } å…ˆé€šè¿‡KeyFactoryçš„buildKeyåˆ›å»ºä¸€ä¸ªç¼“å­˜çš„keyï¼Œmodelæ˜¯loadæ–¹æ³•ä¼ è¿›æ¥çš„å‚æ•°ï¼Œå®½å’Œé«˜æ˜¯åŠ è½½çš„å›¾ç‰‡å°ºå¯¸ã€‚resourceClassåœ¨ä¸Šä¸€èŠ‚ä¸­è§£ç æ—¶å€™è·å–LoadPathä»‹ç»è¿‡ï¼Œå®ƒä¸»è¦å½±å“åˆ°è¿‡æ»¤DecodePathï¼Œé»˜è®¤æ˜¯Object.classï¼Œå¯ä»¥é€šè¿‡RequestOptionsçš„decodeTypeOfæ–¹æ³•è®¾ç½®ã€‚transformationsæ˜¯loadæ–¹æ³•ä¼ è¿›æ¥çš„å‚æ•°ç±»å‹ï¼Œæ¯”å¦‚é»˜è®¤ä¼ è¿›æ¥ä¸€ä¸ªurlï¼Œåˆ™transformationsæ˜¯ä¸€ä¸ªDrawable.classã€‚signatureæ˜¯ä¸€ä¸ªç­¾åå‚æ•°ï¼Œé»˜è®¤æ˜¯EmptySignatureï¼Œå¯ä»¥é€šè¿‡RequestOptionsçš„signatureOfæ–¹æ³•è¿›è¡Œè®¾ç½®ã€‚optionså¯ä»¥é…ç½®ä¸€äº›å‚æ•°ï¼Œæ¯”å¦‚è§£ç æ–¹å¼ç­‰ã€‚æ­¤å¤„ä½¿ç”¨EngineKeyFactoryçš„buildKeyç›´æ¥æ„å»ºï¼Œä¹Ÿæ˜¯ä¸€ç§å·¥å‚æ¨¡å¼ï¼Œåªä¸è¿‡æ­¤å¤„ä¸éœ€è¦å¤–ç•Œè¿›è¡Œæ„å»ºï¼Œæ‰€ä»¥ç›´æ¥é€šè¿‡æ™®é€šç±»åˆ›å»ºEngineKeyã€‚æ¥ç€çœ‹ä¸‹loadFromMemoryæ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 private EngineResource\u0026lt;?\u0026gt; loadFromMemory( EngineKey key, boolean isMemoryCacheable, long startTime) { if (!isMemoryCacheable) { return null; } EngineResource\u0026lt;?\u0026gt; active = loadFromActiveResources(key); if (active != null) { return active; } EngineResource\u0026lt;?\u0026gt; cached = loadFromCache(key); if (cached != null) { return cached; } return null; } isMemoryCacheableè¡¨ç¤ºå†…å­˜ç¼“å­˜æ˜¯å¦å¯ä½¿ç”¨ï¼Œå¦‚æœå¯ä½¿ç”¨ï¼Œè°ƒç”¨è¿‡loadFromActiveResourcesæ–¹æ³•è·å–ä¸€çº§ç¼“å­˜ï¼š\n1 2 3 4 5 6 7 8 private final ActiveResources activeResources; private EngineResource\u0026lt;?\u0026gt; loadFromActiveResources(Key key) { EngineResource\u0026lt;?\u0026gt; active = activeResources.get(key); if (active != null) { active.acquire(); } return active; } é€šè¿‡ActiveResourcesçš„getæ–¹æ³•è·å–ä¸€çº§ç¼“å­˜ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 final Map\u0026lt;Key, ResourceWeakReference\u0026gt; activeEngineResources = new HashMap\u0026lt;\u0026gt;(); synchronized EngineResource\u0026lt;?\u0026gt; get(Key key) { ResourceWeakReference activeRef = activeEngineResources.get(key); if (activeRef == null) { return null; } EngineResource\u0026lt;?\u0026gt; active = activeRef.get(); if (active == null) { cleanupActiveReference(activeRef); } return active; } void cleanupActiveReference(@NonNull ResourceWeakReference ref) { synchronized (this) { activeEngineResources.remove(ref.key); if (!ref.isCacheable || ref.resource == null) { return; } } EngineResource\u0026lt;?\u0026gt; newResource = new EngineResource\u0026lt;\u0026gt;( ref.resource, /* isMemoryCacheable= */ true, /* isRecyclable= */ false, ref.key, listener); listener.onResourceReleased(ref.key, newResource); } åœ¨getæ–¹æ³•ä¸­å…ˆä»activeEngineResourcesè¿™ä¸ªmapä¸­è·å–ResourceWeakReferenceï¼Œå®ƒæ˜¯ä¸€ä¸ªå¼±å¼•ç”¨ï¼Œé‡Œé¢å­˜å‚¨çš„å¯¹è±¡æ˜¯EngineResourceï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 static final class ResourceWeakReference extends WeakReference\u0026lt;EngineResource\u0026lt;?\u0026gt;\u0026gt; { final Key key; final boolean isCacheable; Resource\u0026lt;?\u0026gt; resource; ResourceWeakReference( @NonNull Key key, @NonNull EngineResource\u0026lt;?\u0026gt; referent, @NonNull ReferenceQueue\u0026lt;? super EngineResource\u0026lt;?\u0026gt;\u0026gt; queue, boolean isActiveResourceRetentionAllowed) { super(referent, queue); this.key = Preconditions.checkNotNull(key); this.resource = referent.isMemoryCacheable() \u0026amp;\u0026amp; isActiveResourceRetentionAllowed ? Preconditions.checkNotNull(referent.getResource()) : null; isCacheable = referent.isMemoryCacheable(); } void reset() { resource = null; clear(); } } åœ¨getæ–¹æ³•ä¸­å¦‚æœè‹¥å¼•ç”¨æ²¡æœ‰è·å–åˆ°ï¼Œåˆ™è¿”å›nullï¼Œå¦‚æœè·å–åˆ°ï¼Œåˆ™ç»§ç»­è·å–å¼±å¼•ç”¨ä¸­çš„å¯¹è±¡ï¼ˆEngineResourceï¼‰ï¼Œå¦‚æœå¼±å¼•ç”¨ä¸­çš„å¯¹è±¡ä¸ºç©ºï¼Œåˆ™è°ƒç”¨cleanupActiveReferenceæ–¹æ³•ï¼Œåœ¨è¯¥æ–¹æ³•é‡Œé¢é€šè¿‡å¼±å¼•ç”¨ä¸­çš„keyå°†è¯¥å¼±å¼•ç”¨ä»mapä¸­ç§»é™¤æ‰ï¼Œå¹¶å›è°ƒonResourceReleasedæ–¹æ³•ã€‚\nå¼±å¼•ç”¨æœ‰ä¸ªç‰¹ç‚¹ï¼Œå¦‚æœåœ¨GCçš„æ—¶å€™ï¼Œå‘ç°å¼±å¼•ç”¨åŒ…è£…çš„å¯¹è±¡æ²¡æœ‰å¼ºå¼•ç”¨æŒ‡å‘çš„æ—¶å€™ï¼Œæ­¤æ—¶å¯¹è±¡åªè¢«å¼±å¼•ç”¨æ‰€å¼•ç”¨äº†ï¼Œå˜æˆâ€å¼±å¯è¾¾â€œï¼Œä¸‹ä¸€æ¬¡GCæ—¶ï¼Œå¼±å¼•ç”¨æŒ‡å‘çš„å¯¹è±¡è¢«ç«‹å³å›æ”¶ã€‚æ¯”å¦‚ä¸‹é¢ä»£ç ï¼š\n1 2 Object obj = new Object(); WeakReference\u0026lt;Object\u0026gt; weakRef = new WeakReference\u0026lt;\u0026gt;(obj); æ­¤æ—¶å¯¹è±¡ç”Ÿå‘½å‘¨æœŸï¼š â€¢\tæœ‰ä¸€ä¸ª å¼ºå¼•ç”¨ï¼ˆobjï¼‰ â€¢\tæœ‰ä¸€ä¸ª å¼±å¼•ç”¨ï¼ˆweakRefï¼‰\nå¯¹è±¡ä¸ä¼šè¢«å›æ”¶ï¼Œå› ä¸ºæœ‰å¼ºå¼•ç”¨ã€‚ å½“obj = nullæ—¶ï¼Œæ­¤æ—¶ï¼š â€¢\tå¯¹è±¡åªè¢«å¼±å¼•ç”¨å¼•ç”¨ â€¢\tå˜æˆäº† â€œå¼±å¯è¾¾â€ï¼ˆWeakly reachableï¼‰ ä¸‹ä¸€é˜¶æ®µå°±æ˜¯GCå›æ”¶å¼±å¼•ç”¨æŒ‡å‘çš„å¯¹è±¡ã€‚ GC åŠ¨ä½œï¼š 1.\tGC æ‰«æå¼±å¼•ç”¨æ‰€å¼•ç”¨çš„å¯¹è±¡ 2.\tå‘ç°å…¶æ²¡æœ‰å¼ºå¼•ç”¨ â†’ ç«‹å³æ¸…é™¤å¯¹è±¡ 3.\tweakRef.get() è¿”å› null 4.\tåŒæ—¶å°† weakRef æ”¾å…¥ ReferenceQueueï¼ˆå¦‚æœä½ åˆ›å»ºäº†çš„è¯ï¼‰ ä¸‹ä¸€é˜¶æ®µï¼šå¼±å¼•ç”¨æœ¬èº«ä»å­˜åœ¨ï¼Œä½†å·²ç»å¤±æ•ˆ\n1 weakRef.get() == null å¼±å¼•ç”¨å¯¹è±¡ï¼ˆWeakReference å®ä¾‹ï¼‰æœ¬èº«ä¸ä¼šè¢«ç«‹å³å›æ”¶ï¼Œå®ƒåªæ˜¯ä¸å†æŒ‡å‘æœ‰æ•ˆå¯¹è±¡ã€‚\næ‰€ä»¥ä¸Šé¢å½“å¼±å¼•ç”¨æ‰€æŒ‡å‘çš„å¯¹è±¡ä¸ºç©ºçš„æ—¶å€™ï¼Œè¯´æ˜EngineResourceå·²ç»è¢«å›æ”¶äº†ã€‚è¯¥ä»ä¸‹ä¸€ä¸ªç¼“å­˜å–äº†ã€‚è‹¥æ‰¾åˆ°äº†ï¼Œè°ƒç”¨EngineResourceçš„acquireï¼š\n1 2 3 4 5 6 7 8 class EngineResource{ synchronized void acquire() { if (isRecycled) { throw new IllegalStateException(\u0026#34;Cannot acquire a recycled resource\u0026#34;); } ++acquired; } } å®ƒè¡¨ç¤ºå½“å‰å›¾ç‰‡æ­£åœ¨ä½¿ç”¨çš„æ¬¡æ•°ï¼Œåé¢ä¼šç”¨åˆ°ï¼ŒçŸ¥é“å½“å‰ç»™acquiredç´¯åŠ æ¬¡æ•°å°±è¡Œã€‚åœ¨ä¸€çº§ç¼“å­˜ä¸­ï¼Œå¯ä»¥çœ‹åˆ°å¼±å¼•ç”¨ä½¿ç”¨äº†å¼•ç”¨é˜Ÿåˆ—ï¼Œå®ƒæ˜¯ç”¨æ¥æ£€æµ‹æˆ‘ä»¬å¼±å¼•ç”¨å¯¹è±¡æ˜¯å¦è¢«å›æ”¶çš„æ ‡å¿—ï¼Œåœ¨ActiveResourcesçš„cleanReferenceQueueæ–¹æ³•ä¸­åˆ¤æ–­é˜Ÿåˆ—ä¸­æ˜¯å¦å­˜åœ¨å¼±å¼•ç”¨å¯¹è±¡ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 void cleanReferenceQueue() { while (!isShutdown) { try { ResourceWeakReference ref = (ResourceWeakReference) resourceReferenceQueue.remove(); cleanupActiveReference(ref); // This section for testing only. DequeuedResourceCallback current = cb; if (current != null) { current.onResourceDequeued(); } // End for testing only. } catch (InterruptedException e) { Thread.currentThread().interrupt(); } } } è¯¥æ–¹æ³•æ˜¯ä¸€ä¸ªwhileå¾ªç¯ï¼Œåªè¦æ²¡æœ‰isShutdownå°±ä¸€ç›´ä»å¼•ç”¨é˜Ÿåˆ—ä¸­æ£€ç´¢å¼±å¼•ç”¨å¯¹è±¡ï¼Œä»å¼•ç”¨é˜Ÿåˆ—ä¸­è·å–åˆ°å¼±å¼•ç”¨å¯¹è±¡ä¹‹åï¼Œæ¥ç€ä¹Ÿæ˜¯è°ƒç”¨äº†cleanupActiveReferenceæ–¹æ³•ï¼Œè¿™ä¸ªåœ¨ä¸Šé¢getæ–¹æ³•ä¸­æœ‰è®²åˆ°è¿‡ã€‚å®ƒæ˜¯ä»mapä¸­ç§»é™¤ResourceWeakReferenceã€‚æ³¨æ„äº†cleanReferenceQueueæ–¹æ³•æ˜¯åœ¨å¤–ç•Œä¼ è¿›æ¥çš„çº¿ç¨‹æ± ï¼ˆExecutors.newSingleThreadExecutorï¼‰ä¸­æ‰§è¡Œçš„ã€‚å®ƒæ˜¯åœ¨ActiveResourcesæ„é€ æ–¹æ³•ä¸­åˆå§‹åŒ–çš„ã€‚\näºŒçº§ç¼“å­˜ æ¥ç€å›åˆ°ä¸Šé¢Engineçš„loadFromMemoryæ–¹æ³•ï¼Œå¦‚æœåœ¨ä¸€çº§ç¼“å­˜ä¸­æ‰¾ä¸åˆ°ï¼Œæ¥ç€è°ƒç”¨äº†loadFromCacheæ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 private EngineResource\u0026lt;?\u0026gt; loadFromCache(Key key) { EngineResource\u0026lt;?\u0026gt; cached = getEngineResourceFromCache(key); if (cached != null) { cached.acquire(); activeResources.activate(key, cached); } return cached; } private final MemoryCache cache; private EngineResource\u0026lt;?\u0026gt; getEngineResourceFromCache(Key key) { Resource\u0026lt;?\u0026gt; cached = cache.remove(key); final EngineResource\u0026lt;?\u0026gt; result; if (cached == null) { result = null; } else if (cached instanceof EngineResource) { result = (EngineResource\u0026lt;?\u0026gt;) cached; } else { result = new EngineResource\u0026lt;\u0026gt;( cached, /* isMemoryCacheable= */ true, /* isRecyclable= */ true, key, /* listener= */ this); } return result; } æ­¤å¤„ä»cacheä¸­å–Resourceï¼Œå¦‚æœå–åˆ°äº†è¿”å›EngineResourceï¼Œæ­¤å¤„çš„cacheæ˜¯LruResourceCacheå¯¹è±¡ï¼Œå®ƒæ˜¯LruCacheå®ç°çš„ã€‚å¯ä»¥çœ‹åˆ°å®ƒæ˜¯è·å–çš„æ—¶å€™ç›´æ¥removeæ‰äº†ï¼Œç´§æ¥ç€è°ƒç”¨acquireï¼Œå¹¶æŠŠç¼“å­˜æ”¾åˆ°ä¸€çº§ç¼“å­˜ä¸­(activeResources.activate)ã€‚ä¹Ÿå°±æ˜¯è¯´å¦‚æœäºŒçº§ç¼“å­˜ä¸­æœ‰æ•°æ®ï¼Œè·å–åˆ°åä»äºŒçº§ç¼“å­˜ä¸­ç§»é™¤æ‰å¹¶æ”¾åˆ°ä¸€çº§ç¼“å­˜ä¸­ï¼Œç„¶åå°†acquiredå˜é‡+1ã€‚ä¸Šé¢ä¼šæ¶‰åŠåˆ°äºŒçº§ç¼“å­˜çš„æœ€å¤§ç¼“å­˜çš„å†…å­˜è®¡ç®—ï¼Œè¿™ä¸ªåœ¨åé¢è®²å†…å­˜çš„æ—¶å€™å†è¯´ã€‚\nä¸‰çº§ç¼“å­˜ å¦‚æœä¸€çº§å’ŒäºŒçº§éƒ½æ²¡æœ‰æ‰¾åˆ°ï¼Œåˆ™ä¼šåœ¨Engineçš„loadæ–¹æ³•ä¸­è°ƒç”¨waitForExistingOrStartNewJobï¼Œåœ¨ä¸»æµç¨‹åŠ è½½å›¾ç‰‡ä¸­è®²è¿‡ResourceCacheGeneratorå’ŒDataCacheGeneratorçš„åŒºåˆ«ï¼ŒResourceCacheGeneratoræ˜¯è·å–æœ¬åœ°ç£ç›˜ç¼–ç åçš„ç¼“å­˜ï¼ŒDataCacheGeneratorä¸­æ˜¯è·å–æœ¬åœ°ç£ç›˜åŸå§‹å›¾ç‰‡çš„ç¼“å­˜ï¼Œæ¥ç€åˆè®²åˆ°äº†SourceGeneratorä¸­é€šè¿‡HttpUrlFetcherè·å–ç½‘ç»œå›¾ç‰‡èµ„æºã€‚å½“ç¬¬ä¸€æ¬¡åŠ è½½å®Œå›¾ç‰‡åï¼Œä¼šä¿å­˜åŸå§‹å›¾ç‰‡åˆ°ç£ç›˜ä¸­ï¼Œè¿™ä¸ªåœ¨SourceGeneratorçš„cacheDataä¸­æœ‰è®²è¿‡ã€‚è§£ç å®Œåï¼Œä¹Ÿä¼šå°†bitmapè¿›è¡Œä¿å­˜åˆ°æœ¬åœ°ç£ç›˜ä¸­ï¼Œè¿™ä¸ªåœ¨DecodeJobä¸­çš„notifyEncodeAndReleaseæ–¹æ³•æœ‰è®²è§£ã€‚æ‰€ä»¥å½“ç¬¬äºŒæ¬¡è·å–å›¾ç‰‡çš„æ—¶å€™æœ‰äº†åŸå§‹å›¾ç‰‡å’Œè§£ç åçš„å›¾ç‰‡ç¼“å­˜äº†ï¼Œçœ‹ä¸‹ResourceCacheGeneratorä¸­å¦‚ä½•è·å–è§£ç åçš„ç¼“å­˜ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 class ResourceCacheGenerator{ public boolean startNext() { currentKey = new ResourceCacheKey( helper.getArrayPool(), sourceId, helper.getSignature(), helper.getWidth(), helper.getHeight(), transformation, resourceClass, helper.getOptions()); cacheFile = helper.getDiskCache().get(currentKey); if (cacheFile != null) { sourceKey = sourceId; modelLoaders = helper.getModelLoaders(cacheFile); modelLoaderIndex = 0; } while (!started \u0026amp;\u0026amp; hasNextModelLoader()) { ModelLoader\u0026lt;File, ?\u0026gt; modelLoader = modelLoaders.get(modelLoaderIndex++); loadData = modelLoader.buildLoadData( cacheFile, helper.getWidth(), helper.getHeight(), helper.getOptions()); if (loadData != null \u0026amp;\u0026amp; helper.hasLoadPath(loadData.fetcher.getDataClass())) { started = true; loadData.fetcher.loadData(helper.getPriority(), this); } } } } å…ˆåˆ›å»ºäº†ResourceCacheKeyçš„keyï¼Œè¿™ä¸ªå’Œå‰é¢åœ¨è§£ç å®Œå›è°ƒä¸­ï¼Œä¹Ÿå°±æ˜¯DecodeJobçš„onResourceDecodedä¸­ä¹Ÿæ˜¯åˆ›å»ºäº†ResourceCacheKeyï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 class DecodeJob{ \u0026lt;Z\u0026gt; Resource\u0026lt;Z\u0026gt; onResourceDecoded(DataSource dataSource, @NonNull Resource\u0026lt;Z\u0026gt; decoded) { Key key = new ResourceCacheKey( decodeHelper.getArrayPool(), currentSourceKey, signature, width, height, appliedTransformation, resourceSubClass, options); deferredEncodeManager.init(key, encoder, lockedResult); } } åˆ›å»ºå®ŒResourceCacheKeyåï¼Œç»§ç»­è°ƒç”¨äº†helper.getDiskCache().get(currentKey)è·å–ç¼“å­˜çš„fileæ–‡ä»¶ï¼Œæ­¤å¤„çš„diskCacheå’Œå‰é¢ä»‹ç»çš„è§£ç å®Œæˆåï¼Œè¿›è¡Œç¼–ç ä¿å­˜bitmapæ‰€ä½¿ç”¨çš„DiskLruCacheWrapperæ˜¯ä¸€è‡´çš„ã€‚è·å–åˆ°fileæ–‡ä»¶åï¼Œé€šè¿‡fileè·å–åˆ°modelLoadersé›†åˆã€‚è¿™ä¸ªå…¶å®è·Ÿå‰é¢ä»‹ç»sourceGeneratorè·å–åˆ°ç½‘ç»œæ•°æ®åï¼Œè°ƒç”¨äº†DataCacheGeneratorçš„startNextæ–¹æ³•ï¼Œåœ¨è¯¥æ–¹æ³•é‡Œé¢ä¹Ÿæ˜¯é€šè¿‡fileè·å–åˆ°ByteBufferFetcherå°†Fileè½¬åŒ–æˆByteBufferã€‚è½¬åŒ–å®Œåå›è°ƒåˆ°ResourceCacheGeneratorçš„onDataReadyæ–¹æ³•ï¼š\n1 2 3 4 5 6 class ResourceCacheGenerator{ public void onDataReady(Object data) { cb.onDataFetcherReady( sourceKey, data, loadData.fetcher, DataSource.RESOURCE_DISK_CACHE, currentKey); } } ç„¶åç»§ç»­å›è°ƒåˆ°DecodeJobçš„onDataFetcherReadyæ–¹æ³•ï¼Œæ³¨æ„äº†æ­¤å¤„çš„dataSourceå›ä¼ çš„æ˜¯DataSource.RESOURCE_DISK_CACHEï¼Œåœ¨å‰é¢ä¸‹è½½å®Œç½‘ç»œèµ„æºåï¼Œå°†Fileè½¬åŒ–æˆByteBufferï¼Œä¹Ÿæ˜¯å›è°ƒç»™DecodeJobçš„onDataFetcherReadyæ–¹æ³•ï¼Œåªä¸è¿‡é‚£ä¸ªdataSourceå›ä¼ çš„æ˜¯DataSource.DATA_DISK_CACHEã€‚ä¹Ÿå°±æ˜¯è¯´DataSource.RESOURCE_DISK_CACHEè¡¨ç¤ºè·å–åˆ°ç›¸åŒå°ºå¯¸çš„bitmapç¼“å­˜ï¼Œè€ŒDataSource.DATA_DISK_CACHEè¡¨ç¤ºè·å–åˆ°åŸå§‹å°ºå¯¸çš„bitmapç¼“å­˜ã€‚å›åˆ°DecodeJobçš„onDataFetcherReadyåï¼Œå°±å›åˆ°äº†è§£ç æµç¨‹ï¼Œè·å–åˆ°ç›¸åŒå°ºå¯¸çš„å›¾ç‰‡åï¼Œä¸ºä»€ä¹ˆè¿˜è¦è¿›è¡Œè§£ç å‘¢ï¼Ÿå› ä¸ºç›®å‰æ‹¿åˆ°çš„è¿˜æ˜¯byteBufferçš„æ•°æ®ï¼Œéœ€è¦å°†å®ƒåŒ…è£…æˆæµï¼Œç„¶åè§£ç æˆbitmapæ•°æ®ï¼Œåªä¸è¿‡åœ¨è§£ç çš„æ—¶å€™ï¼Œå›¾ç‰‡çš„é‡‡æ ·ç‡=1ï¼ŒinTargetDensityå’ŒinDensityçš„æ¯”ä¾‹ç­‰äº1ï¼Œæ‰€ä»¥åªä¸è¿‡æ˜¯å°†æµè½¬åŒ–æˆbitmapè€Œå·²ã€‚è§£ç å®Œåå›åˆ°äº†DecodeJobçš„onResourceDecodedæ–¹æ³•ï¼Œåœ¨è¯¥æ–¹æ³•é‡Œé¢æ¢³ç†è¿‡ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 class DecodeJob{ \u0026lt;Z\u0026gt; Resource\u0026lt;Z\u0026gt; onResourceDecoded(DataSource dataSource, @NonNull Resource\u0026lt;Z\u0026gt; decoded) { @SuppressWarnings(\u0026#34;unchecked\u0026#34;) Class\u0026lt;Z\u0026gt; resourceSubClass = (Class\u0026lt;Z\u0026gt;) decoded.get().getClass(); Transformation\u0026lt;Z\u0026gt; appliedTransformation = null; Resource\u0026lt;Z\u0026gt; transformed = decoded; //å¦‚æœdataSourceæ˜¯RESOURCE_DISK_CACHEå°±ä¸è¿›è¡Œtransformationå¤„ç† if (dataSource != DataSource.RESOURCE_DISK_CACHE) { appliedTransformation = decodeHelper.getTransformation(resourceSubClass); transformed = appliedTransformation.transform(glideContext, decoded, width, height); } if (!decoded.equals(transformed)) { decoded.recycle(); } final EncodeStrategy encodeStrategy = encoder.getEncodeStrategy(options); final ResourceEncoder\u0026lt;Z\u0026gt; encoder = decodeHelper.getResultEncoder(transformed); Resource\u0026lt;Z\u0026gt; result = transformed; boolean isFromAlternateCacheKey = !decodeHelper.isSourceKey(currentSourceKey); //å¦‚æœdataSourceæ˜¯RESOURCE_DISK_CACHEå°±ä¸è¿›è¡Œç¼–ç çš„å‚æ•°åˆå§‹åŒ– if (diskCacheStrategy.isResourceCacheable( isFromAlternateCacheKey, dataSource, encodeStrategy)) { if (encoder == null) { throw new Registry.NoResultEncoderAvailableException(transformed.get().getClass()); } final Key key; switch (encodeStrategy) { case SOURCE: key = new DataCacheKey(currentSourceKey, signature); break; case TRANSFORMED: key = new ResourceCacheKey( decodeHelper.getArrayPool(), currentSourceKey, signature, width, height, appliedTransformation, resourceSubClass, options); break; default: throw new IllegalArgumentException(\u0026#34;Unknown strategy: \u0026#34; + encodeStrategy); } LockedResource\u0026lt;Z\u0026gt; lockedResult = LockedResource.obtain(transformed); deferredEncodeManager.init(key, encoder, lockedResult); result = lockedResult; } return result; } } åœ¨onResourceDecodedæ–¹æ³•ä¸­ï¼Œå¦‚æœdataSourceæ˜¯RESOURCE_DISK_CACHEå°±ä¸è¿›å…¥åˆ°transformationçš„é€»è¾‘ï¼Œå¹¶ä¸”ä¹Ÿä¸è¿›è¡Œç¼–ç çš„å‚æ•°åˆå§‹åŒ–ï¼Œæ‰€ä»¥åœ¨DecodeJobçš„notifyEncodeAndReleaseæ–¹æ³•ä¸­ä¸è¿›è¡Œç¼–ç äº†ï¼Œå› ä¸ºç£ç›˜ä¸­å·²ç»å­˜åœ¨è¯¥ç¼“å­˜ã€‚\nå››çº§ç¼“å­˜ å››çº§ç¼“å­˜åœ¨glideä¸­æ˜¯å­˜å‚¨åŸå§‹æ–‡ä»¶ï¼Œåœ¨ä¸Šä¸€ç¯‡èŠ‚ä¸­è®²è¿‡SourceGeneratoré€šè¿‡HttpUrlFetcherä¸‹è½½å®Œç½‘ç»œèµ„æºåï¼Œä¼šä¿å­˜åŸå§‹æ–‡ä»¶ï¼Œè¿™ä¸ªåœ¨startNextä¸­è°ƒç”¨cacheDataæ–¹æ³•å®ç°çš„ã€‚è€Œè·å–åŸå§‹æ–‡ä»¶çš„ç¼“å­˜æ˜¯åœ¨DataCacheGeneratorçš„startNextå®ç°çš„ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 class DataCacheGenerator{ public boolean startNext() { while (modelLoaders == null || !hasNextModelLoader()) { sourceIdIndex++; if (sourceIdIndex \u0026gt;= cacheKeys.size()) { return false; } Key sourceId = cacheKeys.get(sourceIdIndex); Key originalKey = new DataCacheKey(sourceId, helper.getSignature()); cacheFile = helper.getDiskCache().get(originalKey); if (cacheFile != null) { this.sourceKey = sourceId; modelLoaders = helper.getModelLoaders(cacheFile); modelLoaderIndex = 0; } } loadData = null; boolean started = false; while (!started \u0026amp;\u0026amp; hasNextModelLoader()) { ModelLoader\u0026lt;File, ?\u0026gt; modelLoader = modelLoaders.get(modelLoaderIndex++); loadData = modelLoader.buildLoadData( cacheFile, helper.getWidth(), helper.getHeight(), helper.getOptions()); if (loadData != null \u0026amp;\u0026amp; helper.hasLoadPath(loadData.fetcher.getDataClass())) { started = true; loadData.fetcher.loadData(helper.getPriority(), this); } } return started; } } å’Œå‰é¢ä»‹ç»çš„cacheDataä¿å­˜åŸå§‹æ–‡ä»¶æ˜¯ç›¸å‘¼åº”çš„ï¼Œé¦–å…ˆåˆ›å»ºäº†DataCacheKeyï¼Œç„¶åé€šè¿‡DiskLruCacheWrapperè·å–åˆ°cacheFileæ–‡ä»¶ï¼Œç„¶åå’Œä¸Šé¢è·å–è§£ç åçš„å›¾ç‰‡é€šè¿‡ByteBufferFetcherè½¬åŒ–æˆbyteBufferä¸€æ ·çš„ï¼Œè½¬åŒ–å®ŒbyteBufferåï¼Œå›è°ƒåˆ°DataCacheGeneratorçš„onDataReadyæ–¹æ³•ï¼Œç»§è€Œå›è°ƒåˆ°DecodeJobçš„onDataFetcherReadyæ–¹æ³•ï¼Œå›è°ƒçš„dataSourceæ˜¯DataSource.DATA_DISK_CACHEï¼Œè¡¨ç¤ºåŸå§‹å›¾ç‰‡çš„ç¼“å­˜ã€‚æœ€åç»è¿‡è§£ç ï¼Œè§£ç å®Œæˆåä¼šè¿›è¡Œtransformationæ“ä½œï¼Œæœ€åå®Œæˆbitmapçš„ç¼–ç æ“ä½œã€‚\nä¸€çº§ç¼“å­˜çš„å­˜å‚¨ åœ¨å‰é¢çš„ç« èŠ‚ä¸­éƒ½è®²è¿‡ä¸‰çº§ç¼“å­˜å’Œå››çº§ç¼“å­˜æ˜¯åœ¨ä»€ä¹ˆæ—¶å€™å­˜å‚¨çš„ï¼Œé‚£ä¸€çº§ç¼“å­˜æ˜¯åœ¨ä»€ä¹ˆæ—¶å€™å­˜å‚¨çš„å‘¢ï¼Ÿåœ¨DecodeJobä¸­ç¼–ç å‰ä¼šè°ƒç”¨notifyCompleteæ–¹æ³•ï¼Œåœ¨è¯¥æ–¹æ³•å›è°ƒåˆ°EngineJobçš„onResourceReadyæ–¹æ³•ï¼Œç„¶åä¼šè°ƒç”¨åˆ°notifyCallbacksOfResultï¼Œæ¥ç€ä¼šå›è°ƒåˆ°Engineçš„onEngineJobCompleteæ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 class Engine{ public synchronized void onEngineJobComplete( EngineJob\u0026lt;?\u0026gt; engineJob, Key key, EngineResource\u0026lt;?\u0026gt; resource) { if (resource != null \u0026amp;\u0026amp; resource.isMemoryCacheable()) { activeResources.activate(key, resource); } } } å¦‚æœmemoryç¼“å­˜å¯ç”¨ï¼Œåˆ™è°ƒç”¨ActiveResourcesçš„activateæ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 synchronized void activate(Key key, EngineResource\u0026lt;?\u0026gt; resource) { ResourceWeakReference toPut = new ResourceWeakReference( key, resource, resourceReferenceQueue, isActiveResourceRetentionAllowed); ResourceWeakReference removed = activeEngineResources.put(key, toPut); if (removed != null) { removed.reset(); } } åˆ›å»ºäº†å¼±å¼•ç”¨ï¼Œç„¶åæŠŠå¼±å¼•ç”¨æŒ‡å‘çš„å¼ºå¼•ç”¨å¯¹è±¡åŒ…è£…èµ·æ¥ï¼Œæœ€åæ”¾åˆ°ä¸€çº§ç¼“å­˜çš„mapä¸­ï¼Œputå®Œåä¼šæŠŠè€çš„å¼±å¼•ç”¨å¯¹è±¡ç»™é‡ç½®æ‰ã€‚å…¶å®activateæ–¹æ³•åœ¨å‰é¢ä»‹ç»ä»äºŒçº§ç¼“å­˜ä¸­è·å–åˆ°åï¼Œä¼šä»äºŒçº§ç¼“å­˜ä¸­ç§»é™¤æ‰å¹¶åŠ å…¥åˆ°ä¸€çº§ç¼“å­˜ä¸­ä¹Ÿæ˜¯è°ƒç”¨è¯¥æ–¹æ³•ã€‚\näºŒçº§ç¼“å­˜çš„å­˜å‚¨ äºŒçº§ç¼“å­˜æ˜¯LRUç®—æ³•çš„å†…å­˜ç¼“å­˜ï¼Œå®ƒçš„å­˜å‚¨æ—¶æœºæ˜¯åœ¨ä»€ä¹ˆæ—¶å€™å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥é€šè¿‡åæŸ¥ä»£ç æ¥å®ç°äºŒçº§ç¼“å­˜åœ¨å“ªäº›åœºæ™¯è¢«å­˜å‚¨ï¼š\nä¸€çº§ç¼“å­˜è¢«æ£€æµ‹åˆ°è¢«GCå›æ”¶ï¼Œç„¶åä¼šè¢«åŠ å…¥åˆ°äºŒçº§ç¼“å­˜ä¸­ã€‚ å½“æ£€æµ‹åˆ°å›¾ç‰‡èµ„æºæ²¡æœ‰è¢«ä½¿ç”¨åˆ°ï¼Œä¹Ÿå°±æ˜¯å‰é¢è®²åˆ°çš„acquiredå˜é‡ä¸º0çš„æ—¶å€™ä¹Ÿä¼šåŠ å…¥åˆ°äºŒçº§ç¼“å­˜ä¸­ã€‚ ä¸‹é¢æ ¹æ®è¿™ä¸¤ç§æƒ…å†µä»æºç è§’åº¦åˆ†ä¸‹ä¸‹ã€‚ 1 2 3 4 5 6 7 class Engine{ private final MemoryCache cache; @Override public void onResourceReleased(Key cacheKey, EngineResource\u0026lt;?\u0026gt; resource) { cache.put(cacheKey, resource); } } å…¶ä¸­onResourceReleasedæ˜¯ç”±ä¸¤å¤„è°ƒç”¨ï¼Œä¸€å¤„æ˜¯ActiveResourcesåœ¨cleanupActiveReferenceä¸­è°ƒç”¨ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 class ActiveResources{ void cleanupActiveReference(@NonNull ResourceWeakReference ref) { synchronized (this) { activeEngineResources.remove(ref.key); if (!ref.isCacheable || ref.resource == null) { return; } } EngineResource\u0026lt;?\u0026gt; newResource = new EngineResource\u0026lt;\u0026gt;( ref.resource, /* isMemoryCacheable= */ true, /* isRecyclable= */ false, ref.key, listener); listener.onResourceReleased(ref.key, newResource); } } è¯¥æ–¹æ³•åœ¨è·å–ä¸€çº§ç¼“å­˜çš„æ—¶å€™ï¼Œå¦‚æœå‘ç°å¼±å¼•ç”¨åŒ…è£…çš„å¼ºå¼•ç”¨ä¸ºç©ºï¼Œæˆ–è€…åœ¨æ£€æµ‹åˆ°å¼±å¼•ç”¨é˜Ÿåˆ—ä¸­å­˜åœ¨å¼±å¼•ç”¨çš„æ—¶å€™ï¼Œå°±ä¼šè°ƒç”¨cleanupActiveReferenceæ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯å‘ç”ŸGCçš„æ—¶å€™ï¼Œå‘ç°å¤–ç•Œå¼ºå¼•ç”¨ä¸å†è¢«ä½¿ç”¨çš„æ—¶å€™è°ƒç”¨è¯¥æ–¹æ³•ã€‚\nå¦å¤–ä¸€å¤„æ˜¯ç”±EngineResourceçš„releaseæ–¹æ³•è°ƒç”¨ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 void release() { boolean release = false; synchronized (this) { if (acquired \u0026lt;= 0) { throw new IllegalStateException(\u0026#34;Cannot release a recycled or not yet acquired resource\u0026#34;); } if (--acquired == 0) { release = true; } } if (release) { listener.onResourceReleased(key, this); } } å¯ä»¥çœ‹åˆ°å½“å‘ç°acquiredç­‰äº0çš„æ—¶å€™ï¼Œå°±å¯ä»¥å°†ç¼“å­˜å­˜åˆ°äºŒçº§ç¼“å­˜ä¸­ã€‚è€Œreleaseæ–¹æ³•è°ƒç”¨ç”¨å¾ˆå¤šï¼Œä¸€å¤„æ˜¯ç”±Engineçš„releaseæ–¹æ³•è°ƒç”¨ï¼Œä¸€å¤„æ˜¯ç”±Engineçš„decrementPendingCallbacksæ–¹æ³•è°ƒç”¨ã€‚ä¹Ÿå°±æ˜¯è¯´å½“å‰å›¾ç‰‡èµ„æºå¦‚æœæ²¡æœ‰è¢«å…¶ä»–åœ°æ–¹ä½¿ç”¨ä¹Ÿä¼šè¢«åŠ å…¥åˆ°äºŒçº§ç¼“å­˜ä¸­ã€‚\næ•´ä½“æµç¨‹å›¾å¦‚ä¸‹ï¼š æ€»ç»“ glideç¼“å­˜åˆ†ä¸ºå†…å­˜å’Œç¡¬ç›˜ä¸¤ç±»ï¼Œå…¶ä¸­å†…å­˜ç¼“å­˜åˆåˆ†ä¸ºæ´»è·ƒç¼“å­˜å’ŒLRUç¼“å­˜ï¼Œç¡¬ç›˜ç¼“å­˜åˆ†ä¸ºè§£ç åæŒ‰ç…§viewå°ºå¯¸å±•ç¤ºçš„bitmapç¼“å­˜ï¼Œå¦å¤–ä¸€éƒ¨åˆ†æ˜¯åŸå§‹å›¾ç‰‡çš„ç¼“å­˜ã€‚ æ´»è·ƒç¼“å­˜ï¼šå®ƒçš„ç»“æ„æ˜¯ä¸€ä¸ªhashmapï¼Œå…¶ä¸­keyæ˜¯æŒ‰ç…§urlã€å°ºå¯¸ç­‰ä¿¡æ¯æ‹¼æˆçš„ï¼Œvalueæ˜¯ä¸€ä¸ªå¼±å¼•ç”¨å¯¹è±¡ï¼Œå…¶ä¸­å¼±å¼•ç”¨ä¸­æ”¾çš„æ‰æ˜¯å›¾ç‰‡ç¼“å­˜å¯¹è±¡ï¼Œç‰¹ç‚¹å¦‚ä¸‹ï¼š å­˜å‚¨æ­£åœ¨ä½¿ç”¨çš„å›¾ç‰‡èµ„æº ä½¿ç”¨å¼±å¼•ç”¨ï¼ˆWeakReferenceï¼‰ é€šè¿‡å¼•ç”¨è®¡æ•°ç®¡ç†ç”Ÿå‘½å‘¨æœŸ ä¸ä¼šè¢«LRUç®—æ³•å›æ”¶ LRUç¼“å­˜ï¼šå®ƒåº•å±‚æ˜¯ä¸€ä¸ªLRUç­–ç•¥çš„ç¼“å­˜ï¼Œkeyä¹Ÿæ˜¯å’Œä¸Šé¢æ´»è·ƒç¼“å­˜ç”¨çš„æ˜¯åŒä¸€ä¸ªã€‚valueå­˜çš„æ˜¯è§£ç åçš„å›¾ç‰‡ç¼“å­˜ã€‚ç‰¹ç‚¹å¦‚ä¸‹ï¼š å­˜å‚¨æœ€è¿‘ä½¿ç”¨è¿‡ä½†å½“å‰æœªä½¿ç”¨çš„å›¾ç‰‡ ä½¿ç”¨å¼ºå¼•ç”¨ LRUæ·˜æ±°ç­–ç•¥ï¼ˆæœ€è¿‘æœ€å°‘ä½¿ç”¨åŸåˆ™ï¼‰ æœ‰å¤§å°é™åˆ¶ è§£ç åçš„ç¡¬ç›˜ç¼“å­˜ï¼šä¹Ÿæ˜¯ä½¿ç”¨çš„LRUç­–ç•¥çš„ç¼“å­˜ï¼Œå…¶ä¸­keyæ˜¯æŒ‰ç…§æŒ‡å®šå°ºå¯¸æ¥æ„å»ºçš„ï¼Œç„¶åä»DiskLruCacheä¸­è·å–ç¼“å­˜ã€‚ åŸå§‹å›¾ç‰‡çš„ç¡¬ç›˜ç¼“å­˜ï¼šä¹Ÿæ˜¯ä½¿ç”¨çš„LRUç­–ç•¥çš„ç¼“å­˜ï¼Œå…¶ä¸­keyä¸æ˜¯é€šè¿‡æŒ‡å®šå°ºå¯¸æ¥æ„å»ºçš„ï¼Œç„¶åä¹Ÿæ˜¯ä»DiskLruCacheä¸­è·å–ç¼“å­˜ã€‚\nLRUçš„å†…å­˜ç¼“å­˜æ˜¯åœ¨ä»€ä¹ˆå­˜å‚¨çš„ï¼Ÿ ä»ä¸Šé¢æµç¨‹å›¾æ¥çœ‹æ¯æ¬¡ä»éæ´»è·ƒç¼“å­˜ä¸­è·å–åˆ°å›¾ç‰‡ç¼“å­˜åï¼Œéƒ½ä¼šæ”¾å…¥åˆ°æ´»è·ƒç¼“å­˜ä¸­ï¼Œé‚£ä»€ä¹ˆæ—¶å€™ä¼šæ”¾åˆ°å†…å­˜çš„LRUç¼“å­˜ä¸­å‘¢ï¼Ÿå½“viewè§¦å‘onViewDetachedFromWindowçš„æ—¶å€™ï¼Œä¹Ÿå°±æ˜¯å½“å‰viewé”€æ¯åï¼Œä¼šæŸ¥çœ‹å½“å‰viewç»‘å®šçš„å›¾ç‰‡è¢«æ­£åœ¨ä½¿ç”¨æ ‡è®°çš„æ¬¡æ•°ï¼Œå¦‚æœæ¬¡æ•°ä¸º0äº†ï¼Œåˆ™å°†å½“å‰å›¾ç‰‡åŠ å…¥åˆ°LRUçš„å†…å­˜ç¼“å­˜ä¸­ã€‚ glideä¸ºä»€ä¹ˆè¦è®¾è®¡ä¸¤å±‚çš„å†…å­˜ç¼“å­˜ï¼Ÿ å†…å­˜ç¼“å­˜åˆ†ä¸ºæ´»è·ƒçš„ç¼“å­˜ï¼Œå®ƒæ˜¯ä¸€ä¸ªmapæ•°æ®ç»“æ„ï¼Œvalueå­˜å‚¨çš„æ˜¯å¼±å¼•ç”¨åŒ…è£…äº†ç¼“å­˜æ•°æ®ï¼Œå¦å¤–ä¸€å±‚æ˜¯LRUçº§åˆ«çš„ç¼“å­˜ã€‚æ´»è·ƒæ•°æ®æŒ‡çš„æ˜¯å½“å‰æ­£åœ¨ä½¿ç”¨çš„èµ„æºï¼Œæ¯”å¦‚æ­£åœ¨æ˜¾ç¤ºçš„å›¾ç‰‡ï¼Œè¿™éƒ¨åˆ†ç”¨å¼±å¼•ç”¨æ¥ä¿å­˜ï¼Œè¿™æ ·å½“å›¾ç‰‡ä¸å†è¢«ä½¿ç”¨æ—¶ï¼Œåƒåœ¾å›æ”¶å™¨å¯ä»¥è‡ªåŠ¨å›æ”¶ï¼Œé¿å…å†…å­˜æ³„æ¼ã€‚è€ŒLRUç¼“å­˜åˆ™æ˜¯æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„ç¼“å­˜ï¼Œä½¿ç”¨å¼ºå¼•ç”¨ï¼Œå½“å†…å­˜ä¸è¶³æ—¶ï¼Œä¼šç§»é™¤æœ€ä¹…æœªä½¿ç”¨çš„èµ„æºã€‚ å¦‚æœåªæœ‰LRUç¼“å­˜çš„æ—¶å€™ï¼Œæ­£åœ¨ä½¿ç”¨çš„å›¾ç‰‡å¯èƒ½æ˜¯é•¿æ—¶é—´æ²¡æœ‰è¢«è®¿é—®çš„å›¾ç‰‡ï¼Œè€Œæ­¤æ—¶å¦‚æœåªæœ‰LRUç¼“å­˜çš„æ—¶å€™ï¼Œå¯èƒ½ä¼šæŠŠæ­£åœ¨ä½¿ç”¨çš„å›¾ç‰‡ç¼“å­˜ç»™ç§»é™¤æ‰äº†ï¼Œè¿™æ ·çš„è¯ï¼Œå½“å‰æ­£åœ¨æ˜¾ç¤ºçš„å›¾ç‰‡ä¼šå‡ºç°ç©ºç™½ï¼Œå¹¶ä¸”å½“å†ä½¿ç”¨è¯¥å›¾ç‰‡çš„æ—¶å€™ï¼Œä¼šä»ç£ç›˜ä¸­å»è·å–è¯¥å›¾ç‰‡ï¼Œè¿™æ ·å¢å¤§äº†è·å–å›¾ç‰‡çš„æ—¶é—´ã€‚å¦‚æœåªæœ‰å¼±å¼•ç”¨ç¼“å­˜çš„æ—¶å€™ï¼Œæ­¤æ—¶å›¾ç‰‡ä¸è¢«ä½¿ç”¨äº†ï¼Œè¢«GCç»™å›æ”¶äº†ï¼Œé‚£æ­¤æ—¶ä¹Ÿåªèƒ½ä»ç£ç›˜ä¸­è·å–ï¼Œå¢å¤§äº†è·å–å›¾ç‰‡çš„æ—¶é—´ã€‚å¦‚æœæ­¤æ—¶æœ‰LRUç¼“å­˜ï¼Œèƒ½åœ¨å†…å­˜ä¸­ä¿ç•™ä¸€æ®µæ—¶é—´ï¼Œé™ä½ä»ç£ç›˜ä¸­è¯»å–çš„å¯èƒ½ã€‚ ","date":"2025-12-01T16:47:20+08:00","permalink":"http://xiangcman.xyz/p/glide%E7%BC%93%E5%AD%98%E6%B5%81%E7%A8%8B/","title":"Glideç¼“å­˜æµç¨‹"},{"content":"LoadDataç›¸å…³è®²è§£ glideç¼–ç æµç¨‹ä¸»è¦æ˜¯é€šè¿‡ModelLoaderã€LoadDataç­‰ç±»è¿›è¡Œå®Œæˆçš„ï¼Œä¸‹é¢å…ˆä»‹ç»è¿™å‡ ä¸ªç±»çš„ç±»å›¾å…³ç³»ï¼š\nModelLoader æ˜¯ç”¨æ¥æ„å»ºLoadDataï¼Œè€ŒLoadDataä¸­å¯¹åº”äº†ä¸åŒçš„DataFetcherï¼ŒDataFetcheræ˜¯æœ€ç»ˆåŠ è½½æ•°æ®å±‚ã€‚\nåœ¨ä¸Šä¸€èŠ‚ä¸­ä»‹ç»è¿‡SourceGeneratoråœ¨startNextæ–¹æ³•ä¸­fetcheræ˜¯HttpUrlFetcherï¼Œä»¥åŠåœ¨è·å–åˆ°æ•°æ®åï¼Œè¿›è¡Œä¿å­˜åˆ°ç£ç›˜ï¼Œç„¶åè°ƒç”¨äº†DataCacheGeneratorçš„startNextæ–¹æ³•ï¼Œç„¶ååœ¨é‡Œé¢ç”¨åˆ°äº†ByteBufferFetcherï¼Œå®ƒä»¬éƒ½æ˜¯æ€ä¹ˆæ¥çš„å‘¢ï¼Ÿä¸‹é¢é€šè¿‡æºç åˆ†æå¦‚ä½•è·å–çš„ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 class SourceGenerator{ public void startNext(){ loadData = null; boolean started = false; while (!started \u0026amp;\u0026amp; hasNextModelLoader()) { loadData = helper.getLoadData().get(loadDataListIndex++); if (loadData != null \u0026amp;\u0026amp; (helper.getDiskCacheStrategy().isDataCacheable(loadData.fetcher.getDataSource()) || helper.hasLoadPath(loadData.fetcher.getDataClass()))) { started = true; startNextLoad(loadData); } } } } åœ¨SourceGeneratorçš„startNextæ–¹æ³•ä¸­æœ‰ä¸Šé¢ä»£ç ï¼Œé¦–å…ˆé€šè¿‡hasNextModelLoaderæ–¹æ³•åˆ¤æ–­æœ‰æ²¡æœ‰åˆé€‚çš„LoadDataï¼š\n1 2 3 private boolean hasNextModelLoader() { return loadDataListIndex \u0026lt; helper.getLoadData().size(); } åˆ¤æ–­å½“å‰ç´¢å¼•æ˜¯å¦å°äºhelperè·å–çš„loadDataçš„æ•°é‡ï¼Œhelperæ˜¯DecodeHelperè¾…åŠ©ç±»ï¼Œå®ƒæ˜¯åœ¨DecodeJobä¸­åˆå§‹åŒ–çš„ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 List\u0026lt;LoadData\u0026lt;?\u0026gt;\u0026gt; getLoadData() { if (!isLoadDataSet) { isLoadDataSet = true; loadData.clear(); List\u0026lt;ModelLoader\u0026lt;Object, ?\u0026gt;\u0026gt; modelLoaders = glideContext.getRegistry().getModelLoaders(model); for (int i = 0, size = modelLoaders.size(); i \u0026lt; size; i++) { ModelLoader\u0026lt;Object, ?\u0026gt; modelLoader = modelLoaders.get(i); LoadData\u0026lt;?\u0026gt; current = modelLoader.buildLoadData(model, width, height, options); if (current != null) { loadData.add(current); } } } return loadData; } glideContextæ˜¯glideç»Ÿä¸€çš„ä¸Šä¸‹æ–‡ï¼Œå®ƒç»§æ‰¿è‡ªContextWrapperï¼Œæ˜¯åœ¨Glideå¯¹è±¡åˆå§‹åŒ–çš„æ—¶å€™åˆ›å»ºçš„ï¼Œæ¥ç€è°ƒç”¨äº†getRegistryæ–¹æ³•ï¼Œè¯¥æ–¹æ³•çš„å®šä¹‰å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 public final class GlideSuppliers { public interface GlideSupplier\u0026lt;T\u0026gt; { T get(); } private GlideSuppliers() {} public static \u0026lt;T\u0026gt; GlideSupplier\u0026lt;T\u0026gt; memorize(final GlideSupplier\u0026lt;T\u0026gt; supplier) { return new GlideSupplier\u0026lt;T\u0026gt;() { private volatile T instance; @Override public T get() { if (instance == null) { synchronized (this) { if (instance == null) { instance = Preconditions.checkNotNull(supplier.get()); } } } return instance; } }; } } public class GlideContext{ private final GlideSupplier\u0026lt;Registry\u0026gt; registry; public GlideContext(@NonNull Context context,@NonNull GlideSupplier\u0026lt;Registry\u0026gt; registry) { super(context.getApplicationContext()); this.registry = GlideSuppliers.memorize(registry); } public Registry getRegistry() { return registry.get(); } } getRegistryæ–¹æ³•ä¸­æ˜¯è°ƒç”¨äº†GlideContextçš„registryå˜é‡çš„getæ–¹æ³•ï¼Œè€Œregistryå˜é‡æ˜¯é€šè¿‡GlideSuppliers.memorizeæ„å»ºçš„ï¼ŒGlideSupplieræ˜¯ä¸€ä¸ªæ¥å£ï¼Œå®šä¹‰äº†getæ–¹æ³•ï¼Œè€Œåœ¨GlideSuppliers.memorizeæ–¹æ³•ä¸­è¿”å›çš„GlideSupplierå¯¹è±¡ä¸­é‡å†™çš„getæ–¹æ³•æ˜¯é€šè¿‡memorizeæ–¹æ³•supplierå‚æ•°çš„getæ¥è·å–çš„ã€‚ä¹Ÿå°±æ˜¯è¯´åˆ›å»ºGlideSupplierå¯¹è±¡äº¤ç»™äº†å¤–ç•Œæ¥åˆ›å»ºã€‚ä¸ºä»€ä¹ˆåœ¨memorizeæ–¹æ³•ä¸­ä¸ç›´æ¥è¿”å›supplier.get()å‘¢ï¼Ÿè€Œéœ€è¦åœ¨memorizeåŒ…è£…ä¸€ä¸ªåŒ¿åçš„GlideSupplierï¼Œè¿™æ˜¯å› ä¸ºåœ¨ä¸šåŠ¡å±‚å¤šå¤„è°ƒç”¨GlideContextçš„getRegistryæ–¹æ³•ï¼Œå¦‚æœåœ¨memorizeæ–¹æ³•ä¸­ç›´æ¥è°ƒç”¨supplier.get()ï¼Œé‚£ä¹ˆæ¯æ¬¡è¿”å›æ–°çš„Registryå®ä¾‹ï¼Œæ‰€ä»¥åœ¨memorizeæ–¹æ³•ä¸­å®šä¹‰äº†ä¸€ä¸ªåŒ¿åçš„GlideSupplierï¼Œåœ¨å®ƒçš„getæ–¹æ³•é‡Œé¢é€šè¿‡åŒé‡åŠ é”æ¥æ§åˆ¶å•ä¸€çš„Registryå®ä¾‹ã€‚å¤–ç•Œä¼ è¿›æ¥çš„GlideSupplieræ˜¯åœ¨åˆ›å»ºGlideå¯¹è±¡çš„æ—¶å€™æ„å»ºçš„ï¼š\n1 2 3 4 Glide(@NonNull Context context) { GlideSupplier\u0026lt;Registry\u0026gt; registry = RegistryFactory.lazilyCreateAndInitializeRegistry(this, manifestModules, annotationGeneratedModule); glideContext =new GlideContext(context,registry); } å¤–ç•Œä¼ è¿›æ¥çš„GlideSupplieræ˜¯é€šè¿‡RegistryFactory.lazilyCreateAndInitializeRegistryæ¥åˆ›å»ºçš„ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 static GlideSupplier\u0026lt;Registry\u0026gt; lazilyCreateAndInitializeRegistry(){ return createAndInitRegistry(glide, manifestModules, annotationGeneratedModule); } static Registry createAndInitRegistry( Glide glide, List\u0026lt;GlideModule\u0026gt; manifestModules, @Nullable AppGlideModule annotationGeneratedModule) { BitmapPool bitmapPool = glide.getBitmapPool(); ArrayPool arrayPool = glide.getArrayPool(); Context context = glide.getGlideContext().getApplicationContext(); GlideExperiments experiments = glide.getGlideContext().getExperiments(); Registry registry = new Registry(); initializeDefaults(context, registry, bitmapPool, arrayPool, experiments); initializeModules(context, glide, registry, manifestModules, annotationGeneratedModule); return registry; } è¿™æ ·å°†Registryçš„åˆå§‹åŒ–äº¤ç»™äº†RegistryFactoryæ¥åˆ›å»ºï¼Œæ‰€æœ‰çš„é…ç½®æ”¶æ‹¢åˆ°ä¸€å—ï¼Œæ›´åŠ èšåˆã€‚å›åˆ°ä¸Šé¢DecodeHelperçš„getLoadDataæ–¹æ³•ï¼Œæ¥ç€è°ƒç”¨äº†Registryçš„getModelLoadersæ–¹æ³•ï¼š\n1 2 3 public \u0026lt;Model\u0026gt; List\u0026lt;ModelLoader\u0026lt;Model, ?\u0026gt;\u0026gt; getModelLoaders(@NonNull Model model) { return modelLoaderRegistry.getModelLoaders(model); } modelLoaderRegistryæ˜¯åœ¨Registryä¸­åˆå§‹åŒ–çš„ï¼Œçœ‹ä¸‹å®ƒçš„getModelLoadersæ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 public \u0026lt;A\u0026gt; List\u0026lt;ModelLoader\u0026lt;A, ?\u0026gt;\u0026gt; getModelLoaders(@NonNull A model) { List\u0026lt;ModelLoader\u0026lt;A, ?\u0026gt;\u0026gt; modelLoaders = getModelLoadersForClass(getClass(model)); int size = modelLoaders.size(); boolean isEmpty = true; List\u0026lt;ModelLoader\u0026lt;A, ?\u0026gt;\u0026gt; filteredLoaders = Collections.emptyList(); for (int i = 0; i \u0026lt; size; i++) { ModelLoader\u0026lt;A, ?\u0026gt; loader = modelLoaders.get(i); if (loader.handles(model)) { if (isEmpty) { filteredLoaders = new ArrayList\u0026lt;\u0026gt;(size - i); isEmpty = false; } filteredLoaders.add(loader); } } return filteredLoaders; } private synchronized \u0026lt;A\u0026gt; List\u0026lt;ModelLoader\u0026lt;A, ?\u0026gt;\u0026gt; getModelLoadersForClass( @NonNull Class\u0026lt;A\u0026gt; modelClass) { List\u0026lt;ModelLoader\u0026lt;A, ?\u0026gt;\u0026gt; loaders = cache.get(modelClass); if (loaders == null) { loaders = Collections.unmodifiableList(multiModelLoaderFactory.build(modelClass)); cache.put(modelClass, loaders); } return loaders; } åœ¨getModelLoadersé€šè¿‡modelçš„Classç±»å‹ï¼Œè°ƒç”¨äº†getModelLoadersForClassæ–¹æ³•ï¼Œåœ¨è¯¥æ–¹æ³•é‡Œé¢ä»cacheé‡Œé¢å–æ‹¿ModelLoaderé›†åˆï¼Œå®ƒæ˜¯åŒ…è£…mapçš„ModelLoaderCacheç±»ï¼Œé¦–æ¬¡ä¸ºç©ºï¼Œæ¥ç€è°ƒç”¨äº†multiModelLoaderFactory.build(modelClass)æŠŠloadersæ”¾åˆ°cacheä¸­ã€‚æ³¨æ„ä¸‹ï¼Œè¯¥æ–¹æ³•ä¸­ä½¿ç”¨Collections.unmodifiableListåŒ…è£…äº†ä¸€å±‚é›†åˆï¼Œè¯¥é›†åˆä¸å…è®¸è¿›è¡Œæ·»åŠ å…ƒç´ ï¼Œä¸»è¦æ˜¯ä¸ºäº†ä¸è®©åç»­æ·»åŠ æ–°çš„ModelLoaderï¼Œé˜²æ­¢åœ¨è¾¹éå†çš„æ—¶å€™ä¼šæœ‰å…¶ä»–åœ°æ–¹æ·»åŠ å…ƒç´ è€Œäº§ç”ŸConcurrentModificationExceptionå¼‚å¸¸ã€‚å¹¶ä¸”æ­¤å¤„ä½¿ç”¨äº†cacheç¼“å­˜ï¼Œä¸‹æ¬¡ç›´æ¥ä»è¯¥mapä¸­å–è¯¥modelä¸‹çš„ModelLoaderé›†åˆï¼Œæ— éœ€å†æ¬¡è¿›è¡Œæ„å»ºã€‚çœ‹ä¸‹è¯¥æ–¹æ³•æ€ä¹ˆè·å–loadersçš„ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 synchronized \u0026lt;Model\u0026gt; List\u0026lt;ModelLoader\u0026lt;Model, ?\u0026gt;\u0026gt; build(@NonNull Class\u0026lt;Model\u0026gt; modelClass) { try { List\u0026lt;ModelLoader\u0026lt;Model, ?\u0026gt;\u0026gt; loaders = new ArrayList\u0026lt;\u0026gt;(); for (Entry\u0026lt;?, ?\u0026gt; entry : entries) { if (alreadyUsedEntries.contains(entry)) { continue; } if (entry.handles(modelClass)) { alreadyUsedEntries.add(entry); loaders.add(this.\u0026lt;Model, Object\u0026gt;build(entry)); alreadyUsedEntries.remove(entry); } } return loaders; } catch (Throwable t) { alreadyUsedEntries.clear(); throw t; } } entriesæ˜¯Entryå¯¹è±¡çš„é›†åˆï¼Œæ³¨æ„äº†ä¸Šé¢ä½¿ç”¨äº†alreadyUsedEntriesé›†åˆæ ‡è®°Entryæœ‰æ²¡æœ‰è¢«æ„å»ºï¼Œæ¯”å¦‚åœ¨æ„å»ºaè¿™ä¸ªmodelLoaderä¸­åˆå»æ„å»ºbè¿™ä¸ªmodelLoaderï¼Œè€Œåœ¨bä¸­åˆå»æ„å»ºaï¼Œè¿™å°±å¯¼è‡´å¾ªç¯æ„å»ºï¼Œæ­¤æ—¶é€šè¿‡è¯¥é›†åˆèƒ½è§£å†³è¿™ä¸ªå¾ªç¯ä¾èµ–é—®é¢˜ï¼Œä»¥åŠè§£å†³é‡å¤æ„å»ºçš„é—®é¢˜ï¼Œæ¯”å¦‚åœ¨aä¸­éœ€è¦æ„å»ºbï¼Œé‚£ä¸‹æ¬¡æ„å»ºbçš„æ—¶å€™å°±æ— éœ€å†æ¬¡æ„å»ºäº†ã€‚Entryå¯¹è±¡é‡Œé¢å­˜å‚¨äº†modelClassã€dataClassã€modelLoaderFactoryï¼š\n1 2 3 4 5 private static class Entry\u0026lt;Model, Data\u0026gt; { private final Class\u0026lt;Model\u0026gt; modelClass; @Synthetic final Class\u0026lt;Data\u0026gt; dataClass; @Synthetic final ModelLoaderFactory\u0026lt;? extends Model, ? extends Data\u0026gt; factory; } è€Œentriesé›†åˆä¸­çš„Entryå…ƒç´ æ˜¯åœ¨ä¸Šé¢åˆ†æRegistryå¯¹è±¡åˆ›å»ºè¿‡ç¨‹ä¸­çš„RegistryFactoryä¸­æ·»åŠ è¿›æ¥çš„ï¼š\n1 2 3 4 5 6 7 8 9 public class RegistryFactory{ private static void initializeDefaults(Registry registry){ registry .append(String.class, InputStream.class, new DataUrlLoader.StreamFactory\u0026lt;String\u0026gt;()) .append(String.class, InputStream.class, new StringLoader.StreamFactory()) .append(String.class, ParcelFileDescriptor.class, new StringLoader.FileDescriptorFactory()) .append(String.class, AssetFileDescriptor.class, new StringLoader.AssetFileDescriptorFactory()) } } appendæ–¹æ³•ä¸‰ä¸ªå‚æ•°å¯¹åº”åˆ†åˆ«å¯¹åº”äº†ä¸Šé¢Entryå¯¹è±¡çš„modelClassã€dataClassã€ModelLoaderFactoryï¼Œæ‰€ä»¥åœ¨ä¸Šé¢multiModelLoaderFactoryçš„buildæ–¹æ³•ä¸­éå†entriesæ—¶å€™ï¼Œé€šè¿‡entryçš„handles(modelClass)æ¥è¿›è¡Œè¿‡æ»¤ï¼š\n1 2 3 public boolean handles(@NonNull Class\u0026lt;?\u0026gt; modelClass) { return this.modelClass.isAssignableFrom(modelClass); } å¦‚æœä¼ è¿›æ¥çš„æ˜¯Stringç±»å‹ï¼Œåˆ™ä¼šè¿‡æ»¤å‡ºä¸Šé¢4ä¸ªé€šè¿‡appendæ–¹æ³•æ„å»ºçš„Entryå¯¹è±¡ï¼Œæ¥ç€ä¼šè°ƒç”¨multiModelLoaderFactoryçš„build(entry)æ–¹æ³•ï¼š\n1 2 3 private \u0026lt;Model, Data\u0026gt; ModelLoader\u0026lt;Model, Data\u0026gt; build(@NonNull Entry\u0026lt;?, ?\u0026gt; entry) { return (ModelLoader\u0026lt;Model, Data\u0026gt;) Preconditions.checkNotNull(entry.factory.build(this)); } é€šè¿‡entryçš„factoryçš„buildæ–¹æ³•åˆ›å»ºModelLoaderï¼Œä¸Šé¢4ä¸ªentryçš„factoryåˆ†åˆ«æ˜¯ DataUrlLoader.StreamFactory ã€ StringLoader.StreamFactory ã€ StringLoader.FileDescriptorFactory ã€ StringLoader.AssetFileDescriptorFactory ï¼Œåˆ†åˆ«è°ƒç”¨å®ƒä»¬çš„buildæ–¹æ³•åˆ›å»ºä¸åŒçš„ModelLoader:\n1 2 3 public ModelLoader\u0026lt;Model, InputStream\u0026gt; build(@NonNull MultiModelLoaderFactory multiFactory) { return new DataUrlLoader\u0026lt;\u0026gt;(opener); } æ‰€ä»¥è¿”å›äº†4ä¸ªModelLoaderåˆ†åˆ«æ˜¯DataUrlLoaderã€StringLoaderã€StringLoaderã€StringLoaderã€‚ç»§ç»­å›åˆ°ModelLoaderRegistryçš„getModelLoadersæ–¹æ³•ï¼Œæ¥ç€é€šè¿‡ModelLoaderçš„handles(modelClass)æ¥è¿‡æ»¤ï¼ŒDataUrlLoaderçš„handlesæ–¹æ³•å¦‚ä¸‹ï¼š\n1 2 3 4 5 private static final String DATA_SCHEME_IMAGE = \u0026#34;data:image\u0026#34;; @Override public boolean handles(@NonNull Model model) { return model.toString().startsWith(DATA_SCHEME_IMAGE); } DataUrlLoaderä¸­å¿…é¡»è¦æ±‚modelæ˜¯ä»¥ data:image å¼€å¤´æ‰è¡Œï¼Œè€ŒStringLoaderçš„handles(modelClass)å¦‚ä¸‹ï¼š\n1 2 3 4 @Override public boolean handles(@NonNull String model) { return true; } æ‰€ä»¥modelLoaderRegistryçš„getModelLoadersæ–¹æ³•è¿”å›åé¢3ä¸ªStringLoaderäº†ã€‚ç»§ç»­å›åˆ°DecodeJobçš„getLoadDataæ–¹æ³•ï¼Œè·å–åˆ°3ä¸ªModelLoaderåï¼Œç»§ç»­è°ƒç”¨å®ƒä»¬çš„buildLoadDataæ–¹æ³•æ¥è·å–LoadDataï¼Œå®ƒä»¬éƒ½æ˜¯StringLoaderï¼Œæ¥çœ‹ä¸‹å®ƒçš„buildLoadDataæ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 @Override public LoadData\u0026lt;Data\u0026gt; buildLoadData( @NonNull String model, int width, int height, @NonNull Options options) { Uri uri = parseUri(model); if (uri == null || !uriLoader.handles(uri)) { return null; } return uriLoader.buildLoadData(uri, width, height, options); } é¦–å…ˆå°†modelè½¬åŒ–æˆuriï¼Œç„¶åè°ƒç”¨uriLoader.handles(uri)è¿‡æ»¤ï¼Œåœ¨StringLoaderä¸­çš„uriLoaderæ˜¯ä¸€ä¸ªMultiModelLoader(ç»§æ‰¿è‡ªModelLoaderï¼Œè¿™å…¶å®å°±æ˜¯ä¸ªä»£ç†æ¨¡å¼ï¼Œå°†åˆ›å»ºLoadDataäº¤ç»™äº†å¤–ç•Œä¼ æ¥çš„ModelLoader)ï¼Œå®ƒæ˜¯åœ¨åˆ›å»ºStringLoaderçš„æ—¶å€™ä¼ è¿›æ¥çš„ï¼Œæ¯”å¦‚ç¬¬ä¸€ä¸ªStringLoaderåˆ›å»ºå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 public static class StreamFactory implements ModelLoaderFactory\u0026lt;String, InputStream\u0026gt; { @NonNull @Override public ModelLoader\u0026lt;String, InputStream\u0026gt; build(@NonNull MultiModelLoaderFactory multiFactory) { return new StringLoader\u0026lt;\u0026gt;(multiFactory.build(Uri.class, InputStream.class)); } } public synchronized \u0026lt;Model, Data\u0026gt; ModelLoader\u0026lt;Model, Data\u0026gt; build( @NonNull Class\u0026lt;Model\u0026gt; modelClass, @NonNull Class\u0026lt;Data\u0026gt; dataClass) { try { List\u0026lt;ModelLoader\u0026lt;Model, Data\u0026gt;\u0026gt; loaders = new ArrayList\u0026lt;\u0026gt;(); boolean ignoredAnyEntries = false; for (Entry\u0026lt;?, ?\u0026gt; entry : entries) { if (alreadyUsedEntries.contains(entry)) { ignoredAnyEntries = true; continue; } if (entry.handles(modelClass, dataClass)) { alreadyUsedEntries.add(entry); loaders.add(this.\u0026lt;Model, Data\u0026gt;build(entry)); alreadyUsedEntries.remove(entry); } } if (loaders.size() \u0026gt; 1) { return factory.build(loaders, throwableListPool); } else if (loaders.size() == 1) { return loaders.get(0); } else { if (ignoredAnyEntries) { return emptyModelLoader(); } else { throw new NoModelLoaderAvailableException(modelClass, dataClass); } } } catch (Throwable t) { alreadyUsedEntries.clear(); throw t; } } public boolean handles(@NonNull Class\u0026lt;?\u0026gt; modelClass, @NonNull Class\u0026lt;?\u0026gt; dataClass) { return handles(modelClass) \u0026amp;\u0026amp; this.dataClass.isAssignableFrom(dataClass); } static class Factory { @NonNull public \u0026lt;Model, Data\u0026gt; MultiModelLoader\u0026lt;Model, Data\u0026gt; build( @NonNull List\u0026lt;ModelLoader\u0026lt;Model, Data\u0026gt;\u0026gt; modelLoaders, @NonNull Pool\u0026lt;List\u0026lt;Throwable\u0026gt;\u0026gt; throwableListPool) { return new MultiModelLoader\u0026lt;\u0026gt;(modelLoaders, throwableListPool); } } ä¸Šé¢MultiModelLoaderFactoryçš„buildä¸¤å‚(modelClasså’ŒdataClass)å’Œå‰é¢ä»‹ç»çš„å•å‚buildæ–¹æ³•å…¶å®ç±»ä¼¼ï¼Œåªä¸è¿‡è¿™é‡Œå¯èƒ½ä¼šåˆ›å»ºä¸€ä¸ªMultiModelLoaderï¼Œå…¶å®è¿™é‡Œå°±æ˜¯ModelLoaderçš„ä¾èµ–æ„å»ºã€‚ç›´æ¥çœ‹ä¸‰ä¸ªStringLoaderçš„æ„å»ºç»“æœï¼š\nStringLoader:uriLoader = MultiModelLoader(modelLoaders= [DataUrlLoader, AssetUriLoader, MediaStoreImageThumbLoader, MediaStoreVideoThumbLoader, QMediaStoreUriLoader, UriLoader, UrlUriLoader, UrlUriLoader]) StringLoader:uriLoader = MultiModelLoader(modelLoaders= [QMediaStoreUriLoader, UriLoader]) StringLoader:uriLoader = MultiModelLoader(modelLoaders= [ResourceUriLoader, AssetUriLoader, UriLoader]) æ‰€ä»¥ç»è¿‡StringLoaderçš„uriLoader(MultiModelLoader)çš„handlesæ–¹æ³•è¿‡æ»¤ï¼š\n1 2 3 4 5 6 7 8 9 @Override public boolean handles(@NonNull Model model) { for (ModelLoader\u0026lt;Model, Data\u0026gt; modelLoader : modelLoaders) { if (modelLoader.handles(model)) { return true; } } return false; } éå†modelLoadersï¼Œç„¶åè°ƒç”¨æ¯ä¸€ä¸ªmodelLoaderçš„handlesæ–¹æ³•ï¼Œæœ€ç»ˆåªæœ‰ç¬¬ä¸€ä¸ªStringLoaderé€šè¿‡ï¼Œæ˜¯å› ä¸ºUrlUriLoaderçš„handlesæ–¹æ³•é€šè¿‡ï¼š\n1 2 3 4 5 6 7 8 public class UrlUriLoader\u0026lt;Data\u0026gt; implements ModelLoader\u0026lt;Uri, Data\u0026gt; { private static final Set\u0026lt;String\u0026gt; SCHEMES = Collections.unmodifiableSet(new HashSet\u0026lt;\u0026gt;(Arrays.asList(\u0026#34;http\u0026#34;, \u0026#34;https\u0026#34;))); @Override public boolean handles(@NonNull Uri uri) { return SCHEMES.contains(uri.getScheme()); } } ç»§ç»­å›åˆ°StringLoaderçš„buildLoadDataæ–¹æ³•ï¼Œæ¥ç€ä¼šè°ƒç”¨uriLoader.buildLoadDataçš„æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯MultiModelLoaderçš„æ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 public LoadData\u0026lt;Data\u0026gt; buildLoadData( @NonNull Model model, int width, int height, @NonNull Options options) { Key sourceKey = null; int size = modelLoaders.size(); List\u0026lt;DataFetcher\u0026lt;Data\u0026gt;\u0026gt; fetchers = new ArrayList\u0026lt;\u0026gt;(size); for (int i = 0; i \u0026lt; size; i++) { ModelLoader\u0026lt;Model, Data\u0026gt; modelLoader = modelLoaders.get(i); if (modelLoader.handles(model)) { LoadData\u0026lt;Data\u0026gt; loadData = modelLoader.buildLoadData(model, width, height, options); if (loadData != null) { sourceKey = loadData.sourceKey; fetchers.add(loadData.fetcher); } } } return !fetchers.isEmpty() \u0026amp;\u0026amp; sourceKey != null ? new LoadData\u0026lt;\u0026gt;(sourceKey, new MultiFetcher\u0026lt;\u0026gt;(fetchers, exceptionListPool)) : null; } æœ€ç»ˆäº¤ç»™äº†UrlUriLoaderçš„buildLoadDataæ–¹æ³•è·å–LoadDataï¼š\n1 2 3 4 5 public LoadData\u0026lt;Data\u0026gt; buildLoadData( @NonNull Uri uri, int width, int height, @NonNull Options options) { GlideUrl glideUrl = new GlideUrl(uri.toString()); return urlLoader.buildLoadData(glideUrl, width, height, options); } å®ƒåˆäº¤ç»™äº†urlLoaderçš„buildLoadDataæ–¹æ³•è·å–LoadDataï¼Œæ­¤å¤„çš„urlLoaderå®é™…æ˜¯HttpGlideUrlLoaderï¼Œå®ƒæ˜¯åœ¨UrlUriLoaderåˆ›å»ºçš„æ—¶å€™è·å–çš„ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 public LoadData\u0026lt;InputStream\u0026gt; buildLoadData( @NonNull GlideUrl model, int width, int height, @NonNull Options options) { GlideUrl url = model; if (modelCache != null) { url = modelCache.get(model, 0, 0); if (url == null) { modelCache.put(model, 0, 0, model); url = model; } } int timeout = options.get(TIMEOUT); return new LoadData\u0026lt;\u0026gt;(url, new HttpUrlFetcher(url, timeout)); } æ‰€ä»¥æœ€ç»ˆçš„LoadDataæ˜¯æ­¤å¤„åˆ›å»ºçš„ï¼Œfetcheræ˜¯HttpUrlFetcherã€‚\nä¸ºä»€ä¹ˆGlideåœ¨åˆ›å»ºModelLoaderçš„æ—¶å€™ä¸ç›´æ¥åœ¨registryé˜¶æ®µä¸ç›´æ¥æŠŠå¯¹åº”çš„ModelLoaderç»„è£…æˆEntryï¼Œè€Œè¦é€šè¿‡ModelLoaderFactoryæ¥åˆ›å»ºModelLoaderï¼Ÿ ä¸Šé¢è¯´è¿‡ModelLoaderçš„åˆ›å»ºå¯èƒ½ä¾èµ–å…¶å®ƒçš„ModelLoaderï¼Œå¦‚æœæŠŠModelLoaderç›´æ¥åˆ›å»ºå‡ºæ¥ï¼Œç›¸å½“äºæŠŠä¾èµ–çš„ModelLoaderä¹Ÿåˆ›å»ºå‡ºæ¥äº†ï¼Œè¿™æ ·ä¼šæŠŠä¸€äº›ä¸ä½¿ç”¨çš„ModelLoaderä¹Ÿåˆ›å»ºå‡ºæ¥äº†ï¼Œç»“æœå°±æ˜¯åˆ›å»ºä¸€äº›æ— ç”¨çš„ModelLoaderå‡ºæ¥ï¼Œé‚£æ ·å†…å­˜ä¹Ÿä¼šå¢åŠ å¾ˆå¤§ï¼Œè€Œç”¨ModelLoaderFactoryçš„å½¢å¼æ³¨å†Œï¼Œåªéœ€è¦æ³¨å†Œä¸€ä¸ªç©ºçš„ModelLoaderFactoryå°±è¡Œï¼Œå†…å­˜ä¸Šå¾—åˆ°æ§åˆ¶ã€‚\nInputStreamåˆ°æ–‡ä»¶ åœ¨å‰é¢åˆ†æåŠ è½½æµç¨‹çš„æ—¶å€™ï¼Œè®²è¿‡SourceGeneratorè·å–åˆ°InputStreamåï¼Œå°†è¯¥InputStreamä¿å­˜åˆ°æœ¬åœ°æ–‡ä»¶ä¸­ï¼Œè¿™ä¸ªè¿‡ç¨‹æ¶‰åŠåˆ°ä¸€æ¬¡ç¼–ç ï¼Œç„¶åå°†æ–‡ä»¶è½¬æˆbyteBufferåï¼Œå®Œæˆbitmapçš„è§£ç ï¼Œæœ€åå°†bitmapåˆè¿›è¡Œä¸€æ¬¡ç¼–ç ï¼Œè¿™ä¸€æ¬¡æ˜¯å¯¹ç¼©æ”¾åçš„å›¾ç‰‡è¿›è¡Œç¼–ç ã€‚æˆ‘ä»¬å…ˆçœ‹ä¸‹SourceGeneratorä¸­å¦‚ä½•å°†InputStreamä¿å­˜åˆ°æœ¬åœ°æ–‡ä»¶ï¼Œé¦–å…ˆçœ‹ä¸‹SourceGeneratorçš„startNextæ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 class SourceGenerator{ public boolean startNext() { if (dataToCache != null) { Object data = dataToCache; dataToCache = null; boolean isDataInCache = cacheData(data); if (!isDataInCache) { return true; } } if (sourceCacheGenerator != null \u0026amp;\u0026amp; sourceCacheGenerator.startNext()) { return true; } } } HttpUrlFetcherå›è°ƒåˆ°SourceGeneratoråï¼ŒdataToCacheå°±ä¸ä¸ºç©ºäº†ï¼Œæ‰€ä»¥ä¼šè°ƒç”¨cacheData(InputStream)ä¿å­˜åˆ°æœ¬åœ°ç£ç›˜ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 private boolean cacheData(Object dataToCache) throws IOException { DataRewinder\u0026lt;Object\u0026gt; rewinder = helper.getRewinder(dataToCache); Object data = rewinder.rewindAndGet(); Encoder\u0026lt;Object\u0026gt; encoder = helper.getSourceEncoder(data); DataCacheWriter\u0026lt;Object\u0026gt; writer = new DataCacheWriter\u0026lt;\u0026gt;(encoder, data, helper.getOptions()); DataCacheKey newOriginalKey = new DataCacheKey(loadData.sourceKey, helper.getSignature()); DiskCache diskCache = helper.getDiskCache(); diskCache.put(newOriginalKey, writer); if (diskCache.get(newOriginalKey) != null) { originalKey = newOriginalKey; sourceCacheGenerator = new DataCacheGenerator(Collections.singletonList(loadData.sourceKey), helper, this); return true; } return false; } helperæ˜¯DecodeHelperï¼Œè°ƒç”¨äº†getRewinderæ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 public class DecodeHelper{ \u0026lt;T\u0026gt; DataRewinder\u0026lt;T\u0026gt; getRewinder(T data) { return glideContext.getRegistry().getRewinder(data); } } public class Registry{ public \u0026lt;X\u0026gt; DataRewinder\u0026lt;X\u0026gt; getRewinder(@NonNull X data) { return dataRewinderRegistry.build(data); } } public class DataRewinderRegistry{ private final Map\u0026lt;Class\u0026lt;?\u0026gt;, DataRewinder.Factory\u0026lt;?\u0026gt;\u0026gt; rewinders = new HashMap\u0026lt;\u0026gt;(); public synchronized \u0026lt;T\u0026gt; DataRewinder\u0026lt;T\u0026gt; build(@NonNull T data) { DataRewinder.Factory\u0026lt;T\u0026gt; result = (DataRewinder.Factory\u0026lt;T\u0026gt;) rewinders.get(data.getClass()); if (result == null) { for (DataRewinder.Factory\u0026lt;?\u0026gt; registeredFactory : rewinders.values()) { if (registeredFactory.getDataClass().isAssignableFrom(data.getClass())) { result = (DataRewinder.Factory\u0026lt;T\u0026gt;) registeredFactory; break; } } } if (result == null) { result = (DataRewinder.Factory\u0026lt;T\u0026gt;) DEFAULT_FACTORY; } return result.build(data); } } DataRewinderæ˜¯ä¸€ä¸ªæ¥å£ï¼Œè¿™é‡Œè·å–DataRewinderç±»ä¼¼ä¸Šé¢ä»‹ç»çš„ModelLoaderï¼Œä¸Šé¢æ˜¯å°†Entryè£…è½½åˆ°MultiModelLoaderFactoryä¸­ï¼Œè€Œæ­¤å¤„æ˜¯å°† DataRewinder.Factory æ”¾åˆ°DataRewinderRegistryä¸­ï¼Œé€šè¿‡æ¯”è¾ƒclassç±»å‹å¾—åˆ°DataRewinderï¼Œæœ€ç»ˆå¾—åˆ°ä¸€ä¸ª InputStreamRewinder ï¼Œæ¥ç€è°ƒç”¨äº†rewindAndGetæ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 public final class InputStreamRewinder implements DataRewinder\u0026lt;InputStream\u0026gt; { // 5MB. private static final int MARK_READ_LIMIT = 5 * 1024 * 1024; private final RecyclableBufferedInputStream bufferedStream; @Synthetic public InputStreamRewinder(InputStream is, ArrayPool byteArrayPool) { bufferedStream = new RecyclableBufferedInputStream(is, byteArrayPool); bufferedStream.mark(MARK_READ_LIMIT); } @NonNull @Override public InputStream rewindAndGet() throws IOException { bufferedStream.reset(); return bufferedStream; } } åœ¨åˆå§‹åŒ–InputStreamRewinderæ—¶å€™ï¼Œå°†ä¼ è¿›æ¥çš„InputStreamåŒ…è£…æˆRecyclableBufferedInputStreamï¼Œç›¸è¾ƒäºjavaä¸­çš„BufferedInputStreamï¼Œå®ƒæ˜¯ä¸€ä¸ªä»byteArrayPoolä¸­ç”³è¯·byte[]æ•°ç»„çš„æµï¼Œå¹¶ä¸”ç”³è¯·çš„é»˜è®¤byte[]æ•°ç»„å¤§å°æ˜¯64KBï¼Œæ¯æ¬¡åœ¨æ‰©å®¹çš„æ—¶å€™ï¼Œä¸æ˜¯é€šè¿‡new byte[]çš„å½¢å¼ç”³è¯·å†…å­˜ï¼Œè€Œæ˜¯é€šè¿‡byteArrayPoolè·å–ï¼Œç”³è¯·åˆ°æ–°çš„å†…å­˜åä¼šå°†æ—§çš„å†…å­˜æ”¾åˆ°byteArrayPoolä¸­ã€‚åŸºäºä»¥ä¸Šç‰¹æ€§èƒ½çœ‹å‡ºæ¥ï¼ŒRecyclableBufferedInputStreamæ˜¯ä¸€ä¸ªå†…å­˜èƒ½å¾ªç¯åˆ©ç”¨çš„å­—èŠ‚è¾“å…¥æµï¼Œå‡å°‘äº†GCã€‚\nDataRewinderç±»å›¾ï¼š\næ¥ç€é€šè¿‡DecodeHelperçš„getSourceEncoderæ–¹æ³•è·å–åˆ°Encoderï¼Œè·Ÿä¸Šé¢è·å–DataRewinderæ˜¯ä¸€æ ·çš„ï¼Œå®ƒæ˜¯é€šè¿‡Registryåˆ°EncoderRegistryï¼Œç„¶åä¹Ÿæ˜¯æ¯”è¾ƒä¼ è¿›æ¥çš„classç±»å‹æ˜¯ä¸æ˜¯æ³¨å†Œçš„classå­ç±»å‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 public class Registry { public \u0026lt;X\u0026gt; Encoder\u0026lt;X\u0026gt; getSourceEncoder(@NonNull X data) { Encoder\u0026lt;X\u0026gt; encoder = encoderRegistry.getEncoder((Class\u0026lt;X\u0026gt;) data.getClass()); if (encoder != null) { return encoder; } } } public class EncoderRegistry { private final List\u0026lt;Entry\u0026lt;?\u0026gt;\u0026gt; encoders = new ArrayList\u0026lt;\u0026gt;(); @SuppressWarnings(\u0026#34;unchecked\u0026#34;) @Nullable public synchronized \u0026lt;T\u0026gt; Encoder\u0026lt;T\u0026gt; getEncoder(@NonNull Class\u0026lt;T\u0026gt; dataClass) { for (Entry\u0026lt;?\u0026gt; entry : encoders) { if (entry.handles(dataClass)) { return (Encoder\u0026lt;T\u0026gt;) entry.encoder; } } return null; } private static final class Entry\u0026lt;T\u0026gt; { private final Class\u0026lt;T\u0026gt; dataClass; final Encoder\u0026lt;T\u0026gt; encoder; Entry(@NonNull Class\u0026lt;T\u0026gt; dataClass, @NonNull Encoder\u0026lt;T\u0026gt; encoder) { this.dataClass = dataClass; this.encoder = encoder; } boolean handles(@NonNull Class\u0026lt;?\u0026gt; dataClass) { return this.dataClass.isAssignableFrom(dataClass); } } } æ‰€ä»¥æœ€ç»ˆEncoderæ˜¯ä¸€ä¸ªStreamEncoderï¼Œå›åˆ°ä¸Šé¢çš„cacheDataæ–¹æ³•ï¼ŒDecodeHelperçš„getDiskCacheæ–¹æ³•ä¼šé€šè¿‡LazyDiskCacheProviderçš„getDiskCacheæ–¹æ³•è¿”å›DiskCacheï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 private static class LazyDiskCacheProvider implements DecodeJob.DiskCacheProvider { private final DiskCache.Factory factory; private volatile DiskCache diskCache; @Override public DiskCache getDiskCache() { if (diskCache == null) { synchronized (this) { if (diskCache == null) { diskCache = factory.build(); } if (diskCache == null) { diskCache = new DiskCacheAdapter(); } } } return diskCache; } } ä»æ­¤å¤„çœ‹å…ˆé€šè¿‡ DiskCache.Factory çš„buildæ–¹æ³•åˆ›å»ºDiskCacheï¼Œå¦‚æœæ²¡æœ‰åˆ›å»ºæˆåŠŸï¼Œ åˆ™è¿”å›DiskCacheAdapterã€‚æ­¤å¤„çš„DiskCache. Factoryæ˜¯åœ¨GlideBuilderä¸­åˆå§‹åŒ–Glideæ—¶å€™åˆå§‹åŒ–çš„ï¼Œå®ƒæ˜¯InternalCacheDiskCacheFactoryï¼Œå®ƒæ˜¯ç»§æ‰¿è‡ªDiskLruCacheFactoryï¼Œçœ‹ä¸‹å®ƒçš„buildæ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 @Override public DiskCache build() { File cacheDir = cacheDirectoryGetter.getCacheDirectory(); if (cacheDir == null) { return null; } if (cacheDir.isDirectory() || cacheDir.mkdirs()) { return DiskLruCacheWrapper.create(cacheDir, diskCacheSize); } return null; } å¯ä»¥çœ‹åˆ°æœ€ç»ˆæ˜¯é€šè¿‡DiskLruCacheWrapperçš„createæ–¹æ³•æ¥åˆ›å»ºDiskCacheï¼š\n1 2 3 public static DiskCache create(File directory, long maxSize) { return new DiskLruCacheWrapper(directory, maxSize); } æ‰€ä»¥ä¸Šé¢cacheDataä¸­diskCacheæ˜¯ä¸€ä¸ªDiskLruCacheWrapperå¯¹è±¡ã€‚æœ€ç»ˆé€šè¿‡DiskLruCacheWrapperçš„putæ–¹æ³•æ¥ä¿å­˜åˆ°æ–‡ä»¶ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 @Override public void put(Key key, Writer writer) { String safeKey = safeKeyGenerator.getSafeKey(key); DiskLruCache diskCache = getDiskCache(); Value current = diskCache.get(safeKey); if (current != null) { return; } DiskLruCache.Editor editor = diskCache.edit(safeKey); if (editor == null) { throw new IllegalStateException(\u0026#34;Had two simultaneous puts for: \u0026#34; + safeKey); } File file = editor.getFile(0); if (writer.write(file)) { editor.commit(); } editor.abortUnlessCommitted(); } é¦–å…ˆé€šè¿‡GlideUrlè·å–å”¯ä¸€keyï¼Œå› ä¸ºæ­¤å¤„æ˜¯ä¿å­˜åŸå§‹æ–‡ä»¶ï¼Œæ‰€ä»¥æ˜¯urlä½œä¸ºå”¯ä¸€keyï¼Œå¦‚æœèƒ½æ‰¾åˆ°æœ¬åœ°å›¾ç‰‡ï¼Œåˆ™ä¸è¿›è¡Œä¿å­˜ã€‚æ¥ç€è·å–è¯¥æ–‡ä»¶çš„editorï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 public Editor edit(String key) throws IOException { return edit(key, ANY_SEQUENCE_NUMBER); } private synchronized Editor edit(String key, long expectedSequenceNumber) throws IOException { checkNotClosed(); Entry entry = lruEntries.get(key); if (expectedSequenceNumber != ANY_SEQUENCE_NUMBER \u0026amp;\u0026amp; (entry == null || entry.sequenceNumber != expectedSequenceNumber)) { return null; // Value is stale. } if (entry == null) { entry = new Entry(key); lruEntries.put(key, entry); } else if (entry.currentEditor != null) { return null; // Another edit is in progress. } Editor editor = new Editor(entry); entry.currentEditor = editor; // Flush the journal before creating files to prevent file leaks. journalWriter.append(DIRTY); journalWriter.append(\u0026#39; \u0026#39;); journalWriter.append(key); journalWriter.append(\u0026#39;\\n\u0026#39;); flushWriter(journalWriter); return editor; } åœ¨ä¸Šé¢editæ–¹æ³•ä¸­ï¼Œåˆ¤æ–­æœŸæœ›çš„åºåˆ—å·å¦‚æœä¸æ˜¯é»˜è®¤åºåˆ—å·å¹¶ä¸”entryä¸ºç©ºæˆ–è€…å·²ç»ä¿å­˜æˆåŠŸäº†åˆ™ç›´æ¥è¿”å›nullã€‚ä¸‹é¢å°±æ˜¯åˆ›å»ºEditorå’ŒEntryçš„è¿‡ç¨‹ã€‚åˆ›å»ºå®ŒEditoråå°±æ˜¯ä½¿ç”¨writerçš„writeæ–¹æ³•ä¿å­˜å›¾ç‰‡çš„è¾“å…¥æµäº†ã€‚æ­¤å¤„çš„writeræ˜¯DataCacheWriterï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 class DataCacheWriter\u0026lt;DataType\u0026gt; implements DiskCache.Writer { private final Encoder\u0026lt;DataType\u0026gt; encoder; private final DataType data; private final Options options; DataCacheWriter(Encoder\u0026lt;DataType\u0026gt; encoder, DataType data, Options options) { this.encoder = encoder; this.data = data; this.options = options; } @Override public boolean write(@NonNull File file) { return encoder.encode(data, file, options); } } ä¼šè°ƒç”¨encoderçš„encodeæ–¹æ³•ï¼Œå¯ä»¥çœ‹å‡ºæ¥è¿™æ˜¯ç¼–ç çš„æ ¸å¿ƒï¼Œä¸Šé¢åˆ†æè¿‡encoderæ˜¯StreamEncoderï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 public boolean encode(@NonNull InputStream data, @NonNull File file, @NonNull Options options) { byte[] buffer = byteArrayPool.get(ArrayPool.STANDARD_BUFFER_SIZE_BYTES, byte[].class); boolean success = false; OutputStream os = new FileOutputStream(file); int read; while ((read = data.read(buffer)) != -1) { os.write(buffer, 0, read); } os.close(); success = true; byteArrayPool.put(buffer); return success; } è¿™å°±æ˜¯ç¼–ç çš„æ ¸å¿ƒäº†ï¼Œé€šè¿‡ä»å­—èŠ‚æ± å­ä¸­è·å–ä¸€ä¸ªä¸´æ—¶çš„byteæ•°ç»„ï¼Œæ¯æ¬¡ä»è¾“å…¥æµä¸­è¯»å–ï¼Œè¯»å–åé€šè¿‡è¾“å‡ºæµå°†bufferæ•°ç»„å†™åˆ°æ–‡ä»¶ä¸­ï¼Œå†™å®Œåï¼Œå¹¶å›æ”¶è¯¥byteæ•°ç»„ã€‚\nDiskCacheç±»å›¾:\nåœ¨ä¸Šé¢ç±»å›¾ä¸­DiskLruCacheFactoryä¸“é—¨ç”¨æ¥åˆ›å»ºDiskLruCacheWrapperçš„ï¼Œå®ƒæ˜¯å®ç°äº†DiskCacheæ¥å£ï¼Œå®é™…ä¸Šä¿å­˜æ•°æ®æ˜¯DiskLruCacheç±»ï¼ŒDiskLruCacheFactoryéœ€è¦CacheDirectoryGetteræ¥å£è·å–ä¿å­˜çš„ç›®å½•ï¼Œæ‰€ä»¥InternalCacheDiskCacheFactoryå®ç°ç±»ä¸­ä¼ ç»™DiskLruCacheFactoryä¸€ä¸ªCacheDirectoryGetterçš„åŒ¿åå†…éƒ¨ç±»ï¼Œå°†å†…å­˜å­˜å‚¨çš„è·¯å¾„ä¼ ç»™çˆ¶ç±»ã€‚ è§£ç è¿‡ç¨‹ è§£ç å‰ï¼šè·å–ByteBufferFetcher ä¿å­˜åŸå§‹å›¾ç‰‡åˆ°æœ¬åœ°åï¼Œå°±æ˜¯bitmapè§£ç äº†ï¼Œåœ¨ä¹‹å‰çš„glideåŠ è½½æµç¨‹ä»‹ç»è¿‡ï¼Œå›åˆ°SourceGeneratorçš„startNextæ–¹æ³•ï¼Œè°ƒå®ŒcacheDataåï¼Œå°±ä¼šè°ƒç”¨DataCacheGeneratorçš„startNextæ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 //SourceGeneratorçš„startNextæ–¹æ³• public boolean startNext() { if (dataToCache != null) { } if (sourceCacheGenerator != null \u0026amp;\u0026amp; sourceCacheGenerator.startNext()) { return true; } } //DataCacheGeneratorçš„startNextæ–¹æ³• public boolean startNext() { while (modelLoaders == null || !hasNextModelLoader()) { sourceIdIndex++; if (sourceIdIndex \u0026gt;= cacheKeys.size()) { return false; } Key sourceId = cacheKeys.get(sourceIdIndex); Key originalKey = new DataCacheKey(sourceId, helper.getSignature()); cacheFile = helper.getDiskCache().get(originalKey); if (cacheFile != null) { this.sourceKey = sourceId; modelLoaders = helper.getModelLoaders(cacheFile); modelLoaderIndex = 0; } } loadData = null; boolean started = false; while (!started \u0026amp;\u0026amp; hasNextModelLoader()) { ModelLoader\u0026lt;File, ?\u0026gt; modelLoader = modelLoaders.get(modelLoaderIndex++); loadData = modelLoader.buildLoadData( cacheFile, helper.getWidth(), helper.getHeight(), helper.getOptions()); if (loadData != null \u0026amp;\u0026amp; helper.hasLoadPath(loadData.fetcher.getDataClass())) { started = true; loadData.fetcher.loadData(helper.getPriority(), this); } } return started; } ä¸Šé¢å’Œå‰é¢ä»‹ç»çš„HttpUrlFetcherè·å–æ˜¯ä¸€æ ·çš„è¿‡ç¨‹ï¼Œåªä¸è¿‡æ­¤å¤„ä¼ è¿›å»çš„modelæ˜¯Fileç±»å‹ï¼Œèƒ½åŒ¹é…åˆ°Modelæ˜¯Fileç±»å‹æœ‰å¦‚ä¸‹å‡ ä¸ªï¼š\n1 2 3 4 append(File.class, ByteBuffer.class, new ByteBufferFileLoader.Factory()) append(File.class, InputStream.class, new FileLoader.StreamFactory()) append(File.class, ParcelFileDescriptor.class, new FileLoader.FileDescriptorFactory()) append(File.class, File.class, UnitModelLoader.Factory.\u0026lt;File\u0026gt;getInstance()) è¿™å‡ ä¸ªModelLoaderçš„handlesæ–¹æ³•éƒ½è¿”å›trueï¼Œæ¥ç€è°ƒç”¨ModelLoaderçš„buildLoadDataè·å–LoadDataï¼ŒByteBufferFileLoaderçš„buildLoadDataï¼š\n1 2 3 4 5 6 public class ByteBufferFileLoader implements ModelLoader\u0026lt;File, ByteBuffer\u0026gt; { public LoadData\u0026lt;ByteBuffer\u0026gt; buildLoadData( @NonNull File file, int width, int height, @NonNull Options options) { return new LoadData\u0026lt;\u0026gt;(new ObjectKey(file), new ByteBufferFetcher(file)); } } FileLoaderçš„buildLoadDataï¼š\n1 2 3 4 5 6 7 public class FileLoader\u0026lt;Data\u0026gt; implements ModelLoader\u0026lt;File, Data\u0026gt; { @Override public LoadData\u0026lt;Data\u0026gt; buildLoadData( @NonNull File model, int width, int height, @NonNull Options options) { return new LoadData\u0026lt;\u0026gt;(new ObjectKey(model), new FileFetcher\u0026lt;\u0026gt;(model, fileOpener)); } } UnitModelLoaderçš„buildLoadDataï¼š\n1 2 3 4 5 6 public class UnitModelLoader\u0026lt;Model\u0026gt; implements ModelLoader\u0026lt;Model, Model\u0026gt; { public LoadData\u0026lt;Model\u0026gt; buildLoadData( @NonNull Model model, int width, int height, @NonNull Options options) { return new LoadData\u0026lt;\u0026gt;(new ObjectKey(model), new UnitFetcher\u0026lt;\u0026gt;(model)); } } å›åˆ°å‰é¢DataCacheGeneratorçš„startNextæ–¹æ³•ï¼Œè·å–åˆ°LoadDataåï¼Œé€šè¿‡DecodeHelperçš„hasLoadPathæ˜¯å¦ä¸ºtrueï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 boolean hasLoadPath(Class\u0026lt;?\u0026gt; dataClass) { return getLoadPath(dataClass) != null; } \u0026lt;Data\u0026gt; LoadPath\u0026lt;Data, ?, Transcode\u0026gt; getLoadPath(Class\u0026lt;Data\u0026gt; dataClass) { return glideContext.getRegistry().getLoadPath(dataClass, resourceClass, transcodeClass); } public \u0026lt;Data, TResource, Transcode\u0026gt; LoadPath\u0026lt;Data, TResource, Transcode\u0026gt; getLoadPath( @NonNull Class\u0026lt;Data\u0026gt; dataClass, @NonNull Class\u0026lt;TResource\u0026gt; resourceClass, @NonNull Class\u0026lt;Transcode\u0026gt; transcodeClass) { LoadPath\u0026lt;Data, TResource, Transcode\u0026gt; result = loadPathCache.get(dataClass, resourceClass, transcodeClass); List\u0026lt;DecodePath\u0026lt;Data, TResource, Transcode\u0026gt;\u0026gt; decodePaths = getDecodePaths(dataClass, resourceClass, transcodeClass); if (decodePaths.isEmpty()) { result = null; } else { result = new LoadPath\u0026lt;\u0026gt;( dataClass, resourceClass, transcodeClass, decodePaths, throwableListPool); } loadPathCache.put(dataClass, resourceClass, transcodeClass, result); return result; } é€šè¿‡getDecodePathsè·å–åˆ°å·²æ³¨å†Œçš„DecodePathï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 private \u0026lt;Data, TResource, Transcode\u0026gt; List\u0026lt;DecodePath\u0026lt;Data, TResource, Transcode\u0026gt;\u0026gt; getDecodePaths( @NonNull Class\u0026lt;Data\u0026gt; dataClass, @NonNull Class\u0026lt;TResource\u0026gt; resourceClass, @NonNull Class\u0026lt;Transcode\u0026gt; transcodeClass) { List\u0026lt;DecodePath\u0026lt;Data, TResource, Transcode\u0026gt;\u0026gt; decodePaths = new ArrayList\u0026lt;\u0026gt;(); List\u0026lt;Class\u0026lt;TResource\u0026gt;\u0026gt; registeredResourceClasses = decoderRegistry.getResourceClasses(dataClass, resourceClass); for (Class\u0026lt;TResource\u0026gt; registeredResourceClass : registeredResourceClasses) { List\u0026lt;Class\u0026lt;Transcode\u0026gt;\u0026gt; registeredTranscodeClasses = transcoderRegistry.getTranscodeClasses(registeredResourceClass, transcodeClass); for (Class\u0026lt;Transcode\u0026gt; registeredTranscodeClass : registeredTranscodeClasses) { List\u0026lt;ResourceDecoder\u0026lt;Data, TResource\u0026gt;\u0026gt; decoders = decoderRegistry.getDecoders(dataClass, registeredResourceClass); ResourceTranscoder\u0026lt;TResource, Transcode\u0026gt; transcoder = transcoderRegistry.get(registeredResourceClass, registeredTranscodeClass); @SuppressWarnings(\u0026#34;PMD.AvoidInstantiatingObjectsInLoops\u0026#34;) DecodePath\u0026lt;Data, TResource, Transcode\u0026gt; path = new DecodePath\u0026lt;\u0026gt;( dataClass, registeredResourceClass, registeredTranscodeClass, decoders, transcoder, throwableListPool); decodePaths.add(path); } } return decodePaths; } public synchronized \u0026lt;T, R\u0026gt; List\u0026lt;Class\u0026lt;R\u0026gt;\u0026gt; getResourceClasses( @NonNull Class\u0026lt;T\u0026gt; dataClass, @NonNull Class\u0026lt;R\u0026gt; resourceClass) { List\u0026lt;Class\u0026lt;R\u0026gt;\u0026gt; result = new ArrayList\u0026lt;\u0026gt;(); for (String bucket : bucketPriorityList) { List\u0026lt;Entry\u0026lt;?, ?\u0026gt;\u0026gt; entries = decoders.get(bucket); if (entries == null) { continue; } for (Entry\u0026lt;?, ?\u0026gt; entry : entries) { if (entry.handles(dataClass, resourceClass) \u0026amp;\u0026amp; !result.contains((Class\u0026lt;R\u0026gt;) entry.resourceClass)) { result.add((Class\u0026lt;R\u0026gt;) entry.resourceClass); } } } return result; } åˆ°è¿™é‡Œåï¼Œæˆ‘ä»¬éœ€è¦ç†Ÿæ‚‰bucketPriorityListå’Œdecodersï¼ŒbucketPriorityListæ˜¯åˆ†ç»„ä¿¡æ¯ï¼Œdecodersæ˜¯åœ¨Registryåˆå§‹åŒ–æ³¨å†Œè¿›æ¥çš„ä¸€äº›Entryé›†åˆè¡¨ã€‚åœ¨ä¸Šé¢ä¼ è¿›æ¥çš„dataClassæ˜¯ModelLoadersä¸­åˆ›å»ºçš„LoadDataçš„fetcherä¸­æŒ‡å®šçš„getDataClassï¼ŒresourceClassé»˜è®¤æ˜¯Object.classï¼š\nä»ä¸Šé¢debugæ•°æ®å¯ä»¥çœ‹å‡ºæ¥ï¼Œä¼ è¿›æ¥çš„dataClassæ˜¯ java.nio.ByteBuffer ï¼ŒresourceClassæ˜¯ java.lang.Object ï¼Œå› ä¸ºåœ¨æ‹¿åˆ°ç¬¬ä¸€ä¸ªByteBufferFileLoaderåˆ›å»ºçš„LoadDataä¸­æ‰€åˆ›å»ºçš„Fetcheræ˜¯ByteBufferFetcherï¼Œå®ƒçš„getDataClassæ–¹æ³•å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 private static final class ByteBufferFetcher implements DataFetcher\u0026lt;ByteBuffer\u0026gt; { @Override public Class\u0026lt;ByteBuffer\u0026gt; getDataClass() { return ByteBuffer.class; } } é€šè¿‡ä¸Šé¢çš„getResourceClassesä¸­entryçš„handle(dataClass, resourceClass)è¿›è¡Œè¿‡æ»¤å‡ºdataClassä¸º java.nio.ByteBuffer çš„Entryæ¥ï¼Œæ‰€ä»¥ä¼šè¿”å› android.graphics.drawable.Drawable ã€ com.bumptech.glide.load.resource.gif.GifDrawable ã€ android.graphics.drawable.Bitmap ã€ android.graphics.drawable.BitmapDrawable è¿™å››ç§resourceClassã€‚å›åˆ°ä¸Šé¢çš„getDecodePathsæ–¹æ³•ï¼ŒregisteredResourceClassesæŒ‡å‘è¿™å››ç§classï¼Œæ¥ç€éå†è¯¥é›†åˆã€‚è°ƒç”¨transcoderRegistry.getTranscodeClasses(registeredResourceClass, transcodeClass)ï¼ŒregisteredTranscodeClassesä¼šè·å–åˆ°å¯¹åº”resourceClassçš„TranscodeClassesï¼Œç„¶åç»§ç»­éå†registeredTranscodeClassesï¼Œè·å–æ¯ä¸€ä¸ªresourceClassçš„decodersï¼Œæœ€åæ„å»ºDecodePathæ·»åŠ åˆ°é›†åˆä¸­è¿”å›ï¼Œè¿™é‡Œåˆ—å‡º4ç§ResourceClassçš„DecodePathæƒ…å†µï¼š\nandroid.graphics.drawable.Drawable : DecodePath(dataClass= java.nio.ByteBuffer , registeredResourceClass= android.graphics.drawable.Drawable , registeredTranscodeClass= android.graphics.drawable.Drawable , decoders=[AnimatedImageDecoder$ByteBufferAnimatedImageDecoderã€ByteBufferGifDecoderã€BitmapDrawableDecoderã€BitmapDrawableDecoder], transcoder=UnitTranscoder) com.bumptech.glide.load.resource.gif.GifDrawable : DecodePath(dataClass= java.nio.ByteBuffer , registeredResourceClass= com.bumptech.glide.load.resource.gif.GifDrawable , registeredTranscodeClass= com.bumptech.glide.load.resource.gif.GifDrawable,decoders=[ByteBufferGifDecoder] transcoder=UnitTranscoder) android.graphics.drawable.Bitmap : DecodePath(dataClass= java.nio.ByteBuffer , registeredResourceClass= android.graphics.drawable.Bitmap , registeredTranscodeClass=BitmapDrawable.class,decoders= [ByteBufferBitmapDecoder], transcoder=UnitTranscoder) android.graphics.drawable.BitmapDrawable : DecodePath(dataClass= java.nio.ByteBuffer , registeredResourceClass= android.graphics.drawable.BitmapDrawable , registeredTranscodeClass=android.graphics.drawable.BitmapDrawable,decoders= [BitmapDrawableDecoderã€BitmapDrawableDecoder], transcoder=UnitTranscoder) æœ€ç»ˆåœ¨Registryçš„getLoadPathæ–¹æ³•ä¸­å°†è¿”å›çš„decodePathsæ„å»ºæˆLoadPathï¼Œå¹¶æ·»åŠ åˆ°loadPathCacheä¸­ï¼Œæ‰€ä»¥åœ¨ä¸Šé¢DataCacheGeneratorä¸­loadData.fetcheræ˜¯ä¸€ä¸ªByteBufferFetcherã€‚\nè§£ç å‰ï¼šå°†Fileè½¬åŒ–æˆByteBuffer åœ¨è§£ç å‰éœ€è¦å°†Fileè½¬åŒ–æˆByteBufferï¼Œè€Œæ²¡æœ‰ç›´æ¥é€šè¿‡Fileè½¬åŒ–æˆBitmapï¼ŒåŸå› æœ‰å¦‚ä¸‹å‡ ç‚¹ï¼š\nGlide è§£ç æ¡†æ¶æ˜¯åŸºäº â€œData â†’ ByteBuffer/InputStream â†’ Resourceâ€ çš„æ¨¡å‹è®¾è®¡ File â†’ BitmapFactory è§£ç æ˜¯é¡ºåº I/Oï¼Œä¸èƒ½ random access éœ€è¦ Rewindï¼ˆé‡è¯»ï¼‰â€”â€” File åšä¸åˆ°ï¼ŒByteBuffer æ”¯æŒ æ”¯æŒ GIFã€WebP ç­‰å¤æ‚æ ¼å¼ï¼Œå¿…é¡»ä½¿ç”¨ ByteBuffer Glide è¦æ”¯æŒ Transformationï¼ˆåœ†è§’ã€è£å‰ªã€ç¼©æ”¾ï¼‰ç­‰ decode å‰åå¤„ç† Glide çš„ç¼“å­˜ç»“æ„ä½¿ç”¨çš„æ˜¯å­—èŠ‚ç¼“å­˜ï¼Œä¸æ˜¯æ–‡ä»¶ç¼“å­˜ï¼ˆé™¤ç£ç›˜ç¼“å­˜ï¼‰ æ¥çœ‹ä¸‹ByteBufferFetcherçš„loadDataå®ç°ï¼š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 @Override public void loadData( @NonNull Priority priority, @NonNull DataCallback\u0026lt;? super ByteBuffer\u0026gt; callback) { ByteBuffer result = ByteBufferUtil.fromFile(file); callback.onDataReady(result); } public static ByteBuffer fromFile(@NonNull File file) throws IOException { RandomAccessFile raf = null; FileChannel channel = null; long fileLength = file.length(); raf = new RandomAccessFile(file, \u0026#34;r\u0026#34;); channel = raf.getChannel(); return channel.map(FileChannel.MapMode.READ_ONLY, 0, fileLength).load(); } é¦–å…ˆè·å–RandomAccessFileçš„FileChannelï¼Œè®©ä½ ä½¿ç”¨ NIOï¼ˆNew I/Oï¼‰é«˜é€Ÿæ–‡ä»¶é€šé“ï¼Œè®©ä½ èƒ½å¯¹æ–‡ä»¶è¿›è¡Œæ›´å¿«ã€æ›´åº•å±‚çš„æ“ä½œï¼Œç„¶åé€šè¿‡mapæ–¹æ³•å°†fileå†…å®¹æ˜ å°„åˆ°å†…å­˜ï¼Œä»è€Œä¸åƒæ™®é€šioä¸€æ ·read/writeé‚£æ ·ç³»ç»Ÿè°ƒç”¨ï¼Œä¸éœ€è¦ç”¨æˆ·æ€å†…æ ¸æ€æ‹·è´ï¼Œè¿”å›çš„MappedByteBuffer æ˜¯å†…å­˜æ˜ å°„æ–‡ä»¶ï¼Œå¯¹ ByteBuffer çš„æ“ä½œå°±æ˜¯åœ¨ç›´æ¥ä¿®æ”¹æ–‡ä»¶å†…å®¹ã€‚æ¯”å¦‚ä¸‹é¢é€šè¿‡putæ–¹æ³•ç»™æŒ‡å®šä½ç½®æ’å…¥å­—ç¬¦çš„äº‹ä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 public static void insertByteByPosition(){ int insertPos = 3; byte value = (byte) \u0026#39;9\u0026#39;; RandomAccessFile raf = new RandomAccessFile(\u0026#34;./test.txt\u0026#34;, \u0026#34;rw\u0026#34;); FileChannel channel = raf.getChannel(); long oldLen = channel.size(); long newLen = oldLen + 1; // 1. æ‰©å±•æ–‡ä»¶é•¿åº¦ raf.setLength(newLen); // 2. é‡æ–° map å…¨æ–‡ä»¶åŒºåŸŸ MappedByteBuffer buffer = channel.map( FileChannel.MapMode.READ_WRITE, 0, newLen ); // 3. ä»åå¾€å‰ç§»åŠ¨æ•°æ®ï¼ˆé¿å…è¦†ç›–ï¼‰ for (long i = oldLen - 1; i \u0026gt;= insertPos; i--) { byte b = buffer.get((int) i); buffer.put((int) (i + 1), b); } // 4. æ’å…¥æ–°çš„å­—èŠ‚ buffer.put(insertPos, value); channel.close(); raf.close(); } å¼€å§‹è§£ç  è½¬åŒ–æˆByteBufferå°±å›åˆ°äº†DecodeJobçš„decodeFromRetrievedDataæ–¹æ³•ï¼Œè¿™ä¸ªåœ¨GlideåŠ è½½å›¾ç‰‡æµç¨‹ä¸­æœ‰è®²åˆ°ï¼Œåœ¨è¯¥æ–¹æ³•é‡Œé¢è°ƒç”¨äº†decodeFromDataæ–¹æ³•ï¼š\n1 2 3 4 5 private \u0026lt;Data\u0026gt; Resource\u0026lt;R\u0026gt; decodeFromData( DataFetcher\u0026lt;?\u0026gt; fetcher, Data data, DataSource dataSource) throws GlideException { Resource\u0026lt;R\u0026gt; result = decodeFromFetcher(data, dataSource); return result; } æ­¤å¤„çš„dataæ˜¯ä¸Šé¢è¯´åˆ°çš„ByteBufferï¼ŒdataSourceæ˜¯ByteBufferFetcherçš„getDataSourceæ–¹æ³•è¿”å›çš„DataSource.LOCALã€‚ç»§ç»­çœ‹decodeFromFetcheræ–¹æ³•ï¼š\n1 2 3 4 5 private \u0026lt;Data\u0026gt; Resource\u0026lt;R\u0026gt; decodeFromFetcher(Data data, DataSource dataSource) throws GlideException { LoadPath\u0026lt;Data, ?, R\u0026gt; path = decodeHelper.getLoadPath((Class\u0026lt;Data\u0026gt;) data.getClass()); return runLoadPath(data, dataSource, path); } åˆå›åˆ°äº†ä¸Šé¢è¯´çš„LoadPathè·å–éƒ¨åˆ†ï¼Œä¸Šé¢åˆ†æè¿‡loadPathCacheä¼šæ„å»ºä¸€ä¸ªLoadPathï¼Œé‡Œé¢æ”¾äº†4ä¸ªDataPathï¼ŒloadPathCacheçš„dataClassæ˜¯ ByteBuffer.class ï¼ŒresourceClassæ˜¯ java.lang.Object.class ï¼ŒtranscodeClassæ˜¯ Drawable.class ï¼Œresultå°±æ˜¯åˆšåˆšä¸Šé¢è¯´çš„4ä¸ªDataPathã€‚æ¥ç€è°ƒç”¨runLoadPathæ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 private \u0026lt;Data, ResourceType\u0026gt; Resource\u0026lt;R\u0026gt; runLoadPath( Data data, DataSource dataSource, LoadPath\u0026lt;Data, ResourceType, R\u0026gt; path) throws GlideException { Options options = getOptionsWithHardwareConfig(dataSource); DataRewinder\u0026lt;Data\u0026gt; rewinder = glideContext.getRegistry().getRewinder(data); return path.load( rewinder, options, width, height, new DecodeCallback\u0026lt;ResourceType\u0026gt;(dataSource)); } æ­¤å¤„çš„rewinderå’Œä¸Šé¢InputStreamRewinderè·å–ç±»ä¼¼ï¼Œåªä¸è¿‡è¿™é‡Œçš„dataæ˜¯ä¸€ä¸ªByteBuffer.classç±»å‹ï¼Œå®ƒè·å–åˆ°çš„æ˜¯ByteBufferRewinderå¯¹è±¡ï¼Œç„¶åè°ƒç”¨LoadPathçš„loadæ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 public Resource\u0026lt;Transcode\u0026gt; load( DataRewinder\u0026lt;Data\u0026gt; rewinder, @NonNull Options options, int width, int height, DecodePath.DecodeCallback\u0026lt;ResourceType\u0026gt; decodeCallback) throws GlideException { return loadWithExceptionList(rewinder, options, width, height, decodeCallback, throwables); } //LoadPath.loadWithExceptionList private Resource\u0026lt;Transcode\u0026gt; loadWithExceptionList( DataRewinder\u0026lt;Data\u0026gt; rewinder, @NonNull Options options, int width, int height, DecodePath.DecodeCallback\u0026lt;ResourceType\u0026gt; decodeCallback, List\u0026lt;Throwable\u0026gt; exceptions) throws GlideException { Resource\u0026lt;Transcode\u0026gt; result = null; for (int i = 0, size = decodePaths.size(); i \u0026lt; size; i++) { DecodePath\u0026lt;Data, ResourceType, Transcode\u0026gt; path = decodePaths.get(i); result = path.decode(rewinder, width, height, options, decodeCallback); if (result != null) { break; } } return result; } //DecodePath.decode public Resource\u0026lt;Transcode\u0026gt; decode( DataRewinder\u0026lt;DataType\u0026gt; rewinder, int width, int height, @NonNull Options options, DecodeCallback\u0026lt;ResourceType\u0026gt; callback) throws GlideException { Resource\u0026lt;ResourceType\u0026gt; decoded = decodeResource(rewinder, width, height, options); Resource\u0026lt;ResourceType\u0026gt; transformed = callback.onResourceDecoded(decoded); return transcoder.transcode(transformed, options); } //DecodePath.decodeResource private Resource\u0026lt;ResourceType\u0026gt; decodeResource( DataRewinder\u0026lt;DataType\u0026gt; rewinder, int width, int height, @NonNull Options options) throws GlideException { return decodeResourceWithList(rewinder, width, height, options, exceptions); } //DecodePath.decodeResourceWithList private Resource\u0026lt;ResourceType\u0026gt; decodeResourceWithList( DataRewinder\u0026lt;DataType\u0026gt; rewinder, int width, int height, @NonNull Options options, List\u0026lt;Throwable\u0026gt; exceptions) throws GlideException { Resource\u0026lt;ResourceType\u0026gt; result = null; for (int i = 0, size = decoders.size(); i \u0026lt; size; i++) { ResourceDecoder\u0026lt;DataType, ResourceType\u0026gt; decoder = decoders.get(i); DataType data = rewinder.rewindAndGet(); if (decoder.handles(data, options)) { data = rewinder.rewindAndGet(); result = decoder.decode(data, width, height, options); } if (result != null) { break; } } return result; } æœ€ç»ˆé€šè¿‡DecodePathçš„decodeæ–¹æ³•è¿›è¡Œè§£ç Bitmapï¼Œä¸Šé¢è¯´è¿‡LoadPathä¸­å­˜åœ¨4ç§DecodePathï¼Œæœ€ç»ˆè°ƒç”¨åˆ°DecodePathçš„decodeResourceWithListï¼Œè¯¥æ–¹æ³•é‡Œé¢ä¼šè°ƒç”¨å‰é¢ä¼šéå†DecodePathä¸­çš„decodersé›†åˆï¼Œç„¶åè°ƒç”¨ResourceDecoderçš„decodeæ–¹æ³•ï¼Œé‚£ä¹ˆç›´æ¥çœ‹å‰é¢åˆ†æè¿‡æœ‰å“ªäº›decoderï¼Œæ¯”å¦‚ç¬¬ä¸€ä¸ªdecoderæ˜¯AnimatedImageDecoder$ByteBufferAnimatedImageDecoderï¼Œé¦–å…ˆæ¥çœ‹ä¸‹å®ƒçš„handlesæ–¹æ³•ï¼š\n1 2 3 4 5 private final AnimatedImageDecoder delegate; public boolean handles(@NonNull ByteBuffer source, @NonNull Options options) throws IOException { return delegate.handles(source); } æ­¤å¤„çš„delegateæ˜¯AnimatedImageDecoderï¼Œçœ‹ä¸‹å®ƒçš„handlesæ–¹æ³•ï¼š\n1 2 3 boolean handles(ByteBuffer byteBuffer) throws IOException { return isHandled(ImageHeaderParserUtils.getType(imageHeaderParsers, byteBuffer)); } ImageHeaderParserUtilsçš„getTypeæ–¹æ³•æ˜¯è·å–å›¾ç‰‡æ˜¯PNGã€WEBPç­‰æ ¼å¼çš„æ–¹æ³•ï¼Œå®ƒæ˜¯é€šè¿‡ByteBufferç›¸åº”ä½ç½®çš„å­—èŠ‚è¿›è¡Œåˆ¤æ–­ï¼ŒimageHeaderParsersæ˜¯DefaultImageHeaderParserå’ŒExifInterfaceImageHeaderParserçš„é›†åˆï¼Œå…³äºè¿™éƒ¨åˆ†å°±ä¸ç”¨å±•å¼€è¯´äº†ï¼Œåé¢ä¼šå•ç‹¬è¯´å¦‚ä½•è·å–å›¾ç‰‡çš„æ ¼å¼ã€‚å†æ¥çœ‹ä¸‹isHandledæ–¹æ³•ï¼š\n1 2 3 4 private boolean isHandled(ImageType imageType) { return imageType == ImageType.ANIMATED_WEBP || (Build.VERSION.SDK_INT \u0026gt;= Build.VERSION_CODES.S \u0026amp;\u0026amp; imageType == ImageType.ANIMATED_AVIF); } å¦‚æœå›¾ç‰‡æ˜¯å¸¦åŠ¨ç”»çš„webpæˆ–è€…æ˜¯ANIMATED_AVIFæ ¼å¼æ‰ä¼šä½¿ç”¨è¯¥decoderè¿›è¡Œè§£ç ã€‚æœ€ç»ˆåœ¨BUCKET=\u0026ldquo;BitmapDrawable\u0026rdquo;ï¼ŒdataClass=ByteBuffer.classï¼ŒresourceClass=BitmapDrawable.class, decoder=BitmapDrawableDecoderçš„DecodePathä¸‹æ‰ä¼šæ ¡éªŒé€šè¿‡ï¼ŒBitmapDrawableDecoderçš„handleså’Œdecodeå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 class BitmapDrawableDecoder{ private final ResourceDecoder\u0026lt;DataType, Bitmap\u0026gt; decoder; @Override public boolean handles(@NonNull DataType source, @NonNull Options options) throws IOException { return decoder.handles(source, options); } @Override public Resource\u0026lt;BitmapDrawable\u0026gt; decode( @NonNull DataType source, int width, int height, @NonNull Options options) throws IOException { Resource\u0026lt;Bitmap\u0026gt; bitmapResource = decoder.decode(source, width, height, options); return LazyBitmapDrawableResource.obtain(resources, bitmapResource); } } æ­¤å¤„çš„decoderå®é™…ä¸€ä¸ªByteBufferBitmapDecoderï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 /** Decodes {@link android.graphics.Bitmap Bitmaps} from {@link java.nio.ByteBuffer ByteBuffers}. */ public class ByteBufferBitmapDecoder implements ResourceDecoder\u0026lt;ByteBuffer, Bitmap\u0026gt; { private final Downsampler downsampler; public ByteBufferBitmapDecoder(Downsampler downsampler) { this.downsampler = downsampler; } @Override public boolean handles(@NonNull ByteBuffer source, @NonNull Options options) { return downsampler.handles(source); } @Override public Resource\u0026lt;Bitmap\u0026gt; decode( @NonNull ByteBuffer source, int width, int height, @NonNull Options options) throws IOException { return downsampler.decode(source, width, height, options); } } ç±»çš„æ³¨é‡Šä¹Ÿå†™å¾—å¾ˆæ¸…æ¥šï¼ŒBitmap from ByteBuffersã€‚\næˆ‘ä»¬æ¥çœ‹ä¸‹Downsamplerçš„handleså’Œdecodeæ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 public boolean handles(@SuppressWarnings(\u0026#34;unused\u0026#34;) ByteBuffer byteBuffer) { // We expect downsampler to handle any available type Android supports. return true; } public Resource\u0026lt;Bitmap\u0026gt; decode( ByteBuffer buffer, int requestedWidth, int requestedHeight, Options options) throws IOException { return decode( new ImageReader.ByteBufferReader(buffer, parsers, byteArrayPool), requestedWidth, requestedHeight, options, EMPTY_CALLBACKS); } æ¥ç€è°ƒç”¨å¦å¤–ä¸€ä¸ªdecodeæ–¹æ³•ï¼Œæ³¨æ„æ­¤æ—¶åˆ›å»ºçš„ImageReaderæ˜¯ByteBufferReaderå¯¹è±¡ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 private Resource\u0026lt;Bitmap\u0026gt; decode( ImageReader imageReader, int requestedWidth, int requestedHeight, Options options, DecodeCallbacks callbacks) throws IOException { //ä»å­—èŠ‚æ± å­é‡Œé¢è·å–é»˜è®¤å¤§å°çš„å­—èŠ‚æ•°ç»„ byte[] bytesForOptions = byteArrayPool.get(ArrayPool.STANDARD_BUFFER_SIZE_BYTES, byte[].class); //ä»æ± å­é‡Œé¢è·å–Options BitmapFactory.Options bitmapFactoryOptions = getDefaultOptions(); //è®¾ç½®ä¸€ä¸ªä¸´æ—¶å¯é€‰çš„ç¼“å†²åŒº(byte[])ï¼Œç”¨äºè§£ç  Bitmap æ—¶ä½œä¸º ä¸­é—´è¯»å†™ç¼“å†² bitmapFactoryOptions.inTempStorage = bytesForOptions; DecodeFormat decodeFormat = options.get(DECODE_FORMAT); PreferredColorSpace preferredColorSpace = options.get(PREFERRED_COLOR_SPACE); DownsampleStrategy downsampleStrategy = options.get(DownsampleStrategy.OPTION); boolean fixBitmapToRequestedDimensions = options.get(FIX_BITMAP_SIZE_TO_REQUESTED_DIMENSIONS); boolean isHardwareConfigAllowed = options.get(ALLOW_HARDWARE_CONFIG) != null \u0026amp;\u0026amp; options.get(ALLOW_HARDWARE_CONFIG); try { Bitmap result = decodeFromWrappedStreams( imageReader, bitmapFactoryOptions, downsampleStrategy, decodeFormat, preferredColorSpace, isHardwareConfigAllowed, requestedWidth, requestedHeight, fixBitmapToRequestedDimensions, callbacks); return BitmapResource.obtain(result, bitmapPool); } finally { releaseOptions(bitmapFactoryOptions); byteArrayPool.put(bytesForOptions); } } é¦–å…ˆä»æ± å­ä¸­åˆ›å»ºä¸€ä¸ª64KBçš„å­—èŠ‚æ•°ç»„ï¼Œç„¶åä»æ± å­ä¸­è·å–ä¸€ä¸ªé»˜è®¤çš„Optionsï¼Œæ¥ç€å°†å‰é¢è·å–åˆ°çš„byteæ•°ç»„ç»™åˆ°Optionsçš„inTempStorageï¼Œå®ƒçš„ä½œç”¨æ˜¯ç»™ä¸€ä¸ªä¸´æ—¶çš„ç¼“å†²åŒºï¼Œç”¨äºè§£ç bitmapæ—¶ä½œä¸ºä¸­é—´è¯»å†™ç¼“å†²ï¼Œå¦‚æœä¸è®¾ç½®ï¼Œç³»ç»Ÿæ¯æ¬¡è§£ç æ—¶ä¼šè‡ªå·±newä¸€ä¸ªä¸´æ—¶byte[]æ¥ç”¨ï¼Œè¯¥ç¼“å†²åŒºä¸»è¦åœ¨ä»¥ä¸‹åœºæ™¯ä¼šç”¨åˆ°ï¼š\nè¯»å–å›¾ç‰‡å¤´(Header) æ¯”å¦‚æ£€æµ‹æ˜¯å¦ PNG/JPEG/WebPã€å®½é«˜ã€æ˜¯å¦æœ‰ alpha ç­‰ã€‚ è¯»å–å‹ç¼©æ•°æ®å—ï¼ˆå¦‚ JPEG çš„ MCUsï¼‰ JPEG è§£ç æ—¶ä¼šåˆ†æ®µè¯»å–å‹ç¼©å†…å®¹ï¼Œéœ€è¦ä¸€ä¸ªä¸´æ—¶ç¼“å†²ã€‚ ä»æµä¸­è¯»å–æ•°æ®æ—¶ä½œä¸º I/O buffer ä¾‹å¦‚ InputStream â†’ Skia çš„å†…éƒ¨è§£ç å™¨éœ€è¦ buffer è£…è½½éƒ¨åˆ†æ•°æ®ã€‚ æ¥ç€è°ƒç”¨äº†decodeFromWrappedStreamsæ–¹æ³•ï¼š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 private Bitmap decodeFromWrappedStreams( ImageReader imageReader, BitmapFactory.Options options, DownsampleStrategy downsampleStrategy, DecodeFormat decodeFormat, PreferredColorSpace preferredColorSpace, boolean isHardwareConfigAllowed, int requestedWidth, int requestedHeight, boolean fixBitmapToRequestedDimensions, DecodeCallbacks callbacks) throws IOException { long startTime = LogTime.getLogTime(); int[] sourceDimensions = getDimensions(imageReader, options, callbacks, bitmapPool); int sourceWidth = sourceDimensions[0]; int sourceHeight = sourceDimensions[1]; String sourceMimeType = options.outMimeType; int orientation = imageReader.getImageOrientation(); int degreesToRotate = TransformationUtils.getExifOrientationDegrees(orientation); boolean isExifOrientationRequired = TransformationUtils.isExifOrientationRequired(orientation); int targetWidth = requestedWidth == Target.SIZE_ORIGINAL ? (isRotationRequired(degreesToRotate) ? sourceHeight : sourceWidth) : requestedWidth; int targetHeight = requestedHeight == Target.SIZE_ORIGINAL ? (isRotationRequired(degreesToRotate) ? sourceWidth : sourceHeight) : requestedHeight; ImageType imageType = imageReader.getImageType(); calculateScaling( imageType, imageReader, callbacks, bitmapPool, downsampleStrategy, degreesToRotate, sourceWidth, sourceHeight, targetWidth, targetHeight, options); calculateConfig( imageReader, decodeFormat, isHardwareConfigAllowed, isExifOrientationRequired, options, targetWidth, targetHeight); boolean isKitKatOrGreater = Build.VERSION.SDK_INT \u0026gt;= Build.VERSION_CODES.KITKAT; if ((options.inSampleSize == 1 || isKitKatOrGreater) \u0026amp;\u0026amp; shouldUsePool(imageType)) { int expectedWidth; int expectedHeight; if (sourceWidth \u0026gt;= 0 \u0026amp;\u0026amp; sourceHeight \u0026gt;= 0 \u0026amp;\u0026amp; fixBitmapToRequestedDimensions \u0026amp;\u0026amp; isKitKatOrGreater) { expectedWidth = targetWidth; expectedHeight = targetHeight; } else { float densityMultiplier = isScaling(options) ? (float) options.inTargetDensity / options.inDensity : 1f; int sampleSize = options.inSampleSize; int downsampledWidth = (int) Math.ceil(sourceWidth / (float) sampleSize); int downsampledHeight = (int) Math.ceil(sourceHeight / (float) sampleSize); expectedWidth = Math.round(downsampledWidth * densityMultiplier); expectedHeight = Math.round(downsampledHeight * densityMultiplier); } if (expectedWidth \u0026gt; 0 \u0026amp;\u0026amp; expectedHeight \u0026gt; 0) { setInBitmap(options, bitmapPool, expectedWidth, expectedHeight); } } if (preferredColorSpace != null) { if (Build.VERSION.SDK_INT \u0026gt;= Build.VERSION_CODES.P) { boolean isP3Eligible = preferredColorSpace == PreferredColorSpace.DISPLAY_P3 \u0026amp;\u0026amp; options.outColorSpace != null \u0026amp;\u0026amp; options.outColorSpace.isWideGamut(); options.inPreferredColorSpace = ColorSpace.get(isP3Eligible ? ColorSpace.Named.DISPLAY_P3 : ColorSpace.Named.SRGB); } else if (Build.VERSION.SDK_INT \u0026gt;= Build.VERSION_CODES.O) { options.inPreferredColorSpace = ColorSpace.get(ColorSpace.Named.SRGB); } } Bitmap downsampled = decodeStream(imageReader, options, callbacks, bitmapPool); callbacks.onDecodeComplete(bitmapPool, downsampled); Bitmap rotated = null; if (downsampled != null) { downsampled.setDensity(displayMetrics.densityDpi); rotated = TransformationUtils.rotateImageExif(bitmapPool, downsampled, orientation); if (!downsampled.equals(rotated)) { bitmapPool.put(downsampled); } } return rotated; } é¦–å…ˆé€šè¿‡getDimensionsæ–¹æ³•è·å–å›¾ç‰‡çš„åŸå§‹å®½é«˜ï¼š\n1 2 3 4 5 6 7 8 9 10 11 private static int[] getDimensions( ImageReader imageReader, BitmapFactory.Options options, DecodeCallbacks decodeCallbacks, BitmapPool bitmapPool) throws IOException { options.inJustDecodeBounds = true; decodeStream(imageReader, options, decodeCallbacks, bitmapPool); options.inJustDecodeBounds = false; return new int[] {options.outWidth, options.outHeight}; } åœ¨è¯»å–å®½é«˜å‰ç»™Optionsçš„inJustDecodeBoundsè®¾ç½®ä¸ºtrueï¼Œè·å–å®Œåï¼Œç„¶åè®¾ç½®ä¸ºfalseï¼Œè¿™é‡Œæ˜¯åªè¯»å–å›¾ç‰‡çš„å®½é«˜ï¼Œä¸è¿›è¡Œè§£ç åŠ è½½åˆ°å†…å­˜ä¸­ã€‚æ¥ç€è°ƒç”¨äº†decodeStreamæ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 private static Bitmap decodeStream( ImageReader imageReader, BitmapFactory.Options options, DecodeCallbacks callbacks, BitmapPool bitmapPool) throws IOException { result = imageReader.decodeBitmap(options); return result; } æ­¤å¤„è°ƒç”¨äº†ByteBufferReaderçš„decodeBitmapï¼š\n1 2 3 4 5 6 7 8 9 10 11 public Bitmap decodeBitmap(Options options) { return BitmapFactory.decodeStream(stream(), /* outPadding= */ null, options); } private InputStream stream() { return ByteBufferUtil.toStream(ByteBufferUtil.rewind(buffer)); } public static InputStream toStream(@NonNull ByteBuffer buffer) { return new ByteBufferStream(buffer); } æ­¤å¤„å°†ByteBufferåŒ…è£…æˆByteBufferStreamçš„æµï¼ŒGlideè‡ªå®šä¹‰äº†ä¸€ä¸ªbytebufferçš„è¾“å…¥æµã€‚æœ‰å…´è¶£çš„å¯ä»¥çœ‹çœ‹å®ç°ï¼Œè¿™é‡Œå°±ä¸å±•å¼€äº†ï¼Œè·å–åˆ°å›¾ç‰‡çš„åŸå§‹å®½é«˜åï¼Œåˆ¤æ–­å›¾ç‰‡æœ‰æ²¡æœ‰è¿›è¡Œæ—‹è½¬ï¼Œå¦‚æœæœ‰çš„è¯ï¼Œåˆ™é‡æ–°è®¡ç®—ç›®æ ‡å®½é«˜ï¼Œå¦åˆ™è¿˜æ˜¯ä¹‹å‰çš„ç›®æ ‡å®½é«˜ï¼Œæ¥ç€è°ƒç”¨calculateScalingæ–¹æ³•æ¥è®¾ç½®é‡‡æ ·å’Œç¼©æ”¾ä¿¡æ¯ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 private static void calculateScaling( ImageType imageType, ImageReader imageReader, DecodeCallbacks decodeCallbacks, BitmapPool bitmapPool, DownsampleStrategy downsampleStrategy, int degreesToRotate, int sourceWidth, int sourceHeight, int targetWidth, int targetHeight, BitmapFactory.Options options) throws IOException { int orientedSourceWidth = sourceWidth; int orientedSourceHeight = sourceHeight; final float exactScaleFactor = downsampleStrategy.getScaleFactor( orientedSourceWidth, orientedSourceHeight, targetWidth, targetHeight); SampleSizeRounding rounding = downsampleStrategy.getSampleSizeRounding( orientedSourceWidth, orientedSourceHeight, targetWidth, targetHeight); int outWidth = round(exactScaleFactor * orientedSourceWidth); int outHeight = round(exactScaleFactor * orientedSourceHeight); int widthScaleFactor = orientedSourceWidth / outWidth; int heightScaleFactor = orientedSourceHeight / outHeight; int scaleFactor = rounding == SampleSizeRounding.MEMORY ? Math.max(widthScaleFactor, heightScaleFactor) : Math.min(widthScaleFactor, heightScaleFactor); int powerOfTwoSampleSize; // BitmapFactory does not support downsampling wbmp files on platforms \u0026lt;= M. See b/27305903. if (Build.VERSION.SDK_INT \u0026lt;= 23 \u0026amp;\u0026amp; NO_DOWNSAMPLE_PRE_N_MIME_TYPES.contains(options.outMimeType)) { powerOfTwoSampleSize = 1; } else { powerOfTwoSampleSize = Math.max(1, Integer.highestOneBit(scaleFactor)); if (rounding == SampleSizeRounding.MEMORY \u0026amp;\u0026amp; powerOfTwoSampleSize \u0026lt; (1.f / exactScaleFactor)) { powerOfTwoSampleSize = powerOfTwoSampleSize \u0026lt;\u0026lt; 1; } } options.inSampleSize = powerOfTwoSampleSize; int powerOfTwoWidth; int powerOfTwoHeight; if (imageType == ImageType.JPEG) { int nativeScaling = Math.min(powerOfTwoSampleSize, 8); powerOfTwoWidth = (int) Math.ceil(orientedSourceWidth / (float) nativeScaling); powerOfTwoHeight = (int) Math.ceil(orientedSourceHeight / (float) nativeScaling); int secondaryScaling = powerOfTwoSampleSize / 8; if (secondaryScaling \u0026gt; 0) { powerOfTwoWidth = powerOfTwoWidth / secondaryScaling; powerOfTwoHeight = powerOfTwoHeight / secondaryScaling; } } else if (imageType == ImageType.PNG || imageType == ImageType.PNG_A) { powerOfTwoWidth = (int) Math.floor(orientedSourceWidth / (float) powerOfTwoSampleSize); powerOfTwoHeight = (int) Math.floor(orientedSourceHeight / (float) powerOfTwoSampleSize); } else if (imageType.isWebp()) { if (Build.VERSION.SDK_INT \u0026gt;= Build.VERSION_CODES.N) { powerOfTwoWidth = Math.round(orientedSourceWidth / (float) powerOfTwoSampleSize); powerOfTwoHeight = Math.round(orientedSourceHeight / (float) powerOfTwoSampleSize); } else { powerOfTwoWidth = (int) Math.floor(orientedSourceWidth / (float) powerOfTwoSampleSize); powerOfTwoHeight = (int) Math.floor(orientedSourceHeight / (float) powerOfTwoSampleSize); } } else if (orientedSourceWidth % powerOfTwoSampleSize != 0 || orientedSourceHeight % powerOfTwoSampleSize != 0) { int[] dimensions = getDimensions(imageReader, options, decodeCallbacks, bitmapPool); powerOfTwoWidth = dimensions[0]; powerOfTwoHeight = dimensions[1]; } else { powerOfTwoWidth = orientedSourceWidth / powerOfTwoSampleSize; powerOfTwoHeight = orientedSourceHeight / powerOfTwoSampleSize; } double adjustedScaleFactor = downsampleStrategy.getScaleFactor( powerOfTwoWidth, powerOfTwoHeight, targetWidth, targetHeight); if (Build.VERSION.SDK_INT \u0026gt;= Build.VERSION_CODES.KITKAT) { options.inTargetDensity = adjustTargetDensityForError(adjustedScaleFactor); options.inDensity = getDensityMultiplier(adjustedScaleFactor); } if (isScaling(options)) { options.inScaled = true; } else { options.inDensity = options.inTargetDensity = 0; } } é¦–å…ˆé€šè¿‡downsampleStrategy.getScaleFactorè·å–ç¼©æ”¾æ¯”ï¼Œé»˜è®¤FitCenterï¼š\n1 2 3 4 5 6 7 8 private static class FitCenter extends DownsampleStrategy { @Override public float getScaleFactor( int sourceWidth, int sourceHeight, int requestedWidth, int requestedHeight) { float widthPercentage = requestedWidth / (float) sourceWidth; float heightPercentage = requestedHeight / (float) sourceHeight; return Math.min(widthPercentage, heightPercentage); } éœ€è¦å®½é«˜æ¯”ä¸ŠåŸå§‹å®½é«˜çš„æ¯”å–å°çš„æ¯”ä¾‹ï¼Œæ¯”å¦‚åœ¨å‰é¢åˆ†æè¿‡ä¸€å¼ 544*184å›¾ç‰‡ï¼ŒimageViewçš„å®½é«˜è®¾ç½®çš„wrap_contentï¼Œè·å–åˆ°çš„requestedWidthå’ŒrequestedHeightåœ¨å°ç±³10ä¸Šæ˜¯2206ï¼Œæ‰€ä»¥getScaleFactorè·å–åˆ°çš„å®½æ¯”ä¾‹è¦å°ï¼Œå·®ä¸å¤šæ˜¯4çš„æ ·å­ã€‚æ‰€ä»¥ç¬¬ä¸€æ¬¡ç®—å‡ºæ¥çš„exactScaleFactoræ˜¯4ï¼Œç»§ç»­è°ƒç”¨downsampleStrategy.getSampleSizeRoundingæ˜¯ä¿è´¨é‡è¿˜æ˜¯ä¿å†…å­˜ã€‚åœ¨å°ç±³10ä¸Šæ˜¯ä¿è´¨é‡ã€‚ç„¶åç®—å‡ºoutWidthå’ŒoutWidthï¼Œå®ƒä»¬æ˜¯è¡¨ç¤ºç¼©æ”¾åçš„å¤§å°ï¼Œé€šè¿‡ sourceWidth*exactScaleFactor ç®—å‡ºæ¥çš„ï¼Œé«˜ä¹Ÿæ˜¯å¦‚æ­¤ã€‚ç„¶åç®—å‡ºå®½é«˜å„è‡ªçš„ç¼©æ”¾æ¯”ï¼Œåªä¸è¿‡è¿™é‡Œç¼©æ”¾æ¯”æ˜¯å–æ•´ï¼Œç„¶åå­˜å‚¨åˆ°widthScaleFactorå’ŒheightScaleFactorä¸­ï¼Œç„¶ååˆ¤æ–­æ˜¯ä¿è´¨é‡è¿˜æ˜¯å†…å­˜ï¼Œå¦‚æœæ˜¯ä¿å†…å­˜ï¼Œåˆ™å–widthScaleFactorå’ŒheightScaleFactorä¸­çš„å¤§å€¼ï¼Œå¦‚æœæ˜¯ä¿è´¨é‡ï¼Œåˆ™å–å®ƒä¸¤çš„å°å€¼ã€‚å°†ç»“æœç»™åˆ°scaleFactorå˜é‡ï¼Œæœ€åè®¡ç®—é‡‡æ ·ç‡ï¼š\n1 2 int powerOfTwoSampleSize = Math.max(1, Integer.highestOneBit(scaleFactor)); options.inSampleSize = powerOfTwoSampleSize; Integer.highestOneBitæ˜¯å¯¹æŸä¸€ä¸ªæ•´æ•°å–2çš„næ¬¡å¹‚ï¼Œæ¯”å¦‚5çš„è¯ï¼Œå®ƒçš„äºŒè¿›åˆ¶æ˜¯101ï¼Œé‚£ä¹ˆå–æœ€é«˜ä½çš„1ï¼Œå…¶ä½™ä½éƒ½æ˜¯0ï¼Œæ‰€ä»¥æ˜¯4ï¼Œæœ€åå°†è¯¥æ•°ç»™åˆ°optionsçš„inSampleSizeè®¾ç½®é‡‡æ ·ç‡ã€‚å› ä¸ºé‡‡æ ·ç‡å–å€¼æ˜¯2çš„næ¬¡å¹‚ã€‚é‚£å‰©ä¸‹çš„ç¼©æ”¾è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿäº¤ç»™äº†densityæ¥è¿›è¡Œç²¾åº¦ç¼©æ”¾ï¼Œä¸‹é¢æ¥çœ‹ä¸‹ä¸‹åŠéƒ¨åˆ†çš„ç¼©æ”¾ï¼š\nJPEG å…ˆäº¤ç»™libjpeg-turboè¿›è¡ŒåŸç”Ÿç¼©æ”¾ï¼Œç¼©æ”¾æœ€å¤§æ˜¯8ï¼Œå¹¶ä¸”ä½¿ç”¨äº†ceilå‘ä¸Šå–æ•´ï¼Œç»§ç»­åˆ¤æ–­å¦‚æœç›®æ ‡ç¼©æ”¾å¤§äº8çš„è¯ï¼Œåˆ™å‰©ä½™çš„ç¼©æ”¾äº¤ç»™skiaè¿›è¡Œç¼©æ”¾ PNG pngç±»å°±æ¯”è¾ƒç®€å•äº†ï¼Œç›´æ¥è·å–ä»»æ„é‡‡æ ·åçš„å¤§å°ï¼Œç„¶åäº¤ç»™äº†skiaè¿›è¡Œç¼©æ”¾ï¼Œæ­¤æ—¶æ˜¯å‘ä¸‹å–æ•´ WebP å’Œä¸Šé¢çš„pngç±»ä¼¼ï¼Œä¹Ÿæ˜¯è·å–ä»»æ„é‡‡æ ·åçš„å¤§å°ï¼Œä¸è¿‡åˆ†ç‰ˆæœ¬æ˜¯å››èˆäº”å…¥è¿˜æ˜¯å‘ä¸‹å–æ•´ åŸå§‹å®½/é‡‡æ ·ä¸èƒ½æ•´é™¤æˆ–è€…åŸå§‹é«˜/é‡‡æ ·ä¸èƒ½æ•´é™¤ ç»§ç»­decodeä¸€æ¬¡è·å–é‡‡æ ·åçš„å®½é«˜ï¼Œå‰©ä½™äº¤ç»™skiaè¿›è¡Œç¼©æ”¾ æ¥ç€å†ä¸€æ¬¡è·å–é‡‡æ ·åçš„æ¯”ä¾‹ï¼Œè·å–åˆ°æ¯”ä¾‹åï¼Œè®¾ç½®optionsçš„inTargetDensityå’ŒinDensityè¿›è¡Œç²¾ç¡®ç¼©æ”¾ï¼Œåœ¨åº•å±‚åšskiaç¼©æ”¾çš„æ—¶å€™ï¼Œä¼šé€šè¿‡inTargetDensity/inDensityå¾—åˆ°ä¸€ä¸ªç¼©æ”¾æ¯”ï¼Œä½†æ˜¯è¿™ä¸¤ä¸ªæ•°éƒ½æ˜¯ä¸€ä¸ªæ•´æ•°ï¼Œé‚£ä¹ˆæ€ä¹ˆä¿è¯ä¸¤ä¸ªæ•´æ•°ç›¸é™¤å¾—åˆ°çš„æ¯”ä¾‹æ˜¯æœ€ç»ˆçš„adjustedScaleFactor(floatç±»å‹)ï¼Œä¸‹é¢çœ‹ä¸‹Glideæ˜¯å¦‚ä½•ç®—inTargetDensityå’ŒinDensityï¼š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 options.inTargetDensity = adjustTargetDensityForError(adjustedScaleFactor);//è®¡ç®—æœ€å°è¯¯å·®çš„targetDensity options.inDensity = getDensityMultiplier(adjustedScaleFactor);//inDensityä½¿ç”¨ä¸€ä¸ªå¾ˆå¤§çš„åˆ†æ¯ private static int adjustTargetDensityForError(double adjustedScaleFactor) { int densityMultiplier = getDensityMultiplier(adjustedScaleFactor); int targetDensity = round(densityMultiplier * adjustedScaleFactor); float scaleFactorWithError = targetDensity / (float) densityMultiplier; double difference = adjustedScaleFactor / scaleFactorWithError; return round(difference * targetDensity); } private static int getDensityMultiplier(double adjustedScaleFactor) { return (int) Math.round( Integer.MAX_VALUE * (adjustedScaleFactor \u0026lt;= 1D ? adjustedScaleFactor : 1 / adjustedScaleFactor)); } getDensityMultiplieræ–¹æ³•æ˜¯å¾—åˆ°ä¸€ä¸ªç›®æ ‡æ¯”ä¾‹çš„åˆ†æ¯ï¼Œå¯ä»¥çœ‹å‡ºæ¥å®ƒæ˜¯ä¸€ä¸ªå¾ˆå¤§çš„æ•°ï¼Œé‚£è‡ªç„¶è€Œç„¶ï¼ŒtargetDensity(ç¬¬ä¸€æ¬¡çš„å®é™…density)å°±æ˜¯densityMultiplier(åˆ†æ¯)*adjustedScaleFactor(ç›®æ ‡æ¯”ä¾‹)ã€‚ç„¶åå¾—åˆ°å®ä¾‹æ¯”ä¾‹(scaleFactorWithError)ï¼Œå†çœ‹é¢„æœŸæ¯”ä¾‹(adjustedScaleFactor)å’Œå®é™…æ¯”ä¾‹(scaleFactorWithError)ç›¸éš”å¤šå°‘å€ï¼Œç„¶åæŠŠè¿™ä¸ªå·®çš„å€æ•°è¡¥ä¸Šåˆ°ç¬¬ä¸€æ¬¡ç®—çš„å®é™…density(targetDensity)å°±å¾—åˆ°æœ€å°è¯¯å·®çš„densityï¼Œä¸Šé¢å°±æ˜¯æ•´ä¸ªç¼©æ”¾çš„é€»è¾‘äº†ã€‚\nå†å›åˆ°ä¸Šé¢decodeä¸­çš„calculateConfigï¼Œå®ƒä¸»è¦æ˜¯é€šè¿‡åˆ¤æ–­æ˜¯å¦æœ‰alphaé€šé“æ¥å¾—åˆ°ä¸€ä¸ªåˆé€‚çš„è§£ç æ–¹å¼:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 private void calculateConfig( ImageReader imageReader, DecodeFormat format, boolean isHardwareConfigAllowed, boolean isExifOrientationRequired, BitmapFactory.Options optionsWithScaling, int targetWidth, int targetHeight) { if (format == DecodeFormat.PREFER_ARGB_8888 || Build.VERSION.SDK_INT == Build.VERSION_CODES.JELLY_BEAN) { optionsWithScaling.inPreferredConfig = Bitmap.Config.ARGB_8888; return; } boolean hasAlpha = imageReader.getImageType().hasAlpha(); optionsWithScaling.inPreferredConfig = hasAlpha ? Bitmap.Config.ARGB_8888 : Bitmap.Config.RGB_565; if (optionsWithScaling.inPreferredConfig == Config.RGB_565) { optionsWithScaling.inDither = true; } } åœ¨Glideä¸­formaté»˜è®¤æ˜¯ DecodeFormat.PREFER_ARGB_8888 ï¼Œå¦‚æœè¦è®¾ç½®çš„è¯ï¼Œé€šè¿‡æ³¨è§£å¯ä»¥é…ç½®ï¼Œæ‰€ä»¥Glideä¼˜å…ˆæ˜¯ä½¿ç”¨ Bitmap.Config.ARGB_8888 , å¦‚æœé»˜è®¤ä¸æ˜¯ DecodeFormat.PREFER_ARGB_8888 ï¼Œåˆ¤æ–­å›¾ç‰‡æ˜¯å¦å¸¦é€æ˜ä¿¡æ¯ï¼Œå¦‚æœå¸¦çš„è¯ï¼Œä¹Ÿæ˜¯è®¾ç½®æˆ Bitmap.Config.ARGB_8888 ï¼Œå¦åˆ™æ˜¯ Bitmap.Config.RGB_565 ã€‚scaleå’Œconfigå¤„ç†å®Œäº‹åï¼Œæœ€åå°±æ˜¯optionsçš„inBitmapå¤„ç†äº†ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 float densityMultiplier = isScaling(options) ? (float) options.inTargetDensity / options.inDensity : 1f; int sampleSize = options.inSampleSize; int downsampledWidth = (int) Math.ceil(sourceWidth / (float) sampleSize); int downsampledHeight = (int) Math.ceil(sourceHeight / (float) sampleSize); expectedWidth = Math.round(downsampledWidth * densityMultiplier); expectedHeight = Math.round(downsampledHeight * densityMultiplier); if (expectedWidth \u0026gt; 0 \u0026amp;\u0026amp; expectedHeight \u0026gt; 0) { setInBitmap(options, bitmapPool, expectedWidth, expectedHeight); } private static void setInBitmap( BitmapFactory.Options options, BitmapPool bitmapPool, int width, int height) { @Nullable Bitmap.Config expectedConfig = null; if (Build.VERSION.SDK_INT \u0026gt;= Build.VERSION_CODES.O) { if (options.inPreferredConfig == Config.HARDWARE) { return; } expectedConfig = options.outConfig; } if (expectedConfig == null) { expectedConfig = options.inPreferredConfig; } // BitmapFactory will clear out the Bitmap before writing to it, so getDirty is safe. options.inBitmap = bitmapPool.getDirty(width, height, expectedConfig); } è®¡ç®—æœ€ç»ˆçš„å®½é«˜ï¼Œç„¶åè°ƒç”¨setInBitmapæ–¹æ³•ï¼Œåœ¨è¯¥æ–¹æ³•é‡Œé¢é€šè¿‡bitmapPoolä¸­æ‰¾åˆ°åˆé€‚çš„bitmapï¼Œè¿™æ ·åœ¨è§£ç çš„æ—¶å€™ï¼Œå¯ä»¥ç”¨è¯¥bitmapçš„å†…å­˜è¿›è¡Œè§£ç ï¼Œä¸éœ€è¦é‡å¤åˆ›å»ºæ–°å†…å­˜ï¼Œä»è€Œå‡å°‘å†…å­˜æŠ–åŠ¨ã€‚æ‰€æœ‰éƒ½å®Œäº‹åï¼Œæœ€åå°±æ˜¯å†ä¸€æ¬¡è°ƒç”¨decodeStreamå°†æµè½¬åŒ–æˆbitmapï¼Œç„¶åå›è°ƒç»™ä¸Šå±‚ï¼Œæ•´ä¸ªè§£ç å®Œæˆã€‚\nç¼–ç è¿‡ç¨‹ ç¼–ç å’Œè§£ç æ˜¯ä¸€ä¸ªå¯¹ç«‹çš„å…³ç³»ï¼Œåœ¨ä¸»æµç¨‹ä¸­è®²è¿‡è§£ç å®Œæˆåï¼Œå…ˆåä¼šå›è°ƒåˆ°DecodeJobçš„onResourceDecodedå’ŒnotifyEncodeAndReleaseæ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 \u0026lt;Z\u0026gt; Resource\u0026lt;Z\u0026gt; onResourceDecoded(DataSource dataSource, @NonNull Resource\u0026lt;Z\u0026gt; decoded) { boolean isFromAlternateCacheKey = !decodeHelper.isSourceKey(currentSourceKey); if (diskCacheStrategy.isResourceCacheable( isFromAlternateCacheKey, dataSource, encodeStrategy)) { final Key key; switch (encodeStrategy) { case SOURCE: key = new DataCacheKey(currentSourceKey, signature); break; case TRANSFORMED: key = new ResourceCacheKey( decodeHelper.getArrayPool(), currentSourceKey, signature, width, height, appliedTransformation, resourceSubClass, options); break; } LockedResource\u0026lt;Z\u0026gt; lockedResult = LockedResource.obtain(transformed); deferredEncodeManager.init(key, encoder, lockedResult); result = lockedResult; } } private void notifyEncodeAndRelease( Resource\u0026lt;R\u0026gt; resource, DataSource dataSource, boolean isLoadedFromAlternateCacheKey) { if (deferredEncodeManager.hasResourceToEncode()) { deferredEncodeManager.encode(diskCacheProvider, options); } onEncodeComplete(); } åœ¨onResourceDecodedå›è°ƒä¸­é¦–å…ˆé€šè¿‡DiskCacheStrategyçš„isResourceCacheableåˆ¤æ–­è§£ç åæ˜¯å¦å¯ä»¥ç¼–ç ï¼Œä¸»è¦æ˜¯çœ‹å¯¹åº”çš„DiskCacheStrategyæ˜¯å¦å¯ä»¥ç¼–ç ï¼Œé»˜è®¤æ˜¯DiskCacheStrategy. AUTOMATICï¼Œå®ƒçš„isResourceCacheableæ–¹æ³•å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 @Override public boolean isResourceCacheable( boolean isFromAlternateCacheKey, DataSource dataSource, EncodeStrategy encodeStrategy) { return ((isFromAlternateCacheKey \u0026amp;\u0026amp; dataSource == DataSource.DATA_DISK_CACHE) || dataSource == DataSource.LOCAL) \u0026amp;\u0026amp; encodeStrategy == EncodeStrategy.TRANSFORMED; } isFromAlternateCacheKeyè¡¨ç¤ºæ˜¯å¦èƒ½ä»LoadDataä¸­æ‰¾åˆ°å¯¹åº”çš„sourceKeyï¼Œå¦‚æœä»ç½‘ç»œæˆ–ä»ç£ç›˜ä¸­æ‰¾åˆ°åŸå›¾çš„è¯ï¼Œåˆ™currentSourceKeyæ˜¯ä¸€ä¸ªGlideUrlçš„keyï¼Œå®ƒæ˜¯èƒ½ä»LoadDataæ‰¾å¾—åˆ°çš„ï¼Œæ‰€ä»¥isFromAlternateCacheKeyä¸ºfalseï¼Œå¦‚æœä»ç½‘ç»œè¿”å›çš„å›¾ç‰‡dataSourceæ˜¯REMOTEï¼Œå¦‚æœæ˜¯ä»ç£ç›˜ä¸­æ‰¾åˆ°åŸå›¾dataSourceæ˜¯DATA_DISK_CACHEï¼Œæ‰€ä»¥deferredEncodeManagerçš„initæ–¹æ³•ä¸ä¼šè°ƒç”¨ï¼Œä¹Ÿå°±ä¸ä¼šå¯¼è‡´notifyEncodeAndReleaseä¸­è°ƒç”¨deferredEncodeManagerçš„encodeï¼Œä¹Ÿå°±ä¸ä¼šè¿›è¡Œç¼–ç ï¼Œå¦‚æœæˆ‘ä»¬å°†RequestOptionsä¸­çš„diskCacheStrategyæ¢æˆDiskCacheStrategy. ALLå°±èƒ½å®ç°ç¼–ç ï¼Œé‚£æˆ‘ä»¬çœ‹ä¸‹DeferredEncodeManagerçš„encodeæ–¹æ³•ï¼š\n1 2 3 4 5 void encode(DiskCacheProvider diskCacheProvider, Options options) { diskCacheProvider .getDiskCache() .put(key, new DataCacheWriter\u0026lt;\u0026gt;(encoder, toEncode, options)); } diskCacheProvideråœ¨ä¸Šé¢è§£ç çš„æ—¶å€™æè¿‡å®ƒæ˜¯ä¸€ä¸ªLazyDiskCacheProviderï¼Œåœ¨Engineä¸­åˆå§‹åŒ–çš„ã€‚åœ¨å®ƒé‡Œé¢æ˜¯é€šè¿‡ DiskCache.Factory çš„buildæ–¹æ³•åˆ›å»ºDiskCacheï¼Œåœ¨GlideBuilderçš„buildæ–¹æ³•ä¸­åˆå§‹åŒ–çš„æ˜¯InternalCacheDiskCacheFactoryçš„ DiskCache.Factory ï¼Œæœ€ç»ˆåˆ›å»ºçš„DiskLruCacheWrapperï¼Œä»åå­—çœ‹å®ƒæ˜¯ä¸€ä¸ªåŒ…è£…ç±»ï¼Œå®é™…å¹²æ´»çš„æ˜¯DiskLruCacheï¼Œå®ƒæ˜¯glideå†…éƒ¨å®ç°çš„LRUç®—æ³•çš„ç£ç›˜ç¼“å­˜ç±»ã€‚è¿™ä¸ªè·Ÿä¸Šé¢çš„è§£ç ä¹‹å‰å°†InputStreamä¿å­˜åˆ°æœ¬åœ°ç£ç›˜ï¼Œä¹Ÿå°±æ˜¯åŸå›¾ä¿å­˜æ˜¯ä¸€æ ·çš„ã€‚æœ€ç»ˆä¼šèµ°åˆ°DataCacheWriterçš„writeæ–¹æ³•ï¼š\n1 2 3 4 5 6 class DataCacheWriter\u0026lt;DataType\u0026gt; implements DiskCache.Writer { @Override public boolean write(@NonNull File file) { return encoder.encode(data, file, options); } } encoderæ˜¯åœ¨ä¸Šé¢onResourceDecodedæ–¹æ³•ä¸­ä»Registryçš„resourceEncoderRegistryä¸­æ ¹æ®Resourceçš„getResourceClassè¿”å›çš„Classå–åˆ°çš„ï¼Œå¦‚æœè§£ç è¿”å›ä¸€ä¸ªBitmapçš„è¯ï¼Œé‚£ä¹ˆæ­¤æ—¶å¾—åˆ°çš„æ˜¯ä¸€ä¸ªBitmapEncoderï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 public static final Option\u0026lt;Integer\u0026gt; COMPRESSION_QUALITY = Option.memory(\u0026#34;com.bumptech.glide.load.resource.bitmap.BitmapEncoder.CompressionQuality\u0026#34;, 90); public boolean encode( @NonNull Resource\u0026lt;Bitmap\u0026gt; resource, @NonNull File file, @NonNull Options options) { final Bitmap bitmap = resource.get(); Bitmap.CompressFormat format = getFormat(bitmap, options); int quality = options.get(COMPRESSION_QUALITY); boolean success = false; OutputStream os = null; OutputStream os = new FileOutputStream(file); if (arrayPool != null) { os = new BufferedOutputStream(os, arrayPool); } bitmap.compress(format, quality, os); success = true; return success; } private Bitmap.CompressFormat getFormat(Bitmap bitmap, Options options) { Bitmap.CompressFormat format = options.get(COMPRESSION_FORMAT); if (format != null) { return format; } else if (bitmap.hasAlpha()) { return Bitmap.CompressFormat.PNG; } else { return Bitmap.CompressFormat.JPEG; } } é»˜è®¤çš„ç¼–ç è´¨é‡æ˜¯90ï¼Œå¹¶ä¸”é»˜è®¤çš„ç¼–ç æ ¼å¼æ˜¯å¦‚æœå›¾ç‰‡å¸¦æœ‰é€æ˜é€šé“åˆ™é‡‡ç”¨PNGæ— æŸå‹ç¼©ï¼Œå¦åˆ™ä½¿ç”¨JPEGæœ‰æŸå‹ç¼©ã€‚å¦‚æœå­—èŠ‚æ± å­å­˜åœ¨ï¼Œåˆ™æ„å»ºä¸€ä¸ªBufferedOutputStreamçš„è¾“å‡ºæµï¼Œå®ƒä½¿ç”¨çš„byteæ•°ç»„æ¥è‡ªäºå­—èŠ‚æ± å­ä¸­çš„ï¼Œé»˜è®¤å­—èŠ‚å¤§å°æ˜¯64KBçš„ç¼“å†²åŒºï¼Œæ¯æ¬¡byteæ•°ç»„è¾¾åˆ°äº†64KBçš„æ—¶å€™ï¼Œè¿›è¡ŒåŒæ­¥åˆ°åº•å±‚çš„FileOutStreamä¸­ã€‚å› ä¸ºåº•å±‚çš„FileOutputStreamæ¯æ¬¡writeéƒ½ä¼šè§¦å‘ä¸€æ¬¡ç³»ç»Ÿè°ƒç”¨ï¼Œç³»ç»Ÿè°ƒç”¨æˆæœ¬é«˜ï¼Œå¤šæ¬¡å°å—å†™å…¥ä¼šäº§ç”Ÿï¼šå†™å…¥æ—¶é—´å˜é•¿ã€CPUé™é€Ÿã€ç£ç›˜ç¢ç‰‡ã€æ•´ä½“ç¼–ç è€—æ—¶å¢åŠ ã€‚åŒæ—¶BufferedOutputStreamä½¿ç”¨çš„æ˜¯å­—èŠ‚æ± å­ä¸­çš„å­—èŠ‚æ•°ç»„ï¼Œé™ä½GCçš„è§¦å‘ã€‚\næœ€ç»ˆæµç¨‹å›¾å¦‚ä¸‹ï¼š ","date":"2025-11-19T11:49:00+08:00","permalink":"http://xiangcman.xyz/p/glide%E7%BC%96%E8%A7%A3%E7%A0%81%E6%B5%81%E7%A8%8B/","title":"Glideç¼–è§£ç æµç¨‹"},{"content":"é¢å‘å¯¹è±¡ ç±»çš„å®šä¹‰ 1 2 3 4 5 6 7 class Student: def study(self, course_name): print(f\u0026#39;å­¦ç”Ÿæ­£åœ¨å­¦ä¹ {course_name}.\u0026#39;) def play(self): print(f\u0026#39;å­¦ç”Ÿæ­£åœ¨ç©æ¸¸æˆ.\u0026#39;) ä¸Šé¢å®šä¹‰äº†ä¸€ä¸ªç±»ï¼Œç±»ä¸­å®šä¹‰äº†ä¸¤ä¸ªæˆå‘˜æ–¹æ³•ï¼Œæ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°è¡¨ç¤ºå½“å‰ç±»çš„å¯¹è±¡ã€‚\nå¯¹è±¡çš„åˆ›å»º 1 2 3 4 5 stu1 = Student() stu2 = Student() print(stu1) # \u0026lt;__main__.Student object at 0x10ad5ac50\u0026gt; print(stu2) # \u0026lt;__main__.Student object at 0x10ad5acd0\u0026gt; print(hex(id(stu1)), hex(id(stu2))) # 0x10ad5ac50 0x10ad5acd0 å…¶ä¸­printä¸­æ‰“å°äº†stu1å’Œstu2å¯¹è±¡çš„åœ¨å†…å­˜ä¸­çš„åœ°å€ï¼Œç”¨çš„æ˜¯16è¿›åˆ¶è¡¨ç¤ºçš„ã€‚ç”¨idæ–¹æ³•ä¹Ÿå¯ä»¥è·å–ä¸€ä¸ªå¯¹è±¡çš„16è¿›åˆ¶çš„å€¼ã€‚å’Œprintä¸­æ‰“å°çš„åœ°å€æ˜¯ä¿æŒä¸€è‡´çš„ã€‚\nå¯¹è±¡çš„æ–¹æ³•è°ƒç”¨ 1 Student.study(stu1, \u0026#39;Pythonç¨‹åºè®¾è®¡\u0026#39;) # å­¦ç”Ÿæ­£åœ¨å­¦ä¹ Pythonç¨‹åºè®¾è®¡. é€šè¿‡ç±»å.æ–¹æ³•çš„æ—¶å€™ï¼Œç¬¬ä¸€ä¸ªå‚æ•°éœ€è¦ä¼ å…¥å¯¹è±¡ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯æ–¹æ³•çš„å‚æ•°ã€‚\n1 stu1.study(\u0026#39;Pythonç¨‹åºè®¾è®¡\u0026#39;) # å­¦ç”Ÿæ­£åœ¨å­¦ä¹ Pythonç¨‹åºè®¾è®¡. æˆå‘˜æ–¹æ³•ä¹Ÿå¯ä»¥é€šè¿‡å¯¹è±¡æ¥è°ƒç”¨æ–¹æ³•ï¼Œå…¶ä¸­æ–¹æ³•çš„å‚æ•°ç›´æ¥æ˜¯æˆå‘˜æ–¹æ³•çš„å‚æ•°ã€‚åŒç†playæ–¹æ³•è°ƒç”¨å¦‚ä¸‹ï¼š\n1 2 Student.play(stu2) # å­¦ç”Ÿæ­£åœ¨ç©æ¸¸æˆ. stu2.play() # å­¦ç”Ÿæ­£åœ¨ç©æ¸¸æˆ. ç±»çš„åˆå§‹åŒ–æ–¹æ³• 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 class Student: \u0026#34;\u0026#34;\u0026#34;å­¦ç”Ÿ\u0026#34;\u0026#34;\u0026#34; def __init__(self, name, age): \u0026#34;\u0026#34;\u0026#34;åˆå§‹åŒ–æ–¹æ³•\u0026#34;\u0026#34;\u0026#34; self.name = name self.age = age def study(self, course_name): \u0026#34;\u0026#34;\u0026#34;å­¦ä¹ \u0026#34;\u0026#34;\u0026#34; print(f\u0026#39;{self.name}æ­£åœ¨å­¦ä¹ {course_name}.\u0026#39;) def play(self): \u0026#34;\u0026#34;\u0026#34;ç©è€\u0026#34;\u0026#34;\u0026#34; print(f\u0026#39;{self.name}æ­£åœ¨ç©æ¸¸æˆ.\u0026#39;) # è°ƒç”¨Studentç±»çš„æ„é€ å™¨åˆ›å»ºå¯¹è±¡å¹¶ä¼ å…¥åˆå§‹åŒ–å‚æ•° stu1 = Student(\u0026#39;å¼ ä¸‰\u0026#39;, 44) stu2 = Student(\u0026#39;æå››\u0026#39;, 25) stu1.study(\u0026#39;Pythonç¨‹åºè®¾è®¡\u0026#39;) # å¼ ä¸‰æ­£åœ¨å­¦ä¹ Pythonç¨‹åºè®¾è®¡. stu2.play() # æå››æ­£åœ¨ç©æ¸¸æˆ. åœ¨åˆå§‹åŒ–æ–¹æ³•ä¸­ç›´æ¥ç»™ç±»çš„æˆå‘˜å˜é‡èµ‹å€¼ï¼Œå¹¶ä¸”ä¹Ÿåˆå§‹åŒ–äº†nameå’Œageå±æ€§ã€‚å¹¶ä¸”æ­¤æ—¶çš„å±æ€§æ˜¯å…¬å¼€çš„ï¼Œèƒ½åœ¨å¤–éƒ¨è®¿é—®ã€‚\nå±æ€§çš„å¯è§æ€§ 1 2 3 4 5 6 7 8 9 10 11 12 13 class Student: def __init__(self, name, age): self.__name = name self.__age = age def study(self, course_name): print(f\u0026#39;{self.__name}æ­£åœ¨å­¦ä¹ {course_name}.\u0026#39;) stu = Student(\u0026#39;å¼ ä¸‰\u0026#39;, 20) stu.study(\u0026#39;Pythonç¨‹åºè®¾è®¡\u0026#39;) print(stu.__name) # AttributeError: \u0026#39;Student\u0026#39; object has no attribute \u0026#39;__name\u0026#39; è¿˜æ˜¯ä¸Šé¢çš„ä¾‹å­ï¼Œå°†nameå’Œageå±æ€§ç»™æ”¹ä¸ºç§æœ‰çš„äº†ï¼Œç›´æ¥ç»™å±æ€§å‰é¢åŠ ä¸‹åˆ’çº¿å°±å¯ä»¥äº†ã€‚\næ–‡ä»¶æ“ä½œ æ–‡ä»¶çš„è¯»å– 1 2 3 file = open(\u0026#34;file/1.txt\u0026#34;,\u0026#34;r\u0026#34;,encoding=\u0026#39;utf-8\u0026#39;) print(file.read()) file.close() ä¸Šé¢ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æ–‡ä»¶çš„è·¯å¾„ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯è¯»çš„æƒé™ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°æŒ‡å®šç¼–ç æ–¹å¼ã€‚\næ–‡ä»¶æŒ‰è¡Œè¯»å– 1 2 3 4 5 6 7 8 9 10 file = open(\u0026#39;file/1.txt\u0026#39;, \u0026#39;r\u0026#39;, encoding=\u0026#39;utf-8\u0026#39;) for line in file: print(line, end=\u0026#39;\u0026#39;) file.close() file = open(\u0026#39;file/1.txt\u0026#39;, \u0026#39;r\u0026#39;, encoding=\u0026#39;utf-8\u0026#39;) lines = file.readlines() for line in lines: print(line, end=\u0026#39;\u0026#39;) file.close() ä¸Šé¢ä¸¤ä¸ªæ–¹å¼éƒ½å¯ä»¥æŒ‰è¡Œè¯»å–ã€‚\næ–‡ä»¶çš„å†™å…¥ 1 2 3 4 5 6 file = open(\u0026#39;file/2.txt\u0026#39;, \u0026#39;a\u0026#39;, encoding=\u0026#39;utf-8\u0026#39;) file.write(\u0026#39;åºŠå‰æ˜æœˆå…‰ï¼Œ\u0026#39;) file.write(\u0026#39;\\nç–‘æ˜¯åœ°ä¸Šéœœ\u0026#39;) file.write(\u0026#39;\\nä¸¾å¤´æœ›æ˜æœˆ\u0026#39;) file.write(\u0026#39;\\nä½å¤´æ€æ•…ä¹¡\u0026#39;) file.close() å¼‚å¸¸å¤„ç† å¼‚å¸¸æ•è· 1 2 3 4 5 6 7 8 9 10 11 12 13 file = None try: file = open(\u0026#39;test.txt\u0026#39;, \u0026#39;r\u0026#39;, encoding=\u0026#39;utf-8\u0026#39;) print(file.read()) except FileNotFoundError: print(\u0026#39;æ— æ³•æ‰“å¼€æŒ‡å®šçš„æ–‡ä»¶!\u0026#39;) except LookupError: print(\u0026#39;æŒ‡å®šäº†æœªçŸ¥çš„ç¼–ç !\u0026#39;) except UnicodeDecodeError: print(\u0026#39;è¯»å–æ–‡ä»¶æ—¶è§£ç é”™è¯¯!\u0026#39;) finally: if file: file.close() ä¸Šé¢æ¼”ç¤ºäº†æ–‡ä»¶è¯»å–æ—¶å€™çš„å¼‚å¸¸æ•æ‰ï¼Œå¦‚æœæ–‡ä»¶æ‰¾ä¸åˆ°åˆ™ä¼šæŠ›FileNotFoundErrorå¼‚å¸¸ï¼Œå¦‚æœæœªæŒ‡å®šç¼–ç æ ¼å¼ï¼Œåˆ™ä¼šæŠ¥LookupErrorå¼‚å¸¸ï¼Œå¦‚æœæ–‡ä»¶è¯»å–æ—¶å€™çš„ç¼–ç æ ¼å¼å’Œå†™å…¥æ—¶å€™çš„ç¼–ç æ ¼å¼ä¸ä¸€è‡´å°±ä¼šæŠ¥UnicodeDecodeErrorå¼‚å¸¸ã€‚\nè‡ªå®šä¹‰å¼‚å¸¸æŠ›å‡º 1 2 3 4 5 6 7 8 9 10 11 class InputError(ValueError): \u0026#34;\u0026#34;\u0026#34;è‡ªå®šä¹‰å¼‚å¸¸ç±»å‹\u0026#34;\u0026#34;\u0026#34; pass def fac(num): \u0026#34;\u0026#34;\u0026#34;æ±‚é˜¶ä¹˜\u0026#34;\u0026#34;\u0026#34; if num \u0026lt; 0: raise InputError(\u0026#39;åªèƒ½è®¡ç®—éè´Ÿæ•´æ•°çš„é˜¶ä¹˜\u0026#39;) if num in (0, 1): return 1 return num * fac(num - 1) é€šè¿‡raiseæŠ›å‡ºå¼‚å¸¸ï¼Œç„¶ååœ¨ä½¿ç”¨facå‡½æ•°çš„æ—¶å€™æ•æ‰å¼‚å¸¸ï¼š\n1 2 3 4 try: print(f\u0026#39;{num}! = {fac(num)}\u0026#39;) except InputError as err: print(err) ","date":"2025-11-01T21:35:52+08:00","permalink":"http://xiangcman.xyz/p/python%E5%B8%B8%E8%A7%81%E8%AF%AD%E6%B3%95%E4%BA%8C/","title":"Pythonå¸¸è§è¯­æ³•äºŒ"},{"content":"å˜é‡ å˜é‡ç±»å‹ 1 2 3 4 5 6 7 8 a = 100 b = 123.45 c = \u0026#39;hello, world\u0026#39; d = True print(type(a)) # \u0026lt;class \u0026#39;int\u0026#39;\u0026gt; print(type(b)) # \u0026lt;class \u0026#39;float\u0026#39;\u0026gt; print(type(c)) # \u0026lt;class \u0026#39;str\u0026#39;\u0026gt; print(type(d)) # \u0026lt;class \u0026#39;bool\u0026#39;\u0026gt; é€šè¿‡typeæ¥çœ‹å˜é‡çš„ç±»å‹ã€‚\nå˜é‡è½¬æ¢ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 a = 100 b = 123.45 c = \u0026#39;123\u0026#39; d = \u0026#39;100\u0026#39; e = \u0026#39;123.45\u0026#39; f = \u0026#39;hello, world\u0026#39; g = True print(float(a)) # intç±»å‹çš„100è½¬æˆfloatï¼Œè¾“å‡º100.0 print(int(b)) # floatç±»å‹çš„123.45è½¬æˆintï¼Œè¾“å‡º123 print(int(c)) # strç±»å‹çš„\u0026#39;123\u0026#39;è½¬æˆintï¼Œè¾“å‡º123 print(int(c, base=16)) # strç±»å‹çš„\u0026#39;123\u0026#39;æŒ‰åå…­è¿›åˆ¶è½¬æˆintï¼Œè¾“å‡º291 print(int(d, base=2)) # strç±»å‹çš„\u0026#39;100\u0026#39;æŒ‰äºŒè¿›åˆ¶è½¬æˆintï¼Œè¾“å‡º4 print(float(e)) # strç±»å‹çš„\u0026#39;123.45\u0026#39;è½¬æˆfloatï¼Œè¾“å‡º123.45 print(bool(f)) # strç±»å‹çš„\u0026#39;hello, world\u0026#39;è½¬æˆboolï¼Œè¾“å‡ºTrue print(int(g)) # boolç±»å‹çš„Trueè½¬æˆintï¼Œè¾“å‡º1 print(chr(a)) # intç±»å‹çš„100è½¬æˆstrï¼Œè¾“å‡º\u0026#39;d\u0026#39; print(ord(\u0026#39;d\u0026#39;)) # strç±»å‹çš„\u0026#39;d\u0026#39;è½¬æˆintï¼Œè¾“å‡º100 ç®—æœ¯è¿ç®— 1 2 3 4 5 6 print(321 / 12) # é™¤æ³•è¿ç®—ï¼Œè¾“å‡º26.75ï¼Œè·Ÿjavaä¸­æ•´é™¤ä¸åƒ print(321 // 12) # æ•´é™¤è¿ç®—ï¼Œè¾“å‡º26 print(321 % 12) # æ±‚æ¨¡è¿ç®—ï¼Œè¾“å‡º9 print(2 ** 3) # å¹‚æ¬¡è¿ç®—ï¼Œ2çš„3æ¬¡æ–¹ # æµ·è±¡è¿ç®—ç¬¦ print((a := 10)) # 10 å°æ•°è¡¨ç¤ºæ³• 1 2 3 f = float(input(\u0026#39;è¯·è¾“å…¥åæ°æ¸©åº¦: \u0026#39;)) c = (f - 32) / 1.8 print(\u0026#39;%.1fåæ°åº¦ = %.1fæ‘„æ°åº¦\u0026#39; % (f, c)) è§£é‡Šï¼šæ­¤å¤„ä½¿ç”¨%.1fæ¥æ ¼å¼åŒ–ä¸€ä¸ªæµ®ç‚¹ç±»å‹çš„æ•°ï¼Œå¹¶ä¸”ä¿ç•™å°æ•°ç‚¹1ä½ã€‚è¿˜æœ‰ä¸­æ ¼å¼åŒ–è¡¨ç¤ºæ³•ï¼š\n1 2 3 f = float(input(\u0026#39;è¯·è¾“å…¥åæ°æ¸©åº¦: \u0026#39;)) c = (f - 32) / 1.8 print(f\u0026#39;{f:.1f}åæ°åº¦ = {c:.1f}æ‘„æ°åº¦\u0026#39;) å‰é¢ç”¨få¼€å¤´ï¼Œè¡¨ç¤ºé‡Œé¢æœ‰æ ¼å¼åŒ–çš„æ“ä½œï¼Œç”¨{f:.1f}æ¥ä»£æ›¿fçš„å€¼ï¼Œå¹¶ä¸”ä¿ç•™å°æ•°ç‚¹1ä½ï¼ŒåŒç†cå˜é‡ä¹Ÿæ˜¯ä¸€æ ·ã€‚\nåˆ†æ”¯ åˆ†æ”¯åˆ¤æ–­ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 height = float(input(\u0026#39;èº«é«˜(cm)ï¼š\u0026#39;)) weight = float(input(\u0026#39;ä½“é‡(kg)ï¼š\u0026#39;)) bmi = weight / (height / 100) ** 2 print(f\u0026#39;{bmi = :.1f}\u0026#39;) if bmi \u0026lt; 18.5: print(\u0026#39;ä½ çš„ä½“é‡è¿‡è½»ï¼\u0026#39;) elif bmi \u0026lt; 24: print(\u0026#39;ä½ çš„èº«æå¾ˆæ£’ï¼\u0026#39;) elif bmi \u0026lt; 27: print(\u0026#39;ä½ çš„ä½“é‡è¿‡é‡ï¼\u0026#39;) elif bmi \u0026lt; 30: print(\u0026#39;ä½ å·²è½»åº¦è‚¥èƒ–ï¼\u0026#39;) elif bmi \u0026lt; 35: print(\u0026#39;ä½ å·²ä¸­åº¦è‚¥èƒ–ï¼\u0026#39;) else: print(\u0026#39;ä½ å·²é‡åº¦è‚¥èƒ–ï¼\u0026#39;) match caseè¡¨ç¤ºæ³•ï¼š 1 2 3 4 5 6 7 8 9 10 11 status_code = int(input(\u0026#39;å“åº”çŠ¶æ€ç : \u0026#39;)) match status_code: case 400: description = \u0026#39;Bad Request\u0026#39; case 401: description = \u0026#39;Unauthorized\u0026#39; case 403: description = \u0026#39;Forbidden\u0026#39; case 404: description = \u0026#39;Not Found\u0026#39; case 405: description = \u0026#39;Method Not Allowed\u0026#39; case 418: description = \u0026#39;I am a teapot\u0026#39; case 429: description = \u0026#39;Too many requests\u0026#39; case _: description = \u0026#39;Unknown Status Code\u0026#39; print(\u0026#39;çŠ¶æ€ç æè¿°:\u0026#39;, description) å¾ªç¯ å¾ªç¯ 1 2 3 4 5 6 7 8 \u0026#34;\u0026#34;\u0026#34; æ¯éš”1ç§’è¾“å‡ºä¸€æ¬¡â€œhello, worldâ€ï¼ŒæŒç»­1å°æ—¶ \u0026#34;\u0026#34;\u0026#34; import time for i in range(3600): print(\u0026#39;hello, world\u0026#39;) time.sleep(1) içš„å€¼æ˜¯ä»0åˆ°3599ã€‚ ä¸è¦iå˜é‡çš„æ—¶å€™ï¼Œå¯ä»¥ç”¨å¦‚ä¸‹å†™æ³•ï¼š\n1 2 3 for _ in range(3600): print(\u0026#39;hello, world\u0026#39;) time.sleep(1) 1 2 3 4 total = 0 for i in range(2, 101, 2): total += i print(total) rangeæ–¹æ³•ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯èµ·å§‹å€¼ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯ç»ˆæ­¢å€¼ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯æ­¥é•¿ã€‚å…¶ä½™çš„whileå¾ªç¯ï¼Œbreakå’Œcontinueå’Œjavaä¸€æ ·çš„ç”¨æ³•ã€‚\nåˆ—è¡¨ åˆ—è¡¨çš„å®šä¹‰ 1 2 3 4 5 6 items1 = [35, 12, 99, 68, 55, 35, 87] items2 = [\u0026#39;Python\u0026#39;, \u0026#39;Java\u0026#39;, \u0026#39;Go\u0026#39;, \u0026#39;Kotlin\u0026#39;] items3 = [100, 12.3, \u0026#39;Python\u0026#39;, True] print(items1) # [35, 12, 99, 68, 55, 35, 87] print(items2) # [\u0026#39;Python\u0026#39;, \u0026#39;Java\u0026#39;, \u0026#39;Go\u0026#39;, \u0026#39;Kotlin\u0026#39;] print(items3) # [100, 12.3, \u0026#39;Python\u0026#39;, True] åˆ—è¡¨ä½¿ç”¨[]æ¥åˆå§‹åŒ–ï¼Œå¯ä»¥æœ‰é‡å¤å€¼ã€‚\nä½¿ç”¨listå®šä¹‰åˆ—è¡¨ 1 2 3 4 items4 = list(range(1, 10)) items5 = list(\u0026#39;hello\u0026#39;) print(items4) # [1, 2, 3, 4, 5, 6, 7, 8, 9] print(items5) # [\u0026#39;h\u0026#39;, \u0026#39;e\u0026#39;, \u0026#39;l\u0026#39;, \u0026#39;l\u0026#39;, \u0026#39;o\u0026#39;] ä½¿ç”¨list()æ¥åˆå§‹åŒ–ä¸€ä¸ªåˆ—è¡¨ã€‚\nåˆ—è¡¨ç›¸åŠ  1 2 3 4 5 6 7 items5 = [35, 12, 99, 45, 66] items6 = [45, 58, 29] items7 = [\u0026#39;Python\u0026#39;, \u0026#39;Java\u0026#39;, \u0026#39;JavaScript\u0026#39;] print(items5 + items6) # [35, 12, 99, 45, 66, 45, 58, 29] print(items6 + items7) # [45, 58, 29, \u0026#39;Python\u0026#39;, \u0026#39;Java\u0026#39;, \u0026#39;JavaScript\u0026#39;] items5 += items6 print(items5) # [35, 12, 99, 45, 66, 45, 58, 29] ä¸¤ä¸ªåˆ—è¡¨ç›¸åŠ ï¼Œå¾—åˆ°ä¸€ä¸ªæ–°çš„åˆ—è¡¨ã€‚\nåˆ—è¡¨å…ƒç´ çš„è·å– 1 2 3 4 5 6 7 8 9 10 11 items8 = [\u0026#39;apple\u0026#39;, \u0026#39;waxberry\u0026#39;, \u0026#39;pitaya\u0026#39;, \u0026#39;peach\u0026#39;, \u0026#39;watermelon\u0026#39;] print(items8[0]) # apple print(items8[2]) # pitaya print(items8[4]) # watermelon items8[2] = \u0026#39;durian\u0026#39; print(items8) # [\u0026#39;apple\u0026#39;, \u0026#39;waxberry\u0026#39;, \u0026#39;durian\u0026#39;, \u0026#39;peach\u0026#39;, \u0026#39;watermelon\u0026#39;] print(items8[-5]) # \u0026#39;apple\u0026#39; print(items8[-4]) # \u0026#39;waxberry\u0026#39; print(items8[-1]) # watermelon items8[-4] = \u0026#39;strawberry\u0026#39; print(items8) # [\u0026#39;apple\u0026#39;, \u0026#39;strawberry\u0026#39;, \u0026#39;durian\u0026#39;, \u0026#39;peach\u0026#39;, \u0026#39;watermelon\u0026#39;] å–åˆ—è¡¨ä¸­çš„å…ƒç´ ï¼Œè´Ÿæ•°è¡¨ç¤ºå€’æ•°ç¬¬å‡ ä¸ªã€‚\nåˆ—è¡¨åŒºé—´å–å…ƒç´  1 2 3 4 5 print(items8[1:3:1]) # [\u0026#39;strawberry\u0026#39;, \u0026#39;durian\u0026#39;] print(items8[0:3:1]) # [\u0026#39;apple\u0026#39;, \u0026#39;strawberry\u0026#39;, \u0026#39;durian\u0026#39;] print(items8[0:5:2]) # [\u0026#39;apple\u0026#39;, \u0026#39;durian\u0026#39;, \u0026#39;watermelon\u0026#39;] print(items8[-4:-2:1]) # [\u0026#39;strawberry\u0026#39;, \u0026#39;durian\u0026#39;] print(items8[-2:-6:-1]) # [\u0026#39;peach\u0026#39;, \u0026#39;durian\u0026#39;, \u0026#39;strawberry\u0026#39;, \u0026#39;apple\u0026#39;] åŒºé—´å–å…ƒç´ ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯å–å€¼çš„è·³è·ƒå‡ ä¸ªã€‚\n1 2 3 4 5 print(items8[1:3]) # [\u0026#39;strawberry\u0026#39;, \u0026#39;durian\u0026#39;] print(items8[:3:1]) # [\u0026#39;apple\u0026#39;, \u0026#39;strawberry\u0026#39;, \u0026#39;durian\u0026#39;] print(items8[::2]) # [\u0026#39;apple\u0026#39;, \u0026#39;durian\u0026#39;, \u0026#39;watermelon\u0026#39;] print(items8[-4:-2]) # [\u0026#39;strawberry\u0026#39;, \u0026#39;durian\u0026#39;] print(items8[-2::-1]) # [\u0026#39;peach\u0026#39;, \u0026#39;durian\u0026#39;, \u0026#39;strawberry\u0026#39;, \u0026#39;apple\u0026#39;] ä¸‰ä¸ªå‚æ•°å¯ä»¥çœç•¥ï¼Œç¬¬ä¸€ä¸ªå‚æ•°çœç•¥æ˜¯0ï¼Œç¬¬äºŒä¸ªå‚æ•°çœç•¥æ˜¯åˆ°æœ€åä¸€ä¸ªå…ƒç´ ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°çœç•¥æ˜¯1ã€‚\nåˆ—è¡¨éå† 1 2 3 languages = [\u0026#39;Python\u0026#39;, \u0026#39;Java\u0026#39;, \u0026#39;C++\u0026#39;, \u0026#39;Kotlin\u0026#39;] for index in range(len(languages)): print(languages[index]) ä½¿ç”¨rangeçš„æ—¶å€™ä¼ å…¥åˆ—è¡¨çš„é•¿åº¦ï¼Œç„¶åè¿›è¡Œéå†å–å…ƒç´ ã€‚\nåˆ—è¡¨çš„å…ƒç´ æ·»åŠ  1 2 3 4 5 languages = [\u0026#39;Python\u0026#39;, \u0026#39;Java\u0026#39;, \u0026#39;C++\u0026#39;] languages.append(\u0026#39;JavaScript\u0026#39;) print(languages) # [\u0026#39;Python\u0026#39;, \u0026#39;Java\u0026#39;, \u0026#39;C++\u0026#39;, \u0026#39;JavaScript\u0026#39;] languages.insert(1, \u0026#39;SQL\u0026#39;) print(languages) # [\u0026#39;Python\u0026#39;, \u0026#39;SQL\u0026#39;, \u0026#39;Java\u0026#39;, \u0026#39;C++\u0026#39;, \u0026#39;JavaScript\u0026#39;] ä½¿ç”¨appendæ·»åŠ åˆ°åˆ—è¡¨æœ«å°¾ï¼Œä½¿ç”¨insertç»™æŒ‡å®šä½ç½®æ·»åŠ å…ƒç´ ã€‚\nåˆ—è¡¨çš„å…ƒç´ ç§»é™¤ 1 2 3 4 5 6 7 8 9 10 11 12 13 languages = [\u0026#39;Python\u0026#39;, \u0026#39;SQL\u0026#39;, \u0026#39;Java\u0026#39;, \u0026#39;C++\u0026#39;, \u0026#39;JavaScript\u0026#39;] if \u0026#39;Java\u0026#39; in languages: languages.remove(\u0026#39;Java\u0026#39;) if \u0026#39;Swift\u0026#39; in languages: languages.remove(\u0026#39;Swift\u0026#39;) print(languages) # [\u0026#39;Python\u0026#39;, \u0026#39;SQL\u0026#39;, C++\u0026#39;, \u0026#39;JavaScript\u0026#39;] languages.pop() temp = languages.pop(1) print(temp) # SQL languages.append(temp) print(languages) # [\u0026#39;Python\u0026#39;, C++\u0026#39;, \u0026#39;SQL\u0026#39;] languages.clear() print(languages) # [] åœ¨åˆ—è¡¨ä¸­ç”¨removeæ–¹æ³•ç§»é™¤å…ƒç´ çš„æ—¶å€™ï¼Œéœ€è¦åˆ¤æ–­å…ƒç´ åœ¨ä¸åœ¨é‡Œé¢ï¼Œå¦‚æœä¸åœ¨é‡Œé¢ç›´æ¥removeä¼šæŠ¥é”™ï¼šValueErroré”™è¯¯å¯¼è‡´ç¨‹åºå´©æºƒã€‚ä¸Šé¢ä½¿ç”¨popæ–¹æ³•ä¼šç§»é™¤æœ€åä¸€ä¸ªå…ƒç´ ï¼Œpopä¹Ÿå¯ä»¥æŒ‰ä½ç½®æŒ‡å®šç§»é™¤ï¼Œclearæ–¹æ³•æ˜¯æ¸…é™¤æ‰€æœ‰çš„å…ƒç´ ã€‚\n1 2 3 items = [\u0026#39;Python\u0026#39;, \u0026#39;Java\u0026#39;, \u0026#39;C++\u0026#39;] del items[1] print(items) # [\u0026#39;Python\u0026#39;, \u0026#39;C++\u0026#39;] é€šè¿‡delåˆ é™¤å…ƒç´ ï¼Œå®ƒæ˜¯ä¸è¿”å›å…ƒç´ ï¼Œæ€§èƒ½ä¸Šæ¯”ä¸Šé¢çš„popè¦å¥½ã€‚\nåˆ—è¡¨çš„ç´¢å¼•å’Œé¢‘æ¬¡ 1 2 3 4 5 6 7 8 9 items = [\u0026#39;Python\u0026#39;, \u0026#39;Java\u0026#39;, \u0026#39;Java\u0026#39;, \u0026#39;C++\u0026#39;, \u0026#39;Kotlin\u0026#39;, \u0026#39;Python\u0026#39;] print(items.index(\u0026#39;Python\u0026#39;)) # 0 # ä»ç´¢å¼•ä½ç½®1å¼€å§‹æŸ¥æ‰¾\u0026#39;Python\u0026#39; print(items.index(\u0026#39;Python\u0026#39;, 1)) # 5 print(items.count(\u0026#39;Python\u0026#39;)) # 2 print(items.count(\u0026#39;Kotlin\u0026#39;)) # 1 print(items.count(\u0026#39;Swfit\u0026#39;)) # 0 # ä»ç´¢å¼•ä½ç½®3å¼€å§‹æŸ¥æ‰¾\u0026#39;Java\u0026#39; print(items.index(\u0026#39;Java\u0026#39;, 3)) # ValueError: \u0026#39;Java\u0026#39; is not in list indexèƒ½æ‰¾åˆ°æŒ‡å®šå…ƒç´ çš„ç´¢å¼•ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å…ƒç´ ï¼Œç¬¬äºŒä¸ªå…ƒç´ æ˜¯ç¬¬å‡ ä¸ªã€‚countè·å–å…ƒç´ å‡ºç°çš„æ¬¡æ•°ã€‚\nåˆ—è¡¨çš„æ’åºå’Œç¿»è½¬ 1 2 3 4 5 items = [\u0026#39;Python\u0026#39;, \u0026#39;Java\u0026#39;, \u0026#39;C++\u0026#39;, \u0026#39;Kotlin\u0026#39;, \u0026#39;Swift\u0026#39;] items.sort() print(items) # [\u0026#39;C++\u0026#39;, \u0026#39;Java\u0026#39;, \u0026#39;Kotlin\u0026#39;, \u0026#39;Python\u0026#39;, \u0026#39;Swift\u0026#39;] items.reverse() print(items) # [\u0026#39;Swift\u0026#39;, \u0026#39;Python\u0026#39;, \u0026#39;Kotlin\u0026#39;, \u0026#39;Java\u0026#39;, \u0026#39;C++\u0026#39;] sortæŒ‰ç…§é¦–å­—æ¯è¿›è¡Œæ’åºï¼Œreverseè¿›è¡Œå‰åç¿»è½¬ã€‚\nåˆ—è¡¨çš„ç”Ÿæˆå¼ 1 2 items = [i for i in range(1, 100) if i % 3 == 0 or i % 5 == 0] print(items) é¦–å…ˆç”¨for-inæ¥å¾ªç¯1åˆ°99ï¼Œåé¢æ˜¯ifè¿‡æ»¤ï¼Œå¦‚æœæ˜¯3æˆ–è€…5çš„å€æ•°æ‰ä¼šæ˜¯å¾ªç¯è¦ç”¨çš„å…ƒç´ ï¼Œforå‰é¢æ˜¯ç”Ÿæˆå¼çš„è¿ç®—ï¼Œè¿™é‡Œç›´æ¥è¿”å›iï¼Œæœ€åç”Ÿæˆä¸€ä¸ªitemsçš„æ–°åˆ—è¡¨ã€‚\n1 2 3 nums1 = [35, 12, 97, 64, 55] nums2 = [num ** 2 for num in nums1] print(nums2) å¯¹åˆ—è¡¨ä¸­çš„å…ƒç´ æ±‚å¹³æ–¹æ“ä½œï¼Œç”Ÿæˆä¸€ä¸ªæ–°çš„åˆ—è¡¨ã€‚\nåˆ—è¡¨åµŒå¥— 1 2 3 scores = [[95, 83, 92], [80, 75, 82], [92, 97, 90], [80, 78, 69], [65, 66, 89]] print(scores[0]) # [95, 83, 92] print(scores[0][1]) # 83 è·Ÿjavaä¸­äºŒç»´æ•°ç»„æ²¡ä»€ä¹ˆåŒºåˆ«ã€‚\nåµŒå¥—åˆ—è¡¨æ·»åŠ  1 2 3 4 5 6 7 8 scores = [] for _ in range(5): temp = [] for _ in range(3): score = int(input(\u0026#39;è¯·è¾“å…¥: \u0026#39;)) temp.append(score) scores.append(temp) print(scores) å¤–å±‚æ˜¯ä¸€ä¸ªå¤§çš„åˆ—è¡¨ï¼Œå¤§çš„åˆ—è¡¨é‡Œé¢æœ‰5ä¸ªå°åˆ—è¡¨ï¼Œæ¯ä¸ªå°åˆ—è¡¨çš„å¤§å°æ˜¯3ã€‚\nåµŒå¥—åˆ—è¡¨ç”Ÿæˆå¼ 1 2 3 import random scores = [[random.randrange(60, 101) for _ in range(3)] for _ in range(5)] print(scores) ç¬¬ä¸€ä¸ªfor-inæŒ‡å®šæ¯ä¸ªå°åˆ—è¡¨çš„é•¿åº¦ï¼Œç¬¬äºŒä¸ªfor-inæŒ‡å®šäº†å¤–å±‚åˆ—è¡¨çš„é•¿åº¦ã€‚\nå…ƒç»„ å…ƒç»„çš„å®šä¹‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 # å®šä¹‰ä¸€ä¸ªä¸‰å…ƒç»„ t1 = (35, 12, 98) # å®šä¹‰ä¸€ä¸ªå››å…ƒç»„ t2 = (\u0026#39;å¼ ä¸‰\u0026#39;, 45, True, \u0026#39;å››å·æˆéƒ½\u0026#39;) # æŸ¥çœ‹å˜é‡çš„ç±»å‹ print(type(t1)) # \u0026lt;class \u0026#39;tuple\u0026#39;\u0026gt; print(type(t2)) # \u0026lt;class \u0026#39;tuple\u0026#39;\u0026gt; # æŸ¥çœ‹å…ƒç»„ä¸­å…ƒç´ çš„æ•°é‡ print(len(t1)) # 3 print(len(t2)) # 4 # ç´¢å¼•è¿ç®— print(t1[0]) # 35 print(t1[2]) # 98 print(t2[-1]) # å››å·æˆéƒ½ # åˆ‡ç‰‡è¿ç®— print(t2[:2]) # (\u0026#39;å¼ ä¸‰\u0026#39;, 43) print(t2[::3]) # (\u0026#39;å¼ ä¸‰\u0026#39;, \u0026#39;å››å·æˆéƒ½\u0026#39;) # å¾ªç¯éå†å…ƒç»„ä¸­çš„å…ƒç´  for elem in t1: print(elem) # æˆå‘˜è¿ç®— print(12 in t1) # True print(99 in t1) # False print(\u0026#39;Hao\u0026#39; not in t2) # True # æ‹¼æ¥è¿ç®— t3 = t1 + t2 print(t3) # (35, 12, 98, \u0026#39;å¼ ä¸‰\u0026#39;, 43, True, \u0026#39;å››å·æˆéƒ½\u0026#39;) # æ¯”è¾ƒè¿ç®— print(t1 == t3) # False print(t1 \u0026gt;= t3) # False print(t1 \u0026lt;= (35, 11, 99)) # False å…ƒç»„å®šä¹‰å¥½åï¼Œå°±ä¸èƒ½å†æ·»åŠ å…ƒç´ å’Œåˆ é™¤äº†ï¼Œä¹Ÿä¸èƒ½ä¿®æ”¹ã€‚\nç©ºå…ƒç»„å’Œå…ƒç»„å®šä¹‰ 1 2 3 4 5 6 7 8 9 10 a = () print(type(a)) # \u0026lt;class \u0026#39;tuple\u0026#39;\u0026gt; b = (\u0026#39;hello\u0026#39;) print(type(b)) # \u0026lt;class \u0026#39;str\u0026#39;\u0026gt; c = (100) print(type(c)) # \u0026lt;class \u0026#39;int\u0026#39;\u0026gt; d = (\u0026#39;hello\u0026#39;, ) print(type(d)) # \u0026lt;class \u0026#39;tuple\u0026#39;\u0026gt; e = (100, ) print(type(e)) # \u0026lt;class \u0026#39;tuple\u0026#39;\u0026gt; ä¸Šé¢aæ˜¯ç©ºå…ƒç»„ï¼Œè€Œbæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ç±»å‹ï¼Œcæ˜¯ä¸€ä¸ªintç±»å‹ï¼Œdæ‰æ˜¯å…ƒç¥–ç±»å‹ï¼Œeä¹Ÿæ˜¯ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœå…ƒç¥–ä¸­åªæœ‰ä¸€ä¸ªå…ƒç´ çš„æ—¶å€™ï¼Œåé¢éœ€è¦åŠ ä¸Šé€—å·ï¼Œå¦‚æœæ˜¯ç©ºçš„å°±ä¸éœ€è¦åŠ é€—å·ï¼Œå¦‚æœæ˜¯ä¸¤ä¸ªæˆ–ä»¥ä¸Šä¹Ÿä¸éœ€è¦é€—å·ã€‚\nå…ƒç»„çš„æ‰“åŒ…å’Œè§£åŒ… 1 2 3 4 5 6 7 # æ‰“åŒ…æ“ä½œ a = 1, 10, 100 print(type(a)) # \u0026lt;class \u0026#39;tuple\u0026#39;\u0026gt; print(a) # (1, 10, 100) # è§£åŒ…æ“ä½œ i, j, k = a print(i, j, k) # 1 10 100 æ‰“åŒ…æ“ä½œåªéœ€è¦ç”¨é€—å·åˆ†éš”ï¼Œè€Œè§£åŒ…åªéœ€è¦æŠŠå¯¹åº”çš„å˜é‡ç”¨é€—å·åˆ†éš”ä¼šè‡ªå®šèµ‹å€¼ã€‚\näº¤æ¢å˜é‡çš„å€¼ 1 2 3 4 a = 10 b = 20 a, b = b, a print(a, b) # 20 10 å…¶å®è¿™ä¸ªæ˜¯è¿ç”¨äº†å…ƒç¥–çš„æ‰“åŒ…å’Œè§£åŒ…ï¼Œé¦–å…ˆå°†b,aç»„æˆä¸€ä¸ªå…ƒç»„ï¼Œç„¶åä»˜ç»™å¦å¤–ä¸€ä¸ªå…ƒç»„ï¼Œç„¶åå…ƒç»„è¿›è¡Œè§£åŒ…ï¼Œç»™åˆ°aå’Œbï¼Œæ‰€ä»¥è¾¾åˆ°äº†äº’æ¢å€¼ã€‚\nå­—ç¬¦ä¸² è½¬ä¹‰å­—ç¬¦ä¸² å­—ç¬¦ä¸²ä¸­ä½¿ç”¨\\æ¥è¡¨ç¤ºè½¬ä¹‰ï¼Œè½¬ä¹‰çš„æ„æ€æ˜¯\\åé¢å­—ç¬¦ä¸å†æ˜¯åŸæ¥çš„æ„æ€ï¼Œä¾‹å¦‚\\nä¸æ˜¯ä»£è¡¨å­—ç¬¦\\å’Œå­—ç¬¦nï¼Œè€Œæ˜¯è¡¨ç¤ºæ¢è¡Œï¼›\\tä¹Ÿä¸æ˜¯ä»£è¡¨å­—ç¬¦\\å’Œå­—ç¬¦tï¼Œè€Œæ˜¯è¡¨ç¤ºåˆ¶è¡¨ç¬¦ã€‚è€Œå¦‚æœæƒ³è¡¨ç¤ºåŸå§‹å­—ç¬¦çš„è¯å‰é¢éœ€è¦å†åŠ ä¸€ä¸ª\\å­—ç¬¦: 1 2 3 4 5 s1 = \u0026#39;\\\u0026#39;hello, world!\\\u0026#39;\u0026#39; # \u0026#39;hello, world!\u0026#39; s2 = \u0026#39;\\\\hello, world!\\\\\u0026#39; # \\hello, world!\\ s3 = \u0026#39;hello\\nworld!\u0026#39; # helloæ¢è¡Œworld! s5 = \u0026#39;hello\\\\nworld!\u0026#39; # hello\\nworld! s4 = \u0026#39;hello\\tworld!\u0026#39; # hello\tworld! åŸå§‹å­—ç¬¦ä¸² åœ¨ä¸Šé¢é»˜è®¤éƒ½æ˜¯\\nè¡¨ç¤ºæ¢è¡Œï¼Œå¦‚æœä¸æƒ³æ¢è¡Œéœ€è¦ä½¿ç”¨\\\\næ¥è¡¨ç¤ºä¸è½¬ä¹‰ã€‚è€Œå¦‚æœåœ¨å­—ç¬¦ä¸²å‰é¢åŠ ä¸Šrçš„è¯ï¼Œå°±è¡¨ç¤ºåŸå§‹å­—ç¬¦ä¸²ï¼Œä¹Ÿå°±æ˜¯è¯´\\nä¸å†è¡¨ç¤ºæ¢è¡Œï¼Œè€Œæ˜¯è¡¨ç¤º\\å­—ç¬¦å’Œnå­—ç¬¦ï¼š 1 s3 = r\u0026#39;hello\\nworld!\u0026#39; # hello\\nworld! å­—ç¬¦çš„ç‰¹æ®Šè¡¨ç¤º åœ¨\\å­—ç¬¦åé¢å¯ä»¥è·Ÿä¸€ä¸ªå…«è¿›åˆ¶çš„æ•°æˆ–è€…æ˜¯åå…­è¿›åˆ¶æ•°æ¥è¡¨ç¤ºå­—ç¬¦ï¼Œæ¯”å¦‚å­—ç¬¦açš„ASCII ç å€¼åè¿›åˆ¶å¯¹åº”çš„æ˜¯97ã€‚é‚£ä¹ˆå¯ä»¥ç”¨\\141æ¥è¡¨ç¤ºaï¼Œ141è¡¨ç¤º97çš„å…«è¿›åˆ¶æ•°ã€‚è€Œ\\x61ä¹Ÿå¯ä»¥è¡¨ç¤ºaï¼Œ61è¡¨ç¤º97çš„åå…­è¿›åˆ¶æ•°ã€‚ 1 s1 = \u0026#39;\\141\\142\\143\\x61\\x62\\x63\u0026#39; # abcabc å¦å¤–ä¸€ç§æ˜¯åœ¨uåé¢è·Ÿ Unicode å­—ç¬¦ç¼–ç ,ä¾‹å¦‚\\u5f20\\u4e09ä»£è¡¨ä¸­æ–‡\u0026quot;å¼ ä¸‰\u0026quot;ï¼š\n1 s2 = \u0026#39;\\u5f20\\u4e09\u0026#39; # å¼ ä¸‰ å…³äºå­—ç¬¦çš„éå†ï¼Œç´¢å¼•ï¼Œé•¿åº¦ï¼Œåˆ‡ç‰‡ç­‰å’Œåˆ—è¡¨ç±»ä¼¼ã€‚\né›†åˆ pythonä¸­çš„é›†åˆå’Œjavaä¸­çš„é›†åˆä¸å¤ªä¸€æ ·ï¼Œpythonä¸­é›†åˆå¯¹åº”äº†javaä¸­setå®¹å™¨ã€‚ä¹Ÿæ˜¯æ— åºï¼Œä¸é‡å¤ã€‚\né›†åˆçš„å®šä¹‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 set1 = {1, 2, 3, 3, 3, 2} print(set1) set2 = {\u0026#39;banana\u0026#39;, \u0026#39;pitaya\u0026#39;, \u0026#39;apple\u0026#39;, \u0026#39;apple\u0026#39;, \u0026#39;banana\u0026#39;, \u0026#39;grape\u0026#39;} print(set2) set3 = set(\u0026#39;hello\u0026#39;) print(set3) set4 = set([1, 2, 2, 3, 3, 3, 2, 1]) # {1, 2, 3} print(set4) set5 = {num for num in range(1, 20) if num % 3 == 0 or num % 7 == 0} print(set5) ä¸Šé¢é€šè¿‡{}åˆå§‹åŒ–ä¸€ä¸ªé›†åˆï¼Œä¹Ÿå¯ä»¥é€šè¿‡set()æ¥åˆå§‹åŒ–ä¸€ä¸ªé›†åˆã€‚set4é›†åˆä¼ å…¥çš„æ˜¯ä¸€ä¸ªåˆ—è¡¨ï¼Œç”±äºæ˜¯ä¸èƒ½é‡å¤ï¼Œæ‰€ä»¥åªæœ‰1,2,3è¿™ä¸‰ä¸ªæ•°å­—ã€‚set5æ˜¯é€šè¿‡ç”Ÿæˆå¼æ¥åˆå§‹åŒ–ä¸€ä¸ªé›†åˆã€‚ç„¶åé›†åˆçš„æ·»åŠ ï¼ŒæŸ¥è¯¢ç­‰åŠŸèƒ½å’Œåˆ—è¡¨ç±»ä¼¼ã€‚\nå­—å…¸ å­—å…¸çš„åˆå§‹åŒ– 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 person = {\u0026#34;name\u0026#34;:\u0026#34;å¼ ä¸‰\u0026#34;, \u0026#34;age\u0026#34;:18} print(type(person)) # \u0026lt;class \u0026#39;dict\u0026#39;\u0026gt; print(\u0026#34;name\u0026#34; in person) # True print(person[\u0026#34;name1\u0026#34;]) # KeyError person[\u0026#34;score\u0026#34;] = 100 for item in person: print(item) student = dict() student[\u0026#39;name\u0026#39;] = \u0026#34;å°æ˜\u0026#34; for e in student: print(f\u0026#34;key = {e}; value = {student[e]}\u0026#34;) student1 ={} student1[\u0026#39;name\u0026#39;] = \u0026#34;å°ç‹\u0026#34; for e in student1: print(f\u0026#34;key1 = {e}; value1 = {student1[e]}\u0026#34;) å­—å…¸æ˜¯é€šè¿‡keyå’Œvalueç»„æˆï¼Œè·Ÿjavaçš„hashMapç±»ä¼¼ã€‚é€šè¿‡inåˆ¤æ–­keyåœ¨ä¸åœ¨å­—å…¸ä¸­ï¼Œå¦‚æœkeyä¸åœ¨å­—å…¸ä¸­ï¼Œç›´æ¥å»æ‹¿å€¼çš„æ—¶å€™ï¼Œä¼šæŠ¥KeyErrorçš„å¼‚å¸¸ã€‚ç»™æ–°çš„keyæ·»åŠ å…ƒç´ ã€‚for inéå†çš„æ—¶å€™ï¼Œå–çš„æ˜¯å­—å…¸çš„keyï¼Œå¦‚æœè¦åœ¨for-iné‡Œé¢å–valyeçš„è¯éœ€è¦é€šè¿‡keyæ¥å–valueå€¼ã€‚ä¸Šé¢å¯ä»¥é€šè¿‡dict()æ¥åˆå§‹åŒ–ä¸€ä¸ªå­—å…¸ï¼Œä¹Ÿå¯ä»¥é€šè¿‡{}æ¥åˆå§‹åŒ–ä¸€ä¸ªå­—å…¸ã€‚\nå­—å…¸çš„æ–¹æ³• 1 2 print(person.get(\u0026#34;name1\u0026#34;)) # None print(person.get(\u0026#34;name1\u0026#34;,\u0026#34;ç‹äºŒ\u0026#34;)) # ç‹äºŒ getæ–¹æ³•å¦‚æœè·å–ä¸åˆ°å¯¹åº”çš„å€¼ä¸ä¼šæŠ¥é”™,ä¼šè¿”å›None,å¹¶ä¸”ç¬¬äºŒä¸ªå‚æ•°å¯ä»¥æŒ‡å®šæ²¡æœ‰å€¼çš„æ—¶å€™ï¼Œè¿”å›é»˜è®¤å€¼ã€‚\n1 2 3 4 5 6 7 print(person.keys()) # dict_keys([\u0026#39;name\u0026#39;, \u0026#39;age\u0026#39;, \u0026#39;score\u0026#39;]) print(person.values()) # dict_values([\u0026#39;å¼ ä¸‰\u0026#39;, 18, 100]) print(person.items()) # dict_items([(\u0026#39;name\u0026#39;, \u0026#39;å¼ ä¸‰\u0026#39;), (\u0026#39;age\u0026#39;, 18), (\u0026#39;score\u0026#39;, 100)]) for item in person.items(): print(item) # (\u0026#39;name\u0026#39;, \u0026#39;å¼ ä¸‰\u0026#39;) (\u0026#39;age\u0026#39;, 18) (\u0026#39;score\u0026#39;, 100) for k,v in person.items(): print(item) # (\u0026#39;name\u0026#39;, \u0026#39;å¼ ä¸‰\u0026#39;) (\u0026#39;age\u0026#39;, 18) (\u0026#39;score\u0026#39;, 100) keys()æ–¹æ³•è·å–æ‰€æœ‰çš„keyï¼Œvalues()è·å–æ‰€æœ‰çš„valueï¼Œitems()æ–¹æ³•èƒ½æ‹¿åˆ°æ‰€æœ‰çš„å…ƒç´ ï¼Œè¿”å›çš„å…ƒç´ æ˜¯ä¸€ä¸ªå…ƒç»„ï¼Œéœ€è¦è‡ªå·±è§£åŒ…åˆ°å¯¹åº”çš„å€¼ä¸Šã€‚\nå‡½æ•° ä¸å®šå‚æ•° 1 2 3 4 5 6 7 8 9 10 def add(*args): print(type(args)) # \u0026lt;class \u0026#39;tuple\u0026#39;\u0026gt; total = 0 # å¯¹ä¿å­˜å¯å˜å‚æ•°çš„å…ƒç»„è¿›è¡Œå¾ªç¯éå† for val in args: # å¯¹å‚æ•°è¿›è¡Œäº†ç±»å‹æ£€æŸ¥ï¼ˆæ•°å€¼å‹çš„æ‰èƒ½æ±‚å’Œï¼‰ if type(val) in (int, float): total += val return total print(add(1, 2, 3,\u0026#34;hello\u0026#34;,4)) # 10 ä¸Šé¢é€šè¿‡*argså®šä¹‰ä¸å®šå‚æ•°ï¼Œå¯ä»¥ä¼ å…¥ä»»ä½•ç±»å‹ï¼Œå¦‚æœæ˜¯intæˆ–è€…æ˜¯floatæ‰ç´¯åŠ ã€‚argså‚æ•°æ˜¯ä¸€ä¸ªå…ƒç»„ç±»å‹ã€‚\n1 2 3 4 5 def foo(*args, **kwargs): print(args) # (3, 2.1, True) print(kwargs) # {\u0026#39;name\u0026#39;: \u0026#39;å¼ ä¸‰\u0026#39;, \u0026#39;age\u0026#39;: 43, \u0026#39;gpa\u0026#39;: 4.95} print(type(kwargs)) # \u0026lt;class \u0026#39;dict\u0026#39;\u0026gt; foo(3, 2.1, True, name=\u0026#39;å¼ ä¸‰\u0026#39;, age=43, gpa=4.95) ä¸Šé¢**kwargsæ˜¯ä¸€ä¸ªå­—å…¸ç±»å‹ï¼Œä¹Ÿæ˜¯ä¸€ç§ä¸å®šå‚æ•°çš„ç±»å‹å†™æ³•ã€‚\nå‡½æ•°é«˜çº§ç”¨æ³• 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 def calc(init_value, op_func, *args, **kwargs): items = list(args) + list(kwargs.values()) result = init_value for item in items: if type(item) in (int, float): result = op_func(result, item) return result def add(x, y): return x + y def mul(x, y): return x * y print(calc(0, add, 1, 2, 3, 4, 5)) # 15 print(calc(1, mul, 1, 2, 3, 4, 5)) # 120 ä¸Šé¢çš„calcæ–¹æ³•åœ¨ä¸Šé¢çš„ä¸å®šå‚æ•°ä¸­å¢åŠ äº†init_valueå’Œop_funcå‚æ•°ï¼Œå…¶ä¸­init_valueæ˜¯åˆå§‹å€¼ï¼Œop_funcæ˜¯ä¼ å…¥çš„å‡½æ•°ï¼Œé€šè¿‡å¤–ç•Œä¼ å…¥å‡½æ•°æ¥è¿›è¡Œè¿ç®—ï¼Œæœ‰ç‚¹åƒkotlinçš„é«˜é˜¶å‡½æ•°ã€‚æ¯”å¦‚ä¸‹é¢ä¼ å…¥addæ–¹æ³•çš„æ—¶å€™ï¼Œæ˜¯å¯¹å‚æ•°æ±‚å’Œï¼Œä¼ å…¥mulå‡½æ•°çš„æ—¶å€™æ˜¯å¯¹å‚æ•°æ±‚ä¹˜ç§¯ã€‚ ä¹Ÿå¯ä»¥ä¼ å…¥operatoræ¨¡å—ä¸­å®šä¹‰çš„å‡½æ•°ï¼š\n1 2 3 import operator print(calc(0, operator.add, 1, 2, 3, 4, 5)) # 15 print(calc(1, operator.mul, 1, 2, 3, 4, 5)) # 120 å†…ç½®çš„é«˜é˜¶å‡½æ•° 1 2 3 4 5 6 7 8 9 10 11 def is_even(num): \u0026#34;\u0026#34;\u0026#34;åˆ¤æ–­numæ˜¯ä¸æ˜¯å¶æ•°\u0026#34;\u0026#34;\u0026#34; return num % 2 == 0 def square(num): \u0026#34;\u0026#34;\u0026#34;æ±‚å¹³æ–¹\u0026#34;\u0026#34;\u0026#34; return num ** 2 old_nums = [35, 12, 8, 99, 60, 52] new_nums = list(map(square, filter(is_even, old_nums))) print(new_nums) # [144, 64, 3600, 2704] ä¸Šé¢çš„filterå’Œmapéƒ½æ˜¯é«˜é˜¶å‡½æ•°ï¼Œå®ƒä»¬çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯è¦ä¼ å…¥çš„æ–¹æ³•ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯æ•°æ®æºã€‚filterå…ˆè¿‡æ»¤å‡ºåˆ—è¡¨çš„å¶æ•°ï¼Œç„¶åmapè¿›è¡Œå¹³æ–¹æ“ä½œã€‚æœ€åè¿”å›ä¸€ä¸ªåˆ—è¡¨ã€‚\n1 2 3 old_strings = [\u0026#39;in\u0026#39;, \u0026#39;apple\u0026#39;, \u0026#39;zoo\u0026#39;, \u0026#39;waxberry\u0026#39;, \u0026#39;pear\u0026#39;] new_strings = sorted(old_strings, key=len) print(new_strings) # [\u0026#39;in\u0026#39;, \u0026#39;zoo\u0026#39;, \u0026#39;pear\u0026#39;, \u0026#39;apple\u0026#39;, \u0026#39;waxberry\u0026#39;] å‰é¢è®²è¿‡listçš„sort()æ–¹æ³•ï¼Œ æ­¤å¤„çš„sortedæ–¹æ³•ä¹Ÿæ˜¯ç±»ä¼¼ï¼Œæ­¤å¤„å¯ä»¥ä¼ å…¥keyï¼Œå®ƒä¹Ÿæ˜¯ä¸€ä¸ªæ–¹æ³•ï¼Œæ­¤å¤„é€šè¿‡å­—ç¬¦ä¸²çš„é•¿åº¦è¿›è¡Œæ’åºã€‚\nLambdaå‡½æ•° 1 2 3 old_nums = [35, 12, 8, 99, 60, 52] new_nums = list(map(lambda x: x ** 2, filter(lambda x: x % 2 == 0, old_nums))) print(new_nums) # [144, 64, 3600, 2704] filterä¸­ä¼ å…¥lambda x: x % 2 == 0ï¼Œå®ƒå°±æ˜¯ä¸€ä¸ªLambdaå‡½æ•°ï¼Œxè¡¨ç¤ºè¾“å…¥ï¼Œå†’å·åé¢æ˜¯è¿ç®—æ“ä½œï¼Œæœ€åä¸€æ¡è¯­å¥æ˜¯lambdaçš„è¿”å›å€¼ï¼Œç”¨æ¥åˆ¤æ–­æ˜¯ä¸æ˜¯å¶æ•°ï¼Œmapä¸­ä¼ å…¥lambda x: x ** 2ï¼Œå®ƒä¹Ÿæ˜¯ä¸€ä¸ªLambdaå‡½æ•°ï¼Œç”¨æ¥æ±‚å¹³æ–¹ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 import functools import operator # ç”¨ä¸€è¡Œä»£ç å®ç°è®¡ç®—é˜¶ä¹˜çš„å‡½æ•° fac = lambda n: functools.reduce(operator.mul, range(2, n + 1), 1) # ç”¨ä¸€è¡Œä»£ç å®ç°åˆ¤æ–­ç´ æ•°çš„å‡½æ•° is_prime = lambda x: all(map(lambda f: x % f, range(2, int(x ** 0.5) + 1))) # è°ƒç”¨Lambdaå‡½æ•° print(fac(6)) # 720 print(is_prime(37)) # True é¦–å…ˆreduceå‡½æ•°æ˜¯pythonæ ‡å‡†åº“functoolsæ¨¡å—ä¸­çš„å‡½æ•°ï¼Œå¯ä»¥å®ç°å¯¹ä¸€ç»„æ•°æ®çš„è§„çº¦æ“ä½œï¼Œç±»ä¼¼ä¸Šé¢è®²çš„calcå‡½æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯è¿ç®—çš„å‡½æ•°ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯è¿ç®—çš„æ•°æ®ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯åˆå§‹å€¼ã€‚ç¬¬äºŒä¸ªåˆ¤æ–­ç´ æ•°æ˜¯é¦–å…ˆé€šè¿‡mapä¼ å…¥lambdaè®¡ç®—x%fæ˜¯å¦ä¸èƒ½æ•´é™¤ï¼Œfçš„æ˜¯lambdaçš„è¾“å…¥ï¼Œè¾“å…¥\n","date":"2025-10-30T00:00:00Z","permalink":"http://xiangcman.xyz/p/python%E5%B8%B8%E8%A7%81%E8%AF%AD%E6%B3%95%E4%B8%80/","title":"Pythonå¸¸è§è¯­æ³•ä¸€"},{"content":"è°ˆåˆ°Androidä¸­çš„anrç›‘æ§ï¼Œä¸€èˆ¬æ¯”è¾ƒå¯é æ˜¯é€šè¿‡ç›‘å¬ç³»ç»Ÿç»™è¿›ç¨‹å‘é€çš„SIGQUITä¿¡å·ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨sigactionå‡½æ•°å¢åŠ SIGQUITä¿¡å·çš„æ•è·ï¼Œç„¶ååœ¨ä¿¡å·å¤„ç†å‡½æ•°ä¸­åˆ¤æ–­SIGQUITåšç›¸åº”çš„å¤„ç†ï¼Œç›‘å¬ä¿¡å·å¦‚ä¸‹ä»£ç ï¼š\n1 sigaction(SIGQUIT, \u0026amp;sa, \u0026amp;old_sa[SIGILL]); è¯¥æ–¹æ³•åœ¨signal.hä¸­çš„æ–¹æ³•ï¼Œæ–¹æ³•å®šä¹‰å¦‚ä¸‹ï¼š\n1 int sigaction(int __signal, const struct sigaction* __new_action, struct sigaction* __old_action); ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¿¡å·ç±»å‹ï¼Œå› æ­¤ANRæ˜¯ç›‘å¬SIGQUITä¿¡å·ï¼Œæ‰€ä»¥æ­¤å¤„ç›´æ¥ç»™è¯¥ä¿¡å·ã€‚ ç¬¬äºŒä¸ªå‚æ•°æ˜¯æ–°å®‰è£…çš„ä¿¡å·å¤„ç†è¡Œä¸ºï¼ˆå³å‘Šè¯‰ç³»ç»Ÿä»¥åè¿™ä¸ªä¿¡å·æ€ä¹ˆå¤„ç†ï¼‰ã€‚ ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ç”¨æ¥ä¿å­˜åŸæ¥çš„ä¿¡å·å¤„ç†è¡Œä¸ºï¼ˆå¯é€‰ï¼Œå¦‚æœä½ æƒ³ä¹‹åæ¢å¤çš„è¯ï¼‰ã€‚ è¿™é‡Œç€é‡çœ‹ä¸‹sigactionè¢«structä¿®é¥°çš„ç»“æ„ä½“çš„å®šä¹‰ï¼š 1 2 3 4 5 6 7 8 9 10 #define __SIGACTION_BODY \\ int sa_flags; \\ union { \\ sighandler_t sa_handler; \\ void (*sa_sigaction)(int, struct siginfo*, void*); \\ }; \\ sigset_t sa_mask; \\ void (*sa_restorer)(void); \\ struct sigaction { __SIGACTION_BODY }; sa_flags:è¡Œä¸ºæ§åˆ¶çš„æ ‡å¿—ï¼Œæ¯”å¦‚SA_RESTARTã€SA_SIGINFOç­‰ã€‚ SA_RESTARTï¼šè¢«ä¿¡å·ä¸­æ–­çš„ç³»ç»Ÿè°ƒç”¨è‡ªåŠ¨é‡å¯ã€‚ SA_SIGINFOï¼šä½¿ç”¨sa_sigactionæ›¿ä»£sa_handlerã€‚ SA_ONSTACKï¼šä½¿ç”¨å¤‡ç”¨ä¿¡å·æ ˆã€‚SA_NODEFERï¼šä¸å±è”½å½“å‰ä¿¡å·ã€‚ sa_handlerï¼šä¿¡å·å¤„ç†å‡½æ•° sa_sigactionï¼šå¸¦ä¸Šä¸‹æ–‡çš„é«˜çº§å¤„ç†å‡½æ•°ï¼ˆä¸SA_SIGINFOé…åˆä½¿ç”¨ï¼‰ sa_maskï¼šå½“å¤„ç†ä¿¡å·æ—¶ï¼Œä¸´æ—¶å±è”½å“ªäº›ä¿¡å· å¦‚æœåªæ˜¯æŒ‰ç…§ä¸Šé¢çš„sigactionå‡½æ•°ç›‘å¬SIGQUITä¿¡å·çš„æ—¶å€™ï¼Œä¼šå‘ç°å¤„ç†å‡½æ•°æ˜¯æ•è·ä¸åˆ°SIGQUITä¿¡å·ï¼Œé‚£æ˜¯å› ä¸ºç³»ç»Ÿå±è”½äº†SIGQUITä¿¡å·ï¼Œä¸å…è®¸sigactionæ¥å—SIGQUITä¿¡å·ã€‚\nç¨‹åºå¯åŠ¨çš„æ—¶å€™ä¼šå¯åŠ¨ä¸€ä¸ªSignalCatcherçº¿ç¨‹ï¼Œè¯¥çº¿ç¨‹ä¼šé€šè¿‡sigwaitå‡½æ•°é˜»å¡ç›‘å¬SIGQUITä¿¡å·ã€‚sigwaitå‡½æ•°ä¹Ÿæ˜¯ç›‘å¬ä¿¡å·çš„å‡½æ•°ï¼Œç›¸æ¯”äºsigactionå‡½æ•°ï¼Œå®ƒæ˜¯åŒæ­¥æ¥æ”¶çš„æ–¹å¼ï¼Œä¹Ÿå°±æ˜¯åªå…è®¸ä¸€ä¸ªåœ°æ–¹ç›‘å¬æŒ‡å®šçš„ä¿¡å·ï¼Œè€Œsigactionå‡½æ•°æ˜¯å¼‚æ­¥çš„ï¼Œå¯ä»¥åœ¨å¤šä¸ªåœ°æ–¹éƒ½ç›‘å¬ä¹‹å¿ƒä¿¡å·å¹¶è¿›è¡Œå¤„ç†ã€‚ è™½ç„¶ç³»ç»Ÿå±è”½äº† sigaction å¼‚æ­¥æ¥æ”¶ SIGQUIT ä¿¡å·çš„æ–¹å¼ï¼Œä½†æ˜¯æ²¡æ³•å±è”½é€šè¿‡ sigwait åŒæ­¥ç›‘å¬ SIGQUIT ä¿¡å· ï¼Œè¿™æ ·ä¹Ÿä¿éšœäº† SignalCatcher çº¿ç¨‹æ¥æ”¶åˆ° SIGQUIT ä¿¡å·åï¼Œèƒ½å¤Ÿæ­£å¸¸çš„è·å–è¿›ç¨‹ä¸­çš„å„ä¸ªçº¿ç¨‹çš„ä¿¡æ¯ï¼Œå¹¶è¾“å‡ºåˆ° /data/anr/traces.txt æ–‡ä»¶ä¸­ã€‚\nè™½ç„¶ SIGQUIT ä¿¡å·è¢«ç³»ç»Ÿå±è”½äº†ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ pthread_sigmask å‡½æ•°å°† SIGQUIT ä¿¡å·ä»å½“å‰çº¿ç¨‹çš„ä¿¡å·å±è”½é›†ä¸­ç§»é™¤ï¼Œå®ç°å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 sigset_t new_set; // åˆå§‹åŒ–æ¸…ç©ºä¿¡å·é›† sigemptyset(\u0026amp;new_set); // å°† SIGQUIT ä¿¡å·æ·»åŠ åˆ°ä¿¡å·é›† sigaddset(\u0026amp;new_set, SIGQUIT); // å°†å½“å‰çº¿ç¨‹çš„ä¿¡å·å±è”½é›†è®¾ç½®ä¸ºä¿¡å·é›†çš„è¡¥é›†ï¼Œå³è§£é™¤ SIGQUIT ä¿¡å·çš„å±è”½ pthread_sigmask(SIG_UNBLOCK, \u0026amp;new_set, \u0026amp;old_set); è§£é™¤å¯¹SIGQUITä¿¡å·çš„å±è”½åï¼Œä¸‹é¢å°±èƒ½æ•è·åˆ°SIGQUITä¿¡å·äº†ï¼Œç„¶åæˆ‘ä»¬åœ¨ä¿¡å·çš„å¤„ç†å‡½æ•°ä¸­åˆ¤æ–­æ˜¯SIGQUITä¿¡å·æ¥å¯¹ANRçš„å¤„ç†ï¼Œå¹¶æ•è·ANRçš„traceæ•°æ®ï¼Œè¿˜éœ€è¦ä¿è¯åŸæ¥çš„SignalCatcherçº¿ç¨‹èƒ½å“åº”SIGQUITä¿¡å·çš„ï¼Œè¿™é‡Œæˆ‘ä»¬æƒ³ä¸‹ï¼Œæ—¢ç„¶ä¸Šé¢è§£é™¤äº†å½“å‰çº¿ç¨‹æ¥æ”¶åˆ°SIGQUITä¿¡å·åï¼Œé‚£ä¹ˆå½“å‰çº¿ç¨‹ä¼šæ‹¦æˆªæ‰äº†SIGQUITä¿¡å·ï¼Œé‚£ä¹ˆSignalCatcherçº¿ç¨‹å°±æ¥æ”¶ä¸åˆ°SIGQUITä¿¡å·äº†ï¼Œæ‰€ä»¥éœ€è¦ç»™SignalCatcherè¡¥å‘ä¸€æ¬¡SIGQUITä¿¡å·ï¼Œå› ä¸ºSignalCatcherçº¿ç¨‹çš„ä¸»è¦èŒè´£å¦‚ä¸‹ï¼š\næ³¨å†Œ SIGQUIT çš„ handlerï¼› å½“ç³»ç»Ÿï¼ˆå¦‚ system_serverï¼‰å‘ app è¿›ç¨‹å‘é€ SIGQUIT æ—¶ï¼Œè´Ÿè´£ dump æ‰€æœ‰çº¿ç¨‹çš„å †æ ˆï¼› è¾“å‡º trace åˆ° /data/anr/traces.txtã€‚ ç”±äºSignalCatcher çº¿ç¨‹ä¸æ˜¯é€šè¿‡ sigaction æ¥å“åº” SIGQUIT ä¿¡å·çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ç›´æ¥æ‰§è¡Œ old_sa æ˜¯æ²¡æ³•ç”Ÿæ•ˆçš„ï¼Œæ­¤æ—¶å¯ä»¥é€šè¿‡ tgkill ä¿¡å·å‘ç”Ÿå‡½æ•° tgkillï¼Œå¾€ SignalCatcher çº¿ç¨‹å‘ç”Ÿä¸€ä¸ª SIGQUIT ä¿¡å·ï¼Œtgkill å‡½æ•°å¾€æŒ‡å®šçº¿ç¨‹å‘é€ä¿¡å·æ—¶éœ€è¦çŸ¥é“çº¿ç¨‹çš„ idï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦é€šè¿‡éå† /proc/{pid}/task ç›®å½•ä¸‹æ‰€è®°å½•çš„è¯¥è¿›ç¨‹ä¸‹æ‰€æœ‰çš„çº¿ç¨‹æ•°æ®ï¼Œæ‹¿åˆ°åç§°ä¸º â€œSignalCatcherâ€ çº¿ç¨‹å¯¹åº”çš„çº¿ç¨‹ idã€‚ä»£ç å®ç°å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 int getSignalCatcherThreadId() { std::string proc_path = \u0026#34;/proc/\u0026#34; + std::to_string(getpid()) + \u0026#34;/task\u0026#34;; DIR *dir = opendir(proc_path.c_str()); if (dir == nullptr) return -1; struct dirent *entry; while ((entry = readdir(dir)) != nullptr) { std::string name = entry-\u0026gt;d_name; if (std::all_of(name.begin(), name.end(), ::isdigit)) { std::string status_path = proc_path + \u0026#34;/\u0026#34; + name + \u0026#34;/status\u0026#34;; std::ifstream status_file(status_path); if (!status_file.is_open()) continue; std::string line; while (std::getline(status_file, line)) { if (line.find(\u0026#34;Name:\\tSignalCatcher\u0026#34;) != std::string::npos) { int tid = std::stoi(name); closedir(dir); return tid; } } } } closedir(dir); return -1; } int tid = getSignalCatcherThreadId(); if (tid != -1) { tgkill(getpid(), tid, SIGQUIT); // è½¬å‘ç»™ SignalCatcher çº¿ç¨‹ } ä¸Šé¢å°±å®Œæˆäº†å½“å‰çº¿ç¨‹ç›‘å¬SIGQUITä¿¡å·ï¼Œè™½ç„¶å®Œæˆäº†SIGQUITä¿¡å·çš„ç›‘å¬ï¼Œä½†æ˜¯ä¸èƒ½ä¿è¯æ˜¯å½“å‰è¿›ç¨‹å‡ºç°äº†ANR,å› ä¸ºæœ‰å¯èƒ½å…¶ä»–åº”ç”¨å‘ç”ŸANRæ—¶ï¼Œcpuä½¿ç”¨ç‡å ç”¨æ¯”è¾ƒé«˜çš„è¿›ç¨‹ä¹Ÿä¼šæ”¶åˆ°SIGQUITä¿¡å·ã€‚å…¶ä»–è¿›ç¨‹æˆ–è€…çº¿ç¨‹ä¹Ÿå¯ä»¥æ‰‹åŠ¨è°ƒç”¨tgkillå‡½æ•°å‘é€SIGQUITä¿¡å·ç»™å½“å‰è¿›ç¨‹ï¼Œå› æ­¤æˆ‘ä»¬è¿˜éœ€è¦äºŒæ¬¡ç¡®è®¤å½“å‰è¿›ç¨‹å‘ç”Ÿäº†ANR,äºŒæ¬¡ç¡®è®¤çš„æ–¹æ¡ˆä¸€èˆ¬æœ‰ä¸‹é¢ä¸¤ç§ï¼š\nå½“è¿›ç¨‹å‘ç”ŸANRçš„æ—¶å€™ï¼Œåœ¨ActivityManagerServiceé€šçŸ¥è¿›ç¨‹å¯åŠ¨ANRå¼¹æ¡†å‰ï¼Œä¼šç»™å‘ç”Ÿäº†ANRçš„è¿›ç¨‹è®¾ç½®ä¸€ä¸ªNOT_RESPONDINGçš„æ ‡å¿—ä½ï¼Œè¡¨ç¤ºè¯¥è¿›ç¨‹å‘ç”Ÿäº†ANRï¼Œè€Œè¿™ä¸ªæ ‡å¿—ä½å¯ä»¥é€šè¿‡ActivityManagerçš„getProcessesInErrorStateæ–¹æ³•æ¥è·å–ï¼Œæ€è·¯å°±æ˜¯åœ¨ä¸Šé¢ç›‘å¬åˆ°SIGQUITä¿¡å·åï¼Œé€šè¿‡jniæ–¹æ³•å›è°ƒåˆ°javaå±‚ï¼Œç„¶ååœ¨javaå±‚åˆ¤æ–­è¿™ä¸ªæ ‡å¿—ä½åˆ¤æ–­æ˜¯ä¸æ˜¯å½“å‰è¿›ç¨‹å‘ç”Ÿäº†ANR,æ¥è¿›è¡ŒäºŒæ¬¡ç¡®è®¤ã€‚ æˆ‘ä»¬éƒ½çŸ¥é“ä¸»çº¿ç¨‹ä¸­æ¶ˆæ¯é˜Ÿåˆ—çš„æ¶ˆæ¯æ˜¯æŒ‰ç…§æ—¶é—´å…ˆåçš„é¡ºåºè¿›è¡Œæ’åˆ—ï¼Œæ¯æ¬¡éƒ½ä¼šå–é˜Ÿåˆ—çš„æœ€å¼€å§‹çš„æ¶ˆæ¯ï¼Œæ¯ä¸ªæ¶ˆæ¯æ˜¯é€šè¿‡å˜é‡whenæ”¾åˆ°é˜Ÿåˆ—çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åˆ¤æ–­æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„å¼€å§‹æ¶ˆæ¯whenå’Œå½“å‰æ—¶é—´å¯¹æ¯”ï¼Œå¦‚æœè¶…è¿‡æˆ‘ä»¬è®¾ç½®çš„é˜ˆå€¼ï¼Œå°±è®¤ä¸ºå‘ç”Ÿäº†anrã€‚ å…³äºä¸Šé¢ä¸¤ç§æ–¹æ¡ˆå„æœ‰åˆ©å¼Šï¼Œç¬¬ä¸€ç§æ–¹æ¡ˆä¼šå­˜åœ¨æ¼æ‰ï¼Œå› ä¸ºå­˜åœ¨ä¸€äº›åå°çš„ANRä¸ä¼šé€šè¿‡ActivityManagerServiceç»™è¿›ç¨‹è®¾ç½®ä¸€ä¸ªNOT_RESPONDINGçš„æ ‡å¿—ä½ï¼Œå› ä¸ºåå°çš„ANRä¼šç›´æ¥æ€æ­»è¿›ç¨‹ï¼Œæ­¤æ—¶éƒ½æ²¡æœºä¼šæ•æ‰è¯¥æ ‡å¿—ä½äº†ã€‚è¿˜æœ‰ç§æƒ…å†µæ˜¯é—ªé€€ANRï¼Œç›¸å½“ä¸€éƒ¨åˆ†æœºå‹ï¼ˆä¾‹å¦‚OPPOã€VIVOä¸¤å®¶çš„é«˜Androidç‰ˆæœ¬çš„æœºå‹ï¼‰ä¿®æ”¹äº†ANRçš„æµç¨‹ï¼Œå³ä½¿æ˜¯å‘ç”Ÿåœ¨å‰å°çš„ANR,ä¹Ÿä¸ä¼šå¼¹æ¡†ï¼Œè€Œæ˜¯ç›´æ¥æ€æ­»è¿›ç¨‹ï¼Œä¹Ÿå°±æ˜¯é—ªé€€ã€‚è¿™éƒ¨åˆ†çš„æœºå‹è¦†ç›–çš„ç”¨æˆ·é‡ä¹Ÿéå¸¸å¤§ã€‚å¹¶ä¸”ï¼Œç¡®å®šä¸¤å®¶ä»Šåçš„æ–°è®¾å¤‡ä¼šä¸€ç›´ç»´æŒè¿™ä¸ªæœºåˆ¶ã€‚æ‰€ä»¥åŸºäºæ­¤ï¼Œç¬¬äºŒç§æ–¹æ¡ˆæ›´åŠ å…¨é¢ï¼Œä½†æ˜¯ç¬¬äºŒç§æ–¹æ¡ˆä¹Ÿä¼šå­˜åœ¨å¼Šç«¯ï¼Œå®ƒéœ€è¦ç‰ˆæœ¬çš„å…¼å®¹ï¼Œå› ä¸ºåœ¨ä½ç‰ˆæœ¬ä¸­æ— æ³•è·å–åˆ°messageQueueï¼Œå¹¶ä¸”æ˜¯é€šè¿‡åå°„çš„æ‰‹æ®µæ¥è¿›è¡Œè·å–ã€‚\nç¬¬ä¸€ç§æ–¹æ¡ˆ(è·å–æ ‡å¿—ä½)å®ç°ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 //jniå›è°ƒæ–¹æ³• void anrDumpTraceCallback() { if (g_vm == nullptr || g_utils_class == nullptr) return; JNIEnv *env = nullptr; if (g_vm-\u0026gt;AttachCurrentThread(\u0026amp;env, nullptr) != JNI_OK) return; jmethodID method = env-\u0026gt;GetStaticMethodID(g_utils_class, \u0026#34;onANRDumpTrace\u0026#34;, \u0026#34;()V\u0026#34;); if (method != nullptr) { env-\u0026gt;CallStaticVoidMethod(g_utils_class, method); } g_vm-\u0026gt;DetachCurrentThread(); } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 static void onANRDumpTrace() { Log.d(\u0026#34;MyUtils\u0026#34;, \u0026#34;onANRDumpTrace start\u0026#34;); ActivityManager am = (ActivityManager) getSystemService(context, ActivityManager.class); if (am != null) { List\u0026lt;ActivityManager.ProcessErrorStateInfo\u0026gt; errorList = am.getProcessesInErrorState(); if (errorList != null \u0026amp;\u0026amp; !errorList.isEmpty()) { for (ActivityManager.ProcessErrorStateInfo info : errorList) { if (info.condition == ActivityManager.ProcessErrorStateInfo.NOT_RESPONDING) { Log.e(\u0026#34;MyUtils\u0026#34;, \u0026#34;ANR detected in process: \u0026#34; + info.processName); // äºŒæ¬¡ç¡®è®¤ANRï¼Œç”¨äºANRè®°å½•æˆ–è€…ä¸ŠæŠ¥ // ... } } } } } ç¬¬äºŒç§æ–¹æ¡ˆä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 @RequiresApi(api = Build.VERSION_CODES.M) private static boolean isMainThreadBlocked() { try { MessageQueue mainQueue = Looper.getMainLooper().getQueue(); Field field = mainQueue.getClass().getDeclaredField(\u0026#34;mMessages\u0026#34;); field.setAccessible(true); final Message mMessage = (Message) field.get(mainQueue); if (mMessage != null) { anrMessageString = mMessage.toString(); long when = mMessage.getWhen(); if (when == 0) { return false; } long time = when - SystemClock.uptimeMillis(); anrMessageWhen = time; long timeThreshold = BACKGROUND_MSG_THRESHOLD; if (currentForeground) { timeThreshold = FOREGROUND_MSG_THRESHOLD; } return time \u0026lt; timeThreshold; } else { MatrixLog.i(TAG, \u0026#34;mMessage is null\u0026#34;); } } catch (Exception e) { return false; } return false; } åœ¨äºŒæ¬¡ç¡®è®¤åï¼Œè¿˜éœ€è¦å¯¹traceæ–‡ä»¶è¿›è¡Œè·å–ï¼Œtraceæ–‡ä»¶ä¼šå­˜å‚¨åœ¨/data/anr/traces.txtï¼Œæ–‡ä»¶çš„å†…å®¹éå¸¸å…¨é¢ï¼ŒåŒ…å«äº†æ‰€æœ‰çº¿ç¨‹çš„å„ç§çŠ¶æ€ã€é”å’Œå †æ ˆï¼Œä½†æ˜¯å¾ˆä¸å¹¸çš„æ˜¯åº”ç”¨ç¨‹åºæ²¡æœ‰æƒé™è·å–åˆ°è¯¥æ–‡ä»¶ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦é—´æ¥è·å–è¯¥æ–‡ä»¶çš„æ•°æ®å†…å®¹ã€‚åœ¨ä¸Šé¢æåˆ°çš„SignalCatcherçº¿ç¨‹æ”¶åˆ°SIGQUITä¿¡å·åï¼Œä¼šæ”¶é›†å„ä¸ªçº¿ç¨‹çš„traceä¿¡æ¯ï¼Œå¹¶é€šè¿‡ç³»ç»Ÿçš„writeæ–¹æ³•æŠŠtraceçš„æ•°æ®å†™åˆ°/data/anr/traces.txtæ–‡ä»¶ä¸­ã€‚å¦‚æœæˆ‘ä»¬èƒ½å¤ŸHookä½è¿™ä¸ªwriteæ–¹æ³•ï¼Œå°±å¯ä»¥è·å–å†™å…¥åˆ°traces.txtæ–‡ä»¶çš„å†…å®¹äº†ã€‚è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨PLT HookæŠ€æœ¯ï¼Œæ‹¦æˆªä½è¯¥writeæ–¹æ³•ï¼Œå°±å¯ä»¥è·å–å†™å…¥åˆ°traces.txtæ–‡ä»¶çš„å†…å®¹ã€‚è¿™é‡Œçš„writeæ–¹æ³•æ˜¯libc.soåº“ä¸­ï¼Œæ­¤å¤„ä½¿ç”¨bhookæ‹¦æˆªä½è¯¥åº“çš„æ–¹æ³•å°±èƒ½è·å–åˆ°è¯¥traceå†…å®¹äº†ï¼Œä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 void dealAnr() { bytehook_hook_all( \u0026#34;libc.so\u0026#34;, \u0026#34;write\u0026#34;, (void *) my_write, nullptr, nullptr); } ssize_t my_write(int fd, const void *const buf, size_t count) { BYTEHOOK_STACK_SCOPE(); if (buf != nullptr) { std::string content((const char *) buf, count); if (content.find(\u0026#34;Cmd line\u0026#34;) != std::string::npos) { LOGI(\u0026#34;Detected ANR trace write. Triggering callback...\u0026#34;); anrDumpTraceCallback(); // å›è°ƒ Java æ–¹æ³• } std::ofstream file(\u0026#34;/data/data/com.example.nativelib/example_anr.txt\u0026#34;, std::ios::app); if (file.is_open()) { file \u0026lt;\u0026lt; content; file.close(); } } return BYTEHOOK_CALL_PREV(my_write, fd, buf, count); } å½“è¿›ç¨‹å‘ç”Ÿanråï¼Œä¼šåœ¨ä¸Šé¢çš„ç›®å½•ä¸­ç”Ÿæˆexample_anr.txtæ–‡ä»¶ï¼Œæˆ‘ä»¬æ¥æµ‹è¯•ä¸€æ³¢ï¼š ä»ä¸Šé¢æ—¥å¿—ä¹Ÿèƒ½çœ‹å‡ºæ¥ä¸»çº¿ç¨‹å‡ºç°äº†sleepçŠ¶æ€ï¼Œé˜»å¡äº†ä¸»çº¿ç¨‹çš„ï¼Œå¹¶ä¸”å¯¹åº”æœ‰å †æ ˆè¡Œå·ã€‚ä¸Šé¢è¯´çš„äºŒæ¬¡ç¡®è®¤ä¸­ç›®å‰è¯•äº†android13å’Œ15éƒ½ä¸å¤ªè¡Œï¼ŒActivityManagerçš„getProcessesInErrorStateæ–¹æ³•å·²ç»ä¸å¯¹å¤–æä¾›å‡ºé”™çš„è¿›ç¨‹ä¿¡æ¯äº†ï¼Œå¹¶ä¸”åœ¨android10ä»¥ä¸Šä¸è®©è·å–messageQueueä¸­çš„messagesäº†ã€‚æ‰€ä»¥å¯¹åº”anrçš„äºŒæ¬¡ç¡®è®¤å·²ç»ç®—æ˜¯ä¸€ä¸ªé˜‰å‰²äº†å§ï¼Œåªèƒ½è·å–traceæ—¥å¿—äº†ã€‚\nå‚è€ƒï¼š\nhttps://juejin.cn/post/7371779128477302823?searchId=20251029174718B15D0AE28A87EE70C32C https://mp.weixin.qq.com/s/fWoXprt2TFL1tTapt7esYg?mode=light ","date":"2025-10-29T00:00:00Z","permalink":"http://xiangcman.xyz/p/android%E4%B8%ADanr%E7%9B%91%E6%8E%A7%E6%90%AD%E5%BB%BA/","title":"Androidä¸­anrç›‘æ§æ­å»º"},{"content":"weditoræ˜¯ä¸€ä¸ªPythonçš„æ’ä»¶ï¼Œé€šè¿‡è¯¥æ’ä»¶ï¼Œå¯ä»¥é€šè¿‡ä¸€äº›å‘½ä»¤æ§åˆ¶æ‰‹æœºï¼Œæ¯”å¦‚æˆ‘ä»Šå¤©è¦è®²çš„æ˜¯é€šè¿‡å®ƒèƒ½è‡ªåŠ¨åŒ–è¿æ¥è®¾ç½®æ‰‹æœºçš„wifiä»£ç†ã€‚\nweditorå®‰è£… åŸºæœ¬éƒ½æ˜¯pythonçš„å¸¸è§„å‘½ä»¤ï¼Œé¦–å…ˆæ˜¯å®‰è£…weditorï¼š\n1 pip install weditor å®‰è£…å®Œæˆ‘ä»¬æ£€æŸ¥ä¸‹æ˜¯å¦å®‰è£…ä¸Šï¼š\n1 which weditor è¯¥å‘½ä»¤ä¼šè¾“å‡ºweditorçš„å®‰è£…ç›®å½•ï¼Œç„¶åé€šè¿‡weditorå‘½ä»¤å¯ä»¥æ‰“å¼€ç½‘é¡µç‰ˆï¼š å·¦è¾¹æ˜¯æ‰‹æœºå½“å‰å‘ˆç°çš„æ ·å¼ï¼Œå³è¾¹æ˜¯å‘½ä»¤ï¼Œä¸­é—´æ˜¯æè¿°ç»„ä»¶çš„ä¸€äº›å±æ€§ï¼Œå…¶å®æˆ‘ä»¬åœ¨æ‰‹æœºä¸Šæ“ä½œä»€ä¹ˆï¼Œæœ€å³è¾¹ä¼šæŠŠå‘½ä»¤è¾“å‡ºå‡ºæ¥ã€‚æœ€å³è¾¹å°±æ˜¯æˆ‘è¿æ¥ä»£ç†çš„å‘½ä»¤ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 import uiautomator2 as u2 d = u2.connect() # è¿æ¥è®¾å¤‡ # æ‰“å¼€ WiFi è®¾ç½® d.app_start(\u0026#34;com.android.settings\u0026#34;) d(text=\u0026#34;WLAN\u0026#34;).click() d.sleep(1) d(text=\u0026#34;Wifiçš„åå­—\u0026#34;).click() d.swipe_ext(\u0026#34;up\u0026#34;,0.8) d.sleep(1) d(text=\u0026#34;ä»£ç†\u0026#34;).click() d(text=\u0026#34;æ‰‹åŠ¨\u0026#34;).click() d.swipe_ext(\u0026#34;up\u0026#34;,0.8) ipNode = d.xpath(\u0026#39;//*[@resource-id=\u0026#34;com.oplus.wirelesssettings:id/recycler_view\u0026#34;]/android.widget.LinearLayout[8]/android.widget.LinearLayout[1]/android.view.ViewGroup[1]/android.view.ViewGroup[1]/android.widget.FrameLayout[1]\u0026#39;) # ipNode.click() ipNode.set_text(\u0026#34;10.100.3.152\u0026#34;) portNode = d.xpath(\u0026#39;//*[@resource-id=\u0026#34;com.oplus.wirelesssettings:id/recycler_view\u0026#34;]/android.widget.LinearLayout[9]/android.widget.LinearLayout[1]/android.view.ViewGroup[1]/android.view.ViewGroup[1]/android.widget.FrameLayout[1]\u0026#39;) # portNode.click() portNode.set_text(\u0026#34;8888\u0026#34;) d(resourceId=\u0026#34;com.oplus.wirelesssettings:id/coui_toolbar_back_view\u0026#34;).click() è¿™å°±å®ç°äº†ä¸€ä¸ªwifiè¿æ¥ä»£ç†ï¼Œä½†æ˜¯å¦‚æœè¦åšå¥½è‡ªåŠ¨åŒ–è¿æ¥ä»£ç ï¼Œéœ€è¦è€ƒè™‘çš„å› ç´ å¾ˆå¤šï¼Œæ¯”å¦‚ä¸‹é¢æˆ‘æŠŠè¿æ¥ä»£ç å’Œå–æ¶ˆä»£ç†çš„è¿‡ç¨‹æŒ‰ç…§å¦‚ä¸‹å†™å‡ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 import argparse import sys import time import uiautomator2 as u2 WLAN_TEXTS = [\u0026#34;WLAN\u0026#34;, \u0026#34;Wiâ€‘Fi\u0026#34;, \u0026#34;WiFi\u0026#34;, \u0026#34;WLAN å’Œäº’è”ç½‘\u0026#34;, \u0026#34;ç½‘ç»œå’Œäº’è”ç½‘\u0026#34;] PROXY_TEXTS = [\u0026#34;ä»£ç†\u0026#34;, \u0026#34;Proxy\u0026#34;] MANUAL_TEXTS = [\u0026#34;æ‰‹åŠ¨\u0026#34;, \u0026#34;Manual\u0026#34;] SAVE_TEXTS = [\u0026#34;ä¿å­˜\u0026#34;, \u0026#34;Save\u0026#34;, \u0026#34;åº”ç”¨\u0026#34;, \u0026#34;Apply\u0026#34;] BACK_IDS = [ \u0026#34;com.oplus.wirelesssettings:id/coui_toolbar_back_view\u0026#34;, \u0026#34;com.android.settings:id/action_bar\u0026#34;, # æŸäº›æœºå‹è¿”å›æŒ‰é’®å®¹å™¨ ] LAUNCHER_PKGS = [ \u0026#34;com.android.launcher3\u0026#34;, \u0026#34;com.google.android.apps.nexuslauncher\u0026#34;, \u0026#34;com.coloros.launcher\u0026#34;, \u0026#34;com.oneplus.launcher\u0026#34;, \u0026#34;com.miui.home\u0026#34;, \u0026#34;com.huawei.android.launcher\u0026#34;, \u0026#34;org.lineageos.launcher\u0026#34;, ] def log(msg): print(f\u0026#34;[INFO] {msg}\u0026#34;) def err(msg): print(f\u0026#34;[ERROR] {msg}\u0026#34;, file=sys.stderr) def sh(d, cmd): r = d.shell(cmd) # ç»Ÿä¸€æ‹¿åˆ°çº¯æ–‡æœ¬ if isinstance(r, dict) and \u0026#34;output\u0026#34; in r: out = r[\u0026#34;output\u0026#34;] elif hasattr(r, \u0026#34;output\u0026#34;): out = r.output else: out = r if out is None: return \u0026#34;\u0026#34; if isinstance(out, (bytes, bytearray)): out = out.decode(\u0026#34;utf-8\u0026#34;, errors=\u0026#34;ignore\u0026#34;) return str(out) def is_wifi_on(d): # ä¼˜å…ˆä» dumpsys è¯»çŠ¶æ€ txt = sh(d, \u0026#39;dumpsys wifi | grep -iE \u0026#34;wi-?fi is\u0026#34; || true\u0026#39;).lower() if \u0026#34;enabled\u0026#34; in txt: return True if \u0026#34;disabled\u0026#34; in txt: return False # é€€åŒ–åˆ°å…¨å±€è®¾ç½®ï¼ˆæœ‰äº›ç³»ç»Ÿå¯èƒ½è¿”å› \u0026#34;null\u0026#34;ï¼‰ val = sh(d, \u0026#34;settings get global wifi_on || true\u0026#34;).strip() return val == \u0026#34;1\u0026#34; def ensure_wifi_on(d, timeout=10): sh(d, \u0026#34;svc wifi enable || true\u0026#34;) end = time.time() + timeout while time.time() \u0026lt; end: if is_wifi_on(d): return True time.sleep(0.4) return False def wait_and_click_text(d, candidates, timeout=10, must=True): end = time.time() + timeout while time.time() \u0026lt; end: for t in candidates if isinstance(candidates, list) else [candidates]: obj = d(text=t) if obj.exists: obj.click() return True time.sleep(0.3) if must: raise RuntimeError(f\u0026#34;æ‰¾ä¸åˆ°æ–‡æœ¬: {candidates}\u0026#34;) return False def wait_exists_text(d, candidates, timeout=10): end = time.time() + timeout while time.time() \u0026lt; end: for t in candidates if isinstance(candidates, list) else [candidates]: if d(text=t).exists: return t time.sleep(0.3) return None def scroll_to_text_and_click(d, target_text, max_swipes=10): for _ in range(max_swipes): if d(text=target_text).exists: d(text=target_text).click() return True if d(scrollable=True).exists: d(scrollable=True).scroll.vert.forward(steps=30) else: d.swipe_ext(\u0026#34;up\u0026#34;, 0.8) time.sleep(0.2) raise RuntimeError(f\u0026#34;æ»šåŠ¨ä»æœªæ‰¾åˆ°: {target_text}\u0026#34;) def go_home(d, timeout=0): d.press(\u0026#34;home\u0026#34;) if timeout \u0026lt;= 0: # ç›´æ¥è¿”å›ï¼Œä¸ç­‰å¾…æ£€æµ‹ return True end = time.time() + timeout while time.time() \u0026lt; end: cur = d.app_current() or {} if cur.get(\u0026#34;package\u0026#34;) in LAUNCHER_PKGS: return True time.sleep(0.1) d.press(\u0026#34;home\u0026#34;) # å…œåº•ï¼Œä¸é˜»å¡ d.shell(\u0026#34;am start -a android.intent.action.MAIN -c android.intent.category.HOME\u0026#34;) return True def click_any_back(d, isGoHome=False, go_home_timeout=0): for t in SAVE_TEXTS: if d(text=t).exists: d(text=t).click() break else: for rid in BACK_IDS: if d(resourceId=rid).exists: d(resourceId=rid).click() break else: d.press(\u0026#34;back\u0026#34;) if isGoHome: go_home(d, timeout=go_home_timeout) def set_edit_texts(d, host, port, clear_first=True): # ä»£ç†ä¸ºâ€œæ‰‹åŠ¨â€åï¼Œé€šå¸¸ä¼šå‡ºç°ä¸¤ä¸ª EditTextï¼šä¸»æœºã€ç«¯å£ # é¿å…å¤æ‚ XPathï¼Œç›´æ¥æ‰¾å¯è§çš„ EditText edits = d(className=\u0026#34;android.widget.EditText\u0026#34;) if len(edits) \u0026lt; 2: # å¯èƒ½æœªæ»šåˆ°ä½æˆ–æ§ä»¶å»¶è¿Ÿå‡ºç°ï¼Œå†å°è¯•æ»šåŠ¨å‡ æ¬¡ for _ in range(4): d.swipe_ext(\u0026#34;up\u0026#34;, 0.7) time.sleep(0.2) edits = d(className=\u0026#34;android.widget.EditText\u0026#34;) if len(edits) \u0026gt;= 2: break if len(edits) \u0026lt; 2: raise RuntimeError(\u0026#34;æœªæ‰¾åˆ°ä»£ç†ä¸»æœº/ç«¯å£è¾“å…¥æ¡†\u0026#34;) host_edit = edits[0] port_edit = edits[1] if clear_first: try: host_edit.clear_text() port_edit.clear_text() except Exception: pass host_edit.set_text(host) port_edit.set_text(str(port)) def restart_settings(d): # éƒ¨åˆ†å‚å•†æŠŠ Wiâ€‘Fi ç•Œé¢æ”¾åœ¨è‡ªå®¶åŒ…é‡Œï¼Œä¸€èµ·åœæ›´ç¨³ for pkg in (\u0026#34;com.android.settings\u0026#34;, \u0026#34;com.oplus.wirelesssettings\u0026#34;): d.app_stop(pkg) d.shell(f\u0026#34;am force-stop {pkg} || true\u0026#34;) # d.press(\u0026#34;home\u0026#34;) d.app_start(\u0026#34;com.android.settings\u0026#34;) d.app_wait(\u0026#34;com.android.settings\u0026#34;, timeout=10) def open_wifi_settings(d): ensure_wifi_on(d) # å…ˆé€šè¿‡ shell æ‰“å¼€ Wiâ€‘Fi log(\u0026#34;æ‰“å¼€è®¾ç½®å¹¶è¿›å…¥ WLAN/Wiâ€‘Fi\u0026#34;) restart_settings(d) # æœ‰äº›æœºå‹é¦–é¡µä¸ç›´æ¥æ˜¾ç¤º WLANï¼Œéœ€è¦æ»šåŠ¨æˆ–è¿›â€œç½‘ç»œå’Œäº’è”ç½‘â€ found = wait_exists_text(d, WLAN_TEXTS, timeout=3) if not found: # å¯èƒ½æ˜¯â€œç½‘ç»œå’Œäº’è”ç½‘â€ä¸€çº§èœå• wait_and_click_text(d, [\u0026#34;ç½‘ç»œå’Œäº’è”ç½‘\u0026#34;, \u0026#34;Network \u0026amp; internet\u0026#34;], timeout=8, must=False) # è¿›å…¥åå†æ‰¾ WLAN wait_and_click_text(d, WLAN_TEXTS, timeout=8, must=True) else: wait_and_click_text(d, WLAN_TEXTS, timeout=3, must=True) def set_wifi_proxy(d, ssid, host, port, wait=10): log(f\u0026#34;è¿›å…¥ Wiâ€‘Fi: {ssid}\u0026#34;) # æ»šåŠ¨æ‰¾åˆ°å¯¹åº” SSID scroll_to_text_and_click(d, ssid, max_swipes=12) time.sleep(0.3) # å±•å¼€â€œä»£ç†â€é€‰é¡¹å¹¶é€‰æ‹©â€œæ‰‹åŠ¨â€ log(\u0026#34;è®¾ç½®ä»£ç†ä¸ºæ‰‹åŠ¨\u0026#34;) # é¡µé¢å¯èƒ½æœ‰â€œé«˜çº§é€‰é¡¹â€ï¼Œå…ˆå±•å¼€ if d(text=\u0026#34;é«˜çº§é€‰é¡¹\u0026#34;).exists: d(text=\u0026#34;é«˜çº§é€‰é¡¹\u0026#34;).click() # æ»šåŠ¨ç¡®ä¿èƒ½çœ‹åˆ°â€œä»£ç†â€ for _ in range(4): if d(text=PROXY_TEXTS[0]).exists or d(text=PROXY_TEXTS[1]).exists: break d.swipe_ext(\u0026#34;up\u0026#34;, 0.7) time.sleep(0.2) wait_and_click_text(d, PROXY_TEXTS, timeout=wait, must=True) wait_and_click_text(d, MANUAL_TEXTS, timeout=wait, must=True) # è®¾ç½®ä¸»æœºå’Œç«¯å£ log(f\u0026#34;å¡«å…¥ä»£ç† {host}:{port}\u0026#34;) set_edit_texts(d, host, port) # ä¿å­˜/è¿”å› click_any_back(d, isGoHome=True,go_home_timeout=0) def main(): parser = argparse.ArgumentParser(description=\u0026#34;é€šè¿‡ uiautomator2 è®¾ç½®æŒ‡å®š Wiâ€‘Fi çš„ HTTP ä»£ç†\u0026#34;) parser.add_argument(\u0026#34;--device\u0026#34;, help=\u0026#34;è®¾å¤‡IPï¼ˆå¯é€‰ï¼Œé»˜è®¤USBæˆ–å·²é…å¯¹ï¼‰\u0026#34;, default=None) parser.add_argument(\u0026#34;--ssid\u0026#34;, required=True, help=\u0026#34;Wiâ€‘Fi SSID\u0026#34;) parser.add_argument(\u0026#34;--host\u0026#34;, required=True, help=\u0026#34;ä»£ç†ä¸»æœº\u0026#34;) parser.add_argument(\u0026#34;--port\u0026#34;, required=True, type=int, help=\u0026#34;ä»£ç†ç«¯å£\u0026#34;) parser.add_argument(\u0026#34;--wait\u0026#34;, type=int, default=10, help=\u0026#34;ç­‰å¾…è¶…æ—¶ç§’æ•°\u0026#34;) args = parser.parse_args() try: #è¿æ¥è®¾å¤‡ d = u2.connect(args.device) if args.device else u2.connect() #å¯ä»¥ä¼ å…¥è¿æ¥çš„è¶…æ—¶æ—¶é—´ d.implicitly_wait(args.wait) try: #æ‰“å¼€è®¾ç½®é¡µ open_wifi_settings(d) time.sleep(1) set_wifi_proxy(d, args.ssid, args.host, args.port, wait=args.wait) log(\u0026#34;å®Œæˆ\u0026#34;) except Exception as e: err(str(e)) sys.exit(1) except Exception as e: err(\u0026#34;æœªè¿æ¥åˆ°è®¾å¤‡ï¼Œè¯·æ£€æŸ¥ USB æˆ– IP æ˜¯å¦æ­£ç¡®\u0026#34;) sys.exit(1) if __name__ == \u0026#34;__main__\u0026#34;: main() ä¸‹é¢å†æ¥çœ‹ä¸‹å–æ¶ˆä»£ç†å¦‚ä½•å†™ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 import argparse import sys import time import uiautomator2 as u2 from ppadb.client import Client as AdbClient WLAN_TEXTS = [\u0026#34;WLAN\u0026#34;, \u0026#34;Wiâ€‘Fi\u0026#34;, \u0026#34;WiFi\u0026#34;, \u0026#34;WLAN å’Œäº’è”ç½‘\u0026#34;, \u0026#34;ç½‘ç»œå’Œäº’è”ç½‘\u0026#34;] PROXY_TEXTS = [\u0026#34;ä»£ç†\u0026#34;, \u0026#34;Proxy\u0026#34;] MANUAL_TEXTS = [\u0026#34;æ— \u0026#34;] SAVE_TEXTS = [\u0026#34;ä¿å­˜\u0026#34;, \u0026#34;Save\u0026#34;, \u0026#34;åº”ç”¨\u0026#34;, \u0026#34;Apply\u0026#34;] BACK_IDS = [ \u0026#34;com.oplus.wirelesssettings:id/coui_toolbar_back_view\u0026#34;, \u0026#34;com.android.settings:id/action_bar\u0026#34;, # æŸäº›æœºå‹è¿”å›æŒ‰é’®å®¹å™¨ ] LAUNCHER_PKGS = [ \u0026#34;com.android.launcher3\u0026#34;, \u0026#34;com.google.android.apps.nexuslauncher\u0026#34;, \u0026#34;com.coloros.launcher\u0026#34;, \u0026#34;com.oneplus.launcher\u0026#34;, \u0026#34;com.miui.home\u0026#34;, \u0026#34;com.huawei.android.launcher\u0026#34;, \u0026#34;org.lineageos.launcher\u0026#34;, ] def log(msg): print(f\u0026#34;[INFO] {msg}\u0026#34;) def err(msg): print(f\u0026#34;[ERROR] {msg}\u0026#34;, file=sys.stderr) def sh(d, cmd): r = d.shell(cmd) # ç»Ÿä¸€æ‹¿åˆ°çº¯æ–‡æœ¬ if isinstance(r, dict) and \u0026#34;output\u0026#34; in r: out = r[\u0026#34;output\u0026#34;] elif hasattr(r, \u0026#34;output\u0026#34;): out = r.output else: out = r if out is None: return \u0026#34;\u0026#34; if isinstance(out, (bytes, bytearray)): out = out.decode(\u0026#34;utf-8\u0026#34;, errors=\u0026#34;ignore\u0026#34;) return str(out) def is_wifi_on(d): # ä¼˜å…ˆä» dumpsys è¯»çŠ¶æ€ txt = sh(d, \u0026#39;dumpsys wifi | grep -iE \u0026#34;wi-?fi is\u0026#34; || true\u0026#39;).lower() if \u0026#34;enabled\u0026#34; in txt: return True if \u0026#34;disabled\u0026#34; in txt: return False # é€€åŒ–åˆ°å…¨å±€è®¾ç½®ï¼ˆæœ‰äº›ç³»ç»Ÿå¯èƒ½è¿”å› \u0026#34;null\u0026#34;ï¼‰ val = sh(d, \u0026#34;settings get global wifi_on || true\u0026#34;).strip() return val == \u0026#34;1\u0026#34; def ensure_wifi_on(d, timeout=10): sh(d, \u0026#34;svc wifi enable || true\u0026#34;) end = time.time() + timeout while time.time() \u0026lt; end: if is_wifi_on(d): return True time.sleep(0.4) return False def wait_and_click_text(d, candidates, timeout=10, must=True): end = time.time() + timeout while time.time() \u0026lt; end: for t in candidates if isinstance(candidates, list) else [candidates]: obj = d(text=t) if obj.exists: obj.click() return True time.sleep(0.3) if must: raise RuntimeError(f\u0026#34;æ‰¾ä¸åˆ°æ–‡æœ¬: {candidates}\u0026#34;) return False def wait_exists_text(d, candidates, timeout=10): end = time.time() + timeout while time.time() \u0026lt; end: for t in candidates if isinstance(candidates, list) else [candidates]: if d(text=t).exists: return t time.sleep(0.3) return None def scroll_to_text_and_click(d, target_text, max_swipes=10): for _ in range(max_swipes): if d(text=target_text).exists: d(text=target_text).click() return True if d(scrollable=True).exists: d(scrollable=True).scroll.vert.forward(steps=30) else: d.swipe_ext(\u0026#34;up\u0026#34;, 0.8) time.sleep(0.2) raise RuntimeError(f\u0026#34;æ»šåŠ¨ä»æœªæ‰¾åˆ°: {target_text}\u0026#34;) def go_home(d, timeout=0): d.press(\u0026#34;home\u0026#34;) if timeout \u0026lt;= 0: # ç›´æ¥è¿”å›ï¼Œä¸ç­‰å¾…æ£€æµ‹ return True end = time.time() + timeout while time.time() \u0026lt; end: cur = d.app_current() or {} if cur.get(\u0026#34;package\u0026#34;) in LAUNCHER_PKGS: return True time.sleep(0.1) d.press(\u0026#34;home\u0026#34;) # å…œåº•ï¼Œä¸é˜»å¡ d.shell(\u0026#34;am start -a android.intent.action.MAIN -c android.intent.category.HOME\u0026#34;) return True def click_any_back(d, isGoHome=False, go_home_timeout=0): for t in SAVE_TEXTS: if d(text=t).exists: d(text=t).click() break else: for rid in BACK_IDS: if d(resourceId=rid).exists: d(resourceId=rid).click() break else: d.press(\u0026#34;back\u0026#34;) if isGoHome: go_home(d, timeout=go_home_timeout) def set_edit_texts(d, host, port, clear_first=True): # ä»£ç†ä¸ºâ€œæ‰‹åŠ¨â€åï¼Œé€šå¸¸ä¼šå‡ºç°ä¸¤ä¸ª EditTextï¼šä¸»æœºã€ç«¯å£ # é¿å…å¤æ‚ XPathï¼Œç›´æ¥æ‰¾å¯è§çš„ EditText edits = d(className=\u0026#34;android.widget.EditText\u0026#34;) if len(edits) \u0026lt; 2: # å¯èƒ½æœªæ»šåˆ°ä½æˆ–æ§ä»¶å»¶è¿Ÿå‡ºç°ï¼Œå†å°è¯•æ»šåŠ¨å‡ æ¬¡ for _ in range(4): d.swipe_ext(\u0026#34;up\u0026#34;, 0.7) time.sleep(0.2) edits = d(className=\u0026#34;android.widget.EditText\u0026#34;) if len(edits) \u0026gt;= 2: break if len(edits) \u0026lt; 2: raise RuntimeError(\u0026#34;æœªæ‰¾åˆ°ä»£ç†ä¸»æœº/ç«¯å£è¾“å…¥æ¡†\u0026#34;) host_edit = edits[0] port_edit = edits[1] if clear_first: try: host_edit.clear_text() port_edit.clear_text() except Exception: pass host_edit.set_text(host) port_edit.set_text(str(port)) def restart_settings(d): # éƒ¨åˆ†å‚å•†æŠŠ Wiâ€‘Fi ç•Œé¢æ”¾åœ¨è‡ªå®¶åŒ…é‡Œï¼Œä¸€èµ·åœæ›´ç¨³ for pkg in (\u0026#34;com.android.settings\u0026#34;, \u0026#34;com.oplus.wirelesssettings\u0026#34;): d.app_stop(pkg) d.shell(f\u0026#34;am force-stop {pkg} || true\u0026#34;) # d.press(\u0026#34;home\u0026#34;) d.app_start(\u0026#34;com.android.settings\u0026#34;) d.app_wait(\u0026#34;com.android.settings\u0026#34;, timeout=10) def open_wifi_settings(d): ensure_wifi_on(d) # å…ˆé€šè¿‡ shell æ‰“å¼€ Wiâ€‘Fi log(\u0026#34;æ‰“å¼€è®¾ç½®å¹¶è¿›å…¥ WLAN/Wiâ€‘Fi\u0026#34;) restart_settings(d) # æœ‰äº›æœºå‹é¦–é¡µä¸ç›´æ¥æ˜¾ç¤º WLANï¼Œéœ€è¦æ»šåŠ¨æˆ–è¿›â€œç½‘ç»œå’Œäº’è”ç½‘â€ found = wait_exists_text(d, WLAN_TEXTS, timeout=3) if not found: # å¯èƒ½æ˜¯â€œç½‘ç»œå’Œäº’è”ç½‘â€ä¸€çº§èœå• wait_and_click_text(d, [\u0026#34;ç½‘ç»œå’Œäº’è”ç½‘\u0026#34;, \u0026#34;Network \u0026amp; internet\u0026#34;], timeout=8, must=False) # è¿›å…¥åå†æ‰¾ WLAN wait_and_click_text(d, WLAN_TEXTS, timeout=8, must=True) else: wait_and_click_text(d, WLAN_TEXTS, timeout=3, must=True) def cancel_wifi_proxy(d, ssid, wait=10): log(f\u0026#34;è¿›å…¥ Wiâ€‘Fi: {ssid}\u0026#34;) # æ»šåŠ¨æ‰¾åˆ°å¯¹åº” SSID scroll_to_text_and_click(d, ssid, max_swipes=12) time.sleep(0.3) # å±•å¼€â€œä»£ç†â€é€‰é¡¹å¹¶é€‰æ‹©â€œæ‰‹åŠ¨â€ log(\u0026#34;å–æ¶ˆä»£ç†\u0026#34;) # é¡µé¢å¯èƒ½æœ‰â€œé«˜çº§é€‰é¡¹â€ï¼Œå…ˆå±•å¼€ if d(text=\u0026#34;é«˜çº§é€‰é¡¹\u0026#34;).exists: d(text=\u0026#34;é«˜çº§é€‰é¡¹\u0026#34;).click() # æ»šåŠ¨ç¡®ä¿èƒ½çœ‹åˆ°â€œä»£ç†â€ for _ in range(4): if d(text=PROXY_TEXTS[0]).exists or d(text=PROXY_TEXTS[1]).exists: break d.swipe_ext(\u0026#34;up\u0026#34;, 0.7) time.sleep(0.2) wait_and_click_text(d, PROXY_TEXTS, timeout=wait, must=True) wait_and_click_text(d, MANUAL_TEXTS, timeout=wait, must=True) # ä¿å­˜/è¿”å› click_any_back(d,isGoHome=True,go_home_timeout=0) def main(): parser = argparse.ArgumentParser(description=\u0026#34;é€šè¿‡ uiautomator2 è®¾ç½®æŒ‡å®š Wiâ€‘Fi çš„ HTTP ä»£ç†è¢«å–æ¶ˆ\u0026#34;) parser.add_argument(\u0026#34;--device\u0026#34;, help=\u0026#34;è®¾å¤‡IPï¼ˆå¯é€‰ï¼Œé»˜è®¤USBæˆ–å·²é…å¯¹ï¼‰\u0026#34;, default=None) parser.add_argument(\u0026#34;--ssid\u0026#34;, required=True, help=\u0026#34;Wiâ€‘Fi SSID\u0026#34;) parser.add_argument(\u0026#34;--wait\u0026#34;, type=int, default=10, help=\u0026#34;ç­‰å¾…è¶…æ—¶ç§’æ•°\u0026#34;) args = parser.parse_args() try: d = u2.connect(args.device) if args.device else u2.connect() d.implicitly_wait(args.wait) try: open_wifi_settings(d) time.sleep(1) cancel_wifi_proxy(d, args.ssid, wait=args.wait) log(\u0026#34;å®Œæˆ\u0026#34;) except Exception as e: err(str(e)) sys.exit(1) except Exception as e: err(\u0026#34;æœªè¿æ¥åˆ°è®¾å¤‡ï¼Œè¯·æ£€æŸ¥ USB æˆ– IP æ˜¯å¦æ­£ç¡®\u0026#34;) sys.exit(1) if __name__ == \u0026#34;__main__\u0026#34;: main() å…¶å®å–æ¶ˆä»£ç†å’Œè®¾ç½®ä»£ç†å·®ä¸å¤šï¼Œåªä¸è¿‡åœ¨é€‰æ‹©ä»£ç†çš„é¡¹ç›®ä¸­ï¼Œè®¾ç½®ä»£ç†é€‰æ‹©æ‰‹åŠ¨ï¼Œè€Œå–æ¶ˆä»£ç†é€‰æ‹©æ— ï¼Œç„¶åå°±é€€å‡ºè®¾ç½®ä»£ç†é¡µé¢äº†ã€‚æœ€åå›åˆ°homeé¡µé¢ã€‚\n","date":"2025-09-25T00:00:00Z","permalink":"http://xiangcman.xyz/p/%E9%80%9A%E8%BF%87python%E7%9A%84weditor%E6%8F%92%E4%BB%B6%E6%90%AD%E5%BB%BA%E6%89%8B%E6%9C%BAwifi%E8%87%AA%E5%8A%A8%E8%BF%9E%E6%8E%A5%E4%BB%A3%E7%90%86/","title":"é€šè¿‡pythonçš„weditoræ’ä»¶æ­å»ºæ‰‹æœºwifiè‡ªåŠ¨è¿æ¥ä»£ç†"},{"content":"æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸ªnativeçš„crashä¾‹å­:\nè¿™æ˜¯æˆ‘åœ¨clionä¸­å†™çš„ä¸€ä¸ªæµ‹è¯•ä»£ç ï¼Œè¿™ä¸ªå¾ˆæ˜æ˜¾ï¼Œåœ¨ç¨‹åºç¬¬8è¡Œä½¿ç”¨äº†ä¸€ä¸ªæœªåˆå§‹åŒ–çš„æŒ‡é’ˆï¼Œç„¶åè¿è¡Œæœ€åï¼Œè¯´ç¨‹åºè¢«SIGSEGVä¿¡å·ç»ˆæ­¢äº†ï¼Œè¯¥ä¿¡å·åœ¨c/c++ä¸­è¡¨ç¤ºéæ³•è®¿é—®å†…å­˜çš„ä¿¡å·ï¼Œå¹¶ä¸”è¯¥ç»ˆæ­¢æ²¡æœ‰æŒ‡æ˜ä»£ç è¡Œå·ã€‚è¿™åœ¨è°ƒè¯•c++ç¨‹åºå¾ˆå¤´ç—›ï¼Œä¸è¿‡åœ¨å®‰å“ndké¡¹ç›®ä¸­å¦‚æœæƒ³è¦å®šä½æ˜¯c++çš„é—®é¢˜ï¼Œæˆ‘ä»¬æ¥ä¸€èµ·çœ‹ä¸‹ã€‚\n1 2 3 4 5 6 7 extern \u0026#34;C\u0026#34; JNIEXPORT void JNICALL Java_com_example_nativelib_CrashActivity_testNativeCrash(JNIEnv *env, jobject thiz) { int* p; int a = 10; *p = 20; } ç„¶ååœ¨activityé‡Œé¢é€šè¿‡jniè°ƒç”¨è¯¥æ–¹æ³•ï¼š\n1 2 3 4 5 native void testNativeCrash(); static { System.loadLibrary(\u0026#34;crash_monitor\u0026#34;); } crashçš„æ—¥å¿—å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 --------- beginning of crash 2025-08-28 14:56:29.639 2487-2487 libc com.example.nativelib A Fatal signal 11 (SIGSEGV), code 1 (SEGV_MAPERR), fault addr 0x0 in tid 2487 (ample.nativelib), pid 2487 (ample.nativelib) 2025-08-28 14:56:30.559 2724-2724 DEBUG pid-2724 A Cmdline: com.example.nativelib 2025-08-28 14:56:30.559 2724-2724 DEBUG pid-2724 A pid: 2487, tid: 2487, name: ample.nativelib \u0026gt;\u0026gt;\u0026gt; com.example.nativelib \u0026lt;\u0026lt;\u0026lt; 2025-08-28 14:56:30.559 2724-2724 DEBUG pid-2724 A #00 pc 0000000000000644 /data/app/~~uAk5HwqkTX5ikhOJ94KruQ==/com.example.nativelib-nvfAk1bvIIxGrBGSolPLNw==/base.apk!libcrash_monitor.so (Java_com_example_nativelib_CrashActivity_testNativeCrash+28) (BuildId: 3f3fdcb6b22b15038811fa94da4200e7cc25d684) 2025-08-28 14:56:30.559 2724-2724 DEBUG pid-2724 A #03 pc 0000000000000880 [anon:dalvik-classes4.dex extracted in memory from /data/app/~~uAk5HwqkTX5ikhOJ94KruQ==/com.example.nativelib-nvfAk1bvIIxGrBGSolPLNw==/base.apk!classes4.dex] (com.example.nativelib.CrashActivity$1.onClick+4) 2025-08-28 14:56:30.559 2724-2724 DEBUG pid-2724 A #07 pc 000000000038fa62 [anon:dalvik-classes.dex extracted in memory from /data/app/~~uAk5HwqkTX5ikhOJ94KruQ==/com.example.nativelib-nvfAk1bvIIxGrBGSolPLNw==/base.apk] (com.google.android.material.button.MaterialButton.performClick+22) æ—¥å¿—è§£è¯» ç¬¬ä¸€è¡Œæ—¥å¿— Signal 11 (SIGSEGV):å› ä¸ºSIGSEGVä¿¡å·å¤±è´¥çš„ï¼Œå’Œä¸Šé¢çš„clionä¸­ä¸€è‡´ã€‚ SEGV_MAPERRï¼šè®¿é—®äº†æœªæ˜ å°„çš„å†…å­˜ã€‚ fault addr 0x0ï¼šå‡ºé”™åœ°å€æ˜¯ 0x0ï¼Œè¯´æ˜æ˜¯å…¸å‹çš„ ç©ºæŒ‡é’ˆè®¿é—®ã€‚ tid: 2487 (ample.nativelib), pid: 2487 (ample.nativelib)ï¼šå´©æºƒå‘ç”Ÿåœ¨ä¸»çº¿ç¨‹ï¼ˆtid==pid==2487ï¼‰ã€‚æ‰€ä»¥æ˜¯uiçº¿ç¨‹ç›´æ¥è°ƒç”¨nativeæ–¹æ³•å¯¼è‡´çš„crashã€‚ è°ƒç”¨å †æ ˆ #00 pc 0000000000000644 libcrash_monitor.so (Java_com_example_nativelib_CrashActivity_testNativeCrash+28) å´©æºƒç‚¹åœ¨soåº“ï¼šlibcrash_monitor.so å¯¹åº”JNIæ–¹æ³•ï¼šJava_com_example_nativelib_CrashActivity_testNativeCrash +28è¡¨ç¤ºåœ¨è¿™ä¸ªJNIå‡½æ•°çš„ç¬¬28ä¸ªå­—ç¬¦å¤„å‘ç”Ÿäº†é”™è¯¯ 0000000000000644ï¼šç›¸å¯¹äºè¯¥soåŠ è½½åŸºå€ï¼ˆbase addressï¼‰çš„åç§»é‡ å´©æºƒå®šä½ addr2line å®ƒæ˜¯åœ¨ndkç›®å½•ä¸­ï¼Œé¦–å…ˆéœ€è¦æŸ¥çœ‹é¡¹ç›®ä½¿ç”¨çš„ndkç‰ˆæœ¬ï¼Œé€šè¿‡./gradlew app:assembleDebug --info | grep ndkæ¥æŸ¥çœ‹ndkç‰ˆæœ¬ï¼Œæˆ–è€…åœ¨appçš„moduleçš„build.gradleä¸­æŒ‡å®šndkç‰ˆæœ¬æˆ–è€…åœ¨local.propertiesä¸­æŒ‡å®šndkç‰ˆæœ¬ï¼Œæˆ‘è¿™é‡Œç”¨çš„æ˜¯21.3.6528147ç‰ˆæœ¬ï¼Œå¹¶ä¸”æœºå™¨æ˜¯64ä½ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š 1 /Users/xiangcheng/Library/Android/sdk/ndk/21.3.6528147/toolchains/llvm/prebuilt/darwin-x86_64/bin/aarch64-linux-android-addr2line -C -f -e /Users/xiangcheng/AndroidStudioProjects/NativeProject/app/build/intermediates/cxx/Debug/6p5m14a5/obj/arm64-v8a/libcrash_monitor.so 0x00644 é¦–å…ˆæ˜¯addr2lineçš„æœ¬åœ°åœ°å€ï¼Œ-C:å¯ç”¨ demanglingï¼ˆç¬¦å·è¿˜åŸï¼‰ï¼ŒæŠŠ C++ çš„ mangled nameï¼ˆç¬¦å·ä¿®é¥°åï¼‰ è½¬æ¢æˆäººç±»å¯è¯»çš„å‡½æ•°ç­¾åã€‚æˆ‘è¿™é‡Œæ˜¯jniæ–¹æ³•ï¼Œæ‰€ä»¥ä¸å­˜åœ¨å‡½æ•°è¿˜åŸã€‚-fï¼šæ‰“å°å‡½æ•°åï¼Œé»˜è®¤åªè¾“å…¥æ–‡ä»¶å+è¡Œå·ï¼ŒåŠ ä¸Š-fæ‰ä¼šæ˜¾ç¤ºå¯¹åº”çš„å‡½æ•°åã€‚-eæ˜¯soçš„è·¯å¾„ï¼Œæœ€åè¾“å…¥åç§»åœ°å€ã€‚å‘½ä»¤ç»“æœå¦‚ä¸‹ï¼š ç¬¬ä¸€è¡Œæ˜¯æ–¹æ³•åï¼Œç¬¬äºŒè¡Œæ˜¯å“ªä¸ªæ–‡ä»¶çš„è¡Œå·ï¼Œå¯ä»¥çœ‹åˆ°å¯¹åº”äº†cppçš„ç¬¬13è¡Œã€‚ addr2lineçš„ç¼ºç‚¹æ˜¯åªèƒ½è¿›è¡Œå•æ¡åœ°å€å®šä½ åœ¨ä¸Šé¢å–çš„soè·¯å¾„æ˜¯build/intermediates/cxx/..ä¸‹é¢ï¼Œè€Œæœ€ç»ˆæ‰“åˆ°apkçš„soæ˜¯è¿™æ ·çš„è¿‡ç¨‹ï¼š åœ¨agp4.0ä¹‹å‰: /build/intermediates/cmake|ndkBuild/.../obj/...(ç¼–è¯‘äº§ç‰©) /build/intermediates/merged_native_libs/.../out/lib/...(æ‰“åŒ…å‰ï¼Œä¹Ÿå°±æ˜¯æ±‡æ€»æ‰€æœ‰ä¾èµ–ä¹‹åçš„é›†åˆç›®å½•ï¼Œä¹Ÿæ˜¯æ²¡æœ‰è¢«å‰”é™¤ç¬¦å·çš„so) /build/intermediates/stripped_native_libs/soæ–‡ä»¶(å‰¥ç¦»äº†è°ƒè¯•ç¬¦å·åçš„ç‰ˆæœ¬) åœ¨agp4.0ä¹‹å: /build/intermediates/cxx/.../obj/...(ç¼–è¯‘äº§ç‰©ï¼Œå¸¦ç¬¦å·) /build/intermediates/merged_native_libs/.../out/lib/...(æ‰“åŒ…å‰ï¼Œä¹Ÿå°±æ˜¯æ±‡æ€»æ‰€æœ‰ä¾èµ–ä¹‹åçš„é›†åˆç›®å½•ï¼Œä¹Ÿæ˜¯æ²¡æœ‰è¢«å‰”é™¤ç¬¦å·çš„so) /build/intermediates/stripped_native_libs/soæ–‡ä»¶(å‰¥ç¦»äº†è°ƒè¯•ç¬¦å·åçš„ç‰ˆæœ¬) è¿™é‡ŒéªŒè¯ä¸‹ä¸‰è€…çš„åŒºåˆ«ï¼š ä½¿ç”¨merged_native_libsä¸‹çš„soï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š 1 /Users/xiangcheng/Library/Android/sdk/ndk/21.3.6528147/toolchains/llvm/prebuilt/darwin-x86_64/bin/aarch64-linux-android-addr2line -C -f -e /Users/xiangcheng/AndroidStudioProjects/NativeProject/app/build/intermediates/merged_native_libs/debug/mergeDebugNativeLibs/out/lib/arm64-v8a/libcrash_monitor.so 0x00644 ç»“æœå¦‚ä¸‹ï¼š å¯ä»¥çœ‹åˆ°ç±»åå’Œè¡Œå·åŸºæœ¬å’Œå‰é¢çš„objç›®å½•ä¸‹çš„soåŸºæœ¬ä¸€è‡´ã€‚ ä½¿ç”¨stripped_native_libsä¸‹çš„soï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š 1 /Users/xiangcheng/Library/Android/sdk/ndk/21.3.6528147/toolchains/llvm/prebuilt/darwin-x86_64/bin/aarch64-linux-android-addr2line -C -f -e /Users/xiangcheng/AndroidStudioProjects/NativeProject/app/build/intermediates/stripped_native_libs/debug/stripDebugDebugSymbols/out/lib/arm64-v8a/libcrash_monitor.so 0x00644 ç»“æœå¦‚ä¸‹ï¼š æ­¤å¤„ç”±äºtestNativeCrashæ–¹æ³•æ˜¯ä¸€ä¸ªjniæ–¹æ³•ï¼Œä¸ä¼šè¢«æ··æ·†æ–¹æ³•åï¼Œä½†æ˜¯è¡Œå·ä¿¡æ¯æ˜¯ä¸¢å¤±äº†ï¼Œå¯ä»¥çœ‹å‡ºæ¥stripä¹‹åçš„soæ˜¯ä¸å¸¦æœ‰è¡Œå·ä¿¡æ¯ã€‚ æ‰“è¿›apkä¸­çš„soæ˜¯å‰¥ç¦»è°ƒè¯•ç¬¦å·çš„soå—ï¼Ÿ ä¸ä¸€å®šæ˜¯ã€‚å¦‚æœæ²¡æœ‰å¼€å¯stripï¼Œé‚£å°±å–çš„æ˜¯merged_native_libsç›®å½•ä¸‹çš„ã€‚å¦åˆ™å–çš„æ˜¯stripped_native_libsç›®å½•ä¸‹çš„soæ–‡ä»¶ ndk-stack å®ƒæ˜¯ndkè‡ªå¸¦å·¥å…·ï¼Œå¯ä»¥ç›´æ¥è§£ælogcatå´©æºƒå †æ ˆï¼ŒæŠŠpcåç§»æ˜ å°„å›æºç è¡Œ ç”¨æ³•ï¼š 1 ndk-stack -sym /Users/xiangcheng/AndroidStudioProjects/NativeProject/app/build/intermediates/cxx/Debug/6p5m14a5/obj/arm64-v8a -dump log sysï¼šæŒ‡å®šsoçš„è·¯å¾„ï¼Œè¿™é‡Œä¸ç”¨æŒ‡æ˜æ˜¯å“ªä¸€ä¸ªsoï¼Œåªéœ€è¦å®šä½åˆ°cpuæ¶æ„çš„ç±»å‹æ–‡ä»¶å¤¹å°±è¡Œï¼Œdumpï¼šæŒ‡å®šlogçš„åœ°å€ï¼Œæ­¤å¤„çš„logæ˜¯åœ¨ä¸Šé¢crashåï¼Œæˆ‘é€šè¿‡logcatå¯¼å‡ºäº†logã€‚æœ€åè¾“å‡ºçš„å†…å®¹å¦‚ä¸‹ï¼š 1 2 3 4 5 6 ********** Crash dump: ********** Build fingerprint: \\u0027Xiaomi/umi/umi:13/TKQ1.221114.001/V816.0.5.0.TJBCNXM:user/release-keys\\u0027\u0026#34; #00 0x0000000000000644 /data/app/~~uAk5HwqkTX5ikhOJ94KruQ\\u003d\\u003d/com.example.nativelib-nvfAk1bvIIxGrBGSolPLNw\\u003d\\u003d/base.apk!libcrash_monitor.so (Java_com_example_nativelib_CrashActivity_testNativeCrash+28) (BuildId: 3f3fdcb6b22b15038811fa94da4200e7cc25d684)\u0026#34; Java_com_example_nativelib_CrashActivity_testNativeCrash /Users/xiangcheng/AndroidStudioProjects/NativeProject/app/src/main/cpp/signal_crash.cpp:13:8 Crash dump is completed å¯ä»¥çœ‹åˆ°ä¹Ÿæ˜¯å®šä½åˆ°signal_crash.cppæ–‡ä»¶çš„ç¬¬13è¡Œå‡ºç°äº†é—®é¢˜ã€‚ ","date":"2025-08-19T00:00:00Z","permalink":"http://xiangcman.xyz/p/native%E7%9A%84crash%E5%A6%82%E4%BD%95%E5%AE%9A%E4%BD%8D/","title":"Nativeçš„crashå¦‚ä½•å®šä½"},{"content":"plthookæŠ€æœ¯åœ¨nativeçš„hookä»£ç ä¸Šèµ·åˆ°å…³é”®çš„ä½œç”¨ï¼Œnativeçš„å‡½æ•°è°ƒç”¨åˆ†ä¸ºå†…éƒ¨è°ƒç”¨å’Œå¤–éƒ¨è°ƒç”¨ã€‚å†…éƒ¨è°ƒç”¨æŒ‡çš„æ˜¯soå†…éƒ¨çš„æ–¹æ³•è°ƒç”¨ï¼Œå½“soè¢«æ‰“åŒ…å¥½åï¼Œsoå†…éƒ¨çš„æ–¹æ³•éƒ½ä¼šè¢«åˆ†é…ä¸€ä¸ªåç§»åœ°å€ï¼Œæ‰€ä»¥å¦‚æœæ˜¯å†…éƒ¨å‡½æ•°çš„è°ƒç”¨ï¼Œé‚£ä¹ˆç›´æ¥é€šè¿‡ç¼–è¯‘æœŸé—´ç»™å‡½æ•°åˆ†é…åç§»åœ°å€å°±èƒ½å»è°ƒç”¨å†…éƒ¨çš„å…¶å®ƒæ–¹æ³•ã€‚ å¦‚æœæ˜¯å¤–éƒ¨è°ƒç”¨ï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨å…¶å®ƒsoçš„æ–¹æ³•ï¼Œå°±åªèƒ½é€šè¿‡ç»å¯¹åœ°å€æ¥è°ƒç”¨äº†ï¼Œä¹Ÿå°±æ˜¯è¯¥å¤–éƒ¨soçš„é¦–åœ°å€+å‡½æ•°çš„åç§»åœ°å€ã€‚æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªä¾‹å­æ¥è¯´æ˜å¤–éƒ¨è°ƒç”¨çš„è¿‡ç¨‹ï¼š\n1 2 3 4 5 6 extern \u0026#34;C\u0026#34; JNIEXPORT void JNICALL Java_com_example_nativelib_MainActivity_MallocLeak(JNIEnv *env, jobject thiz) { malloc(88 * 1000 * 1000); __android_log_print(ANDROID_LOG_DEBUG, \u0026#34;hookMallocByPLTHook\u0026#34;, \u0026#34;åŸæ¥çš„mallocå‡½æ•°è¢«è°ƒç”¨\u0026#34;); } è¿™é‡Œæˆ‘åœ¨jniçš„æ–¹æ³•MallocLeakæ–¹æ³•ä¸­è°ƒç”¨äº†mallocæ–¹æ³•ï¼Œå®ƒæ˜¯lic.soåº“ä¸­çš„æ–¹æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬è®¤ä¸ºå®ƒæ˜¯ä¸€ä¸ªå¤–éƒ¨è°ƒç”¨çš„æ–¹æ³•ã€‚ jniæ–¹æ³•è§£é‡Šï¼šextern \u0026ldquo;C\u0026rdquo;ï¼Œå‘Šè¯‰c++ç¼–è¯‘å™¨ï¼Œè¯¥æ–¹æ³•æ˜¯ä¸€ä¸ªjniçš„æ–¹æ³•ï¼Œä½ ä¸èƒ½æ··æ·†è¯¥æ–¹æ³•ï¼Œè¦ä¸ç„¶javaå±‚æ‰¾ä¸åˆ°è¯¥æ–¹æ³•çš„ç­¾åã€‚ä¸‹é¢çš„__android_log_printæ˜¯è°ƒç”¨äº†androidåº“çš„logæ–¹æ³•ï¼Œç”¨è¯¥æ–¹æ³•çš„æ—¶å€™éœ€è¦å¯¼å…¥android/log.hï¼ŒJNIEXPORT void JNICALLæ˜¯ä¸€ä¸ªè·¨å¹³å°çš„ä¸¤ä¸ªå®å®šä¹‰ã€‚ä¸€èˆ¬åœ¨windowså¹³å°ä¸Šå¦‚ä½•æ²¡æœ‰è¯¥å®ä¼šæŠ¥é”™ã€‚åœ¨jniæ–¹æ³•å‚æ•°ä¸Šæœ‰ä¸¤ä¸ªï¼Œä¸€ä¸ªjniç¯å¢ƒçš„æ–¹æ³•ï¼Œå®ƒæ˜¯ä¸€ä¸ªæŒ‡é’ˆå˜é‡ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯javaå±‚è°è°ƒç”¨çš„å¯¹è±¡ï¼Œæ¯”å¦‚æˆ‘ç¤ºä¾‹ä¸­æ˜¯é€šè¿‡MainActivityè°ƒç”¨çš„ï¼Œé‚£ä¹ˆæ­¤å¤„çš„jobjectå°±æ˜¯MainActivityå¯¹è±¡ã€‚ åœ¨javaå±‚å°±åº”è¯¥æœ‰è¯¥nativeæ–¹æ³•çš„å®šä¹‰ã€‚\n1 external fun MallocLeak() åœ¨kotlinä»£ç ä¸­æ²¡æœ‰nativeå…³é”®å­—ï¼Œç”¨externalå…³é”®å­—å®šä¹‰nativeæ–¹æ³•ã€‚ä¸‹é¢æˆ‘ä»¬å†æ¥çœ‹ä¸‹CMakeLists.txtæ–‡ä»¶ï¼Œå®ƒæ˜¯ç”¨æ¥å®šä¹‰ä¼šæ„å»ºå“ªå‡ ä¸ªsoåº“ï¼Œä»¥åŠæ¯ä¸€ä¸ªsoåº“æ˜¯ç”±é‚£äº›cå±‚ä»£ç æ„å»ºçš„ã€‚ä»¥åŠæ¯ä¸€ä¸ªsoåº“å®ƒæ‰€éœ€è¦ä¾èµ–çš„å…¶å®ƒä¸‰æ–¹åº“æœ‰å“ªäº›ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 //å®šä¹‰cmakeçš„ç¼–è¯‘ç‰ˆæœ¬ cmake_minimum_required(VERSION 3.22.1) //ç”¨æ¥å®šä¹‰nativeé¡¹ç›®çš„åå­—ï¼Œæˆ‘æ„Ÿè§‰æ²¡æœ‰å®é™…æ„ä¹‰ project(\u0026#34;nativelib\u0026#34;) #æŸ¥æ‰¾å¹¶å¼•å…¥ä¸€ä¸ªå¤–éƒ¨åº“bytehookï¼Œè¦æ±‚å¿…é¡»æ‰¾åˆ°å®ƒï¼ˆREQUIREDï¼‰ï¼Œå¹¶ä¸”ä»¥Configæ¨¡å¼æŸ¥æ‰¾ï¼ˆå¯»æ‰¾ bytehookConfig.cmakeæˆ–ç±»ä¼¼æ–‡ä»¶ï¼‰ find_package(bytehook REQUIRED CONFIG) #æ­¤å¤„çš„CMAKE_PROJECT_NAMEå°±æ˜¯projectä¸­å®šä¹‰nativelibå­—ç¬¦ä¸² #å£°æ˜è¦ç¼–è¯‘ç”Ÿæˆä¸€ä¸ªåº“ï¼Œåº“çš„åå­—æ˜¯CMAKE_PROJECT_NAMEï¼Œä¹Ÿå°±æ˜¯nativelib.so #SHAREDï¼šè¡¨ç¤ºç”Ÿæˆä¸€ä¸ª å…±äº«åº“ï¼ˆ.so æ–‡ä»¶ï¼‰ï¼›å¦‚æœæ˜¯ STATICï¼Œåˆ™ä¸º .a é™æ€åº“ã€‚ #native-lib.cppï¼šè¦å‚ä¸ç¼–è¯‘çš„æºæ–‡ä»¶ add_library(${CMAKE_PROJECT_NAME} SHARED native-lib.cpp) #ä¸ºä½ ç”Ÿæˆçš„åº“æ·»åŠ é“¾æ¥ä¾èµ– #æ­¤å¤„æ€»å…±æ·»åŠ 3ä¸ªä¾èµ–åº“ #android:é“¾æ¥Android NDKæä¾›çš„libandroid.so #log:é“¾æ¥Androidæ—¥å¿—åº“liblog.soï¼Œç”¨äº __android_log_print() ç­‰å‡½æ•° #bytehook::bytehook:é“¾æ¥bytehookè¿™ä¸ªç¬¬ä¸‰æ–¹åº“ï¼ˆå‰ææ˜¯å·²é€šè¿‡find_packageå¼•å…¥ï¼‰ target_link_libraries(${CMAKE_PROJECT_NAME} android log bytehook::bytehook) #ç”Ÿæˆä¸€ä¸ªanr_monitor.soçš„åº“ add_library(anr_monitor SHARED signal-anr.cpp) target_link_libraries(anr_monitor android log bytehook::bytehook) ä¸Šé¢çš„cmakeæ„å»ºæ–‡ä»¶ä¸­ï¼Œæˆ‘å®šä¹‰äº†è¦æ„å»ºä¸¤ä¸ªsoï¼Œå…¶ä¸­ä¸€ä¸ªsoå«nativelib.soï¼Œå¦å¤–ä¸€ä¸ªå«anr_monitor.soã€‚åœ¨å®šä¹‰ä¹‹å‰æˆ‘å®šä¹‰äº†ä¸€ä¸ªfind_packageæ–¹æ³•ï¼Œç”¨æ¥å¼•å…¥ä¸€ä¸ªå¤–éƒ¨åº“bytehookã€‚add_libraryæ–¹æ³•è¡¨ç¤ºè¦æ„å»ºçš„soç”±å“ªäº›c/c++ç±»ã€‚target_link_librariesæ–¹æ³•è¡¨ç¤ºè¯¥soåº“éœ€è¦å“ªäº›ä¸‰æ–¹åº“çš„æ”¯æŒï¼Œæ¯”å¦‚android log bytehook::bytehookæ˜¯æˆ‘ä»¬è¦åœ¨c++ä»£ç ä¸­ä½¿ç”¨çš„ä¸‰æ–¹åº“ã€‚å¦‚æœè¦ç”Ÿæˆæ›´å¤šçš„soï¼Œä¾æ¬¡ç±»æ¨ã€‚ åœ¨ä¸Šé¢çš„nativelib.soçš„æ„å»ºè¿‡ç¨‹ä¸­ï¼Œå‚ä¸ç¼–è¯‘çš„æ–‡ä»¶æ˜¯native-lib.cppï¼Œå‰é¢æˆ‘ä»¬å·²ç»ä»‹ç»è¿‡jniæ–¹æ³•Java_com_example_nativelib_MainActivity_MallocLeakã€‚åœ¨å®ƒé‡Œé¢è°ƒç”¨äº†å¤–éƒ¨soçš„æ–¹æ³•mallocæ¥ç”³è¯·å†…å­˜ï¼Œmallocæ–¹æ³•æ˜¯lic.soå¤–éƒ¨åº“çš„æ–¹æ³•ï¼Œæˆ‘ä»¬çš„ç›®çš„æ˜¯é€šè¿‡plthookæŠ€æœ¯æ¥å®ç°mallocæ–¹æ³•çš„ç›‘å¬ï¼Œä»è€Œåšè‡ªå·±çš„äº‹æƒ…ã€‚å‰é¢å·²ç»è®²è¿‡plthookæŠ€æœ¯å…¶å®æ˜¯é€šè¿‡æ‹¦æˆªå¤–éƒ¨soçš„æ–¹æ³•è°ƒç”¨ï¼Œå…·ä½“å®ƒæ˜¯é€šè¿‡soå†…éƒ¨çš„pltè¡¨è·³è½¬åˆ°å¤–éƒ¨çš„å‡½æ•°å¯¹åº”çš„gotè¡¨çš„ä»£ç æ®µï¼Œè€Œåœ¨gotè¡¨ä¸­è®°å½•äº†å¤–éƒ¨å‡½æ•°çš„åœ°å€ã€‚åœ¨ç¨‹åºè¿è¡Œæ—¶ï¼ŒåŠ¨æ€é“¾æ¥å™¨ä¼šæ ¹æ®å‡½æ•°çš„ç¬¦å·ä¿¡æ¯ï¼Œå°†å‡½æ•°çš„çœŸå®åœ°å€å›å†™åˆ°gotè¡¨ä¸­ï¼Œä»è€Œå®ç°å‡½æ•°çš„åŠ¨æ€è°ƒç”¨ã€‚è€ŒplthookæŠ€æœ¯å…¶å®å°±æ˜¯ä¿®æ”¹gotè¡¨ä¸­è®°å½•çš„çœŸå®åœ°å€ï¼Œæ”¹ä¸ºæˆ‘ä»¬çš„è‡ªå®šä¹‰æ–¹æ³•çš„åœ°å€ã€‚è€Œåœ¨è‡ªå®šä¹‰æ–¹æ³•ä¸­ï¼Œé€šè¿‡è°ƒç”¨åŸå‡½æ•°çš„åœ°å€æ¥å®ç°åŸå‡½æ•°çš„è°ƒç”¨ã€‚ ä¸‹é¢æˆ‘ä»¬é€šè¿‡bhookæ¡†æ¶æ¥å®ç°å¤–éƒ¨å‡½æ•°è°ƒç”¨çš„æ‹¦æˆªï¼š\n1 2 3 4 5 6 7 8 9 10 11 extern \u0026#34;C\u0026#34; JNIEXPORT void JNICALL Java_com_example_nativelib_MainActivity_loadAddress(JNIEnv *env, jobject thiz) { bytehook_stub_t stub = bytehook_hook_single( \u0026#34;libnativelib.so\u0026#34;, nullptr, \u0026#34;malloc\u0026#34;, reinterpret_cast\u0026lt;void *\u0026gt;(\u0026amp;malloc_hook_by_plt), hacker_bytehook_strlen_hooked, nullptr); } è¿™é‡Œæˆ‘å®šä¹‰äº†ä¸€ä¸ªjniçš„æ–¹æ³•ï¼Œå®ƒçš„è°ƒç”¨éœ€è¦åœ¨ä¸Šé¢jniæ–¹æ³•Java_com_example_nativelib_MainActivity_MallocLeakä¹‹å‰ã€‚å› ä¸ºåªæœ‰å…ˆç›‘å¬ï¼Œåé¢è°ƒç”¨çš„æ—¶å€™æ‰èƒ½ç›‘å¬åˆ°ã€‚bytehook_hook_singleæ–¹æ³•æ˜¯bhookæ¡†æ¶ä¸­çš„æ–¹æ³•ï¼Œå®ƒæ˜¯bhookæ¡†æ¶ä¸­çš„æ–¹æ³•ï¼Œç”¨äºhookè¿›ç¨‹ä¸­çš„å•ä¸ªè°ƒç”¨è€…åŠ¨æ€åº“çš„æŸä¸ªæ–¹æ³•ã€‚ç¬¬ä¸€ä¸ªå‚æ•°æŒ‡å®šä½œç”¨äºåœ¨å“ªä¸ªsoä¸Šï¼Œæ­¤å¤„çš„mallocæ–¹æ³•æ‹¦æˆªæ˜¯åœ¨libnativelib.soåº“ä¸­çš„Java_com_example_nativelib_MainActivity_MallocLeakæ–¹æ³•è°ƒç”¨çš„ã€‚ç¬¬äºŒä¸ªå‚æ•°æ˜¯è¢«è°ƒç”¨soçš„åå­—ï¼Œæ­¤å¤„æˆ‘ä¼ çš„æ˜¯nullptrï¼Œå…¶å®å®ƒæ˜¯lic.soçš„æ–¹æ³•ï¼Œæ­¤å¤„å¦‚æœæœ‰å¤šä¸ªåº“ä¸­å‡ºç°äº†mallocæ–¹æ³•ï¼Œè¯¥å‚æ•°éœ€è¦åˆ¶å®šã€‚ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯æ–¹æ³•åã€‚ç¬¬å››ä¸ªå‚æ•°æ˜¯è¢«hookæ—¶å€™çš„æ–¹æ³•æŒ‡é’ˆï¼Œæ­¤å¤„è¦æ±‚ç±»å‹æ˜¯void *ï¼Œåœ¨c++/cä¸­è¡¨ç¤ºæŒ‡å‘æœªçŸ¥ç±»å‹çš„æŒ‡é’ˆï¼Œä¹Ÿå«é€šç”¨æŒ‡é’ˆã€‚è€Œreinterpret_castæ˜¯c++/cä¸­çš„å¼ºè½¬ã€‚ ä¸‹é¢æ¥äº†è§£ä¸‹c++ä¸­çš„å‡ ç§å¼ºè½¬ï¼š\nstatic_cast(expr) åšç±»å‹ä¹‹é—´çš„è½¬æ¢ï¼Œä½œç”¨äºç¼–è¯‘æœŸæ£€æŸ¥ï¼Œè¿è¡Œæ—¶ä¸æ£€æŸ¥ã€‚æ¯”å¦‚åŸºç¡€ç±»å‹ä¹‹é—´è½¬æ¢ï¼ˆint-\u0026gt;doubleï¼‰ æœ‰ç»§æ‰¿å…³ç³»çš„æŒ‡é’ˆæˆ–å¼•ç”¨ä¹‹é—´çš„è½¬æ¢(å‘ä¸Šè½¬å‹å®‰å…¨ï¼Œå‘ä¸‹è½¬å‹éœ€è‡ªå·±ä¿è¯å®‰å…¨) void* â†” å…·ä½“ç±»å‹ ä¸¾ä¾‹è¯´æ˜ï¼š åŸºæœ¬ç±»å‹è½¬æ¢ 1 2 3 int i = 10; double d = static_cast\u0026lt;double\u0026gt;(i);//int-\u0026gt;doubleç±»å‹ cout \u0026lt;\u0026lt;\u0026#34;æ•°å€¼æ˜¯:\u0026#34;\u0026lt;\u0026lt; d \u0026lt;\u0026lt; endl; void*è½¬æˆå…·ä½“ç±»å‹ 1 2 3 4 int i = 10; void *p = \u0026amp;i;//å°†içš„åœ°å€ç»™åˆ°æŒ‡é’ˆp int *pi = static_cast\u0026lt;int*\u0026gt;(p);//å°†pçš„æŒ‡é’ˆå¼ºè½¬æˆintç±»å‹çš„æŒ‡é’ˆ cout \u0026lt;\u0026lt; \u0026#34;piæŒ‡é’ˆå­˜å‚¨çš„å€¼æ˜¯ = \u0026#34; \u0026lt;\u0026lt; *pi \u0026lt;\u0026lt; endl;//å–å€¼æ“ä½œ é‚£ä»€ä¹ˆæ˜¯ç¼–è¯‘æœŸæ£€æŸ¥çš„ç±»å‹å‘¢ï¼Ÿæˆ‘ä»¬é€šè¿‡ä¸‹é¢ä¸€ä¸ªä¾‹å­æ¥è¯´æ˜: 1 2 class Base{}; class Derived : public Base{}; è¿™é‡Œæˆ‘å®šä¹‰äº†ä¸€ä¸ªçˆ¶ç±»å’Œä¸€ä¸ªå­ç±»ï¼Œç„¶åé€šè¿‡static_castèƒ½å°†å­ç±»ç±»å‹æŒ‡å‘çˆ¶ç±»ç±»å‹ï¼š 1 2 Derived* derived = new Derived(); Base* base = static_cast\u0026lt;Base*\u0026gt;(derived); è¿™é‡Œç›´æ¥èƒ½å°†å­ç±»æŒ‡é’ˆæŒ‡å‘çˆ¶ç±»æŒ‡é’ˆã€‚ä¸‹é¢ä¸¾ä¸ªä¸èƒ½è¢«æŒ‡å‘çš„ä¾‹å­ï¼š 1 2 3 4 struct A {}; struct B {}; A* a = new A(); B* b = static_cast\u0026lt;B*\u0026gt;(a); // âŒ æŠ¥é”™ï¼šæ²¡æœ‰ A* -\u0026gt; B* çš„è½¬æ¢è§„åˆ™ dynamic_cast(expr) è¿è¡Œæ—¶ç±»å‹å®‰å…¨è½¬æ¢ï¼Œä¸»è¦ç”¨äºå¤šæ€ç±»ï¼ˆå«æœ‰ è™šå‡½æ•°è¡¨ çš„ç±»ï¼‰ã€‚å‘ä¸‹è½¬æ¢æ—¶ï¼Œä¼šåœ¨è¿è¡Œæ—¶æ£€æŸ¥ï¼Œå¤±è´¥åˆ™è¿”å›nullptrï¼ˆæŒ‡é’ˆæƒ…å†µï¼‰ï¼Œæˆ–æŠ›å‡ºstd::bad_castï¼ˆå¼•ç”¨æƒ…å†µï¼‰ã€‚ 1 2 3 4 5 6 7 8 class Base{virtual void fun(){}}; class Derived : public Base{}; Base* base = new Derived(); Derived* derived = dynamic_cast\u0026lt;Derived*\u0026gt;(base); std::cout \u0026lt;\u0026lt;\u0026#34;è½¬æ¢åçš„ç»“æœï¼š\u0026#34;\u0026lt;\u0026lt; derived \u0026lt;\u0026lt;std::endl; if (derived) { std::cout \u0026lt;\u0026lt; \u0026#34;è½¬æ¢æˆåŠŸ\u0026#34;\u0026lt;\u0026lt;std::endl; } ä¸Šé¢å¯ä»¥é€šè¿‡dynamic_castè½¬æ¢å°†å­ç±»ç±»å‹çš„æŒ‡é’ˆè½¬æ¢æˆçˆ¶ç±»ç±»å‹çš„æŒ‡é’ˆã€‚ä¸Šé¢å¦‚æœBaseä¸­æ²¡æœ‰å®šä¹‰è™šå‡½æ•°ï¼Œåˆ™åœ¨dynamic_castç¼–è¯‘æœŸå°±ä¼šæç¤ºé”™è¯¯ã€‚åœ¨ä¸Šé¢ä¾‹å­ä¸­derivedä¸ä¼šä¸ºç©ºï¼Œä»€ä¹ˆå«è¿è¡Œæ—¶å®‰å…¨è½¬æ¢å‘¢ï¼Ÿä¸‹é¢é€šè¿‡ä¸€ä¸ªä¸æ˜¯ç»§æ‰¿å…³ç³»æ¥è¯´æ˜é—®é¢˜ï¼š 1 2 3 4 5 6 7 8 class Base{virtual void fun(){}}; class Derived {}; Base* base = new Base(); Derived* derived = dynamic_cast\u0026lt;Derived*\u0026gt;(base); std::cout \u0026lt;\u0026lt;\u0026#34;è½¬æ¢åçš„ç»“æœï¼š\u0026#34;\u0026lt;\u0026lt; derived \u0026lt;\u0026lt;std::endl; if (derived == nullptr) { std::cout \u0026lt;\u0026lt; \u0026#34;è½¬æ¢åä¸ºç©º\u0026#34;\u0026lt;\u0026lt;std::endl; } åœ¨ä¸Šé¢ä»£ç ä¸­ï¼ŒDerivedä¸æ˜¯ç»§æ‰¿è‡ªBaseï¼Œå¹¶ä¸”åœ¨ç”¨dynamic_castæ—¶å€™ï¼Œç¼–è¯‘æœŸä¸ä¼šæŠ¥é”™ï¼Œå¦‚æœç”¨ä¸Šé¢çš„static_castå°±ä¼šæŠ¥é”™äº†ã€‚ä½†æ˜¯åœ¨è¿è¡ŒæœŸå¾—åˆ°çš„ç»“æœå°±æ˜¯nullptrã€‚ const_cast(expr) å»é™¤æˆ–æ·»åŠ  constã€volatile ä¿®é¥°ç¬¦ å”¯ä¸€èƒ½å»æ‰ const çš„ cast ä¸èƒ½ç”¨äºä¸åŒç±»å‹ä¹‹é—´çš„è½¬æ¢ å¦‚æœåŸå¯¹è±¡æœ¬èº«æ˜¯ const çš„ï¼Œå»æ‰ const åä¿®æ”¹ä¼šå¯¼è‡´ æœªå®šä¹‰è¡Œä¸ºã€‚ 1 2 3 4 5 const int a = 10; int* p = const_cast\u0026lt;int*\u0026gt;(\u0026amp;a); *p = 20; std::cout \u0026lt;\u0026lt; \u0026#34;a=\u0026#34;\u0026lt;\u0026lt; a \u0026lt;\u0026lt;std::endl;//a=10 std::cout \u0026lt;\u0026lt; \u0026#34;p=\u0026#34;\u0026lt;\u0026lt; *p \u0026lt;\u0026lt;std::endl;//p=20 æ­¤å¤„å®šä¹‰äº†const aç­‰äº10ï¼Œåœ¨åé¢è™½ç„¶æŠŠpæŒ‡é’ˆæŒ‡å‘aï¼Œæ”¹å˜pçš„å€¼åï¼Œå¯¹aæ²¡æœ‰å½±å“ã€‚ reinterpret_cast(expr) åº•å±‚äºŒè¿›åˆ¶çº§åˆ«çš„é‡æ–°è§£é‡Šã€‚ ä¸å®‰å…¨ï¼Œä¸æ£€æŸ¥ç±»å‹ã€‚ å¸¸ç”¨äºæŒ‡é’ˆä¹‹é—´çš„çš„è½¬æ¢ã€æŒ‡é’ˆå’Œæ•´æ•°ä¹‹é—´çš„è½¬æ¢ã€‚ åªæ˜¯ç®€å•åœ°â€œè§£é‡Šâ€æ¯”ç‰¹ä½ï¼Œæ²¡æœ‰è¯­ä¹‰ä¸Šçš„è½¬æ¢ã€‚ ä¸¾ä¸ªæŒ‡é’ˆè½¬åŒ–æˆlongç±»å‹çš„ä¾‹å­ï¼š 1 2 3 4 5 6 int i =10; int* p2 = \u0026amp;i; std::cout \u0026lt;\u0026lt; \u0026#34;p2=\u0026#34;\u0026lt;\u0026lt; *p2 \u0026lt;\u0026lt;std::endl; std::cout \u0026lt;\u0026lt; \u0026#34;p2çš„åœ°å€å€¼=\u0026#34;\u0026lt;\u0026lt; p2 \u0026lt;\u0026lt;std::endl; long s = reinterpret_cast\u0026lt;long\u0026gt;(p2); std::cout \u0026lt;\u0026lt; \u0026#34;sçš„å€¼æ˜¯:\u0026#34; \u0026lt;\u0026lt; s \u0026lt;\u0026lt;std::endl; p2æŒ‡å‘äº†å˜é‡içš„åœ°å€ï¼Œæ¥ç€ä½¿ç”¨reinterpret_castå°†p2è¿™ä¸ªæŒ‡é’ˆè½¬åŒ–æˆlongç±»å‹ã€‚ å†æ¥ä¸¾ä¸€ä¸ªæŒ‡é’ˆå˜æˆå¦å¤–ä¸€ä¸ªæŒ‡é’ˆçš„ä¾‹å­ï¼š 1 2 3 4 Base* base2 = new Base(); std::cout \u0026lt;\u0026lt; \u0026#34;base2:\u0026#34;\u0026lt;\u0026lt;base2\u0026lt;\u0026lt;std::endl; Derived* derived2 = reinterpret_cast\u0026lt;Derived*\u0026gt;(base2); std::cout \u0026lt;\u0026lt; \u0026#34;derived2:\u0026#34;\u0026lt;\u0026lt; derived2 \u0026lt;\u0026lt;std::endl; ä¸Šé¢ä½¿ç”¨reinterpret_castèƒ½ç›´æ¥å°†base2çš„æŒ‡é’ˆç›´æ¥å¼ºè½¬åˆ°derived2ä¸Šï¼Œä»ç»“æœæ¥çœ‹ï¼Œbase2å’Œderived2çš„æŒ‡é’ˆå€¼éƒ½æ˜¯ä¸€æ ·çš„ï¼Œåœ¨ä¸Šé¢è®²çš„const_castå®ƒæ˜¯å¾—åˆ°ä¸€ä¸ªé»˜è®¤æŒ‡é’ˆï¼Œä¹Ÿå°±æ˜¯nullptrã€‚ å›åˆ°ä¸Šé¢jniçš„æ‹¦æˆªæ–¹æ³•é‡Œé¢ï¼Œå®ƒæ˜¯å°†malloc_hook_by_pltè¿™ä¸ªå‡½æ•°é€šè¿‡å–å€ç¬¦(\u0026amp;)æ¥è·å–åˆ°å‡½æ•°çš„åœ°å€ï¼Œæ¥ç€é€šè¿‡reinterpret_castå¼ºè½¬æ“ä½œç¬¦è½¬åŒ–æˆvoid*ç±»å‹çš„æŒ‡é’ˆï¼Œå®ƒæ˜¯c/c++ä¸­çš„ä»»ä½•æŒ‡é’ˆç±»å‹ã€‚æˆ‘ä»¬æ¥çœ‹ä¸‹malloc_hook_by_pltå‡½æ•°ï¼š\n1 2 3 4 5 6 7 8 9 10 size_t malloc_hook_by_plt(size_t len) { __android_log_print(ANDROID_LOG_DEBUG, \u0026#34;hookMallocByPLTHook\u0026#34;, \u0026#34;origin malloc size:%d\u0026#34;, len); if (len \u0026gt; 20 * 1024 * 1024) { __android_log_print(ANDROID_LOG_DEBUG, \u0026#34;hookMallocByPLTHook\u0026#34;, \u0026#34;do somethings\u0026#34;); //å †æ ˆæ‰“å° // printNativeStack(); } //è°ƒç”¨åŸæ¥çš„å‡½æ•° return hacker_orig_strlen(len); } é¦–å…ˆè¯¥å‡½æ•°çš„è¿”å›å€¼ç±»å‹æ˜¯size_tï¼Œå®ƒè¡¨ç¤ºçš„æ˜¯æ— ç¬¦å·çš„intå€¼ï¼Œåœ¨32ä½æœºå™¨ä¸Šï¼Œå®ƒæ˜¯4å­—èŠ‚ï¼Œ64ä½æœºå™¨ä¸Šï¼Œå®ƒæ˜¯8å­—èŠ‚ï¼Œä¸€èˆ¬ç”¨æ¥è¡¨ç¤ºåœ°å€å€¼ã€‚æ¥ç€å‡½æ•°çš„å‚æ•°ä¹Ÿæ˜¯ä¸€ä¸ªsize_tå€¼ï¼Œå®ƒæ˜¯å’Œæˆ‘ä»¬çš„mallocå‡½æ•°çš„å‚æ•°å¯¹åº”ï¼Œè¡¨ç¤ºç”³è¯·çš„å†…å­˜å¤§å°ã€‚æ¥ç€æˆ‘ä»¬è¾“å‡ºandroidçš„logï¼Œå¦‚æœç”³è¯·çš„å†…å­˜å¤§äº20Mçš„æ—¶å€™ï¼Œä¹Ÿè¾“å‡ºandroidçš„logï¼Œæœ€åè¿”å›åŸæ¥å‡½æ•°çš„åœ°å€å€¼ã€‚æˆ‘ä»¬çœ‹ä¸‹hacker_orig_strlenå‡½æ•°ï¼Œå®ƒæ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆç±»å‹ï¼š\n1 2 typedef size_t (*hacker_strlen_t)(const size_t); static hacker_strlen_t hacker_orig_strlen = nullptr; æ­¤å¤„ä½¿ç”¨typedefæ˜¯ç»™å½“å‰å‡½æ•°æŒ‡é’ˆèµ·ä¸€ä¸ªåˆ«åï¼Œåå­—å«hacker_strlen_tï¼Œå‡½æ•°çš„è¿”å›å€¼æ˜¯size_tï¼Œç¬¬äºŒè¡Œå®šä¹‰äº†ä¸€ä¸ªhacker_strlen_tç±»å‹çš„å‡½æ•°ã€‚æ­¤å¤„ä¸ºä»€ä¹ˆè¦è¿™æ ·å®šä¹‰å‡½æ•°æŒ‡é’ˆå‘¢ï¼Ÿæˆ‘ä»¬å›åˆ°ä¸Šé¢çš„è°ƒç”¨å°±çŸ¥é“äº†ï¼Œmalloc_hook_by_pltæ–¹æ³•éœ€è¦ä¸€ä¸ªsize_tç”¨æ¥è¡¨ç¤ºnew_funcçš„åœ°å€ï¼Œå‚æ•°å’Œmallocæ–¹æ³•çš„å‚æ•°ä¸€è‡´ã€‚è¿™ä¸ªåœ¨hockçš„æ—¶å€™éœ€è¦çŸ¥é“ç”³è¯·çš„å†…å­˜å¤§å°ï¼Œhacker_orig_strlenå‡½æ•°æŒ‡é’ˆæ˜¯ä»€ä¹ˆæ—¶å€™åˆå§‹åŒ–çš„å‘¢ï¼Ÿå®ƒæ˜¯åœ¨hacker_bytehook_strlen_hookedæ–¹æ³•ä¸­è¢«èµ‹å€¼çš„ï¼š\n1 2 3 4 5 6 7 8 9 static void hacker_bytehook_strlen_hooked(bytehook_stub_t task_stub, int status_code, const char *caller_path_name, const char *sym_name, void *new_func, void *prev_func, void *arg) { hacker_orig_strlen = (hacker_strlen_t) prev_func;//æ­¤å¤„å½“hookçš„ä¹‹åï¼Œå°†åŸå§‹å‡½æ•°çš„æŒ‡é’ˆèµ‹å€¼ç»™hacker_orig_strlenå˜é‡ï¼Œè¿™æ˜¯cé£æ ¼çš„å¼ºåˆ¶è½¬æ¢ï¼Œä¸å¤ªæ¨èè¿™ç§è½¬æ¢ï¼Œå› ä¸ºè¿™ç§æ— æ³•åŒºåˆ†ç”¨é€”ï¼Œä¸å®‰å…¨ï¼Œä¸æ˜ç¡®ï¼Œå¯èƒ½ç»•è¿‡ç±»å‹æ£€æŸ¥ //caller_path_nameæ­¤å¤„ä¼šè¾“å‡ºlibnativelib.soçš„å®Œæ•´è·¯å¾„ __android_log_print(ANDROID_LOG_DEBUG, \u0026#34;hookMallocByPLTHook\u0026#34;, \u0026#34;caller_path_name:%s\u0026#34;, caller_path_name); //sym_nameæ­¤å¤„ä¼šè¾“å‡ºmallocå‡½æ•°åå­— __android_log_print(ANDROID_LOG_DEBUG, \u0026#34;hookMallocByPLTHook\u0026#34;, \u0026#34;sym_name:%s\u0026#34;, sym_name); } å®ƒæ˜¯bhookä¸­bytehook_hook_singleæ–¹æ³•çš„hookedå‚æ•°è¢«è°ƒç”¨çš„ï¼Œå®ƒè¡¨ç¤ºplthookè¿‡ç¨‹ä¸­è¢«hookedæ—¶å€™è°ƒç”¨çš„æ–¹æ³•ï¼Œä¸‹é¢æ¥åˆ†æä¸‹è¯¥æ–¹æ³•ï¼š\nè¯¥å‡½æ•°çš„å®šä¹‰æ˜¯ç”¨äºhookæˆåŠŸåä¿å­˜åŸå§‹å‡½æ•°æŒ‡é’ˆ staticè¡¨ç¤ºè¯¥å‡½æ•°åªèƒ½åœ¨å½“å‰æºæ–‡ä»¶ä¸­å¯è§ï¼ˆå±€éƒ¨é“¾æ¥ï¼‰ task_stubï¼šhookæ“ä½œçš„å¥æŸ„ï¼Œbhookç”¨æ¥æ ‡è¯†ä¸€æ¬¡hookä»»åŠ¡ status_codeï¼šçŠ¶æ€ç ï¼Œè¡¨ç¤ºhookæ˜¯å¦æˆåŠŸï¼Œåœ¨bytehook.hä¸­å®šä¹‰äº†BYTEHOOK_STATUS_CODE_OKï¼Œè¡¨ç¤ºhookæˆåŠŸ caller_path_nameï¼šè¿™æ˜¯ä¸€ä¸ªæŒ‡å‘å¸¸é‡å­—ç¬¦çš„æŒ‡é’ˆï¼Œåœ¨cå’Œc++ä¸­ï¼Œå­—ç¬¦ä¸²ä¸æ˜¯ä¸€ä¸ªå•ç‹¬çš„ç±»å‹ï¼Œè€Œæ˜¯ç”±å­—ç¬¦æ•°ç»„å®ç°çš„ï¼Œè€ŒæŒ‡é’ˆå¯ä»¥ç”¨æ¥æŒ‡å‘ä¸€ä¸²å­—ç¬¦çš„æŒ‡é’ˆï¼Œæ‰€ä»¥æ¬¡æ•°ç”¨char *ï¼Œå‰é¢åŠ constè¡¨ç¤ºè¯¥å‡½æ•°ä¸­ä¸èƒ½ä¿®æ”¹è¯¥å­—ç¬¦ä¸²ï¼Œè°ƒç”¨è€…æ¨¡å—çš„è·¯å¾„,æ˜¯è°è°ƒç”¨äº†è¢«hookçš„å‡½æ•° sym_nameï¼šè¢«hookçš„ç¬¦å·å new_funcï¼šæ–°çš„å‡½æ•°åœ°å€ï¼Œæ­¤å¤„ä½¿ç”¨void *ï¼Œè¡¨ç¤ºçš„æ˜¯æ³›å‹æŒ‡é’ˆï¼Œè¡¨ç¤ºä»»æ„ç±»å‹çš„æŒ‡é’ˆï¼Œå³ä¸€ä¸ªæ²¡æœ‰å…·ä½“ç±»å‹çš„å†…å­˜åœ°å€ï¼Œhookæ¡†æ¶ä¸çŸ¥é“ä½ hookå‡½æ•°åˆ°åº•æ˜¯ä»€ä¹ˆç­¾åï¼Œæ‰€ä»¥åªè¿”å›ä¸€ä¸ªåœ°å€ï¼Œè®©ä½ è‡ªè¡Œè½¬æ¢ä¸ºå¯¹åº”å‡½æ•°æŒ‡é’ˆç±»å‹ prev_funcï¼šè¢«æ›¿æ¢æ‰çš„åŸå‡½æ•°åœ°å€ï¼ˆå¯é€šè¿‡å®ƒè°ƒç”¨åŸå‡½æ•°ï¼‰ argï¼šä½  hook æ—¶ä¼ å…¥çš„è‡ªå®šä¹‰å‚æ•°ï¼Œå¯ä¼  hook æ—¶çš„ä¸Šä¸‹æ–‡ç­‰ åœ¨å‡½æ•°é‡Œé¢å°†prev_funcçš„void*ç±»å‹æŒ‡é’ˆç›´æ¥å¼ºè½¬æˆhacker_strlen_tå‡½æ•°æŒ‡é’ˆï¼Œå…¶å®è¿™ç§å°æ‹¬å·çš„å¼ºè½¬ä¸å¤Ÿè§„èŒƒï¼Œåº”è¯¥ç”¨ä¸Šé¢çš„reinterpret_castæ¥è¿›è¡ŒæŒ‡é’ˆç±»å‹çš„å¼ºè½¬ã€‚æœ€åè¾“å‡ºäº†android logï¼Œæ•´ä¸ªè¿‡ç¨‹å°±ç»“æŸäº†ã€‚\n","date":"2025-08-06T19:20:53+08:00","permalink":"http://xiangcman.xyz/p/%E4%BB%8Eplthook%E5%BC%80%E5%A7%8B%E8%AE%A4%E8%AF%86jni%E5%BC%80%E5%8F%91/","title":"ä»plthookå¼€å§‹è®¤è¯†jniå¼€å‘"},{"content":"å‰é¢ä»‹ç»è¿‡å¦‚ä½•ä½¿ç”¨perfettoè·Ÿè¸ªappçš„é—®é¢˜ï¼Œæœ¬èŠ‚ä¸»è¦å›´ç»•appçš„ä¸»çº¿ç¨‹å¡é¡¿é—®é¢˜ï¼Œä»¥åŠç†Ÿæ‚‰åº”ç”¨ç•Œé¢æ˜¯å¦‚ä½•è¢«æ¸²æŸ“åˆ°å±å¹•ä¸Šçš„ã€‚è¿˜æ˜¯å’Œå¾€å¸¸ä¸€æ ·ï¼Œå…ˆçœ‹ä¸‹æˆ‘é…ç½®çš„è·Ÿè¸ªæ–‡ä»¶config.pbtx:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 buffers: { size_kb: 131072 fill_policy: DISCARD } buffers: { size_kb: 2048 fill_policy: DISCARD } data_sources: { config { name: \u0026#34;android.packages_list\u0026#34; target_buffer: 1 } } data_sources: { config { name: \u0026#34;android.log\u0026#34; android_log_config { log_ids: LID_EVENTS log_ids: LID_CRASH log_ids: LID_KERNEL log_ids: LID_DEFAULT log_ids: LID_RADIO log_ids: LID_SECURITY log_ids: LID_STATS log_ids: LID_SYSTEM } } } data_sources: { config { name: \u0026#34;android.surfaceflinger.frametimeline\u0026#34; } } data_sources: { config { name: \u0026#34;linux.ftrace\u0026#34; ftrace_config { ftrace_events: \u0026#34;sched/sched_switch\u0026#34; ftrace_events: \u0026#34;sched/sched_wakeup\u0026#34; ftrace_events: \u0026#34;sched/sched_blocked_reason\u0026#34; ftrace_events: \u0026#34;power/suspend_resume\u0026#34; ftrace_events: \u0026#34;sched/sched_process_exit\u0026#34; ftrace_events: \u0026#34;sched/sched_process_free\u0026#34; ftrace_events: \u0026#34;task/task_newtask\u0026#34; ftrace_events: \u0026#34;task/task_rename\u0026#34; ftrace_events: \u0026#34;ftrace/print\u0026#34; ftrace_events: \u0026#34;mutex/lock_contention\u0026#34; ftrace_events: \u0026#34;mutex/lock_acquired\u0026#34; ftrace_events: \u0026#34;mutex/lock_release\u0026#34; ftrace_events: \u0026#34;synchronization/lock_acquire\u0026#34; ftrace_events: \u0026#34;synchronization/lock_release\u0026#34; ftrace_events: \u0026#34;sync/sync_timeline_wait\u0026#34; ftrace_events: \u0026#34;mm_event/page_fault_user\u0026#34; ftrace_events: \u0026#34;io_uring/io_uring_cmd\u0026#34; atrace_categories: \u0026#34;am\u0026#34; atrace_categories: \u0026#34;adb\u0026#34; atrace_categories: \u0026#34;aidl\u0026#34; atrace_categories: \u0026#34;dalvik\u0026#34; atrace_categories: \u0026#34;audio\u0026#34; atrace_categories: \u0026#34;binder_lock\u0026#34; atrace_categories: \u0026#34;binder_driver\u0026#34; atrace_categories: \u0026#34;bionic\u0026#34; atrace_categories: \u0026#34;camera\u0026#34; atrace_categories: \u0026#34;database\u0026#34; atrace_categories: \u0026#34;gfx\u0026#34; atrace_categories: \u0026#34;hal\u0026#34; atrace_categories: \u0026#34;input\u0026#34; atrace_categories: \u0026#34;network\u0026#34; atrace_categories: \u0026#34;nnapi\u0026#34; atrace_categories: \u0026#34;pm\u0026#34; atrace_categories: \u0026#34;power\u0026#34; atrace_categories: \u0026#34;rs\u0026#34; atrace_categories: \u0026#34;res\u0026#34; atrace_categories: \u0026#34;rro\u0026#34; atrace_categories: \u0026#34;sm\u0026#34; atrace_categories: \u0026#34;ss\u0026#34; atrace_categories: \u0026#34;vibrator\u0026#34; atrace_categories: \u0026#34;video\u0026#34; atrace_categories: \u0026#34;view\u0026#34; atrace_categories: \u0026#34;webview\u0026#34; atrace_categories: \u0026#34;wm\u0026#34; atrace_apps: \u0026#34;åº”ç”¨çš„åŒ…å\u0026#34; } } } data_sources: { config { name: \u0026#34;linux.process_stats\u0026#34; target_buffer: 1 process_stats_config { scan_all_processes_on_start: true } } } duration_ms: 10000 ä¸Šé¢é…ç½®äº†ä¸»ç¼“å†²åŒºå’Œæ¬¡ç¼“å†²åŒºçš„å¤§å°ï¼Œæ—¶é•¿ï¼Œftraceç­‰ä¿¡æ¯ã€‚æ¥ç€é€šè¿‡å¦‚ä¸‹å‘½ä»¤è¿›è¡Œè·Ÿè¸ªï¼š\n1 ./record_android_trace -c config.pbtx -o trace_file.perfetto-trace ç„¶åæ“ä½œappåï¼Œè¿‡äº†10sè‡ªåŠ¨æ‰“å¼€è¯¥è·Ÿè¸ªæ–‡ä»¶ã€‚æˆ‘ä»¬æ‰“å¼€\n","date":"2025-06-24T00:00:00Z","permalink":"http://xiangcman.xyz/p/%E4%BD%BF%E7%94%A8perfetto%E8%AF%86%E5%88%AB%E5%8D%A1%E9%A1%BF%E9%97%AE%E9%A2%98/","title":"ä½¿ç”¨perfettoè¯†åˆ«å¡é¡¿é—®é¢˜"},{"content":"ç›®çš„ è¯¥ç¯‡ä¸»è¦ä»‹ç»å¦‚æœåœ¨Androidä¸‹é¢å¯åŠ¨perfettoçš„è·Ÿè¸ªï¼Œæ–¹ä¾¿åé¢èƒ½å¿«é€Ÿä½¿ç”¨perfettoå·¥å…·ã€‚\nå¯åŠ¨è·Ÿè¸ªæœåŠ¡ å¯åŠ¨è·Ÿè¸ªæœåŠ¡åœ¨Android11(R)ä¹‹åæ˜¯é»˜è®¤å¼€å¯çš„ï¼Œåœ¨Android9(P)å’ŒAndroid10(Q)ä¸Šï¼Œéœ€è¦æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼Œç¡®ä¿å·²å¯ç”¨è·Ÿè¸ªæœåŠ¡ï¼š\n1 2 # Needed only on Android 9 (P) and 10 (Q) on non-Pixel phones. adb shell setprop persist.traced.enable 1 å¦‚æœæ˜¯åœ¨Android9ä¹‹å‰çš„ç‰ˆæœ¬ï¼Œèƒ½é€šè¿‡Perfetto è„šæœ¬æ•è·è·Ÿè¸ªè®°å½•record_android_traceã€‚\nè®°å½•è·Ÿè¸ª å‘½ä»¤è¡Œè·Ÿè¸ª record_android_traceè„šæœ¬è·Ÿè¸ª é¦–å…ˆå°†record_android_traceè„šæœ¬ä¸‹è½½ä¸‹æ¥ï¼š 1 2 3 4 //ä¸‹è½½è„šæœ¬ curl -O https://raw.githubusercontent.com/google/perfetto/main/tools/record_android_trace //ç»™è„šæœ¬åˆ†é…æ‰§è¡Œæƒé™ chmod u+x record_android_trace å¼€å§‹è·Ÿè¸ª 1 2 ./record_android_trace -o trace_file.perfetto-trace -t 30s -b 64mb \\ sched freq idle am wm gfx view binder_driver hal dalvik camera input res memory å‘½ä»¤è§£é‡Šï¼š ä¸Šé¢çš„è„šæœ¬ä¸­æ˜¯é€šè¿‡record_android_traceè¿™ä¸ªè„šæœ¬æ”¶é›†ï¼Œæ¥ç€-oåé¢è·Ÿçš„æ˜¯è¾“å‡ºçš„perfettoèƒ½è¯†åˆ«çš„æ–‡ä»¶ï¼Œ-tæ˜¯è·Ÿè¸ªå¤šä¹…çš„æ—¶é—´ï¼Œ-båé¢æ˜¯æœ€å¤§çš„æ–‡ä»¶å¤§å°ï¼Œæœ€åæ˜¯ä¸€å †çš„categoryåˆ†ç±»ã€‚æ”¶é›†å®Œåï¼Œå®ƒä¼šè‡ªåŠ¨åœ¨ui.perfetto.devä¸Šæ‰“å¼€è¯¥traceæ–‡ä»¶ã€‚ä¸Šé¢æ‹¼æ¥çš„åˆ†ç±»æœ‰å¦‚ä¸‹è§£é‡Šï¼š schedï¼šè¿›ç¨‹è°ƒåº¦(Scheduler) freqï¼šCPU é¢‘ç‡å˜åŒ–(CPU Frequency) idleï¼šCPU ç©ºé—²çŠ¶æ€(CPU Idle) amï¼šåº”ç”¨ç”Ÿå‘½å‘¨æœŸã€è¿›ç¨‹è°ƒåº¦ç­‰(Activity Manager) wmï¼šçª—å£ç®¡ç†ã€Activity å¯åŠ¨ç­‰(Window Manager) gfx:å›¾å½¢æ¸²æŸ“ã€SurfaceFlingerã€GPU æ´»åŠ¨ç­‰(Graphics) view:è§†å›¾ç»˜åˆ¶ã€å¸ƒå±€ã€æµ‹é‡ç­‰(View System) binder_driverï¼šè¿›ç¨‹é—´é€šä¿¡ï¼ˆBinder IPCï¼‰ halï¼šç¡¬ä»¶æŠ½è±¡å±‚ï¼ˆHardware Abstraction Layerï¼‰ dalvikï¼šART è¿è¡Œæ—¶ã€GCã€JNI è°ƒç”¨ç­‰ï¼ˆART Runtimeï¼‰ cameraï¼šæ‘„åƒå¤´æ“ä½œï¼ˆCameraï¼‰ inputï¼šè¾“å…¥äº‹ä»¶å¤„ç†ï¼ˆInputï¼‰ resï¼šèµ„æºåŠ è½½ï¼ˆResourceï¼‰ memoryï¼šå†…å­˜åˆ†é…å’Œä½¿ç”¨ï¼ˆMemoryï¼‰ æƒ³è·å–æ›´å¤šçš„ç±»åˆ«ï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹çš„æŒ‡ä»¤è·å–ï¼š\n1 2 adb shell atrace --list_categories atrace \u0026ndash;list_categories åˆ—å‡ºçš„ä¸»è¦æ˜¯ Atrace ç±»åˆ«ã€‚è¿™äº›ç±»åˆ«æ˜¯ Perfetto ä¸­æœ€å¸¸ç”¨çš„ç±»åˆ«ä¹‹ä¸€ã€‚\nä¸€äº›å‚å•†å¯èƒ½ä¼šæ·»åŠ è‡ªå·±çš„è‡ªå®šä¹‰ç±»åˆ«ï¼Œè¿™äº›ä¹Ÿä¼šåœ¨è¿™é‡Œåˆ—å‡ºã€‚\nä½¿ç”¨è®¾å¤‡ä¸Šçš„ /system/bin/perfetto å‘½ä»¤ é¦–å…ˆæˆ‘å¾—è®¾å¤‡æ˜¯Android13çš„ï¼Œæ‰€ä»¥å…·å¤‡é€šè¿‡adbçš„å‘½ä»¤æ¥æŠ“å–è·Ÿè¸ªæ–‡ä»¶ï¼Œéœ€è¦åœ¨å¼€å‘è€…é€‰é¡¹ä¸­é€‰æ‹©è°ƒè¯•åº”ç”¨ä¸ºä½ è¦è°ƒè¯•çš„åº”ç”¨ã€‚\næ¥ç€é€šè¿‡å¦‚ä¸‹å‘½ä»¤æ¥è·Ÿè¸ªï¼š\n1 2 adb shell perfetto -o /data/misc/perfetto-traces/trace_file.perfetto-trace -t 20s \\ sched freq idle am wm gfx view binder_driver hal dalvik camera input res memory æ­¤å¤„çš„å‘½ä»¤å’Œä¸Šé¢record_android_traceè„šæœ¬è·Ÿè¸ªåŸºæœ¬ä¸€è‡´çš„ï¼Œè·Ÿè¸ªå®Œåï¼Œå¯¼å‡ºè¯¥æ–‡ä»¶åˆ°ç”µè„‘ä¸Šï¼š\n1 adb pull /data/misc/perfetto-traces/trace_file.perfetto-trace ~/trace.perfetto-trace æœ€åå°†å¯¼å‡ºçš„traceæ–‡ä»¶æ‹–æ‹½åˆ°ui.perfetto.devä¸­ã€‚\né€šè¿‡é…ç½®æ–‡ä»¶æ¥å¯åŠ¨è·Ÿè¸ª é¦–å…ˆæ¥çœ‹ä¸‹å®˜ç½‘ç»™çš„äº‹ä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 cat\u0026lt;\u0026lt;EOF\u0026gt;config.pbtx duration_ms: 10000 buffers: { size_kb: 8960 fill_policy: DISCARD } buffers: { size_kb: 1280 fill_policy: DISCARD } data_sources: { config { name: \u0026#34;linux.ftrace\u0026#34; ftrace_config { ftrace_events: \u0026#34;sched/sched_switch\u0026#34; ftrace_events: \u0026#34;power/suspend_resume\u0026#34; ftrace_events: \u0026#34;sched/sched_process_exit\u0026#34; ftrace_events: \u0026#34;sched/sched_process_free\u0026#34; ftrace_events: \u0026#34;task/task_newtask\u0026#34; ftrace_events: \u0026#34;task/task_rename\u0026#34; ftrace_events: \u0026#34;ftrace/print\u0026#34; atrace_categories: \u0026#34;gfx\u0026#34; atrace_categories: \u0026#34;view\u0026#34; atrace_categories: \u0026#34;webview\u0026#34; atrace_categories: \u0026#34;camera\u0026#34; atrace_categories: \u0026#34;dalvik\u0026#34; atrace_categories: \u0026#34;power\u0026#34; } } } data_sources: { config { name: \u0026#34;linux.process_stats\u0026#34; target_buffer: 1 process_stats_config { scan_all_processes_on_start: true } } } EOF ./record_android_trace -c config.pbtx -o trace_file.perfetto-trace åœ¨EOFä¹‹å‰çš„å‘½ä»¤ä¼šæŠŠé…ç½®å†™åˆ°config.pbtxæ–‡ä»¶ä¸­ï¼Œåœ¨EOFä¹‹åï¼Œå’Œä¸Šé¢çš„ä¸€æ ·ï¼Œåªä¸è¿‡åŒºåˆ«æ˜¯å¢åŠ äº†-cåé¢è·Ÿé…ç½®æ–‡ä»¶çš„è·¯å¾„ï¼Œè¯¥æ–¹å¼ä¹Ÿä¼šè‡ªåŠ¨åœ¨ui.perfetto.devä¸Šæ‰“å¼€è¯¥traceã€‚\nä¸‹é¢å†æ¥è§£é‡Šä¸‹ä¸Šé¢çš„é…ç½®æ–‡ä»¶éƒ½é…ç½®äº†äº›ä»€ä¹ˆï¼š\nduration_ms: 10000: è·Ÿè¸ªå°†æŒç»­ 10 ç§’ buffers: å®šä¹‰äº†ä¸¤ä¸ªç¼“å†²åŒºã€‚ size_kb: 8960, fill_policy: DISCARD(ä¸»ç¼“å†²åŒºï¼Œå…¶ä¸­å¡«å……ç­–ç•¥æ˜¯ä¸¢å¼ƒæ¨¡å¼) size_kb: 1280, fill_policy: DISCARD(æ¬¡ç¼“å†²åŒºï¼Œç”¨æ¥å­˜å‚¨å…¶å®ƒå°‘é‡çš„æ•°æ®æº) data_sources linux.ftraceï¼šftraceå’Œatraceäº‹ä»¶çš„è·Ÿè¸ª ftraceç›¸å…³çš„è·Ÿè¸ª sched/sched_switchï¼šè¿™æ˜¯æ˜¾ç¤º CPU è°ƒåº¦å’Œæ„å»ºçº¿ç¨‹ CPU è½¨é“çš„æœ€å…³é”®äº‹ä»¶ã€‚ æœ‰äº†è¿™ä¸ªäº‹ä»¶ï¼ŒPerfetto UI å°±èƒ½çŸ¥é“å“ªäº›çº¿ç¨‹åœ¨ä½•æ—¶è¿è¡Œåœ¨å“ªä¸ª CPU ä¸Šã€‚ power/suspend_resumeï¼šä¸ç”µæºç®¡ç†ç›¸å…³ã€‚ sched/sched_process_exit, sched/sched_process_free, task/task_newtask, task/task_renameï¼šè¿™äº›äº‹ä»¶æœ‰åŠ©äº Perfetto è·Ÿè¸ªè¿›ç¨‹å’Œçº¿ç¨‹çš„åˆ›å»ºã€é”€æ¯å’Œé‡å‘½åï¼Œä»è€Œåœ¨ UI ä¸­æ­£ç¡®åœ°æ˜¾ç¤ºå®ƒä»¬çš„ç”Ÿå‘½å‘¨æœŸå’Œåç§°ã€‚ ftrace/print: æ”¶é›† printk ç­‰å†…æ ¸æ‰“å°ä¿¡æ¯ï¼Œåœ¨æŸäº›è°ƒè¯•åœºæ™¯æœ‰ç”¨ã€‚ atraceç›¸å…³çš„è·Ÿè¸ª gfxï¼Œviewï¼Œwebviewï¼šå›¾å½¢å’Œuiæ¸²æŸ“ç›¸å…³çš„atraceã€‚ cameraï¼šæ‘„åƒå¤´ç›¸å…³çš„atrace dalvikï¼šARTè¿è¡Œæ—¶ç›¸å…³çš„atraceã€‚ powerï¼šç”µæºç›¸å…³çš„atraceã€‚ linux.process_statsï¼šæ‰€æœ‰è¿›ç¨‹çš„çŠ¶æ€è·Ÿè¸ªï¼Œå¦‚æœæ²¡æœ‰è¯¥é…ç½®ï¼Œç”Ÿæˆçš„perfettoè·Ÿè¸ªä¿¡æ¯ä¸­ï¼Œéƒ½ä¸ä¼šæ˜¾ç¤ºå…·ä½“çš„è¿›ç¨‹åå­—ï¼Œå¦‚æœæƒ³çŸ¥é“ target_buffer: 1: æŒ‡ç¤ºæ­¤æ•°æ®æºå°†æ•°æ®å†™å…¥ç¬¬äºŒä¸ªï¼ˆè¾ƒå°çš„ï¼‰ç¼“å†²åŒºã€‚ process_stats_configï¼š scan_all_processes_on_start: trueï¼šè¿™å°†ä¼šåœ¨è·Ÿè¸ªå¼€å§‹æ—¶æ‰«ææ‰€æœ‰è¿›ç¨‹ä¿¡æ¯ï¼Œç¡®ä¿ Perfetto äº†è§£æ‰€æœ‰æ´»åŠ¨çš„è¿›ç¨‹å’Œçº¿ç¨‹çš„åˆå§‹çŠ¶æ€ã€‚ å†æ¥çœ‹ä¸€ä¸ªä¹‹å‰é€šè¿‡perfettoå¯è§†åŒ–é¡µé¢è·å–çš„ä¸€ä¸ªé…ç½®ï¼š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 buffers: { size_kb: 63488 fill_policy: DISCARD } buffers: { size_kb: 2048 fill_policy: DISCARD } data_sources: { config { name: \u0026#34;android.packages_list\u0026#34; target_buffer: 1 } } data_sources: { config { name: \u0026#34;android.log\u0026#34; android_log_config { log_ids: LID_EVENTS log_ids: LID_CRASH log_ids: LID_KERNEL log_ids: LID_DEFAULT log_ids: LID_RADIO log_ids: LID_SECURITY log_ids: LID_STATS log_ids: LID_SYSTEM } } } data_sources: { config { name: \u0026#34;android.surfaceflinger.frametimeline\u0026#34; } } data_sources: { config { name: \u0026#34;linux.ftrace\u0026#34; ftrace_config { ftrace_events: \u0026#34;ftrace/print\u0026#34; atrace_categories: \u0026#34;am\u0026#34; atrace_categories: \u0026#34;adb\u0026#34; atrace_categories: \u0026#34;aidl\u0026#34; atrace_categories: \u0026#34;dalvik\u0026#34; atrace_categories: \u0026#34;audio\u0026#34; atrace_categories: \u0026#34;binder_lock\u0026#34; atrace_categories: \u0026#34;binder_driver\u0026#34; atrace_categories: \u0026#34;bionic\u0026#34; atrace_categories: \u0026#34;camera\u0026#34; atrace_categories: \u0026#34;database\u0026#34; atrace_categories: \u0026#34;gfx\u0026#34; atrace_categories: \u0026#34;hal\u0026#34; atrace_categories: \u0026#34;input\u0026#34; atrace_categories: \u0026#34;network\u0026#34; atrace_categories: \u0026#34;nnapi\u0026#34; atrace_categories: \u0026#34;pm\u0026#34; atrace_categories: \u0026#34;power\u0026#34; atrace_categories: \u0026#34;rs\u0026#34; atrace_categories: \u0026#34;res\u0026#34; atrace_categories: \u0026#34;rro\u0026#34; atrace_categories: \u0026#34;sm\u0026#34; atrace_categories: \u0026#34;ss\u0026#34; atrace_categories: \u0026#34;vibrator\u0026#34; atrace_categories: \u0026#34;video\u0026#34; atrace_categories: \u0026#34;view\u0026#34; atrace_categories: \u0026#34;webview\u0026#34; atrace_categories: \u0026#34;wm\u0026#34; atrace_apps: \u0026#34;com.example.coroutinescopedemo\u0026#34; } } } duration_ms: 10000 ä¸»è¦æ¥è¯´ä¸‹å’Œä¸Šé¢å®˜ç½‘çš„é…ç½®åŒºåˆ«ã€‚ä¸»è¦åœ¨data_sourceséƒ¨åˆ†ï¼š\nandroid.packages_list:æ”¶é›†è®¾å¤‡ä¸Šå®‰è£…çš„åº”ç”¨ç¨‹åºåŒ…çš„åˆ—è¡¨ã€‚è¿™å¯¹äºåœ¨ Perfetto UI ä¸­å°†è·Ÿè¸ªäº‹ä»¶ä¸ç‰¹å®šçš„åº”ç”¨ç¨‹åºå…³è”èµ·æ¥éå¸¸æœ‰ç”¨ã€‚ android.log:æ”¶é›†android logcatæ—¥å¿—ã€‚è¿™å¯¹äºè°ƒè¯•åº”ç”¨ç¨‹åºè¡Œä¸ºã€æŸ¥çœ‹ç³»ç»Ÿäº‹ä»¶ã€å´©æºƒä¿¡æ¯ç­‰éå¸¸é‡è¦ã€‚ android_log_config: è¯¦ç»†é…ç½®äº†è¦æ”¶é›†çš„æ—¥å¿—ç¼“å†²åŒºï¼š LID_EVENTS: äº‹ä»¶æ—¥å¿—ï¼ˆäºŒè¿›åˆ¶æ ¼å¼çš„ç³»ç»Ÿäº‹ä»¶ï¼‰ã€‚ LID_CRASH: å´©æºƒæ—¥å¿—ã€‚ LID_KERNEL: å†…æ ¸æ—¥å¿—ã€‚ LID_DEFAULT: ä¸»æ—¥å¿—ç¼“å†²åŒºï¼ˆåº”ç”¨ç¨‹åºå’Œå¤§éƒ¨åˆ†ç³»ç»Ÿæ—¥å¿—ï¼‰ã€‚ LID_RADIO: æ— çº¿ç”µ/ç”µè¯ç›¸å…³çš„æ—¥å¿—ã€‚ LID_SECURITY: å®‰å…¨ç›¸å…³çš„æ—¥å¿—ã€‚ LID_STATS: ç»Ÿè®¡ä¿¡æ¯æ—¥å¿—ã€‚ LID_SYSTEM: ç³»ç»Ÿæ—¥å¿—ã€‚ è¿™å‡ ä¹æ¶µç›–äº†æ‰€æœ‰ä¸»è¦çš„ Logcat æ—¥å¿—ç¼“å†²åŒºï¼Œä¼šæ”¶é›†å¤§é‡çš„æ—¥å¿—ä¿¡æ¯ã€‚ android.surfaceflinger.frametimelineï¼šæ”¶é›† SurfaceFlinger çš„å¸§æ—¶é—´çº¿æ•°æ®ã€‚è¿™å¯¹äºåˆ†æ UI æ¸²æŸ“æ€§èƒ½ã€å¡é¡¿ã€Jank ç­‰é—®é¢˜éå¸¸å…³é”®ã€‚å®ƒèƒ½æ˜¾ç¤ºå¸§çš„ç”Ÿå‘½å‘¨æœŸï¼Œä»åº”ç”¨æäº¤åˆ°æœ€ç»ˆæ˜¾ç¤ºåœ¨å±å¹•ä¸Šçš„å„ä¸ªé˜¶æ®µã€‚ linux.ftraceï¼šå’Œä¸Šé¢å¯¹æ¯”ï¼Œå¢åŠ äº†atrace_appsä¿¡æ¯ï¼Œè¿™æ˜¯éå¸¸é‡è¦çš„ã€‚å®ƒä¼šå¯ç”¨é’ˆå¯¹ç‰¹å®šåº”ç”¨ç¨‹åº com.example.coroutinescopedemo çš„åº”ç”¨å±‚è‡ªå®šä¹‰ app ç±»åˆ«è·Ÿè¸ªã€‚å¦‚æœè¯¥åº”ç”¨ä½¿ç”¨äº† android.os.Trace æˆ–ç±»ä¼¼çš„ Tracing SDK æ¥æ·»åŠ è‡ªå®šä¹‰äº‹ä»¶ï¼Œé‚£ä¹ˆè¿™äº›äº‹ä»¶å°†è¢«æ•è·ã€‚ å…³äºæ›´å¤šçš„é…ç½®å¯ä»¥å‚è€ƒrepoä¸Šçš„test/configs\nä¸Šé¢æ˜¯é€šè¿‡record_android_traceè„šæœ¬ï¼Œç„¶åé…ç½®config.pbtxæ¥è·Ÿè¸ªçš„ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä¸å€ŸåŠ©record_android_traceè„šæœ¬ï¼Œç›´æ¥ä½¿ç”¨è®¾å¤‡ä¸Šçš„å‘½ä»¤ï¼š\n1 cat config.pbtx | adb shell perfetto -c - --txt -o /data/misc/perfetto-traces/trace.perfetto-trace æˆ–è€…å…ˆæŠŠconfig.pbtxç»™æ¨é€åˆ°è®¾å¤‡ä¸Šï¼Œç„¶åå†è·Ÿè¸ªï¼š\n1 2 adb push config.pbtx /data/local/tmp/config.pbtx adb shell \u0026#39;cat /data/local/tmp/config.pbtx | perfetto --txt -c - -o /data/misc/perfetto-traces/trace.perfetto-trace\u0026#39; é€šè¿‡ Perfetto ç•Œé¢è®°å½•è·Ÿè¸ª ç‚¹å¼€ui.perfetto,devï¼Œç„¶åç‚¹å‡»å·¦ä¾§èœå•çš„Record new traceï¼Œç„¶åè¿æ¥ä¸Šè®¾å¤‡ï¼š\næ¥åˆ°Buffers and durationï¼Œè¿™é‡Œé»˜è®¤çš„ç¼“å†²åŒºæ˜¯64Mï¼Œdurationæ˜¯10sï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©ä¸åŠ¨ï¼š\næ¥ç€é…ç½®å‰é¢è¯´çš„ftraceå’Œatraceä¿¡æ¯ï¼Œå®ƒæ˜¯åœ¨Android apps \u0026amp; svcsçš„tabä¸­ï¼Œä½†æ˜¯æ­¤å¤„æˆ‘åªçœ‹åˆ°atraceçš„é…ç½®ï¼š\nå¯ä»¥çœ‹åˆ°ä¸Šé¢æˆ‘æŠŠæ‰€æœ‰çš„atraceçš„åˆ†ç±»éƒ½ç»™å‹¾ä¸Šäº†ã€‚åœ¨æœ€åä¸€æ ä¸­æˆ‘å¡«ä¸Šäº†è¿›ç¨‹çš„åå­—ï¼Œè¿™ä¸ªè·Ÿä¸Šé¢config.pbtxçš„atrace_appsé…ç½®æ˜¯ä¸€æ ·çš„ï¼Œç”¨æ¥è·Ÿè¸ªè‡ªå®šä¹‰çš„traceä¿¡æ¯ã€‚\næ¥ç€æ¥çœ‹ä¸‹android logçš„æ•°æ®æºé…ç½®ï¼Œå®ƒä¹Ÿæ˜¯åœ¨Android apps \u0026amp; svcsçš„tabä¸­ï¼š\nå¯ä»¥çœ‹åˆ°æˆ‘è¿™é‡ŒæŠŠæ‰€æœ‰çš„logçº§åˆ«éƒ½ç»™å‹¾ä¸Šäº†ã€‚\nåœ¨Event logä¸‹é¢è¿˜æœ‰ä¸ªFrame timelineçš„è·Ÿè¸ªï¼Œå®ƒæ˜¯æˆ‘ä»¬å¡é¡¿åˆ†æä¸­å¾ˆé‡è¦çš„ä¸€é¡¹ï¼Œå®ƒä¼šæŠŠæ¯ä¸€å¸§çš„æœŸæœ›æ—¶é—´å’Œå®é™…æ—¶é—´ç»™åˆ—å‡ºæ¥ï¼Œæ–¹ä¾¿åˆ†ææ˜¯å¦æ˜¯å¡é¡¿å¸§ï¼š\nå®ƒä¼šåœ¨config.pbtxä¸­ç”Ÿæˆå¦‚ä¸‹ï¼š\n1 2 3 4 5 data_sources: { config { name: \u0026#34;android.surfaceflinger.frametimeline\u0026#34; } } è¿™ä¸ªåœ¨å‰é¢çš„configä¸­æœ‰ä»‹ç»ã€‚æ‰€æœ‰çš„é…ç½®å®Œäº‹åï¼Œå¯ä»¥åœ¨Cmdline instructionsçš„tabä¸­æµè§ˆç”Ÿæˆçš„é…ç½®ä¿¡æ¯ã€‚æœ€ç»ˆç”Ÿæˆçš„ä¹Ÿæ˜¯å‰é¢ä»‹ç»çš„config.pbtx: é€šç”¨æ“ä½œ å¯¼èˆªæ“ä½œ wï¼šæ”¾å¤§æ“ä½œ\nsï¼šç¼©å°æ“ä½œ\naï¼šè½¨é“å·¦ç§»\ndï¼šè½¨é“å³ç§»\né¼ æ ‡æ“ä½œ é¼ æ ‡å·¦é”®ç‚¹å‡»ï¼šé€‰ä¸­åŒºåŸŸæˆ–ç‰‡æ®µ\ncontrol+æ»šè½®ï¼šæ”¾å¤§æˆ–ç¼©å°\né¼ æ ‡å·¦é”®é•¿æŒ‰+æ‹–æ‹½ï¼šé€‰ä¸­åŒºåŸŸ\nshift+å·¦é”®é•¿æŒ‰+æ‹–æ‹½ï¼šè½¨é“å·¦ç§»æˆ–å³ç§»\nå‘½ä»¤è¡Œæ“ä½œ åœ¨å¤´éƒ¨çš„æœç´¢æ¡†ä¸­è¾“å…¥ã€Œ\u0026gt;ã€,è¿›å…¥å¿«æ·æ“ä½œï¼Œç‚¹å‡»deleteé€€å‡ºå¿«æ·æ“ä½œ\nåœ¨å¤´éƒ¨çš„æœç´¢æ¡†ä¸­è¾“å…¥ã€Œ:ã€ï¼Œè¿›å…¥sqlæ¨¡å¼ï¼Œç‚¹å‡»deleteé€€å‡ºsqlæ¨¡å¼\nenterï¼šåœ¨ä¸Šé¢è¾“å…¥å®Œsqlåï¼Œå°±æ‰§è¡Œsql\ncontrol+enterï¼šåœ¨ä¸Šé¢è¾“å…¥å®Œsqlåï¼Œå°±æ‰§è¡Œsqlï¼Œæ¯æ¬¡çš„sqléƒ½ä¸ä¼šè¢«è¦†ç›–\nsqlé¡µé¢æ“ä½œ control+enterï¼šæ‰§è¡Œsqlï¼Œä¹Ÿå¯ä»¥é€šè¿‡é¼ æ ‡é€‰ä¸­æŸæ®µsqlæ¥æ‰§è¡Œç»“æœ\nå¿«æ·é”®æ“ä½œ shift+mï¼šåŸºäºå½“å‰é€‰ä¸­çš„åŒºåŸŸæˆ–ç‰‡æ®µæ·»åŠ ä¸€ä¸ªæ–°çš„ç¬”è®°ç‰‡æ®µ\nRï¼šå¯¹å½“å‰é€‰ä¸­çš„åŒºåŸŸæˆ–ç‰‡æ®µè½¬ä¸ºåŒºåŸŸé€‰æ‹©\nescï¼šå–æ¶ˆå½“å‰é€‰æ‹©çš„åŒºåŸŸæˆ–ç‰‡æ®µ\ncommand+pï¼šé€šè¿‡åå­—æ‰¾è½¨é“\nf:å°†ç”»é¢èšç„¦åˆ°å½“å‰é€‰ä¸­çš„åŒºåŸŸæˆ–ç‰‡æ®µ\nå›è½¦ï¼šå¯¹é¡µé¢ä¸Šçš„æœç´¢ç»“æœï¼ˆcommand+fï¼‰è¿›è¡Œå®šä½åˆ°ä¸‹ä¸€ä¸ª\nshift+å›è½¦ï¼šå¯¹é¡µé¢ä¸Šçš„æœç´¢ç»“æœï¼ˆcommand+fï¼‰è¿›è¡Œå®šä½åˆ°ä¸Šä¸€ä¸ª\ncommand+shift+p:æ‰“å¼€å¿«æ·æ“ä½œï¼Œè·Ÿä¸Šé¢åœ¨æœç´¢æ¡†ä¸­è¾“å…¥ã€Œ\u0026gt;ã€ä¸€æ ·çš„æ•ˆæœ\ncommand+oï¼šæ‰“å¼€traceæ–‡ä»¶\ncommand+t:ç½®é¡¶è½¨é“\ndelete:ç§»é™¤æ‰é€‰ä¸­çš„ç¬”è®°ç‰‡æ®µ\n/:èšç„¦åˆ°æœç´¢æ¡†\n.:å®šä½åˆ°ä¸‹ä¸€ä¸ªè½¨é“çš„ç‰‡æ®µ\n,:å®šä½åˆ°ä¸Šä¸€ä¸ªè½¨é“çš„ç‰‡æ®µ\nmï¼šæ ¹æ®å½“å‰é€‰ä¸­çš„åŒºåŸŸæˆ–ç‰‡æ®µï¼Œæ·»åŠ ä¸´æ—¶çš„ç¬”è®°ç‰‡æ®µï¼Œå’Œä¸Šé¢çš„shift+mçš„åŒºåˆ«æ˜¯ï¼Œæ­¤å¤„å¦‚æœå†æ·»åŠ å¦å¤–çš„ç¬”è®°ç‰‡æ®µçš„æ—¶å€™ï¼Œæ­¤æ—¶è¿™ç§æ·»åŠ çš„ç¬”è®°ç‰‡æ®µä¼šè¢«è¦†ç›–\nqï¼šåˆ‡æ¢åº•éƒ¨çš„é¢æ¿\ncommand+b:åˆ‡æ¢å·¦è¾¹çš„èœå•é¢æ¿\ncommand+option+sï¼šå¤šä¸ªtraceæ–‡ä»¶åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€çš„æ—¶å€™ï¼Œèƒ½åŒæ­¥å¤šä¸ªtraceçš„æ“ä½œï¼Œæ–¹ä¾¿å¯¹æ¯”\nå¸¸è§sql æ¨¡ç³ŠåŒ¹é…æŸ¥è¯¢ï¼šlikeã€globã€regexp like:ä¸€èˆ¬è·Ÿ%å’Œ_æ¥æ­é…ä½¿ç”¨ï¼Œæ˜¯ä¸ç¡®å®šæ•°é‡å­—ç¬¦ä¸ªæ•°ï¼Œ_æ˜¯åŒ¹é…å•ä¸ªå­—ç¬¦ï¼Œå¹¶ä¸”likeå‰é¢å¯ä»¥åŠ notå–åï¼Œæ¯”å¦‚æˆ‘æƒ³æŸ¥è¯¢æ‰€æœ‰fragmentçš„onCreateViewçš„è€—æ—¶ï¼š\n1 SELECT * FROM slice WHERE name LIKE \u0026#39;%onCreateView%\u0026#39;; åœ¨likeä¸­æ˜¯ä¸åŒºåˆ†å¤§å°å†™ã€‚ glob:ä¸€èˆ¬å’Œ*ã€?ã€[\u0026hellip;]æ­é…ä½¿ç”¨ï¼Œ*è¡¨ç¤ºä»»æ„é•¿åº¦çš„å­—ç¬¦ä¸²ã€?è¡¨ç¤ºå•ä¸ªå­—ç¬¦ã€[\u0026hellip;]è¡¨ç¤ºå­—ç¬¦é›†ã€‚å®ƒæ˜¯è¦åŒºåˆ†å¤§å°å†™ã€‚å¹¶ä¸”å‰é¢ä¹Ÿå¯ä»¥ç”¨notå–åã€‚\n1 2 3 4 SELECT * FROM slice WHERE name GLOB \u0026#39;*interesting_slice*\u0026#39; LIMIT 10; regexp:æ˜¯ä¸€ç§ä»¥æ­£åˆ™æ¥åŒ¹é…çš„å…³é”®å­—ï¼Œä¸‹é¢çœ‹ä¸€ä¸ªç»Ÿè®¡sliceçš„è€—æ—¶sqlï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 SELECT name, COUNT(dur) AS count_slice, -- Convert nanoseconds to milliseconds AVG(dur) / 1000000 AS avg_dur_ms, CAST(MAX(dur) AS DOUBLE) / 1000000 AS max_dur_ms, CAST(MIN(dur) AS DOUBLE) / 1000000 AS min_dur_ms, PERCENTILE(dur,50) / 1000000 AS P50_dur_ms, PERCENTILE(dur,90) / 1000000 AS P90_dur_ms, PERCENTILE(dur,99) / 1000000 AS P99_dur_ms FROM slice WHERE name REGEXP \u0026#39;.*interesting_slice.*\u0026#39; GROUP BY name ORDER BY count_slice DESC LIMIT 10; ä¸Šé¢çš„sqlé€šè¿‡regexpæ­£åˆ™æ¥åŒ¹é…åˆ°æ„Ÿå…´è¶£çš„sliceï¼Œå¹¶ä¸”å¼€å¤´å’Œç»“å°¾éƒ½æ˜¯.*æ¥åŒ¹é…ï¼Œè¯¥.è¡¨ç¤ºåŒ¹é…å•ä¸ªå­—ç¬¦ï¼Œè€Œ*åˆ™æ˜¯åŒ¹é…å‰ä¸€ä¸ªå­—ç¬¦æ˜¯0æ¬¡æˆ–å¤šæ¬¡ï¼Œæ‰€ä»¥è¡¨ç¤ºå‰é¢interesting_sliceå‰é¢æœ‰ä»»æ„ä¸ªæ•°çš„å­—ç¬¦ï¼Œinteresting_sliceåé¢æœ‰ä»»æ„ä¸ªæ•°çš„å­—ç¬¦ã€‚å¹¶ä¸”æŒ‰ç…§åå­—åˆ†ç»„ï¼Œåˆ—æ˜æœ‰åå­—ã€count_sliceè¡¨ç¤ºè¯¥sliceå‡ºç°çš„æ¬¡æ•°ã€avg_dur_msè¯¥sliceçš„å¹³å‡è€—æ—¶ï¼Œå•ä½æ˜¯msã€max_dur_msæœ€å¤§è€—æ—¶ã€min_dur_msæœ€å°è€—æ—¶ã€P50_dur_msæ˜¯p50è€—æ—¶ã€P90_dur_msæ˜¯p90çš„è€—æ—¶ã€P99_dur_msæ˜¯p99çš„è€—æ—¶ï¼Œæœ€åæŒ‰ç…§å‡ºç°æ¬¡æ•°é™åºæ’åˆ—ï¼ŒæŸ¥è¯¢å‰10æ¡ã€‚\nè”è¡¨æŸ¥è¯¢ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 SELECT s.id AS id, s.ts AS ts, s.track_id AS track_id, s.slice_id AS slice_id, s.dur AS dur, s.name AS slice, p.name AS process, t.name AS thread FROM slice s JOIN thread_track tt ON s.track_id = tt.id JOIN thread t on tt.utid = t.utid JOIN process p on t.upid = p.upid WHERE s.name LIKE \u0026#39;%interesting_slice%\u0026#39; -- Only look for slices in your app\u0026#39;s process AND p.name = \u0026#39;com.example.myapp\u0026#39; -- Only look for slices on your app\u0026#39;s main thread AND t.is_main_thread ORDER BY dur DESC; ä¸Šé¢thread_trackï¼ˆçº¿ç¨‹è½¨é“è¡¨ï¼‰çš„idå’Œsliceçš„trace_idè¿›è¡Œå…³è”ï¼Œthreadï¼ˆçº¿ç¨‹è¡¨ï¼‰çš„utidï¼ˆçº¿ç¨‹å”¯ä¸€idï¼‰å’Œthread_trackçš„utidè¿›è¡Œå…³è”ï¼Œprogressï¼ˆè¿›ç¨‹è¡¨ï¼‰çš„upidï¼ˆè¿›ç¨‹å”¯ä¸€idï¼‰å’Œthreadçš„upidè¿›è¡Œå…³è”ã€‚\né€šè¿‡sqlæŸ¥æ‰¾ç¡çœ ä¸­æ–­çš„åŸå›  ç¡çœ ä¸­æ–­æ˜¯æ€§èƒ½ä¼˜åŒ–ä¸­ä¸€ä¸ªé˜»å¡çº¿ç¨‹çš„é—®é¢˜ï¼Œæ¯”å¦‚åœ¨ç­‰å¾…ioã€é”ç­‰éƒ½æ˜¯ç¡çœ ä¸­æ–­é—®é¢˜ï¼Œå³è°ƒç”¨åœ¨ä¸å¯ä¸­æ–­æ¡ä»¶ä¸‹é˜»å¡çš„å†…æ ¸å‡½æ•°ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡é…ç½®perfettoå¦‚ä¸‹æ¥æ‰¾å‡ºç¡çœ ä¸­æ–­çš„åŸå› ï¼š\n1 2 3 4 5 6 7 8 9 data_sources: { config { name: \u0026#34;linux.ftrace\u0026#34; target_buffer: 0 ftrace_config { ftrace_events: \u0026#34;sched/sched_blocked_reason\u0026#34; } } } ç„¶åé€šè¿‡sqlæŸ¥æ‰¾ä¸­æ–­çš„åŸå› ï¼š\n1 2 3 4 5 6 7 SELECT blocked_function, COUNT(thread_state.id), SUM(dur) FROM thread_state JOIN thread USING (utid) JOIN process USING (upid) WHERE process.name = \u0026#34;com.google.android.youtube\u0026#34; GROUP BY blocked_function ORDER BY SUM(dur) DESC; blocked_function:å®ƒæ˜¯æ¥è‡ªäºthread_stateè¡¨ï¼Œå®ƒæ˜¯çº¿ç¨‹çŠ¶æ€è¡¨ï¼Œè¡¨ç¤ºçº¿ç¨‹åœ¨æŸä¸ªæ—¶åˆ»é˜»å¡æ—¶ï¼Œå¯¹åº”çš„å‡½æ•°ã€‚ COUNT(thread_state.id)ï¼šç»Ÿè®¡è¯¥é˜»å¡é—®é¢˜å‡ºç°çš„æ¬¡æ•° SUM(dur):ç»Ÿè®¡è¿™ç§é˜»å¡å‡ºç°çš„æ€»æ—¶é•¿ æ³¨æ„ï¼šä¸Šé¢é€šè¿‡join thread usingï¼ˆutidï¼‰æ˜¯é€šè¿‡thread_stateä¸­çš„utidå’Œthreadè¡¨ä¸­çš„utidè¿›è¡Œå…³è”ï¼Œå°†threadä¸­çš„upidå’Œprocessä¸­çš„upidè¿›è¡Œå…³è”ï¼Œé€šè¿‡threaè¡¨è¿›è¡Œä¸­é—´è¿‡æ¸¡ã€‚\nå‚è€ƒ https://perfetto.dev/docs/quickstart/android-tracing https://perfetto.dev/docs/concepts/config https://perfetto.dev/docs/getting-started/android-trace-analysis ","date":"2025-06-18T00:00:00Z","permalink":"http://xiangcman.xyz/p/android%E4%B8%8A%E5%90%AF%E5%8A%A8perfetto%E8%B7%9F%E8%B8%AA/","title":"Androidä¸Šå¯åŠ¨perfettoè·Ÿè¸ª"},{"content":"Androidä¸­å¡é¡¿æ²»ç†ä¸»è¦é›†ä¸­åœ¨recyclerViewæ»‘åŠ¨åˆ—è¡¨æ—¶å€™æœ‰å¡é¡¿ï¼Œæˆ‘ä»¬ç»“åˆandroid studioä¸­profilerçš„systemTraceå·¥å…·æ¥æŸ¥çœ‹å¡é¡¿æƒ…å†µï¼Œæˆ‘ç›®å‰çš„Android Studioå·²æ›´æ–°åˆ°Meerkat Feature Drop | 2024.3.2 Patch 1ç‰ˆæœ¬ï¼Œä¸‹æ¥æ¥çœ‹çœ‹å¦‚ä½•é€šè¿‡è¯¥å·¥å…·æ¥å®šä½åˆ°å…·ä½“çš„å¡é¡¿ã€‚\né¦–å…ˆAndroid Studioä¸­System Traceå·¥å…·æ˜¯åŸºäºperfettoæ¥è¿›è¡Œå®šä½ï¼Œæ‰€ä»¥éœ€è¦æœ‰ä¸€å®šçš„perfettoç»éªŒæ‰èƒ½ä½¿ç”¨è¯¥åŠŸèƒ½ï¼Œperfettoèƒ½é€šè¿‡å†…æ ¸ã€ç³»ç»Ÿç»„ä»¶ã€æœ¬åœ°å†…å­˜ã€cpuç­‰å¤šæ–¹é¢è¿›è¡Œæ”¶é›†æ•°æ®ï¼Œè€Œæˆ‘ä»¬çš„å¡é¡¿ä¸€èˆ¬æ˜¯ç›‘æ§åº”ç”¨çš„ä¸»çº¿ç¨‹ç»˜åˆ¶é˜¶æ®µçš„æ•°æ®ï¼Œè€Œandroidä»£ç ä¸­å·²ç»ä¸ºä¸»çº¿ç¨‹ç»˜åˆ¶é˜¶æ®µæ·»åŠ äº†å„ç§tagï¼Œé€šè¿‡è¯¥tagèƒ½çŸ¥é“æ˜¯ä»€ä¹ˆç»„ä»¶çš„ç»˜åˆ¶é˜¶æ®µå‘ç”Ÿäº†å¡é¡¿ã€‚\né¦–å…ˆæˆ‘çš„æ‰‹æœºæ˜¯Android13çš„ç‰ˆæœ¬ï¼Œåœ¨å¡é¡¿æ£€æµ‹å®˜ç½‘ä¸­ä»‹ç»äº†Android12ä»¥ä¸Šã€Android11ã€Android10ä»¥ä¸‹çš„åŒºåˆ«ï¼Œè¿™é‡Œæˆ‘å°±ä»¥Android13æ¥è®²è§£å¦‚ä½•è¯†åˆ«å¡é¡¿ã€‚\nåœ¨å®˜ç½‘ä¸­ä»‹ç»æœ‰ä¸¤ç§æ¨¡å¼ï¼Œä¸€ç§æ˜¯å¯åˆ†æåº”ç”¨ï¼Œä¸€ç§æ˜¯å¯è°ƒè¯•åº”ç”¨ï¼Œæ–°ç‰ˆandroid studioä¸­çš„profilerä¸­system traceè¦æ±‚æ˜¯å¯åˆ†æçš„(profileable)åº”ç”¨ï¼Œåœ¨å¯åŠ¨åº”ç”¨æ—¶å€™ï¼Œç‚¹å‡»menu toolbarçš„æ›´å¤šæ“ä½œï¼Œç„¶åç‚¹å‡»ï¼Œä¾¿å¯è¿›å…¥åˆ°profileableæ¨¡å¼ï¼Œä¹Ÿå¯ä»¥å°†å˜ä½“åˆ‡æ¢ä¸ºreleaseæ¨¡å¼ï¼Œåœ¨releaseå˜ä½“ä¸‹ï¼Œåœ¨æ¸…å•æ–‡ä»¶åŠ ä¸Šå¦‚ä¸‹é…ç½®ï¼š\n1 \u0026lt;profileable android:shell=\u0026#34;true\u0026#34; /\u0026gt; é…ç½®å®Œåï¼Œæ¥ç€å°±æ˜¯é€‰æ‹©ç›¸åº”çš„åº”ç”¨ï¼Œç„¶åç‚¹å‡»System Traceé€‰é¡¹è¿›è¡Œç›‘æ§åº”ç”¨ã€‚æ¯”å¦‚æˆ‘åœ¨RecyclerViewçš„åˆ—è¡¨adapterä¸­onBindViewHolderè¿›è¡ŒThread.sleep(50)ï¼Œç„¶åè§‚å¯Ÿç”Ÿæˆçš„traceæ–‡ä»¶ï¼š æ•´ä½“ä¸Šåˆ†ä¸ºJanky framesã€Threadsã€Analysiså‡ ä¸ªåŒºåŸŸï¼ŒJanky framesé»˜è®¤å±•ç¤ºçš„æ˜¯å¡é¡¿å¸§ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å‹¾é€‰All Framesï¼ŒThreadséƒ¨åˆ†å±•ç¤ºçš„æ—¶å€™æ‰€æœ‰çº¿ç¨‹ï¼Œæ¯”å¦‚appçš„ä¸»çº¿ç¨‹ï¼ŒRenderThreadæ¸²æŸ“çº¿ç¨‹ç­‰ã€‚AnalysisåŒºåŸŸå±•ç¤ºçš„æ˜¯æŸå—çš„è·Ÿè¸ªä¿¡æ¯ã€‚\nå¡é¡¿å¸§ï¼šå®ƒæ˜¯æˆ‘ä»¬åˆ†æå¡é¡¿æœ€ç›´æ¥çš„å›¾å½¢ï¼Œæˆ‘ä»¬é¦–å…ˆé€‰ä¸­æŸä¸€ä¸ªå¡é¡¿å¸§ï¼Œç„¶åè¯¥å¸§ä¼šå‡ºç°ä¸¤ä¸ªé¢œè‰²ï¼Œå·¦è¾¹çš„æ·±çº¢è‰²è¡¨ç¤ºä¸€é’ˆçš„æœŸæœ›æ—¶é—´ï¼Œè€Œå³è¾¹çš„æš—çº¢è‰²è¡¨ç¤ºè¯¥å¸§å»¶è¿Ÿäº†å¤šä¹…ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å³è¾¹AnalysisåŒºåŸŸæ ‡æ˜äº†Jank typeæ˜¯Deadline missedï¼ˆå»¶è¿Ÿå¸§ï¼‰ï¼ŒLayer nameè¡¨æ˜æ˜¯å“ªä¸ªactivityï¼ŒExpected durationè¡¨ç¤ºæœŸæœ›æ—¶é—´ï¼ŒActual durationè¡¨ç¤ºå®é™…æ‰§è¡Œæ—¶é—´ã€‚events associated with frameå±•ç¤ºçš„æ˜¯è¯¥å¸§ä»ä¸»çº¿ç¨‹åˆ°RenderThreadåˆ°gpuåˆ°SurfaceFlingerçš„å…³é”®äº‹ä»¶ã€‚å¯ä»¥é€šè¿‡è¯¥åŒºåŸŸåˆ†æè¯¥å¸§æ˜¯åº”ç”¨å±‚ç»˜åˆ¶è€—æ—¶å¤šï¼Œè¿˜æ˜¯æ¸²æŸ“çº¿ç¨‹æˆ–è€…æ˜¯gpuç­‰é˜¶æ®µè€—æ—¶ä¹…ã€‚ä¸‹é¢è¿˜ä¼šå±•ç¤ºMain thread stateså’ŒRenderThread statesï¼Œåˆ†åˆ«è®°å½•äº†ç°æˆçš„çŠ¶æ€ã€æ¯ä¸ªçŠ¶æ€çš„è€—æ—¶ã€ä»¥åŠæ¯ä¸ªçŠ¶æ€çš„å æ¯”ï¼ŒOccurrencesè¡¨ç¤ºçš„æ˜¯å½“å‰çº¿ç¨‹åœ¨è¯¥å¸§çš„ç”Ÿå‘½å‘¨æœŸå†…ï¼Œåœ¨è¯¥çŠ¶æ€ä¸‹çš„æ¬¡æ•°ã€‚ ä»ä¸Šé¢æˆªå›¾ä¸­å¯ä»¥çœ‹åˆ°åœ¨è¯¥å¸§ä¸­ï¼Œä¸»çº¿ç¨‹çš„sleepingçŠ¶æ€å æ¯”æ˜¯æœ€é«˜çš„ã€‚\nå›åˆ°å·¦è¾¹çš„Janky framesé¢æ¿ï¼Œå†å›åˆ°åˆšæ‰é‚£ä¸€å¸§ï¼Œç„¶åæŒ‰mé”®ä¼šè‡ªåŠ¨æ”¾å¤§è¯¥å¸§çš„è§†å›¾ï¼Œåœ¨ä¸»çº¿ç¨‹è§†å›¾ä¸­æŸ¥çœ‹è·Ÿè¸ªäº‹ä»¶çš„tagã€‚è¿™é‡Œä»‹ç»ç³»ç»Ÿsystem traceä¸­å¸¸è§çš„ä¸€å¸§çš„tagï¼š\ntagåå­— æè¿° Choreographer#doFrame *** æ¯ä¸€å¸§çš„çˆ¶äº‹ä»¶ï¼Œå…¶ä¸­åé¢çš„æ•°å­—æ˜¯vsync input æ¯ä¸€å¸§ä¸­æ‰§è¡Œinputäº‹ä»¶ animation æ¯ä¸€å¸§æ‰§è¡Œanimationäº‹ä»¶ RV Scroll recyclerviewæ»‘åŠ¨äº‹ä»¶ é€‰ä¸­æŸä¸€å¸§çš„Choreographer#doFrameåï¼Œåœ¨å³ä¾§çš„Analysisé¢æ¿ä¼šçœ‹åˆ°è¯¥å¸§çš„ç›¸å…³ä¿¡æ¯ã€‚åˆ†ä¸ºSummaryã€Top Downã€Flame Chartã€Bottom Upã€Eventså‡ ä¸ªtabã€‚\nSummary\nTime Rangeï¼šè¯¥å¸§çš„æ—¶é—´ Data Typeï¼šè¯¥å¸§çš„äº‹ä»¶ç±»å‹ start timeï¼šäº‹ä»¶åœ¨traceä¸­çš„å¼€å§‹æ—¶é—´ Nameï¼šäº‹ä»¶çš„åç§° Wall Durationï¼šäº‹ä»¶ä»å¼€å§‹åˆ°ç»“æŸæ‰€ç»è¿‡çš„å®é™…æ—¶é—´ï¼Œè¿™åŒ…æ‹¬çº¿ç¨‹å¤„äºRunningã€Runnableã€Waitingã€Sleepingç­‰æ‰€æœ‰çŠ¶æ€çš„æ—¶é—´ Wall Self timeï¼šè¯¥æ—¶é—´è¡¨ç¤ºä¸ç®—å­äº‹ä»¶çš„æ—¶é—´ï¼Œåªç®—è‡ªå·±ç­‰å¾…å…¶ä»–æ“ä½œçš„æ—¶é—´ cpu durationï¼šäº‹ä»¶åœ¨cpuä¸Šæ‰§è¡Œçš„å®é™…æ—¶é—´ï¼ŒåŒ…æ‹¬å­äº‹ä»¶çš„æ‰§è¡Œæ—¶é—´ã€‚ä½†æ˜¯è¿™åªåŒ…æ‹¬çº¿ç¨‹å¤„äºrunningçŠ¶æ€ä¸‹çš„æ—¶é—´ï¼Œä¹Ÿå°±æ˜¯å®ƒæ­£åœ¨ä¸»åŠ¨ä½¿ç”¨cpuè¿›è¡Œè®¡ç®—çš„æ—¶é—´ cpu self timeï¼šå’Œä¸Šé¢cpu durationå”¯ä¸€åŒºåˆ«æ˜¯åˆ¨é™¤äº†å­äº‹ä»¶çš„æ‰§è¡Œæ—¶é—´ï¼Œä¹Ÿå°±æ˜¯è‡ªå·±å ç”¨cpuå¤„äºrunningçŠ¶æ€ä¸‹çš„æ—¶é—´ All Occurrencesï¼šè¿™é‡Œæ˜¯ç»Ÿè®¡äº†æ‰€æœ‰ç›¸åŒåå­—çš„äº‹ä»¶æ¬¡æ•°ã€å¹³å‡äº‹ä»¶ã€æœ€å¤§äº‹ä»¶ã€æœ€å°äº‹ä»¶ã€æ‰€æœ‰äº‹ä»¶çš„æ ‡å‡†å·®ï¼Œæ ‡å‡†å·®è¡¡é‡äº†æ•°æ®ç›¸å¯¹äºå¹³å‡å€¼çš„ç¦»æ•£ç¨‹åº¦ï¼Œå€¼è¶Šå¤§è¡¨ç¤ºæ³¢åŠ¨è¶Šå¤§ã€‚å…¶ä¸­è¿™å‡ é¡¹é‡Œé¢çš„æ—¶é—´éƒ½æ˜¯è¡¨ç¤ºWall durationï¼Œä¹Ÿå°±æ˜¯çœŸå®æ‰€ç»è¿‡çš„æ—¶é—´ Longest running occurrencesï¼šæŒ‰è¿è¡Œæ—¶é—´è¿›è¡Œæ’åºçš„äº‹ä»¶ï¼Œé€šè¿‡è¯¥è¡¨å¯ä»¥æ‰¾åˆ°äº‹ä»¶æ¶ˆè€—æœ€ä¹…çš„äº‹ä»¶ï¼Œä»è€Œä¼˜å…ˆå¤„ç†è€—æ—¶æœ€ä¹…çš„äº‹ä»¶ Top Down Top Downå…³æ³¨çš„æ˜¯çˆ¶äº‹ä»¶åˆ°å­äº‹ä»¶çš„å±‚çº§ä¿¡æ¯ Totalï¼šè¯¥äº‹ä»¶æ‰€æ¶ˆè€—çš„å®é™…æ—¶é—´ï¼Œä¹Ÿå°±æ˜¯å‰é¢æåˆ°çš„Wall Duration ç¬¬ä¸€ä¸ªç™¾åˆ†æ¯”ï¼šå½“å‰äº‹ä»¶çš„Totalæ—¶é—´å æ¯”æ ¹äº‹ä»¶çš„Totalæ—¶é—´æ¯”ä¾‹ Selfï¼šä¸ç®—å­äº‹ä»¶çš„Totalæ—¶é—´ï¼Œå¯ä»¥çœ‹å‡ºæ¥æ¯ä¸ªæ—¶é—´çš„totalæ—¶é—´=self+æ‰€æœ‰å­äº‹ä»¶çš„totalæ—¶é—´ ç¬¬äºŒä¸ªç™¾åˆ†æ¯”ï¼šå½“å‰äº‹ä»¶çš„selfæ—¶é—´å æ¯”æ ¹äº‹ä»¶çš„totalæ—¶é—´çš„æ¯”ä¾‹ childrenï¼šå½“å‰äº‹ä»¶çš„æ‰€æœ‰å­äº‹ä»¶çš„å®é™…æ¶ˆè€—æ—¶é—´ ç¬¬ä¸‰ä¸ªç™¾åˆ†æ¯”ï¼šæ‰€æœ‰å­äº‹ä»¶æ¶ˆè€—çš„æ—¶é—´å æ ¹äº‹ä»¶çš„totalæ—¶é—´çš„æ¯”ä¾‹ Flame Chart Flame Chartè§†å›¾ä¹Ÿå«ç«ç„°å›¾ï¼Œä»åº•ä¸‹åˆ°ä¸Šé¢ä¾æ¬¡æ˜¯çˆ¶äº‹ä»¶åˆ°å­äº‹ä»¶ï¼Œè¯¥å›¾èƒ½ç›´è§‚çš„çœ‹åˆ°å­äº‹ä»¶åœ¨çˆ¶äº‹ä»¶ä¸Šçš„å æ¯”,åœ¨çˆ¶äº‹ä»¶ä¸Šå±•ç¤ºå­äº‹ä»¶çš„æ—¶å€™ï¼Œä¼šæŠŠå æ¯”æœ€é•¿çš„æ”¾åœ¨å·¦è¾¹ï¼Œæ‰€ä»¥æ’æŸ¥å­äº‹ä»¶çš„æ—¶å€™ä¼˜å…ˆçœ‹å·¦è¾¹çš„äº‹ä»¶ Bottom Up bottom upè§†å›¾å°†çˆ¶äº‹ä»¶å’Œå­äº‹ä»¶å¹³é“ºå±•å¼€ï¼Œé€šè¿‡å®ƒå¯ä»¥ç›´è§‚çš„çœ‹å‡ºå½“å‰äº‹ä»¶å æ¯”æ ¹äº‹ä»¶çš„å æ¯”ï¼Œä¹Ÿå¯ä»¥ç›´æ¥æŒ‰ç…§æ¯”ä¾‹æ’åºæŸ¥çœ‹å æ¯”é«˜çš„äº‹ä»¶ Events å…¶å®å®ƒæ˜¯å¯¹å‰é¢Summaryè§†å›¾ä¸­çš„All Occurrencesï¼ˆæ‰€æœ‰ç›¸åŒäº‹ä»¶ï¼‰çš„æ±‡æ€»ï¼Œå¹¶æŠŠå„é¡¹ä¿¡æ¯åˆ—å‡ºæ¥ï¼Œæ–¹ä¾¿æˆ‘ä»¬çŸ¥é“æ¯ä¸ªäº‹ä»¶çš„è€—æ—¶ å›åˆ°å‰é¢ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬åœ¨Adapterçš„onBindViewHolderä¸­åŠ å…¥äº†Thread.sleep(50)çš„æ—¶é—´ï¼Œç„¶åå›åˆ°åˆšæ‰é‚£ä¸€å¸§ï¼ŒæŸ¥çœ‹çº¿ç¨‹çš„çŠ¶æ€ï¼š\næˆ‘ä»¬é€‰æ‹©äº†åˆšåˆšçš„é‚£ä¸€å¸§ï¼Œå‘ç°åœ¨å…¶ä¸­ä¸»çº¿ç¨‹ä¸€ç›´å¤„äºsleepçŠ¶æ€ï¼Œé‚£æœ€ç»ˆæ˜¯æ€ä¹ˆå‘ç°æ˜¯åœ¨onBindViewHolderä¸­çº¿ç¨‹å¤„äºä¼‘çœ çŠ¶æ€çš„å‘¢ï¼Œæˆ‘ä»¬çœ‹ä¸‹è¯¥å¸§çš„RV Scrolläº‹ä»¶ï¼š\nåœ¨è¯¥äº‹ä»¶çš„Top Downé¢æ¿ä¸­ï¼Œå¤§éƒ¨åˆ†å ç”¨æ—¶é—´æ˜¯åœ¨RV Scrollä¸­ï¼Œå…¶ä¸­å­äº‹ä»¶çš„æ—¶é—´å ç”¨å¾ˆå°‘ï¼Œåœ¨RV OnBindViewä¸­çš„selfæ—¶é—´å¾ˆå°‘ï¼Œæ˜¯å› ä¸ºå®ƒä¸å ç”¨cpuçš„èµ„æºï¼Œè€Œsystemtraceè®°å½•çš„æ˜¯RV OnBindViewçœŸæ­£å ç”¨cpuçš„è¿è¡Œæ—¶é—´ã€‚æ‰€ä»¥åœ¨RV OnBindViewä¸Šçš„æ—¶é—´å æ¯”å¾ˆå°‘ã€‚æ‰€ä»¥æœ€ç»ˆæ—¶é—´æ¶ˆè€—ä½“ç°åœ¨RV Scrollä¸Šé¢ï¼Œè€Œç»“åˆçº¿ç¨‹çš„çŠ¶æ€ï¼Œæ‰€ä»¥èƒ½ç¡®å®šæ˜¯åœ¨recyclerviewçš„scrollé˜¶æ®µçº¿ç¨‹å‡ºç°äº†å¤§é‡çš„sleepçŠ¶æ€ã€‚\næ¡ˆä¾‹åˆ†æ è¿™æ˜¯ä¸€ä¸ªæ¥å›æ»‘åŠ¨recyclerviewçš„é¡µé¢ï¼Œåœ¨Janky framesæœ‰å¡é¡¿çš„å¸§ï¼Œæˆ‘ä»¬ç‚¹å¼€ç¬¬ä¸€ä¸ªå¡é¡¿å¸§ï¼Œç„¶åä½¿ç”¨Mé”®æ”¾å¤§è¯¥å¸§ï¼š\nè§‚å¯Ÿå¡é¡¿åŸå› æ˜¯åœ¨æ»‘åŠ¨è¿‡ç¨‹ä¸­ä¸€ç›´æœ‰inflateï¼Œé€šè¿‡ä»£ç æŸ¥çœ‹æ˜¯å› ä¸ºè¯¥è§†å›¾å­˜åœ¨recyclerviewåµŒå¥—recyclerviewå¯¼è‡´çš„ï¼Œåœ¨onbindViewHolderä¸­é‡æ–°å»inflateäº†å­å¸ƒå±€å¯¼è‡´ä¼šé‡æ–°inflateï¼Œæ­¤å¤„çš„æ”¹æ³•æ˜¯å°†å¤–å±‚çš„recyclerviewçš„layoutmanageré‡å†™calculateExtraLayoutSpaceæ–¹æ³•ï¼Œç„¶åå°†extraLayoutSpaceçš„ä¸Šä¸‹æ–¹å‘çš„åç§»é‡è®¾ç½®ä¸ºå¤–å±‚recyclerviewé«˜åº¦çš„2å€ã€‚ å‚è€ƒï¼š\nhttps://developer.android.com/studio/profile?hl=zh-cn#start-profiling https://developer.android.com/studio/profile/inspect-traces https://developer.android.com/studio/profile/jank-detection ","date":"2025-06-05T17:39:52+08:00","permalink":"http://xiangcman.xyz/p/android%E5%8D%A1%E9%A1%BF%E6%B2%BB%E7%90%86/","title":"Androidå¡é¡¿æ²»ç†"},{"content":"glideæºç ç²¾é«“æ˜¯èƒ½å­¦ä¹ åˆ°å¾ˆå¤šè®¾è®¡æ¨¡å¼ï¼Œä»¥åŠå¯¹å›¾ç‰‡çš„å„ç§å¤„ç†ï¼Œé¦–å…ˆä»¥æºç é€šè¯»çš„æ–¹å¼è¿›å…¥åˆ°ä»Šå¤©çš„æ–‡ç« ã€‚\nglideæºç æ˜¯åœ¨4.16.0çš„ç‰ˆæœ¬ä¸Šåˆ†æçš„ã€‚ å¹³å¸¸æˆ‘ä»¬ä½¿ç”¨glideæ—¶å€™ç›´æ¥ glide.with(activity).load(url).into(imageview) åŠ è½½å›¾ç‰‡ï¼ŒåŸºäºæ­¤ï¼Œæˆ‘ä»¬é¡ºè—¤æ‘¸ç“œçœ‹ä¸‹åº•å±‚æ˜¯æ€ä¹ˆåŠ è½½å›¾ç‰‡çš„ã€‚\nGlide.with æˆ‘ä»¬æ˜¯åŸºäºå‚æ•°æ˜¯activityçš„é‡è½½æ–¹æ³•ï¼š\n1 2 3 public static RequestManager with(@NonNull Activity activity) { return getRetriever(activity).get(activity); } å…ˆè·å–RequestManagerRetrieverï¼Œç„¶åå†è·å–RequestManagerï¼š\n1 2 3 private static RequestManagerRetriever getRetriever(@Nullable Context context) { return Glide.get(context).getRequestManagerRetriever(); } é¦–å…ˆè°ƒç”¨Glide.get(context)æ–¹æ³•ï¼Œç„¶åé€šè¿‡getRequestManagerRetrieveræ–¹æ³•è·å–åˆ°RequestManagerRetrieverï¼š\n1 2 3 4 5 6 7 8 9 10 public static Glide get(@NonNull Context context) { if (glide == null) { synchronized (Glide.class) { if (glide == null) { checkAndInitializeGlide(context); } } } return glide; } å¯ä»¥çœ‹åˆ°è¯¥æ–¹æ³•æ˜¯ä¸€ä¸ªé™æ€æ–¹æ³•åŠ é”ï¼Œé”çš„æ˜¯æ‰€æœ‰çº¿ç¨‹åˆ›å»ºglideçš„å®ä¾‹ã€‚å¦‚æœglideä¸ºç©ºï¼Œä¼šè°ƒç”¨checkAndInitializeGlideæ–¹æ³•ï¼ŒçŒœæµ‹æ˜¯åˆ›å»ºglideå®ä¾‹çš„æ–¹æ³•ï¼š\næ­¤å¤„ä¸å…è®¸å¤šæ¬¡åˆå§‹åŒ–glideå¯¹è±¡ï¼Œé€šè¿‡ä¸€ä¸ªå¸ƒå°”å€¼æ§åˆ¶ï¼Œå¹¶ä¸”è¯¥å¸ƒå°”å€¼æ˜¯ä¸€ä¸ªvolatileç±»å‹çš„ï¼Œåœ¨å¤šçº¿ç¨‹ä¸­è®¿é—®æ˜¯å®‰å…¨çš„ã€‚æ¥ç€è°ƒç”¨äº†initializeGlideæ–¹æ³•ï¼š\n1 2 3 4 private static void initializeGlide( @NonNull Context context, @Nullable GeneratedAppGlideModule generatedAppGlideModule) { initializeGlide(context, new GlideBuilder(), generatedAppGlideModule); } è°ƒç”¨äº†å¦å¤–ä¸€ä¸ªinitializeGlideæ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 private static void initializeGlide( @NonNull Context context, @NonNull GlideBuilder builder, @Nullable GeneratedAppGlideModule annotationGeneratedModule) { //çœç•¥ä»£ç  Context applicationContext = context.getApplicationContext(); Glide glide = builder.build(applicationContext, manifestModules, annotationGeneratedModule); applicationContext.registerComponentCallbacks(glide); Glide.glide = glide; } æ­¤å¤„çœç•¥äº†é€šè¿‡æ³¨è§£æ¥ç”Ÿæˆå„ç§é…ç½®ï¼Œå…¶ä¸­æ³¨è§£æ˜¯ GlideModule çš„æ³¨è§£ï¼Œå®ƒæ˜¯ä¸€ä¸ªç¼–è¯‘æ—¶æ³¨è§£ï¼Œé€šè¿‡ç¼–è¯‘æ—¶æ‰«æåˆ°è¯¥æ³¨è§£ï¼Œç„¶åç”ŸæˆGeneratedAppGlideModuleImplç±»ï¼ŒinitializeGlideæ˜¯é€šè¿‡åå°„æ‰§è¡ŒGeneratedAppGlideModuleImplç±»ã€‚æœ€ç»ˆé€šè¿‡GlideBuilder.buildæ–¹æ³•æ¥ç”Ÿæˆglideå¯¹è±¡ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 Glide build(@NonNull Context context) { if (sourceExecutor == null) {//è®¿é—®èµ„æºçš„çº¿ç¨‹æ±  sourceExecutor = GlideExecutor.newSourceExecutor(); } if (diskCacheExecutor == null) {//ç¼“å­˜çº¿ç¨‹æ±  diskCacheExecutor = GlideExecutor.newDiskCacheExecutor(); } if (animationExecutor == null) {//åŠ¨ç”»çº¿ç¨‹æ±  animationExecutor = GlideExecutor.newAnimationExecutor(); } if (memorySizeCalculator == null) { memorySizeCalculator = new MemorySizeCalculator.Builder(context).build(); } if (connectivityMonitorFactory == null) { connectivityMonitorFactory = new DefaultConnectivityMonitorFactory(); } if (bitmapPool == null) { int size = memorySizeCalculator.getBitmapPoolSize(); if (size \u0026gt; 0) { bitmapPool = new LruBitmapPool(size); } else { bitmapPool = new BitmapPoolAdapter(); } } if (arrayPool == null) { arrayPool = new LruArrayPool(memorySizeCalculator.getArrayPoolSizeInBytes()); } if (memoryCache == null) { memoryCache = new LruResourceCache(memorySizeCalculator.getMemoryCacheSize()); } if (diskCacheFactory == null) { diskCacheFactory = new InternalCacheDiskCacheFactory(context); } if (engine == null) { engine = new Engine( memoryCache, diskCacheFactory, diskCacheExecutor, sourceExecutor, GlideExecutor.newUnlimitedSourceExecutor(), GlideExecutor.newAnimationExecutor(), isActiveResourceRetentionAllowed); } RequestManagerRetriever requestManagerRetriever = new RequestManagerRetriever(requestManagerFactory); return new Glide( context, engine, memoryCache, bitmapPool, arrayPool, requestManagerRetriever, connectivityMonitorFactory, logLevel, defaultRequestOptions.lock(), defaultTransitionOptions); } åˆå§‹åŒ–çº¿ç¨‹æ± ï¼Œæ„é€ äº†Engineã€RequestManagerRetrieverå¯¹è±¡ï¼Œæœ€ååˆå§‹åŒ–äº†Glideå¯¹è±¡ã€‚æ‰€ä»¥ä¸Šé¢çš„getRequestManagerRetrieveræ–¹æ³•è¿”å›çš„å¯¹è±¡å°±æ˜¯æ­¤å¤„newçš„RequestManagerRetrieverå¯¹è±¡ã€‚æ¥ç€è°ƒç”¨äº†RequestManagerRetrieverçš„getæ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 @NonNull public RequestManager get(@NonNull Context context) { if (context == null) { throw new IllegalArgumentException(\u0026#34;You cannot start a load on a null Context\u0026#34;); } else if (Util.isOnMainThread() \u0026amp;\u0026amp; !(context instanceof Application)) { if (context instanceof FragmentActivity) { return get((FragmentActivity) context); } else if (context instanceof ContextWrapper \u0026amp;\u0026amp; ((ContextWrapper) context).getBaseContext().getApplicationContext() != null) { return get(((ContextWrapper) context).getBaseContext()); } } return getApplicationManager(context); } è¯¥æ–¹æ³•ä¼šè¿”å›ä¸€ä¸ªRequestManagerå¯¹è±¡ï¼Œå¦‚æœcontextä¸æ˜¯Applicationç±»å‹ï¼Œåˆ™é€šè¿‡getæ–¹æ³•åˆ›å»ºRequestManagerå¯¹è±¡ï¼Œå¦‚æœæ˜¯Applicationç±»å‹ï¼Œåˆ™é€šè¿‡getApplicationManageræ–¹æ³•åˆ›å»ºã€‚é¦–å…ˆæ¥çœ‹ä¸‹é€šè¿‡FragmentActivityæ¥åˆ›å»ºRequestManagerå¯¹è±¡ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 public RequestManager get(@NonNull FragmentActivity activity) { //å¦‚æœå½“å‰ä¸æ˜¯ä¸»çº¿ç¨‹ï¼Œåˆ™é€šè¿‡Applicationåˆ›å»º if (Util.isOnBackgroundThread()) { return get(activity.getApplicationContext()); } assertNotDestroyed(activity); frameWaiter.registerSelf(activity); boolean isActivityVisible = isActivityVisible(activity); Glide glide = Glide.get(activity.getApplicationContext()); return lifecycleRequestManagerRetriever.getOrCreate( activity, glide, activity.getLifecycle(), activity.getSupportFragmentManager(), isActivityVisible); } é¦–å…ˆåˆ¤æ–­å½“å‰çº¿ç¨‹å¦‚æœä¸æ˜¯ä¸»çº¿ç¨‹ï¼Œåˆ™é€šè¿‡Applicationåˆ›å»ºRequestManagerï¼Œæ¥ç€åˆ¤æ–­activityæ˜¯å¦å¯è§ï¼Œå¯è§çš„æ¡ä»¶æ˜¯activityæ²¡æœ‰finishæ‰ã€‚æœ€ç»ˆé€šè¿‡LifecycleRequestManagerRetrieverçš„getOrCreateæ–¹æ³•æ¥åˆ›å»ºRequestManagerï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 RequestManager getOrCreate( Context context, Glide glide, final Lifecycle lifecycle, FragmentManager childFragmentManager, boolean isParentVisible) { Util.assertMainThread(); RequestManager result = getOnly(lifecycle); if (result == null) { LifecycleLifecycle glideLifecycle = new LifecycleLifecycle(lifecycle); result = factory.build( glide, glideLifecycle, new SupportRequestManagerTreeNode(childFragmentManager), context); lifecycleToRequestManager.put(lifecycle, result); glideLifecycle.addListener( new LifecycleListener() { @Override public void onStart() {} @Override public void onStop() {} @Override public void onDestroy() { lifecycleToRequestManager.remove(lifecycle); } }); if (isParentVisible) { result.onStart(); } } return result; } å…ˆé€šè¿‡getOnlyä»lifecycleToRequestManagerè¿™ä¸ªmapä¸­å–ï¼Œkeyæ˜¯activityçš„lifecycleå¯¹è±¡ï¼Œå¦‚æœæ²¡æœ‰å–åˆ°åˆ™é€šè¿‡factory.buildæ¥åˆ›å»ºRequestManagerï¼Œfactoryæ˜¯RequestManagerFactoryæ¥å£ï¼Œå®ƒæ˜¯åœ¨glideåˆå§‹åŒ–çš„æ—¶å€™æ„é€ çš„ã€‚LifecycleRequestManagerRetrieverä¸­çš„factoryæ˜¯åœ¨RequestManagerRetrieveræ„é€ æ–¹æ³•ä¸­ä¼ è¿›æ¥çš„ï¼š\n1 2 3 4 5 public RequestManagerRetriever(@Nullable RequestManagerFactory factory) { this.factory = factory != null ? factory : DEFAULT_FACTORY; lifecycleRequestManagerRetriever = new LifecycleRequestManagerRetriever(this.factory); frameWaiter = buildFrameWaiter(); } RequestManagerRetrieveræ„é€ æ–¹æ³•ä¸­é»˜è®¤ä¼ å…¥çš„RequestManagerFactoryæ˜¯ç©ºçš„ï¼Œå› æ­¤ä¼šç”¨DEFAULT_FACTORYï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 private static final RequestManagerFactory DEFAULT_FACTORY = new RequestManagerFactory() { @NonNull @Override public RequestManager build( @NonNull Glide glide, @NonNull Lifecycle lifecycle, @NonNull RequestManagerTreeNode requestManagerTreeNode, @NonNull Context context) { return new RequestManager(glide, lifecycle, requestManagerTreeNode, context); } }; ç›´æ¥newäº†ä¸€ä¸ªRequestManagerå¯¹è±¡ï¼Œå¯è§å…¸å‹çš„å·¥å‚æ¨¡å¼åˆ›å»ºå¯¹è±¡ã€‚\nå°ç»“ Glide.withæ–¹æ³•é‡Œé¢åˆ¤æ–­glideå•ä¾‹å¯¹è±¡æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨å…ˆåœ¨GlideBuilderçš„buildæ–¹æ³•ä¸­åˆ›å»ºå„ç§çº¿ç¨‹æ± ï¼ŒåŒ…æ‹¬è®¿é—®èµ„æºçš„çº¿ç¨‹æ± ï¼Œç¼“å­˜çº¿ç¨‹æ± ï¼ŒåŠ¨ç”»çº¿ç¨‹æ± ç­‰ã€‚ç„¶ååˆ›å»ºEngineå’ŒRequestManagerRetrieverå¯¹è±¡ï¼Œæ¥ç€æŠŠåˆ›å»ºçš„å„ç§çº¿ç¨‹æ± ï¼Œpoolï¼ŒEngineå’ŒRequestManagerRetrieveréƒ½ä¼ å…¥åˆ°Glideå¯¹è±¡ä¸­ï¼Œæ–¹ä¾¿åé¢ä½¿ç”¨ã€‚ä¸Šé¢åœ¨æ„å»ºGlideä¹‹å‰ä¼šåˆ¤æ–­GeneratedAppGlideModuleæ³¨è§£çš„ç±»å­˜ä¸å­˜åœ¨ï¼Œå®ƒæ˜¯é€šè¿‡æ³¨è§£æ¥é…ç½®å„ç§å‚æ•°çš„ç±»ã€‚ æ„å»ºå®ŒGlideå¯¹è±¡åï¼Œæ¥ç€é€šè¿‡RequestManagerRetrieverçš„getæ–¹æ³•åˆ›å»ºRequestManagerï¼Œå…¶ä¸­åˆ›å»ºRequestManagerçš„æ–¹å¼æœ‰Applicationï¼ŒFragmentï¼ŒActivityçš„å½¢å¼ï¼Œæˆ‘ä»¬æ‹¿Activityçš„å½¢å¼åˆ›å»ºæ¥è¯´ï¼Œå¦‚æœå½“å‰çº¿ç¨‹ä¸æ˜¯ä¸»çº¿ç¨‹ï¼Œåˆ™ä½¿ç”¨Applicationçš„å½¢å¼æ¥åˆ›å»ºï¼Œå› ä¸ºéä¸»çº¿ç¨‹æ˜¯ä¸å¸¦ç”Ÿå‘½å‘¨æœŸã€‚æ¥ç€é€šè¿‡LifecycleRequestManagerRetrieverçš„getOrCreateæ–¹æ³•æ¥è·å–RequestManagerï¼Œæ­¤å¤„çš„LifecycleRequestManagerRetrieveræ˜¯åœ¨RequestManagerRetrieveræ„é€ æ–¹æ³•ä¸­åˆ›å»ºçš„ã€‚ LifecycleRequestManagerRetrieverçš„getOrCreateæ–¹æ³•ä¸­é€šè¿‡mapå­˜å‚¨äº†Lifecycleä¸­çš„RequestManagerï¼Œä¹Ÿå°±æ˜¯è¯´æ¯ä¸€ä¸ªLifecycleå¯¹åº”ä¸€ä¸ªRequestManagerã€‚é¦–å…ˆåˆ¤æ–­è¯¥mapä¸­æ˜¯å¦å­˜åœ¨RequestManagerï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œåˆ›å»ºäº†ä¸€ä¸ªLifecycleLifecycleï¼Œå®ƒæ˜¯ä¸€ä¸ªLifecycleObserverå¯¹è±¡ï¼Œå®ƒé€šè¿‡ç›‘å¬Activityç­‰ç±»å‹çš„Lifecycleçš„ç”Ÿå‘½å‘¨æœŸï¼Œæ¥ç®¡ç†Lifecycleå’ŒRequestManagerã€‚ ä¸Šé¢å°±æ˜¯æ•´ä¸ªGlide.withåˆ›å»ºRequestManagerçš„æµç¨‹ã€‚ Glide.with(Context).load(url) ä¸Šé¢åˆ†æäº†Glide.withæ˜¯åˆ›å»ºRequestManagerçš„è¿‡ç¨‹ï¼Œé‚£å…¶å®loadæ–¹æ³•ä¹Ÿå°±å¯¹åº”äº†RequestManagerçš„loadæ–¹æ³•ï¼š\n1 2 3 public RequestBuilder\u0026lt;Drawable\u0026gt; load(@Nullable String string) { return asDrawable().load(string); } æˆ‘ä»¬é€šè¿‡ä¼ è¿›æ¥çš„stringä½œä¸ºè®²è§£ï¼Œé¦–å…ˆè°ƒç”¨äº†asDrawableæ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 public RequestBuilder\u0026lt;Drawable\u0026gt; asDrawable() { return as(Drawable.class); } public \u0026lt;ResourceType\u0026gt; RequestBuilder\u0026lt;ResourceType\u0026gt; as( @NonNull Class\u0026lt;ResourceType\u0026gt; resourceClass) { return new RequestBuilder\u0026lt;\u0026gt;(glide, this, resourceClass, context); } å°†Drawableä½œä¸ºRequestBuilderçš„æ³›å‹ï¼Œå¹¶è¿”å›äº†RequestBuilderå®ä¾‹ï¼Œæ¥ç€çœ‹RequestBuilderçš„loadæ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 public RequestBuilder\u0026lt;TranscodeType\u0026gt; load(@Nullable String string) { return loadGeneric(string); } private RequestBuilder\u0026lt;TranscodeType\u0026gt; loadGeneric(@Nullable Object model) { if (isAutoCloneEnabled()) { return clone().loadGeneric(model); } this.model = model; isModelSet = true; return selfOrThrowIfLocked(); } loadæ–¹æ³•å°†urlä¼ ç»™äº†RequestBuilderçš„modelå±æ€§ï¼Œç„¶åè¿”å›è‡ªå·±ã€‚\nGlide.with(Context).load(url).into(imageView) è°ƒå®Œloadæ–¹æ³•ï¼Œå®é™…å°±è¿”å›äº†RequestBuilderå¯¹è±¡äº†ã€‚æ‰€ä»¥intoå°±æ˜¯å®ƒçš„æ–¹æ³•äº†ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 public ViewTarget\u0026lt;ImageView, TranscodeType\u0026gt; into(@NonNull ImageView view) { Util.assertMainThread(); BaseRequestOptions\u0026lt;?\u0026gt; requestOptions = this; if (!requestOptions.isTransformationSet() \u0026amp;\u0026amp; requestOptions.isTransformationAllowed() \u0026amp;\u0026amp; view.getScaleType() != null) { switch (view.getScaleType()) { case CENTER_CROP: requestOptions = requestOptions.clone().optionalCenterCrop(); break; case CENTER_INSIDE: requestOptions = requestOptions.clone().optionalCenterInside(); break; case FIT_CENTER: case FIT_START: case FIT_END: requestOptions = requestOptions.clone().optionalFitCenter(); break; case FIT_XY: requestOptions = requestOptions.clone().optionalCenterInside(); break; case CENTER: case MATRIX: default: } } return into( glideContext.buildImageViewTarget(view, transcodeClass), /* targetListener= */ null, requestOptions, Executors.mainThreadExecutor()); } RequestBbuilderç»§æ‰¿è‡ªBaseRequestOptionsï¼Œåœ¨intoé‡Œé¢é¦–å…ˆé€šè¿‡imageViewçš„scaleTypeï¼Œç„¶åç”Ÿæˆä¸åŒçš„BaseRequestOptionsï¼Œç„¶åé€šè¿‡glideContext.buildImageViewTargetæ–¹æ³•å°†ImageViewåŒ…è£…æˆViewTargetï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 public \u0026lt;X\u0026gt; ViewTarget\u0026lt;ImageView, X\u0026gt; buildImageViewTarget( @NonNull ImageView imageView, @NonNull Class\u0026lt;X\u0026gt; transcodeClass) { return imageViewTargetFactory.buildTarget(imageView, transcodeClass); } public \u0026lt;Z\u0026gt; ViewTarget\u0026lt;ImageView, Z\u0026gt; buildTarget( @NonNull ImageView view, @NonNull Class\u0026lt;Z\u0026gt; clazz) { if (Bitmap.class.equals(clazz)) { return (ViewTarget\u0026lt;ImageView, Z\u0026gt;) new BitmapImageViewTarget(view); } else if (Drawable.class.isAssignableFrom(clazz)) { return (ViewTarget\u0026lt;ImageView, Z\u0026gt;) new DrawableImageViewTarget(view); } } ä¸Šé¢åˆ†æè¿‡clazzä¼ è¿›æ¥çš„æ˜¯Drawable.classï¼Œæ‰€ä»¥ä¼šåŒ…è£…æˆDrawableImageViewTargetã€‚ æ¥ç€è°ƒç”¨äº†å¦å¤–ä¸€ä¸ªintoæ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 private \u0026lt;Y extends Target\u0026lt;TranscodeType\u0026gt;\u0026gt; Y into( @NonNull Y target, @Nullable RequestListener\u0026lt;TranscodeType\u0026gt; targetListener, BaseRequestOptions\u0026lt;?\u0026gt; options, Executor callbackExecutor) { Request request = buildRequest(target, targetListener, options, callbackExecutor); Request previous = target.getRequest(); if (request.isEquivalentTo(previous) \u0026amp;\u0026amp; !isSkipMemoryCacheWithCompletePreviousRequest(options, previous)) { if (!Preconditions.checkNotNull(previous).isRunning()) { previous.begin(); } return target; } requestManager.clear(target); target.setRequest(request); requestManager.track(target, request); return target; } é¦–å…ˆè°ƒç”¨äº†buildRequestæ–¹æ³•æ¥æ„å»ºRequestï¼Œç„¶åè·å–targetçš„requestå’Œå½“å‰requestæ˜¯ä¸æ˜¯åŒä¸€ä¸ªï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œåˆ™ç›´æ¥è¿”å›å·²ç»å­˜åœ¨çš„targetï¼Œå¦åˆ™è°ƒç”¨requestManager.trackï¼Œæˆ‘ä»¬å…ˆçœ‹buildRequestï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 private Request buildRequest( Target\u0026lt;TranscodeType\u0026gt; target, @Nullable RequestListener\u0026lt;TranscodeType\u0026gt; targetListener, BaseRequestOptions\u0026lt;?\u0026gt; requestOptions, Executor callbackExecutor) { return buildRequestRecursive( /* requestLock= */ new Object(), target, targetListener, /* parentCoordinator= */ null, transitionOptions, requestOptions.getPriority(), requestOptions.getOverrideWidth(), requestOptions.getOverrideHeight(), requestOptions, callbackExecutor); } private Request buildRequestRecursive( Object requestLock, Target\u0026lt;TranscodeType\u0026gt; target, @Nullable RequestListener\u0026lt;TranscodeType\u0026gt; targetListener, @Nullable RequestCoordinator parentCoordinator, TransitionOptions\u0026lt;?, ? super TranscodeType\u0026gt; transitionOptions, Priority priority, int overrideWidth, int overrideHeight, BaseRequestOptions\u0026lt;?\u0026gt; requestOptions, Executor callbackExecutor) { Request mainRequest = buildThumbnailRequestRecursive( requestLock, target, targetListener, parentCoordinator, transitionOptions, priority, overrideWidth, overrideHeight, requestOptions, callbackExecutor); return mainRequest; } ä¸Šé¢çš„buildRequestRecursiveæ–¹æ³•çœå»äº†errorBuilderç›¸å…³çš„å¤„ç†ï¼Œé»˜è®¤æ˜¯ä¸ç”¨å»å¤„ç†çš„ï¼Œæ‰€ä»¥å¯ä»¥çœ‹åˆ°ä¸Šé¢æ„å»ºRequestå®é™…è°ƒç”¨äº†buildThumbnailRequestRecursiveæ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 private Request buildThumbnailRequestRecursive( Object requestLock, Target\u0026lt;TranscodeType\u0026gt; target, RequestListener\u0026lt;TranscodeType\u0026gt; targetListener, @Nullable RequestCoordinator parentCoordinator, TransitionOptions\u0026lt;?, ? super TranscodeType\u0026gt; transitionOptions, Priority priority, int overrideWidth, int overrideHeight, BaseRequestOptions\u0026lt;?\u0026gt; requestOptions, Executor callbackExecutor) { return obtainRequest( requestLock, target, targetListener, requestOptions, parentCoordinator, transitionOptions, priority, overrideWidth, overrideHeight, callbackExecutor); } ä¸Šé¢ä¹Ÿæ˜¯çœå»äº†å…¶ä»–ç›¸å…³é€»è¾‘ï¼Œæ‰€ä»¥æˆ‘ä»¬ç›´æ¥çœ‹obtainRequestæ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 private Request obtainRequest( Object requestLock, Target\u0026lt;TranscodeType\u0026gt; target, RequestListener\u0026lt;TranscodeType\u0026gt; targetListener, BaseRequestOptions\u0026lt;?\u0026gt; requestOptions, RequestCoordinator requestCoordinator, TransitionOptions\u0026lt;?, ? super TranscodeType\u0026gt; transitionOptions, Priority priority, int overrideWidth, int overrideHeight, Executor callbackExecutor) { return SingleRequest.obtain( context, glideContext, requestLock, model, transcodeClass, requestOptions, overrideWidth, overrideHeight, priority, target, targetListener, requestListeners, requestCoordinator, glideContext.getEngine(), transitionOptions.getTransitionFactory(), callbackExecutor); } public static \u0026lt;R\u0026gt; SingleRequest\u0026lt;R\u0026gt; obtain( Context context, GlideContext glideContext, Object requestLock, Object model, Class\u0026lt;R\u0026gt; transcodeClass, BaseRequestOptions\u0026lt;?\u0026gt; requestOptions, int overrideWidth, int overrideHeight, Priority priority, Target\u0026lt;R\u0026gt; target, RequestListener\u0026lt;R\u0026gt; targetListener, @Nullable List\u0026lt;RequestListener\u0026lt;R\u0026gt;\u0026gt; requestListeners, RequestCoordinator requestCoordinator, Engine engine, TransitionFactory\u0026lt;? super R\u0026gt; animationFactory, Executor callbackExecutor) { return new SingleRequest\u0026lt;\u0026gt;( context, glideContext, requestLock, model, transcodeClass, requestOptions, overrideWidth, overrideHeight, priority, target, targetListener, requestListeners, requestCoordinator, engine, animationFactory, callbackExecutor); } ä¸Šé¢éƒ½æ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œç›´æ¥newäº†ä¸€ä¸ªSingleRequestï¼Œæ­¤å¤„SingleRequestçš„å‘å‹æ˜¯Drawableï¼Œè¿™æ˜¯åœ¨ä¸Šé¢åˆ†æloadçš„æ—¶å€™çŸ¥é“çš„ï¼Œå…ˆæ˜ç¡®è¿™ç‚¹ã€‚æˆ‘ä»¬å†å›åˆ°ä¸Šé¢RequestBuilderçš„intoæ–¹æ³•ï¼Œå…ˆæ„å»ºä¸€ä¸ªSingleRequestï¼Œç„¶åçœ‹å½“å‰targetçš„requestå’Œæ„å»ºçš„SingleRequestæ˜¯ä¸æ˜¯åŒä¸€ä¸ªï¼Œå¦‚æœæ˜¯ç›´æ¥è¿”å›ï¼Œå¦‚æœä¸æ˜¯è°ƒç”¨requestManager.trackï¼Œå…ˆçœ‹target.getRequestï¼Œå‰é¢åˆ†æè¿‡targetæ˜¯ä¸€ä¸ªDrawableImageViewTargetï¼Œå®ƒçš„çˆ¶çˆ¶ç±»ViewTargetï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 public Request getRequest() { Object tag = getTag(); Request request = null; if (tag != null) { if (tag instanceof Request) { request = (Request) tag; } else { throw new IllegalArgumentException( \u0026#34;You must not call setTag() on a view Glide is targeting\u0026#34;); } } return request; } private static int tagId = R.id.glide_custom_view_target_tag; private Object getTag() { return view.getTag(tagId); } public void setRequest(@Nullable Request request) { setTag(request); } private void setTag(@Nullable Object tag) { isTagUsedAtLeastOnce = true; view.setTag(tagId, tag); } å¯ä»¥çœ‹åˆ°requestæ˜¯å¡å…¥åˆ°viewçš„tagä¸Šï¼Œå¹¶ä¸”è¯¥tagæ˜¯ç»‘å®šäº†ä¸€ä¸ªidã€‚æ¥ç€çœ‹ä¸‹requestManager.trackï¼š\n1 2 3 4 synchronized void track(@NonNull Target\u0026lt;?\u0026gt; target, @NonNull Request request) { targetTracker.track(target); requestTracker.runRequest(request); } å°†targetæ”¾åˆ°TargetTrackerä¸­ï¼š\n1 2 3 4 5 private final Set\u0026lt;Target\u0026lt;?\u0026gt;\u0026gt; targets = Collections.newSetFromMap(new WeakHashMap\u0026lt;Target\u0026lt;?\u0026gt;, Boolean\u0026gt;()); public void track(@NonNull Target\u0026lt;?\u0026gt; target) { targets.add(target); } å°†targetåªæ˜¯æ”¾åˆ°seté›†åˆä¸­ï¼Œåé¢ä¼šç”¨åˆ°ï¼Œå…ˆä¸ç”¨ç®¡ã€‚é‡è¦çœ‹RequestTrackerçš„runRequestæ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 private final Set\u0026lt;Request\u0026gt; requests = Collections.newSetFromMap(new WeakHashMap\u0026lt;Request, Boolean\u0026gt;()); public void runRequest(@NonNull Request request) { requests.add(request); if (!isPaused) { request.begin(); } else { request.clear(); pendingRequests.add(request); } } é¦–å…ˆå°†requestä¹Ÿæ˜¯æ”¾åˆ°seté›†åˆä¸­ï¼Œæ¥ç€åˆ¤æ–­å½“å‰æ˜¯ä¸æ˜¯pauseçŠ¶æ€ï¼Œé»˜è®¤ä¸æ˜¯pauseçŠ¶æ€ï¼Œåˆ™è°ƒç”¨requestçš„beginæ–¹æ³•ï¼Œå‰é¢åˆ†æè¿‡è¯¥requestå®é™…æ˜¯SingleRequestï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 public void begin() { synchronized (requestLock) { experimentalNotifyRequestStarted(model); status = Status.WAITING_FOR_SIZE;//é»˜è®¤çŠ¶æ€ //å¦‚æœé‡å†™äº†overrideæ–¹æ³•æ¥åˆ¶å®šåŠ è½½å›¾ç‰‡çš„å¤§å° if (Util.isValidDimensions(overrideWidth, overrideHeight)) { onSizeReady(overrideWidth, overrideHeight); } else { //å¦‚æœæ²¡æœ‰åˆ¶å®šå¤§å°èµ°æ­¤å¤„ target.getSize(this); } if ((status == Status.RUNNING || status == Status.WAITING_FOR_SIZE) \u0026amp;\u0026amp; canNotifyStatusChanged()) { //å›è°ƒstartçš„çŠ¶æ€ target.onLoadStarted(getPlaceholderDrawable()); } } } å¦‚æœæ²¡æœ‰é€šè¿‡overrideæ–¹æ³•åˆ¶å®šåŠ è½½å›¾ç‰‡çš„å¤§å°ï¼Œåˆ™è°ƒç”¨target.getSizeæ–¹æ³•ï¼š\n1 2 3 public void getSize(@NonNull SizeReadyCallback cb) { sizeDeterminer.getSize(cb); } è°ƒç”¨äº†å†…éƒ¨ç±»SizeDeterminerçš„getSizeæ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 void getSize(@NonNull SizeReadyCallback cb) { //è·å–targetçš„å®½é«˜ int currentWidth = getTargetWidth(); int currentHeight = getTargetHeight(); //å¦‚æœå®½é«˜æ ¡éªŒé€šè¿‡åˆ™å›è°ƒåˆ°SingleRequestçš„onSizeReady if (isViewStateAndSizeValid(currentWidth, currentHeight)) { cb.onSizeReady(currentWidth, currentHeight); return; } if (!cbs.contains(cb)) { cbs.add(cb); } if (layoutListener == null) { ViewTreeObserver observer = view.getViewTreeObserver(); layoutListener = new SizeDeterminerLayoutListener(this); //å¦åˆ™ç›‘å¬ç»˜åˆ¶çš„å‰ç½®äº‹ä»¶ observer.addOnPreDrawListener(layoutListener); } } è·å–targetçš„å®½é«˜ï¼Œå¦‚æœå®½é«˜æ ¡éªŒé€šè¿‡åˆ™å›è°ƒåˆ°SingleRequestä¸­ï¼Œå¦åˆ™ç›‘å¬targetçš„ç»˜åˆ¶å‰ç½®äº‹ä»¶ã€‚æˆ‘ä»¬çœ‹ä¸‹å¦‚ä½•è·å–å®½é«˜çš„ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 private int getTargetWidth() { int horizontalPadding = view.getPaddingLeft() + view.getPaddingRight(); LayoutParams layoutParams = view.getLayoutParams(); int layoutParamSize = layoutParams != null ? layoutParams.width : PENDING_SIZE; return getTargetDimen(view.getWidth(), layoutParamSize, horizontalPadding); } private int getTargetDimen(int viewSize, int paramSize, int paddingSize) { int adjustedParamSize = paramSize - paddingSize; //å¦‚æœlayoutParamsä¸­è®¾ç½®äº†ç²¾ç¡®å®½åº¦ if (adjustedParamSize \u0026gt; 0) { return adjustedParamSize; } //é»˜è®¤ä¸èµ°è¿™é‡Œ if (waitForLayout \u0026amp;\u0026amp; view.isLayoutRequested()) { return PENDING_SIZE; } //é»˜è®¤viewSizeç­‰äº0ï¼Œä¹Ÿä¸èµ°è¿™é‡Œ int adjustedViewSize = viewSize - paddingSize; if (adjustedViewSize \u0026gt; 0) { return adjustedViewSize; } //å¦‚æœimageViewæ²¡æœ‰ç»è¿‡æµ‹é‡ï¼Œå¹¶ä¸”å®½åº¦è®¾ç½®çš„æ˜¯WRAP_CONTENTï¼Œèµ°è¿™é‡Œ if (!view.isLayoutRequested() \u0026amp;\u0026amp; paramSize == LayoutParams.WRAP_CONTENT) { return getMaxDisplayLength(view.getContext()); } return PENDING_SIZE; } æˆ‘ä»¬åªåˆ†æå®½åº¦å’Œé«˜åº¦ä¸ºLayoutParams. WRAP_CONTENTæƒ…å†µï¼Œæ­¤æ—¶ä¼šè°ƒgetMaxDisplayLengthï¼š\n1 2 3 4 5 6 7 8 9 10 11 private static int getMaxDisplayLength(@NonNull Context context) { if (maxDisplayLength == null) { WindowManager windowManager = (WindowManager) context.getSystemService(Context.WINDOW_SERVICE); Display display = Preconditions.checkNotNull(windowManager).getDefaultDisplay(); Point displayDimensions = new Point(); display.getSize(displayDimensions); maxDisplayLength = Math.max(displayDimensions.x, displayDimensions.y); } return maxDisplayLength; } å¯ä»¥çœ‹åˆ°è·å–çš„æ˜¯å±å¹•çš„å®½é«˜ï¼Œæ‰€ä»¥å¦‚æœæ²¡æœ‰imageViewå®šå®½é«˜ï¼Œå¹¶ä¸”è¿˜æ²¡åˆ°æµ‹é‡çš„æ—¶å€™ï¼Œæ­¤æ—¶è®¾ç½®çš„åˆå§‹å®½é«˜æ˜¯å±å¹•å®½é«˜çš„æœ€å¤§å€¼ã€‚è·å–åˆ°é»˜è®¤å®½é«˜åä¼šå›è°ƒåˆ°SingleRequestçš„onSizeReadyï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 public void onSizeReady(int width, int height) { synchronized (requestLock) { if (status != Status.WAITING_FOR_SIZE) { return; } status = Status.RUNNING; loadStatus = engine.load( glideContext, model, requestOptions.getSignature(), this.width, this.height, requestOptions.getResourceClass(), transcodeClass, priority, requestOptions.getDiskCacheStrategy(), requestOptions.getTransformations(), requestOptions.isTransformationRequired(), requestOptions.isScaleOnlyOrNoTransform(), requestOptions.getOptions(), requestOptions.isMemoryCacheable(), requestOptions.getUseUnlimitedSourceGeneratorsPool(), requestOptions.getUseAnimationPool(), requestOptions.getOnlyRetrieveFromCache(), this, callbackExecutor); if (status != Status.RUNNING) { loadStatus = null; } } } è°ƒç”¨äº†Engineçš„loadæ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 public \u0026lt;R\u0026gt; LoadStatus load( GlideContext glideContext, Object model, Key signature, int width, int height, Class\u0026lt;?\u0026gt; resourceClass, Class\u0026lt;R\u0026gt; transcodeClass, Priority priority, DiskCacheStrategy diskCacheStrategy, Map\u0026lt;Class\u0026lt;?\u0026gt;, Transformation\u0026lt;?\u0026gt;\u0026gt; transformations, boolean isTransformationRequired, boolean isScaleOnlyOrNoTransform, Options options, boolean isMemoryCacheable, boolean useUnlimitedSourceExecutorPool, boolean useAnimationPool, boolean onlyRetrieveFromCache, ResourceCallback cb, Executor callbackExecutor) { //æ„å»ºEngineKeyï¼Œç”±äºä¸éœ€è¦å¤–éƒ¨å»æ§åˆ¶keyï¼Œæ‰€ä»¥keyFactoryæ˜¯ä¸€ä¸ªæ™®é€šçš„factoryï¼Œä¸éœ€è¦è¿›è¡Œæ‰©å±• EngineKey key = keyFactory.buildKey( model, signature, width, height, transformations, resourceClass, transcodeClass, options); EngineResource\u0026lt;?\u0026gt; memoryResource; synchronized (this) { //ä»å†…å­˜ä¸­åŠ è½½ memoryResource = loadFromMemory(key, isMemoryCacheable, startTime); if (memoryResource == null) { //å¦‚æœå†…å­˜ä¸­ä¸å­˜åœ¨ï¼Œèµ°è¿™é‡Œ return waitForExistingOrStartNewJob( glideContext, model, signature, width, height, resourceClass, transcodeClass, priority, diskCacheStrategy, transformations, isTransformationRequired, isScaleOnlyOrNoTransform, options, isMemoryCacheable, useUnlimitedSourceExecutorPool, useAnimationPool, onlyRetrieveFromCache, cb, callbackExecutor, key, startTime); } } cb.onResourceReady( memoryResource, DataSource.MEMORY_CACHE, /* isLoadedFromAlternateCacheKey= */ false); return null; } å…ˆä¸ç”¨ç®¡å†…å­˜åŠ è½½è¿™å—ï¼Œç›´æ¥çœ‹waitForExistingOrStartNewJobæ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 private \u0026lt;R\u0026gt; LoadStatus waitForExistingOrStartNewJob( GlideContext glideContext, Object model, Key signature, int width, int height, Class\u0026lt;?\u0026gt; resourceClass, Class\u0026lt;R\u0026gt; transcodeClass, Priority priority, DiskCacheStrategy diskCacheStrategy, Map\u0026lt;Class\u0026lt;?\u0026gt;, Transformation\u0026lt;?\u0026gt;\u0026gt; transformations, boolean isTransformationRequired, boolean isScaleOnlyOrNoTransform, Options options, boolean isMemoryCacheable, boolean useUnlimitedSourceExecutorPool, boolean useAnimationPool, boolean onlyRetrieveFromCache, ResourceCallback cb, Executor callbackExecutor, EngineKey key, long startTime) { //ä»å·²å­˜åœ¨çš„jobåˆ—è¡¨ä¸­æ‰¾ç›¸åŒçš„EngineJob EngineJob\u0026lt;?\u0026gt; current = jobs.get(key, onlyRetrieveFromCache); if (current != null) { current.addCallback(cb, callbackExecutor); return new LoadStatus(cb, current); } //å¦‚æœæ²¡æœ‰æ‰¾åˆ°ç›¸åŒçš„EngineJobï¼Œåˆ™æ„å»ºä¸€ä¸ªæ–°çš„å‡ºæ¥ EngineJob\u0026lt;R\u0026gt; engineJob = engineJobFactory.build( key, isMemoryCacheable, useUnlimitedSourceExecutorPool, useAnimationPool, onlyRetrieveFromCache); //æ„å»ºDecodeJob DecodeJob\u0026lt;R\u0026gt; decodeJob = decodeJobFactory.build( glideContext, model, key, signature, width, height, resourceClass, transcodeClass, priority, diskCacheStrategy, transformations, isTransformationRequired, isScaleOnlyOrNoTransform, onlyRetrieveFromCache, options, engineJob); //å°†æ„å»ºå¥½çš„EngineJobæ”¾åˆ°jobåˆ—è¡¨ä¸­ jobs.put(key, engineJob); //å°†cbæ·»åŠ åˆ°EngineJobä¸­ä½œä¸ºå›è°ƒï¼Œè¿™é‡Œçš„cbæ˜¯å‰é¢çš„SingleRequest engineJob.addCallback(cb, callbackExecutor); //è§¦å‘åŠ è½½é€»è¾‘ engineJob.start(decodeJob); return new LoadStatus(cb, engineJob); } ä¸Šé¢åˆ›å»ºEngineJobå’ŒDecodeJobï¼Œä»åå­—çœ‹EngineJobæ˜¯ä¸“é—¨ç”¨æ¥åŠ è½½ä¸»é€»è¾‘çš„Jobï¼ŒDecodeJobæ˜¯è§£ç ç”¨çš„ã€‚å…ˆä¸ç®¡å®ƒä»¬æ˜¯æ€ä¹ˆåˆ›å»ºçš„ï¼Œåé¢ä¼šè®²åˆ°ï¼Œç›´æ¥çœ‹EngineJobçš„startæ–¹æ³•ï¼š\n1 2 3 4 5 6 public synchronized void start(DecodeJob\u0026lt;R\u0026gt; decodeJob) { this.decodeJob = decodeJob; GlideExecutor executor = decodeJob.willDecodeFromCache() ? diskCacheExecutor : getActiveSourceExecutor(); executor.execute(decodeJob); } æ­¤æ—¶å°†DecodeJobä½œä¸ºrunnableæ”¾åˆ°çº¿ç¨‹æ± ä¸­æ‰§è¡Œï¼Œçœ‹ä¸‹å®ƒçš„runæ–¹æ³•ï¼š\n1 2 3 public void run() { runWrapped(); } å…¶ä½™çš„ä»£ç åˆ é™¤æ‰äº†ï¼Œåªä¿ç•™æ ¸å¿ƒçš„æ–¹æ³•è°ƒç”¨ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 private void runWrapped() { switch (runReason) { case INITIALIZE: stage = getNextStage(Stage.INITIALIZE); currentGenerator = getNextGenerator(); runGenerators(); break; case SWITCH_TO_SOURCE_SERVICE: runGenerators(); break; case DECODE_DATA: decodeFromRetrievedData(); break; } } runReasonçš„é»˜è®¤å€¼æ˜¯INITIALIZEï¼Œç„¶åè°ƒç”¨getNextStageè·å–åˆ°å½“å‰stageï¼Œç„¶åé€šè¿‡getNextGeneratorè·å–ä¸‹ä¸€ä¸ªgeneratorï¼Œç„¶åè°ƒç”¨runGeneratorsæ¥æ‰§è¡Œgeneratorï¼Œæ¥çœ‹ä¸‹è¿™ä¸€æ®µé€»è¾‘ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 private Stage getNextStage(Stage current) { switch (current) { case INITIALIZE: return diskCacheStrategy.decodeCachedResource() ? Stage.RESOURCE_CACHE : getNextStage(Stage.RESOURCE_CACHE); case RESOURCE_CACHE: return diskCacheStrategy.decodeCachedData() ? Stage.DATA_CACHE : getNextStage(Stage.DATA_CACHE); case DATA_CACHE: return onlyRetrieveFromCache ? Stage.FINISHED : Stage.SOURCE; case SOURCE: case FINISHED: return Stage.FINISHED; default: throw new IllegalArgumentException(\u0026#34;Unrecognized stage: \u0026#34; + current); } } é»˜è®¤æ˜¯æ”¯æŒdecodeCachedResourceçš„ï¼Œå®ƒè¡¨ç¤ºæ˜¯å¦è·å–è§£ç åçš„ç¼“å­˜èµ„æºï¼Œæ‰€ä»¥æ­¤æ—¶è¿”å›Stage. RESOURCE_CACHEï¼Œæ¥ç€è°ƒç”¨getNextGeneratoræ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 private DataFetcherGenerator getNextGenerator() { switch (stage) { case RESOURCE_CACHE: return new ResourceCacheGenerator(decodeHelper, this); case DATA_CACHE: return new DataCacheGenerator(decodeHelper, this); case SOURCE: return new SourceGenerator(decodeHelper, this); case FINISHED: return null; default: throw new IllegalStateException(\u0026#34;Unrecognized stage: \u0026#34; + stage); } } åˆ›å»ºäº†ResourceCacheGeneratorï¼Œç„¶åè°ƒç”¨runGeneratorsæ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 private void runGenerators() { boolean isStarted = false; //è°ƒç”¨å½“å‰çš„generatorï¼Œå¦‚æœå®ƒçš„startNextæ–¹æ³•è¿”å›falseï¼Œåˆ™ç»§ç»­è·å–ä¸‹ä¸€ä¸ªstageï¼Œå¹¶ç»§ç»­è°ƒç”¨ä¸‹ä¸€ä¸ªgeneratorçš„startNextæ–¹æ³• while (!isCancelled \u0026amp;\u0026amp; currentGenerator != null \u0026amp;\u0026amp; !(isStarted = currentGenerator.startNext())) { stage = getNextStage(stage); currentGenerator = getNextGenerator(); if (stage == Stage.SOURCE) { reschedule(RunReason.SWITCH_TO_SOURCE_SERVICE); return; } } if ((stage == Stage.FINISHED || isCancelled) \u0026amp;\u0026amp; !isStarted) { notifyFailed(); } } æˆ‘ä»¬ç›´æ¥çœ‹stageä¸ºSOURCE, generatorç›´æ¥æ˜¯SourceGeneratoræ—¶å€™ï¼Œçœ‹ä¸‹å®ƒçš„startNextæ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 public boolean startNext() { //å¦‚æœå·²ç»ç¼“å­˜ä¸Šäº†ï¼Œç›´æ¥ç”¨ç¼“å­˜çš„æ•°æ® if (dataToCache != null) { Object data = dataToCache; dataToCache = null; try { boolean isDataInCache = cacheData(data); if (!isDataInCache) { return true; } } catch (IOException e) { } } //å¦‚æœsourceCacheGeneratorä¸­èƒ½æ‹¿åˆ°æ•°æ®ç›´æ¥è¿”å› if (sourceCacheGenerator != null \u0026amp;\u0026amp; sourceCacheGenerator.startNext()) { return true; } sourceCacheGenerator = null; loadData = null; boolean started = false; //ä»DecodeHelperä¸­è·å–loadData while (!started \u0026amp;\u0026amp; hasNextModelLoader()) { loadData = helper.getLoadData().get(loadDataListIndex++); if (loadData != null \u0026amp;\u0026amp; (helper.getDiskCacheStrategy().isDataCacheable(loadData.fetcher.getDataSource()) || helper.hasLoadPath(loadData.fetcher.getDataClass()))) { started = true; //å¦‚æœå­˜åœ¨loadDataåˆ™è°ƒè¯¥æ–¹æ³• startNextLoad(loadData); } } return started; } startNextä¸­é¦–å…ˆä»DecodeHelperä¸­è·å–åˆ°loadDataï¼Œæ­¤å¤„æˆ‘ä»¬å…ˆä¸ç”¨ç®¡æ€ä¹ˆè·å–åˆ°loadDataï¼Œè·å–åˆ°loadDataåè°ƒç”¨startNextLoadæ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 private void startNextLoad(final LoadData\u0026lt;?\u0026gt; toStart) { loadData.fetcher.loadData( helper.getPriority(), new DataCallback\u0026lt;Object\u0026gt;() { @Override public void onDataReady(@Nullable Object data) { if (isCurrentRequest(toStart)) { onDataReadyInternal(toStart, data); } } @Override public void onLoadFailed(@NonNull Exception e) { if (isCurrentRequest(toStart)) { onLoadFailedInternal(toStart, e); } } }); } æ­¤æ—¶è°ƒç”¨loadDataä¸­çš„fetcherçš„loadDataæ–¹æ³•ï¼Œæ­¤å¤„çš„loadData.fetcheræ˜¯è°å‘¢ï¼Ÿè¿™ä¸ªåé¢çš„ç« èŠ‚å†äº†è§£ï¼Œå…ˆçŸ¥é“æ˜¯HttpUrlFetcherï¼Œç„¶åçœ‹ä¸‹å®ƒçš„loadDataæ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 public void loadData( @NonNull Priority priority, @NonNull DataCallback\u0026lt;? super InputStream\u0026gt; callback) { try { InputStream result = loadDataWithRedirects(glideUrl.toURL(), 0, null, glideUrl.getHeaders()); callback.onDataReady(result); } catch (IOException e) { callback.onLoadFailed(e); } } è°ƒç”¨äº†loadDataWithRedirectsæ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 private InputStream loadDataWithRedirects( URL url, int redirects, URL lastUrl, Map\u0026lt;String, String\u0026gt; headers) throws HttpException { urlConnection = buildAndConfigureConnection(url, headers); try { urlConnection.connect(); stream = urlConnection.getInputStream(); } catch (IOException e) { throw new HttpException( \u0026#34;Failed to connect or obtain data\u0026#34;, getHttpStatusCodeOrInvalid(urlConnection), e); } if (isCancelled) { return null; } final int statusCode = getHttpStatusCodeOrInvalid(urlConnection); if (isHttpOk(statusCode)) { return getStreamForSuccessfulRequest(urlConnection); } } é€šè¿‡buildAndConfigureConnectionåˆ›å»ºäº†HttpURLConnectionï¼Œæ¥ç€é€šè¿‡codeç è§£æå¯¹åº”çš„InputStreamï¼Œç»“æŸåå›è°ƒåˆ°SourceGeneratorå†…éƒ¨ç±»DataCallbackçš„onDataReadyï¼Œç„¶åå›è°ƒåˆ°SourceGeneratorçš„onDataReadyInternalï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 void onDataReadyInternal(LoadData\u0026lt;?\u0026gt; loadData, Object data) { DiskCacheStrategy diskCacheStrategy = helper.getDiskCacheStrategy(); if (data != null \u0026amp;\u0026amp; diskCacheStrategy.isDataCacheable(loadData.fetcher.getDataSource())) { dataToCache = data; cb.reschedule(); } else { cb.onDataFetcherReady( loadData.sourceKey, data, loadData.fetcher, loadData.fetcher.getDataSource(), originalKey); } } å°†è·å–åˆ°çš„æ•°æ®ç»™åˆ°dataToCacheï¼Œå¹¶ä¸”å›è°ƒåˆ°DecodeJobçš„rescheduleæ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 public void reschedule() { reschedule(RunReason.SWITCH_TO_SOURCE_SERVICE); } private void reschedule(RunReason runReason) { this.runReason = runReason; callback.reschedule(this); } æ­¤å¤„çš„callbackæ˜¯EngineJobï¼Œç»§ç»­å›è°ƒåˆ°rescheduleï¼š\n1 2 3 public void reschedule(DecodeJob\u0026lt;?\u0026gt; job) { getActiveSourceExecutor().execute(job); } æ­¤å¤„åˆæ˜¯ä¸€ä¸ªçº¿ç¨‹æ± ï¼Œå†æ¬¡æ‰§è¡ŒDecodeJobï¼Œæ³¨æ„äº†æ­¤æ—¶DecodeJobä¸­çš„runReasonæ˜¯SWITCH_TO_SOURCE_SERVICEï¼Œåˆå›åˆ°åˆšæ‰è¯´çš„runWrappedæ–¹æ³•ä¸­ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 private void runWrapped() { switch (runReason) { case SWITCH_TO_SOURCE_SERVICE: runGenerators(); break; } } private void runGenerators() { boolean isStarted = false; //å‰é¢åˆ†æè¿‡currentGeneratoræ˜¯SourceGeneratorï¼Œæ‰€ä»¥å†æ¬¡æ‰§è¡Œå®ƒçš„startNextæ–¹æ³• while (!isCancelled \u0026amp;\u0026amp; currentGenerator != null \u0026amp;\u0026amp; !(isStarted = currentGenerator.startNext())) { stage = getNextStage(stage); currentGenerator = getNextGenerator(); if (stage == Stage.SOURCE) { reschedule(RunReason.SWITCH_TO_SOURCE_SERVICE); return; } } if ((stage == Stage.FINISHED || isCancelled) \u0026amp;\u0026amp; !isStarted) { notifyFailed(); } } public boolean startNext() { if (dataToCache != null) { Object data = dataToCache; dataToCache = null; try { boolean isDataInCache = cacheData(data); if (!isDataInCache) { return true; } } catch (IOException e) { } } if (sourceCacheGenerator != null \u0026amp;\u0026amp; sourceCacheGenerator.startNext()) { return true; } //...çœç•¥äº†å‰é¢åˆ†æè¿‡çš„æµç¨‹ } å‰é¢åˆ†æè¿‡è·å–åˆ°ç½‘ç»œæ•°æ®åï¼Œç»™dataToCacheèµ‹å€¼ï¼Œæ‰€ä»¥å†æ¬¡æ‰§è¡ŒstartNextæ—¶å€™ï¼Œä¼šè°ƒç”¨dataToCacheä¸ä¸ºç©ºçš„é€»è¾‘ã€‚å…¶ä¸­cacheDataæ˜¯å°†åŸå§‹å›¾ç‰‡çš„inputStreamæ•°æ®ä¿å­˜åˆ°ç£ç›˜ä¸­ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 private boolean cacheData(Object dataToCache) throws IOException { DataRewinder\u0026lt;Object\u0026gt; rewinder = helper.getRewinder(dataToCache); Object data = rewinder.rewindAndGet(); Encoder\u0026lt;Object\u0026gt; encoder = helper.getSourceEncoder(data); DataCacheWriter\u0026lt;Object\u0026gt; writer = new DataCacheWriter\u0026lt;\u0026gt;(encoder, data, helper.getOptions()); DataCacheKey newOriginalKey = new DataCacheKey(loadData.sourceKey, helper.getSignature()); DiskCache diskCache = helper.getDiskCache(); diskCache.put(newOriginalKey, writer); sourceCacheGenerator = new DataCacheGenerator(Collections.singletonList(loadData.sourceKey), helper, this); return true; } ä¿å­˜å®Œç£ç›˜åï¼Œåˆ›å»ºäº†DataCacheGeneratorï¼Œæ‰€ä»¥å›åˆ°startNextæ–¹æ³•ä¸­ï¼Œä¼šæ‰§è¡ŒDataCacheGeneratorçš„startNextæ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 public boolean startNext() { loadData = null; boolean started = false; while (!started \u0026amp;\u0026amp; hasNextModelLoader()) { ModelLoader\u0026lt;File, ?\u0026gt; modelLoader = modelLoaders.get(modelLoaderIndex++); loadData = modelLoader.buildLoadData( cacheFile, helper.getWidth(), helper.getHeight(), helper.getOptions()); if (loadData != null \u0026amp;\u0026amp; helper.hasLoadPath(loadData.fetcher.getDataClass())) { started = true; loadData.fetcher.loadData(helper.getPriority(), this); } } return started; } æ­¤å¤„çš„loadData.fetcheræ˜¯ä¸€ä¸ªByteBufferFetcherï¼Œåé¢å†åˆ†ææ€ä¹ˆå¾—åˆ°è¯¥fetcherï¼Œä¼šæ‰§è¡Œåˆ°å®ƒçš„loadDataï¼š\n1 2 3 4 5 6 public void loadData( @NonNull Priority priority, @NonNull DataCallback\u0026lt;? super ByteBuffer\u0026gt; callback) { ByteBuffer result; result = ByteBufferUtil.fromFile(file); callback.onDataReady(result); } å°†æ–‡ä»¶è½¬æ¢æˆbufferæ•°æ®ï¼Œå¹¶å›è°ƒåˆ°DataCacheGeneratorçš„onDataReadyï¼š\n1 2 3 public void onDataReady(Object data) { cb.onDataFetcherReady(sourceKey, data, loadData.fetcher, DataSource.DATA_DISK_CACHE, sourceKey); } å›è°ƒåˆ°SourceGeneratorçš„onDataFetcherReadyï¼š\n1 2 3 4 public void onDataFetcherReady( Key sourceKey, Object data, DataFetcher\u0026lt;?\u0026gt; fetcher, DataSource dataSource, Key attemptedKey) { cb.onDataFetcherReady(sourceKey, data, fetcher, loadData.fetcher.getDataSource(), sourceKey); } ç»§ç»­å›è°ƒåˆ°DecodeJobçš„onDataFetcherReadyæ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 public void onDataFetcherReady( Key sourceKey, Object data, DataFetcher\u0026lt;?\u0026gt; fetcher, DataSource dataSource, Key attemptedKey) { this.currentSourceKey = sourceKey; this.currentData = data; this.currentFetcher = fetcher; this.currentDataSource = dataSource; this.currentAttemptingKey = attemptedKey; this.isLoadingFromAlternateCacheKey = sourceKey != decodeHelper.getCacheKeys().get(0); reschedule(RunReason.DECODE_DATA); } è¿˜æ˜¯å’Œä¸Šé¢æ‹¿åˆ°ç½‘ç»œæ•°æ®ä¸€æ ·ï¼Œç»§ç»­æ‰§è¡ŒDecodeJobçš„runWrappedï¼š\n1 2 3 4 5 6 7 private void runWrapped() { switch (runReason) { case DECODE_DATA: decodeFromRetrievedData(); break; } } è°ƒç”¨å¼€å§‹è§£ç çš„æ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 private void decodeFromRetrievedData() { Resource\u0026lt;R\u0026gt; resource = null; try { resource = decodeFromData(currentFetcher, currentData, currentDataSource); } catch (GlideException e) { e.setLoggingDetails(currentAttemptingKey, currentDataSource); throwables.add(e); } if (resource != null) { notifyEncodeAndRelease(resource, currentDataSource, isLoadingFromAlternateCacheKey); } else { runGenerators(); } } å…³äºè§£ç è¿™å—åé¢ä¼šåˆ†æåˆ°ï¼Œè§£ç æˆåŠŸåå…ˆå›è°ƒåˆ°DecodeJobçš„onResourceDecodedæ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 \u0026lt;Z\u0026gt; Resource\u0026lt;Z\u0026gt; onResourceDecoded(DataSource dataSource, @NonNull Resource\u0026lt;Z\u0026gt; decoded) { Class\u0026lt;Z\u0026gt; resourceSubClass = (Class\u0026lt;Z\u0026gt;) decoded.get().getClass(); Transformation\u0026lt;Z\u0026gt; appliedTransformation = null; Resource\u0026lt;Z\u0026gt; transformed = decoded; if (dataSource != DataSource.RESOURCE_DISK_CACHE) { appliedTransformation = decodeHelper.getTransformation(resourceSubClass); transformed = appliedTransformation.transform(glideContext, decoded, width, height); } if (!decoded.equals(transformed)) { decoded.recycle(); } final EncodeStrategy encodeStrategy; final ResourceEncoder\u0026lt;Z\u0026gt; encoder; if (decodeHelper.isResourceEncoderAvailable(transformed)) { encoder = decodeHelper.getResultEncoder(transformed); encodeStrategy = encoder.getEncodeStrategy(options); } else { encoder = null; encodeStrategy = EncodeStrategy.NONE; } Resource\u0026lt;Z\u0026gt; result = transformed; return result; } åœ¨æˆ‘ä»¬çš„äº‹ä¾‹ä¸­é¦–æ¬¡è·å–çš„æ˜¯å›¾ç‰‡åŸå§‹å°ºå¯¸ï¼Œå¹¶ä¸”transformedå’Œdecodedæ˜¯åŒä¸€ä¸ªï¼Œæ‰€ä»¥ç›´æ¥è¿”å›äº†ã€‚æ¥ç€å›åˆ°decodeFromRetrievedDataæ–¹æ³•ä¸­ï¼Œç»§ç»­è°ƒç”¨äº†notifyEncodeAndReleaseæ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 private void notifyEncodeAndRelease( Resource\u0026lt;R\u0026gt; resource, DataSource dataSource, boolean isLoadedFromAlternateCacheKey) { Resource\u0026lt;R\u0026gt; result = resource; LockedResource\u0026lt;R\u0026gt; lockedResource = null; notifyComplete(result, dataSource, isLoadedFromAlternateCacheKey); stage = Stage.ENCODE; onEncodeComplete(); } ä¸Šé¢æŠŠencodeé€»è¾‘å»æ‰äº†ï¼Œå› ä¸ºä¸Šé¢è¿”å›çš„æ˜¯åŸå§‹å›¾ç‰‡ï¼Œæ‰€ä»¥æ— éœ€è¿›è¡Œencodeçš„æœ¬åœ°ä¿å­˜ã€‚çœ‹ä¸‹notifyCompleteæ–¹æ³•ï¼š\n1 2 3 4 private void notifyComplete( Resource\u0026lt;R\u0026gt; resource, DataSource dataSource, boolean isLoadedFromAlternateCacheKey) { callback.onResourceReady(resource, dataSource, isLoadedFromAlternateCacheKey); } å›è°ƒåˆ°EngineJobçš„onResourceReadyï¼š\n1 2 3 4 5 6 7 8 9 public void onResourceReady( Resource\u0026lt;R\u0026gt; resource, DataSource dataSource, boolean isLoadedFromAlternateCacheKey) { synchronized (this) { this.resource = resource; this.dataSource = dataSource; this.isLoadedFromAlternateCacheKey = isLoadedFromAlternateCacheKey; } notifyCallbacksOfResult(); } ç»§ç»­è°ƒç”¨notifyCallbacksOfResultï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 void notifyCallbacksOfResult() { ResourceCallbacksAndExecutors copy; Key localKey; EngineResource\u0026lt;?\u0026gt; localResource; synchronized (this) { engineResource = engineResourceFactory.build(resource, isCacheable, key, resourceListener); copy = cbs.copy(); incrementPendingCallbacks(copy.size() + 1); localKey = key; localResource = engineResource; } engineJobListener.onEngineJobComplete(this, localKey, localResource); for (final ResourceCallbackAndExecutor entry : copy) { entry.executor.execute(new CallResourceReady(entry.cb)); } decrementPendingCallbacks(); } é¦–å…ˆè°ƒç”¨onEngineJobCompleteè¿›è¡Œå›è°ƒä¿å­˜åˆ°å†…å­˜ä¸­ï¼Œæ¥ç€é€šè¿‡çº¿ç¨‹æ± è°ƒç”¨äº†CallResourceReadyï¼Œå…¶å®æ­¤å¤„çš„çº¿ç¨‹æ± æ˜¯å›è°ƒåˆ°ä¸»çº¿ç¨‹ï¼Œåœ¨ä¸Šé¢cbs.copy()çš„ä½¿ç”¨ï¼Œæ˜¯ä¸ºäº†é˜²æ­¢ä½¿ç”¨åŸå§‹é›†åˆéå†çš„æ—¶å€™ï¼Œå¯èƒ½å‘ç”ŸmodifyExceptioné—®é¢˜ï¼Œæ‰€ä»¥åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„å¯¹è±¡å‡ºæ¥éå†ï¼Œçœ‹ä¸‹CallResourceReadyçš„runæ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 public void run() { synchronized (cb.getLock()) { synchronized (EngineJob.this) { if (cbs.contains(cb)) { engineResource.acquire(); callCallbackOnResourceReady(cb); removeCallback(cb); } decrementPendingCallbacks(); } } } ä¸»è¦çœ‹ä¸‹callCallbackOnResourceReadyæ–¹æ³•ï¼š\n1 2 3 4 5 6 7 void callCallbackOnResourceReady(ResourceCallback cb) { try { cb.onResourceReady(engineResource, dataSource, isLoadedFromAlternateCacheKey); } catch (Throwable t) { throw new CallbackException(t); } } æ­¤å¤„çš„cbå¯¹è±¡æ˜¯åœ¨Engineçš„waitForExistingOrStartNewJobæ–¹æ³•ä¸­æ·»åŠ çš„ï¼Œå®é™…æ˜¯SingleRequestå¯¹è±¡ï¼Œæ‰€ä»¥ç»§ç»­å›è°ƒåˆ°SingleRequestçš„onResourceReadyæ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 public void onResourceReady( Resource\u0026lt;?\u0026gt; resource, DataSource dataSource, boolean isLoadedFromAlternateCacheKey) { onResourceReady( (Resource\u0026lt;R\u0026gt;) resource, (R) received, dataSource, isLoadedFromAlternateCacheKey); } private void onResourceReady( Resource\u0026lt;R\u0026gt; resource, R result, DataSource dataSource, boolean isAlternateCacheKey) { target.onResourceReady(result, animation); } å‰é¢åˆ†æè¿‡targetæ˜¯DrawableImageViewTargetï¼Œå®ƒæ˜¯ç»§æ‰¿è‡ªImageViewTargetï¼Œå®ƒçš„onResourceReadyæ–¹æ³•ï¼š\n1 2 3 4 5 6 7 public void onResourceReady(@NonNull Z resource, @Nullable Transition\u0026lt;? super Z\u0026gt; transition) { if (transition == null || !transition.transition(resource, this)) { setResourceInternal(resource); } else { maybeUpdateAnimatable(resource); } } æ­¤å¤„çš„transitionæ˜¯ä¸€ä¸ªNoTransitionï¼Œæ‰€ä»¥ä¼šèµ°setResourceInternalï¼š\n1 2 3 4 5 6 private void setResourceInternal(@Nullable Z resource) { setResource(resource); maybeUpdateAnimatable(resource); } protected abstract void setResource(@Nullable Z resource); åœ¨DrawableImageViewTargetä¸­é‡å†™äº†setResourceæ–¹æ³•ï¼š\n1 2 3 protected void setResource(@Nullable Drawable resource) { view.setImageDrawable(resource); } æœ€ç»ˆå°†å›¾ç‰‡å±•ç¤ºåˆ°imageViewä¸Šã€‚\næœ€ç»ˆçš„ç®€å›¾ï¼š\n","date":"2025-05-22T00:00:00Z","permalink":"http://xiangcman.xyz/p/glide%E5%8A%A0%E8%BD%BD%E5%9B%BE%E7%89%87%E6%B5%81%E7%A8%8B/","title":"GlideåŠ è½½å›¾ç‰‡æµç¨‹"},{"content":"ä¹‹å‰åœ¨äº†è§£touchäº‹ä»¶çš„æ—¶å€™ï¼Œéƒ½æ˜¯ä»activity-\u0026gt;phoneWindow-\u0026gt;decoreVoew-\u0026gt;contentéƒ¨åˆ†çš„viewäº‹ä»¶åˆ†å‘ï¼Œè€Œä¸çŸ¥é“åº•å±‚æ˜¯å¦‚ä½•ä¼ é€’ç»™viewçš„ï¼Œè¯¥ç¯‡æ–‡ç« å°±æ˜¯ä»‹ç»ï¼Œåº•å±‚æ˜¯å¦‚ä½•å°†äº‹ä»¶ä¼ é€’ç»™åº”ç”¨å±‚çš„ã€‚ä¸‹é¢å…ˆæŠŠtraceViewçš„æˆªå›¾åˆ—å‡ºæ¥ï¼š å½“å±å¹•æ”¶åˆ°è§¦æ‘¸äº‹ä»¶åï¼Œåº•å±‚ä¼šç»™ä¸»çº¿ç¨‹çš„æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ’å…¥ä¸€æ¡æ¶ˆæ¯ï¼Œç„¶åå”¤é†’ä¸Šå±‚ï¼Œä¸Šå±‚çš„æ¥æ”¶ç«¯æ˜¯NativeInputEventReceriverçš„handleEventï¼š æ¥ç€è°ƒç”¨äº†consumeEventsæ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 status_t NativeInputEventReceiver::consumeEvents(JNIEnv* env, bool consumeBatches, nsecs_t frameTime, bool* outConsumedBatch) { if (inputEventObj.get()) { if (kDebugDispatchCycle) { ALOGD(\u0026#34;channel \u0026#39;%s\u0026#39; ~ Dispatching input event.\u0026#34;, getInputChannelName().c_str()); } //è°ƒç”¨åˆ°javaå±‚çš„android/view/InputEventReceiverçš„dispatchInputEventæ–¹æ³• env-\u0026gt;CallVoidMethod(receiverObj.get(), gInputEventReceiverClassInfo.dispatchInputEvent, seq, inputEventObj.get()); } } int register_android_view_InputEventReceiver(JNIEnv* env) { int res = RegisterMethodsOrDie(env, \u0026#34;android/view/InputEventReceiver\u0026#34;, gMethods, NELEM(gMethods)); //æŒ‡å‘äº†javaå±‚çš„android/view/InputEventReceiverç±» jclass clazz = FindClassOrDie(env, \u0026#34;android/view/InputEventReceiver\u0026#34;); gInputEventReceiverClassInfo.clazz = MakeGlobalRefOrDie(env, clazz); gInputEventReceiverClassInfo.dispatchInputEvent = GetMethodIDOrDie(env, gInputEventReceiverClassInfo.clazz, \u0026#34;dispatchInputEvent\u0026#34;, \u0026#34;(ILandroid/view/InputEvent;)V\u0026#34;); gInputEventReceiverClassInfo.onFocusEvent = GetMethodIDOrDie(env, gInputEventReceiverClassInfo.clazz, \u0026#34;onFocusEvent\u0026#34;, \u0026#34;(Z)V\u0026#34;); gInputEventReceiverClassInfo.onPointerCaptureEvent = GetMethodIDOrDie(env, gInputEventReceiverClassInfo.clazz, \u0026#34;onPointerCaptureEvent\u0026#34;, \u0026#34;(Z)V\u0026#34;); gInputEventReceiverClassInfo.onDragEvent = GetMethodIDOrDie(env, gInputEventReceiverClassInfo.clazz, \u0026#34;onDragEvent\u0026#34;, \u0026#34;(ZFF)V\u0026#34;); gInputEventReceiverClassInfo.onTouchModeChanged = GetMethodIDOrDie(env, gInputEventReceiverClassInfo.clazz, \u0026#34;onTouchModeChanged\u0026#34;, \u0026#34;(Z)V\u0026#34;); gInputEventReceiverClassInfo.onBatchedInputEventPending = GetMethodIDOrDie(env, gInputEventReceiverClassInfo.clazz, \u0026#34;onBatchedInputEventPending\u0026#34;, \u0026#34;(I)V\u0026#34;); return res; } å¯ä»¥çœ‹åˆ°ä¸Šé¢é€šè¿‡register_android_view_InputEventReceiveræ–¹æ³•çš„æ³¨å†Œï¼Œå°†gInputEventReceiverClassInfoæŒ‡å‘äº†javaå±‚çš„android/view/InputEventReceiverã€‚è€Œåœ¨consumeEventsä¸­é€šè¿‡env-\u0026gt;CallVoidMethodè°ƒç”¨jniåˆ°äº†android/view/InputEventReceiverçš„dispatchInputEventæ–¹æ³•ã€‚æ¥ä¸‹æ¥åˆ°äº†javaå±‚ï¼Œç›´æ¥çœ‹traceview\n1 InputEventReceiver.dispatchInputEvent-\u0026gt;ViewRootImpl$WindowInputEventReceiver.onInputEvent-\u0026gt;ViewRootImpl.enqueueInputEvent-\u0026gt;ViewRootImpl.doProcessInputEvents-\u0026gt;ViewRootImpl.deliverInputEvent-\u0026gt;ViewRootImpl$InputStage.deliver-\u0026gt;ViewRootImpl$InputStage.apply-\u0026gt;deliver-\u0026gt;ViewRootImpl$InputStage.forward-\u0026gt;ViewRootImpl$InputStage.onDeliverToNext....-\u0026gt;ViewPostImeInputStage.onProcess-\u0026gt;ViewPostImeInputStage.processPointerEvent-\u0026gt;View.dispatchPointerEvent-\u0026gt;DecorView.dispatchTouchEvent-\u0026gt;Activity.dispatchTouchEvent-\u0026gt;PhoneWindow.superDispatchTouchEvent-\u0026gt;DecorView.superDispatchTouchEvent-\u0026gt;ViewGroup.dispatchTouchEvent å•å‡»viewæ—¶å€™çš„traceæ–‡ä»¶\nå…¶å®è¿™ä¸ªåªæ˜¯å•æ¬¡çš„ç‚¹å‡»äº‹ä»¶ï¼Œå¦‚æœæ˜¯å¤šæ¬¡è§¦å‘ç‚¹å‡»ï¼Œåœ¨viewrootimplä¸­ä¼šé€šè¿‡ç»™Choreographeræ’å…¥ä¸€æ¡CALLBACK_INPUTçš„äº‹ä»¶ï¼Œè¿™ä¸ªæ ¹æºä¹Ÿæ˜¯åœ¨NativeInputEventReceiverçš„consumeEventsä¸­è§¦å‘äº†WindowInputEventReceiverçš„onBatchedInputEventPendingï¼Œå…³é”®ä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 status_t NativeInputEventReceiver::consumeEvents(JNIEnv* env, bool consumeBatches, nsecs_t frameTime, bool* outConsumedBatch) { if (kDebugDispatchCycle) { ALOGD(\u0026#34;channel \u0026#39;%s\u0026#39; ~ Consuming input events, consumeBatches=%s, frameTime=%\u0026#34; PRId64, getInputChannelName().c_str(), toString(consumeBatches), frameTime); } if (consumeBatches) { mBatchedInputEventPending = false; traceBoolVariable(\u0026#34;mBatchedInputEventPending\u0026#34;, mBatchedInputEventPending); } if (outConsumedBatch) { *outConsumedBatch = false; } ScopedLocalRef\u0026lt;jobject\u0026gt; receiverObj(env, nullptr); bool skipCallbacks = false; for (;;) { uint32_t seq; InputEvent* inputEvent; status_t status = mInputConsumer.consume(\u0026amp;mInputEventFactory, consumeBatches, frameTime, \u0026amp;seq, \u0026amp;inputEvent); if (status == WOULD_BLOCK) { if (!skipCallbacks \u0026amp;\u0026amp; !mBatchedInputEventPending \u0026amp;\u0026amp; mInputConsumer.hasPendingBatch()) { // There is a pending batch. Come back later. if (!receiverObj.get()) { receiverObj.reset(GetReferent(env, mReceiverWeakGlobal)); if (!receiverObj.get()) { ALOGW(\u0026#34;channel \u0026#39;%s\u0026#39; ~ Receiver object was finalized \u0026#34; \u0026#34;without being disposed.\u0026#34;, getInputChannelName().c_str()); return DEAD_OBJECT; } } mBatchedInputEventPending = true; traceBoolVariable(\u0026#34;mBatchedInputEventPending\u0026#34;, mBatchedInputEventPending); if (kDebugDispatchCycle) { ALOGD(\u0026#34;channel \u0026#39;%s\u0026#39; ~ Dispatching batched input event pending notification.\u0026#34;, getInputChannelName().c_str()); } //è°ƒç”¨åˆ°gInputEventReceiverClassInfoçš„onBatchedInputEventPendingæ–¹æ³• env-\u0026gt;CallVoidMethod(receiverObj.get(), gInputEventReceiverClassInfo.onBatchedInputEventPending, mInputConsumer.getPendingBatchSource()); if (env-\u0026gt;ExceptionCheck()) { ALOGE(\u0026#34;Exception dispatching batched input events.\u0026#34;); mBatchedInputEventPending = false; // try again later traceBoolVariable(\u0026#34;mBatchedInputEventPending\u0026#34;, mBatchedInputEventPending); } } return OK; } } } æœ€ç»ˆè§¦å‘åˆ°ConsumeBatchedInputRunnableï¼Œæœ€åä¼šæ‰§è¡ŒdoProcessInputEvents-\u0026gt;deliverInputEvent\u0026hellip;ï¼Œä¹Ÿå°±ä¸Šå•æ¬¡ç‚¹å‡»çš„æ–¹æ³•è°ƒç”¨ã€‚ä»è¿™é‡Œä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œå¦‚æœè§¦æ‘¸äº‹ä»¶ç§¯ç´¯å¾ˆå¤šçš„æ—¶å€™ï¼Œä¼šé€šè¿‡ç»™Choreographeræ’å…¥ä¸€æ¡CALLBACK_INPUTçš„äº‹ä»¶ï¼Œç„¶åç­‰åˆ°ä¸‹æ¬¡vsyncä¿¡å·æ¥çš„æ—¶å€™ï¼Œæ‰ä¼šå»å¤„ç†touchäº‹ä»¶ï¼Œå‡è½»ä¸»çº¿ç¨‹çš„å‹åŠ›ã€‚é€šè¿‡æ­¤æœºåˆ¶ï¼ŒAndroid åœ¨ä¿è¯è¾“å…¥å“åº”çš„åŒæ—¶ï¼Œæœ€å¤§é™åº¦å‡å°‘ UI çº¿ç¨‹çš„è´Ÿè½½ï¼Œä¼˜åŒ–æ•´ä½“æµç•…æ€§ã€‚ å¤šæ¬¡è§¦æ‘¸å±å¹•çš„æ—¶å€™traceæ–‡ä»¶\n","date":"2025-03-24T00:00:00Z","permalink":"http://xiangcman.xyz/p/%E9%80%9A%E8%BF%87traceview%E5%88%86%E6%9E%90touch%E4%BA%8B%E4%BB%B6%E7%9A%84%E6%BA%90%E5%A4%B4%E5%8A%A0%E6%B7%B1touch%E4%BA%8B%E4%BB%B6%E7%9A%84%E7%90%86%E8%A7%A3/","title":"TraceViewå¸®æˆ‘è§£å†³äº†touchäº‹ä»¶çš„æºå¤´"},{"content":"è¦ç€æ‰‹binderåˆ†æï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ªç®€å•çš„activityè·³è½¬é€»è¾‘æ¥åˆ†æï¼Œæœ€å¥½çš„åŠæ³•æ˜¯è®©intentä¸­æºå¸¦çš„æ•°æ®è¶…è¿‡1Mçš„æ•°æ®ï¼Œç„¶åé€šè¿‡logcatä¸­å¼‚å¸¸å †æ ˆæ¥åˆ†æï¼š\n1 2 3 4 val intent = Intent(this, BitmapActivity::class.java) val data = ByteArray(1024*1024)open intent.putExtra(\u0026#34;data\u0026#34;,data) startActivity(intent) æ­¤å¤„æ˜¯ç›´æ¥æºå¸¦1Mçš„æ•°æ®ï¼Œç„¶åç³»ç»Ÿç»™æˆ‘æ¥äº†ä¸ªå¼‚å¸¸ä¿¡æ¯ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 2025-04-17 20:33:24.613 8782-8782 JavaBinder com.example.coroutinescopedemo E !!! FAILED BINDER TRANSACTION !!! (parcel size = 1049068) --------- beginning of crash 2025-04-17 20:33:24.627 8782-8782 AndroidRuntime com.example.coroutinescopedemo E FATAL EXCEPTION: main Process: com.example.coroutinescopedemo, PID: 8782 java.lang.RuntimeException: Failure from system at android.app.Instrumentation.execStartActivity(Instrumentation.java:1749) at android.app.Activity.startActivityForResult(Activity.java:5533) at androidx.activity.ComponentActivity.startActivityForResult(ComponentActivity.kt:704) at android.app.Activity.startActivityForResult(Activity.java:5486) at androidx.activity.ComponentActivity.startActivityForResult(ComponentActivity.kt:683) at android.app.Activity.startActivity(Activity.java:5892) at android.app.Activity.startActivity(Activity.java:5845) at com.example.coroutinescopedemo.BottomSheetActivity.onCreate$lambda$0(BottomSheetActivity.kt:27) at com.example.coroutinescopedemo.BottomSheetActivity.$r8$lambda$CWhZfDsJCDnJCQuDq0om0F9MZaU(Unknow at com.example.coroutinescopedemo.BottomSheetActivity$$ExternalSyntheticLambda0.onClick(D8$$Synthet at android.view.View.performClick(View.java:7753) at android.view.View.performClickInternal(View.java:7730) at android.view.View.access$3700(View.java:861) at android.view.View$PerformClick.run(View.java:29146) at android.os.Handler.handleCallback(Handler.java:938) at android.os.Handler.dispatchMessage(Handler.java:99) at android.os.Looper.loopOnce(Looper.java:210) at android.os.Looper.loop(Looper.java:299) at android.app.ActivityThread.main(ActivityThread.java:8293) at com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run(RuntimeInit.java:556) at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:1045) Caused by: android.os.TransactionTooLargeException: data parcel size 1049092 bytes at android.os.BinderProxy.transactNative(Native Method) at android.os.BinderProxy.transact(BinderProxy.java:624) at android.app.IActivityTaskManager$Stub$Proxy.startActivity(IActivityTaskManager.java:2664) at android.app.Instrumentation.execStartActivity(Instrumentation.java:1743) at android.app.Activity.startActivityForResult(Activity.java:5533)Â at androidx.activity.ComponentActivity.startActivityForResult(ComponentActivity.kt:704)Â at android.app.Activity.startActivityForResult(Activity.java:5486)Â at androidx.activity.ComponentActivity.startActivityForResult(ComponentActivity.kt:683)Â at android.app.Activity.startActivity(Activity.java:5892)Â at android.app.Activity.startActivity(Activity.java:5845)Â at com.example.coroutinescopedemo.BottomSheetActivity.onCreate$lambda$0(BottomSheetActivity.kt:27)Â at com.example.coroutinescopedemo.BottomSheetActivity.$r8$lambda$CWhZfDsJCDnJCQuDq0om0F9MZaU(Unknow at com.example.coroutinescopedemo.BottomSheetActivity$$ExternalSyntheticLambda0.onClick(D8$$Synthet at android.view.View.performClick(View.java:7753)Â at android.view.View.performClickInternal(View.java:7730)Â at android.view.View.access$3700(View.java:861)Â at android.view.View$PerformClick.run(View.java:29146)Â at android.os.Handler.handleCallback(Handler.java:938)Â at android.os.Handler.dispatchMessage(Handler.java:99)Â at android.os.Looper.loopOnce(Looper.java:210)Â at android.os.Looper.loop(Looper.java:299)Â at android.app.ActivityThread.main(ActivityThread.java:8293)Â at com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run(RuntimeInit.java:556)Â at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:1045)Â å¯ä»¥çœ‹åˆ°å¼‚å¸¸åˆ†ä¸¤å—ï¼Œä¸€å—æ˜¯ä¸Šé¢çš„ java.lang.RuntimeException: Failure from system ï¼Œå®ƒæ˜¯Instrumentationä¸­çš„execStartActivityæŠ›çš„å¼‚å¸¸ï¼Œæœ€ç»ˆæ˜¯å› ä¸ºåœ¨android.os. BinderProxy.transactNative(Native Method)ä¸­æŠ›äº† android.os.TransactionTooLargeException: data parcel size 1049092 bytes å¼‚å¸¸ï¼Œå¼‚å¸¸å †æ ˆè¶Šæ˜¯å¾€ä¸Šé¢æ˜¯å¼‚å¸¸æ‰€åœ¨ç‚¹ï¼Œè¶Šå¾€ä¸‹é¢æ˜¯ä¸Šå±‚ä»£ç ã€‚å½“ç‚¹å‡»æŒ‰é’®çš„æ—¶å€™å±å¹•åº•å±‚ä¼šç»™androidåº”ç”¨å±‚å‘é€ä¸»çº¿ç¨‹çš„æ¶ˆæ¯ï¼Œç„¶ååœ¨æ¶ˆæ¯é˜Ÿåˆ—è½®è®­è¯¥æ¶ˆæ¯çš„æ—¶å€™ï¼Œç”±äºåº•å±‚æŠ›å‡ºå¼‚å¸¸ï¼Œåœ¨looperè½®è®­æ¶ˆæ¯çš„æ—¶å€™ç»§ç»­å¾€ä¸Šå±‚æŠ›ï¼Œæœ€ç»ˆè¯¥å¼‚å¸¸ä¼šæŠ›ç»™åˆ°ZygoteInitã€‚javaé»˜è®¤çš„å¼‚å¸¸å¤„ç†æœºåˆ¶æ˜¯äº¤ç»™å½“å‰çº¿ç¨‹çš„defaultUncaughtExceptionHandlerï¼Œè€ŒRuntimeInitä¸­å®šä¹‰è¿‡ä¸»çº¿ç¨‹çš„defaultUncaughtExceptionHandlerï¼Œæœ€ç»ˆè¯¥Handleræ˜¯KillApplicationHandlerï¼Œåœ¨è¯¥handlerä¸­å…ˆæ”¶é›†æ—¥å¿—ï¼Œç„¶åkillæ‰è¿›ç¨‹ã€‚\nå®¢æˆ·ç«¯åˆ°é©±åŠ¨å±‚ åœ¨ä¸Šé¢å †æ ˆä¸­ï¼Œæˆ‘ä»¬ç›´æ¥åˆ†æ IActivityTaskManager$Stub$Proxy.startActivity æ–¹æ³•ï¼Œå…¶ä¸­ IActivityTaskManager$Stub$Proxy ç±»æ˜¯aidlå·¥å…·å¸®æˆ‘ä»¬ç”Ÿæˆçš„ç±»ï¼Œå®ƒæ˜¯IActivityTaskManageræ¥å£ä¸­çš„ä¸€ä¸ªå†…éƒ¨ç±»ï¼Œå®ƒæ˜¯å®¢æˆ·ç«¯æ‹¿åˆ°æœåŠ¡ç«¯çš„binderèµ·å§‹ç±»ï¼Œå®ƒçš„è·å–å¦‚ä¸‹ï¼š\n1 2 final IBinder b = ServiceManager.getService(Context.ACTIVITY_TASK_SERVICE); return IActivityTaskManager.Stub.asInterface(b); å…¶ä¸­ServiceManager.getService(Context. ACTIVITY_TASK_SERVICE)æ‹¿åˆ°çš„æ˜¯binderProxyå¯¹è±¡ï¼Œå®ƒæ˜¯c++å±‚çš„BinderProxyå¯¹åº”javaå±‚çš„BinderProxyå¯¹è±¡ï¼Œåœ¨IActivityTaskManager. Stub.asInterfaceä¸­åˆ¤æ–­å¦‚æœè°ƒç”¨è¿›ç¨‹å’Œç›®æ ‡è¿›ç¨‹ä¸æ˜¯ä¸€ä¸ªçš„è¯ï¼Œä¼šè¿”å›Proxyå¯¹è±¡ï¼Œç„¶åè°ƒç”¨åˆ°Proxyçš„startActivityæ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 @Override public int startActivity(IApplicationThread caller, String callingPackage, Intent intent, String resolvedType, IBinder resultTo, String resultWho, int requestCode, int flags, ProfilerInfo profilerInfo, Bundle options) throws RemoteException { Parcel _data = Parcel.obtain(); Parcel _reply = Parcel.obtain(); int _result; try { _data.writeInterfaceToken(DESCRIPTOR); // éªŒè¯è¿œç¨‹æ¥å£ _data.writeStrongBinder(caller != null ? caller.asBinder() : null); _data.writeString(callingPackage); if (intent != null) { _data.writeInt(1); intent.writeToParcel(_data, 0); } else { _data.writeInt(0); } _data.writeString(resolvedType); _data.writeStrongBinder(resultTo); _data.writeString(resultWho); _data.writeInt(requestCode); _data.writeInt(flags); if (profilerInfo != null) { _data.writeInt(1); profilerInfo.writeToParcel(_data, 0); } else { _data.writeInt(0); } if (options != null) { _data.writeInt(1); options.writeToParcel(_data, 0); } else { _data.writeInt(0); } mRemote.transact(Stub.TRANSACTION_startActivity, _data, _reply, 0); _reply.readException(); _result = _reply.readInt(); } finally { _reply.recycle(); _data.recycle(); } return _result; } åœ¨è¯¥æ–¹æ³•é‡Œé¢ï¼Œä¼šåˆ›å»ºä¸¤ä¸ªParcelå¯¹è±¡ï¼Œä¸€ä¸ªæ˜¯_dataï¼Œä¸€ä¸ªæ˜¯_replyã€‚ç„¶åå°†å‚æ•°éƒ½æ”¾åˆ°_dataä¸­ï¼Œæœ€ç»ˆè°ƒç”¨äº†mRemoteçš„transactæ–¹æ³•ï¼Œå¹¶æŠŠ_dataå’Œ_replyä¼ å…¥å…¶ä¸­ã€‚æ­¤å¤„çš„_remoteå¯¹è±¡javaå±‚çš„BinderProxyå¯¹è±¡ï¼Œä»å †æ ˆä¸Šçœ‹ç„¶åè°ƒç”¨äº†transactNativeæ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ˜¯ä¸€ä¸ªnativeæ–¹æ³•ï¼Œå¯¹åº”çš„aospä¸­æ˜¯android_util_Binder.cppçš„android_os_BinderProxy_transactæ–¹æ³•ï¼Œå¯ä»¥çœ‹å¦‚ä¸‹æ–¹æ³•æ³¨å†Œï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 static const JNINativeMethod gBinderProxyMethods[] = { /* name, signature, funcPtr */ {\u0026#34;pingBinder\u0026#34;, \u0026#34;()Z\u0026#34;, (void*)android_os_BinderProxy_pingBinder}, {\u0026#34;isBinderAlive\u0026#34;, \u0026#34;()Z\u0026#34;, (void*)android_os_BinderProxy_isBinderAlive}, {\u0026#34;getInterfaceDescriptor\u0026#34;, \u0026#34;()Ljava/lang/String;\u0026#34;, (void*)android_os_BinderProxy_getInterfaceDescriptor}, {\u0026#34;transactNative\u0026#34;, \u0026#34;(ILandroid/os/Parcel;Landroid/os/Parcel;I)Z\u0026#34;, (void*)android_os_BinderProxy_transact}, {\u0026#34;linkToDeathNative\u0026#34;, \u0026#34;(Landroid/os/IBinder$DeathRecipient;I)V\u0026#34;, (void*)android_os_BinderProxy_linkToDeath}, {\u0026#34;unlinkToDeathNative\u0026#34;, \u0026#34;(Landroid/os/IBinder$DeathRecipient;I)Z\u0026#34;, (void*)android_os_BinderProxy_unlinkToDeath}, {\u0026#34;addFrozenStateChangeCallbackNative\u0026#34;, \u0026#34;(Landroid/os/IBinder$FrozenStateChangeCallback;)V\u0026#34;, (void*)android_os_BinderProxy_addFrozenStateChangeCallback}, {\u0026#34;removeFrozenStateChangeCallbackNative\u0026#34;, \u0026#34;(Landroid/os/IBinder$FrozenStateChangeCallback;)Z\u0026#34;, (void*)android_os_BinderProxy_removeFrozenStateChangeCallback}, {\u0026#34;getNativeFinalizer\u0026#34;, \u0026#34;()J\u0026#34;, (void*)android_os_BinderProxy_getNativeFinalizer}, {\u0026#34;getExtension\u0026#34;, \u0026#34;()Landroid/os/IBinder;\u0026#34;, (void*)android_os_BinderProxy_getExtension}, }; 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 static jboolean android_os_BinderProxy_transact(JNIEnv* env, jobject obj, jint code, jobject dataObj, jobject replyObj, jint flags) // throws RemoteException { //â‘ ã€dataObjæ˜¯javaå±‚ä¼ è¿‡æ¥çš„å‘é€æ•°æ®çš„parcel if (dataObj == NULL) { jniThrowNullPointerException(env, NULL); return JNI_FALSE; } //â‘¡ã€å°†javaå±‚çš„parcelæ•°æ®è½¬æˆnativeå±‚çš„parcel Parcel* data = parcelForJavaObject(env, dataObj); if (data == NULL) { return JNI_FALSE; } //â‘¢ã€å°†javaå±‚çš„replyçš„parcelæ•°æ®è½¬æˆnativeå±‚çš„parcel Parcel* reply = parcelForJavaObject(env, replyObj); if (reply == NULL \u0026amp;\u0026amp; replyObj != NULL) { return JNI_FALSE; } //â‘£ã€é€šè¿‡javaå±‚çš„BinderProxyè·å–åˆ°nativeå±‚çš„BpBinder IBinder* target = getBPNativeData(env, obj)-\u0026gt;mObject.get(); if (target == NULL) { jniThrowException(env, \u0026#34;java/lang/IllegalStateException\u0026#34;, \u0026#34;Binder has been finalized!\u0026#34;); return JNI_FALSE; } ALOGV(\u0026#34;Java code calling transact on %p in Java object %p with code %\u0026#34; PRId32 \u0026#34;\\n\u0026#34;, target, obj, code); //â‘¤ã€è°ƒç”¨nativeå±‚çš„BpBinderçš„transactæ–¹æ³• status_t err = target-\u0026gt;transact(code, *data, reply, flags); if (err == NO_ERROR) { return JNI_TRUE; } //â‘¥ã€é€šè¿‡jniè°ƒç”¨åˆ°javaå±‚çš„Binderçš„transactionCallbackæ–¹æ³• env-\u0026gt;CallStaticVoidMethod(gBinderOffsets.mClass, gBinderOffsets.mTransactionCallback, getpid(), code, flags, err); if (err == UNKNOWN_TRANSACTION) { return JNI_FALSE; } //â‘¦ã€è¾“å‡ºé”™è¯¯ä¿¡æ¯ signalExceptionForError(env, obj, err, true /*canThrowRemoteException*/, data-\u0026gt;dataSize()); return JNI_FALSE; } åœ¨â‘ å¤„å¦‚æœä¼ è¿›æ¥çš„javaå±‚çš„parcelç±»å‹çš„dataæ•°æ®ä¸ºç©ºï¼Œåˆ™ç›´æ¥è¿”å›å¤±è´¥ã€‚\nåœ¨â‘¡å¤„å°†javaå±‚çš„parcelç±»å‹çš„dataæ•°æ®è½¬æˆnativeå±‚çš„parcelæ•°æ®ã€‚\nåœ¨â‘¢å¤„å°†javaå±‚çš„parcelç±»å‹çš„replyæ•°æ®è½¬æˆnativeå±‚çš„parcelæ•°æ®ã€‚\nåœ¨â‘£å¤„é€šè¿‡javaå±‚çš„BinderProxyè·å–åˆ°nativeå±‚çš„BpBinderï¼Œä¸»è¦æ˜¯é€šè¿‡javaå±‚BinderProxyçš„mNativeDataæŒ‡é’ˆ(nativeå±‚BpBinderæŒ‡é’ˆ)æ¥è·å–åˆ°nativeå±‚çš„BpBinderã€‚\nåœ¨â‘¤å¤„è°ƒç”¨nativeå±‚çš„BpBinderçš„transactæ–¹æ³•ã€‚\nåœ¨â‘¥å¤„é€šè¿‡jniè°ƒç”¨åˆ°javaå±‚çš„Binderçš„transactionCallbackæ–¹æ³•ã€‚\næœ€ååœ¨â‘¦å¤„æ ¹æ®transactçš„ç»“æœè¾“å‡ºé”™è¯¯ä¿¡æ¯ã€‚\nç€é‡çœ‹ä¸‹åœ¨ä¸Šé¢â‘¤å¤„ï¼Œçœ‹ä¸‹nativeå±‚çš„BpBinderå¦‚ä½•å¤„ç†binderçš„ï¼š\n1 2 3 4 5 6 7 status_t BpBinder::transact( uint32_t code, const Parcel\u0026amp; data, Parcel* reply, uint32_t flags) { status_t status; status = IPCThreadState::self()-\u0026gt;transact(binderHandle(), code, data, reply, flags); return status; } ä¸Šé¢åªåˆ—å‡ºå…³é”®ä»£ç ï¼ŒIPCThreadState::self()æ˜¯çº¿ç¨‹å•ä¾‹ï¼Œè°ƒç”¨åˆ°IPCThreadStateçš„transactæ–¹æ³•ï¼Œå¹¶ä¸”å¯ä»¥çœ‹åˆ°ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯è·å–BpBinderçš„binderHandleæ–¹æ³•ï¼Œå®ƒå°±æ˜¯è·å–æœåŠ¡ç«¯çš„binderå¥æŸ„ï¼Œé€šè¿‡å®ƒå‘Šè¯‰é©±åŠ¨å±‚ï¼Œæƒ³è¦çš„æœåŠ¡ç«¯binderæ˜¯å“ªä¸ªï¼Œä¸‹é¢æ¥çœ‹ä¸‹IPCThreadStateçš„transactæ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 status_t IPCThreadState::transact(int32_t handle, uint32_t code, const Parcel\u0026amp; data, Parcel* reply, uint32_t flags) { status_t err; flags |= TF_ACCEPT_FDS; //å¾€é©±åŠ¨å±‚å†™æ•°æ® err = writeTransactionData(BC_TRANSACTION, flags, handle, code, data, nullptr); //å¦‚æœæœ‰errorå°±ä¸å¾€ä¸‹æ‰§è¡Œ if (err != NO_ERROR) { if (reply) reply-\u0026gt;setError(err); return (mLastError = err); } //å¦‚æœä¸æ˜¯one wayçš„è¯·æ±‚æ–¹å¼ if ((flags \u0026amp; TF_ONE_WAY) == 0) { //ç­‰å¾…è¿”å›ç»“æœ if (reply) { err = waitForResponse(reply); } else { Parcel fakeReply; err = waitForResponse(\u0026amp;fakeReply); } } else { //å¦‚æœæ˜¯one wayï¼Œä¼ è¿›å»çš„replyæ˜¯ç©ºçš„ err = waitForResponse(nullptr, nullptr); } return err; } transacté€»è¾‘è¿˜æ˜¯æŒºæ¸…æ™°çš„ï¼Œé¦–å…ˆå¾€é©±åŠ¨å±‚å†™æ•°æ®ï¼Œå¦‚æœæœ‰errorå°±ä¸å¾€ä¸‹æ‰§è¡Œã€‚å¦‚æœæ²¡é—®é¢˜åˆ¤æ–­æ˜¯ä¸æ˜¯one wayçš„è¯·æ±‚æ–¹å¼ï¼Œå¦‚æœä¸æ˜¯åˆ™ç­‰å¾…è¿”å›ç»“æœï¼Œå¦‚æœæ˜¯one wayä¼ è¿›å…¥çš„replyæ˜¯nullã€‚\nwriteTransactionDataæ˜¯å¾€é©±åŠ¨å†™æ•°æ®çš„æ–¹æ³•ï¼Œçœ‹ä¸‹è¯¥æ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 status_t IPCThreadState::writeTransactionData(int32_t cmd, uint32_t binderFlags, int32_t handle, uint32_t code, const Parcel\u0026amp; data, status_t* statusBuffer) { //å®šä¹‰é©±åŠ¨å±‚è®¤è¯†çš„æ•°æ®ç»“æ„ binder_transaction_data tr; tr.target.ptr = 0; tr.target.handle = handle; tr.code = code; tr.flags = binderFlags; tr.cookie = 0; tr.sender_pid = 0; tr.sender_euid = 0; //åˆ¤æ–­å‘é€çš„æ•°æ®æ˜¯å¦æœ‰é—®é¢˜ const status_t err = data.errorCheck(); if (err == NO_ERROR) { //å¦‚æœæ²¡æœ‰é—®é¢˜ï¼Œåˆ™å¾€binder_transaction_dataä¸­å†™æ•°æ® tr.data_size = data.ipcDataSize(); tr.data.ptr.buffer = data.ipcData(); tr.offsets_size = data.ipcObjectsCount()*sizeof(binder_size_t); tr.data.ptr.offsets = data.ipcObjects(); } else if (statusBuffer) { tr.flags |= TF_STATUS_CODE; *statusBuffer = err; tr.data_size = sizeof(status_t); tr.data.ptr.buffer = reinterpret_cast\u0026lt;uintptr_t\u0026gt;(statusBuffer); tr.offsets_size = 0; tr.data.ptr.offsets = 0; } else { //æœ‰é—®é¢˜çš„è¯ï¼Œåˆ™è¿”å›å¤±è´¥ return (mLastError = err); } //å°†BC_TRANSACTIONå’Œbinder_transaction_dataå†™å…¥åˆ°mOutè¿™ä¸ªparcelé‡Œé¢ mOut.writeInt32(cmd); mOut.write(\u0026amp;tr, sizeof(tr)); return NO_ERROR; } é¦–å…ˆå®šä¹‰binder_transaction_dataæ•°æ®ç»“æ„ï¼Œç„¶ååˆ¤æ–­å‘é€çš„æ•°æ®æ˜¯å¦æœ‰é—®é¢˜ï¼Œå¦‚æœæ²¡æœ‰åˆ™å°†dataç›¸å…³çš„æ•°æ®ç»™åˆ°binder_transaction_dataï¼Œå¦‚æœæœ‰é—®é¢˜ï¼Œåˆ™è¿”å›å¤±è´¥ï¼Œæœ€åå°†BC_TRANSACTIONå’Œbinder_transaction_dataå†™å…¥åˆ°mOutè¿™ä¸ªparcelé‡Œé¢ã€‚\nä¸Šé¢é€šè¿‡data.errorCheck()æ¥åˆ¤æ–­å‘é€çš„æ•°æ®æ˜¯å¦æœ‰é—®é¢˜ï¼Œä¸‹é¢æ¥çœ‹ä¸‹å¦‚ä½•éªŒè¯çš„ï¼š\n1 2 3 4 5 6 status_t Parcel::errorCheck() const { return mError; } ç›´æ¥è¿”å›mErrorå­—æ®µï¼Œå®ƒæ˜¯åœ¨Parcel::continueWrite()æ–¹æ³•ä¸­èµ‹å€¼çš„ï¼Œè€ŒcontinueWrite()æ–¹æ³•æ˜¯åœ¨growData()-\u0026gt;writeInplace()-\u0026gt;android_os_Parcel.cpp.android_os_Parcel_write***()æ–¹æ³•ï¼Œæœ€ç»ˆæ˜¯javaå±‚çš„Parcel.write***()ç­‰æ–¹æ³•è°ƒç”¨çš„ï¼Œå…³äºjavaå±‚çš„parcelæ˜¯å¦‚ä½•é€šè¿‡jniè°ƒç”¨åˆ°android_os_Parcel.cppä¸»è¦æ˜¯å› ä¸ºjavaå±‚parcelå­˜å‚¨äº†nativeçš„parcelæŒ‡é’ˆï¼Œå®ƒæ˜¯mNativePtrã€‚ å…¶ä¸­å…³äºæœ€å¤§parcelçš„å†…å­˜å€¼åˆ¤æ–­åœ¨growDataæ–¹æ³•ä¸­ï¼Œå…¶ä¸­å˜é‡SIZE_MAXæ˜¯64ä½æœºå™¨ä¸Šæœ€å¤§çš„byteæ•°ã€‚å¦‚æœè¶…è¿‡è¿™ä¸ªå€¼ï¼Œåˆ™è¿”å›NO_MEMORYï¼Œåœ¨continueWriteä¸­ä¼šç»§ç»­åˆ¤æ–­binderæ€»å†…å­˜ï¼Œå…³äºæœ€å¤§å†…å­˜ç”³è¯·åœ¨ProcessState.cppä¸­è°ƒç”¨mmapå†…å­˜æ˜ å°„çš„æ—¶å€™ï¼ŒæŒ‡å®šäº†binderçš„æœ€å¤§å†…å­˜ä½BINDER_VM_SIZE = ((1 * 1024 * 1024) - sysconf(_SC_PAGE_SIZE) * 2)ã€‚ å›åˆ°ä¸Šé¢çš„IPCThreadState::transactï¼Œå†™å®Œæ•°æ®åå¦‚æœå‘ç°æœ‰é—®é¢˜ï¼Œåˆ™é€šè¿‡android_util_Binder.cppä¸­çš„signalExceptionForErroræŠ›å‡ºå¼‚å¸¸ã€‚æ¥ç€å°±æ˜¯åˆ¤æ–­å¦‚æœä¸æ˜¯one wayçš„è¯·æ±‚æ–¹å¼ï¼Œåˆ™é€šè¿‡waitForResponseç­‰å¾…è¿”å›ç»“æœï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 status_t IPCThreadState::waitForResponse(Parcel *reply, status_t *acquireResult){ uint32_t cmd; while (1) { //å¾€é©±åŠ¨å±‚å†™ä¸œè¥¿ talkWithDriver(); cmd = (uint32_t)mIn.readInt32(); switch (cmd) { case BR_TRANSACTION_COMPLETE: break; case BR_REPLY:{ binder_transaction_data tr; err = mIn.read(\u0026amp;tr, sizeof(tr)); reply-\u0026gt;ipcSetDataReference(tr.data.ptr.buffer,tr.data_size); } goto finish; } } return err; } é€šè¿‡whileå¾ªç¯æ¥åˆ¤æ–­å‘½ä»¤ï¼Œé¦–å…ˆæ¯æ¬¡å…ˆé€šè¿‡talkWithDriverå¾€é©±åŠ¨å±‚å†™ä¸œè¥¿ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 status_t IPCThreadState::talkWithDriver(bool doReceive) { binder_write_read bwr; const bool needRead = mIn.dataPosition() \u0026gt;= mIn.dataSize(); const size_t outAvail = (!doReceive || needRead) ? mOut.dataSize() : 0; bwr.write_size = outAvail; bwr.write_buffer = (uintptr_t)mOut.data(); if (doReceive \u0026amp;\u0026amp; needRead) { bwr.read_size = mIn.dataCapacity(); bwr.read_buffer = (uintptr_t)mIn.data(); } else { bwr.read_size = 0; bwr.read_buffer = 0; } ioctl(mProcess-\u0026gt;mDriverFD, BINDER_WRITE_READ, \u0026amp;bwr); return err; } å‰é¢åœ¨åˆ†æwriteTransactionDataæ—¶å€™ï¼Œä¼šæŠŠbinder_transaction_dataæ•°æ®ç»“æ„ä¿å­˜åˆ°oOutè¿™ä¸ªparcelé‡Œé¢ï¼Œæ­¤å¤„æŠŠoOutçš„åœ°å€æŒ‡å‘äº†binder_write_readçš„write_bufferå­—æ®µï¼Œå¦‚æœèƒ½è¯»çš„è¯ï¼Œåˆ™å°†mInçš„åœ°å€æŒ‡å‘äº†binder_write_readçš„read_bufferå­—æ®µã€‚æœ€åé€šè¿‡ioctlæ–¹æ³•å°†binder_write_readå‘é€åˆ°é©±åŠ¨å±‚ã€‚å…³äºioctlæ˜¯é©±åŠ¨å±‚çš„æ–¹æ³•ï¼Œåœ¨linuxå†…æ ¸ä»£ç ä¸­ã€‚ ç»§ç»­å›åˆ°ä¸Šé¢çš„waitForResponseæ–¹æ³•åœ¨BR_REPLYæŒ‡ä»¤ä¸­ä¼šè¯»å–ä»é©±åŠ¨è¯»å‡ºæ¥çš„äºŒè¿›åˆ¶è£¸æ•°æ®ï¼Œç„¶åæŠŠäºŒè¿›åˆ¶è§£æä¸ºbinder_transaction_dataæ•°æ®ç»“æ„ï¼Œæœ€åä¿å­˜åˆ°mInè¿™ä¸ªparcelä¸­ï¼Œè¿™ä¸ªè·Ÿå‰é¢å†™å…¥åˆ°mOutä¸­æ˜¯ä¸€æ ·çš„æ•°æ®ç»“æ„ï¼Œæœ€åå°†binder_transaction_dataä¸­çš„è¾“å…¥æ”¾åˆ°replyè¿™ä¸ªparcelä¸­ï¼Œæœ€ç»ˆå®¢æˆ·ç«¯ä¹Ÿå°±æ”¶åˆ°äº†æœåŠ¡ç«¯çš„æ•°æ®ã€‚ åœ¨ä¸Šé¢è¦å‘èµ·ioctlæ—¶å€™ï¼Œä¼šæŠŠmOutå’ŒmInçš„é¦–åœ°å€å¡«å……åˆ°binder_write_readä¸­ï¼Œè¿™æ ·é©±åŠ¨å±‚èƒ½ç›´æ¥è¯»å–åˆ°mOutçš„æ•°æ®ï¼Œåœ¨é©±åŠ¨å±‚è¿”å›æ•°æ®çš„æ—¶å€™ï¼ŒåŒæ ·é“ç†ç”±äºæ‹¿åˆ°äº†mInçš„åœ°å€ï¼Œæ‰€ä»¥ä¹Ÿèƒ½å°†æœåŠ¡ç«¯çš„æ•°æ®ç›´æ¥æŒ‡å‘äº†mInï¼Œæ‰€ä»¥åœ¨ä¸Šé¢waitForResponseçš„BR_REPLYèƒ½ç›´æ¥è§£æmInã€‚\nåœ¨ä¸Šé¢åˆ†æIPCThreadState::transactä¸­å¦‚æœæ˜¯one wayçš„è¯·æ±‚æ–¹å¼ï¼Œåˆ™è°ƒç”¨waitForResponseæ—¶å€™ä¼ è¿›å…¥çš„replyå’ŒacquireResultéƒ½æ˜¯nullã€‚è€Œåœ¨waitForResponseä¸­å¦‚æœreplyå’ŒacquireResultä¸ºnullçš„æ—¶å€™ï¼Œå¦‚æœæ˜¯BR_TRANSACTION_COMPLETEåˆ™ç›´æ¥goto finishï¼Œåœ¨one wayä¸­ä¸ä¼šæ”¶åˆ°BR_REPLYæŒ‡ä»¤ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 status_t IPCThreadState::waitForResponse(Parcel *reply, status_t *acquireResult){ uint32_t cmd; while (1) { //å¾€é©±åŠ¨å±‚å†™ä¸œè¥¿ talkWithDriver(); cmd = (uint32_t)mIn.readInt32(); switch (cmd) { case BR_TRANSACTION_COMPLETE: if (!reply \u0026amp;\u0026amp; !acquireResult) goto finish; break; } } return err; } å¼‚æ­¥æ¶ˆæ¯æ—¶åºå›¾ï¼š\nåŒæ­¥æ¶ˆæ¯æ—¶åºå›¾ï¼š\nä¸Šé¢å°±æ˜¯æ•´ä¸ªå®¢æˆ·ç«¯åˆ°é©±åŠ¨å±‚çš„è°ƒç”¨æµç¨‹ï¼Œå®¢æˆ·ç«¯åˆ°é©±åŠ¨å±‚çš„æµç¨‹å›¾å¦‚ä¸‹ï¼š\næœåŠ¡ç«¯åˆ°é©±åŠ¨å±‚ æœåŠ¡ç«¯å¦‚ä½•è·Ÿé©±åŠ¨å±‚é€šä¿¡ï¼Œå¾—ä»zygoteåˆå§‹åŒ–çš„æ—¶å€™è¯´èµ·ï¼Œåœ¨è¯¥é˜¶æ®µä¼šå¯åŠ¨binderæœºåˆ¶ï¼Œå¯åŠ¨è¿‡ç¨‹çš„æœ€åä¼šå¼€å¯loopå¾ªç¯ï¼Œé€šè¿‡è°ƒç”¨PoolThread::threadLoopæ–¹æ³•ï¼Œæºç åœ°å€ï¼š/frameworks/native/libs/binder/ProcessState.cpp\n1 2 3 4 5 6 7 8 9 protected: virtual bool threadLoop() { IPCThreadState::self()-\u0026gt;joinThreadPool(mIsMain); return false; } const bool mIsMain; }; serverç«¯ä¸»è¦é€šè¿‡binderçº¿ç¨‹ï¼Œè¿™ä¸ªbinderçº¿ç¨‹å…¶å®å°±æ˜¯newäº†ä¸€ä¸ªæ™®é€šçš„çº¿ç¨‹ï¼Œç„¶åå†è°ƒç”¨äº†IPCThreadState::self()-\u0026gt;joinThreadPool(mIsMain)è¿™è¡Œä»£ç ï¼ŒæŠŠè¿™ä¸ªçº¿ç¨‹æ³¨å†Œåˆ°binderé©±åŠ¨ï¼Œè¿™æ ·ä»–å°±æˆä¸ºä¸€ä¸ªbinderçº¿ç¨‹äº†ï¼Œæ¥ç€æ¥çœ‹ä¸‹IPCThreadStateçš„joinThreadPoolæ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 void IPCThreadState::joinThreadPool(bool isMain) { mOut.writeInt32(isMain ? BC_ENTER_LOOPER : BC_REGISTER_LOOPER); status_t result; do { result = getAndExecuteCommand(); } while (result != -ECONNREFUSED \u0026amp;\u0026amp; result != -EBADF); mOut.writeInt32(BC_EXIT_LOOPER); talkWithDriver(false); } è¿™é‡Œçœç•¥äº†å…¶å®ƒæ— å…³çš„ä»£ç ï¼Œå…ˆæ˜¯å¾€mOuté‡Œé¢å†™äº†ä¸€ä¸ªBC_ENTER_LOOPERæˆ–è€…BC_REGISTER_LOOPERï¼ŒBC_ENTER_LOOPERè¡¨ç¤ºè¿™ä¸ªçº¿ç¨‹æ˜¯è‡ªå·±ä¸»åŠ¨æ³¨å†Œåˆ°binderé©±åŠ¨çš„ï¼ŒBC_REGISTER_LOOPERè¡¨ç¤ºæ˜¯è¢«åŠ¨çš„ï¼Œç”±binderå…ˆç”³è¯·ï¼Œç„¶åç”±åº”ç”¨æ¥æ³¨å†Œã€‚æ³¨å†ŒæˆåŠŸä¹‹åï¼Œä»–åœ¨ä¸€ä¸ªwhileå¾ªç¯é‡Œé¢ä¸åœåœ°æ‰§è¡ŒgetAndExecuteCommandæ–¹æ³•ï¼Œä¸åœåœ°å»å–æŒ‡ä»¤ã€å¤„ç†æŒ‡ä»¤ï¼Œè¿™ä¸ªwhileå¾ªç¯ä¸€èˆ¬æ˜¯ä¸ä¼šé€€å‡ºçš„ï¼Œé™¤éæ˜¯é‡åˆ°äº†ä»€ä¹ˆé”™è¯¯ã€‚\næˆ‘ä»¬æ¥ç€çœ‹getAndExecuteCommandçš„å®ç°ï¼Œæ–¹æ³•ä½äº/frameworks/native/libs/binder/IPCThreadState.cppä¸­:\n1 2 3 4 5 6 7 8 9 10 11 status_t IPCThreadState::getAndExecuteCommand() { status_t result; int32_t cmd; result = talkWithDriver(); cmd = mIn.readInt32(); result = executeCommand(cmd); return result; } é€šè¿‡talkWithDriverä»é©±åŠ¨è¯»å–è¯·æ±‚ï¼Œè¿™ä¸ªåœ¨å‰é¢è®²è¿‡ï¼Œä¸»è¦æ˜¯é€šè¿‡binder_write_readçš„æ•°æ®ç»“æ„å’Œé©±åŠ¨è¯»å’Œå†™æ•°æ®ã€‚å†å°±æ˜¯executeCommandå¤„ç†è¿™ä¸ªè¯·æ±‚ï¼Œåœ¨å¤„ç†è¯·æ±‚ä¹‹å‰è¦å…ˆä»mIné‡Œé¢æŠŠæŒ‡ä»¤è¯»å‡ºæ¥ï¼Œç„¶åæ ¹æ®è¿™ä¸ªæŒ‡ä»¤æ¥æ‰§è¡Œä¸åŒçš„æ“ä½œã€‚\næ¥ç€çœ‹ä¸‹IPCThreadState::executeCommandæ–¹æ³•ï¼Œä½äº/frameworks/native/libs/binder/IPCThreadState.cppä¸­ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 status_t IPCThreadState::executeCommand(int32_t cmd) { BBinder* obj; RefBase::weakref_type* refs; status_t result = NO_ERROR; switch ((uint32_t)cmd) { case BR_TRANSACTION: { binder_transaction_data\u0026amp; tr; result = mIn.read(\u0026amp;tr, sizeof(tr)); Parcel buffer; buffer.ipcSetDataReference(...); Parcel reply; reinterpret_cast\u0026lt;BBinder*\u0026gt;(tr.cookie)-\u0026gt;transact(tr.code, buffer, \u0026amp;reply, tr.flags); sendReply(reply, (tr.flags \u0026amp; kForwardReplyFlags)); break; } return result; } è¿™é‡Œæ ¹æ®ä¸åŒçš„cmdèµ°åˆ°ä¸åŒçš„caseé‡Œé¢ï¼Œæˆ‘ä»¬ä¸»è¦å…³æ³¨BR_TRANSACTIONè¿™ä¸ªcaseï¼Œå®ƒçš„æ„æ€æ˜¯è¯´ClientæŠŠè¯·æ±‚å‘ç»™é©±åŠ¨ï¼Œé©±åŠ¨å†æŠŠè¯·æ±‚è½¬å‘ç»™Serverç«¯ï¼Œè½¬å‘ç»™Serverç«¯çš„æ—¶å€™å‘¢Serverç«¯çš„Binderçº¿ç¨‹å°±ä¼šæ”¶åˆ°è¿™ä¸ªæŒ‡ä»¤BR_TRANSACTIONã€‚\næ”¶åˆ°æŒ‡ä»¤åï¼Œé¦–å…ˆæŠŠæ•°æ®ä»mIné‡Œé¢è¯»å‡ºæ¥ï¼Œæ”¾åˆ°binder_transaction_dataé‡Œé¢ï¼Œæ¥ç€å‡†å¤‡ä¸¤ä¸ªParcelï¼Œä¸€ä¸ªbufferä¸€ä¸ªreplyï¼Œbufferæ˜¯è¦ä¼ é€’ç»™Serverç«¯ä¸Šå±‚çš„ï¼Œreplyå°±æ˜¯ä¸Šå±‚è¦å›å¤ç»™Clientç«¯çš„ã€‚\nbinder_transaction_dataé‡Œé¢æœ‰ä¸ªcookieå­—æ®µï¼Œä¿å­˜çš„æ˜¯Binderå®ä½“å¯¹è±¡ï¼Œå› ä¸ºè¿™é‡Œæ˜¯nativeå±‚ï¼Œæ‰€ä»¥cookieå°±æ˜¯Binderå®ä½“å¯¹è±¡åœ¨nativeå±‚çš„å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯BBinderï¼Œè·å–è¿™ä¸ªBinderå¯¹è±¡ã€‚\næ¥ç€è°ƒç”¨BBinderçš„transactæ–¹æ³•ï¼Œ æŠŠè¿™ä¸ªè¯·æ±‚å¾€ä¸Šä¼ ï¼Œå¾€Serverç«¯çš„ä¸Šå±‚å»ä¼ ã€‚æˆ‘ä»¬çœ‹ä¸‹transactæ–¹æ³•çš„å‚æ•°ï¼Œç¬¬ä¸€ä¸ªæ˜¯codeï¼Œç¬¬äºŒæ˜¯bufferï¼Œä¹Ÿå°±æ˜¯å‚æ•°ï¼Œç¬¬ä¸‰ä¸ªæ˜¯replyå›å¤çš„å‚æ•°ï¼Œç¬¬å››ä¸ªæ˜¯flagsã€‚\nä¸Šå±‚å¤„ç†å®Œä¹‹åå°±è°ƒç”¨sendReplyï¼ŒæŠŠè¿™ä¸ªå›å¤çš„replyå‘å‡ºå»ã€‚æ¥çœ‹ä¸‹sendReplyå®ç°ï¼š\n1 2 3 4 5 6 7 status_t IPCThreadState::sendReply(const Parcel\u0026amp; reply, uint32_t flags) { status_t err; status_t statusBuffer; err = writeTransactionData(BC_REPLY, flags, -1, 0, reply, \u0026amp;statusBuffer); return waitForResponse(nullptr, nullptr); } sendReplyçš„å®ç°ä¸­ï¼Œå…ˆè°ƒç”¨writeTransactionDataæ–¹æ³•ï¼ŒæŠŠæ•°æ®å†™åˆ°é©±åŠ¨é‡Œé¢ï¼Œé©±åŠ¨å†è½¬å‘ç»™Clientç«¯ï¼Œæˆ‘ä»¬éœ€è¦æ³¨æ„ä¸‹è¿™é‡Œçš„åè®®æ˜¯BC_REPLYï¼›æ¥ç€è°ƒç”¨waitForResponseæ–¹æ³•ï¼Œæ–¹æ³•çš„ä¸¤ä¸ªå…¥å‚éƒ½æ˜¯NULLï¼Œè·Ÿonewayæœ‰ç‚¹åƒï¼Œè¡¨ç¤ºä¸ç”¨ç­‰å¾…å¯¹æ–¹å›å¤äº†ã€‚\nä¸Šé¢executeCommandä¸­é€šè¿‡BBinderçš„transactè°ƒç”¨æœåŠ¡ç«¯çš„ä¸Šå±‚ï¼Œå®ƒä½äº/frameworks/native/libs/binder/Binder.cppï¼š\n1 2 3 4 5 6 7 8 9 10 11 status_t BBinder::transact( uint32_t code, const Parcel\u0026amp; data, Parcel* reply, uint32_t flags) { status_t err = NO_ERROR; switch (code) { default: err = onTransact(code, data, reply, flags); break; } return err; } åœ¨transactä¸­æ ¹æ®ä¸åŒçš„codeæ‰§è¡Œä¸åŒçš„æŒ‡ä»¤ï¼Œè¿™é‡Œèµ°çš„æ˜¯defaultåˆ†æ”¯ï¼Œè°ƒç”¨çš„æ˜¯onTransactæ–¹æ³•ï¼ŒBBinderçš„å®é™…å¯¹è±¡æ˜¯JavaBBinderå¯¹è±¡ï¼Œç»§ç»­çœ‹JavaBBinder::onTransactï¼Œæºç ä½äº/frameworks/base/core/jni/android_util_Binder.cppï¼š\n1 2 3 4 5 6 7 8 status_t onTransact( uint32_t code, const Parcel\u0026amp; data, Parcel* reply, uint32_t flags = 0) override { JNIEnv* env = javavm_to_jnienv(mVM); jboolean res = env-\u0026gt;CallBooleanMethod(mObject, gBinderOffsets.mExecTransact, code, reinterpret_cast\u0026lt;jlong\u0026gt;(\u0026amp;data), reinterpret_cast\u0026lt;jlong\u0026gt;(reply), flags); return res != JNI_FALSE ? NO_ERROR : UNKNOWN_TRANSACTION; } javavm_to_jnienvæ–¹æ³•æ˜¯æ ¹æ®javaçš„VMæ‹¿åˆ°å½“å‰çº¿ç¨‹çš„jni Environmentï¼Œå½“å‰çº¿ç¨‹æ˜¯åœ¨binderçº¿ç¨‹æ± ä¸­ï¼Œæ‹¿åˆ°ä¹‹åå°±å¯ä»¥å‘èµ·jniè°ƒç”¨äº†ã€‚æ¥ç€å‘èµ·jniè°ƒç”¨ï¼Œè°ƒç”¨äº†Binderå¯¹è±¡çš„execTransactå‡½æ•°ï¼ŒexecTransactå‡½æ•°çš„æºç ä½äº/frameworks/base/core/java/android/os/Binder.javaä¸­ï¼Œåœ¨å®ƒé‡Œé¢è°ƒç”¨äº†Binderå¯¹è±¡çš„onTransactå‡½æ•°ã€‚\nåœ¨ä¸Šé¢çš„ gBinderOffsets.mExecTransact å¯¹åº”äº†Binderå¯¹è±¡çš„execTransactæ–¹æ³•ï¼Œå®ƒæ˜¯åœ¨frameworks/base/core/jni/android_util_Binder.cpp#int_register_android_os_Binderæ–¹æ³•ä¸­æ³¨å†Œçš„ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 const char* const kBinderPathName = \u0026#34;android/os/Binder\u0026#34;; static int int_register_android_os_Binder(JNIEnv* env) { jclass clazz = FindClassOrDie(env, kBinderPathName); gBinderOffsets.mClass = MakeGlobalRefOrDie(env, clazz); gBinderOffsets.mExecTransact = GetMethodIDOrDie(env, clazz, \u0026#34;execTransact\u0026#34;, \u0026#34;(IJJI)Z\u0026#34;); return RegisterMethodsOrDie( env, kBinderPathName, gBinderMethods, NELEM(gBinderMethods)); } è€Œæˆ‘ä»¬æœåŠ¡ç«¯çš„binderå¯¹è±¡æ­£æ˜¯aidlç”Ÿæˆçš„Stubå†…éƒ¨ç±»ï¼Œæ¯”å¦‚åœ¨å¯åŠ¨activityè¿‡ç¨‹ä¸­ï¼Œå®é™…å°±æ˜¯IActivityTaskManager.aidlé€šè¿‡aidlå·¥å…·ç¼–è¯‘æˆçš„å†…éƒ¨ç±»stubï¼Œè€Œframeworks/base/services/core/java/com/android/server/am/ActivityManagerService.javaå®ƒæ˜¯ç»§æ‰¿è‡ªIActivityManager. Stubï¼Œæ‰€ä»¥æœ€ç»ˆæ˜¯è°ƒç”¨äº†ActivityManagerServiceçš„onTransactæ–¹æ³•ã€‚\næ€»ç»“ one wayè¯·æ±‚æ–¹å¼\nåˆ†æå®Œæ•´ä¸ªæµç¨‹åï¼Œæˆ‘ä»¬å†æ¥çœ‹ä¸‹ one way è¯·æ±‚æ–¹å¼ï¼Œåœ¨ä¸Šé¢å®¢æˆ·ç«¯åˆ°é©±åŠ¨å±‚è¯·æ±‚è¿‡ç¨‹ä¸­ï¼Œåœ¨ IPCThreadState::transact æ–¹æ³•ä¸­ï¼Œä¼šé€šè¿‡flagså‚æ•°åˆ¤æ–­æ˜¯ä¸æ˜¯ one way è¯·æ±‚æ–¹å¼ï¼Œå¦‚æœæ˜¯ one way ï¼Œç»™waitForResponseæ–¹æ³•ä¼ è¿›å»çš„replyå’ŒacquireResultå‚æ•°éƒ½æ˜¯ç©ºï¼Œåœ¨è¯¥æ–¹æ³•é‡Œé¢å¦‚æœæ”¶åˆ°äº†BR_TRANSACTION_COMPLETEçš„æ—¶å€™ï¼Œä¹Ÿå°±æ˜¯é©±åŠ¨å±‚æ”¶åˆ°äº†å®¢æˆ·ç«¯çš„binderè¯·æ±‚ï¼Œç„¶åç»™åˆ°æœåŠ¡ç«¯çš„å›æ‰§ï¼Œåœ¨è¿™é‡Œé¢å¦‚æœreplyå’ŒacquireResultå‚æ•°ä¸ºç©ºï¼Œç›´æ¥é€€å‡ºäº†waitForResponseçš„whileå¾ªç¯ï¼Œä¹Ÿå°±æ˜¯å®¢æˆ·ç«¯ä¸è¿›è¡Œä¼‘çœ ç­‰å¾…æœåŠ¡ç«¯çš„ç›¸åº”ã€‚\nTransactionTooLargeExceptioné—®é¢˜\nå†æ¥çœ‹å¼€ç¯‡è®²åˆ°çš„parcelä¸­æ•°æ®é‡å¤§çš„é—®é¢˜ï¼ŒIPCThreadState::writeTransactionDataæ–¹æ³•ä¸­å…ˆåˆ¤æ–­dataè¿™ä¸ªparcelçš„æ•°æ®é‡æ˜¯å¦æœ‰é—®é¢˜ï¼Œæ˜¯é€šè¿‡errorCheckæ¥åˆ¤æ–­ï¼Œè¿™ä¸ªé”™è¯¯ä¿¡æ¯ï¼Œæ˜¯åœ¨ write** ç­‰ç³»åˆ—æ–¹æ³•ä¸­è°ƒç”¨continueWriteæ—¶å€™ï¼Œåˆ¤æ–­æ˜¯å¦è¶…è¿‡æ€»å¤§å°ï¼Œè¿™ä¸ªæ€»å¤§å°æ˜¯åœ¨ProcessState.cppä¸­è°ƒç”¨mmapå†…å­˜æ˜ å°„çš„æ—¶å€™ï¼ŒæŒ‡å®šäº†binderçš„æœ€å¤§å†…å­˜ä½BINDER_VM_SIZE = ((1 * 1024 * 1024) - sysconf(_SC_PAGE_SIZE) * 2)ã€‚æœ€ç»ˆè¿™ä¸ªerrorä¸€è·¯è¿”å›åˆ°android_util_Binder.cppçš„android_os_BinderProxy_transactæ–¹æ³•æ–¹æ³•ï¼Œåœ¨è¯¥æ–¹æ³•é‡Œé¢ä¼šè°ƒç”¨signalExceptionForErroræ–¹æ³•ï¼Œåœ¨è¯¥æ–¹æ³•é‡Œé¢ä¼šé€šè¿‡åˆ¤æ–­é”™è¯¯ç æ˜¯ FAILED_TRANSACTION ï¼Œç„¶åé€šè¿‡jniç»™javaå±‚æŠ›å‡ºTransactionTooLargeExceptionå¼‚å¸¸ã€‚\né€šä¿¡åè®®\nâ‘ é¦–å…ˆä»Clientå‘èµ·ä¸€ä¸ªBC_TRANSACTIONï¼Œä¹Ÿå°±æ˜¯Clientå‘Serverç«¯å‘èµ·ä¸€ä¸ªIPCè°ƒç”¨çš„æ—¶å€™ï¼Œå®ƒé¦–å…ˆä¼šå‘binderé©±åŠ¨å†™äº†BC_TRANSACTIONæŒ‡ä»¤ï¼Œbinderæ”¶åˆ°ä¹‹åä¼šç»™Clientä¸€ä¸ªå›æ‰§ï¼Œä¹Ÿå°±æ˜¯BR_TRANSACTION_COMPLETEã€‚\nâ‘¡å›æ‰§å‘å®Œäº†ä¹‹åï¼Œbinderé©±åŠ¨å†æŠŠè¿™ä¸ªè¯·æ±‚è½¬å‘ç»™Serverç«¯ï¼Œé€šè¿‡BR_TRANSACTIONæŒ‡ä»¤ã€‚\nâ‘¢Serverç«¯æ”¶åˆ°BR_TRANSACTIONæŒ‡ä»¤ä¹‹åå»å¤„ç†è¿™ä¸ªè¯·æ±‚ï¼Œå¤„ç†å®Œä¹‹åä¼šå›å¤binderé©±åŠ¨ï¼Œé€šè¿‡BC_REPLYæŒ‡ä»¤ã€‚\nâ‘£é©±åŠ¨æ”¶åˆ°Serverç«¯çš„å›å¤ä¹‹åï¼Œä¹Ÿä¼šç»™Serverç«¯ä¸€ä¸ªå›æ‰§ï¼Œå°±æ˜¯BR_TRANSACTION_COMPLETEæŒ‡ä»¤ã€‚\nâ‘¤æœ€åbinderé©±åŠ¨å†æŠŠè¿”å›ç»“æœè½¬å‘ç»™Clientç«¯ï¼Œé€šè¿‡BR_REPLYæŒ‡ä»¤ã€‚\nâ‘¥éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒClientåœ¨å‘å‡ºè¯·æ±‚ä¹‹åï¼Œåœ¨ç­‰å¾…Serverç«¯å›å¤çš„è¿‡ç¨‹ä¸­ï¼ŒClientå¤„äºä¼‘çœ çŠ¶æ€ã€‚å¦å¤–Serverç«¯åº”è¯¥æ˜¯Binderçº¿ç¨‹ï¼ŒBinderçº¿ç¨‹åœ¨å¤„ç†è¯·æ±‚ä¹‹å¤–çš„æ—¶é—´ä¹Ÿæ˜¯å¤„äºä¼‘çœ çŠ¶æ€çš„ï¼Œç­‰ç€binderé©±åŠ¨å‘è¿‡æ¥çš„è¯·æ±‚ã€‚\næœ€åæ¥ä¸€å¼ åˆ«äººæ€»ç»“çš„binderåˆ†å±‚æ¶æ„å›¾ï¼š\n","date":"2025-03-20T00:00:00Z","permalink":"http://xiangcman.xyz/p/binder%E9%80%9A%E4%BF%A1%E5%8E%9F%E7%90%86/","title":"binderé€šä¿¡åŸç†"},{"content":"booster-transform-activity-thread ä½œç”¨ï¼šæ•æ‰å¼‚å¸¸ä¿¡æ¯ï¼Œæ˜¯æŠ›å¼‚å¸¸è¿˜æ˜¯æ•æ‰åˆ°å¼‚å¸¸ï¼Œå¯ä»¥é€šè¿‡æ•æ‰åˆ°å¼‚å¸¸åï¼Œä¸Šä¼ åˆ°æœåŠ¡ç«¯ æ’ä»¶å…¥å£ï¼šActivityThreadTransformer é€šè¿‡è§£æmanifestä¸­çš„applicationæ ‡ç­¾ï¼Œç„¶ååœ¨applicationçš„onCreateæ–¹æ³•æœ€åæ’å…¥ActivityThreadHooker.hook(\u0026quot;\u0026quot;)æ–¹æ³•ï¼Œå…¶ä¸­å‚æ•°ä¼ å…¥çš„æ˜¯å¿½ç•¥çš„åŒ…åï¼Œè·å–çš„æ˜¯gradle.propertiesä¸­çš„booster.transform.activity.thread.packages.ignoreé…ç½®ï¼š 1 booster.transform.activity.thread.packages.ignore=com.demo.cdh.cardswipedemo åœ¨ActivityThreadHookerä¸­è·å–åˆ°ActivityThreadç±»çš„mHï¼Œå®ƒæ˜¯ä¸€ä¸ªhandlerï¼Œç„¶åç»™å®ƒçš„mCallbackæ›¿æ¢ä¸ºActivityThreadCallbackï¼Œæ‰€ä»¥æœ€ç»ˆä¼šå›è°ƒåˆ°ActivityThreadCallbackçš„handleMessageæ–¹æ³•ä¸­ï¼Œè¯¥æ–¹æ³•ä¼šå¤„ç†å„ç§å¼‚å¸¸ä¿¡æ¯ï¼Œåœ¨å¤„ç†å¼‚å¸¸çš„æ—¶å€™ï¼Œå¦‚æœä¸æ˜¯å¿½ç•¥çš„åŒ…åï¼Œåˆ™è®¤ä¸ºæ˜¯éœ€è¦å¤„ç†çš„å¼‚å¸¸ï¼Œç„¶åæŠŠè¯¥å¼‚å¸¸æŠ›å‡ºå»äº†ï¼Œäº¤ç»™ç³»ç»Ÿå»å¤„ç†ã€‚å¦åˆ™ä¸æŠ›ç»™ç³»ç»Ÿï¼Œåº”ç”¨ä¸ä¼šå´©æºƒã€‚ ç†è§£ï¼šåœ¨apkæ„å»ºé˜¶æ®µï¼Œå®ƒæ˜¯æ²¡æœ‰androidç¯å¢ƒçš„ï¼Œæ‰€ä»¥åœ¨transformé˜¶æ®µåªæ˜¯åœ¨è‡ªå®šä¹‰çš„applicationçš„onCreateæ–¹æ³•æœ€åæ’å…¥äº†ActivityThreadHooker.hook()æ–¹æ³•ï¼Œåœ¨è¯¥æ–¹æ³•é‡Œé¢æ„å»ºäº†ActivityThreadCallbackå¯¹è±¡ï¼Œåœ¨è¯¥å¯¹è±¡çš„æ„é€ å™¨ä¸­é€šè¿‡é‡æ–°å®šä¹‰ä¸€ä¸ªå’Œandroidä¸€æ ·çš„ActivityThreadçš„åŒ…åå’Œç±»åã€‚æ‰€ä»¥ç­‰åˆ°apkè¿è¡Œçš„æ—¶å€™ï¼Œé€šè¿‡å¯åŠ¨äº†androidçš„è™šæ‹Ÿæœºï¼Œä¼šä¼˜å…ˆæ‰¾åˆ°ç³»ç»Ÿçš„ActivityThreadç±»ã€‚æˆ‘å¯ä»¥ç†è§£æœ‰ç‚¹å·æ¢æ¢æŸ±çš„æ„Ÿè§‰ã€‚ booster-transform-logcat ä½œç”¨ï¼šå°†ç³»ç»Ÿè°ƒç”¨Log.()ã€e.printStackTrace()ã€System.outæˆ–System.errçš„æ–¹æ³•åˆ†åˆ«æ›¿æ¢æˆShadowLog.()ã€ShadowThrowable.printStackTrace(e:Exception)ã€ShadowSystem.outæˆ–ShadowSystem.errç­‰æ–¹æ³•ï¼Œè€Œè¿™äº›æ–¹æ³•ä¸­éƒ½æ˜¯ç©ºå®ç°ã€‚ æ’ä»¶å…¥å£ï¼šLogcatTransformer åœ¨transformæ–¹æ³•ä¸­ï¼Œé€šè¿‡ClassNodeéå†æ–¹æ³•ï¼Œç„¶ååœ¨æ–¹æ³•çš„æŒ‡ä»¤ä¸­å¦‚æœé‡åˆ°opcodeæ˜¯INVOKESTATICï¼Œé‚£ä¹ˆæ­¤æ—¶çš„æŒ‡ä»¤æ˜¯ä¸€ä¸ªMethodInsnNodeï¼Œå¦‚æœMethodInsnNodeçš„owneræ˜¯android/util/Logå¹¶ä¸”æ˜¯æ„Ÿå…´è¶£çš„æ–¹æ³•åˆ™å‘½ä¸­ï¼›å¦‚æœopcodeæ˜¯INVOKEVIRTUALï¼ˆjavaå®ä¾‹çš„æ™®é€šæ–¹æ³•çš„è°ƒç”¨ï¼‰ï¼Œæ­¤æ—¶ä¹Ÿæ˜¯ä¸€ä¸ªMethodInsnNodeï¼Œè·å–æ–¹æ³•çš„nameæ˜¯printStackTraceï¼Œå¹¶ä¸”æ–¹æ³•çš„æè¿°æ˜¯()Vï¼Œå¹¶ä¸”é€šè¿‡åˆ¤æ–­å½“å‰ownerçš„classç±»å‹æ˜¯java.lang.throwableçš„classå­ç±»å‹æ—¶å°±å‘½ä¸­ï¼›å¦‚æœopcodeæ˜¯GETSTATICï¼Œå¹¶ä¸”owneræ˜¯java/lang/Systemï¼Œæ–¹æ³•çš„nameæ˜¯outæˆ–æ˜¯erræ—¶å€™ä¹Ÿå‘½ä¸­ã€‚ åœ¨ä¸Šé¢åˆ¤æ–­å½“å‰MethodInsnNodeçš„ownerçš„classç±»å‹æ˜¯java.lang.throwableçš„classå­ç±»å‹æºç åˆ†æï¼š 1 context.klassPool.get(THROWABLE).isAssignableFrom(it.owner) context.klassPool.get(THROWABLE)æ‹¿åˆ°çš„æ˜¯ä¸€ä¸ªAbstractKlassPoolï¼Œå®ƒè¡¨ç¤ºçš„æ˜¯transformé˜¶æ®µæ‰€æœ‰å·²ç»åŠ è½½è¿‡çš„classçš„æ± å­ï¼Œå®ƒæ˜¯åœ¨BoosterTransformInvocationä¸­åˆå§‹åŒ–çš„ï¼Œåˆå§‹åŒ–çš„æ—¶å€™æ¥æ”¶compileClasspathå’Œtransform.bootKlassPoolï¼Œå…¶ä¸­compileClasspathè¡¨ç¤ºçš„transformé˜¶æ®µæ‰€æœ‰çš„è¾“å…¥classï¼ˆåŒ…æ‹¬æ‰€æœ‰transformé˜¶æ®µå¯ä»¥ä¿®æ”¹å’Œä¸å¯ä¿®æ”¹çš„è¾“å…¥classå’Œjaræ–‡ä»¶è·¯å¾„ï¼‰ï¼Œæ­¤å¤„çš„ä¸å¯ä¿®æ”¹è¡¨ç¤ºå½“å‰transformè¯†åˆ«åˆ°çš„å…¶å®ƒæ’ä»¶ç”Ÿæˆçš„classï¼Œä¾‹å¦‚dagger2ã€ButterKnifeç­‰ã€‚transform.bootKlassPoolæ˜¯è·å–AndroidExtensionsçš„bootClasspathçš„è·¯å¾„ï¼Œç„¶åç”Ÿæˆä¸€ä¸ªAbstractKlassPoolï¼ŒAndroidExtensionsçš„bootClasspathçš„è·¯å¾„æŒ‡çš„æ˜¯ç¼–è¯‘æ—¶ JDK + Android Framework çš„åŸºç¡€ç±»åº“è·¯å¾„ã€‚æ‰€ä»¥æ­¤å¤„æœ‰ä¸¤ä¸ªAbstractKlassPoolï¼Œä¸€ä¸ªæ˜¯ç”¨æ¥è¡¨ç¤ºbootClasspathçš„çˆ¶ç±»æ± å­ï¼Œå¦å¤–ä¸€ä¸ªå°±æ˜¯compileClasspathçš„æ± å­ï¼ŒbootClasspathçš„çˆ¶ç±»æ± å­çš„classloaderæŒ‡å‘äº†compileClasspathçš„æ± å­çš„çˆ¶classloaderï¼Œæ­¤å¤„ç”¨åˆ°çš„classloaderæ˜¯ä¸€ä¸ªURLClassLoaderï¼Œç”¨å®ƒæ˜¯ä¸ºäº†å’Œgradleä¸»ç±»åŠ è½½å™¨é¿å…å†²çªï¼Œèƒ½å¤Ÿç‹¬ç«‹ç®¡ç†é¡¹ç›®ç±»è·¯å¾„ï¼Œæ”¯æŒæŒ‰éœ€åŠ è½½ç±»å’Œèµ„æºï¼Œé€‚åº”å­—èŠ‚ç æ“ä½œéœ€æ±‚ï¼Œéš”ç¦»Boosterå†…éƒ¨ä¾èµ–ï¼Œé˜²æ­¢ä¸é¡¹ç›®ä¾èµ–å†²çªï¼Œå…è®¸åŠ¨æ€æ·»åŠ æ’ä»¶æˆ–æ¨¡å—çš„ç±»è·¯å¾„ã€‚æœ€ååŠ è½½è¿‡çš„classä¼šæ”¾åˆ°mapä¸­ï¼Œä¸‹æ¬¡ç›´æ¥æ‹¿åˆ°è¯¥classï¼Œæœ€ç»ˆé€šè¿‡classçš„isAssignableFromæ–¹æ³•æ¥åˆ¤æ–­ä¼ å…¥çš„classæ˜¯å¦æ˜¯çˆ¶classçš„å­ç±»ã€‚ booster-transform-shared-preferences ","date":"2025-03-18T00:00:00Z","permalink":"http://xiangcman.xyz/p/booster%E5%85%B6%E4%BB%96%E6%8F%92%E4%BB%B6%E4%BB%8B%E7%BB%8D/","title":"Boosterå…¶ä»–æ’ä»¶ä»‹ç»"},{"content":"å¹³æ—¶å¦‚æœæœ‰å®šåˆ¶åŒ–pdfçš„æ—¶å€™ï¼Œä¸€èˆ¬éƒ½æ˜¯é€šè¿‡æœ‰é“äº‘ç¬”è®°æ¥åˆ°å¤„pdfï¼Œè‡ªä»ç”¨ä¸ŠVScodeå¯¼å‡ºpdfåï¼Œå‘ç°éå¸¸niceã€‚ä¸‹é¢è®°å½•ä¸‹æ•´ä¸ªå®šåˆ¶pdfçš„è¿‡ç¨‹ã€‚\nä¸‹è½½æ’ä»¶ åœ¨vscodeä¸­é€‰æ‹©Extensionsï¼Œå¹¶æœç´¢Markdown PDFæ’ä»¶ å®‰è£…å®Œåï¼Œå¼€å§‹é€šè¿‡é…ç½®settings.jsonæ–‡ä»¶æ¥é…ç½®Markdown PDFæ’ä»¶ ä½¿ç”¨å¿«æ·é”®command+shift+pè°ƒèµ·vscodeæœç´¢åŠŸèƒ½ï¼Œæœç´¢æ¡†ä¸­è¾“å…¥settings.json settings.jsonå…³äºmarkdwon pdfé…ç½®å¦‚ä¸‹ï¼š 1 2 3 \u0026#34;markdown-pdf.displayHeaderFooter\u0026#34;: false,//ä¸æ˜¾ç¤ºé¡µç å’Œé¡µçœ‰ \u0026#34;markdown-pdf.styles\u0026#34;:[\u0026#34;/Users/xiangcheng/desktop/youdao-style.css\u0026#34;],//è‡ªå®šä¹‰css \u0026#34;markdown-pdf.breaks\u0026#34;: true//æ˜¯è¢«bræ ‡ç­¾ç”¨æ¥æ¢è¡Œæˆ–è€…ç©ºä¸€è¡Œ youdao-style.cssçš„é…ç½®å¦‚ä¸‹ï¼š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 /* å…¨å±€æ ·å¼ */ body { font-family: \u0026#34;Helvetica Neue\u0026#34;, \u0026#34;Microsoft YaHei\u0026#34;, \u0026#34;Segoe UI\u0026#34;, Arial, sans-serif; font-size: 14px; line-height: 1.5; color: #28262a; margin: 0; padding: 0; } /* æ ‡é¢˜æ ·å¼ */ h1 { font-size: 24px; border-bottom: 2px solid #eee; padding-bottom: 0.3em; } h2 { font-size: 20px; border-bottom: 1px solid #eee; } h3 { font-size: 16px; font-weight: bold; } /* ä»£ç å— */ pre { background-color: #f6f8fa; border-radius: 4px; padding: 12px; overflow: auto; } code { font-family: \u0026#34;Consolas\u0026#34;, \u0026#34;Monaco\u0026#34;, monospace; background-color: rgba(27, 31, 35, 0.05); padding: 0.2em 0.4em; border-radius: 3px; } /* Table styles ripped from Github */ table { display: block; overflow: auto; width: 100%; border-collapse: collapse; border-spacing: 0; } tbody { display: table-row-group; vertical-align: middle; border-color: inherit; } table tr { background-color: #fff; border-top: 1px solid #c6cbd1; } table tr:nth-child(2n) { background-color: #f6f8fa; } table th { font-weight: 600; } table td, table th { border: 1px solid #dfe2e5; padding: 6px 13px; } table tr { background-color: #fff; border-top: 1px solid #c6cbd1; } table tr:nth-child(2n) { background-color: #f6f8fa; } table\u0026gt;thead\u0026gt;tr\u0026gt;th { border-bottom: 0; } /* End of table styles */ /* åˆ—è¡¨ */ ul, ol { padding-left: 2em; } li { margin: 0.15em 0; } /* é“¾æ¥ */ a { color: #3f6bde; text-decoration: none; } /* å›¾ç‰‡å±…ä¸­ */ p\u0026gt;img { display: block; margin: 0 auto; } blockquote { border-left: 2px solid #d0d7df; /* å·¦ä¾§è¾¹æ¡†é¢œè‰² */ background: white; /* èƒŒæ™¯è‰² */ } /* é¡µé¢è®¾ç½® */ @page { size: A4; margin: 5mm; } ä½¿ç”¨ æ‰“å¼€ä¸€ä¸ªmdæ–‡ä»¶åï¼Œç„¶åå³é”®ï¼š å‚è€ƒï¼š https://github.com/yzane/vscode-markdown-pdf youdao-style.css\n","date":"2025-03-18T00:00:00Z","permalink":"http://xiangcman.xyz/p/vscode%E8%87%AA%E5%AE%9A%E4%B9%89pdf/","title":"VScodeè‡ªå®šä¹‰pdf"},{"content":"bitmapè§£ç æ–¹å¼ è§£ç æŒ‡çš„æ˜¯æŠŠå›¾ç‰‡é€šè¿‡æ–‡ä»¶è¯»å–åˆ°å†…å­˜ä¸­ï¼Œè€Œbitmapæ­£æ˜¯æ‰¿è½½ç€å›¾ç‰‡åœ¨å†…å­˜ä¸­å­˜å‚¨çš„å¯¹è±¡ã€‚å…³äºå›¾ç‰‡çš„è§£ç æ–¹å¼æœ‰å¦‚ä¸‹å‡ ç§ï¼š\nALPHA_8ï¼šåªå­˜å‚¨é€æ˜åº¦ä¿¡æ¯ï¼Œä¸€ä¸ªåƒç´ å ç”¨ä¸€ä¸ªå­—èŠ‚ï¼Œä¸€ä¸ªå­—èŠ‚æ˜¯8ä½ã€‚æ‰€ä»¥åœ¨åœ¨è¯¥è§£ç æ–¹å¼ä¸‹ï¼Œä¸€ä¸ªåƒç´ æ˜¯å 8ä½ã€‚ ARGB_4444ï¼šæ¯ä¸ªåƒç´ å 2ä¸ªå­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯16ä½ï¼Œå…¶ä¸­Aå 4ä½ï¼ŒRå 4ä½ï¼ŒGå 4ä½ï¼ŒBå 4ä½ï¼ˆ4+4+4+4ï¼‰ï¼Œæ”¯æŒalphaé€šé“ ä»API13å¼€å§‹ä¸æ¨èä½¿ç”¨ï¼Œåœ¨android4.4ä¸Šé¢ï¼Œè®¾ç½®çš„ARGB_4444ä¼šè¢«ç³»ç»Ÿä½¿ç”¨ARGB_8888æ›¿æ¢ ARGB_8888ï¼šbitmapç¼–ç çš„é»˜è®¤æ–¹å¼ï¼Œæ¯åƒç´ å 4å­—èŠ‚ï¼Œæ¯ä¸ªé€šé“åˆ†åˆ«å 8ä½ RGB_565ï¼šæ¯åƒç´ å ç”¨2å­—èŠ‚ï¼ŒRGBåˆ†åˆ«å 5ï¼Œ6ï¼Œ5ä½ï¼Œä¸æ”¯æŒalphaé€šé“ å‚è€ƒï¼šhttps://www.ieclipse.cn/2017/06/14/Android/Android-bitmap-config/ ä¸Šé¢æåˆ°çš„RGB_565è§£ç æ–¹å¼ï¼Œä¸ºä»€ä¹ˆæ˜¯5,6,5å‘¢ï¼Ÿ RGB_565 æ˜¯æ—©æœŸ Android åœ¨ å†…å­˜é™åˆ¶ã€æ¸²æŸ“æ•ˆç‡ã€è§†è§‰è´¨é‡ ä¸‰è€…é—´æ‰¾åˆ°çš„å¹³è¡¡ç‚¹ã€‚éšç€è®¾å¤‡ç¡¬ä»¶æå‡ï¼Œæ›´é«˜ç²¾åº¦çš„æ ¼å¼ï¼ˆå¦‚ ARGB_8888ï¼‰é€æ¸æˆä¸ºé»˜è®¤é€‰é¡¹ï¼Œä½†åœ¨ç‰¹å®šä¼˜åŒ–åœºæ™¯ä¸­ï¼ŒRGB_565 ä»æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„çœå†…å­˜æ–¹æ¡ˆã€‚ æµ‹è¯•å„ç§è§£ç æ–¹å¼ å¯¹äºå¸¦æœ‰é€æ˜çš„å›¾ç‰‡ï¼šåœ¨ALPHA_8ä¸‹ï¼Œå®ƒæ˜¯åªæœ‰é€æ˜ä¿¡æ¯ï¼Œä½†æ˜¯ä»–å ç”¨çš„å¤§å°è¿˜æ˜¯ä¸€ä¸ªåƒç´ å 4ä¸ªå­—èŠ‚ï¼Œå¹¶ä¸”å±•ç¤ºçš„å›¾ç‰‡å’ŒARGB_8888ä¸€æ ·çš„ã€‚RGB_565æ˜¯ä¸å¸¦é€æ˜é€šé“çš„ï¼Œä½†æ˜¯å¸¦æœ‰é€æ˜åº¦çš„å›¾ç‰‡è¿˜æ˜¯èƒ½å‘ˆç°é€æ˜æ ·å¼çš„ï¼Œå¹¶ä¸”å ç”¨å†…å­˜å’ŒARGB_8888ä¸€æ ·çš„ã€‚ å¯¹äºéé€æ˜çš„å›¾ç‰‡ï¼šRGB_565ä¸‹å†…å­˜å ç”¨æ˜¯ARGB_8888çš„ä¸€åŠã€‚åœ¨ALPHA_8ä¸‹é¢å±•ç¤ºçš„å›¾ç‰‡æ‰€å ç”¨çš„å­—èŠ‚å¤§å°å’ŒARGB_8888æ˜¯ä¸€æ ·çš„ã€‚ å…³äºè¿™å—ä¸ºä»€ä¹ˆå¸¦æœ‰é€æ˜çš„å›¾ç‰‡åœ¨alpha_8ä¸‹è¿˜æ˜¯å’Œargb_8888ä¸‹é¢ä¸€æ ·çš„ï¼Œä¸‹é¢æ–‡ç« æœ‰è®²è§£ï¼š https://juejin.cn/post/7059206294959292452 æµ‹è¯•äº†ä¸‹å¸¦é€æ˜çš„å›¾ç‰‡ä½¿ç”¨RGB_565çš„æ—¶å€™ï¼Œå‘ç°è§£ç ç”Ÿæˆçš„bitmapçš„configè¿˜æ˜¯ARGB_8888ï¼Œè¯´æ˜ç³»ç»Ÿè¿˜æ˜¯ä¼šé€‰æ‹©åˆé€‚çš„é¢œè‰²æ¨¡å¼æ¥è§£ç ï¼Œé€šè¿‡å¦‚ä¸‹è·å–æœ€ç»ˆçš„è§£ç æ–¹å¼ï¼š bitmapå‹ç¼© 1.é‡‡æ ·ç‡å‹ç¼©ï¼šè®¾ç½®BitmapFactory.Options.inSampleSizeï¼Œå€¼è¶Šå¤§ï¼Œå¯¹åº”çš„å®½é«˜çš„åƒç´ å€¼è¶Šå°ï¼Œå¦‚æœinSampleSize=2ï¼Œåˆ™å†…å­˜æ˜¯åŸæ¥çš„4åˆ†æ”¯1äº†ï¼Œå› ä¸ºå®½é«˜å„å‡å°‘2å€ 2.è®¾ç½®ç¼–ç æ ¼å¼ï¼šBitmapFactory.Options.inPreferredConfigï¼Œä¸€èˆ¬è®¾ç½®æœ‰RGB_565ï¼ŒARGB_8888ï¼ŒRGB_565çš„æ—¶å€™å¿½ç•¥äº†é€æ˜é€šé“ã€‚ 3.è´¨é‡å‹ç¼©ï¼šè´¨é‡å‹ç¼©ä¸æ”¹å˜å›¾ç‰‡çš„åƒç´ ï¼Œæ”¹å˜å›¾ç‰‡çš„ä½æ·±å’Œé€æ˜åº¦ï¼Œé€‚åˆäºŒè¿›åˆ¶å›¾ç‰‡æ•°æ®ï¼Œå¸¸è§çš„æœ‰PNGã€JPEGã€WEBPå‹ç¼©ç®—æ³•ã€‚å…¶ä¸­PNGå‹ç¼©ç®—æ³•ç§°ä¸ºæ— æŸå‹ç¼©ï¼ŒåŸºæœ¬ä¸ä¼šæ”¹å˜å›¾ç‰‡å ç”¨æ–‡ä»¶çš„å¤§å°ï¼ŒJPEGä¼šæ ¹æ®qualityå‚æ•°æ¥å®ç°å‹ç¼©ã€‚ ç»è¿‡æµ‹è¯•ï¼šåœ¨PNGå‹ç¼©ç®—æ³•ä¸‹ï¼Œå›¾ç‰‡ä¸ä¼šæ”¹å˜ï¼Œå› æ­¤è¢«ç§°ä¸ºæ— æŸå‹ç¼©\nåœ¨JPEGå‹ç¼©ç®—æ³•ä¸‹ï¼Œå¦‚æœæ˜¯å¸¦æœ‰é€æ˜çš„å›¾ç‰‡ï¼Œç”±äºä¼šå¿½ç•¥é€æ˜åº¦ï¼Œå› æ­¤ä¼šæ˜¾ç¤ºæˆé»‘è‰²ã€‚å¹¶ä¸”å‘ç°ä¿å­˜åˆ°æœ¬åœ°çš„æ–‡ä»¶å¤§å°ä¼šå¢å¤§ï¼Œä½†æ˜¯äºŒè¿›åˆ¶çš„byteæ•°ä¼šéšç€qualityå˜å°è€Œå˜å°ã€‚å› æ­¤å¸¦æœ‰é€æ˜çš„å›¾ç‰‡æ…ç”¨\nwebå‹ç¼©ç®—æ³•æ˜¯ä¸€ç§æœ‰æŸå‹ç¼©ï¼Œwebpå›¾åƒçš„ä½“ç§¯è¦æ¯”jpegæ ¼å¼å›¾åƒå°40%ï¼Œä½†æ˜¯webpçš„ç¼–ç æ—¶é—´æ¯”jpegæ ¼å¼é•¿8å€ã€‚ https://juejin.cn/post/6844903725081821198#heading-12\nbitmapå†…å­˜è·å– bitmapçš„å®½ï¼ˆåƒç´ ä¸ªæ•°ï¼‰*bitmapçš„é«˜ï¼ˆåƒç´ ä¸ªæ•°ï¼‰*æ¯ä¸ªåƒç´ æ‰€å ç”¨çš„å†…å­˜ bitmapçš„å®é™…å®½ï¼š å›¾ç‰‡çš„çœŸå®å®½*è®¾å¤‡çš„densityDpi/å›¾ç‰‡æ‰€åœ¨çš„drawableçš„densityDpi è®¾å¤‡çš„densityDpi:æœ€ç»ˆä¼šèµ‹å€¼åˆ°ä¸ŠBitmapFactory.Options.inTargetDensityï¼Œé€šè¿‡å¦‚ä¸‹æ–¹å¼è·å–è®¾å¤‡çš„densityDpiï¼š å›¾ç‰‡æ‰€åœ¨çš„drawableçš„densityDpiï¼šæœ€ç»ˆä¼šè®¾ç½®åˆ°BitmapFactory.Options.inDensityä¸Šï¼Œé€šè¿‡å¦‚ä¸‹æ–¹å¼è·å–ï¼š å…³äºè®¾å¤‡çš„dpiå’Œdrawableçš„dpiå¯ä»¥è·Ÿç€æºç çœ‹ä¸‹ï¼š 1 2 3 4 5 6 7 8 9 10 public static Bitmap decodeResource(Resources res, int id, Options opts) { Bitmap bm = null; InputStream is = null; //è·å–å›¾ç‰‡æ‰€åœ¨drawableçš„dpi final TypedValue value = new TypedValue(); is = res.openRawResource(id, value); bm = decodeResourceStream(res, value, is, null, opts); return bm; } ä¸Šé¢é€»è¾‘æ˜¯å¦‚æœæ²¡è·å–åˆ°drawableçš„densityï¼Œé‚£ä¹ˆå°±è®¾ç½®ä¸º160ï¼Œå¦åˆ™ç›´æ¥ç»™Options.inDensityè®¾ç½®ä¸ºdensityã€‚ç„¶åå°†è®¾å¤‡çš„densityè®¾ç½®åˆ°Options.inTargetDensityã€‚\næ¥ç€è°ƒç”¨äº†decodeStreamæ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 @Nullable public static Bitmap decodeStream(@Nullable InputStream is, @Nullable Rect outPadding, @Nullable Options opts) { validate(opts); Bitmap bm = null; try { //å¦‚æœæ˜¯assetç›®å½•ä¸­çš„å›¾ç‰‡ï¼Œåˆ™èµ°if if (is instanceof AssetManager.AssetInputStream) { final long asset = ((AssetManager.AssetInputStream) is).getNativeAsset(); bm = nativeDecodeAsset(asset, outPadding, opts, Options.nativeInBitmap(opts), Options.nativeColorSpace(opts)); } else { //å¦‚æœæ˜¯drawableç›®å½•ä¸‹çš„å›¾ç‰‡ï¼Œåˆ™èµ°è¿™é‡Œ bm = decodeStreamInternal(is, outPadding, opts); } setDensityFromOptions(bm, opts); return bm; } å¯ä»¥çœ‹åˆ°å¦‚æœæ˜¯drawableç›®å½•ä¸‹çš„å›¾ç‰‡ï¼Œåˆ™èµ°decodeStreamInternalï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 private static Bitmap decodeStreamInternal(@NonNull InputStream is, @Nullable Rect outPadding, @Nullable Options opts) { // ASSERT(is != null); byte [] tempStorage = null; if (opts != null) tempStorage = opts.inTempStorage; if (tempStorage == null) tempStorage = new byte[DECODE_BUFFER_SIZE]; return nativeDecodeStream(is, tempStorage, outPadding, opts, Options.nativeInBitmap(opts), Options.nativeColorSpace(opts)); } private static native Bitmap nativeDecodeStream(InputStream is, byte[] storage, Rect padding, Options opts, long inBitmapHandle, long colorSpaceHandle); æœ€ç»ˆä¼šè°ƒç”¨nativeDecodeStreamæ–¹æ³•ï¼Œæ­¤å¤„é€šè¿‡aospæ¥æŸ¥çœ‹æºç ï¼Œè¯¥c++ä»£ç åœ¨/frameworks/base/libs/hwui/jni/BitmapFactory.cppä¸‹ï¼Œæ‰¾åˆ°cppæ–‡ä»¶åï¼Œç„¶åå†çœ‹c++å±‚çš„æ–¹æ³•æ³¨å†Œï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 static const JNINativeMethod gMethods[] = { { \u0026#34;nativeDecodeStream\u0026#34;, \u0026#34;(Ljava/io/InputStream;[BLandroid/graphics/Rect;Landroid/graphics/BitmapFactory$Options;JJ)Landroid/graphics/Bitmap;\u0026#34;, (void*)nativeDecodeStream }, { \u0026#34;nativeDecodeFileDescriptor\u0026#34;, \u0026#34;(Ljava/io/FileDescriptor;Landroid/graphics/Rect;Landroid/graphics/BitmapFactory$Options;JJ)Landroid/graphics/Bitmap;\u0026#34;, (void*)nativeDecodeFileDescriptor }, { \u0026#34;nativeDecodeAsset\u0026#34;, \u0026#34;(JLandroid/graphics/Rect;Landroid/graphics/BitmapFactory$Options;JJ)Landroid/graphics/Bitmap;\u0026#34;, (void*)nativeDecodeAsset }, { \u0026#34;nativeDecodeByteArray\u0026#34;, \u0026#34;([BIILandroid/graphics/BitmapFactory$Options;JJ)Landroid/graphics/Bitmap;\u0026#34;, (void*)nativeDecodeByteArray }, { \u0026#34;nativeIsSeekable\u0026#34;, \u0026#34;(Ljava/io/FileDescriptor;)Z\u0026#34;, (void*)nativeIsSeekable }, }; æ­¤å¤„å¯¹åº”åˆ°ç¬¬ä¸€ä¸ªæ–¹æ³•nativeDecodeStreamï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 static jobject nativeDecodeStream(JNIEnv* env, jobject clazz, jobject is, jbyteArray storage, jobject padding, jobject options, jlong inBitmapHandle, jlong colorSpaceHandle) { jobject bitmap = NULL; std::unique_ptr\u0026lt;SkStream\u0026gt; stream(CreateJavaInputStreamAdaptor(env, is, storage)); if (stream.get()) { std::unique_ptr\u0026lt;SkStreamRewindable\u0026gt; bufferedStream(skia::FrontBufferedStream::Make( std::move(stream), SkCodec::MinBufferedBytesNeeded())); SkASSERT(bufferedStream.get() != NULL); bitmap = doDecode(env, std::move(bufferedStream), padding, options, inBitmapHandle, colorSpaceHandle); } return bitmap; } JNIEnv* env ä½œç”¨\nJNIEnv æ˜¯ JNI ç¯å¢ƒæŒ‡é’ˆï¼Œæä¾›æ‰€æœ‰ JNI å‡½æ•°ï¼ˆå¦‚è°ƒç”¨ Java æ–¹æ³•ã€æ“ä½œ Java å¯¹è±¡ç­‰ï¼‰çš„æ¥å£ã€‚ å®ƒæ˜¯çº¿ç¨‹ç›¸å…³çš„ï¼Œæ¯ä¸ªçº¿ç¨‹çš„ JNIEnv ç‹¬ç«‹ï¼Œä¸å¯è·¨çº¿ç¨‹ä½¿ç”¨ã€‚ å…³é”®åŠŸèƒ½\nè®¿é—® Java å¯¹è±¡ï¼šä¾‹å¦‚é€šè¿‡ GetFieldIDã€GetMethodID è·å–å­—æ®µæˆ–æ–¹æ³•ã€‚ è°ƒç”¨ Java æ–¹æ³•ï¼šä¾‹å¦‚ CallVoidMethodã€CallStaticIntMethodã€‚ å¼‚å¸¸å¤„ç†ï¼šä¾‹å¦‚ ExceptionCheckã€ExceptionDescribeã€‚ å†…å­˜ç®¡ç†ï¼šä¾‹å¦‚ NewStringUTF åˆ›å»ºå­—ç¬¦ä¸²ï¼ŒDeleteLocalRef é‡Šæ”¾å±€éƒ¨å¼•ç”¨ã€‚ jobject clazz ä½œç”¨ å¦‚æœæœ¬åœ°æ–¹æ³•æ˜¯ é™æ€æ–¹æ³•ï¼ˆstaticï¼‰ï¼Œjobject clazz è¡¨ç¤ºè°ƒç”¨è¯¥æ–¹æ³•çš„ Java ç±»å¯¹è±¡ï¼ˆå¯¹åº” Class å¯¹è±¡ï¼‰ã€‚ å¦‚æœæœ¬åœ°æ–¹æ³•æ˜¯ å®ä¾‹æ–¹æ³•ï¼ˆéé™æ€ï¼‰ï¼Œå‚æ•°åº”ä¸º jobject thizï¼Œè¡¨ç¤ºè°ƒç”¨è¯¥æ–¹æ³•çš„ Java å¯¹è±¡å®ä¾‹ã€‚ å¯ä»¥çœ‹åˆ°è°ƒç”¨äº†å¦å¤–ä¸€ä¸ªé™æ€æ–¹æ³•doDecodeï¼š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 static jobject doDecode(JNIEnv* env, std::unique_ptr\u0026lt;SkStreamRewindable\u0026gt; stream, jobject padding, jobject options, jlong inBitmapHandle, jlong colorSpaceHandle) { // Set default values for the options parameters. int sampleSize = 1; bool onlyDecodeSize = false; SkColorType prefColorType = kN32_SkColorType; bool isHardware = false; bool isMutable = false; float scale = 1.0f; bool requireUnpremultiplied = false; jobject javaBitmap = NULL; sk_sp\u0026lt;SkColorSpace\u0026gt; prefColorSpace = GraphicsJNI::getNativeColorSpace(colorSpaceHandle); // Update with options supplied by the client. if (options != NULL) { sampleSize = env-\u0026gt;GetIntField(options, gOptions_sampleSizeFieldID); // Correct a non-positive sampleSize. sampleSize defaults to zero within the // options object, which is strange. if (sampleSize \u0026lt;= 0) { sampleSize = 1; } if (env-\u0026gt;GetBooleanField(options, gOptions_scaledFieldID)) { //è·å–å›¾ç‰‡æ‰€åœ¨æ–‡ä»¶å¤¹çš„density const int density = env-\u0026gt;GetIntField(options, gOptions_densityFieldID); //è·å–å±å¹•æ‰€åœ¨çš„density const int targetDensity = env-\u0026gt;GetIntField(options, gOptions_targetDensityFieldID); const int screenDensity = env-\u0026gt;GetIntField(options, gOptions_screenDensityFieldID); if (density != 0 \u0026amp;\u0026amp; targetDensity != 0 \u0026amp;\u0026amp; density != screenDensity) { //å¾—åˆ°bitmapçš„ç¼©æ”¾æ¯”ä¾‹ scale = (float) targetDensity / density; } } } // Determine the output size. //å¾—åˆ°bitmapçš„å¤§å° SkISize size = codec-\u0026gt;getSampledDimensions(sampleSize); int scaledWidth = size.width(); int scaledHeight = size.height(); bool willScale = false; // Apply a fine scaling step if necessary. if (needsFineScale(codec-\u0026gt;getInfo().dimensions(), size, sampleSize)) { willScale = true; scaledWidth = codec-\u0026gt;getInfo().width() / sampleSize; scaledHeight = codec-\u0026gt;getInfo().height() / sampleSize; } // Scale is necessary due to density differences. //æ ¹æ®å‰é¢ç®—çš„ç¼©æ”¾æ¯”ä¾‹ï¼Œå¾—åˆ°æœ€ç»ˆçš„bitmapå¤§å° if (scale != 1.0f) { willScale = true; scaledWidth = static_cast\u0026lt;int\u0026gt;(scaledWidth * scale + 0.5f); scaledHeight = static_cast\u0026lt;int\u0026gt;(scaledHeight * scale + 0.5f); } //ç®—å‡ºæœ€ç»ˆçš„ç¼©æ”¾æ¯”ä¾‹ const float scaleX = scaledWidth / float(decodingBitmap.width()); const float scaleY = scaledHeight / float(decodingBitmap.height()); SkBitmap outputBitmap; if (willScale) { // Set the allocator for the outputBitmap. SkBitmap::Allocator* outputAllocator; if (javaBitmap != nullptr) { outputAllocator = \u0026amp;recyclingAllocator; } else { //æœ€ç»ˆçš„æ•°æ®åœ¨outputAllocatorä¸­ outputAllocator = \u0026amp;defaultAllocator; } SkColorType scaledColorType = decodingBitmap.colorType(); // FIXME: If the alphaType is kUnpremul and the image has alpha, the // colors may not be correct, since Skia does not yet support drawing // to/from unpremultiplied bitmaps. outputBitmap.setInfo( bitmapInfo.makeWH(scaledWidth, scaledHeight).makeColorType(scaledColorType)); if (!outputBitmap.tryAllocPixels(outputAllocator)) { // This should only fail on OOM. The recyclingAllocator should have // enough memory since we check this before decoding using the // scaleCheckingAllocator. return nullObjectReturn(\u0026#34;allocation failed for scaled bitmap\u0026#34;); } SkPaint paint; // kSrc_Mode instructs us to overwrite the uninitialized pixels in // outputBitmap. Otherwise we would blend by default, which is not // what we want. paint.setBlendMode(SkBlendMode::kSrc); //æœ€ç»ˆè§£ç çš„bitmapåœ¨outputBitmapä¸Š SkCanvas canvas(outputBitmap, SkCanvas::ColorBehavior::kLegacy); //ä½¿ç”¨æœ€ç»ˆçš„ç¼©æ”¾æ¯”ä¾‹ canvas.scale(scaleX, scaleY); decodingBitmap.setImmutable(); // so .asImage() doesn\u0026#39;t make a copy canvas.drawImage(decodingBitmap.asImage(), 0.0f, 0.0f, SkSamplingOptions(SkFilterMode::kLinear), \u0026amp;paint); } Bitmap* heapBitmap = defaultAllocator.getStorageObjAndReset(); if (hasGainmap \u0026amp;\u0026amp; heapBitmap != nullptr) { heapBitmap-\u0026gt;setGainmap(std::move(gainmap)); } uirenderer::logBitmapDecode(*heapBitmap); // now create the java bitmap //åˆ›å»ºbitmap return bitmap::createBitmap(env, heapBitmap, bitmapCreateFlags, ninePatchChunk, ninePatchInsets, -1); } decodeä¸­å°±æ˜¯å…³äºbitmapçš„ç¼©æ”¾å¤„ç†ï¼Œæ ¹æ®optionä¸­çš„targetDensity/densityï¼Œä¹Ÿå°±æ˜¯å±å¹•çš„density/drawableçš„densityå¾—åˆ°scaleï¼Œç„¶åæ ¹æ®åŸå§‹å°ºå¯¸å†ä¹˜ä»¥è¯¥scaleå¾—åˆ°æœ€ç»ˆçš„å®½é«˜åƒç´ ã€‚\nå…³äºåº•å±‚å¦‚ä½•è§£æå›¾ç‰‡çš„è§£ç æ–¹å¼ï¼Œå¯ä»¥æ¥ç€ä¸Šé¢åˆ†æåˆ†æBitmapFactory.cppçš„doDecodeæ—¶å€™è°ƒç”¨çš„ï¼Œåœ¨doDecodeæ—¶å€™æœ‰è¿™ä¹ˆä¸¤å¥ï¼š\n1 2 3 SkColorType prefColorType = kN32_SkColorType; prefColorType = GraphicsJNI::getNativeBitmapColorType(env, jconfig); SkColorType decodeColorType = codec-\u0026gt;computeOutputColorType(prefColorType); é¦–å…ˆé»˜è®¤å®šä¹‰äº†prefColorTypeä¸ºkN32_SkColorTypeï¼Œç„¶åè°ƒç”¨äº†getNativeBitmapColorTypeæ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 SkColorType GraphicsJNI::getNativeBitmapColorType(JNIEnv* env, jobject jconfig) { ALOG_ASSERT(env); if (NULL == jconfig) { return kUnknown_SkColorType; } ALOG_ASSERT(env-\u0026gt;IsInstanceOf(jconfig, gBitmapConfig_class)); //è·å–åˆ°javaå±‚BitmapFactory.Optionsä¸­çš„inPreferredConfigï¼ˆBitmap.Configï¼‰çš„nativeIntå€¼ int c = env-\u0026gt;GetIntField(jconfig, gBitmapConfig_nativeInstanceID); return legacyBitmapConfigToColorType(c); } SkColorType GraphicsJNI::legacyBitmapConfigToColorType(jint legacyConfig) { const uint8_t gConfig2ColorType[] = { kUnknown_SkColorType, kAlpha_8_SkColorType, kUnknown_SkColorType, // Previously kIndex_8_SkColorType, kRGB_565_SkColorType, kARGB_4444_SkColorType, kN32_SkColorType, kRGBA_F16_SkColorType, kN32_SkColorType, kRGBA_1010102_SkColorType, }; if (legacyConfig \u0026lt; 0 || legacyConfig \u0026gt; kLastEnum_LegacyBitmapConfig) { legacyConfig = kNo_LegacyBitmapConfig; } return static_cast\u0026lt;SkColorType\u0026gt;(gConfig2ColorType[legacyConfig]); } åœ¨getNativeBitmapColorTypeæ–¹æ³•ä¸­è·å–åˆ°BitmapFactory.Optionsä¸­çš„inPreferredConfigï¼ˆBitmap.Configï¼‰çš„nativeIntå€¼ï¼Œç„¶åä¼ ç»™äº†legacyBitmapConfigToColorTypeï¼Œåœ¨è¯¥æ–¹æ³•ä¸­è·å–åˆ°å¯¹åº”çš„SkColorTypeï¼Œå…¶å®å°±æ˜¯å°†åœ¨javaå±‚Bitmap.Configæšä¸¾ä¸­å®šä¹‰çš„nativeIntï¼Œæ˜ å°„åˆ°gConfig2ColorTypeæ•°ç»„ä¸­ï¼Œç„¶åå¯¹åº”è·å–åˆ°c++å±‚çš„SkColorTypeæšä¸¾ã€‚å¯¹åº”å…³ç³»å¦‚ä¸‹\njavaå±‚ c++å±‚ ALPHA_8 kAlpha_8_SkColorType RGB_565 kRGB_565_SkColorType ARGB_4444 kARGB_4444_SkColorType ARGB_8888 kN32_SkColorType RGBA_F16 kRGBA_F16_SkColorType HARDWARE kN32_SkColorType RGBA_1010102 kRGBA_1010102_SkColorType è·å–åˆ°SkColorTypeåï¼Œæ¥ç€è°ƒç”¨äº†SkAndroidCodecçš„computeOutputColorTypeæ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 SkColorType SkAndroidCodec::computeOutputColorType(SkColorType requestedColorType) { //å¦‚æœæ¯ä¸ªé¢œè‰²åˆ†é‡çš„ä½æ•°è¶…è¿‡8ä½ï¼Œå°±è®¤ä¸ºæ˜¯é«˜ç²¾åº¦ bool highPrecision = fCodec-\u0026gt;getEncodedInfo().bitsPerComponent() \u0026gt; 8; //ä»ç¼–ç ä¿¡æ¯ä¸­è·å–é¢œè‰²æ·±åº¦ï¼ˆä¾‹å¦‚ 8-bitã€10-bitï¼‰ uint8_t colorDepth = fCodec-\u0026gt;getEncodedInfo().getColorDepth(); switch (requestedColorType) { //å¦‚æœæ˜¯kARGB_4444_SkColorTypeï¼Œç›´æ¥è¿”å›kN32_SkColorTypeï¼ˆARGB_8888ï¼‰ //åŸå› ï¼šARGB_4444 æ ¼å¼å·²è¿‡æ—¶ï¼Œç°ä»£è®¾å¤‡æ›´å€¾å‘ä½¿ç”¨ 32 ä½æ ¼å¼ï¼ˆå…¼å®¹æ€§/æ€§èƒ½ä¼˜åŒ–ï¼‰ã€‚ case kARGB_4444_SkColorType: return kN32_SkColorType; //å¦‚æœæ˜¯kN32_SkColorTypeï¼Œç›´æ¥ä¸å¤„ç† case kN32_SkColorType: break; case kAlpha_8_SkColorType: case kGray_8_SkColorType: //è‹¥å½“å‰å›¾åƒé¢œè‰²ç±»å‹ä¸º kGray_8ï¼Œè¿”å› kGray_8ï¼Œå¦åˆ™è·³è¿‡ //kAlpha_8 æ—§ç‰ˆæœ¬ä¸­å¯èƒ½ç”¨äºç°åº¦å›¾ï¼Œç°éœ€å…¼å®¹æ€§å¤„ç† //ä»…å½“åŸå§‹å›¾åƒä¸ºç°åº¦æ—¶ï¼Œæ‰è¿”å› kGray_8ï¼ˆé¿å…æ— æ•ˆè½¬æ¢ï¼‰ if (kGray_8_SkColorType == this-\u0026gt;getInfo().colorType()) { return kGray_8_SkColorType; } break; case kRGB_565_SkColorType: //è‹¥å›¾åƒä¸é€æ˜ï¼ˆalphaType == kOpaqueï¼‰ï¼Œè¿”å› kRGB_565 //RGB_565 ä¸æ”¯æŒé€æ˜åº¦ï¼Œä»…é€‚ç”¨äºä¸é€æ˜å›¾åƒ if (kOpaque_SkAlphaType == this-\u0026gt;getInfo().alphaType()) { return kRGB_565_SkColorType; } break; case kRGBA_1010102_SkColorType: //è‹¥é¢œè‰²æ·±åº¦ä¸º 10-bitï¼Œè¿”å› kRGBA_1010102ï¼Œé¢œè‰²æ·±åº¦è¡¨ç¤ºæ¯ä¸ªé€šé“å 10ä½ï¼Œå¦‚æœæ˜¯RGBçš„è¯ï¼Œåˆ™æ˜¯30ä½çš„äºŒè¿›åˆ¶ï¼Œå¦‚æœæ˜¯ARGBçš„è¯ï¼Œåˆ™æ˜¯40ä½çš„äºŒè¿›åˆ¶ //10-bit æ·±åº¦åŒ¹é…è¯¥æ ¼å¼çš„é«˜ç²¾åº¦éœ€æ±‚ if (colorDepth == 10) { return kRGBA_1010102_SkColorType; } break; case kRGBA_F16_SkColorType: //å¼ºåˆ¶é«˜ç²¾åº¦æµ®ç‚¹æ ¼å¼ï¼Œæ¯ä¸€ä¸ªé¢œè‰²é€šé“æ˜¯16ä½ï¼Œå¦‚æœæ˜¯RGBçš„è¯ï¼Œåˆ™æ˜¯48ä½çš„äºŒè¿›åˆ¶ return kRGBA_F16_SkColorType; default: break; } //å¦‚æœé«˜è¿›åº¦çš„åˆ™è¿”å›kRGBA_F16_SkColorTypeï¼Œå¦‚æœä½æ·±æ˜¯10çš„è¯ï¼Œåˆ™è¿”å›kRGBA_1010102_SkColorTypeï¼Œå…¶ä½™çš„éƒ½è¿”å›kN32_SkColorType return highPrecision ? kRGBA_F16_SkColorType : (colorDepth == 10 ? kRGBA_1010102_SkColorType : kN32_SkColorType); } è¿™ä¹Ÿå°±è§£é‡Šäº†åœ¨RGB_565è§£ç æ–¹å¼ä¸‹ï¼Œå¦‚æœæ˜¯å¸¦é€æ˜çš„å›¾ç‰‡ï¼Œç›´æ¥ä½¿ç”¨kN32_SkColorTypeçš„è§£ç æ–¹å¼ï¼Œä¹Ÿå°±æ˜¯ARGB_8888ã€‚é»˜è®¤çš„è§£ç æ–¹å¼ï¼Œå¦‚æœæ˜¯ä¸å¸¦é€æ˜çš„å›¾ç‰‡ï¼Œåˆ™ä½¿ç”¨çš„æ˜¯RGB_565ã€‚å¦‚æœä½¿ç”¨çš„æ˜¯ALPHA_8ï¼Œä¸æ˜¯ç°åº¦å›¾åƒçš„æ—¶å€™ï¼Œä½¿ç”¨çš„æ˜¯ARGB_8888ã€‚\nå…³äºdrawableçš„densityDpiçš„å€¼å¦‚ä¸‹ï¼š ç»“è®ºï¼šå›¾ç‰‡æ‰€å å†…å­˜å’Œdrawableçš„densityDpiæˆåæ¯”ã€‚\næ¥æºï¼šhttps://juejin.cn/post/6844904166138069005\nbitmapå†…å­˜åˆ†é…ï¼š 8.0ä¹‹å‰çš„Bitmapåƒç´ æ•°æ®åŸºæœ¬å­˜å‚¨åœ¨Java heap 8.0ä¹‹åçš„ Bitmapåƒç´ æ•°æ®åŸºæœ¬å­˜å‚¨åœ¨native heap å‚è€ƒï¼šhttps://juejin.cn/post/6844903608887017485\nbitmapåƒç´ åˆ†é…ï¼š å‚è€ƒï¼šhttps://juejin.cn/post/6844903715766272013\n","date":"2025-03-11T00:00:00Z","permalink":"http://xiangcman.xyz/p/bitmap%E6%80%BB%E7%BB%93/","title":"bitmapæ€»ç»“"},{"content":"è®¾è®¡åŸåˆ™ å¼€é—­åŸåˆ™ ä¸»è¦æŒ‡å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­ã€‚ç”¨æŠ½è±¡æ„å»ºæ¡†æ¶ï¼Œç”¨å®ç°æ‰©å±•ç»†èŠ‚ã€‚ ä¼˜ç‚¹ï¼šä¿æŒè½¯ä»¶çš„ç¨³å®šæ€§ï¼Œä¸å½±å“åŸæœ‰ä¸šåŠ¡é€»è¾‘ä»£ç ã€‚ä½¿ä»£ç æ›´å…·æœ‰æ¨¡å—åŒ–ï¼Œæ˜“äºç»´æŠ¤ã€‚æé«˜å¼€å‘æ•ˆç‡ã€‚ æ¥æºï¼šhttps://segmentfault.com/a/1190000021922108 é‡Œå¼æ›¿æ¢åŸåˆ™ æ‰€æœ‰å¼•ç”¨åŸºç±»çš„åœ°æ–¹å¿…é¡»èƒ½é€æ˜åœ°ä½¿ç”¨å…¶å­ç±»çš„å¯¹è±¡ åŸåˆ™ï¼šå­ç±»å¿…é¡»å®ç°çˆ¶ç±»çš„æŠ½è±¡æ–¹æ³•ï¼Œä¸å¾—é‡å†™çˆ¶ç±»çš„éæŠ½è±¡æ–¹æ³• å­ç±»å¯ä»¥å¢åŠ è‡ªå·±ç‰¹æœ‰çš„æ–¹æ³• å­ç±»åœ¨å®ç°çˆ¶ç±»çš„æ–¹æ³•çš„æ—¶å€™ï¼Œå½¢å‚è¦æ¯”çˆ¶ç±»çš„å‚æ•°æ›´åŠ å®½æ¾ã€‚ å­ç±»å®ç°çˆ¶ç±»çš„æ–¹æ³•çš„æ—¶å€™ï¼Œå‡ºå‚è¦æ¯”çˆ¶ç±»æ›´åŠ ä¸¥æ ¼ã€‚ ä¾èµ–å€’ç½®åŸåˆ™ é«˜å±‚æ¨¡å—ä¸åº”è¯¥ç›´æ¥ä¾èµ–åº•å±‚æ¨¡å—ï¼ŒäºŒè€…åº”è¯¥ä¾èµ–æŠ½è±¡ï¼ŒæŠ½è±¡ä¸åº”è¯¥ä¾èµ–ç»†èŠ‚ï¼Œç»†èŠ‚åº”è¯¥ä¾èµ–æŠ½è±¡ã€‚ æ¯”å¦‚Aç±»æ˜¯æ¥å£ï¼ŒBç±»æ˜¯å®ç°ï¼Œè€ŒCç±»è¦ä½¿ç”¨Bç±»ï¼Œé‚£ä¹ˆCç±»ä¸èƒ½ç›´æ¥ä½¿ç”¨Bç±»ï¼Œè€Œæ˜¯é€šè¿‡ä¾èµ–Aæ¥å£æ¥å®ç°ï¼Œè¿™æ ·å°†ä½¿ç”¨è°çš„æƒäº¤ç»™äº†å¤–ç•Œã€‚Cç±»æ›´åŠ çš„çµæ´» å•ä¸€èŒä¸šåŸåˆ™ ä¸€ä¸ªç±»æˆ–è€…æ¨¡å—åªè´Ÿè´£å®Œæˆä¸€ä¸ªèŒè´£ã€‚ä¸è¦è®¾è®¡å¤§è€Œå…¨çš„ç±»ï¼Œè¦è®¾è®¡ç²’åº¦å°ã€åŠŸèƒ½å•ä¸€çš„ç±»ã€‚å•ä¸€èŒè´£åŸåˆ™æ˜¯ä¸ºäº†å®ç°ä»£ç é«˜å†…èšã€ä½è€¦åˆï¼Œæé«˜ä»£ç çš„å¤ç”¨æ€§ã€å¯è¯»æ€§ã€å¯ç»´æŠ¤æ€§ã€‚ æ¥å£éš”ç¦»åŸåˆ™ å°½é‡å°†è‡ƒè‚¿åºå¤§çš„æ¥å£æ‹†åˆ†æˆæ›´å°çš„å’Œæ›´å…·ä½“çš„æ¥å£ï¼Œè®©æ¥å£ä¸­åªåŒ…å«å®¢æˆ·æ„Ÿå…´è¶£çš„æ–¹æ³•ã€‚å’Œå•ä¸€èŒè´£åŸåˆ™ç›¸æ¯”ï¼Œä»–ä»¬éƒ½æ˜¯ä¸ºäº†æé«˜ç±»çš„å†…èšæ€§ã€é™ä½å®ƒä»¬ä¹‹é—´çš„è€¦åˆæ€§ï¼Œä½“ç°äº†å°è£…çš„æ€æƒ³ã€‚ä¸¤è€…ä¸åŒåœ¨äºå•ä¸€èŒè´£åŸåˆ™æ³¨é‡çš„æ˜¯èŒè´£ï¼Œè€Œæ¥å£éš”ç¦»åŸåˆ™æ³¨é‡çš„æ˜¯å¯¹æ¥å£ä¾èµ–çš„éš”ç¦»ã€‚å•ä¸€èŒè´£åŸåˆ™ä¸»è¦æ˜¯çº¦æŸç±»ï¼Œå®ƒé’ˆå¯¹çš„æ˜¯ç¨‹åºä¸­çš„å®ç°å’Œç»†èŠ‚ã€‚æ¥å£éš”ç¦»åŸåˆ™ä¸»è¦æ˜¯çº¦æŸæ¥å£ï¼Œä¸»è¦é’ˆå¯¹æŠ½è±¡å’Œç¨‹åºæ•´ä½“æ¡†æ¶çš„æ„å»ºã€‚ è¿ªç±³ç‰¹æ³•åˆ™ å¦‚æœä¸¤ä¸ªè½¯ä»¶å®ä½“æ— é¡»ç›´æ¥é€šä¿¡ï¼Œé‚£ä¹ˆå°±ä¸åº”å½“å‘ç”Ÿç›´æ¥çš„ç›¸äº’è°ƒç”¨ï¼Œå¯ä»¥é€šè¿‡ç¬¬ä¸‰æ–¹è½¬å‘è¯¥è°ƒç”¨ï¼Œç›®çš„æ˜¯é™ä½ç±»ä¹‹é—´çš„è€¦åˆåº¦ï¼Œæé«˜æ¨¡å—çš„ç›¸å¯¹ç‹¬ç«‹æ€§ã€‚ç”±äºäº²åˆåº¦é™ä½ï¼Œä»è€Œæé«˜äº†ç±»çš„å¯å¤ç”¨ç‡å’Œç³»ç»Ÿçš„æ‰©å±•æ€§ã€‚ æ¯”å¦‚Aç±»æƒ³è°ƒç”¨Bç±»ï¼Œä½†æ˜¯ä»–ä»¬åˆæ²¡æœ‰ç›´æ¥è”ç³»ï¼Œè€Œé€šè¿‡ä¸­é—´çš„Cç±»æ¥è°ƒç”¨Bç±»ã€‚A-\u0026gt;C-\u0026gt;Bè¿™ç§è°ƒç”¨å…³ç³» åˆæˆå¤ç”¨åŸåˆ™ è¦æ±‚åœ¨è½¯ä»¶å¤ç”¨æ—¶ï¼Œå°½é‡å…ˆä½¿ç”¨ç»„åˆæˆ–è€…èšåˆç­‰å…³è”å…³ç³»æ¥å®ç°ï¼Œå…¶æ¬¡æ‰è€ƒè™‘ä½¿ç”¨é›†æˆå…³ç³»æ¥å®ç°ã€‚é‡‡ç”¨ç»„åˆæˆ–èšåˆå¤ç”¨æ—¶ï¼Œå¯ä»¥å°†å·²æœ‰å¯¹è±¡çº³å…¥æ–°å¯¹è±¡ä¸­ï¼Œä½¿ä¹‹æˆä¸ºæ–°å¯¹è±¡çš„ä¸€éƒ¨åˆ†ï¼Œä»è€Œæ–°å¯¹è±¡å¯ä»¥è°ƒç”¨å·²æœ‰å¯¹è±¡çš„åŠŸèƒ½ã€‚ ç»´æŒäº†ç±»çš„å°è£…æ€§ï¼Œå› ä¸ºæˆåˆ†å¯¹è±¡çš„å†…éƒ¨ç»†èŠ‚æ˜¯æ–°å¯¹è±¡çœ‹ä¸è§çš„ï¼Œè¿™ç§å¤ç”¨ç§°ä¸ºé»‘ç®±å¤ç”¨ã€‚ æ–°æ—§ç±»ä¹‹é—´çš„è€¦åˆåº¦ä½ï¼Œè¿™ç§å¤ç”¨æ‰€éœ€çš„ä¾èµ–è¾ƒå°‘ï¼Œæ–°å¯¹è±¡å­˜å‚¨æˆåˆ†å¯¹è±¡çš„å”¯ä¸€æ–¹æ³•æ˜¯é€šè¿‡æˆåˆ†å¯¹è±¡çš„æ¥å£ã€‚ å¤ç”¨çš„çµæ´»æ€§é«˜ã€‚è¿™ç§å¤ç”¨å¯ä»¥åœ¨è¿è¡Œæ—¶åŠ¨æ€è¿›è¡Œï¼Œæ–°å¯¹è±¡å¯ä»¥åŠ¨æ€åœ°å¼•ç”¨ä¸æˆåˆ†å¯¹è±¡ç±»å‹ç›¸åŒçš„å¯¹è±¡ã€‚ è®¾è®¡æ¨¡å¼ è®¾è®¡æ¨¡å¼åˆ†ä¸ºåˆ›å»ºå‹ã€ç»“æ„å‹ã€è¡Œä¸ºå‹ã€‚ åˆ›å»ºå‹ï¼šç”¨äºå¯¹è±¡çš„åˆ›å»ºï¼Œæé«˜ä»£ç çš„çµæ´»æ€§å’Œå¤ç”¨æ€§ è®¾è®¡æ¨¡å¼ æè¿° å·¥å‚æ–¹æ³•æ¨¡å¼ï¼ˆFactory Methodï¼‰ é€šè¿‡å·¥å‚ç±»æä¾›ä¸€ä¸ªåˆ›å»ºå¯¹è±¡çš„æ¥å£ï¼Œè€Œä¸æ˜¯ç›´æ¥ new ä¸€ä¸ªå¯¹è±¡ï¼Œæé«˜ä»£ç çš„å¯æ‰©å±•æ€§ã€‚ æŠ½è±¡å·¥å‚æ¨¡å¼ï¼ˆAbstract Factoryï¼‰ æä¾›ä¸€ä¸ªåˆ›å»ºä¸€ç³»åˆ—ç›¸å…³æˆ–ç›¸äº’ä¾èµ–å¯¹è±¡çš„æ¥å£ï¼Œè€Œæ— éœ€æŒ‡å®šå®ƒä»¬çš„å…·ä½“ç±»ã€‚ å•ä¾‹æ¨¡å¼ï¼ˆSingletonï¼‰ ç¡®ä¿ä¸€ä¸ªç±»åªæœ‰ä¸€ä¸ªå®ä¾‹ï¼Œå¹¶æä¾›ä¸€ä¸ªå…¨å±€è®¿é—®ç‚¹ã€‚ å»ºé€ è€…æ¨¡å¼ï¼ˆBuilderï¼‰ ç”¨äºåˆ›å»ºå¤æ‚å¯¹è±¡ï¼Œå°†å¯¹è±¡çš„æ„å»ºä¸è¡¨ç¤ºåˆ†ç¦»ï¼Œä»¥ä¾¿ç›¸åŒçš„æ„å»ºè¿‡ç¨‹å¯ä»¥åˆ›å»ºä¸åŒçš„è¡¨ç¤ºã€‚ åŸå‹æ¨¡å¼ï¼ˆPrototypeï¼‰ é€šè¿‡å¤åˆ¶ï¼ˆå…‹éš†ï¼‰å·²æœ‰çš„å®ä¾‹æ¥åˆ›å»ºæ–°å¯¹è±¡ï¼Œè€Œä¸æ˜¯é€šè¿‡å®ä¾‹åŒ–ã€‚ ç»“æ„å‹æ¨¡å¼ï¼šä¸»è¦ç”¨äºç±»ä¸å¯¹è±¡çš„ç»„åˆï¼Œç¡®ä¿ç³»ç»Ÿçš„ç»“æ„æ›´åŠ çµæ´»å’Œé«˜æ•ˆã€‚ è®¾è®¡æ¨¡å¼ æè¿° é€‚é…å™¨æ¨¡å¼ï¼ˆAdapterï¼‰ è®©åŸæœ¬ä¸å…¼å®¹çš„æ¥å£èƒ½å¤ŸååŒå·¥ä½œï¼Œç›¸å½“äºâ€œè½¬æ¢å™¨â€ã€‚ æ¡¥æ¥æ¨¡å¼ï¼ˆBridgeï¼‰ åˆ†ç¦»æŠ½è±¡éƒ¨åˆ†å’Œå®ç°éƒ¨åˆ†ï¼Œä½¿å®ƒä»¬å¯ä»¥ç‹¬ç«‹å˜åŒ–ï¼Œæé«˜å¯æ‰©å±•æ€§ã€‚ è£…é¥°å™¨æ¨¡å¼ï¼ˆDecoratorï¼‰ é€šè¿‡åŠ¨æ€åœ°ç»™å¯¹è±¡å¢åŠ é¢å¤–çš„åŠŸèƒ½ï¼Œè€Œä¸ä¼šæ”¹å˜å…¶ç»“æ„ï¼ˆç±»ä¼¼äº Java çš„ IO æµï¼‰ã€‚ ç»„åˆæ¨¡å¼ï¼ˆCompositeï¼‰ å…è®¸å°†å¯¹è±¡ç»„åˆæˆæ ‘å½¢ç»“æ„ï¼Œä»¥è¡¨ç¤ºâ€œæ•´ä½“-éƒ¨åˆ†â€å…³ç³»ï¼Œé€‚ç”¨äºæ ‘å½¢ç»“æ„æ•°æ®ã€‚ å¤–è§‚æ¨¡å¼ï¼ˆFacadeï¼‰ æä¾›ä¸€ä¸ªç»Ÿä¸€çš„æ¥å£ï¼Œç”¨äºè®¿é—®å­ç³»ç»Ÿçš„ä¸€ç»„æ¥å£ï¼Œç®€åŒ–å®¢æˆ·ç«¯çš„è°ƒç”¨ã€‚ äº«å…ƒæ¨¡å¼ï¼ˆFlyweightï¼‰ é€šè¿‡å…±äº«å¯¹è±¡ï¼Œå‡å°‘å†…å­˜å ç”¨ï¼Œæé«˜æ€§èƒ½ã€‚ ä»£ç†æ¨¡å¼ï¼ˆProxyï¼‰ é€šè¿‡ä»£ç†å¯¹è±¡æ§åˆ¶å¯¹ç›®æ ‡å¯¹è±¡çš„è®¿é—®ï¼Œä¾‹å¦‚ï¼šé™æ€ä»£ç†ã€åŠ¨æ€ä»£ç†ï¼ˆJDK/CGLIBï¼‰ã€‚ è¡Œä¸ºå‹æ¨¡å¼ï¼šä¸»è¦ç”¨äºå¯¹è±¡ä¹‹é—´çš„é€šä¿¡å’ŒèŒè´£åˆ†é…ï¼Œæé«˜ä»£ç çš„å¯ç»´æŠ¤æ€§å’Œå¯æ‰©å±•æ€§ã€‚ è®¾è®¡æ¨¡å¼ æè¿° ç­–ç•¥æ¨¡å¼ï¼ˆStrategyï¼‰ å®šä¹‰ä¸€ç³»åˆ—ç®—æ³•ï¼Œå°†æ¯ç§ç®—æ³•å°è£…èµ·æ¥ï¼Œå¹¶ä½¿å®ƒä»¬å¯ä»¥äº’æ¢ã€‚ è§‚å¯Ÿè€…æ¨¡å¼ï¼ˆObserverï¼‰ å…è®¸å¯¹è±¡é—´å»ºç«‹ä¸€å¯¹å¤šçš„ä¾èµ–å…³ç³»ï¼Œå½“ä¸€ä¸ªå¯¹è±¡çŠ¶æ€å˜åŒ–æ—¶ï¼Œæ‰€æœ‰ä¾èµ–å®ƒçš„å¯¹è±¡éƒ½ä¼šæ”¶åˆ°é€šçŸ¥ï¼ˆå¦‚ ç›‘å¬å™¨ æœºåˆ¶ï¼‰ã€‚ è´£ä»»é“¾æ¨¡å¼ï¼ˆChain of Responsibilityï¼‰ å°†è¯·æ±‚æ²¿ç€å¤„ç†é“¾ä¼ é€’ï¼Œç›´åˆ°æŸä¸ªå¯¹è±¡å¤„ç†è¯·æ±‚ï¼Œé™ä½è€¦åˆåº¦ï¼ˆå¦‚ Java Web è¿‡æ»¤å™¨ï¼‰ã€‚ å‘½ä»¤æ¨¡å¼ï¼ˆCommandï¼‰ å°†è¯·æ±‚å°è£…ä¸ºå¯¹è±¡ï¼Œæ”¯æŒè¯·æ±‚çš„æ’¤é”€ï¼ˆUndoï¼‰å’Œæ¢å¤ï¼ˆRedoï¼‰ã€‚ å¤‡å¿˜å½•æ¨¡å¼ï¼ˆMementoï¼‰ ä¿å­˜å¯¹è±¡çš„å†å²çŠ¶æ€ï¼Œä»¥ä¾¿ä»¥åæ¢å¤ï¼ˆå¦‚ æ’¤é”€/æ¢å¤ æ“ä½œï¼‰ã€‚ çŠ¶æ€æ¨¡å¼ï¼ˆStateï¼‰ å…è®¸å¯¹è±¡åœ¨ä¸åŒçŠ¶æ€ä¸‹æ”¹å˜è¡Œä¸ºï¼Œé¿å…å¤§é‡ if-else è¯­å¥ã€‚ ä¸­ä»‹è€…æ¨¡å¼ï¼ˆMediatorï¼‰ é€šè¿‡ä¸€ä¸ªä¸­ä»‹å¯¹è±¡æ¥åè°ƒå¤šä¸ªå¯¹è±¡ä¹‹é—´çš„äº¤äº’ï¼Œé¿å…å¯¹è±¡é—´çš„ç›´æ¥é€šä¿¡ã€‚ è¿­ä»£å™¨æ¨¡å¼ï¼ˆIteratorï¼‰ æä¾›ä¸€ç§è®¿é—®é›†åˆå¯¹è±¡å…ƒç´ çš„æ–¹æ³•ï¼Œè€Œä¸æš´éœ²é›†åˆçš„å†…éƒ¨è¡¨ç¤ºã€‚ è®¿é—®è€…æ¨¡å¼ï¼ˆVisitorï¼‰ å…è®¸åœ¨ä¸ä¿®æ”¹å¯¹è±¡ç»“æ„çš„æƒ…å†µä¸‹ï¼Œå‘å¯¹è±¡ç»“æ„ä¸­æ·»åŠ æ–°çš„è¡Œä¸ºï¼ˆå¦‚ XML è§£æï¼‰ã€‚ è§£é‡Šå™¨æ¨¡å¼ï¼ˆInterpreterï¼‰ ç”¨äºå®šä¹‰è¯­è¨€çš„è¯­æ³•è§„åˆ™ï¼Œå¹¶è§£é‡Šç›¸åº”çš„è¡¨è¾¾å¼ï¼ˆå¦‚ SQL è§£æï¼‰ã€‚ å•ä¾‹æ¨¡å¼ é¥¿æ±‰å¼ï¼šç±»åŠ è½½æ—¶æœºå°±å·²ç»æŠŠå•ä¾‹å¯¹è±¡å®ä¾‹åŒ–å‡ºæ¥äº†ï¼Œæ‰€ä»¥ä»–ä¸å­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚ä½†æ˜¯å®ƒä¼šæµªè´¹å†…å­˜ï¼Œåœ¨è¿˜æ²¡ä½¿ç”¨çš„æ—¶å€™ï¼Œå°±å·²ç»åˆ›å»ºäº†å®ä¾‹ã€‚ æ‡’æ±‰å¼ï¼ˆçº¿ç¨‹ä¸å®‰å…¨ï¼‰ åˆ›å»ºå¯¹è±¡çš„æ—¶æœºä¿®æ”¹ä¸ºäº†åœ¨getInstanceå†…éƒ¨ï¼Œéœ€è¦æ—¶å†åˆ›å»ºï¼Œå¯ä»¥èŠ‚çº¦ç³»ç»Ÿèµ„æºã€‚ getInstanceæ–¹æ³•åœ¨å¤šä¸ªçº¿ç¨‹å¹¶å‘è°ƒç”¨æ—¶ï¼Œæœ‰å¯èƒ½ä¼šå‡ºç°åˆ›å»ºäº†å¤šä¸ªå®ä¾‹ï¼Œæ‰€ä»¥è¿™æ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„å•ä¾‹æ¨¡å¼ã€‚ æ‡’æ±‰å¼ï¼ˆçº¿ç¨‹å®‰å…¨ï¼‰ æ–¹æ³•ä¸ŠåŠ é”ï¼Œè¿™ç§åŠ é”èƒ½ä¿è¯çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œä½†æ˜¯åŠ é”çš„ç²’åº¦è¾ƒå¤§ï¼Œæ¯æ¬¡åœ¨è°ƒç”¨getInstanceæ–¹æ³•çš„æ—¶å€™ï¼Œéƒ½éœ€è¦åŠ é”ï¼Œå¾ˆæ˜¾ç„¶ï¼Œé”çš„å¼€é”€å¾ˆå¤§ã€‚ æ‡’æ±‰å¼ï¼ˆçº¿ç¨‹å®‰å…¨-dclæ¨¡å¼ï¼‰ åŒé‡åˆ¤æ–­ï¼Œæˆå‘˜å±æ€§instanceä¸Šï¼Œå¢åŠ äº†volatileå…³é”®å­—ï¼Œä¿éšœå¤šçº¿ç¨‹å¯¹instanceå€¼çš„å¯è§æ€§ä»¥åŠç¦æ­¢æŒ‡ä»¤é‡æ’ã€‚ ç¬¬ä¸€å±‚ç©ºåˆ¤æ–­æ˜¯ä¸ºäº†é”çš„å¼€é”€ï¼Œåªæœ‰ä¸ºç©ºçš„æ—¶å€™æ‰åŠ é”ã€‚ç¬¬äºŒå±‚ç©ºåˆ¤æ–­æ˜¯ä¸ºäº†é˜²æ­¢åˆ›å»ºäº†å¤šä¸ªå®ä¾‹ã€‚ é™æ€å†…éƒ¨ç±»ä¸­åŠ é™æ€å˜é‡ é™æ€å†…éƒ¨ç±»å¯ä»¥è¾¾åˆ°åŒæ£€é”çš„æ•ˆæœã€‚å°†instanceæ”¾åœ¨äº†å†…éƒ¨ç±»ä¸­ï¼Œä¸ä¼šåœ¨ç±»åŠ è½½çš„æ—¶å€™å°±åŠ è½½å®ä¾‹ï¼Œè¿™ä¸ªå’Œé¥¿æ±‰å¼åœ¨ç±»åŠ è½½çš„æ—¶å€™å°±åŠ è½½æœ‰åŒºåˆ«ã€‚ä»–åªä¼šåœ¨getInstanceçš„æ—¶å€™ï¼Œæ‰ä¼šå»åŠ è½½å†…éƒ¨ç±»ï¼Œæ­¤æ—¶æ‰ä¼šå»åŠ è½½å•ä¾‹å®ä¾‹ã€‚å¹¶ä¸”instanceæ˜¯å†…éƒ¨ç±»ç±»åŠ è½½çš„æ—¶å€™æ‰è¿›è¡ŒåŠ è½½ï¼Œæ‰€ä»¥çº¿ç¨‹å®‰å…¨é—®é¢˜ä¹Ÿä¿è¯äº†ã€‚ æšä¸¾å•ä¾‹ è¿™ç§ä¸ä»…èƒ½é¿å…å¤šçº¿ç¨‹åŒæ­¥é—®é¢˜ï¼Œè¿˜è‡ªåŠ¨æ”¯æŒåºåˆ—åŒ–æœºåˆ¶ï¼Œé˜²æ­¢ååºåˆ—åŒ–é‡æ–°åˆ›å»ºæ–°çš„å¯¹è±¡ï¼Œé˜²æ­¢å¤šæ¬¡å®ä¾‹åŒ–ã€‚ åŸå‹æ¨¡å¼ JavaåŸå‹æ¨¡å¼ï¼ˆPrototype Patternï¼‰æ˜¯ä¸€ç§åˆ›å»ºå‹è®¾è®¡æ¨¡å¼ï¼Œå…¶ç›®çš„æ˜¯é€šè¿‡å¤åˆ¶ç°æœ‰å¯¹è±¡æ¥åˆ›å»ºæ–°çš„å¯¹è±¡ã€‚ ä½¿ç”¨åœºæ™¯ï¼š å½“å¯¹è±¡åˆ›å»ºçš„è¿‡ç¨‹æ¯”è¾ƒè€—æ—¶æˆ–è€…æ¯”è¾ƒå¤æ‚ï¼Œä¾‹å¦‚éœ€è¦è¿›è¡Œå¤æ‚çš„è®¡ç®—æˆ–è€…æ¶‰åŠåˆ°ç½‘ç»œè¯·æ±‚ç­‰æ“ä½œï¼Œå¯ä»¥ä½¿ç”¨åŸå‹æ¨¡å¼æ¥é¿å…é‡å¤çš„åˆå§‹åŒ–è¿‡ç¨‹ã€‚ å½“éœ€è¦åˆ›å»ºçš„å¯¹è±¡éœ€è¦å’Œå…¶ä»–å¯¹è±¡è¿›è¡ŒååŒå·¥ä½œæ—¶ï¼Œä¾‹å¦‚éœ€è¦åˆ›å»ºä¸€ä¸ªåŒ…å«å¤šä¸ªå¯¹è±¡çš„ç»„åˆå¯¹è±¡ï¼Œå¯ä»¥ä½¿ç”¨åŸå‹æ¨¡å¼æ¥å¤åˆ¶ä¸€ä¸ªå·²æœ‰çš„ç»„åˆå¯¹è±¡ï¼Œç„¶åè¿›è¡Œä¿®æ”¹æ¥åˆ›å»ºæ–°çš„ç»„åˆå¯¹è±¡ã€‚ å½“éœ€è¦åŠ¨æ€åœ°å¢åŠ æˆ–è€…åˆ é™¤ä¸€äº›å¯¹è±¡æ—¶ï¼Œå¯ä»¥ä½¿ç”¨åŸå‹æ¨¡å¼æ¥å¤åˆ¶ä¸€ä¸ªå·²æœ‰çš„å¯¹è±¡ï¼Œç„¶åè¿›è¡Œä¿®æ”¹æ¥åˆ›å»ºæ–°çš„å¯¹è±¡ã€‚ å½“éœ€è¦ä¿æŠ¤å¯¹è±¡çš„å¤æ‚çŠ¶æ€æ—¶ï¼Œä¾‹å¦‚å½“ä¸€ä¸ªå¯¹è±¡çš„åˆ›å»ºéœ€è¦å¤§é‡çš„æ•°æ®åˆå§‹åŒ–æ—¶ï¼Œå¯ä»¥ä½¿ç”¨åŸå‹æ¨¡å¼æ¥ä¿æŠ¤è¿™äº›æ•°æ®ï¼Œé¿å…å› ä¸ºå¯¹è±¡çš„å¤åˆ¶è€Œäº§ç”Ÿæ„å¤–çš„å‰¯ä½œç”¨ã€‚ ä»£ç å®ç°ï¼š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 // å®šä¹‰ä¸€ä¸ªåŸå‹æ¥å£ interface Prototype { public Prototype clone(); } // å…·ä½“çš„åŸå‹ç±» class ConcretePrototype implements Prototype { public Prototype clone() { return new ConcretePrototype(); } } // å®¢æˆ·ç«¯ä»£ç  class Client { public static void main(String[] args) { Prototype prototype = new ConcretePrototype(); Prototype clone = prototype.clone(); } } ä½¿ç”¨å°ç»“ï¼š Javaä¸­çš„Objectç±»å®ç°äº†Cloneableæ¥å£ï¼Œè¿™å°±æ„å‘³ç€Javaä¸­çš„ä»»ä½•å¯¹è±¡éƒ½å¯ä»¥å®ç°åŸå‹æ¨¡å¼ã€‚é€šè¿‡å®ç°Cloneableæ¥å£ï¼Œå¹¶é‡å†™Objectç±»ä¸­çš„clone()æ–¹æ³•ï¼Œå¯ä»¥å®ç°åŸå‹æ¨¡å¼ã€‚ä¾‹å¦‚ ArrayListã€HashMap ç­‰é›†åˆç±»éƒ½å®ç°äº†Cloneable æ¥å£ï¼Œå¯ä»¥é€šè¿‡å¤åˆ¶ç°æœ‰å¯¹è±¡æ¥åˆ›å»ºæ–°çš„å¯¹è±¡ã€‚ Javaä¸­çš„çº¿ç¨‹æ± ä¹Ÿæ˜¯ä½¿ç”¨äº†åŸå‹æ¨¡å¼ï¼Œçº¿ç¨‹æ± ä¸­çš„æ¯ä¸ªçº¿ç¨‹éƒ½æ˜¯ä»åŸå‹çº¿ç¨‹ä¸­å¤åˆ¶è€Œæ¥ï¼Œè€Œä¸æ˜¯æ¯æ¬¡åˆ›å»ºæ–°çš„çº¿ç¨‹ã€‚ å·¥å‚æ¨¡å¼ åˆ†ä¸ºç®€å•å·¥å‚æ¨¡å¼ã€å·¥å‚æ–¹æ³•æ¨¡å¼ã€æŠ½è±¡å·¥å‚æ¨¡å¼ã€‚å®šä¹‰ä¸€ä¸ªåˆ›å»ºäº§å“å¯¹è±¡çš„å·¥å‚æ¥å£ï¼Œå°†äº§å“å¯¹è±¡çš„å®é™…åˆ›å»ºå·¥ä½œæ¨è¿Ÿåˆ°å…·ä½“å­å·¥å‚ç±»å½“ä¸­ã€‚è¿™æ»¡è¶³åˆ›å»ºå‹æ¨¡å¼ä¸­æ‰€è¦æ±‚çš„åˆ›å»ºä¸ä½¿ç”¨ç›¸åˆ†ç¦»ã€‚åˆ›å»ºå‹æ¨¡å¼å¯ä»¥é™ä½ç³»ç»Ÿçš„è€¦åˆåº¦ï¼Œä½¿ç”¨è€…ä¸éœ€è¦å…³æ³¨å¯¹è±¡çš„åˆ›å»ºç»†èŠ‚ï¼Œå¯¹è±¡çš„åˆ›å»ºç”±ç›¸å…³çš„å·¥å‚æ¥å®Œæˆã€‚\nç®€å•å·¥å‚æ¨¡å¼ ç®€å•å·¥å‚ç±»ä¼šå¾ˆåºå¤§ï¼Œè´Ÿè´£åˆ›å»ºæ‰€æœ‰äº§å“çš„åˆ›å»ºï¼Œå¦‚æœè¦æ–°å¢äº§å“ç±»ï¼Œä¼šä¿®æ”¹å·¥å‚ç±»ï¼Œè¿èƒŒäº†å¼€é—­åŸåˆ™ã€‚å¹¶ä¸”è¿èƒŒäº†é«˜èšåˆåŸåˆ™ã€‚ å·¥å‚æ–¹æ³•æ¨¡å¼\nåœ¨ç®€å•å·¥å‚ç±»åŸºç¡€ä¸Šå°†å·¥å‚ç±»ä¹Ÿè¿›è¡ŒæŠ½è±¡åŒ–ï¼Œæ¯ä¸ªå·¥å‚ç±»åªåšä¸€ä»¶äº‹ï¼Œé‚£å°±æ˜¯ç”Ÿäº§å¯¹åº”çš„å¯¹è±¡ï¼Œä¿è¯äº†å•ä¸€èŒè´£åŸåˆ™ï¼Œå¹¶ä¸”ä¿è¯äº†å¼€é—­åŸåˆ™ï¼Œå¦‚æœè¦ç”Ÿäº§ä¸åŒçš„å¯¹è±¡ï¼Œåªéœ€è¦æä¾›å¯¹åº”çš„å·¥å‚å®ç°ç±»å°±å¯ä»¥ã€‚ æŠ½è±¡å·¥å‚æ¨¡å¼\nå’Œä¸Šé¢çš„å·¥å‚æ–¹æ³•æ¨¡å¼å·®ä¸å¤šï¼Œä¹Ÿæ˜¯æœ‰å¯¹åº”çš„å·¥å‚å®ç°ç±»ï¼ŒåŒºåˆ«æ˜¯å·¥å‚ç±»èƒ½ç”Ÿäº§ä¸åŒçº§åˆ«çš„äº§å“ã€‚ å»ºé€ è€…æ¨¡å¼ å°†ä¸€ä¸ªå¤æ‚å¯¹è±¡çš„æ„å»ºä¸å®ƒçš„è¡¨ç¤ºåˆ†ç¦»ï¼Œä½¿åŒæ ·çš„æ„å»ºè¿‡ç¨‹å¯ä»¥åˆ›å»ºä¸åŒçš„è¡¨ç¤ºã€‚å°†ä¸€ä¸ªå¤æ‚å¯¹è±¡è¿›è¡Œä¸€æ­¥æ­¥çš„æ„å»ºè€Œæˆï¼Œæ‰©å±•æ€§å¥½ï¼Œå¯ä»¥çµæ´»é…ç½®çš„å±æ€§ï¼Œæ¥ç”Ÿæˆä¸åŒçš„å¯¹è±¡ã€‚ æ„å»ºæŒ‡çš„æ˜¯å¯¹è±¡çš„åˆ›å»ºè¿‡ç¨‹ï¼Œé€šè¿‡ä¸€æ­¥æ­¥ç»„è£…çš„å½¢å¼æœ€ç»ˆåˆ›å»ºå¯¹è±¡ï¼Œè€Œå®¢æˆ·ç«¯åœ¨æ­¤è¿‡ç¨‹ä¸­åªéœ€è¦æä¾›ç»„è£…çš„å±æ€§ï¼Œè€Œæ— éœ€å…³å¿ƒç»„è£…çš„è¿‡ç¨‹ è¡¨ç¤ºæŒ‡çš„æ˜¯å¯¹è±¡åˆ›å»ºå®Œåçš„å½¢æ€æˆ–ç»“æ„ï¼Œåˆ›å»ºå®Œåï¼Œå¯¹è±¡å°±å½¢æˆä¸å¯å˜çš„ç»“æ„ã€‚æ­¤æ—¶å®¢æˆ·ç«¯å¯ä»¥æ”¾å¿ƒä½¿ç”¨è¯¥å¯¹è±¡ã€‚ é™æ€ä»£ç†æ¨¡å¼ ç”±äºæŸäº›åŸå› éœ€è¦ç»™æŸå¯¹è±¡æä¾›ä¸€ä¸ªä»£ç†ä»¥æ§åˆ¶å¯¹è¯¥å¯¹è±¡çš„è®¿é—®ã€‚è¿™æ—¶ï¼Œè®¿é—®å¯¹è±¡ä¸é€‚åˆæˆ–è€…ä¸èƒ½ç›´æ¥å¼•ç”¨ç›®æ ‡å¯¹è±¡ï¼Œä»£ç†å¯¹è±¡ä½œä¸ºè®¿é—®å¯¹è±¡å’Œç›®æ ‡å¯¹è±¡ä¹‹é—´çš„ä¸­ä»‹ã€‚ ä»£ç†æ¨¡å¼åœ¨å®¢æˆ·ç«¯ä¸ç›®æ ‡å¯¹è±¡ä¹‹é—´èµ·åˆ°ä¸€ä¸ªä¸­ä»‹ä½œç”¨å’Œä¿æŠ¤ç›®æ ‡å¯¹è±¡çš„ä½œç”¨ã€‚ ä»£ç†å¯¹è±¡å¯ä»¥æ‰©å±•ç›®æ ‡å¯¹è±¡çš„åŠŸèƒ½ å…¶ä¸­é™æ€ä»£ç†è¦æ±‚ä»£ç†ç±»å’Œè¢«ä»£ç†ç±»å®ç°åŒæ ·çš„æ¥å£ï¼Œæ—¨åœ¨æƒ³æ‰©å±•è¢«ä»£ç†ç±»çš„æŸäº›åŠŸèƒ½ï¼Œæ¯”å¦‚æƒ³æ·»åŠ äº›æ—¥å¿—ç­‰è¡Œä¸º åŠ¨æ€ä»£ç†æ¨¡å¼ åŠ¨æ€ä»£ç†æ¨¡å¼å’Œé™æ€ä»£ç†æ¨¡å¼çš„åŒºåˆ«æ˜¯ï¼Œé™æ€ä»£ç†åœ¨ç¼–è¯‘æœŸå°±å·²ç»ç¡®å®šäº†ä»£ç†ç±»å’Œè¢«ä»£ç†ç±»çš„å…³ç³»ï¼Œè€ŒåŠ¨æ€ä»£ç†æ˜¯åœ¨è¿è¡Œæ—¶é€šè¿‡Proxyåˆ›å»ºäº†ä»£ç†ç±»ï¼Œåœ¨ä»£ç†ç±»ä¸­é€šè¿‡åå°„åŠ¨æ€è°ƒç”¨äº†InvokeHandleræ¥å£çš„å®ç°ç±»çš„invokeæ–¹æ³•ï¼Œæœ€ååœ¨invokeä¸­ç»Ÿä¸€è°ƒç”¨è¢«ä»£ç†ç±»çš„æ–¹æ³•ã€‚\næ€»ç»“ï¼š ä»£ç†æ¨¡å¼ä¸»è¦æ˜¯é€šè¿‡ä»£ç†ç±»æ¥æ§åˆ¶å¯¹è±¡çš„è®¿é—®ï¼Œä¸»è¦æ¶‰åŠåˆ°è®¿é—®æƒé™ã€å»¶è¿ŸåŠ è½½ã€æ—¥å¿—è®°å½•ã€‚æ¯”å¦‚æœ‰ä¸€ä¸ªç”¨æˆ·è§’è‰²æƒé™æ¯”è¾ƒä½ï¼Œä¸èƒ½è®¿é—®æ•°æ®åº“ï¼Œæ­¤æ—¶åœ¨è°ƒç”¨å¯¹è±¡çš„æ—¶å€™ï¼Œåˆ¤æ–­æƒé™è€ŒæŠ›å¼‚å¸¸ã€‚å†è€…æ¯”å¦‚åœ¨ä»£ç†ç±»ä¸­ï¼Œå¯ä»¥å»¶è¿Ÿåˆå§‹åŒ–è¢«ä»£ç†ç±»ã€‚å†æ¯”å¦‚å¯ä»¥é€šè¿‡æ—¥å¿—è®°å½•è¢«ä»£ç†ç±»çš„è®¿é—®ã€‚\né€‚é…å™¨æ¨¡å¼ å°†ä¸€ä¸ªç±»çš„æ¥å£è½¬æ¢æˆå®¢æˆ·å¸Œæœ›çš„å¦å¤–ä¸€ä¸ªæ¥å£ï¼Œä½¿å¾—åŸæœ¬æ˜¯ç”±äºæ¥å£ä¸å…¼å®¹è€Œä¸èƒ½ä¸€èµ·å·¥ä½œçš„é‚£äº›ç±»èƒ½ä¸€èµ·å·¥ä½œã€‚é€‚é…å™¨æ¨¡å¼åˆ†ä¸ºç±»ç»“æ„å‹æ¨¡å¼å’Œå¯¹è±¡ç»“æ„å‹æ¨¡å¼ã€‚ç±»ç»“æ„å‹æ¨¡å¼çš„è€¦åˆåº¦æ¯”åè€…é«˜ã€‚ ä¼˜ç‚¹ï¼šå®¢æˆ·ç«¯é€šè¿‡é€‚é…å™¨å¯ä»¥é€æ˜åœ°è°ƒç”¨ç›®æ ‡æ¥å£ï¼Œå¤ç”¨äº†ç°å­˜çš„ç±»ï¼Œç¨‹åºå‘˜ä¸éœ€è¦ä¿®æ”¹åŸæœ‰ä»£ç è€Œé‡ç”¨ç°æœ‰çš„é€‚é…è€…ç±»ã€‚å°†ç›®æ ‡ç±»å’Œé€‚é…è€…ç±»è§£è€¦ï¼Œè§£å†³äº†ç›®æ ‡ç±»å’Œé€‚é…è€…ç±»æ¥å£ä¸ä¸€è‡´çš„é—®é¢˜ã€‚ è§’è‰²ï¼šç›®æ ‡ç±»ï¼Œå®ƒæ˜¯çœŸæ­£è¢«è°ƒç”¨çš„ç±»ï¼›é€‚é…è€…ç±»ï¼Œå®ƒæ˜¯è¢«è®¿é—®å’Œé€‚é…çš„ç°å­˜ç»„ä»¶åº“ä¸­çš„ç»„ä»¶æ¥å£ï¼›é€‚é…å™¨ç±»ï¼šå®ƒæ˜¯ä¸€ä¸ªè½¬æ¢å™¨ï¼ŒæŠŠé€‚é…è€…æ¥å£è½¬æ¢æˆç›®æ ‡æ¥å£ï¼Œè®©å®¢æˆ·èƒ½é€šè¿‡é€‚é…è€…è°ƒç”¨ç›®æ ‡æ¥å£ã€‚ ç±»é€‚é…å™¨æ¨¡å¼ï¼š åœ¨ä¸Šé¢Adapteeæ˜¯ä¸šåŠ¡è¦è¢«é€‚é…çš„ç±»ï¼Œé€‚é…å™¨ç±»ClassAdapteré€šè¿‡ç»§æ‰¿è‡ªAdapteeå’Œè¢«é€‚é…å™¨ç±»è€¦åˆï¼Œä¸æ–¹ä¾¿æ‰©å±•ï¼Œæœ€å¥½çš„æ–¹æ¡ˆæ˜¯å°†è¢«é€‚é…å™¨ç±»äº¤ç»™è°ƒç”¨æ–¹è‡ªå·±ä¼ è¿›æ¥ã€‚ å¯¹è±¡é€‚é…å™¨æ¨¡å¼ï¼š ä»è¿™é‡Œå¯ä»¥çœ‹å‡ºï¼Œå¯¹è±¡é€‚é…æ¨¡å¼æ›´åŠ çš„ç¬¦åˆå¼€é—­åŸåˆ™ï¼Œå¹¶ä¸”æ›´åŠ å®¹æ˜“æ‰©å±•ã€‚ æ¡¥æ¥æ¨¡å¼ å¼ºè°ƒçš„æ˜¯æŠ½è±¡ä¸å®ç°åˆ†ç¦»ï¼Œä½¿å®ƒä»¬å¯ä»¥ç‹¬ç«‹å˜åŒ–ã€‚ä½¿ç”¨ç»„åˆå…³ç³»ä»£æ›¿ç»§æ‰¿å…³ç³»æ¥å®ç°ã€‚é™ä½äº†æŠ½è±¡å’Œå®ç°ä¸¤ä¸ªå¯å˜ç»´åº¦çš„è€¦åˆåº¦ã€‚å’Œä¸Šé¢é€‚é…å™¨æ¨¡å¼ä¸åŒï¼Œè¿™é‡Œå¼ºè°ƒçš„æ˜¯å¤šç§æŠ½è±¡çš„ç»„åˆã€‚å®ƒæ˜¯æœ‰ä»¥ä¸‹è§’è‰²ï¼š æŠ½è±¡åŒ–è§’è‰²ï¼šå®šä¹‰æŠ½è±¡ç±»ï¼Œå¹¶åŒ…å«ä¸€ä¸ªå¯¹å®ç°åŒ–å¯¹è±¡çš„å¼•ç”¨ã€‚ æ‰©å±•æŠ½è±¡åŒ–è§’è‰²ï¼šæ˜¯æŠ½è±¡åŒ–è§’è‰²çš„å­ç±»ï¼Œå®ç°çˆ¶ç±»ä¸­çš„ä¸šåŠ¡æ–¹æ³•ï¼Œå¹¶é€šè¿‡ç»„åˆå…³ç³»è°ƒç”¨å®ç°åŒ–è§’è‰²ä¸­çš„ä¸šåŠ¡æ–¹æ³•ã€‚ å®ç°åŒ–è§’è‰²ï¼šå®šä¹‰å®ç°åŒ–è§’è‰²çš„æ¥å£ï¼Œä¾›æ‰©å±•æŠ½è±¡åŒ–è§’è‰²è°ƒç”¨ã€‚ å…·ä½“å®ç°åŒ–è§’è‰²ï¼šç»™å‡ºå®ç°åŒ–è§’è‰²æ¥å£çš„å…·ä½“å®ç°ã€‚ å®ç°åŒ–è§’è‰²åœ¨è¿™é‡Œæ˜¯ä¾é™„äºæŠ½è±¡åŒ–è§’è‰²ä¸Šçš„ï¼Œä¹Ÿå°±æ˜¯æœ€ç»ˆæ˜¯è¢«æ‰©å±•åŒ–è§’è‰²æ‰€ä½¿ç”¨ã€‚ ä¸Šé¢çš„coloræ˜¯ä¸€ä¸ªå®ç°åŒ–è§’è‰²ï¼Œå…¶ä¸­å…·ä½“å®ç°åŒ–è§’è‰²åˆ†ä¸ºçº¢è‰²å’Œé»„è‰²ã€‚æŠ½è±¡åŒ–è§’è‰²æ˜¯Bagç±»ï¼Œå®ƒçš„æ‰©å±•æŠ½è±¡åŒ–è§’è‰²æœ‰Walletå’ŒHandBagã€‚ä»–ä»¬ä½¿ç”¨äº†colorè¿™ä¸ªå®ç°åŒ–è§’è‰²ã€‚ è£…é¥°è€…æ¨¡å¼ åœ¨ä¸æ”¹å˜ç°æœ‰å¯¹è±¡ç»“æ„çš„æƒ…å†µä¸‹ï¼ŒåŠ¨æ€åœ°ç»™è¯¥å¯¹è±¡å¢åŠ ä¸€äº›èŒè´£ï¼ˆå³å¢åŠ å…¶é¢å¤–åŠŸèƒ½ï¼‰çš„æ¨¡å¼ã€‚ æœ‰ä»¥ä¸‹è§’è‰²ï¼š æŠ½è±¡æ„ä»¶è§’è‰²ï¼šå®šä¹‰ä¸€ä¸ªæŠ½è±¡æ¥å£ä»¥è§„èŒƒå‡†å¤‡æ¥æ”¶é™„åŠ è´£ä»»çš„å¯¹è±¡ã€‚ å…·ä½“æ„ä»¶è§’è‰²ï¼šå®ç°æŠ½è±¡æ„ä»¶ï¼Œé€šè¿‡è£…é¥°è§’è‰²ä¸ºå…¶æ·»åŠ ä¸€äº›èŒè´£ã€‚ æŠ½è±¡è£…é¥°è§’è‰²ï¼šç»§æ‰¿æŠ½è±¡æ„ä»¶ï¼Œå¹¶åŒ…å«å…·ä½“æ„ä»¶çš„å®ä¾‹ï¼Œå¯ä»¥é€šè¿‡å…¶å­ç±»æ‰©å±•å…·ä½“æ„ä»¶çš„åŠŸèƒ½ã€‚ å…·ä½“è£…é¥°è§’è‰²ï¼šå®ç°æŠ½è±¡è£…é¥°çš„ç›¸å…³æ–¹æ³•ï¼Œå¹¶ç»™å…·ä½“æ„ä»¶å¯¹è±¡æ·»åŠ é™„åŠ çš„è´£ä»»ã€‚ ä¸Šé¢ConcreteDecoratoræ˜¯å…·ä½“çš„çš„è£…é¥°è§’è‰²ï¼Œå®ƒæ˜¯æŒæœ‰äº†å…·ä½“çš„æ„ä»¶è§’è‰²ConcreteComponentï¼Œåœ¨è°ƒç”¨å…·ä½“çš„æ„å»ºè§’è‰²æ–¹æ³•å¤–ï¼Œè¿˜è°ƒç”¨äº†è‡ªå·±çš„å¦å¤–ä¸€ä¸ªæ–¹æ³•ï¼Œè¿™ä¸ªæ˜¯å’Œæ¡¥æ¥æ¨¡å¼çš„ä¸€ä¸ªåŒºåˆ«ä¹‹å¤„ã€‚å¹¶ä¸”è£…é¥°è€…æ¨¡å¼çš„æŠ½è±¡çš„è£…é¥°è§’è‰²å®ç°äº†æŠ½è±¡æ„ä»¶è§’è‰²ï¼Œä½†æ˜¯æ¡¥æ¥æ¨¡å¼ä¸­ï¼ŒæŠ½è±¡åŒ–æ„ä»¶è§’è‰²ä¸­æ˜¯ä¸å®ç°å®ç°åŒ–è§’è‰²æ¥å£çš„ã€‚ å¤–è§‚æ¨¡å¼ æ˜¯è¿ªç±³ç‰¹æ³•åˆ™çš„ä½“ç°ï¼Œæ¯”å¦‚ä¸€ä¸ªç³»ç»Ÿæƒ³è°ƒç”¨å­ç³»ç»Ÿçš„æŸä¸ªæ–¹æ³•çš„æ—¶å€™ï¼Œä¸ºäº†é™ä½å®¢æˆ·ç«¯è°ƒç”¨ç³»ç»Ÿçš„æ—¶å€™ï¼Œå°†è°ƒç”¨å­ç³»ç»Ÿçš„æ–¹æ³•ï¼Œé€šè¿‡ç»Ÿä¸€çš„ä¸­å¿ƒæ¥è°ƒç”¨å­ç³»ç»Ÿã€‚åˆ†ä¸ºä»¥ä¸‹è§’è‰²ï¼š äº«å…ƒæ¨¡å¼ ç›¸åŒå¯¹è±¡åªè¦ä¿å­˜ä¸€ä»½ï¼Œè¿™é™ä½äº†ç³»ç»Ÿä¸­å¯¹è±¡çš„æ•°é‡ï¼Œä»è€Œé™ä½äº†ç³»ç»Ÿä¸­ç»†ç²’åº¦å¯¹è±¡ç»™å†…å­˜å¸¦æ¥çš„å‹åŠ›ã€‚ å…·ä½“æœ‰å¦‚ä¸‹è§’è‰²ï¼š æŠ½è±¡äº«å…ƒè§’è‰²ï¼šæ˜¯æ‰€æœ‰çš„å…·ä½“äº«å…ƒç±»çš„åŸºç±»ï¼Œä¸ºå…·ä½“äº«å…ƒè§„èŒƒéœ€è¦å®ç°çš„å…¬å…±æ¥å£ï¼Œéäº«å…ƒçš„å¤–éƒ¨çŠ¶æ€ä»¥å‚æ•°çš„å½¢å¼é€šè¿‡æ–¹æ³•ä¼ å…¥ã€‚ å…·ä½“äº«å…ƒè§’è‰²ï¼šå®ç°æŠ½è±¡äº«å…ƒè§’è‰²ä¸­æ‰€è§„å®šçš„æ¥å£ã€‚ éäº«å…ƒè§’è‰²ï¼šæ˜¯ä¸å¯ä»¥å…±äº«çš„å¤–éƒ¨çŠ¶æ€ï¼Œå®ƒä»¥å‚æ•°çš„å½¢å¼æ³¨å…¥å…·ä½“äº«å…ƒçš„ç›¸å…³æ–¹æ³•ä¸­ã€‚ äº«å…ƒå·¥å‚è§’è‰²ï¼šè´Ÿè´£åˆ›å»ºå’Œç®¡ç†äº«å…ƒè§’è‰²ã€‚å½“å®¢æˆ·å¯¹è±¡è¯·æ±‚ä¸€ä¸ªäº«å…ƒå¯¹è±¡æ—¶ï¼Œäº«å…ƒå·¥å‚æ£€æŸ»ç³»ç»Ÿä¸­æ˜¯å¦å­˜åœ¨ç¬¦åˆè¦æ±‚çš„äº«å…ƒå¯¹è±¡ï¼Œå¦‚æœå­˜åœ¨åˆ™æä¾›ç»™å®¢æˆ·ï¼›å¦‚æœä¸å­˜åœ¨çš„è¯ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„äº«å…ƒå¯¹è±¡ã€‚ ä¸Šé¢äº«å…ƒå·¥å‚é€šè¿‡keyæ¥ç®¡ç†ä¸åŒçš„äº«å…ƒè§’è‰²ï¼Œè€Œäº«å…ƒè§’è‰²æŒæœ‰äº†éäº«å…ƒè§’è‰²çš„æ¥å£å¼•ç”¨ã€‚ä¸Šé¢ä¾‹å­ä¸­å‰3æ¬¡è·å–çš„æ˜¯åŒä¸€ä¸ªäº«å…ƒè§’è‰²ï¼Œåä¸¤æ¬¡è·å–çš„æ˜¯åŒä¸€ä¸ªäº«å…ƒè§’è‰²ã€‚ å‚è€ƒï¼š Javaå¸¸ç”¨è®¾è®¡æ¨¡å¼(ä¸€) Javaå¸¸ç”¨è®¾è®¡æ¨¡å¼(äºŒ) Javaå¸¸ç”¨è®¾è®¡æ¨¡å¼(ä¸‰) ","date":"2025-03-07T00:00:00Z","permalink":"http://xiangcman.xyz/p/java%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99%E4%B8%8E%E6%A8%A1%E5%BC%8F/","title":"javaè®¾è®¡åŸåˆ™ä¸æ¨¡å¼"},{"content":"åœ¨çœ‹boosterå†…è”Rçš„æ—¶å€™ï¼Œçœ‹åˆ°è¿‡æ»¤R$colorè¿™ç§å†…éƒ¨ç±»çš„æ—¶å€™ï¼Œæ˜¯é€šè¿‡æ­£åˆ™è¡¨è¾¾å¼è¿›è¡Œè¿‡æ»¤çš„ï¼Œç„¶åå®ƒçš„åŒ¹é…è§„åˆ™æ˜¯ï¼š\n1 2 internal const val R_REGEX = \u0026#34;.*/R\\\\\\$.*|.*/R\\\\.*\u0026#34; Pattern.matches(R_REGEX, klass.name) æˆ‘æ˜¯æƒ³åŒ¹é…åˆ°com/xc/lib/R$coloræˆ–com/xc/lib/Rå½¢å¦‚è¿™ç§classçš„åå­—ï¼Œç¬¬ä¸€çœ¼çœ‹çš„æ—¶å€™æœ‰ç‚¹æ‡µï¼Œç„¶åé€šè¿‡æŸ¥çœ‹æ­£åˆ™è¡¨è¾¾å¼çš„è¯­æ³•æ—¶å€™ï¼Œå‘ç°æ­£åˆ™æ˜¯æœ‰è§„å¾‹å¯å¾ªçš„ï¼Œå…ˆçœ‹ä¸€å¼ è¡¨æ ¼ï¼š\nç¬¦å· å«ä¹‰ ç¤ºä¾‹ . åŒ¹é…ä»»æ„å•ä¸ªå­—ç¬¦ï¼ˆé™¤æ¢è¡Œç¬¦ï¼‰ a.b å¯åŒ¹é… acbã€a1b \\d æ•°å­— (0-9) \\d{3} åŒ¹é… 123 \\D åŒ¹é…éæ•°å­— \\d\\D å¯ä»¥åŒ¹é…9a / 3# / 0Fç­‰ \\w å•è¯å­—ç¬¦ (a-z, A-Z, 0-9, _)ï¼ŒåŒ¹é…å•è¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ \\w+ åŒ¹é… abc_123 \\W åŒ¹é…éå­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ b\\Wt å¯ä»¥åŒ¹é…b#t / b@tç­‰ï¼Œä½†ä¸èƒ½åŒ¹é…but / b1t / b_tç­‰ \\s ç©ºç™½å­—ç¬¦ï¼ˆç©ºæ ¼ã€Tabã€æ¢è¡Œï¼‰ Hello\\sWorld åŒ¹é… Hello World \\S å•ä¸ªéç©ºç™½å­—ç¬¦ ä»»æ„å•ä¸ªéç©ºæ ¼å­—ç¬¦éƒ½åŒ¹é… \\b å•è¯è¾¹ç•Œ \\bcat\\b ä»…åŒ¹é… catï¼Œä¸åŒ¹é… catalog ^ è¡Œé¦– ^Hello ä»…åŒ¹é… Hello åœ¨è¡Œé¦–çš„æƒ…å†µ $ è¡Œå°¾ end$ ä»…åŒ¹é… end åœ¨è¡Œå°¾çš„æƒ…å†µ * åŒ¹é…å‰ä¸€ä¸ªå­—ç¬¦ 0 æ¬¡æˆ–å¤šæ¬¡ ab*c å¯åŒ¹é… acã€abcã€abbc + åŒ¹é…å‰ä¸€ä¸ªå­—ç¬¦ 1 æ¬¡æˆ–å¤šæ¬¡ ab+c ä»…åŒ¹é… abcã€abbcï¼Œä¸åŒ¹é… ac ? åŒ¹é…å‰ä¸€ä¸ªå­—ç¬¦ 0 æ¬¡æˆ– 1 æ¬¡ ab?c å¯åŒ¹é… ac æˆ– abc {n} åŒ¹é… n æ¬¡ a{3} ä»…åŒ¹é… aaa {n,} è‡³å°‘åŒ¹é… n æ¬¡ a{2,} å¯åŒ¹é… aaã€aaa {n,m} åŒ¹é… n åˆ° m æ¬¡ a{2,4} å¯åŒ¹é… aaã€aaaã€aaaa [] å­—ç¬¦é›†åˆ [aeiou] åŒ¹é…ä»»æ„å…ƒéŸ³å­—æ¯ ` ` æˆ–ï¼ˆåŒ¹é…å·¦è¾¹æˆ–å³è¾¹ï¼‰ () åˆ†ç»„ (ab)+ åŒ¹é… abã€abab ä¸Šé¢\u0026quot;.*/R\\\\\\$.*|.*/R\\\\.*\u0026quot;å¯ä»¥æ‹†è§£æˆä¸¤ä¸ªæ­£åˆ™ï¼Œå› ä¸ºä¸­é—´ç”¨äº†ä¸€ä¸ªæˆ–ï¼Œåˆ†åˆ«æ˜¯.*/R\\\\\\$.*ã€.*/R\\\\.*ï¼Œé¦–å…ˆæ¥çœ‹.*/R\\\\\\$.*å®ƒå¯ä»¥åˆ†è§£æˆ:\nå­—ç¬¦ å«ä¹‰ åŒ¹é…å­—ç¬¦ .* è¡¨ç¤ºæœ‰0æ¬¡æˆ–å¤šæ¬¡çš„å•ä¸ªå­—ç¬¦ com/xc/lib /R ç›´æ¥åŒ¹é…å­—ç¬¦ /R \\$ è¿™é‡Œç”±äºå’Œ$æœ‰å†²çªï¼Œæ‰€ä»¥å‰é¢åŠ äº†è½¬ä¹‰ï¼ŒåŒ¹é…çš„æ˜¯$å­—ç¬¦ $ .* å’Œå¼€å¤´çš„åŒ¹é…ä¸€æ ·ï¼Œè¡¨ç¤ºæœ‰0æ¬¡æˆ–å¤šæ¬¡çš„å•ä¸ªå­—ç¬¦ color æ‰€ä»¥æœ€ç»ˆcom/xc/lib/R$colorèƒ½è¢«åŒ¹é…åˆ°ï¼Œå†æ¥çœ‹.*/R\\\\.*å®ƒå¯ä»¥åˆ†è§£æˆï¼š\nå­—ç¬¦ å«ä¹‰ åŒ¹é…å­—ç¬¦ .* è¡¨ç¤ºæœ‰0æ¬¡æˆ–å¤šæ¬¡çš„å•ä¸ªå­—ç¬¦ com/xc/lib /R ç›´æ¥åŒ¹é…å­—ç¬¦ /R \\.* è¿™é‡Œç”±äºå’Œ.æœ‰å†²çªï¼Œæ‰€ä»¥å‰é¢åŠ äº†è½¬ä¹‰ï¼ŒåŒ¹é…çš„æ˜¯0æ¬¡æˆ–å¤šæ¬¡çš„.å­—ç¬¦ . æ‰€ä»¥æœ€ç»ˆcom/xc/lib/Rä¹Ÿèƒ½è¢«åŒ¹é…åˆ°ã€‚\næ›´å¤šæ­£åˆ™çš„åŒ¹é…ï¼š æµ‹è¯•ç”¨ä¾‹ï¼š #key_mmkv_migrate_version# ï¼Œæ­£åˆ™è¡¨è¾¾å¼(#[^#]*[^#\\\\s]+[^#]*#)ï¼Œä½¿ç”¨\n1 2 Pattern pattern = Pattern.compile(\u0026#34;(#[^#]*[^#\\\\s]+[^#]*#)\u0026#34;); Matcher matcher = pattern.match(\u0026#34;#key_mmkv_migrate_version# \u0026#34;) è¯¥æ­£åˆ™è¡¨è¾¾å¼ä½œç”¨ï¼šç”¨äºåŒ¹é… ä»¥ # å¼€å¤´å’Œç»“å°¾çš„å†…å®¹ï¼Œå¹¶ä¸”å†…å®¹ä¸­è‡³å°‘åŒ…å« ä¸€ä¸ªéç©ºç™½çš„é # å­—ç¬¦ã€‚ æ­£åˆ™è§£æï¼š\néƒ¨åˆ† å«ä¹‰ # åŒ¹é… #ï¼ˆå¼€å§‹ï¼‰ [^#]* åŒ¹é…ä»»æ„å¤šä¸ªé # çš„å­—ç¬¦ï¼ˆ0 æ¬¡æˆ–å¤šæ¬¡ï¼‰ [^#\\s]+ è‡³å°‘åŒ¹é… 1 ä¸ªé # å’Œéç©ºæ ¼çš„å­—ç¬¦ï¼ˆä¿è¯å†…å®¹ä¸æ˜¯ç©ºçš„ï¼‰ [^#]* å†æ¬¡åŒ¹é…ä»»æ„å¤šä¸ªé # çš„å­—ç¬¦ï¼ˆ0 æ¬¡æˆ–å¤šæ¬¡ï¼‰ # åŒ¹é… #ï¼ˆç»“æŸï¼‰ (\u0026hellip;) æ‹¬å·ç”¨äºæ•è·åŒ¹é…å†…å®¹ Matcher#replaceAllæ–¹æ³•\n1 matcher.replaceAll(\u0026#34;\u0026lt;a type=\u0026#34;topic\u0026#34; \u0026gt;$1\u0026lt;/a\u0026gt;\u0026#34;) ä¼šè¢«æ›¿æ¢æˆå¦‚ä¸‹ï¼š \u0026lt;a type=\u0026quot;topic\u0026quot; \u0026gt;#key_mmkv_migrate_version#\u0026lt;/a\u0026gt; æ­£åˆ™: \u0026lt;a[^\u0026gt;]*?((\u0026gt;[\\s\\S]*?\u0026lt;/a\u0026gt;)|(/\u0026gt;))\n1 2 @kotlin.internal.InlineOnly public inline fun String.toRegex(): Regex = Regex(this) å°†stringè½¬åŒ–æˆRegex:\n1 2 val regexStr = `\u0026lt;a[^\u0026gt;]*?((\u0026gt;[\\s\\S]*?\u0026lt;/a\u0026gt;)|(/\u0026gt;))` val regex = regexStr.toRegex() ç”¨äº åŒ¹é… HTML æ ‡ç­¾ï¼ˆåŒ…æ‹¬è‡ªé—­åˆ å’Œ **å¸¦å†…å®¹çš„ \u0026hellip; å½¢å¼ï¼‰ã€‚ æ­£åˆ™è§£æï¼š\néƒ¨åˆ† å«ä¹‰ \u0026lt;a åŒ¹é… \u0026lt;aï¼ˆå¼€å§‹çš„ æ ‡ç­¾ï¼‰ [^\u0026gt;]*? éè´ªå©ªåŒ¹é… å†…çš„æ‰€æœ‰å±æ€§ï¼ˆä¸åŒ…æ‹¬ \u0026gt;) `((â€¦ ) (/\u0026gt;))` \u0026gt;[\\s\\S]*? æƒ…å†µ â‘ ï¼šåŒ¹é… \u0026gt; åçš„å†…å®¹ï¼Œç›´åˆ° / \u0026gt; æƒ…å†µ â‘¡ï¼šåŒ¹é… ï¼ˆè‡ªé—­åˆæ ‡ç­¾ï¼‰ CharSequence.contains(regex: Regex):\n1 2 3 4 val source = `\u0026lt;a type=\u0026#34;topic\u0026#34; \u0026gt;#key_mmkv_migrate_version#\u0026lt;/a\u0026gt; ` val regexStr = `\u0026lt;a[^\u0026gt;]*?((\u0026gt;[\\s\\S]*?\u0026lt;/a\u0026gt;)|(/\u0026gt;))` val regex = regexStr.toRegex() source.contains(regex) containsæ–¹æ³•è¡¨ç¤ºæ˜¯å¦ç¬¦åˆè¿™ä¸ªæ­£åˆ™åˆ¤æ–­ã€‚\nRegex.find(input: CharSequence, startIndex: Int = 0): MatchResult? Regex.find() æ–¹æ³•ç”¨äº æŸ¥æ‰¾å­—ç¬¦ä¸²ä¸­ç¬¬ä¸€ä¸ªåŒ¹é…çš„ç»“æœï¼Œè¿”å› MatchResult?ï¼Œå¦‚æœæ‰¾ä¸åˆ°åŒ¹é…é¡¹ï¼Œåˆ™è¿”å› nullã€‚ MatchResult.range:è¡¨ç¤ºåŒ¹é…çš„ç´¢å¼•èŒƒå›´ï¼Œåˆ†åˆ«ç”¨startå’ŒendInclusiveæ¥è¡¨ç¤ºèŒƒå›´ã€‚ MatchResult.value:è¡¨ç¤ºåŒ¹é…åˆ°çš„å†…å®¹\næ­£åˆ™ï¼š(\\\\S+)=\\\u0026quot;([^\\\u0026quot;]+)\\\u0026quot; ä½œç”¨ï¼šä¸»è¦æ˜¯ç”¨æ¥åŒ¹é…html/xmlå±æ€§åŠå…¶å€¼ï¼Œæ¯”å¦‚\u0026lt;a type=\u0026quot;topic\u0026quot; \u0026gt;#key_mmkv_migrate_version#\u0026lt;/a\u0026gt; èƒ½åŒ¹é…åˆ°ï¼Œå®ƒæ˜¯åŒ¹é…type=\u0026quot;topic\u0026quot;ã€‚ æ­£åˆ™è§£æï¼š\næ­£åˆ™éƒ¨åˆ† ä½œç”¨ (\\S+) åŒ¹é…å±æ€§åï¼ˆéç©ºå­—ç¬¦ \\Sï¼ŒåŒ¹é…è‡³å°‘ä¸€ä¸ªå­—ç¬¦ +ï¼‰ = åŒ¹é…ç­‰å·ï¼ˆå›ºå®šå­—ç¬¦ =ï¼‰ \u0026quot;([^\u0026quot;]+)\u0026quot; åŒ¹é…å±æ€§å€¼ï¼ˆè¢«åŒå¼•å· \u0026quot; åŒ…è£¹ï¼Œå†…å®¹ä¸å« \u0026ldquo;ï¼‰ Regex.findAll\n1 public actual fun findAll(input: CharSequence, startIndex: Int = 0): Sequence\u0026lt;MatchResult\u0026gt; ç”¨äºè·å–å­—ç¬¦ä¸²ä¸­æ‰€æœ‰ç¬¦åˆæ­£åˆ™çš„ç»“æœï¼Œè¿”å›çš„æ˜¯ä¸€ä¸ªSequenceçš„MatchResult\n1 2 3 val attributeRegex = \u0026#34;(\\\\S+)=\\\u0026#34;([^\\\u0026#34;]+)\\\u0026#34;\u0026#34;.toRegex() val source = \u0026#34;\u0026lt;a type=\u0026#34;topic\u0026#34; \u0026gt;#key_mmkv_migrate_version#\u0026lt;/a\u0026gt; \u0026#34; val matchResultList = attributeRegex.findAll(source) MatchResult.destructuredå±æ€§ ç”¨æ¥æå–åŒ¹é…ç»“æœçš„æ•è·ç»„ï¼Œä¾‹å¦‚ä¸Šé¢æå–çš„æ˜¯typeå’Œtopicè¿™ä¸€ç»„å†…å®¹ã€‚\nä¾‹å¦‚ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 val regex = Regex(\u0026#34;(\\\\d{4})-(\\\\d{2})-(\\\\d{2})\u0026#34;) // åŒ¹é…æ—¥æœŸæ ¼å¼ YYYY-MM-DD val input = \u0026#34;2024-03-07\u0026#34; val matchResult = regex.find(input) if (matchResult != null) { val (year, month, day) = matchResult.destructured println(\u0026#34;Year: $year, Month: $month, Day: $day\u0026#34;) } è¾“å‡ºï¼š Year: 2024, Month: 03, Day: 07 ç„¶åé€šè¿‡MatchResult.destructured.toList()æ–¹æ³•è½¬æˆlistï¼Œå°±å¯ä»¥è·å–typeå’Œtopicå†…å®¹äº†ã€‚\nSpannableStringBuilderä½¿ç”¨\nåœ¨ Android å¼€å‘ä¸­ï¼ŒSpannableStringBuilder ä¸»è¦ç”¨äºå¯Œæ–‡æœ¬ï¼ˆStyled Textï¼‰ï¼Œå¯ä»¥è®©å­—ç¬¦ä¸²çš„ä¸€éƒ¨åˆ†å…·æœ‰ä¸åŒçš„æ ¼å¼ï¼Œæ¯”å¦‚ é¢œè‰²ã€å¤§å°ã€æ ·å¼ã€ç‚¹å‡»äº‹ä»¶ã€å›¾ç‰‡ç­‰ã€‚å®ƒæ¯” Html.fromHtml() æ€§èƒ½æ›´å¥½ï¼Œæ›´é€‚åˆåŠ¨æ€æ‹¼æ¥æ–‡æœ¬ã€‚\nä½¿ç”¨ï¼š\n1 2 3 4 5 6 7 8 9 10 11 val spannable = SpannableStringBuilder(\u0026#34;Hello, Android!\u0026#34;) // ç»™ \u0026#34;Android\u0026#34; è®¾ç½®çº¢è‰² spannable.setSpan( ForegroundColorSpan(Color.RED), 7, 14, Spannable.SPAN_EXCLUSIVE_EXCLUSIVE ) // åº”ç”¨åˆ° TextView textView.text = spannable SpannableStringBuilder(\u0026ldquo;Hello, Android!\u0026rdquo;) åˆ›å»ºä¸€ä¸ªå¯å˜çš„ Spannable å¯¹è±¡ã€‚ setSpan(ForegroundColorSpan(Color.RED), 7, 14, Spannable.SPAN_EXCLUSIVE_EXCLUSIVE) ForegroundColorSpan(Color.RED) â†’ è®¾ç½®å‰æ™¯è‰²ä¸ºçº¢è‰²ã€‚ 7, 14 â†’ åº”ç”¨èŒƒå›´ï¼ˆâ€œAndroidâ€ å­—ç¬¦çš„ç´¢å¼•ï¼‰ã€‚ SPAN_EXCLUSIVE_EXCLUSIVE â†’ è¯¥ Span åªä½œç”¨äºå½“å‰å­—ç¬¦èŒƒå›´ï¼Œåç»­æ–‡æœ¬ä¿®æ”¹ä¸ä¼šç»§æ‰¿ã€‚ textView.movementMethod = LinkMovementMethod.getInstance()ï¼Œè®¾ç½® TextView å¯ç‚¹å‡» æ‰€ä»¥å¦‚æœæƒ³è¦å¤šä¸ªæ•ˆæœï¼Œå¯ä»¥æ·»åŠ å¤šä¸ªspanç»™SpannableStringBuilderï¼Œé€šè¿‡å¤šæ¬¡è°ƒç”¨setSpanæ–¹æ³•ï¼Œç„¶åè®¾ç½®ä¸åŒçš„åæ ‡ä¿¡æ¯ã€‚\nSpannableStringBuilder.append()ï¼Œå¯ä»¥è¿½åŠ å¤šä¸ªspançš„æ ·å¼ï¼Œå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 val spannable = SpannableStringBuilder() // æ·»åŠ æ™®é€šæ–‡æœ¬ spannable.append(\u0026#34;Normal Text \u0026#34;) // æ·»åŠ çº¢è‰²æ–‡å­— val redText = SpannableString(\u0026#34;Red Text\u0026#34;) redText.setSpan(ForegroundColorSpan(Color.RED), 0, redText.length, Spannable.SPAN_EXCLUSIVE_EXCLUSIVE) spannable.append(redText) // æ·»åŠ è“è‰²æ–œä½“æ–‡å­— val blueText = SpannableString(\u0026#34; Blue Italic\u0026#34;) blueText.setSpan(ForegroundColorSpan(Color.BLUE), 0, blueText.length, Spannable.SPAN_EXCLUSIVE_EXCLUSIVE) blueText.setSpan(StyleSpan(Typeface.ITALIC), 0, blueText.length, Spannable.SPAN_EXCLUSIVE_EXCLUSIVE) spannable.append(blueText) // åº”ç”¨åˆ° TextView textView.text = spannable ä¸Šé¢ç”¨åˆ°äº†SpannableStringï¼Œå®ƒæ˜¯å®ç°äº†CharSequenceï¼Œæ˜¯å¯¹å­—ç¬¦ä¸²è¿›è¡Œæ ·å¼çš„æ‰©å±•ç±»ï¼Œç„¶åæŠŠå®ƒæ·»åŠ åˆ°SpannableStringBuilderä¸­ã€‚\nspanä¸­æ’å…¥å›¾ç‰‡ï¼Œé€šè¿‡imageSpanå®ç°ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 val spannable = SpannableStringBuilder(\u0026#34;Text with image \u0026#34;) val drawable = ContextCompat.getDrawable(context, R.drawable.ic_launcher_foreground)!! drawable.setBounds(0, 0, drawable.intrinsicWidth, drawable.intrinsicHeight) // åœ¨æ–‡æœ¬æœ«å°¾æ·»åŠ å›¾ç‰‡ spannable.setSpan( ImageSpan(drawable, ImageSpan.ALIGN_BASELINE), spannable.length - 1, spannable.length, Spannable.SPAN_EXCLUSIVE_EXCLUSIVE ) textView.text = spannable ","date":"2025-03-04T00:00:00Z","permalink":"http://xiangcman.xyz/p/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%95%B4%E7%90%86/","title":"æ­£åˆ™è¡¨è¾¾å¼æ•´ç†"},{"content":"ä¸Šä¸€èŠ‚é€šè¿‡booster-transform-toastçš„ä½¿ç”¨ï¼Œæ¥ç€ä»‹ç»äº†boosteræ’ä»¶çš„ä¸»æ¡†æ¶ï¼Œæœ€åè‡ªå·±ç®€å•ä½¿ç”¨äº†asmæ›¿æ¢classä¸­æ–¹æ³•çš„è°ƒç”¨ï¼Œè¿™ä¸€èŠ‚è®²è§£boosteré€šè¿‡Rå†…è”æ¥å‡å°‘åŒ…ä½“ç§¯ã€‚\né¦–å…ˆæˆ‘ä»¬äº†è§£ä¸‹å¤šç»„ä»¶æ‰“åŒ…çš„æ—¶å€™ï¼Œèµ„æºæ˜¯æ€ä¹ˆç®¡ç†çš„ï¼Œé¦–å…ˆæ¯ä¸ªmoduleéƒ½ä¼šæœ‰è‡ªå·±çš„R.classï¼Œåˆ†åˆ«å­˜å‚¨äº†animã€animatorã€attrã€boolç­‰å±æ€§ï¼š å¯ä»¥çœ‹åˆ°R.classä¸­åˆ†åˆ«ç”¨é™æ€å†…éƒ¨ç±»çš„å½¢å¼ä¿å­˜å„ç§èµ„æºå±æ€§ï¼Œæ¯ä¸€ä¸ªå±æ€§æ˜¯ç”¨ä¸€ä¸ªé™æ€å¸¸é‡çš„å½¢å¼ä¿å­˜ï¼Œå…¶ä¸­æ¯ä¸€ä¸ªå±æ€§å€¼æ˜¯ç”±PackageId+TypeId+EntryIdç»„åˆçš„ä¸€ä¸ªå€¼ï¼š å°±æ‹¿abc_face_inè¿™ä¸ªå±æ€§å€¼ï¼Œå®ƒæ˜¯0x7f010000è¿™ä¸ªå€¼ã€‚ä¸‹é¢æ¥æ‹†è§£ä¸‹è¿™ä¸ªå€¼ï¼š\nPackageIdï¼šæ˜¯åŒ…çš„idå€¼ï¼Œandroidä¸­å¦‚ä½•ä¸‰æ–¹åº”ç”¨çš„è¯ï¼Œè¿™ä¸ªå€¼ä¸€ç›´æ˜¯0x7fï¼Œç³»ç»Ÿåº”ç”¨çš„è¯æ˜¯0x01ï¼Œå®ƒæ˜¯å ç”¨ä¸€ä¸ªå­—èŠ‚ã€‚ TypeIdï¼šæ˜¯èµ„æºçš„ç±»å‹Idå€¼ï¼Œä¸€èˆ¬éƒ½æ˜¯ç”±animã€animatorã€attrç­‰ç±»å‹ï¼Œæ¯”å¦‚animæ˜¯0x01ï¼Œanimatoræ˜¯0x02ï¼Œattræ˜¯0x03ï¼Œä¾æ¬¡ç±»æ¨ã€‚å®ƒä¹Ÿæ˜¯å ç”¨ä¸€ä¸ªå­—èŠ‚ EntryIdï¼šæ˜¯å…·ä½“ç±»å‹ä¸‹èµ„æºå®ä¾‹çš„idå€¼ï¼Œä»0å¼€å§‹ï¼Œä¾æ¬¡é€’å¢ï¼Œå®ƒæ˜¯å ç”¨2ä¸ªå­—èŠ‚ã€‚ åœ¨å¤šmoduleä¸‹ï¼Œæ¯ä¸€ä¸ªmoduleæ‰“åŒ…åï¼Œéƒ½ä¼šæœ‰è‡ªå·±çš„R.classï¼Œå…¶ä¸­moduleä¸ºlibraryå¦‚æœå¼•ç”¨äº†èµ„æºçš„æ—¶å€™ï¼Œç¼–è¯‘apkçš„æ—¶å€™moduleä¸­å¼•ç”¨çš„è¿˜æ˜¯R.classä¸­çš„èµ„æºidã€‚å¦‚æœæ˜¯ä¸»moduleï¼Œä¹Ÿå°±æ˜¯applicationç±»å‹çš„ï¼Œå®ƒä¼šç›´æ¥è¢«æ›¿æ¢æˆå¸¸é‡å€¼äº†ã€‚å› ä¸ºmoduleçš„classæ–‡ä»¶ï¼Œåœ¨ä¸»å·¥ç¨‹ç¼–è¯‘æ—¶ï¼Œä¸ä¼šå†æ¬¡è¿›è¡Œç¼–è¯‘ï¼Œmoduleçš„calssæ–‡ä»¶åŸå°ä¸åŠ¨çš„æ‰“åŒ…è¿›apkã€‚è€Œèµ„æºidä¸ºå¸¸é‡æ˜¯åœ¨ä¸»å·¥ç¨‹ç¼–è¯‘æ—¶æ‰å½¢æˆçš„ï¼Œä½†moduleç”Ÿæˆclassæ—¶ï¼Œä½¿ç”¨çš„æ˜¯ä¸Šé¢è¯´åˆ°çš„å˜é‡ï¼Œæ‰€ä»¥ä¸€ç›´è¢«ä¿ç•™äº†ä¸‹æ¥ã€‚ å¦‚æœåŒä¸€ä¸ªèµ„æºåˆ†åˆ«åœ¨module1å’Œmodule2éƒ½å®šä¹‰äº†ï¼Œmodule1ä¸­å¼•ç”¨äº†è‡ªå·±moduleçš„èµ„æºï¼Œæ­¤æ—¶ä¸»moduleå…ˆåä¾èµ–äº†module1å’Œmodule2ï¼Œé‚£ä¹ˆæ­¤æ—¶module1ä¸­å¼•ç”¨çš„èµ„æºæ˜¯module1ä¸­çš„èµ„æºï¼Œå¦‚æœä¸»moduleå…ˆåä¾èµ–äº†module2å’Œmodule1ï¼Œé‚£ä¹ˆæ­¤æ—¶module1ä¸­å¼•ç”¨çš„èµ„æºæ˜¯module2ä¸­å®šä¹‰çš„ã€‚å‡ºç°ä¸Šé¢çš„åŸå› æ˜¯å› ä¸ºä¸»moduleåœ¨ç¼–è¯‘çš„æ—¶å€™ï¼Œçœ‹è°å…ˆä¾èµ–ï¼Œå¦‚æœæ‰¾åˆ°äº†å¯¹åº”çš„èµ„æºï¼Œé‚£ä¹ˆå°±ä¼šä»¥å…ˆä¾èµ–çš„moduleä¸­çš„èµ„æºä¸ºä¸»ã€‚ åœ¨ç¼–è¯‘çš„è¿‡ç¨‹ä¸­ï¼Œä¼šæŠŠåˆå¹¶åçš„èµ„æºç”Ÿæˆä¸€ä¸ªä¸´æ—¶çš„R.txtæ–‡ä»¶ï¼Œå®ƒçš„è·¯å¾„åœ¨appæ¨¡å—ä¸‹çš„build/intermediates/symbols/debug/R.txtä¸­ï¼š åœ¨ä¸åŒç‰ˆæœ¬çš„agpä¸Šsymbolsæ–‡ä»¶å¤¹å¯èƒ½ä¸åŒï¼Œæˆ‘è¿™é‡Œç”¨çš„agpæ˜¯3.5.3ï¼Œå¯ä»¥çœ‹åˆ°R.txtä¸­æ¯ä¸€è¡Œæ ‡æ˜äº†èµ„æºçš„å€¼ç±»å‹ã€èµ„æºç±»å‹ã€èµ„æºåã€èµ„æºå¯¹åº”çš„16è¿›åˆ¶å€¼ã€‚æœ€ç»ˆé€šè¿‡aaptå·¥å…·ä¼šæ„å»ºresource.arscæ–‡ä»¶ã€‚resource.arscæ˜¯ä¸€ä¸ªèµ„æºæ˜ å°„è¡¨ï¼Œé‡Œé¢é€šè¿‡16è¿›åˆ¶å€¼æ‰¾åˆ°å¯¹åº”çš„èµ„æºåã€‚å…¶ä¸­valuesæ–‡ä»¶å¤¹ä¸‹çš„èµ„æºéƒ½ä¼šåœ¨è¯¥æ–‡ä»¶ä¸­å®šä¹‰ï¼š å¯ä»¥çœ‹åˆ°å¤šè¯­è¨€é»˜è®¤æ‰“åˆ°apkä¸­ï¼Œæ‰€ä»¥å¦‚æœä¸éœ€è¦å›½é™…åŒ–æ˜¯å¯ä»¥çœå»å¤šè¯­è¨€çš„ã€‚è€Œåƒévaluesæ–‡ä»¶å¤¹ä¸‹çš„èµ„æºç›´æ¥åœ¨resç›®å½•ä¸­ã€‚\næ€»ç»“ appæ‰“åŒ…è¿‡ç¨‹ä¸­ï¼Œæ€»ä¼šç”¨å…ˆä¾èµ–çš„moduleä¸­å®šä¹‰çš„èµ„æºï¼Œå³ä½¿è¯¥moduleç”¨çš„æ˜¯è¯¥moduleä¸­çš„èµ„æºï¼Œæœ€ç»ˆç”±äºæ‰“åŒ…åˆå¹¶èµ„æºçš„æ—¶å€™ï¼Œä¼˜å…ˆå»ç”¨å…ˆä¾èµ–çš„moduleä¸­çš„èµ„æºã€‚ç„¶åä¼šç”ŸæˆR.txtæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶æ˜¯èµ„æºåˆå¹¶åç”Ÿæˆçš„æ–‡ä»¶ï¼Œé‡Œé¢æ¯ä¸€è¡Œå®šä¹‰äº†æŸä¸ªèµ„æºçš„èµ„æºå€¼ç±»å‹ã€èµ„æºç±»å‹ã€èµ„æºåã€èµ„æº16è¿›åˆ¶å€¼ï¼Œæœ€ç»ˆé€šè¿‡è¯¥æ–‡ä»¶ç”Ÿæˆresources.arscï¼Œè¯¥æ–‡ä»¶æ˜¯æè¿°æ¯ä¸ªèµ„æºçš„èµ„æºå€¼å’Œèµ„æºåçš„ä¸€ä¸ªå¯¹åº”å…³ç³»ï¼Œæœ€ç»ˆé€šè¿‡è¯¥å…³ç³»æ‰¾åˆ°èµ„æºã€‚ åœ¨ä»£ç ä¸­ï¼Œä¸»moduleé»˜è®¤æ˜¯é€šè¿‡å¸¸é‡å¼•ç”¨èµ„æºï¼Œè€Œlibraryçš„moduleä¸­é»˜è®¤å¼•ç”¨èµ„æºçš„æ—¶å€™ï¼Œæ˜¯å¼•ç”¨è‡ªå·±moduleçš„Rä¸­çš„å˜é‡ï¼Œè€Œèµ„æºæœ€ç»ˆä¼šåˆå¹¶ï¼Œæ‰€ä»¥æœ€ç»ˆä½¿ç”¨çš„èµ„æºçœ‹åˆå¹¶æ—¶å€™å“ªä¸ªèµ„æºè¢«æ‰“åˆ°apkä¸­ã€‚\nä¸Šé¢æåˆ°è°å…ˆä¾èµ–çš„é—®é¢˜ï¼Œ å…¶å®è¿™ä¸ªå¯ä»¥é€šè¿‡gradleå‘½ä»¤æŸ¥çœ‹ä¾èµ–å…³ç³»ï¼Œæ¯”å¦‚æˆ‘æƒ³çœ‹appè¿™ä¸ªmoduleçš„ä¾èµ–ï¼Œæ¯”å¦‚æˆ‘æƒ³çœ‹è¿è¡Œæ—¶çš„ä¾èµ–ï¼š\n1 ./gradlew app:dependencies --configuration debugRuntimeClasspath 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 debugRuntimeClasspath - Resolved configuration for runtime for variant: debug +--- project :lib | +--- project :lib2 | | +--- androidx.constraintlayout:constraintlayout:1.1.3 | | | \\--- androidx.constraintlayout:constraintlayout-solver:1.1.3 | | +--- com.google.android.material:material:1.1.0 | | | +--- androidx.annotation:annotation:1.0.1 -\u0026gt; 1.1.0 | | | +--- androidx.appcompat:appcompat:1.1.0 | | | | +--- androidx.annotation:annotation:1.1.0 | | | | +--- androidx.core:core:1.1.0 | | | | | +--- androidx.annotation:annotation:1.1.0 | | | | | +--- androidx.lifecycle:lifecycle-runtime:2.0.0 -\u0026gt; 2.1.0 | | | | | | +--- androidx.lifecycle:lifecycle-common:2.1.0 | | | | | | | \\--- androidx.annotation:annotation:1.1.0 | | | | | | +--- androidx.arch.core:core-common:2.1.0 | | | | | | | \\--- androidx.annotation:annotation:1.1.0 | | | | | | \\--- androidx.annotation:annotation:1.1.0 | | | | | +--- androidx.versionedparcelable:versionedparcelable:1.1.0 | | | | | | +--- androidx.annotation:annotation:1.1.0 | | | | | | \\--- androidx.collection:collection:1.0.0 -\u0026gt; 1.1.0 | | | | | | \\--- androidx.annotation:annotation:1.1.0 | | | | | \\--- androidx.collection:collection:1.0.0 -\u0026gt; 1.1.0 (*) | | | | +--- androidx.cursoradapter:cursoradapter:1.0.0 | | | | | \\--- androidx.annotation:annotation:1.0.0 -\u0026gt; 1.1.0 | | | | +--- androidx.fragment:fragment:1.1.0 | | | | | +--- androidx.annotation:annotation:1.1.0 | | | | | +--- androidx.core:core:1.1.0 (*) | | | | | +--- androidx.collection:collection:1.1.0 (*) | | | | | +--- androidx.viewpager:viewpager:1.0.0 | | | | | | +--- androidx.annotation:annotation:1.0.0 -\u0026gt; 1.1.0 | | | | | | +--- androidx.core:core:1.0.0 -\u0026gt; 1.1.0 (*) | | | | | | \\--- androidx.customview:customview:1.0.0 | | | | | | +--- androidx.annotation:annotation:1.0.0 -\u0026gt; 1.1.0 | | | | | | \\--- androidx.core:core:1.0.0 -\u0026gt; 1.1.0 (*) | | | | | +--- androidx.loader:loader:1.0.0 | | | | | | +--- androidx.annotation:annotation:1.0.0 -\u0026gt; 1.1.0 | | | | | | +--- androidx.core:core:1.0.0 -\u0026gt; 1.1.0 (*) | | | | | | +--- androidx.lifecycle:lifecycle-livedata:2.0.0 | | | | | | | +--- androidx.arch.core:core-runtime:2.0.0 | | | | | | | | +--- androidx.annotation:annotation:1.0.0 -\u0026gt; 1.1.0 | | | | | | | | \\--- androidx.arch.core:core-common:2.0.0 -\u0026gt; 2.1.0 (*) | | | | | | | +--- androidx.lifecycle:lifecycle-livedata-core:2.0.0 | | | | | | | | +--- androidx.lifecycle:lifecycle-common:2.0.0 -\u0026gt; 2.1.0 (*) | | | | | | | | +--- androidx.arch.core:core-common:2.0.0 -\u0026gt; 2.1.0 (*) | | | | | | | | \\--- androidx.arch.core:core-runtime:2.0.0 (*) | | | | | | | \\--- androidx.arch.core:core-common:2.0.0 -\u0026gt; 2.1.0 (*) | | | | | | \\--- androidx.lifecycle:lifecycle-viewmodel:2.0.0 -\u0026gt; 2.1.0 | | | | | | \\--- androidx.annotation:annotation:1.1.0 | | | | | +--- androidx.activity:activity:1.0.0 | | | | | | +--- androidx.annotation:annotation:1.1.0 | | | | | | +--- androidx.core:core:1.1.0 (*) | | | | | | +--- androidx.lifecycle:lifecycle-runtime:2.1.0 (*) | | | | | | +--- androidx.lifecycle:lifecycle-viewmodel:2.1.0 (*) | | | | | | \\--- androidx.savedstate:savedstate:1.0.0 | | | | | | +--- androidx.annotation:annotation:1.1.0 | | | | | | +--- androidx.arch.core:core-common:2.0.1 -\u0026gt; 2.1.0 (*) | | | | | | \\--- androidx.lifecycle:lifecycle-common:2.0.0 -\u0026gt; 2.1.0 (*) | | | | | \\--- androidx.lifecycle:lifecycle-viewmodel:2.0.0 -\u0026gt; 2.1.0 (*) | | | | +--- androidx.appcompat:appcompat-resources:1.1.0 | | | | | +--- androidx.annotation:annotation:1.1.0 | | | | | +--- androidx.core:core:1.0.1 -\u0026gt; 1.1.0 (*) | | | | | +--- androidx.vectordrawable:vectordrawable:1.1.0 | | | | | | +--- androidx.annotation:annotation:1.1.0 | | | | | | +--- androidx.core:core:1.1.0 (*) | | | | | | \\--- androidx.collection:collection:1.1.0 (*) | | | | | +--- androidx.vectordrawable:vectordrawable-animated:1.1.0 | | | | | | +--- androidx.vectordrawable:vectordrawable:1.1.0 (*) | | | | | | +--- androidx.interpolator:interpolator:1.0.0 | | | | | | | \\--- androidx.annotation:annotation:1.0.0 -\u0026gt; 1.1.0 | | | | | | \\--- androidx.collection:collection:1.1.0 (*) | | | | | \\--- androidx.collection:collection:1.0.0 -\u0026gt; 1.1.0 (*) | | | | +--- androidx.drawerlayout:drawerlayout:1.0.0 | | | | | +--- androidx.annotation:annotation:1.0.0 -\u0026gt; 1.1.0 | | | | | +--- androidx.core:core:1.0.0 -\u0026gt; 1.1.0 (*) | | | | | \\--- androidx.customview:customview:1.0.0 (*) | | | | \\--- androidx.collection:collection:1.0.0 -\u0026gt; 1.1.0 (*) | | | +--- androidx.cardview:cardview:1.0.0 | | | | \\--- androidx.annotation:annotation:1.0.0 -\u0026gt; 1.1.0 | | | +--- androidx.coordinatorlayout:coordinatorlayout:1.1.0 | | | | +--- androidx.annotation:annotation:1.1.0 | | | | +--- androidx.core:core:1.1.0 (*) | | | | +--- androidx.customview:customview:1.0.0 (*) | | | | \\--- androidx.collection:collection:1.0.0 -\u0026gt; 1.1.0 (*) | | | +--- androidx.core:core:1.1.0 (*) | | | +--- androidx.fragment:fragment:1.0.0 -\u0026gt; 1.1.0 (*) | | | +--- androidx.lifecycle:lifecycle-runtime:2.0.0 -\u0026gt; 2.1.0 (*) | | | +--- androidx.recyclerview:recyclerview:1.0.0 -\u0026gt; 1.1.0 | | | | +--- androidx.annotation:annotation:1.1.0 | | | | +--- androidx.core:core:1.1.0 (*) | | | | +--- androidx.customview:customview:1.0.0 (*) | | | | \\--- androidx.collection:collection:1.0.0 -\u0026gt; 1.1.0 (*) | | | +--- androidx.transition:transition:1.2.0 | | | | +--- androidx.annotation:annotation:1.1.0 | | | | +--- androidx.core:core:1.0.1 -\u0026gt; 1.1.0 (*) | | | | \\--- androidx.collection:collection:1.0.0 -\u0026gt; 1.1.0 (*) | | | +--- androidx.vectordrawable:vectordrawable:1.1.0 (*) | | | \\--- androidx.viewpager2:viewpager2:1.0.0 | | | +--- androidx.annotation:annotation:1.1.0 | | | +--- androidx.fragment:fragment:1.1.0 (*) | | | +--- androidx.recyclerview:recyclerview:1.1.0 (*) | | | +--- androidx.core:core:1.1.0 (*) | | | \\--- androidx.collection:collection:1.1.0 (*) | | +--- androidx.cardview:cardview:1.0.0 (*) | | \\--- androidx.appcompat:appcompat:1.1.0 (*) | +--- androidx.constraintlayout:constraintlayout:1.1.3 (*) | +--- com.google.android.material:material:1.1.0 (*) | +--- androidx.cardview:cardview:1.0.0 (*) | \\--- androidx.appcompat:appcompat:1.1.0 (*) +--- project :lib1 | +--- project :lib3 | | +--- androidx.constraintlayout:constraintlayout:1.1.3 (*) | | +--- com.google.android.material:material:1.1.0 (*) | | +--- androidx.cardview:cardview:1.0.0 (*) | | \\--- androidx.appcompat:appcompat:1.1.0 (*) | +--- androidx.constraintlayout:constraintlayout:1.1.3 (*) | +--- com.google.android.material:material:1.1.0 (*) | +--- androidx.cardview:cardview:1.0.0 (*) | \\--- androidx.appcompat:appcompat:1.1.0 (*) +--- androidx.constraintlayout:constraintlayout:1.1.3 (*) +--- com.google.android.material:material:1.1.0 (*) +--- androidx.cardview:cardview:1.0.0 (*) +--- androidx.appcompat:appcompat:1.1.0 (*) \\--- com.didiglobal.booster:booster-android-instrument-toast:3.1.0 \\--- com.didiglobal.booster:booster-android-instrument:3.1.0 å¯ä»¥çœ‹å‡ºæ¥appçš„moduleå…ˆæ˜¯ä¾èµ–äº†libå’Œlib1è¿™ä¸¤ä¸ªmoduleï¼Œå¹¶ä¸”libè¿™ä¸ªmoduleåˆä¾èµ–äº†lib2ï¼Œlib1ä¾èµ–äº†lib3ï¼Œæ‰€ä»¥èµ„æºåˆå¹¶çš„æ—¶å€™ï¼Œä¼˜å…ˆä½¿ç”¨libå’Œlib2ä¸­çš„èµ„æºã€‚ å…³äºæ›´å¤šä¾èµ–çš„gradleå‘½ä»¤ï¼š\n1 2 //æŸ¥çœ‹ç¼–è¯‘æ—¶çš„ä¾èµ–ï¼Œå®ƒåªä¼šçœ‹ç›´æ¥ä¾èµ–çš„å­moduleï¼Œé—´æ¥ä¾èµ–çš„å­moduleä¸ä¼šæŸ¥çœ‹ ./gradlew app:dependencies --configuration debugCompileClasspath 1 2 //å®ƒä¼šè¾“å‡ºdebugã€releaseã€testã€compileã€runtimeç»„åˆçš„ä¾èµ– ./gradlew app:dependencies æ³¨ï¼šä¸‹é¢ä»‹ç»çš„Rå†…è”æ’ä»¶æ˜¯åœ¨booster3.1.0ç‰ˆæœ¬ä¸Š ä»‹ç»å®Œä¸Šé¢èµ„æºæ–‡ä»¶å¼•ç”¨é—®é¢˜ï¼Œæˆ‘ä»¬å‘ç°éšç€moduleå’Œaarè¶Šæ¥è¶Šå¤šçš„æ—¶å€™ï¼ŒR.classçš„æ•°é‡ä¼šæ€¥å‰§å¢åŠ ï¼Œå¯¼è‡´åŒ…ä½“ç§¯æ€¥å¢ã€‚é‚£boosteræ˜¯æ€ä¹ˆè§£å†³è¿™ä¸ªR.classå‰§å¢çš„å‘¢ï¼Ÿ å®ƒæ˜¯é€šè¿‡æŠŠå­moduleçš„R.classä¸­å®šä¹‰çš„å˜é‡éƒ½åˆ é™¤æ‰ï¼Œç„¶åå­moduleä¸­çš„ä»£ç å¼•ç”¨çš„èµ„æºå˜é‡ä¼šç›´æ¥è¢«R.txtä¸­å®šä¹‰çš„å¸¸é‡å€¼æ‰€ä»£æ›¿ã€‚è¿™å°±æ˜¯Ræ–‡ä»¶å†…è”çš„è¿‡ç¨‹ã€‚é‚£ä¸‹é¢å°±åˆ†æä¸‹è¿™ä¸ªè¿‡ç¨‹æ€ä¹ˆå®ç°çš„ï¼Œå‰é¢ä»‹ç»è¿‡å„ä¸ªæ’ä»¶æ˜¯é€šè¿‡è‡ªå·±çš„ClassTransformeræ¥å®ç°å­—èŠ‚ç ä¿®æ”¹ï¼Œå…¶ä¸­Ræ–‡ä»¶å†…è”çš„æ’ä»¶æ˜¯é€šè¿‡RInlineTransformerå®ç°çš„ï¼Œé¦–å…ˆçœ‹ä¸‹onPreTransformä¸­çš„å®ç°ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 override fun onPreTransform(context: TransformContext) { this.appPackage = context.originalApplicationId.replace(\u0026#39;.\u0026#39;, \u0026#39;/\u0026#39;) //â‘ è§£æR.txtï¼Œç”Ÿæˆsybolsä¿¡æ¯ this.symbols = SymbolList.from(context.artifacts.get(SYMBOL_LIST).single()) this.appRStyleable = \u0026#34;$appPackage/$R_STYLEABLE\u0026#34; this.ignores = context.getProperty(PROPERTY_IGNORES)?.split(\u0026#39;,\u0026#39;)?.map { Wildcard(it) }?.toSet() ?: emptySet() //â‘¡å¿½ç•¥constrainlayoutä¸­çš„idå±æ€§ val retainedSymbols: Set\u0026lt;String\u0026gt; val classpath = context.compileClasspath.map { it.absolutePath } if (classpath.any { it.contains(PREFIX_SUPPORT_CONSTRAINT_LAYOUT) || it.contains(PREFIX_JETPACK_CONSTRAINT_LAYOUT) }) { // Find symbols that should be retained retainedSymbols = context.findRetainedSymbols() if (retainedSymbols.isNotEmpty()) { this.ignores += setOf(Wildcard.valueOf(\u0026#34;android/support/constraint/R\\$id\u0026#34;)) this.ignores += setOf(Wildcard.valueOf(\u0026#34;androidx/constraintlayout/R\\$id\u0026#34;)) } } else { retainedSymbols = emptySet() } } åœ¨onPreTransformâ‘ å¤„é¦–å…ˆè§£æR.txtæ–‡ä»¶ï¼Œæ–‡ç« å¼€å¤´å·²ç»ä»‹ç»è¿‡è¯¥æ–‡ä»¶ï¼Œå®ƒä¸»è¦æ˜¯ç”¨æ¥å­˜å‚¨èµ„æºæ–‡ä»¶åˆå¹¶åçš„ä¿¡æ¯ã€‚åœ¨â‘¡å¤„ä¼šå¿½ç•¥ConstrainLayoutä¸­çš„R.id.**çš„å˜é‡ï¼Œå› ä¸ºåœ¨ ConstraintLayout ä¸­ï¼ŒR.id.xxx å¯èƒ½ä¼šè¢« ConstraintSet æˆ–è€…å…¶ä»–ä»£ç  åŠ¨æ€è§£æï¼Œæ¯”å¦‚ï¼š\n1 2 3 val constraintSet = ConstraintSet() constraintSet.clone(constraintLayout) constraintSet.connect(R.id.viewA, ConstraintSet.START, R.id.viewB, ConstraintSet.END) Booster è¿›è¡Œ ä»£ç å‹ç¼©/é‡æ’ æ—¶ï¼Œå¦‚æœå¯¹ R.id.xxx è¿›è¡Œäº†å†…è”æˆ–ä¼˜åŒ–ï¼Œå¯èƒ½ä¼šå¯¼è‡´ ID å¤±æ•ˆï¼Œè¿›è€Œå¯¼è‡´çº¦æŸå¸ƒå±€æ— æ³•æ­£å¸¸å·¥ä½œã€‚æ¥ç€çœ‹ä¸‹transformæ–¹æ³•ï¼Œå®ƒæ˜¯æ“ä½œå­—èŠ‚ç çš„å…³é”®æ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 override fun transform(context: TransformContext, klass: ClassNode): ClassNode { if (this.symbols.isEmpty()) { return klass } if (this.ignores.any { it.matches(klass.name) }) { logger.println(\u0026#34;Ignore `${klass.name}`\u0026#34;) } else if (Pattern.matches(R_REGEX, klass.name) \u0026amp;\u0026amp; klass.name != appRStyleable) { //é€šè¿‡æ­£åˆ™åŒ¹é…åˆ é™¤R$colorè¿™ç§å†…éƒ¨ç±»çš„æ‰€æœ‰å±æ€§ klass.fields.clear() removedR[klass.name] = klass.bytes() } else { //å¦‚æœæ˜¯ä»£ç ä¸­è°ƒç”¨äº†R.color.**è¿™ç§ï¼Œç›´æ¥æ“ä½œå­—èŠ‚ç  klass.replaceSymbolReferenceWithConstant() } return klass } åœ¨transformæ–¹æ³•ä¸­ï¼Œé€šè¿‡æ­£åˆ™åŒ¹é…åˆ é™¤R$colorè¿™ç§å†…éƒ¨ç±»çš„æ‰€æœ‰å±æ€§ï¼Œå¦‚æœä¸æ˜¯R$colorè¿™ç§å†…éƒ¨ç±»ï¼Œåˆ™é€šè¿‡æ‰©å±•å‡½æ•°replaceSymbolReferenceWithConstantç›´æ¥æ“ä½œå­—èŠ‚ç \n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 private fun ClassNode.replaceSymbolReferenceWithConstant() { methods.forEach { method -\u0026gt; //â‘ ï¼šé€šè¿‡æ–¹æ³•çš„æŒ‡ä»¤é›†æ¥è¿‡æ»¤ val insns = method.instructions.iterator().asIterable().filter { //â‘¡ï¼šå¦‚æœå½“å‰æŒ‡ä»¤æ˜¯getstatic it.opcode == GETSTATIC }.map { it as FieldInsnNode }.filter { //â‘¢ï¼šè¿”å›å€¼æ˜¯intç±»å‹å¹¶ä¸”æ˜¯ä»¥**R$å¼€å¤´è·å–Ræ–‡ä»¶ä¸­çš„å¸¸é‡å½¢å¼å¹¶ä¸”ä¸æ˜¯ä»¥androidå†…éƒ¨çš„Rå¼€å¤´çš„è¯ (\u0026#34;I\u0026#34; == it.desc || \u0026#34;[I\u0026#34; == it.desc) \u0026amp;\u0026amp; it.owner.substring(it.owner.lastIndexOf(\u0026#39;/\u0026#39;) + 1).startsWith(\u0026#34;R$\u0026#34;) \u0026amp;\u0026amp; !(it.owner.startsWith(COM_ANDROID_INTERNAL_R) || it.owner.startsWith(ANDROID_R)) } //â‘£ï¼šè¿‡æ»¤å‡ºè¿”å›å€¼ä¸ºintç±»å‹çš„æŒ‡ä»¤ val intFields = insns.filter { \u0026#34;I\u0026#34; == it.desc } val intArrayFields = insns.filter { \u0026#34;[I\u0026#34; == it.desc } intFields.forEach { field -\u0026gt; //â‘¤ï¼šè·å–Ræ–‡ä»¶çš„èµ„æºç±»å‹ val type = field.owner.substring(field.owner.lastIndexOf(\u0026#34;/R$\u0026#34;) + 3) try { //â‘¥ï¼šåœ¨è·å–Rä¸­å¸¸é‡æŒ‡ä»¤ä¹‹å‰æ’å…¥å¸¸é‡çš„æŒ‡ä»¤ï¼ŒLdcInsnNodeä¸­çš„å‚æ•°æ˜¯è·å–è¿™ä¸ªå¸¸é‡å€¼ method.instructions.insertBefore(field, LdcInsnNode(symbols.getInt(type, field.name))) //â‘¦ï¼šç§»é™¤å½“å‰è·å–å˜é‡çš„æŒ‡ä»¤ method.instructions.remove(field) } catch (e: NullPointerException) { logger.println(\u0026#34;Unresolvable symbol `R.$type.${field.name}` : $name.${method.name}${method.desc}\u0026#34;) } } //â‘§ï¼šintæ•°ç»„ç±»å‹çš„æŒ‡ä»¤ç›´æ¥æŠŠowneræ›¿æ¢æˆappç›®å½•çš„åŒ…å intArrayFields.forEach { field -\u0026gt; field.owner = \u0026#34;$appPackage/${field.owner.substring(field.owner.lastIndexOf(\u0026#39;/\u0026#39;) + 1)}\u0026#34; } } } åœ¨ä¸Šé¢å­—èŠ‚ç æ“ä½œå¦‚æœä¸å¤ªç†Ÿæ‚‰çš„è¯ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨libraryæ¨¡å—ä¸­å®šä¹‰ç±»å»è·å–Rä¸­çš„èµ„æºï¼Œæ¯”å¦‚æˆ‘ä¸‹é¢å®šä¹‰ä¸€ä¸ªTestViewï¼Œè·å–è‡ªå·±çš„Rä¸­çš„colorå±æ€§ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 public class TestView extends View { public TestView(Context context) { this(context, null); } public TestView(Context context, @Nullable AttributeSet attrs) { this(context, attrs, 0); } public TestView(Context context, @Nullable AttributeSet attrs, int defStyleAttr) { super(context, attrs, defStyleAttr); setBackgroundColor(getResources().getColor(R.color.black_bg)); } } ä¸Šé¢è·å–R.color.black_bgï¼Œé‚£æ­¤å¤„ä¼šç”¨boosterçš„Rå†…è”ç»™æ›¿æ¢æˆå¸¸é‡ï¼Œæ€ä¹ˆæ›¿æ¢ï¼Œå…ˆè‚¯å®šæ˜¯æ‰¾åˆ°è¿™ä¸ªæŒ‡ä»¤å¯¹ä¸ï¼Ÿçœ‹ä¸‹æ­¤å¤„çš„æŒ‡ä»¤ï¼Œæˆ‘ä»¬é€šè¿‡jclasslib bytecode vieweræ¥æŸ¥çœ‹ç¼–è¯‘åçš„classï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 0 aload_0 1 aload_1 2 aload_2 3 iload_3 4 invokespecial #3 \u0026lt;android/view/View.\u0026lt;init\u0026gt; : (Landroid/content/Context;Landroid/util/AttributeSet;I)V\u0026gt; 7 aload_0 8 aload_0 9 invokevirtual #4 \u0026lt;com/xc/lib/TestView.getResources : ()Landroid/content/res/Resources;\u0026gt; 12 getstatic #5 \u0026lt;com/xc/lib/R$color.black_bg : I\u0026gt; 15 invokevirtual #6 \u0026lt;android/content/res/Resources.getColor : (I)I\u0026gt; 18 invokevirtual #7 \u0026lt;com/xc/lib/TestView.setBackgroundColor : (I)V\u0026gt; 21 return åœ¨12è¡Œï¼Œé€šè¿‡getstaticæ¥è·å–com/xc/lib/R$color.black_bgï¼Œè¿”å›ç±»å‹æ˜¯Iï¼Œè¡¨ç¤ºæ•´å½¢ã€‚æ‰€ä»¥ä¸Šé¢â‘ -â‘£çš„æ“ä½œå°±æ˜¯åœ¨è·å–è¯¥æŒ‡ä»¤ï¼Œåœ¨â‘¤å¤„è·å–è¯¥èµ„æºç±»å‹ï¼Œä¸Šé¢TestViewä¸­æ˜¯è·å–colorç±»å‹çš„èµ„æºï¼ŒåŠ 3æ˜¯ä¸ºäº†è¦è·å–åœ¨/R$åé¢çš„å­—ç¬¦çš„å¼€å§‹ä½ç½®ï¼Œâ‘¥å¤„è¡¨ç¤ºåœ¨è¯¥è·å–å˜é‡çš„æŒ‡ä»¤å‰æ’å…¥ä¸€æ¡LdcInsnNodeçš„å¸¸é‡æŒ‡ä»¤ï¼Œåœ¨â‘¦å¤„ç§»é™¤å½“å‰è·å–å˜é‡çš„æŒ‡ä»¤ã€‚åœ¨â‘§å¤„å¦‚æœæ˜¯intæ•°ç»„ç±»å‹çš„æŒ‡ä»¤ç›´æ¥æŠŠowneræ›¿æ¢æˆappç›®å½•çš„åŒ…åã€‚ å…¶å®è¿˜æœ‰ä¸ªå·¥å…·å¯ä»¥æŸ¥çœ‹ä¸Šé¢FieldInsnNodeçš„ownerã€desã€nameä¿¡æ¯ï¼Œæ¯”å¦‚getstatic #5 \u0026lt;com/xc/lib/R$color.black_bg : I\u0026gt;è¿™æ¡æŒ‡ä»¤åœ¨jclasslib bytecode viewerï¼Œæ¯”å¦‚ä¸Šé¢çš„å±æ€§ä¿¡æ¯å±•ç¤ºå¦‚ä¸‹ï¼š ä¸Šé¢å±æ€§æ˜¯ä¸€ä¸ªå¸¸é‡ï¼Œæ‰€ä»¥å®ƒæ˜¯åœ¨å¸¸é‡æ± ä¸­ï¼Œéœ€è¦æ˜¯05ï¼Œç±»åå¯¹åº”äº†ownerï¼Œä¹Ÿå°±æ˜¯è¯´è¯¥å±æ€§æ˜¯å±äºå“ªä¸ªç±»ä¸‹çš„ï¼Œåå­—æ˜¯black_bgï¼Œå¯¹åº”äº†nameï¼ŒIæ˜¯è¿”å›å€¼ï¼Œintç±»å‹ï¼Œå¯¹åº”äº†desã€‚ ç»“åˆä¿®æ”¹åçš„å­—èŠ‚ç ï¼ŒæŸ¥çœ‹TestViewä¿®æ”¹åçš„å­—èŠ‚ç ï¼Œé€šè¿‡BytecodeVieweræ¥æŸ¥çœ‹ç¼–è¯‘åçš„classï¼š å¯ä»¥çœ‹åˆ°æœ€ç»ˆé€šè¿‡ldcæŒ‡ä»¤æ¥è·å–ä¸€ä¸ªå¸¸é‡æ¥æ›¿æ¢ä¹‹å‰è·å–R.color.black_bgå˜é‡ã€‚åŒæ—¶å†æ¥çœ‹ä¸‹moduleä¸‹çš„R$color.class: å¯ä»¥çœ‹åˆ°è¯¥å†…éƒ¨ç±»æ‰€æœ‰çš„å±æ€§è¢«ç½®ä¸ºç©ºäº†ï¼ŒåŒ…æ‹¬ä¸»moduleä¸‹çš„R$color.classä¸‹çš„å±æ€§ä¹Ÿæ˜¯æ¸…ç©ºäº†ã€‚æ‰€ä»¥boosterçš„æ–¹æ¡ˆæ˜¯ä¸åŒºåˆ†ä¸»moduleè¿˜æ˜¯libçš„moduleã€‚\nä¸ºä»€ä¹ˆR$styleableä¸­çš„é™æ€å˜é‡ä¸ä¼šè¢«ç§»é™¤ï¼Ÿå¹¶ä¸”ä¸»moduleæ˜¯åŸå°ä¸åŠ¨ï¼Œlibçš„moduleæ˜¯åªä¿ç•™äº†æ•°ç»„ç±»å‹çš„å˜é‡ï¼Œå¹¶ä¸”æ˜¯åœ¨staticä»£ç å—ä¸­å®šä¹‰æ•°ç»„ï¼Œå¹¶ä¸”æ•°ç»„çš„å®šä¹‰ç¼ºå°‘public static finalå…³é”®å­—ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 package com.xc.lib; public final class R$styleable { static { ActionBar = new int[]{2130903092, 2130903099, 2130903100, 2130903224, 2130903225, 2130903226, 2130903227, 2130903228, 2130903229, 2130903255, 2130903264, 2130903265, 2130903284, 2130903343, 2130903349, 2130903355, 2130903356, 2130903358, 2130903368, 2130903381, 2130903481, 2130903513, 2130903532, 2130903536, 2130903537, 2130903598, 2130903601, 2130903673, 2130903683}; ActionBarLayout = new int[]{16842931}; ActionMenuItemView = new int[]{16843071}; ActionMenuView = new int[0]; ActionMode = new int[]{2130903092, 2130903099, 2130903192, 2130903343, 2130903601, 2130903683}; ActivityChooserView = new int[]{2130903303, 2130903369}; AlertDialog = new int[]{16842994, 2130903142, 2130903143, 2130903470, 2130903471, 2130903510, 2130903566, 2130903568}; AnimatedStateListDrawableCompat = new int[]{16843036, 16843156, 16843157, 16843158, 16843532, 16843533}; AnimatedStateListDrawableItem = new int[]{16842960, 16843161}; AnimatedStateListDrawableTransition = new int[]{16843161, 16843849, 16843850, 16843851}; AppBarLayout = new int[]{16842964, 16843919, 16844096, 2130903284, 2130903304, 2130903462, 2130903463, 2130903592}; AppBarLayoutStates = new int[]{2130903586, 2130903587, 2130903589, 2130903590}; AppBarLayout_Layout = new int[]{2130903460, 2130903461}; AppCompatImageView = new int[]{16843033, 2130903578, 2130903671, 2130903672}; AppCompatSeekBar = new int[]{16843074, 2130903668, 2130903669, 2130903670}; AppCompatTextHelper = new int[]{16842804, 16843117, 16843118, 16843119, 16843120, 16843666, 16843667}; AppCompatTextView = new int[]{16842804, 2130903087, 2130903088, 2130903089, 2130903090, 2130903091, 2130903269, 2130903270, 2130903271, 2130903272, 2130903274, 2130903275, 2130903276, 2130903277, 2130903326, 2130903329, 2130903337, 2130903399, 2130903464, 2130903633, 2130903660}; AppCompatTheme = new int[]{16842839, 16842926, 2130903040, 2130903041, 2130903042, 2130903043, 2130903044, 2130903045, 2130903046, 2130903047, 2130903048, 2130903049, 2130903050, 2130903051, 2130903052, 2130903054, 2130903055, 2130903056, 2130903057, 2130903058, 2130903059, 2130903060, 2130903061, 2130903062, 2130903063, 2130903064, 2130903065, 2130903066, 2130903067, 2130903068, 2130903069, 2130903070, 2130903074, 2130903075, 2130903076, 2130903077, 2130903078, 2130903086, 2130903120, 2130903135, 2130903136, 2130903137, 2130903138, 2130903139, 2130903144, 2130903145, 2130903157, 2130903164, 2130903198, 2130903199, 2130903200, 2130903201, 2130903202, 2130903203, 2130903204, 2130903211, 2130903212, 2130903218, 2130903236, 2130903261, 2130903262, 2130903263, 2130903266, 2130903268, 2130903279, 2130903280, 2130903281, 2130903282, 2130903283, 2130903355, 2130903367, 2130903466, 2130903467, 2130903468, 2130903469, 2130903472, 2130903473, 2130903474, 2130903475, 2130903476, 2130903477, 2130903478, 2130903479, 2130903480, 2130903522, 2130903523, 2130903524, 2130903531, 2130903533, 2130903540, 2130903542, 2130903543, 2130903544, 2130903553, 2130903554, 2130903555, 2130903556, 2130903575, 2130903576, 2130903605, 2130903644, 2130903646, 2130903647, 2130903648, 2130903650, 2130903651, 2130903652, 2130903653, 2130903656, 2130903657, 2130903685, 2130903686, 2130903687, 2130903688, 2130903696, 2130903698, 2130903699, 2130903700, 2130903701, 2130903702, 2130903703, 2130903704, 2130903705, 2130903706, 2130903707}; Badge = new int[]{2130903093, 2130903103, 2130903105, 2130903505, 2130903515}; BottomAppBar = new int[]{2130903101, 2130903284, 2130903314, 2130903315, 2130903316, 2130903317, 2130903318, 2130903350}; BottomNavigationView = new int[]{2130903101, 2130903284, 2130903373, 2130903376, 2130903378, 2130903379, 2130903382, 2130903394, 2130903395, 2130903396, 2130903398, 2130903508}; BottomSheetBehavior_Layout = new int[]{16843840, 2130903101, 2130903111, 2130903112, 2130903113, 2130903114, 2130903116, 2130903117, 2130903118, 2130903557, 2130903560}; ButtonBarLayout = new int[]{2130903079}; CardView = new int[]{16843071, 16843072, 2130903148, 2130903149, 2130903150, 2130903152, 2130903153, 2130903154, 2130903230, 2130903231, 2130903232, 2130903233, 2130903234}; Chip = new int[]{16842804, 16842904, 16842923, 16843039, 16843087, 16843237, 2130903160, 2130903161, 2130903163, 2130903165, 2130903166, 2130903167, 2130903169, 2130903170, 2130903171, 2130903172, 2130903173, 2130903174, 2130903175, 2130903180, 2130903181, 2130903182, 2130903184, 2130903185, 2130903186, 2130903187, 2130903188, 2130903189, 2130903190, 2130903191, 2130903296, 2130903348, 2130903359, 2130903363, 2130903547, 2130903557, 2130903560, 2130903564, 2130903658, 2130903661}; ChipGroup = new int[]{2130903159, 2130903176, 2130903177, 2130903178, 2130903569, 2130903570}; CollapsingToolbarLayout = new int[]{2130903195, 2130903196, 2130903235, 2130903305, 2130903306, 2130903307, 2130903308, 2130903309, 2130903310, 2130903311, 2130903548, 2130903550, 2130903593, 2130903673, 2130903674, 2130903684}; CollapsingToolbarLayout_Layout = new int[]{2130903405, 2130903406}; ColorStateListItem = new int[]{16843173, 16843551, 2130903080}; CompoundButton = new int[]{16843015, 2130903140, 2130903146, 2130903147}; ConstraintLayout_Layout = new int[]{16842948, 16843039, 16843040, 16843071, 16843072, 2130903107, 2130903108, 2130903156, 2130903220, 2130903221, 2130903407, 2130903408, 2130903409, 2130903410, 2130903411, 2130903412, 2130903413, 2130903414, 2130903415, 2130903416, 2130903417, 2130903418, 2130903419, 2130903420, 2130903421, 2130903422, 2130903423, 2130903424, 2130903425, 2130903426, 2130903427, 2130903428, 2130903429, 2130903430, 2130903431, 2130903432, 2130903433, 2130903434, 2130903435, 2130903436, 2130903437, 2130903438, 2130903439, 2130903440, 2130903441, 2130903442, 2130903443, 2130903444, 2130903445, 2130903446, 2130903447, 2130903449, 2130903450, 2130903451, 2130903452, 2130903453, 2130903454, 2130903455, 2130903456, 2130903459}; ConstraintLayout_placeholder = new int[]{2130903222, 2130903287}; ConstraintSet = new int[]{16842948, 16842960, 16842972, 16842996, 16842997, 16842999, 16843000, 16843001, 16843002, 16843039, 16843040, 16843071, 16843072, 16843551, 16843552, 16843553, 16843554, 16843555, 16843556, 16843557, 16843558, 16843559, 16843560, 16843701, 16843702, 16843770, 16843840, 2130903107, 2130903108, 2130903156, 2130903221, 2130903407, 2130903408, 2130903409, 2130903410, 2130903411, 2130903412, 2130903413, 2130903414, 2130903415, 2130903416, 2130903417, 2130903418, 2130903419, 2130903420, 2130903421, 2130903422, 2130903423, 2130903424, 2130903425, 2130903426, 2130903427, 2130903428, 2130903429, 2130903430, 2130903431, 2130903432, 2130903433, 2130903434, 2130903435, 2130903436, 2130903437, 2130903438, 2130903439, 2130903440, 2130903441, 2130903442, 2130903443, 2130903444, 2130903445, 2130903446, 2130903447, 2130903449, 2130903450, 2130903451, 2130903452, 2130903453, 2130903454, 2130903455, 2130903456}; CoordinatorLayout = new int[]{2130903397, 2130903591}; CoordinatorLayout_Layout = new int[]{16842931, 2130903402, 2130903403, 2130903404, 2130903448, 2130903457, 2130903458}; DrawerArrowToggle = new int[]{2130903084, 2130903085, 2130903106, 2130903197, 2130903273, 2130903340, 2130903574, 2130903664}; ExtendedFloatingActionButton = new int[]{2130903284, 2130903312, 2130903348, 2130903564, 2130903567}; ExtendedFloatingActionButton_Behavior_Layout = new int[]{2130903109, 2130903110}; FloatingActionButton = new int[]{2130903101, 2130903102, 2130903119, 2130903284, 2130903296, 2130903319, 2130903320, 2130903348, 2130903357, 2130903506, 2130903535, 2130903547, 2130903557, 2130903560, 2130903564, 2130903694}; FloatingActionButton_Behavior_Layout = new int[]{2130903109}; FlowLayout = new int[]{2130903390, 2130903465}; FontFamily = new int[]{2130903330, 2130903331, 2130903332, 2130903333, 2130903334, 2130903335}; FontFamilyFont = new int[]{16844082, 16844083, 16844095, 16844143, 16844144, 2130903328, 2130903336, 2130903337, 2130903338, 2130903693}; ForegroundLinearLayout = new int[]{16843017, 16843264, 2130903339}; GradientColor = new int[]{16843165, 16843166, 16843169, 16843170, 16843171, 16843172, 16843265, 16843275, 16844048, 16844049, 16844050, 16844051}; GradientColorItem = new int[]{16843173, 16844052}; LinearConstraintLayout = new int[]{16842948}; LinearLayoutCompat = new int[]{16842927, 16842948, 16843046, 16843047, 16843048, 2130903265, 2130903267, 2130903507, 2130903563}; LinearLayoutCompat_Layout = new int[]{16842931, 16842996, 16842997, 16843137}; ListPopupWindow = new int[]{16843436, 16843437}; MaterialAlertDialog = new int[]{2130903094, 2130903095, 2130903096, 2130903097}; MaterialAlertDialogTheme = new int[]{2130903483, 2130903484, 2130903485, 2130903486, 2130903487}; MaterialButton = new int[]{16843191, 16843192, 16843193, 16843194, 16843237, 2130903101, 2130903102, 2130903243, 2130903284, 2130903358, 2130903360, 2130903361, 2130903362, 2130903364, 2130903365, 2130903547, 2130903557, 2130903560, 2130903594, 2130903595}; MaterialButtonToggleGroup = new int[]{2130903158, 2130903570}; MaterialCalendar = new int[]{16843277, 2130903256, 2130903257, 2130903258, 2130903259, 2130903541, 2130903708, 2130903709, 2130903710}; MaterialCalendarItem = new int[]{16843191, 16843192, 16843193, 16843194, 2130903374, 2130903383, 2130903384, 2130903391, 2130903392, 2130903396}; MaterialCardView = new int[]{16843237, 2130903151, 2130903160, 2130903162, 2130903547, 2130903557, 2130903560, 2130903588, 2130903594, 2130903595}; MaterialCheckBox = new int[]{2130903146, 2130903695}; MaterialRadioButton = new int[]{2130903695}; MaterialShape = new int[]{2130903557, 2130903560}; MaterialTextAppearance = new int[]{16844159, 2130903464}; MaterialTextView = new int[]{16842804, 16844159, 2130903464}; MenuGroup = new int[]{16842766, 16842960, 16843156, 16843230, 16843231, 16843232}; MenuItem = new int[]{16842754, 16842766, 16842960, 16843014, 16843156, 16843230, 16843231, 16843233, 16843234, 16843235, 16843236, 16843237, 16843375, 2130903053, 2130903071, 2130903073, 2130903081, 2130903223, 2130903364, 2130903365, 2130903516, 2130903562, 2130903689}; MenuView = new int[]{16842926, 16843052, 16843053, 16843054, 16843055, 16843056, 16843057, 2130903534, 2130903596}; NavigationView = new int[]{16842964, 16842973, 16843039, 2130903284, 2130903342, 2130903373, 2130903375, 2130903377, 2130903378, 2130903379, 2130903380, 2130903383, 2130903384, 2130903385, 2130903386, 2130903387, 2130903388, 2130903389, 2130903393, 2130903396, 2130903508}; PopupWindow = new int[]{16843126, 16843465, 2130903517}; PopupWindowBackgroundState = new int[]{2130903585}; RecycleListView = new int[]{2130903518, 2130903521}; RecyclerView = new int[]{16842948, 16842987, 16842993, 2130903321, 2130903322, 2130903323, 2130903324, 2130903325, 2130903401, 2130903546, 2130903573, 2130903579}; ScrimInsetsFrameLayout = new int[]{2130903370}; ScrollingViewBehavior_Layout = new int[]{2130903115}; SearchView = new int[]{16842970, 16843039, 16843296, 16843364, 2130903185, 2130903219, 2130903260, 2130903341, 2130903366, 2130903400, 2130903538, 2130903539, 2130903551, 2130903552, 2130903597, 2130903602, 2130903697}; ShapeAppearance = new int[]{2130903238, 2130903239, 2130903240, 2130903241, 2130903242, 2130903244, 2130903245, 2130903246, 2130903247, 2130903248}; Snackbar = new int[]{2130903571, 2130903572}; SnackbarLayout = new int[]{16843039, 2130903072, 2130903082, 2130903098, 2130903284, 2130903503}; Spinner = new int[]{16842930, 16843126, 16843131, 16843362, 2130903532}; StateListDrawable = new int[]{16843036, 16843156, 16843157, 16843158, 16843532, 16843533}; StateListDrawableItem = new int[]{16843161}; SwitchCompat = new int[]{16843044, 16843045, 16843074, 2130903565, 2130903577, 2130903603, 2130903604, 2130903606, 2130903665, 2130903666, 2130903667, 2130903690, 2130903691, 2130903692}; SwitchMaterial = new int[]{2130903695}; TabItem = new int[]{16842754, 16842994, 16843087}; TabLayout = new int[]{2130903607, 2130903608, 2130903609, 2130903610, 2130903611, 2130903612, 2130903613, 2130903614, 2130903615, 2130903616, 2130903617, 2130903618, 2130903619, 2130903620, 2130903621, 2130903622, 2130903623, 2130903624, 2130903625, 2130903626, 2130903627, 2130903628, 2130903630, 2130903631, 2130903632}; TextAppearance = new int[]{16842901, 16842902, 16842903, 16842904, 16842906, 16842907, 16843105, 16843106, 16843107, 16843108, 16843692, 16844165, 2130903329, 2130903337, 2130903633, 2130903660}; TextInputLayout = new int[]{16842906, 16843088, 2130903125, 2130903126, 2130903127, 2130903128, 2130903129, 2130903130, 2130903131, 2130903132, 2130903133, 2130903134, 2130903249, 2130903250, 2130903251, 2130903252, 2130903253, 2130903254, 2130903288, 2130903289, 2130903290, 2130903291, 2130903292, 2130903293, 2130903297, 2130903298, 2130903299, 2130903300, 2130903301, 2130903302, 2130903344, 2130903345, 2130903346, 2130903347, 2130903351, 2130903352, 2130903353, 2130903354, 2130903525, 2130903526, 2130903527, 2130903528, 2130903529, 2130903557, 2130903560, 2130903580, 2130903581, 2130903582, 2130903583, 2130903584}; ThemeEnforcement = new int[]{16842804, 2130903294, 2130903295}; Toolbar = new int[]{16842927, 16843072, 2130903141, 2130903193, 2130903194, 2130903224, 2130903225, 2130903226, 2130903227, 2130903228, 2130903229, 2130903481, 2130903482, 2130903504, 2130903508, 2130903511, 2130903512, 2130903532, 2130903598, 2130903599, 2130903600, 2130903673, 2130903675, 2130903676, 2130903677, 2130903678, 2130903679, 2130903680, 2130903681, 2130903682}; View = new int[]{16842752, 16842970, 2130903519, 2130903520, 2130903662}; ViewBackgroundHelper = new int[]{16842964, 2130903101, 2130903102}; ViewPager2 = new int[]{16842948}; ViewStubCompat = new int[]{16842960, 16842994, 16842995}; } private R$styleable() { } } ä¸‹é¢æµ‹è¯•ä¸‹R.styleableç»“æœåœ¨classä¸­çš„ä½“ç°ï¼š å¯ä»¥çœ‹åˆ°åœ¨libä¸­å¼•ç”¨åˆ°çš„styleableæ•°ç»„å±æ€§è¢«æ›¿æ¢æˆä¸»moduleä¸­çš„å±æ€§äº†ã€‚libçš„R.classä¸­åªæœ‰R$styleableçš„æ•°ç»„å±æ€§ï¼Œå¹¶ä¸”åœ¨é™æ€ä»£ç å—ä¸­ã€‚\n","date":"2025-02-28T00:00:00Z","permalink":"http://xiangcman.xyz/p/booster%E5%8C%85%E4%BD%93%E7%A7%AF%E4%BC%98%E5%8C%96%E4%B9%8Br%E5%86%85%E8%81%94/","title":"boosteråŒ…ä½“ç§¯ä¼˜åŒ–ä¹‹Rå†…è”"},{"content":"åˆ›å»ºè„šæœ¬ é¦–å…ˆåœ¨ç»ˆç«¯ä¸‹åˆ›å»ºä¸€ä¸ªè„šæœ¬æ–‡ä»¶\n1 touch apkcompare ç»™è„šæœ¬èµ‹äºˆæ‰§è¡Œæƒé™ 1 chmod +x apkcompare æ‰“å¼€è„šæœ¬ ä½¿ç”¨zshä¸­è£…çš„sublimeæ’ä»¶æ‰“å¼€è„šæœ¬æ–‡ä»¶\n1 st apkcompare ç¼–è¾‘è„šæœ¬å†…å®¹ 1 2 3 4 5 6 7 #!/bin/bash echo \u0026#34;è¯·è¾“å…¥æ”¹å˜å‰çš„apkè·¯å¾„ï¼š\u0026#34; read path1 echo \u0026#34;è¯·è¾“å…¥æ”¹å˜åçš„apkè·¯å¾„ï¼š\u0026#34; read path2 cd /Users/xiangcheng/downloads java -jar apkcompare-1.0.jar $path1 $path2 compare_result_file æ‰§è¡Œè„šæœ¬ 1 ./apkcompare å¦‚ä½•å…¨å±€èƒ½æ‰§è¡Œè„šæœ¬ ä¸Šé¢æ‰§è¡Œè„šæœ¬è¦åˆ°æŒ‡å®šçš„ç›®å½•æ‰è¡Œï¼Œå¦‚æœæˆ‘æƒ³å…¨å±€éƒ½èƒ½è¿è¡Œè„šæœ¬çš„è¯ï¼Œå¯ä»¥é€šè¿‡é…ç½®è„šæœ¬çš„æ ¹ç›®å½•çš„ç¯å¢ƒå˜é‡ï¼Œæ¯”å¦‚æˆ‘çš„è„šæœ¬éƒ½æ”¾åœ¨äº†desktop/è„šæœ¬æ–‡ä»¶å¤¹ä¸­ï¼Œé‚£ä¹ˆæˆ‘å¯ä»¥åœ¨.zshrcä¸­é…ç½®å¦‚ä¸‹ï¼š\n1 export PATH=\u0026#34;$HOME/desktop/è„šæœ¬:$PATH\u0026#34; è¿™æ ·æˆ‘ä»¬å°±ç›´æ¥å¯ä»¥å…¨å±€è¿è¡Œè„šæœ¬ï¼Œæ¯”å¦‚æˆ‘è¿™é‡Œæœ‰ä¸ªjadxçš„è„šæœ¬ï¼Œåˆ™å¯ä»¥ç›´æ¥ç”¨å¦‚ä¸‹å‘½ä»¤å¯åŠ¨jadxå·¥å…·ï¼š\n1 jadx å°†è„šæœ¬å®šåˆ¶æˆåº”ç”¨ å¹³æ—¶ä½¿ç”¨shellè„šæœ¬çš„æ—¶å€™ï¼Œæ¯æ¬¡éƒ½è¦æ‰¾åˆ°shellè„šæœ¬çš„æ‰§è¡Œæ–‡ä»¶éå¸¸éº»çƒ¦ï¼Œç„¶åæƒ³åˆ°å¦‚æœèƒ½å°†shellè„šæœ¬åˆ¶ä½œæˆä¸€ä¸ªåº”ç”¨é‚£å°±éå¸¸niceäº†ã€‚ ä¸‹é¢å°±ä»¥å¹³æ—¶ç”¨çš„æ¯”è¾ƒå¤šçš„åç¼–è¯‘è„šæœ¬jadxä¸ºä¾‹æ¥å®è·µã€‚\nå…ˆé€šè¿‡Alfredå·¥å…·æœç´¢å‡ºæœ¬æœºçš„Automatorå·¥å…·ï¼š é€‰å–åº”ç”¨ç¨‹åº æ·»åŠ shellè„šæœ¬ åœ¨å·¦ä¾§æœç´¢ â€œè¿è¡Œ Shell è„šæœ¬â€ï¼ˆRun Shell Scriptï¼‰ã€‚ æ‹–åŠ¨åˆ°å³ä¾§å·¥ä½œåŒºã€‚ åœ¨ Shell é€‰é¡¹é‡Œï¼Œé€‰æ‹© /bin/bashï¼ˆæˆ– /bin/zshï¼‰ã€‚ åœ¨æ–‡æœ¬æ¡†é‡Œè¾“å…¥å¦‚ä¸‹ä»£ç ï¼š 1 2 #!/bin/bash /opt/homebrew/Cellar/jadx/1.5.1/bin/jadx-gui æˆ‘æ˜¯é€šè¿‡homebrewè£…çš„jadxå·¥å…·ï¼Œæ‰€ä»¥æŒ‡å®šä¸‹è‡ªå·±çš„jadxç›®å½•ã€‚\nä¿å­˜åº”ç”¨ ç»™åº”ç”¨å®šåˆ¶å›¾æ ‡ macä¸‹åº”ç”¨çš„å›¾æ ‡éƒ½æ˜¯é€šè¿‡åº”ç”¨ä¸‹çš„Info.plistæ–‡ä»¶æ¥æ§åˆ¶çš„ï¼š å®ƒæ˜¯é€šè¿‡CFBundleIconFileå­—æ®µæ§åˆ¶çš„ï¼Œè¿™é‡Œæˆ‘æŠŠå›¾æ ‡æ”¾åœ¨äº†åº”ç”¨çš„Resourcesæ–‡ä»¶ä¸‹ï¼š å¯ä»¥çœ‹åˆ°éœ€è¦ä¸€ä¸ª.icnsçš„æ–‡ä»¶ï¼Œè¿™é‡Œæˆ‘æ˜¯é€šè¿‡åœ¨çº¿ç½‘ç«™https://cloudconvert.com/png-to-icnsæ¥å®ç°png-\u0026gt;icnsçš„ã€‚ä¸€åˆ‡æ›¿æ¢å®Œåï¼Œè¿˜éœ€è¦åˆ·æ–° Launch Servicesï¼Œå¦åˆ™ macOS å¯èƒ½ä¸ä¼šç«‹åˆ»è¯†åˆ«æ–°å›¾æ ‡ï¼Œæ‰§è¡Œå¦‚ä¸‹è„šæœ¬ï¼š\n1 2 touch /Applications/Jadx.app killall Finder æˆ‘åœ¨chatgptæœç´¢çš„æ—¶å€™ï¼Œå®ƒæ˜¯é€šè¿‡touch ~/Applications/Jadx.appæ¥æ‰§è¡Œçš„ï¼Œä½†æ˜¯æˆ‘å‘ç°æˆ‘çš„Jadx.appæ˜¯åœ¨å¦‚ä¸‹ç›®å½•ï¼š æ‰€ä»¥ä¸ç”¨å®šä½åˆ°Users/ç”¨æˆ·åï¼Œè¦ä¸ç„¶ä¼šæŠ¥é”™æ‰¾ä¸åˆ°Jadxåº”ç”¨ã€‚è¿™é‡Œæä¸€å¥macä¸‹~è¡¨ç¤ºçš„ç›®å½•æ˜¯Users/ç”¨æˆ·åï¼Œæ¯”å¦‚æˆ‘çš„å¦‚ä¸‹ï¼š æ“ä½œå®Œåï¼Œä¸€ä¸ªå¸¦å›¾æ ‡çš„shellè„šæœ¬çš„åº”ç”¨å°±åˆ›å»ºæˆåŠŸäº†ã€‚\næˆ‘çš„è„šæœ¬å·¥å…·é›† apkæ¯”å¯¹è„šæœ¬ï¼š apkcompare\nå­—èŠ‚ç æŸ¥çœ‹è„šæœ¬ï¼š bytecode-viewer\næ‰¹é‡åˆ é™¤æŒ‡å®šåç¼€çš„å›¾ç‰‡è„šæœ¬ï¼š delete_images\nåç¼–è¯‘apkçš„è„šæœ¬ï¼š jadx\n","date":"2025-02-19T00:00:00Z","permalink":"http://xiangcman.xyz/p/mac%E4%B8%8B%E5%BF%AB%E9%80%9F%E5%86%99%E4%B8%80%E4%B8%AA%E8%84%9A%E6%9C%AC/","title":"macä¸‹å¿«é€Ÿå†™ä¸€ä¸ªè„šæœ¬"},{"content":"boosteræ˜¯åŸºäºgradle transformã€asmè¿›è¡Œå­—èŠ‚ç æ“ä½œçš„æ¡†æ¶ï¼Œå†…éƒ¨æœ‰å¾ˆå¤šgradle transformæ¥æ“ä½œå¯¹åº”çš„å­—èŠ‚ç ï¼Œé¦–å…ˆæˆ‘ä»¬å°†å¯¹åº”çš„æ’ä»¶ä¾èµ–è¿›æ¥ï¼Œæˆ‘ä»¬ä»¥toastæ’ä»¶æ›¿æ¢ä¸ºæµ‹è¯•ï¼Œçœ‹ä¸‹æ•ˆæœ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 buildscript { ext { plugin_version = \u0026#34;0.3.0\u0026#34; booster_version = \u0026#34;1.0.0\u0026#34; } // ext.plugin_version = \u0026#34;0.3.0\u0026#34; repositories { google() jcenter() maven { url \u0026#34;https://artifact.bytedance.com/repository/byteX/\u0026#34; } } dependencies { classpath \u0026#39;com.android.tools.build:gradle:3.5.3\u0026#39; //booster classpath \u0026#34;com.didiglobal.booster:booster-gradle-plugin:$booster_version\u0026#34; //booster toastæ’ä»¶ classpath \u0026#34;com.didiglobal.booster:booster-transform-toast:$booster_version\u0026#34; //bytex base // classpath \u0026#34;com.bytedance.android.byteX:base-plugin:${plugin_version}\u0026#34; // Add bytex plugins\u0026#39; dependencies on demand. æŒ‰éœ€æ·»åŠ æ’ä»¶ä¾èµ– // classpath \u0026#34;com.bytedance.android.byteX:method-call-opt-plugin:${plugin_version}\u0026#34; // NOTE: Do not place your application dependencies here; they belong // in the individual module build.gradle files } } ç„¶åä½¿ç”¨æ’ä»¶ï¼š\n1 2 apply plugin: \u0026#39;com.android.application\u0026#39; apply plugin: \u0026#39;com.didiglobal.booster\u0026#39; // â‘¢ åœ¨MainActivityä¸­æ·»åŠ å¦‚ä¸‹ä»£ç ï¼š ç„¶åçœ‹ç¼–è¯‘åçš„ç±»ï¼Œè¿™é‡Œæœ‰ä¸ªç»†èŠ‚ï¼Œå¤§å®¶å¾—ç†Ÿæ‚‰æ‰“åŒ…æµç¨‹ï¼Œjavacç¼–è¯‘æˆclassåï¼Œç„¶åæŠŠclassè½¬åŒ–æˆdexæ–‡ä»¶ï¼Œtransformå°±æ˜¯ä½œç”¨äºclassè½¬æˆdexä¹‹é—´ï¼Œæ‰€ä»¥å¦‚æœçœ‹javacä¹‹åçš„classæ˜¯çœ‹ä¸åˆ°æœ€ç»ˆtoastæ’ä»¶ä½œç”¨çš„æ•ˆæœï¼Œéœ€è¦åç¼–è¯‘çœ‹æœ€ç»ˆçš„apkæˆ–è€…dexæ–‡ä»¶ï¼š å¯ä»¥çœ‹åˆ°æ­¤æ—¶æ˜¯æ›¿æ¢æˆäº†ShadowToastä¸­çš„showæ–¹æ³•äº†ã€‚ä¸‹é¢ç»“åˆæºç çœ‹ä¸‹boosterå¦‚ä½•åšåˆ°classæ›¿æ¢çš„ï¼Œæœ¬æ¬¡é€šè¿‡gradleä¸‹è½½çš„æ’ä»¶æºç æ¥åˆ†æï¼Œboosteræ’ä»¶ä¸‹è½½çš„åœ°å€åœ¨/Users/xiangcheng/.gralde/cache/modules-2/files-2.1/com.didiglobal.boosterä¸‹ï¼š booster-gradle-plugin æ˜¯boosterå®šä¹‰æ’ä»¶çš„æ¨¡å—ï¼Œä¸‹é¢æ‰“å¼€å®ƒçš„æºç ï¼Œæ‰¾åˆ°å®ƒçš„pluginï¼š boosteræ’ä»¶å¯¹åº”çš„ç±»åæ˜¯com.didiglobal.booster.gradle.BoosterPlugin:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 package com.didiglobal.booster.gradle import com.android.build.gradle.AppExtension import com.android.build.gradle.LibraryExtension import com.didiglobal.booster.task.spi.VariantProcessor import org.gradle.api.Plugin import org.gradle.api.Project import java.util.ServiceLoader /** * Represents the booster gradle plugin * * @author johnsonlee */ class BoosterPlugin : Plugin\u0026lt;Project\u0026gt; { override fun apply(project: Project) { when { //å¦‚æœä¾èµ–boosteræ’ä»¶çš„moduleæ˜¯applicationç±»å‹ project.plugins.hasPlugin(\u0026#34;com.android.application\u0026#34;) || project.plugins.hasPlugin(\u0026#34;com.android.dynamic-feature\u0026#34;) -\u0026gt; project.getAndroid\u0026lt;AppExtension\u0026gt;().let { android -\u0026gt; //æ³¨å†ŒBoosterAppTransform android.registerTransform(BoosterAppTransform()) //project.afterEvaluateç›‘å¬moduleé…ç½®é˜¶æ®µå®Œæˆå project.afterEvaluate { //é€šè¿‡ServiceLoaderæ¥æ‰¾åˆ°æ‰€æœ‰çš„VariantProcessorå­ç±»ï¼Œå®ƒæ˜¯spiæ¨¡å—ä¸­å®šä¹‰çš„ ServiceLoader.load(VariantProcessor::class.java, javaClass.classLoader).toList().let { processors -\u0026gt; //é¦–å…ˆéå†åº”ç”¨ä¸­æ‰€æœ‰çš„å˜ä½“ android.applicationVariants.forEach { variant -\u0026gt; //éå†æ‰€æœ‰çš„VariantProcessorï¼ŒæŠŠå˜ä½“ä¼ åˆ°VariantProcessorçš„processæ–¹æ³•ä¸­ processors.forEach { processor -\u0026gt; processor.process(variant) } } } } } //å¦‚æœä¾èµ–boosteræ’ä»¶çš„moduleæ˜¯libraryç±»å‹ project.plugins.hasPlugin(\u0026#34;com.android.library\u0026#34;) -\u0026gt; project.getAndroid\u0026lt;LibraryExtension\u0026gt;().let { android -\u0026gt; //BoosterLibTransform android.registerTransform(BoosterLibTransform()) project.afterEvaluate { ServiceLoader.load(VariantProcessor::class.java, javaClass.classLoader).toList().let { processors -\u0026gt; android.libraryVariants.forEach { variant -\u0026gt; processors.forEach { processor -\u0026gt; processor.process(variant) } } } } } } } } æˆ‘ä»¬åªçœ‹å½“å‰moduleæ˜¯applicationç±»å‹çš„ï¼Œlibraryç±»å‹çš„moduleå¤„ç†åŸºæœ¬ä¸€è‡´ã€‚é¦–å…ˆæ³¨å†ŒBoosterAppTransformï¼Œç„¶åç›‘å¬projecté…ç½®é˜¶æ®µå®Œæˆï¼Œç„¶åé€šè¿‡ServiceLoaderæ‰¾åˆ°æ‰€æœ‰çš„VariantProcessorå­ç±»ï¼Œå®ƒæ˜¯task.spiæ¨¡å—ä¸‹çš„ä¸€ä¸ªæ¥å£ï¼Œç„¶åè°ƒç”¨æ‰€æœ‰å­ç±»çš„processæ–¹æ³•ï¼Œå…ˆæ¥çœ‹ä¸‹VariantProcessoræ¥å£çš„å®šä¹‰ï¼š\n1 2 3 4 5 6 7 8 9 package com.didiglobal.booster.task.spi import com.android.build.gradle.api.BaseVariant interface VariantProcessor { fun process(variant: BaseVariant) } æ¯”å¦‚åœ¨toastæ¨¡å—ä¸‹æœ‰å¦‚ä¸‹å­ç±»ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 package com.didiglobal.booster.transform.toast import com.android.build.gradle.api.BaseVariant import com.android.build.gradle.api.LibraryVariant import com.didiglobal.booster.gradle.isDynamicFeature import com.didiglobal.booster.gradle.scope import com.didiglobal.booster.gradle.variantData import com.didiglobal.booster.task.spi.VariantProcessor import com.google.auto.service.AutoService @AutoService(VariantProcessor::class) class ToastVariantProcessor : VariantProcessor { override fun process(variant: BaseVariant) { //å¦‚æœå˜ä½“ä¸æ˜¯LibraryVariantï¼ŒLibraryVariantåªå‡ºç°åœ¨libraryçš„moduleä¸­ï¼Œå¹¶ä¸”å˜ä½“ä¸æ˜¯ä¸€ä¸ªåŠ¨æ€æ¨¡å—ï¼ŒåŠ¨æ€æ¨¡å—æ˜¯Android App Bundle(.aab)ç»“æ„ä¸­ä¸€çš„ä¸€éƒ¨åˆ†ï¼Œå…è®¸æŒ‰éœ€ä¸‹è½½å’Œå®‰è£…æ¨¡å—ï¼Œç„¶åæ·»åŠ instrument-toastçš„aarä¾èµ– if (variant !is LibraryVariant \u0026amp;\u0026amp; !variant.variantData.isDynamicFeature()) { variant.scope.globalScope.project.dependencies.add(\u0026#34;implementation\u0026#34;, \u0026#34;${Build.GROUP}:booster-android-instrument-toast:${Build.VERSION}\u0026#34;) } } } é€šè¿‡AutoServiceæ³¨è§£æ‰¾åˆ°ToastVariantProcessorè¿™ä¸ªå­ç±»ï¼Œè€Œä¸Šé¢åˆ†æboosterPluginçš„æ—¶å€™ï¼ŒVariantProcessorçš„processæ–¹æ³•æ˜¯åœ¨é…ç½®å®Œåè°ƒç”¨çš„ï¼Œä¹Ÿå°±æ˜¯æ¯ä¸€ä¸ªmoduleçš„build.gradleè§£æå®Œäº‹ä¹‹åã€‚ToastVariantProcessorä¸­çš„processæ–¹æ³•åˆ¤æ–­å¦‚æœå˜ä½“ä¸æ˜¯LibraryVariantï¼ŒLibraryVariantåªå‡ºç°åœ¨libraryçš„moduleä¸­ï¼Œå¹¶ä¸”å˜ä½“ä¸æ˜¯ä¸€ä¸ªåŠ¨æ€æ¨¡å—ï¼ŒåŠ¨æ€æ¨¡å—æ˜¯Android App Bundle(.aab)ç»“æ„ä¸­ä¸€çš„ä¸€éƒ¨åˆ†ï¼Œå…è®¸æŒ‰éœ€ä¸‹è½½å’Œå®‰è£…æ¨¡å—ï¼Œç„¶åæ·»åŠ instrument-toastçš„aarä¾èµ–ã€‚\næ¥çœ‹ä¸‹booster-android-instrument-toastçš„ä¸»è¦æ„æˆï¼š è¿™ä¸å°±æ˜¯ä¸Šé¢è¦å°†Toastçš„è°ƒç”¨è¦æ›¿æ¢æˆç›®æ ‡ShadowToastç±»å—ï¼Ÿæ‰€ä»¥ä¸éš¾çœ‹å‡ºï¼Œå…¶å®å¯¹åº”çš„booster-android-instrument-toastæ¨¡å—å°±æ˜¯å°†ShadowToastå¼•å…¥è¿›æ¥ï¼Œæ–¹ä¾¿asmæ“ä½œå­—èŠ‚ç çš„æ—¶å€™èƒ½å¤Ÿæ›¿æ¢ï¼Œä¸‹é¢æ¥çœ‹ä¸‹å¦‚ä½•æ›¿æ¢çš„å­—èŠ‚ç ã€‚\næˆ‘ä»¬å›åˆ°ä¸Šé¢æ³¨å†Œçš„BoosterAppTransformï¼Œå®ƒæ˜¯æ ¸å¿ƒæµç¨‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 package com.didiglobal.booster.gradle import com.android.build.api.transform.QualifiedContent /** * Represents android transform for application project * * @author johnsonlee */ class BoosterAppTransform : BoosterTransform() { override fun getScopes(): MutableSet\u0026lt;in QualifiedContent.Scope\u0026gt; = SCOPE_FULL_WITH_FEATURES } å®ƒæ˜¯ç»§æ‰¿è‡ªBoosterTransformï¼Œæ‰€ä»¥æ¥ç€çœ‹BoosterTransformçš„transformæ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 final override fun transform(invocation: TransformInvocation?) { invocation?.let { //BoosterTransformInvocationæ˜¯ä¸€ä¸ªä»£ç†ç±» BoosterTransformInvocation(it).apply { //â‘  dumpInputs(this) //â‘¡ if (isIncremental) { //â‘¢ onPreTransform(this) doIncrementalTransform() } else { buildDir.file(AndroidProject.FD_INTERMEDIATES, \u0026#34;transforms\u0026#34;, \u0026#34;dexBuilder\u0026#34;).let { dexBuilder -\u0026gt; if (dexBuilder.exists()) { dexBuilder.deleteRecursively() } } outputProvider.deleteAll() onPreTransform(this) doFullTransform() } //â‘£ this.onPostTransform(this) }.executor.apply { shutdown() awaitTermination(1, TimeUnit.MINUTES) } } } //å°†æ‰«æåˆ°çš„jarå†™åˆ°inputs.txtæ–‡ä»¶ä¸­ private fun dumpInputs(invocation: BoosterTransformInvocation) { //invocation.context.temporaryDirï¼šè·å–å½“å‰transformçš„ä¸´æ—¶ç›®å½•ï¼Œç„¶ååˆ›å»ºinputs.txtæ–‡ä»¶ invocation.context.temporaryDir.file(\u0026#34;inputs.txt\u0026#34;).touch().printWriter().use { printer -\u0026gt; invocation.inputs.flatMap { it.jarInputs }.map { it.file }.forEach(printer::println) } } åœ¨transformæ–¹æ³•ä¸­TransformInvocationå¯¹è±¡æ˜¯Transformæ ¸å¿ƒç±»ï¼Œå®ƒæ˜¯è·å–æ‰€æœ‰classå’Œè¾“å‡ºclassçš„å¤„ç†ç±»ã€‚æ¥ç€å°†TransformInvocationä»£ç†åˆ°äº†BoosterTransformInvocationä¸­ï¼Œå®ƒæ˜¯ä¸€ä¸ªé™æ€ä»£ç†æ¨¡å¼ã€‚åœ¨â‘ å¤„ï¼ŒdumpInputsæ–¹æ³•å°†é¡¹ç›®ä¸­ä½¿ç”¨åˆ°çš„jaréƒ½æ‰“å°åˆ°transformçš„ä¸´æ—¶ç›®å½•ä¸­çš„inputs.txtä¸­ï¼š ä¸çŸ¥é“è¿™ä¸ªæ˜¯å¹²å˜›çš„ï¼Œå¯èƒ½æ˜¯ä¸ºäº†è®°å½•æ‰€æœ‰çš„jarå§ã€‚åœ¨â‘¡å¤„ï¼Œåˆ¤æ–­æ˜¯ä¸æ˜¯å¢é‡ç¼–è¯‘ï¼Œé»˜è®¤æ˜¯å¢é‡çš„ï¼Œåœ¨â‘¢å¤„ï¼Œè°ƒç”¨äº†BoosterTransformInvocationçš„onPreTransformï¼Œæ¥ç€è°ƒç”¨äº†doIncrementalTransformï¼Œåœ¨â‘£å¤„ï¼Œè°ƒç”¨äº†onPostTransformï¼Œè¿™äº›éƒ½æ˜¯BoosterTransformInvocationçš„æ–¹æ³•ï¼Œæ³¨æ„äº†æœ€åæ˜¯è°ƒç”¨äº†executorçš„shutdownå’ŒawaitTerminationæ–¹æ³•ã€‚æ­¤å¤„çš„executoræ˜¯ä¸€ä¸ªForkJoinPoolã€‚æ‰€ä»¥é‡ç‚¹æ¥åˆ°BoosterTransformInvocationï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 internal class BoosterTransformInvocation(private val delegate: TransformInvocation) : TransformInvocation, TransformContext, TransformListener, ArtifactManager { /* * Preload transformers as List to fix NoSuchElementException caused by ServiceLoader in parallel mode */ private val transformers = ServiceLoader.load(Transformer::class.java, javaClass.classLoader).toList() override fun onPreTransform(context: TransformContext) = transformers.forEach { it.onPreTransform(this) } @Suppress(\u0026#34;NON_EXHAUSTIVE_WHEN\u0026#34;) internal fun doIncrementalTransform() { //â‘  this.inputs.parallelStream().forEach { input -\u0026gt; //â‘¡ input.jarInputs.parallelStream().filter { it.status != NOTCHANGED }.forEach { jarInput -\u0026gt; when (jarInput.status) { REMOVED -\u0026gt; jarInput.file.delete() CHANGED, ADDED -\u0026gt; { //â‘¢ val root = outputProvider.getContentLocation(jarInput.name, jarInput.contentTypes, jarInput.scopes, Format.JAR) project.logger.info(\u0026#34;Transforming ${jarInput.file}\u0026#34;) //â‘£ jarInput.file.transform(root) { bytecode -\u0026gt; //â‘¤ bytecode.transform(this) } } } } input.directoryInputs.parallelStream().forEach { dirInput -\u0026gt; val base = dirInput.file.toURI() dirInput.changedFiles.ifNotEmpty { it.forEach { file, status -\u0026gt; when (status) { REMOVED -\u0026gt; file.delete() ADDED, CHANGED -\u0026gt; { val root = outputProvider.getContentLocation(dirInput.name, dirInput.contentTypes, dirInput.scopes, Format.DIRECTORY) project.logger.info(\u0026#34;Transforming $file\u0026#34;) file.transform(File(root, base.relativize(file.toURI()).path)) { bytecode -\u0026gt; bytecode.transform(this) } } } } } } } } private fun ByteArray.transform(invocation: BoosterTransformInvocation): ByteArray { return transformers.fold(this) { bytes, transformer -\u0026gt; transformer.transform(invocation, bytes) } } override fun onPostTransform(context: TransformContext) = transformers.forEach { it.onPostTransform(this) } } è¿™é‡Œæˆ‘æŠŠå‡ ä¸ªé‡ç‚¹æ–¹æ³•ç»™æ¬è¿‡æ¥äº†ï¼ŒBoosterTransformInvocationç»§æ‰¿è‡ªTransformInvocationï¼Œè€Œæ„é€ å™¨ä¸­ä¼ å…¥äº†BoosterTransformä¸­çš„TransformInvocationï¼Œæœ€ç»ˆä»£ç†åˆ°äº†è¿™ä¸ªTransformInvocationã€‚åœ¨onPreTransformä¸­éå†Transformerï¼Œç„¶åè°ƒç”¨onPreTransformã€‚ åœ¨doIncrementalTransformçš„â‘ å¤„ä¸­é€šè¿‡parallelStreaméå†TransformInputé›†åˆï¼Œå…¶ä¸­parallelStreamæ˜¯é›†åˆæµçš„ä¸€ç§å¤„ç†æ–¹å¼ï¼Œå®ƒèƒ½å¹¶è¡Œéå†å¯¹è±¡ï¼Œä¸€èˆ¬é€‚åˆå¤§é‡æ•°æ®çš„æ—¶å€™ï¼Œåœ¨â‘¡å¤„éå†TransformInputä¸­çš„jarInputsï¼Œå¦‚æœæ˜¯REMOVEDçŠ¶æ€åˆ™ç›´æ¥åˆ é™¤ï¼Œå¦‚æœæ˜¯æ›´æ–°ã€æ·»åŠ çŠ¶æ€ï¼Œåˆ™ä¼šèµ°åˆ°â‘¢å¤„ï¼Œé€šè¿‡TransformOutputProviderè·å–åˆ°jarçš„è¾“å‡ºè·¯å¾„ã€‚åœ¨â‘£å¤„æ‹¿åˆ°jarçš„fileå¯¹è±¡ï¼Œç„¶åè°ƒç”¨æ‰©å±•çš„transformï¼Œè·å–åˆ°jarä¸­çš„byteArrayã€‚ç»è¿‡â‘¤å¤„çš„byteArrayçš„transformæ“ä½œåï¼Œä¹Ÿå°±æ˜¯å­—èŠ‚ç æ“ä½œï¼Œç„¶ååœ¨jarçš„transformä¸­å†å†™å›åˆ°â‘¢ä¸­çš„rootä¸­ã€‚ä¸‹é¢çœ‹ä¸‹Fileçš„transformæ‰©å±•æ–¹æ³•æ˜¯å¦‚ä½•è·å–åˆ°byteArrayï¼Œå¹¶å›å†™åˆ°rootä¸­ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 /** * Transform this file or directory to the output by the specified transformer * * @param output The output location * @param transformer The byte data transformer */ fun File.transform(output: File, transformer: (ByteArray) -\u0026gt; ByteArray = { it -\u0026gt; it }) { when { isDirectory -\u0026gt; { val base = this.toURI() this.search().forEach { it.transform(File(output, base.relativize(it.toURI()).path), transformer) } } isFile -\u0026gt; { when (output.extension.toLowerCase()) { //å¦‚æœå½“å‰fileæ˜¯ä¸€ä¸ªjarï¼Œâ‘  \u0026#34;jar\u0026#34; -\u0026gt; JarFile(this).use { //â‘¡ it.transform(output, ::JarArchiveEntry, transformer) } //å¦‚æœå½“å‰fileæ˜¯ä¸€ä¸ªclassï¼Œâ‘¢ \u0026#34;class\u0026#34; -\u0026gt; inputStream().use { logger.info(\u0026#34;Transforming ${this.absolutePath}\u0026#34;) //â‘£ it.transform(transformer).redirect(output) } else -\u0026gt; this.copyTo(output, true) } } else -\u0026gt; TODO(\u0026#34;Unexpected file: ${this.absolutePath}\u0026#34;) } } æ•´ä¸ªtransformæ–¹æ³•ï¼Œæœ‰ä¸¤ä¸ªå‚æ•°ä¸€ä¸ªæ˜¯ç›®æ ‡è·¯å¾„ï¼Œç¬¬äºŒä¸ªå‚æ•°å°±æ˜¯å­—èŠ‚ç æ“ä½œçš„é—­åŒ…ã€‚é—­åŒ…è¿”å›çš„æ˜¯ByteArrayï¼Œä¹Ÿå°±æ˜¯ä¿®æ”¹å‰çš„å­—èŠ‚ç æ•°æ®ã€‚ åœ¨â‘ å¤„ï¼Œå¦‚æœå½“å‰Fileæ˜¯ä¸€ä¸ªjarçš„æ—¶å€™ï¼Œä¼šåˆå§‹åŒ–ä¸€ä¸ªJarFileï¼Œç„¶åè°ƒç”¨useæ‰©å±•å‡½æ•°ï¼Œå…¶ä¸­useæ–¹æ³•æ˜¯å¯¹Closeableç±»å‹åšçš„å¼‚å¸¸å¤„ç†ï¼Œæµçš„å…³é—­å¤„ç†ã€‚åœ¨â‘¡å¤„è°ƒç”¨JarFileçš„transformæ‰©å±•å‡½æ•°ï¼Œå…¶ä¸­JarFileæ˜¯ZipFileçš„å­ç±»ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 fun ZipFile.transform(output: File, entryFactory: (ZipEntry) -\u0026gt; ZipArchiveEntry = ::ZipArchiveEntry, transformer: (ByteArray) -\u0026gt; ByteArray = { it -\u0026gt; it }) { //â‘  val creator = ParallelScatterZipCreator(Executors.newWorkStealingPool()) val entries = mutableSetOf\u0026lt;String\u0026gt;() //â‘¡ entries().asSequence().forEach { entry -\u0026gt; //â‘¢ if (!entries.contains(entry.name)) { //â‘£ val zae = entryFactory(entry) //â‘¤ val stream = InputStreamSupplier { when (entry.name.substringAfterLast(\u0026#39;.\u0026#39;, \u0026#34;\u0026#34;)) { //â‘¥ \u0026#34;class\u0026#34; -\u0026gt; getInputStream(entry).use { src -\u0026gt; logger.info(\u0026#34;Transforming ${this.name}!/${entry.name}\u0026#34;) src.transform(transformer).inputStream() } //â‘¦ else -\u0026gt; getInputStream(entry) } } //â‘§ creator.addArchiveEntry(zae, stream) entries.add(entry.name) } else { logger.error(\u0026#34;Duplicated jar entry: ${this.name}!/${entry.name}\u0026#34;) } } //â‘¨ ZipArchiveOutputStream(output.touch()).use { it -\u0026gt; creator.writeTo(it) } } åœ¨â‘ å¤„åˆ›å»ºParallelScatterZipCreatorï¼Œå®ƒæ˜¯å¤šçº¿ç¨‹å¹¶è¡Œå‹ç¼©å¤šä¸ªæ–‡ä»¶ï¼Œç„¶åå†åˆå¹¶åˆ°ä¸€ä¸ªæ€»çš„å‹ç¼©æ–‡ä»¶ä¸­ï¼Œå¸¸è§çš„ZipOutputStreamæ˜¯å•çº¿ç¨‹è¿›è¡Œå‹ç¼©æ‰€æœ‰çš„æ–‡ä»¶ã€‚åœ¨â‘¡å¤„æ‹¿åˆ°ZipFileçš„entriesæ•°ç»„ï¼Œç„¶åè°ƒç”¨asSequenceè¿›è¡Œéå†ï¼Œentriesæ–¹æ³•æ˜¯ä¸€ä¸ªZipEntryIteratorå¯¹è±¡ï¼Œå…¶å®å®ƒä¹Ÿæœ‰toListæ–¹æ³•ï¼Œåœ¨æ­¤å¤„éƒ½æ˜¯éå†ï¼Œå…¶å®å’Œlistæ²¡æœ‰åŒºåˆ«ï¼ŒSequenceåŒºåˆ«æ˜¯åœ¨å¤„ç†ä¸­é—´æ“ä½œç¬¦çš„æ—¶å€™ä¸ä¼šåˆ›å»ºä¸´æ—¶çš„é›†åˆå¯¹è±¡ï¼Œæ¯”å¦‚mapï¼Œfilterç­‰ã€‚åœ¨â‘¢ä¸»è¦æ˜¯å»é‡ï¼Œåœ¨â‘£å¤„å°†ZipEntryè½¬åŒ–æˆZipArchiveEntryï¼Œæ–¹ä¾¿ç»™åˆ°ParallelScatterZipCreatorã€‚åœ¨â‘¤å¤„æ„å»ºInputStreamSupplierï¼Œå®ƒæ˜¯ä¸€ä¸ªæ¥å£ï¼Œåœ¨getæ–¹æ³•ä¸­è¿”å›InputStreamï¼Œæ–¹ä¾¿ä½¿ç”¨é—­åŒ…ã€‚åœ¨â‘¥å¤„é€šè¿‡ZipEntryè·å–åˆ°å¯¹åº”çš„inputStreamï¼Œç„¶åè°ƒç”¨srcï¼ˆinputStreamï¼‰çš„transformæ‰©å±•æ–¹æ³•ï¼Œå¹¶æŠŠtransformeré—­åŒ…ä¼ å…¥å…¶ä¸­ï¼š\n1 2 3 fun InputStream.transform(transformer: (ByteArray) -\u0026gt; ByteArray): ByteArray { return transformer(readBytes()) } å¯ä»¥çœ‹åˆ°é€šè¿‡InputStreamçš„readBytesæ‰©å±•æ–¹æ³•è·å–åˆ°ByteArrayï¼š\n1 2 3 4 5 private fun InputStream.readBytes(estimatedSize: Int = DEFAULT_BUFFER_SIZE): ByteArray { val buffer = ByteArrayOutputStream(Math.max(estimatedSize, this.available())) copyTo(buffer) return buffer.toByteArray() } å…¶ä¸­æœ€ç»ˆé€šè¿‡æ„é€ ByteArrayOutputStreamå¯¹è±¡ï¼Œç„¶åè°ƒç”¨InputStreamçš„copyToæ‰©å±•æ–¹æ³•å°†bufferå¤åˆ¶åˆ°ByteArrayOutputStreamä¸­L\n1 2 3 4 5 6 7 8 9 10 11 private fun InputStream.copyTo(out: OutputStream, bufferSize: Int = DEFAULT_BUFFER_SIZE): Long { var bytesCopied: Long = 0 val buffer = ByteArray(bufferSize) var bytes = read(buffer) while (bytes \u0026gt;= 0) { out.write(buffer, 0, bytes) bytesCopied += bytes bytes = read(buffer) } return bytesCopied } è·å–åˆ°fileçš„byteArrayåï¼Œäº¤ç»™äº†transformerè¿›è¡Œä¿®æ”¹å­—èŠ‚ç ï¼Œå‰©ä¸‹å°±æ˜¯å†™å›åˆ°ç›®æ ‡è·¯å¾„ä¸­ï¼Œå›åˆ°ä¸Šé¢ZipFileçš„transformâ‘¥å¤„ï¼Œæœ€ç»ˆå°†ByteArrayé€šè¿‡inputStreamæ‰©å±•æ–¹æ³•è½¬åŒ–æˆ ByteArrayInputStreamï¼š\n1 2 @kotlin.internal.InlineOnly public inline fun ByteArray.inputStream(): ByteArrayInputStream = ByteArrayInputStream(this) æ‰€ä»¥æœ€ç»ˆçš„ByteArrayInputStreamç»™åˆ°äº†â‘¤å¤„InputStreamSupplierçš„getæ–¹æ³•è¿”å›å€¼äº†ã€‚åœ¨â‘¦ä¸­ï¼Œå¦‚æœä¸æ˜¯classç±»å‹çš„entryï¼Œåˆ™ä¸è¿›è¡Œtransformçš„é—­åŒ…ä¿®æ”¹ã€‚åœ¨â‘§å¤„å°†ä¿®æ”¹åçš„InputStreamæ·»åŠ åˆ°ParallelScatterZipCreatorä¸­ï¼Œå¹¶æ·»åŠ åˆ°entriesé›†åˆä¸­ï¼Œæ–¹ä¾¿å»é‡ã€‚åœ¨â‘¨å¤„ï¼Œé€šè¿‡ZipArchiveOutputStreamçš„è¾“å‡ºæµå›å†™åˆ°outputç›®æ ‡æ–‡ä»¶ä¸­ã€‚æ•´ä¸ªä¿®æ”¹å¹¶å›å†™è¿‡ç¨‹åˆ†ä¸ºè¿™9å¤§æ­¥éª¤ã€‚å…³äºfileæ˜¯ç›®å½•ç»“æ„å’Œéç›®å½•ç»“æ„ä¸­çš„classæ–‡ä»¶å¤„ç†å°±ä¸è¯´äº†ï¼Œä»£ç å¾ˆç®€å•ã€‚\nBoosterTransformInvocationä¸­å…¨é‡ç¼–è¯‘è¿‡ç¨‹å°±ä¸åˆ†æäº†ï¼Œå’Œå¢é‡ç¼–è¯‘å¤§å·®ä¸å·®ã€‚\nå°ç»“ï¼š boosterä¸­ä¿®æ”¹å­—èŠ‚ç è¿‡ç¨‹æ˜¯åœ¨BoosterTransformInvocationä¸­ï¼Œå®ƒå°†å…·ä½“çš„ä¿®æ”¹äº¤ç»™äº†Transformerçš„å­ç±»ï¼Œå…¶ä¸­ä¿®æ”¹æ­¥éª¤æ˜¯å…ˆéå†TransformInputä¸­JarInputå’ŒdirectoryInputçš„classæ–‡ä»¶ï¼Œç„¶åè·å–åˆ°classçš„byteArrayï¼Œç„¶åç»è¿‡Transformerå­ç±»çš„transformæ–¹æ³•ä¿®æ”¹byteArrayï¼Œä¿®æ”¹å®Œåï¼Œå†å›å†™åˆ°åŸå§‹classå¯¹åº”çš„ç›®å½•ä¸­ï¼Œè¿™æ ·å°±è¾¾åˆ°äº†ä¿®æ”¹å¹¶è¦†ç›–classçš„ç›®çš„ã€‚\nbooster-transform-asm å‰é¢åˆ†æäº†boosterPluginä¸­ä¼šéå†Transformçš„å­ç±»ç„¶åæ‰§è¡Œå®ƒçš„transformæ–¹æ³•ï¼Œå…¶ä¸­AsmTransformeræ˜¯å®ç°äº†Transformeræ¥å£ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 @AutoService(Transformer::class) class AsmTransformer : Transformer { /* * Preload transformers as List to fix NoSuchElementException caused by ServiceLoader in parallel mode */ private val transformers = ServiceLoader.load(ClassTransformer::class.java, javaClass.classLoader).toList() override fun transform(context: TransformContext, bytecode: ByteArray): ByteArray { return ClassWriter(ClassWriter.COMPUTE_MAXS).also { writer -\u0026gt; transformers.fold(ClassNode().also { klass -\u0026gt; ClassReader(bytecode).accept(klass, 0) }) { klass, transformer -\u0026gt; transformer.transform(context, klass) }.accept(writer) }.toByteArray() } override fun onPreTransform(context: TransformContext) { transformers.forEach { it.onPreTransform(context) } } override fun onPostTransform(context: TransformContext) { transformers.forEach { it.onPostTransform(context) } } } AsmTransformeré€šè¿‡AutoServiceæ³¨è§£è¢«æ‰«æåˆ°æ˜¯Transformerçš„å­ç±»ï¼Œæˆ‘ä»¬å°†å®ƒçš„transformå†™æˆå¦‚ä¸‹æ–¹å¼ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 override fun transform(context: TransformContext, bytecode: ByteArray): ByteArray { // ClassNodeæ˜¯ASM tree APIçš„ç±» var classNode = ClassNode() val classReader = ClassReader(bytecode) // accept()æ–¹æ³•ï¼Œè¯»å–bytecodeçš„ç›¸å…³.classä¿¡æ¯èµ‹å€¼åˆ°classNodeå¯¹è±¡çš„ç›¸åº”å­—æ®µ classReader.accept(classNode,0) transformers.foreach { transformer -\u0026gt; // æ¯æ¬¡transformåï¼Œclassçš„å†…å®¹å˜åŒ–éƒ½ç¼“å­˜åœ¨classNodesä¸­ // æ³¨æ„æ­¤æ—¶çš„classNodeå¯¹è±¡çš„å†…å®¹å°±æ˜¯bytecodeçš„å†…å®¹ï¼Œåªæ˜¯æ ¼å¼ä¸åŒè€Œå·² transformer.transform(context, classNode) } //ClassWriteræ˜¯ASM core APIçš„ç±» ï¼Œä¸“é—¨ç”¨æ¥å†™å‡ºä¿®æ”¹åclassçš„ç±» val classWriter = ClassWriter(ClassWriter.COMPUTE_MAXS) //å°†å†™å¥½åçš„classNodeå›å†™åˆ°classWriterä¸­ classNode.accept(classWriter) // classWriteræŠŠè¢«æ´—ç¤¼åçš„classNodeï¼Œå³ClassNodeå¯¹è±¡ï¼Œ // å†™æˆByteArrayè¿”å›åˆ°ä¸Šå±‚BoosterTransformInvocation return classWriter.toByteArray() } å°ç»“: å¯ä»¥å‘ç°asmå­—èŠ‚ç æ“ä½œï¼ŒåŸºæœ¬éƒ½æ˜¯æ¨¡ç‰ˆä»£ç ï¼Œé¦–å…ˆé€šè¿‡classReaderè¯»å–åˆ°byteArrayï¼ˆåœ¨å‰é¢å­¦ä¹ asmçš„æ—¶å€™ï¼Œæ˜¯é€šè¿‡FileInputStreamæ¥è¯»å–çš„ï¼‰ï¼Œç„¶åæŠŠclassä¿¡æ¯æ˜ å°„åˆ°classNodeå¯¹è±¡ä¸Šã€‚ç„¶åéå†å­—èŠ‚ç æ“ä½œç±»ï¼Œå°†è¦ä¿®æ”¹çš„classNodeç»™åˆ°æ“ä½œç±»ï¼Œä¿®æ”¹å®Œåï¼Œå°†classNodeåŒæ­¥åˆ°classWriterä¸Šï¼Œæœ€åæŠŠä¿®æ”¹åçš„byteArrayå›å†™åˆ°ä¸Šå±‚ä¸­ã€‚\nbooster-transform-toast ä¸Šé¢åˆ†æè¿‡ä¼šé€šè¿‡ClassTransformerçš„å­ç±»æ¥ä¿®æ”¹å­—èŠ‚ç ï¼Œtoastå­—èŠ‚ç çš„ä¿®æ”¹æ˜¯åœ¨ToastTransformerè¿™ä¸ªå­ç±»ä¸­ï¼Œä¸»è¦æ¥çœ‹ä¸‹å®ƒçš„transformæ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 private const val TOAST = \u0026#34;android/widget/Toast\u0026#34; private const val SHADOW_TOAST = \u0026#34;com/didiglobal/booster/instrument/ShadowToast\u0026#34; override fun transform(context: TransformContext, klass: ClassNode): ClassNode { //â‘  if (klass.name == SHADOW_TOAST) { return klass } klass.methods.forEach { method -\u0026gt; //â‘¡ method.instructions?.iterator()?.asIterable()?.filterIsInstance(MethodInsnNode::class.java)?.filter { //â‘¢ it.opcode == Opcodes.INVOKEVIRTUAL \u0026amp;\u0026amp; it.name == \u0026#34;show\u0026#34; \u0026amp;\u0026amp; it.desc == \u0026#34;()V\u0026#34; \u0026amp;\u0026amp; (it.owner == TOAST || context.klassPool.get(TOAST).isAssignableFrom(it.owner)) }?.forEach { //â‘£ it.optimize(klass, method) } } return klass } //â‘¤ private fun MethodInsnNode.optimize(klass: ClassNode, method: MethodNode) { logger.println(\u0026#34; * ${this.owner}.${this.name}${this.desc} =\u0026gt; $SHADOW_TOAST.apply(L$SHADOW_TOAST;)V: ${klass.name}.${method.name}${method.desc}\u0026#34;) this.owner = SHADOW_TOAST this.name = \u0026#34;show\u0026#34; this.desc = \u0026#34;(L$TOAST;)V\u0026#34; this.opcode = Opcodes.INVOKESTATIC this.itf = false } ä¸Šé¢transformæ–¹æ³•ä¸­ï¼Œåœ¨â‘ å¤„å¦‚æœå½“å‰classæ˜¯com/didiglobal/booster/instrument/ShadowToastï¼Œåˆ™ä¸å¤„ç†ï¼Œåœ¨â‘¡å¤„é€šè¿‡method.instructionsæ‹¿åˆ°å½“å‰æ–¹æ³•çš„æ‰€æœ‰çš„æŒ‡ä»¤é›†ï¼Œç„¶åé€šè¿‡filterIsInstanceè¿‡æ»¤æ˜¯æ–¹æ³•è°ƒç”¨æŒ‡ä»¤ï¼Œæ¯”å¦‚INVOKEVIRTUALã€INVOKESTATICã€INVOKESPECIAL å’Œ INVOKEINTERFACEï¼Œå› ä¸ºMethodInsnNodeä»£è¡¨çš„æ˜¯æ–¹æ³•è°ƒç”¨æŒ‡ä»¤ã€‚æ‰€ä»¥åœ¨â‘¢å¤„é€šè¿‡opcodeã€nameã€descã€owneræ¥åˆ¤æ–­æ˜¯ä¸æ˜¯è¦ä¿®æ”¹çš„å­—èŠ‚ç ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å·¥å…·æ¥çœ‹ä¸‹ï¼š å¯ä»¥çœ‹åˆ°ï¼Œä¿®æ”¹å‰çš„å­—èŠ‚ç çš„opcode=invokevirtualï¼Œname=showï¼Œdesc = ()Vï¼Œowner = android/widget/Toastï¼Œæ‰€ä»¥é€šè¿‡ä¸Šé¢çš„è¿‡æ»¤æ¡ä»¶ï¼Œå°±èƒ½è¿‡æ»¤å‡ºè¦ä¿®æ”¹çš„æŒ‡ä»¤ã€‚åœ¨â‘£å¤„ï¼Œè°ƒç”¨äº†MethodInsnNodeçš„æ‰©å±•æ–¹æ³•optimizeï¼Œåœ¨â‘¤å¤„å°±æ˜¯ä¿®æ”¹å­—èŠ‚ç äº†ï¼Œå¦‚æœä¸çŸ¥é“ä¿®æ”¹åçš„å­—èŠ‚ç ï¼Œæˆ‘ä»¬å¯ä»¥å€ŸåŠ©å·¥å…·æŸ¥çœ‹ï¼š å¯ä»¥çœ‹åˆ°æœ€ç»ˆçš„opcode= invokestaticï¼Œname = showï¼Œdesc = (Landroid/widget/Toast;)Vï¼Œowner = com/didiglobal/booster/instrument/ShadowToastã€‚å’Œä¸Šé¢optimizeæ–¹æ³•ä¸­ä¿®æ”¹çš„æŒ‡ä»¤ä¸€æ ·ï¼Œæ–°åŠ äº†itf = falseï¼Œè¡¨ç¤ºæ–°æ›¿æ¢çš„owneræ˜¯å¦æ˜¯æ¥å£ï¼Œæ­¤å¤„çš„ShadowToastä¸æ˜¯ä¸€ä¸ªæ¥å£ï¼Œæ‰€ä»¥ä¸ºfalseï¼Œè¿™å°±æ˜¯æ›¿æ¢æŒ‡ä»¤çš„è¿‡ç¨‹ï¼Œæ˜¯ä¸æ˜¯å¾ˆç®€å•ã€‚\nä¸‹é¢æ¥å®æ“ä¸€æ³¢ï¼Œå°†æŸä¸ªç±»ä¸­çš„æ–¹æ³•è°ƒç”¨æ”¹æˆå…¶å®ƒçš„æ–¹æ³•è°ƒç”¨ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 package com.xc.asm; public class Main { public static void main(String[] args) { System.out.println(\u0026#34;Hello world!\u0026#34;); } public static void test(){ System.out.println(\u0026#34;Mainä¸­çš„testæ–¹æ³•\u0026#34;); } public static void test1(){ System.out.println(\u0026#34;Mainä¸­çš„test1æ–¹æ³•\u0026#34;); } } 1 2 3 4 5 6 7 8 9 10 11 12 13 package com.xc.asm; public class C { public void m() throws Exception { Thread.sleep(100); } public void n(){ Main.test(); } } åœ¨Cç±»ä¸­è°ƒç”¨äº†Mainç±»ä¸­çš„testé™æ€æ–¹æ³•ï¼Œæˆ‘ä»¬è¿™é‡Œæ˜¯æƒ³æŠŠè°ƒç”¨testæ–¹æ³•ç»™æ›¿æ¢æˆtest1æ–¹æ³•ï¼Œè¯ä¸å¤šè¯´ï¼Œç›´æ¥æ’¸ğŸ´ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 public class MethodReplaceTest { public static void main(String[] args) throws Exception { Class clazz = C.class; String clazzFilePath = Utils.getClassFilePath(clazz); ClassReader classReader = new ClassReader(new FileInputStream(clazzFilePath)); //ClassWriter.COMPUTE_FRAMESè¡¨ç¤ºè‡ªåŠ¨è®¡ç®—æ–¹æ³•æ ˆæ•° ClassWriter classWriter = new ClassWriter(ClassWriter.COMPUTE_FRAMES); //é€šè¿‡æ„é€ ä¸€ä¸ªæ–°çš„classVisitorï¼Œç„¶åå°†classWriterä¼ å…¥åˆ°è¯¥classVistorä¸­ï¼Œå®é™…å¹²æ´»çš„è¿˜æ˜¯classWriterï¼ŒMethodReplaceClassVisitoråªæ˜¯ä½œä¸ºä¸€ä¸ªä»£ç†ç±»ï¼Œè¿›è¡Œæ·»åŠ å±æ€§ MethodReplaceClassVisitor methodReplaceClassVisitor = new MethodReplaceClassVisitor(Opcodes.ASM5, classWriter); classReader.accept(methodReplaceClassVisitor, 0); // å†™å…¥æ–‡ä»¶ byte[] bytes = classWriter.toByteArray(); FileOutputStream fos = new FileOutputStream(clazzFilePath); fos.write(bytes); fos.flush(); fos.close(); //éªŒè¯ç»“æœ C c = new C(); c.n(); } } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 public class MethodReplaceClassVisitor extends ClassVisitor { protected MethodReplaceClassVisitor(int api, ClassVisitor classVisitor) { super(api, classVisitor); } @Override public MethodVisitor visitMethod(int access, String name, String descriptor, String signature, String[] exceptions) { MethodVisitor methodVisitor = super.visitMethod(access, name, descriptor, signature, exceptions); if(name.equals(\u0026#34;n\u0026#34;)){ return new MethodReplaceMethodVisitor(Opcodes.ASM5,methodVisitor); } return methodVisitor; } } 1 2 3 4 5 6 7 8 9 10 11 12 public class MethodReplaceMethodVisitor extends MethodVisitor { protected MethodReplaceMethodVisitor(int api, MethodVisitor methodVisitor) { super(api, methodVisitor); } @Override public void visitMethodInsn(int opcode, String owner, String name, String descriptor, boolean isInterface) { if (mv != null) { mv.visitMethodInsn(Opcodes.INVOKESTATIC,\u0026#34;com/xc/asm/Main\u0026#34;,\u0026#34;test1\u0026#34;,\u0026#34;()V\u0026#34;,false); } } } å…³äºasmçš„åŸºç¡€æ“ä½œå°±ä¸å¤šè¯´äº†ï¼Œä¸»è¦çœ‹ä¸‹MethodReplaceMethodVisitorçš„visitMethodInsnæ–¹æ³•æ˜¯æ“ä½œæ–¹æ³•æŒ‡ä»¤çš„ï¼Œé€šè¿‡ä¼ è¿›æ¥çš„MethodVisitorï¼Œæ¥è¿›è¡Œä¿®æ”¹æŒ‡ä»¤ï¼Œå…¶ä¸­æŒ‡ä»¤ä¸­çš„nameå­—æ®µä¼ test1ï¼Œå…¶ä½™çš„å­—æ®µå’ŒåŸæ¥è°ƒç”¨testæ–¹æ³•ä¸€è‡´çš„ã€‚\nå‚è€ƒ: æ»´æ»´å¼€æºåº“Booster:æ¶æ„è¿ä½œåŠæºç åˆ†æ\n","date":"2025-02-17T00:00:00Z","permalink":"http://xiangcman.xyz/p/booster%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/","title":"boosteræºç åˆ†æ"},{"content":"gradleçš„å¾ˆå¤šæ’ä»¶æ¶‰åŠåˆ°äº†å­—èŠ‚ç ä¿®æ”¹ï¼Œå†…éƒ¨ä¿®æ”¹å­—èŠ‚ç åŸºæœ¬éƒ½æ˜¯é€šè¿‡asmæ¥ä¿®æ”¹ï¼Œæœ¬æ–‡ç« å°±æ˜¯é€šè¿‡asmæ¥ä¿®æ”¹classã€‚æœ¬æ–‡åŸºäºintellij ideaæ¥ä½“éªŒçš„ã€‚\nä¸‹è½½ä¾èµ– é¦–å…ˆæˆ‘åˆ›å»ºçš„å·¥ç¨‹æ˜¯ä¸€ä¸ªjavaå·¥ç¨‹ï¼Œç„¶åå°†é¡¹ç›®é…ç½®æˆmavenå·¥ç¨‹ï¼š æ¥ç€å»mavenå®˜ç½‘æ‰¾ä¸‹å¯¹åº”ä¾èµ–ï¼š ç„¶ååœ¨å·¥ç¨‹é‡Œé¢æ·»åŠ ä¾èµ–ï¼š è¯»å–class é¦–å…ˆå®šä¹‰ä¸€ä¸ªæ™®é€šçš„ç±»ï¼š 1 2 3 4 5 6 7 8 9 10 11 public class User { private String name;//Ljava/lang/Stringè¡¨ç¤ºstringç±»å‹ private int age;//Iè¡¨ç¤ºintç±»å‹ private long lang;//åœ¨classä¸­Jè¡¨ç¤ºlongç±»å‹ public String getName() { return name; } public int getAge() { return age; } } è¯»å–åˆ°Userç±»å¯¹åº”classçš„è·¯å¾„ 1 2 3 4 5 6 7 8 9 public class Utils { public static String getClassFilePath(Class clazz) { // file:/Users/xiangcheng/IdeaProject/Asm/target/classes/ String buildDir = clazz.getProtectionDomain().getCodeSource().getLocation().getFile();//è·å–åˆ°æ–‡ä»¶æ‰€åœ¨ä½ç½® String fileName = clazz.getSimpleName() + \u0026#34;.class\u0026#34;; File file = new File(buildDir + clazz.getPackage().getName().replaceAll(\u0026#34;[.]\u0026#34;, \u0026#34;/\u0026#34;) + \u0026#34;/\u0026#34;, fileName); return file.getAbsolutePath(); } } é€šè¿‡ClassReaderè·å–åˆ°classçš„è¯»å– 1 2 3 4 Class clazz = User.class; String clazzFilePath = Utils.getClassFilePath(clazz); //é¦–å…ˆé€šè¿‡classçš„è·¯å¾„è·å–åˆ°classReaderï¼Œç„¶åé€šè¿‡classReaderçš„acceptæ–¹æ³•ï¼Œä¼ å…¥ä¸€ä¸ªclassNodeï¼Œç„¶åä½¿ç”¨classNodeè·å–åˆ°æ–¹æ³•å’Œå±æ€§ ClassReader classReader = new ClassReader(new FileInputStream(clazzFilePath)); é€šè¿‡classReaderè·å–åˆ°classNode 1 2 ClassNode classNode = new ClassNode(Opcodes.ASM5); classReader.accept(classNode, 0); ClassNodeè¯»å–æ–¹æ³•å’Œå±æ€§ 1 2 3 4 5 6 7 8 9 10 List\u0026lt;MethodNode\u0026gt; methods = classNode.methods; List\u0026lt;FieldNode\u0026gt; fields = classNode.fields; System.out.println(\u0026#34;methods:\u0026#34;); for (MethodNode methodNode : methods) { System.out.println(methodNode.name + \u0026#34;, \u0026#34; + methodNode.desc); } System.out.println(\u0026#34;fields:\u0026#34;); for (FieldNode fieldNode : fields) { System.out.println(fieldNode.name + \u0026#34;, \u0026#34; + fieldNode.desc); } è·å–ä¿¡æ¯å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 methods: \u0026lt;init\u0026gt;, ()V getName, ()Ljava/lang/String; getAge, ()I fields: name, Ljava/lang/String; age, I lang, J æˆ‘ä»¬é€šè¿‡jclasslibéªŒè¯ä¸‹ï¼š å…¶ä¸­å±æ€§çš„åå­—ï¼Œæè¿°ç¬¦ï¼Œè®¿é—®æ ‡è¯†éƒ½å’Œä¸Šé¢çš„å¯¹åº”çš„ä¸Šã€‚æ–¹æ³•ä¹Ÿæ˜¯å¦‚æ­¤ã€‚ ä¸Šé¢æ˜¯é€šè¿‡classNodeæ ‘å½¢ç»“æ„è®¿é—®çš„ï¼Œä¸‹é¢é€šè¿‡visitå›è°ƒçš„å½¢å¼è®¿é—®å±æ€§å’Œæ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 Class clazz = User.class; String clazzFilePath = Utils.getClassFilePath(clazz); ClassReader classReader = new ClassReader(new FileInputStream(clazzFilePath)); //å‰é¢ä»‹ç»çš„classNodeæ˜¯ç»§æ‰¿è‡ªclassVisitorï¼ŒclassNodeæ˜¯æŠŠæ‰€æœ‰çš„æ–¹æ³•å’Œå±æ€§å…¨éƒ¨éƒ½è¯»åˆ°å†…å­˜ä¸­ï¼Œç„¶åå†éå†ï¼ŒClassVisitorè¾¹è¯»è¾¹éå† ClassVisitor classVisitor = new ClassVisitor(Opcodes.ASM5) { @Override public FieldVisitor visitField(int access, String name, String descriptor, String signature, Object value) { System.out.println(\u0026#34;visit field:\u0026#34; + name + \u0026#34; , desc = \u0026#34; + descriptor); return super.visitField(access, name, descriptor, signature, value); } @Override public MethodVisitor visitMethod(int access, String name, String descriptor, String signature, String[] exceptions) { System.out.println(\u0026#34;visit method:\u0026#34; + name + \u0026#34; , desc = \u0026#34; + descriptor); return super.visitMethod(access, name, descriptor, signature, exceptions); } }; classReader.accept(classVisitor, 0); é€šè¿‡ClassVisitorä¹Ÿèƒ½è®¿é—®åˆ°å±æ€§å’Œæ–¹æ³•ï¼Œä¸Šé¢ä»‹ç»çš„ClassNodeæ˜¯ç»§æ‰¿è‡ªClassVisitorï¼ŒClassVisitoræ˜¯è¾¹è¯»è¾¹éå†ï¼Œè€ŒClassNodeæ˜¯æŠŠæ–¹æ³•å’Œå±æ€§å…¨éƒ¨éƒ½è¯»åˆ°å†…å­˜ä¸­ï¼Œç„¶åå†éå†ã€‚\nä¿®æ”¹class ä¸Šé¢ä»‹ç»çš„éƒ½æ˜¯è¯»å–classï¼Œæˆ‘ä»¬æœ€ç»ˆçš„ç›®çš„æ˜¯ä¿®æ”¹classï¼Œä¸‹é¢ä¹Ÿé€šè¿‡ä¸€ä¸ªğŸŒ°æ¥ä»‹ç»å¦‚ä½•ä¿®æ”¹classï¼Œè¿˜æ˜¯å…ˆæ¥ä¸€ä¸ªç±»ï¼š\n1 2 3 4 5 6 7 public class C { public void m() throws Exception { Thread.sleep(100); } } æˆ‘ä»¬è¦æŠŠå®ƒä¿®æ”¹æˆå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 public class C { public static long timer; public void m() throws Exception { timer -= System.currentTimeMillis(); Thread.sleep(100L); timer += System.currentTimeMillis(); } } asmä¿®æ”¹å­—èŠ‚ç å…ˆé€šè¿‡ClassReaderæŠŠclassä¿¡æ¯è¯»å–åˆ°ï¼Œç„¶åé€šè¿‡ClassWriteræŠŠä¿®æ”¹åçš„classå†å†™ä¼šåˆ°æ–‡ä»¶é‡Œé¢ï¼Œå…ˆä»‹ç»ä¸‹é€šè¿‡ClassWriteræŠŠclasså†™åˆ°æ–‡ä»¶ä¸­ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 Class clazz = C.class; String clazzFilePath = Utils.getClassFilePath(clazz); ClassReader classReader = new ClassReader(new FileInputStream(clazzFilePath)); ClassWriter classWriter = new ClassWriter(0); classReader.accept(classWriter, 0); // å†™å…¥æ–‡ä»¶ byte[] bytes = classWriter.toByteArray(); String buildDir = clazz.getProtectionDomain().getCodeSource().getLocation().getFile(); FileOutputStream fos = new FileOutputStream(buildDir + clazz.getPackage().getName().replaceAll(\u0026#34;[.]\u0026#34;, \u0026#34;/\u0026#34;) +\u0026#34;/copyed.class\u0026#34;); fos.write(bytes); fos.flush(); fos.close(); å¯ä»¥çœ‹åˆ°classReaderçš„acceptæ–¹æ³•ä¹Ÿå¯ä»¥æ¥å—ä¸€ä¸ªclassWriterå¯¹è±¡ï¼Œå®ƒä¹Ÿæ˜¯ç»§æ‰¿è‡ªclassVisitorï¼Œç„¶åæŠŠå®ƒè½¬åŒ–æˆbyteæ•°ç»„ï¼Œæœ€åé€šè¿‡æ–‡ä»¶è¾“å‡ºæµæŠŠbyteæ•°ç»„å†™ä¼šåˆ°æ–‡ä»¶ä¸­ï¼Œæ•´ä¸ªè¿‡ç¨‹å¾ˆç®€å•ã€‚ä¿®æ”¹classä¹Ÿæ˜¯å¦‚æ­¤æŠŠä¿®æ”¹åçš„byteæ•°ç»„ä¹Ÿæ˜¯å†™ä¼šåˆ°æ–‡ä»¶ä¸­çš„ã€‚\nåœ¨ä¸Šé¢æˆ‘ä»¬çŸ¥é“classVisitoræ˜¯è¯»å–classçš„æ ¸å¿ƒç±»ï¼Œæœ€ç»ˆæŠŠè¯¥classVistorä¼ åˆ°acceptæ–¹æ³•ä¸­ï¼Œè€ŒclassWriterä¹Ÿéœ€è¦ä¼ åˆ°acceptæ–¹æ³•ä¸­ã€‚æ‰€ä»¥çœ‹ä¸‹ä¸¤è€…éƒ½è¦ä½¿ç”¨çš„è¯ï¼Œè¯¥æ€ä¹ˆå¤„ç†ï¼š å¯ä»¥çœ‹åˆ°æ„é€ å™¨ä¸­å¯ä»¥ä¼ å…¥classVisitorï¼Œæœ€ç»ˆé‡Œé¢çš„æ‰€æœ‰visit**æ–¹æ³•éƒ½æ˜¯è°ƒç”¨äº†ä¼ å…¥è¿›æ¥çš„classVisitoræ–¹æ³•ã€‚æ‰€ä»¥ä¸éš¾çœ‹å‡ºæ¥è¿™æ˜¯ä¸ªä»£ç†æ¨¡å¼ï¼Œä¼ å…¥è¿›æ¥çš„classVisitoræ˜¯ä¸€ä¸ªè¢«ä»£ç†å¯¹è±¡ï¼Œè¯¥classVisitoræ˜¯ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œé¦–å…ˆè‡ªå®šä¹‰ä¸€ä¸ªclassVisitorï¼š\n1 2 3 4 5 6 public class AddTimerClassVisitor extends ClassVisitor { public AddTimerClassVisitor(int api, ClassVisitor classVisitor) { super(api, classVisitor); } } ç„¶åçœ‹ä¸‹æ€ä¹ˆè°ƒç”¨AddTimerClassVisitorï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 Class clazz = C.class; String clazzFilePath = Utils.getClassFilePath(clazz); ClassReader classReader = new ClassReader(new FileInputStream(clazzFilePath)); //ClassWriter.COMPUTE_FRAMESè¡¨ç¤ºè‡ªåŠ¨è®¡ç®—æ–¹æ³•æ ˆæ•° ClassWriter classWriter = new ClassWriter(ClassWriter.COMPUTE_FRAMES); //é€šè¿‡æ„é€ ä¸€ä¸ªæ–°çš„classVisitorï¼Œç„¶åå°†classWriterä¼ å…¥åˆ°è¯¥classVistorä¸­ï¼Œå®é™…å¹²æ´»çš„è¿˜æ˜¯classWriterï¼ŒAddTimerClassVisitoråªæ˜¯ä½œä¸ºä¸€ä¸ªä»£ç†ç±»ï¼Œè¿›è¡Œæ·»åŠ å±æ€§ AddTimerClassVisitor addTimerClassVisitor = new AddTimerClassVisitor(Opcodes.ASM5, classWriter); classReader.accept(addTimerClassVisitor, 0); // å†™å…¥æ–‡ä»¶ byte[] bytes = classWriter.toByteArray(); FileOutputStream fos = new FileOutputStream(clazzFilePath); fos.write(bytes); fos.flush(); fos.close(); å°†ClassWriterä¼ åˆ°AddTimerClassVisitorä¸­ï¼Œå¯ä»¥çœ‹å‡ºæ¥ClassWriteræ˜¯è¢«ä»£ç†çš„å¯¹è±¡ï¼ŒAddTimerClassVisitoræ˜¯ä»£ç†å¯¹è±¡ï¼Œåœ¨å‰é¢æˆ‘ä»¬é€šè¿‡é‡å†™visitFieldè®¿é—®åˆ°å±æ€§ï¼Œé€šè¿‡visitMethodè®¿é—®åˆ°æ–¹æ³•ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•æ˜¯å¤šæ¬¡è¢«è°ƒç”¨ï¼Œè€Œæˆ‘ä»¬æ˜¯æƒ³æ·»åŠ ä¸€ä¸ªé™æ€çš„timerå±æ€§ï¼Œå’Œä¿®æ”¹æ–¹æ³•mï¼Œé‚£æ­¤æ—¶visitFieldè‚¯å®šä¸ä¼šè¢«è°ƒç”¨åˆ°ï¼Œåœ¨classå¼€å§‹è®¿é—®å’Œç»“æŸè®¿é—®çš„æ—¶å€™ä¼šåˆ†åˆ«è°ƒç”¨visitå’ŒvisitEndæ–¹æ³•ï¼Œé‚£æ·»åŠ timerå±æ€§å¯ä»¥æ”¾åˆ°visitEndä¸­ï¼Œä¿®æ”¹æ–¹æ³•å¯ä»¥åœ¨visitMethodä¸­é€šè¿‡è¿‡æ»¤æ¥è¾¾åˆ°ä¿®æ”¹çš„ç›®çš„ï¼Œè€Œæœ€ç»ˆçš„å­—èŠ‚ç ç…§æ ·å¯ä»¥å…ˆæŠŠç»“æœé€šè¿‡jclasslibæ¥æŸ¥çœ‹ï¼š åœ¨classä¸­åå­—æ˜¯timerï¼Œæè¿°ç¬¦æ˜¯Jï¼Œè®¿é—®æ ‡å¿—æ˜¯public+staticï¼Œé‚£ä¹ˆé€šè¿‡asmå¦‚ä½•æ·»åŠ è¯¥å±æ€§ï¼š\n1 2 3 4 5 6 7 8 9 10 11 @Override public void visitEnd() { System.out.println(\u0026#34;AddTimerClassVisitor visitEnd\u0026#34;); //é€šè¿‡visitFieldæ–¹æ³•æ·»åŠ å±æ€§,cvæ˜¯ä¼ è¿›æ¥çš„classWriterï¼Œå®é™…å¹²æ´»çš„è¿˜æ˜¯classWriterï¼Œæ­¤å¤„ç”¨åˆ°äº†ä»£ç†æ¨¡å¼ FieldVisitor fv = cv.visitField(Opcodes.ACC_PUBLIC + Opcodes.ACC_STATIC, \u0026#34;timer\u0026#34;, \u0026#34;J\u0026#34;, null, null);//visitFieldæ–¹æ³•ç¬¬ä¸€ä¸ªå‚æ•°å®šä¹‰è®¿é—®æ ‡å¿—ï¼Œå®ƒæ˜¯public+staticç±»å‹ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯å‚æ•°çš„åå­—ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯å‚æ•°çš„æè¿°ç¬¦ï¼Œè¡¨ç¤ºä»€ä¹ˆç±»å‹ï¼Œlongç±»å‹ç”¨Jè¡¨ç¤º if (fv != null) { fv.visitEnd(); } cv.visitEnd(); } é€šè¿‡cvï¼ˆä¼ è¿›æ¥çš„classWriterï¼‰æ¥è®¿é—®å±æ€§æ¥æ·»åŠ timerå±æ€§ï¼Œå’Œä¸Šé¢ç”¨jclasslibå·¥å…·æŸ¥çœ‹çš„ç»“æœä¸€æ ·ã€‚ä¸‹é¢å†çœ‹ä¸‹å¦‚æœä¿®æ”¹mæ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 @Override public MethodVisitor visitMethod(int access, String name, String descriptor, String signature, String[] exceptions) { System.out.println(\u0026#34;AddTimerClassVisitor visitMethod\u0026#34;); MethodVisitor methodVisitor = super.visitMethod(access, name, descriptor, signature, exceptions); if (methodVisitor != null \u0026amp;\u0026amp; !name.equals(\u0026#34;\u0026lt;init\u0026gt;\u0026#34;)) { NewMethodVisitor newMethodVisitor = new NewMethodVisitor(Opcodes.ASM5, methodVisitor, mOwner); return newMethodVisitor; } return methodVisitor; } é¦–å…ˆæ˜¯æ‹¿åˆ°å½“å‰çš„MethodVisitorï¼Œç„¶ååˆ¤æ–­æ–¹æ³•ä¸æ˜¯æ„é€ å‡½æ•°ï¼Œæœ€åæ”¾å›ä¸€ä¸ªæ–°çš„NewMethodVisitorï¼Œå¦åˆ™è¿”å›åŸæ¥çš„MethodVisitorï¼Œä¸‹æ¥æ¥çœ‹ä¸‹NewMethodVisitorå¦‚ä½•ä¿®æ”¹æ–¹æ³•mï¼Œå…ˆçœ‹ä¸‹jclasslibä¿®æ”¹åclassçš„æ–¹æ³•mï¼š å…¶å®æˆ‘ä»¬é€šè¿‡javap -v com.xc.asm.Cæ¥æŸ¥çœ‹å­—èŠ‚ç ï¼š æ›´å¤šçš„javapå‘½ä»¤å¦‚ä¸‹ï¼š æœ‰äº†ä¸Šé¢åç¼–è¯‘çš„å­—èŠ‚ç åï¼Œå…¶å®å°±æ˜¯asmå¯¹åº”çš„æ–¹æ³•æ“ä½œäº†ï¼Œåœ¨NewMethodVisitorä¸­é‡å†™visitCodeæ–¹æ³•ï¼Œåœ¨è®¿é—®è¯¥æ–¹æ³•ä¹‹å‰æ·»åŠ å¯¹åº”çš„å­—èŠ‚ç ï¼Œé‡å†™visitInsnæ–¹æ³•ï¼Œåœ¨æ–¹æ³•returnä¹‹å‰æ·»åŠ å¯¹åº”çš„å­—èŠ‚ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 public class NewMethodVisitor extends MethodVisitor { private String mOwner; public NewMethodVisitor(int api, MethodVisitor methodVisitor, String mOwner) { super(api, methodVisitor); this.mOwner = mOwner; } @Override public void visitCode() { mv.visitCode(); mv.visitFieldInsn(GETSTATIC, mOwner, \u0026#34;timer\u0026#34;, \u0026#34;J\u0026#34;); mv.visitMethodInsn(INVOKESTATIC, \u0026#34;java/lang/System\u0026#34;, \u0026#34;currentTimeMillis\u0026#34;, \u0026#34;()J\u0026#34;); mv.visitInsn(LSUB); mv.visitFieldInsn(PUTSTATIC, mOwner, \u0026#34;timer\u0026#34;, \u0026#34;J\u0026#34;); } @Override public void visitInsn(int opcode) { if ((opcode \u0026gt;= IRETURN \u0026amp;\u0026amp; opcode \u0026lt;= RETURN) || opcode == ATHROW) { mv.visitFieldInsn(GETSTATIC, mOwner, \u0026#34;timer\u0026#34;, \u0026#34;J\u0026#34;); mv.visitMethodInsn(INVOKESTATIC, \u0026#34;java/lang/System\u0026#34;, \u0026#34;currentTimeMillis\u0026#34;, \u0026#34;()J\u0026#34;); mv.visitInsn(LADD); mv.visitFieldInsn(PUTSTATIC, mOwner, \u0026#34;timer\u0026#34;, \u0026#34;J\u0026#34;); } mv.visitInsn(opcode); } } å¯ä»¥ç»“åˆä¸Šé¢çš„åç¼–è¯‘çš„å­—èŠ‚ç ï¼Œå¯¹åº”ç€çœ‹asmçš„æ“ä½œã€‚æœ€åasmæ“ä½œå®Œåï¼Œå°±æ˜¯é€šè¿‡è¾“å‡ºæµæŠŠbyteæ•°ç»„å†™ä¼šåˆ°æ–‡ä»¶ä¸­ã€‚\nå‚è€ƒ: Android è¿›é˜¶ä¹‹è·¯ï¼šASM ä¿®æ”¹å­—èŠ‚ç ï¼Œè¿™æ ·å­¦å°±å¯¹äº†ï¼ asmä¾èµ– asmå®˜ç½‘ jclasslib\n","date":"2025-02-10T00:00:00Z","permalink":"http://xiangcman.xyz/p/asm%E4%BF%AE%E6%94%B9%E5%AD%97%E8%8A%82%E7%A0%81%E5%88%9D%E4%BD%93%E9%AA%8C/","title":"asmä¿®æ”¹å­—èŠ‚ç åˆä½“éªŒ"},{"content":"å¹³æ—¶å·¥ä½œä¸­éœ€è¦ç»å¸¸å˜jdkçš„ç‰ˆæœ¬é…ç½®ï¼Œä½¿ç”¨jenvæ¥ç®¡ç†jdkçš„æ—¶å€™ï¼Œä¸ç”¨æ¥å›é…ç½®ç¯å¢ƒå˜é‡ã€‚\nå®‰è£…jenv 1 brew install jenv é…ç½®.zshrc 1 2 export PATH=\u0026#34;$HOME/.jenv/bin:$PATH\u0026#34; eval \u0026#34;$(jenv init -)\u0026#34; åŒæ­¥.zshrc 1 source ~/.zshrc æŸ¥çœ‹æœ¬æœºå®‰è£…äº†å“ªäº›jdk 1 /usr/libexec/java_home -V ç»“æœå¦‚ä¸‹ï¼š æ·»åŠ jdk 1 2 3 jenv add /Users/xiangcheng/Library/Java/JavaVirtualMachines/corretto-18.0.2/Contents/Home jenv add /Users/xiangcheng/Library/Java/JavaVirtualMachines/corretto-11.0.23/Contents/Home jenv add /Users/xiangcheng/Library/Java/JavaVirtualMachines/corretto-1.8.0_412/Contents/Home æŸ¥çœ‹jenvç®¡ç†çš„jdkç‰ˆæœ¬ 1 jenv versions ç»“æœå¦‚ä¸‹ï¼š åˆ‡æ¢å…¨å±€çš„jdkç‰ˆæœ¬ 1 jenv global 18 å½“å‰ shell åˆ‡æ¢ JDK 1 jenv shell 18 é¡¹ç›®ç›®å½•æŒ‡å®š JDK 1 2 cd ~/my_project jenv local 18 ","date":"2025-02-10T00:00:00Z","permalink":"http://xiangcman.xyz/p/%E4%BD%BF%E7%94%A8jenv%E7%AE%A1%E7%90%86%E5%A4%9A%E4%B8%AAjdk/","title":"ä½¿ç”¨jenvç®¡ç†å¤šä¸ªjdk"},{"content":"zshçš„æ’ä»¶åˆ†ä¸ºé¢„è£…çš„æ’ä»¶å’Œè‡ªå®šä¹‰çš„æ’ä»¶ï¼Œè‡ªå®šä¹‰æ’ä»¶åœ¨.oh-my-zsh/customæ–‡ä»¶å¤¹ä¸‹ï¼Œé¢„è£…çš„æ’ä»¶åœ¨pluginsæ–‡ä»¶å¤¹ä¸‹ï¼š æˆ‘æ˜¯è£…äº†4ä¸ªè‡ªå®šä¹‰æ’ä»¶ï¼Œå…³äºè‡ªå®šä¹‰æ’ä»¶çš„å®‰è£…å¯ä»¥åœ¨å¯¹åº”çš„æ’ä»¶ä»‹ç»ä¸­æ‰¾åˆ°\nsublimeæ’ä»¶ sublimeæ’ä»¶èƒ½å¿«é€Ÿæ‰“å¼€æŸä¸ªæ–‡ä»¶æˆ–æ–‡ä»¶ï¼Œå¹¶åœ¨sublimeåº”ç”¨ä¸­å±•ç¤ºã€‚å®ƒæ˜¯é¢„è£…çš„æ’ä»¶ï¼Œæ‰€ä»¥ä¸ç”¨å•ç‹¬å®‰è£… ä½¿ç”¨ï¼š\n1 2 st . # æ‰“å¼€å½“å‰ç›®å½• st myfile.txt # æ‰“å¼€ myfile.txt å‚è€ƒï¼š ohmyzsh zsh-autosuggestions zsh-completions zsh-syntax-highlighting\n","date":"2025-02-08T00:00:00Z","permalink":"http://xiangcman.xyz/p/oh-my-zsh%E6%8F%92%E4%BB%B6%E5%BF%85%E5%A4%87/","title":"oh-my-zshæ’ä»¶å¿…å¤‡"},{"content":"GradleåŸºç¡€ gradleæ˜¯ä¸€ä¸ªè„šæœ¬æ¡†æ¶ï¼Œç”¨æ¥æ„å»ºandroidç¨‹åºçš„ä¸€ä¸ªè„šæœ¬ï¼Œåœ¨è®¤è¯†å‰ï¼Œæˆ‘ä»¬å…ˆä»¥æœ€åŸºç¡€çš„æ–¹å¼æ¥è®¤è¯†å®ƒã€‚\ngradleé…ç½® é¦–å…ˆåœ¨å®˜ç½‘ä¸‹è½½å¯¹åº”çš„ç‰ˆæœ¬ï¼Œè¿™é‡Œæˆ‘é€‰æ‹©6.6.1-allçš„ç‰ˆæœ¬ï¼Œä¸‹è½½å®Œåï¼Œæ”¾åˆ°æŒ‡å®šçš„ç›®å½•ï¼Œç„¶åé…ç½®gradleçš„ç¯å¢ƒå˜é‡:\nopen -e .bash_profile æ‰“å¼€é…ç½®æ–‡ä»¶ æ·»åŠ  GRADLE_HOMEã€PATH 1 2 3 4 5 6 7 export GRADLE_HOME=/Users/xiangcheng/gradle/gradle-6.6.1 export PATH=${PATH}:/Users/xiangcheng/gradle/gradle-6.6.1/bin ----------------å®˜æ–¹å†™æ³•å¦‚ä¸‹-------------------------------- export GRADLE_HOME=/Users/xiangcheng/gradle/gradle-6.6.1 export PATH=$PATH:$GRADLE_HOME/bin source .bash_profile é‡ç½®é…ç½®æ–‡ä»¶ï¼Œä»¥ä¾¿æ–° path ç”Ÿæ•ˆ open -e ~/.zshrc æ‰“å¼€å¦ä¸€ä¸ªé…ç½® åœ¨æœ€åä¸€è¡Œæ·»åŠ  source ~/.bash_profile source ~/.zshrc é‡ç½®é…ç½®æ–‡ä»¶ é…ç½® zshrc æ˜¯å› ä¸ºæœ‰çš„æœºå™¨ bash_profile é…ç½®ä¸ç®¡ç”¨ï¼Œæ·»åŠ è¿™ä¸ªå°±è¡Œäº†\nè¿è¡Œ gradle \u0026ndash;versionï¼Œå‡ºç°ç‰ˆæœ¬å·åˆ™ Gradle é…ç½®æˆåŠŸ æ³¨æ„ï¼šgradleç‰ˆæœ¬å’Œjdkç‰ˆæœ¬éœ€è¦æœ‰å¯¹åº”å…³ç³»ï¼š è¿™é‡Œæˆ‘å®‰è£…çš„æ˜¯gradle-6.6.1çš„ç‰ˆæœ¬ï¼Œå› æ­¤æˆ‘éœ€è¦è®¾ç½®JDK8ï¼Œå¦‚æœæœ¬åœ°å®‰è£…çš„jdkç‰ˆæœ¬å¤šä¸ªçš„è¯ï¼Œmacä¼šä½¿ç”¨æœ€é«˜çš„ç‰ˆæœ¬ï¼Œå…ˆæŸ¥çœ‹æœ¬åœ°å®‰è£…äº†å“ªäº›jdkç‰ˆæœ¬ 1 /usr/libexec/java_home -V è¾“å‡ºå¦‚ä¸‹ï¼š\n1 2 3 4 Matching Java Virtual Machines (3): 18.0.2 (arm64) \u0026#34;Amazon.com Inc.\u0026#34; - \u0026#34;Amazon Corretto 18\u0026#34; /Users/xiangcheng/Library/Java/JavaVirtualMachines/corretto-18.0.2/Contents/Home 11.0.23 (arm64) \u0026#34;Amazon.com Inc.\u0026#34; - \u0026#34;Amazon Corretto 11\u0026#34; /Users/xiangcheng/Library/Java/JavaVirtualMachines/corretto-11.0.23/Contents/Home 1.8.0_412 (arm64) \u0026#34;Amazon\u0026#34; - \u0026#34;Amazon Corretto 8\u0026#34; /Users/xiangcheng/Library/Java/JavaVirtualMachines/corretto-1.8.0_412/Contents/Home æ‰€ä»¥é»˜è®¤ç”¨çš„æ˜¯jdk18ï¼Œæˆ‘éœ€è¦æ”¹ä¸‹ç¯å¢ƒå˜é‡ï¼Œå°†jdkæ”¹æˆ8ï¼š\n1 2 export JAVA_HOME=/Users/xiangcheng/Library/Java/JavaVirtualMachines/corretto-1.8.0_412/Contents/Home export PATH=$JAVA_HOME/bin:$PATH å†è¿è¡Œï¼š\n1 source ~/.bash_profile ä¸Šé¢çš„jdké…ç½®å¥½åï¼Œç„¶åæ‰¾ä¸ªæ–‡ä»¶å¤¹ï¼Œåˆ›å»ºbuild.gradleï¼Œç„¶åè¾“å…¥ï¼š\n1 println(\u0026#34;hello world!\u0026#34;) ç„¶åç”¨gradle build.gradleè¿è¡Œè¯¥æ–‡ä»¶ï¼Œè¾“å‡ºå¦‚ä¸‹ï¼š è¯´æ˜å·²ç»æˆåŠŸäº†ã€‚\ngradleåˆå§‹åŒ–å·¥ç¨‹ å¹³æ—¶éƒ½æ˜¯ç›´æ¥é€šè¿‡asåˆ›å»ºå·¥ç¨‹ï¼Œä¸‹é¢é€šè¿‡gradleæ¥åˆ›å»ºä¸€ä¸ªå·¥ç¨‹ï¼š\nè¾“å…¥gradle initæ¥åˆå§‹åŒ– æ¥ç€ä¼šè¾“å…¥ç›¸å…³é…ç½®ä¿¡æ¯ï¼š å‘½ä»¤è¡Œæç¤ºé€‰æ‹©é¡¹ç›®æ¨¡æ¿ å‘½ä»¤è¡Œæç¤ºé€‰æ‹©å¼€å‘è¯­è¨€ å‘½ä»¤è¡Œæç¤ºé€‰æ‹©è„šæœ¬è¯­è¨€ è¾“å…¥å·¥ç¨‹å è¾“å…¥åŒ…å æœ€ç»ˆå·¥ç¨‹åˆ›å»ºå¦‚ä¸‹ï¼š å’Œandroid studioåˆ›å»ºçš„å·¥ç¨‹ç»“æ„æ˜¯ä¸€è‡´çš„ã€‚ Gradle Wrapper asåˆ›å»ºä¸€ä¸ªå·¥ç¨‹çš„æ—¶å€™ï¼Œé»˜è®¤ä¼šæœ‰Gradle Wrapperæ–‡ä»¶å¤¹ï¼Œå®ƒé‡Œé¢ä¼šæœ‰ä¸ªwrapper.propertiesæ–‡ä»¶å¤¹ï¼Œé…ç½®äº†gradleç›¸å…³ä¿¡æ¯ã€‚ Gradle Wrapper æ–‡ä»¶çš„ä½œç”¨å°±æ˜¯å¯ä»¥è®©ä½ çš„ç”µè„‘åœ¨ä¸å®‰è£…é…ç½® Gradle ç¯å¢ƒçš„å‰æä¸‹è¿è¡Œ Gradle é¡¹ç›®ï¼Œä½ çš„æœºå™¨è¦æ˜¯æ²¡æœ‰é… Gradle ç¯å¢ƒï¼Œé‚£ä¹ˆä½  clone gradle é¡¹ç›®ä¸‹æ¥ï¼Œæ‰§è¡Œ init å‘½ä»¤ï¼Œä¼šæ ¹æ® gradle-wrapper.properties æ–‡ä»¶ä¸­å£°æ˜çš„ gradle URL è¿œç¨‹è·¯å¾„å»ä¸‹è½½ gradle æ„å»ºå·¥å…·ï¼Œcd è¿›è¯¥é¡¹ç›®ï¼Œæ‰§è¡Œäº†./gradlew -vï¼Œç„¶åä¸‹è½½äº†å¯¹åº”ç‰ˆæœ¬çš„gradleï¼Œå¦‚æœæ­¤æ—¶æ‰§è¡Œçš„æ˜¯gradle -vï¼Œå°±ç”¨çš„æ˜¯æœ¬åœ°é…ç½®çš„ç¯å¢ƒå˜é‡ä¸­çš„gradleç‰ˆæœ¬ï¼Œæ­¤æ—¶ä¸ä¼šå»ä¸‹è½½ã€‚ ç„¶åå°±å¯ä»¥åœ¨é¡¹ç›®ç›®å½•ä¸‹è¿è¡Œ gradle å‘½ä»¤äº†ï¼Œä¸è¿‡è¿˜æ˜¯æ¨èå¤§å®¶åœ¨æœºå™¨é…ç½®ç»Ÿä¸€çš„ Gradle ç¯å¢ƒ\ngradlew \u0026ndash;\u0026gt; linux å¹³å°è„šæœ¬ gradlew.bat \u0026ndash;\u0026gt; window å¹³å°è„šæœ¬ gradle-wrapper.jar \u0026ndash;\u0026gt; Gradle ä¸‹è½½ã€ç®¡ç†ç›¸å…³ä»£ç  gradle-wrapper.properties \u0026ndash;\u0026gt; Gradle ä¸‹è½½ã€ç®¡ç†é…ç½®å‚æ•° gradle-wrapper.properties æ–‡ä»¶ä¸­å‚æ•°è¯¦è§£ï¼š\ndistributionUrl \u0026ndash;\u0026gt; Gradle å‹ç¼©åŒ…ä¸‹è½½åœ°å€\nzipStoreBase \u0026ndash;\u0026gt; æœ¬æœºå­˜æ”¾ Gradle å‹ç¼©åŒ…ä¸»åœ°å€\nzipStorePath \u0026ndash;\u0026gt; æœ¬æœºå­˜æ”¾ Gradle å‹ç¼©åŒ…ä¸»è·¯å¾„\nGradle å‹ç¼©åŒ…å®Œæ•´çš„è·¯å¾„æ˜¯ zipStoreBase + zipStorePath distributionBase \u0026ndash;\u0026gt; æœ¬æœº Gradle å‹ç¼©åŒ…è§£å‹åä¸»åœ°å€\ndistributionPath \u0026ndash;\u0026gt; æœ¬æœº Gradle å‹ç¼©åŒ…è§£å‹åè·¯å¾„\nGradle è§£å‹å®Œæ•´çš„è·¯å¾„æ˜¯ distributionBase + distributionPath distributionBase çš„è·¯å¾„æ˜¯ç¯å¢ƒ path ä¸­ GRADLE_USER_HOME çš„åœ°å€ Windowsï¼šC:/ç”¨æˆ·/ä½ ç”µè„‘ç™»å½•çš„ç”¨æˆ·å/.gradle/ MACï¼šï½/.gradle/ ä½  MAC è¦æ˜¯é…äº† Gradle ç¯å¢ƒå˜é‡ï¼ŒdistributionBase å°±æ˜¯ä½ è‡ªå·±è§£å‹ç¼©çš„ gradle è·¯å¾„ è¿™å‡ ä¸ªåœ°å€è¿˜æ˜¯è¦ææ¸…æ¥šçš„~\nå…³äºaså¦‚æœé…ç½®ç»Ÿä¸€çš„gradleç‰ˆæœ¬ï¼Œå¯ä»¥çœ‹å¦‚ä¸‹æˆªå›¾ï¼š gradle-wrapper.properties \u0026ndash; ä½¿ç”¨ wrapper ä¹Ÿå°±æ˜¯ AS æ¥ç®¡ç† Gradle Specifiled location \u0026ndash; ä½¿ç”¨æœ¬åœ°æ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬è‡ªå·±ç®¡ç† Gradleï¼Œè¿™æ ·æ¯ä¸ªå·¥ç¨‹çš„gradle-wrapper.propertieså°±ä¸èµ·ä½œç”¨äº†ï¼Œä½¿ç”¨æœ¬æœºé…ç½®çš„gradleç‰ˆæœ¬ gradlwå’ŒgradleåŒºåˆ« gradlewå®é™…æ˜¯ä¸€ä¸ªè„šæœ¬æ–‡ä»¶ï¼Œå®ƒæ˜¯åœ¨gradleå·¥ç¨‹çš„æ ¹ç›®å½•ä¸‹é¢ï¼Œå¦‚æœæ˜¯windowsçš„è¯ï¼Œä¼šæ‰§è¡Œgradlew.batæ–‡ä»¶ï¼Œè¿™ä¸ªåœ¨å‰é¢é€šè¿‡å‘½ä»¤åˆå§‹åŒ–å·¥ç¨‹çš„æ—¶å€™å¯ä»¥çœ‹åˆ°ï¼Œå…¶ä¸­gradlewè„šæœ¬ä¼šé€šè¿‡gradle/wrapper/gradle-wrapper.jaræ¥ä½¿ç”¨é¡¹ç›®ä¸­é…ç½®çš„gradleç‰ˆæœ¬ï¼Œè€Œgradleå‘½ä»¤æ˜¯ä½¿ç”¨æœ¬æœºé…ç½®çš„gradleç‰ˆæœ¬ã€‚\nGradleä¸­task taskå¯ä»¥è®¤ä¸ºæ˜¯gradleä¸­æœ€å°æ‰§è¡Œå•å…ƒï¼Œæ­£æ˜¯å› ä¸ºæœ‰äº†taskï¼Œgradleæ¡†æ¶æ‰èƒ½æœ‰åºçš„å·¥ä½œã€‚å®é™…ä¸Šæ ¹æ® Gradle æ„å»ºé¡¹ç›®çš„æµç¨‹ï¼Œæ˜¯å…ˆæŠŠæ‰€æœ‰çš„ .gradle è„šæœ¬æ‰§è¡Œä¸€éï¼Œç¼–è¯‘ç”Ÿæˆå¯¹åº”çš„ Gradleã€Settingã€Project å¯¹è±¡ï¼Œç„¶åæ ¹æ®æˆ‘ä»¬åœ¨æ„å»ºè„šæœ¬ä¸­è®¾ç½®çš„æ„å»ºé…ç½®ï¼Œç”Ÿæˆä¸€å¼  Task ç»„æˆçš„ï¼šæœ‰å‘æ— ç¯å›¾ï¼Œå…ˆæ¥çœ‹çœ‹è¿™å¼ å›¾: å·¦è¾¹è¡¨ç¤ºçš„æ˜¯taskä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œå³è¾¹è¡¨ç¤ºçš„æ˜¯é¡¹ç›®æ„å»ºè¿‡ç¨‹ä¸­è¦ç»è¿‡çš„ä»»åŠ¡ï¼Œæ­£æ˜¯å› ä¸ºæœ‰äº†è¿™äº›ä»»åŠ¡ï¼Œé¡¹ç›®æ‰èƒ½æ„å»ºå‡ºæ¥ã€‚\nå®é™…ä¸Šåœ¨gradleæ„å»ºè¿‡ç¨‹ä¸­ï¼Œä¼šæŠŠæ¯ä¸€ä¸ªå·¥ç¨‹çš„build.gradleæ–‡ä»¶ä¼šæ„å»ºæˆä¸€ä¸ªprojectå¯¹è±¡ï¼Œè€Œè¯¥projectå¯¹è±¡ç”±ä¸€ä¸ªä¸ªçš„taskç»„æˆï¼Œæ¯”å¦‚åœ¨æ„å»ºandroidé¡¹ç›®çš„æ—¶å€™ä¼šæœ‰ç¼–è¯‘javaä»£ç çš„taskï¼Œç¼–è¯‘èµ„æºçš„taskç­‰ã€‚è¿™äº›taskå…¶å®æ˜¯å®šä¹‰åœ¨androidæ’ä»¶ä¸­ï¼Œå…³äºæ’ä»¶åé¢å†è¯´ã€‚\næ¯”å¦‚androidå·¥ç¨‹ä¸­æœ‰å¾ˆå¤šæˆ‘ä»¬ç†Ÿæ‚‰çš„taskï¼š å¯ä»¥çœ‹åˆ°åœ¨buildè¿™ä¸ªåˆ†ç»„ä¸‹é¢æœ‰å¾ˆå¤šç†Ÿæ‚‰çš„taskï¼Œæ¯”å¦‚æœ‰assembleçš„taskï¼Œå®ƒæ˜¯ç”¨æ¥æ‰“åŒ…çš„taskã€‚è€Œå®ƒä»¬åˆä¾èµ–å…¶å®ƒçš„taskï¼Œæœ€ç»ˆä¸€ä¸ªä¸ªçš„taskè¢«æ‰§è¡Œå®Œï¼ŒåŒ…ä¹Ÿæ‰“å‡ºæ¥äº†ã€‚ æ¯”å¦‚æˆ‘åœ¨ç»ˆç«¯ä¸Šè¿è¡Œ./gradlew buildçš„æ—¶å€™ï¼Œä¼šæ‰§è¡Œä¸€å¤§å †çš„taskï¼š Task æ˜¯å®Œæˆä¸€ç±»ä»»åŠ¡ï¼Œå®é™…ä¸Šå¯¹åº”çš„ä¹Ÿæ˜¯ä¸€ä¸ªå¯¹è±¡ã€‚è€Œ Task æ˜¯ç”±æ— æ•°ä¸ª Action ç»„æˆçš„ï¼ŒAction ä»£è¡¨çš„æ˜¯ä¸€ä¸ªä¸ªå‡½æ•°ã€æ–¹æ³•ï¼Œæ¯ä¸ª Task éƒ½æ˜¯ä¸€å † Action æŒ‰åºç»„æˆçš„æ‰§è¡Œå›¾ï¼Œå°±å¥½åƒæˆ‘ä»¬åœ¨ Class çš„ main å‡½æ•°ä¸­æŒ‰ç…§é€»è¾‘è°ƒç”¨ä¸€ç³»åˆ—æ–¹æ³•ä¸€æ ·ã€‚\nåˆ›å»ºtask 1 2 3 4 5 6 7 8 9 10 11 task hello{ println \u0026#34;hello world\u0026#34; } task(hello2){ println \u0026#34;hello world2\u0026#34; } task (\u0026#39;hello3\u0026#39;){ println \u0026#34;hello world3\u0026#34; } è¿è¡Œtask é€šè¿‡./gradlew taskåæ¥è¿è¡Œtaskï¼Œè¿è¡Œç»“æœå¦‚ä¸‹ï¼š å¦‚æœæ˜¯å­æ¨¡å—çš„è¯ï¼Œåˆ™é€šè¿‡./gradlew æ¨¡å—å:taskåè¿è¡Œtaskï¼Œè¿è¡Œç»“æœå¦‚ä¸‹ï¼š è¿™æ˜¯åœ¨å·¥ç¨‹çš„æ ¹ç›®å½•ä¸‹build.gradleå®šä¹‰çš„ä¸‰ä¸ªtaskï¼Œç„¶åé€šè¿‡./gradlew helloå‘½ä»¤æ¥æ‰§è¡Œhelloè¿™ä¸ªtaskï¼Œè€Œå…¶å®ƒä¸¤ä¸ªtaskä¹Ÿè¾“å‡ºæ—¥å¿—ï¼Œæ˜¯å› ä¸ºè¿™å‡ æ¡æ—¥å¿—éƒ½æ˜¯åœ¨é…ç½®é˜¶æ®µè¾“å‡ºï¼Œå…³äºgradleçš„ç”Ÿå‘½å‘¨æœŸåé¢ä¼šè¯´ã€‚é‚£ä¸ºä»€ä¹ˆgradlewæ‰§è¡Œè„šæœ¬å°±åœ¨æ ¹ç›®å½•ä¸‹ï¼Œè¿˜éœ€è¦./æ¥æ‰§è¡Œè¯¥è„šæœ¬å‘¢ï¼Ÿ è¿™æ˜¯å› ä¸ºåœ¨ç»ˆç«¯é‡Œé¢ï¼Œéœ€è¦é€šè¿‡./æ¥è·å–å½“å‰ç›®å½•ï¼Œå¦‚æœä¸åŠ çš„è¯ï¼Œä¼šå¯¼è‡´ç»ˆç«¯åœ¨ç›®å½•ä¸‹æ‰¾ä¸åˆ°ã€‚\nå…¶å®taskæ˜¯projectçš„æ–¹æ³•ï¼Œprojectè¡¨ç¤ºçš„æ˜¯æ¨¡å—åœ¨åˆå§‹åŒ–é˜¶æ®µä¼šç”Ÿæˆï¼Œä¸Šé¢ä½¿ç”¨task hello{}ï¼Œåˆ›å»ºçš„taskå®é™…æ˜¯ä¼ å…¥äº†actionçš„é—­åŒ…ï¼Œå®ƒæ˜¯åœ¨æ„å»ºçš„æ—¶å€™è¢«è°ƒç”¨çš„ï¼š åœ¨åˆ›å»ºtaskçš„æ—¶å€™å¯ä»¥æŒ‡å®šå…¶ä»–å±æ€§ï¼Œå¯ä»¥é€šè¿‡taskå…¶ä»–çš„é‡è½½æ–¹æ³•æ¥åˆ›å»ºï¼š\n1 2 3 task demo1(group: \u0026#34;demoç»„\u0026#34;,name:\u0026#34;demo2\u0026#34;,description:\u0026#34;æˆ‘æ˜¯demo2çš„task\u0026#34;,action:{ println(\u0026#34;æˆ‘æ˜¯demo2 taskçš„action\u0026#34;) }) æ¯”å¦‚åœ¨æ„å»ºdemo1çš„æ—¶å€™ï¼Œç”³æ˜äº†å…¶å®ƒå±æ€§ï¼Œæ­¤å¤„çš„actionè·Ÿä¸Šé¢å†™åœ¨æ‹¬å·å¤–é¢æ˜¯ä¸€å›äº‹ï¼Œåªä¸è¿‡æ­¤å¤„æ˜¯é€šè¿‡mapæ¥åˆ›å»ºçš„ï¼Œè¿˜æœ‰ä¸€ç‚¹ï¼Œmapä¸­æŒ‡å®šçš„nameä¸ä¼šç”Ÿæ•ˆï¼Œä¼šè¢«demo1çš„åå­—ç»™è¦†ç›–äº†ï¼Œç›®å‰å‘ç°æ²¡ä»€ä¹ˆä½œç”¨ï¼Œæ‰§è¡Œç»“æœå¦‚ä¸‹ï¼š task.dofirstå’Œdolast doFirstæ˜¯taskæ‰§è¡Œå‰è¦è°ƒç”¨çš„actionï¼ŒdoLastæ˜¯taskæ‰§è¡Œåè¦è°ƒç”¨çš„actionï¼š\n1 2 3 4 5 6 7 8 9 task demo2{ println(\u0026#34;demo2\u0026#34;) doFirst{ println(\u0026#34;demo2 çš„ doFirst\u0026#34;) } doLast{ println(\u0026#34;demo2 çš„ doLast\u0026#34;) } } å…³äºtaskå…¶å®ƒçš„ä½¿ç”¨å¯ä»¥åœ¨çœ‹ä¸‰æ–¹æ’ä»¶çš„æ—¶å€™å†çœ‹ã€‚\nGradleæ’ä»¶ gradleæ’ä»¶ï¼ˆpluginï¼‰æ˜¯æ„å»ºé¡¹ç›®æ—¶å€™ç”¨åˆ°çš„ï¼Œå®ƒå…¶å®æ˜¯ç”±ä¸€ç³»åˆ—çš„taskç»„æˆçš„ï¼Œå…¶å®androidçš„å·¥ç¨‹ï¼Œgoogleå·²ç»å¸®æˆ‘ä»¬å®ç°äº†android gradle pluginï¼ˆagpï¼‰ã€‚googleä¹Ÿæ˜¯éµå¾ªäº†gradleçš„taskä¾èµ–æ³•åˆ™ï¼Œæ„æˆä¸€ä¸ªæœ‰åºæ— å‘å›¾ã€‚æœ€ç»ˆå»æ‰§è¡Œä¸€ä¸ªä¸ªçš„takã€‚\næ’ä»¶ä¸»è¦é€šè¿‡å®šä¹‰ä»“åº“ï¼Œç„¶åå®šä¹‰æ’ä»¶çš„åå­—ï¼Œæ¯”å¦‚å®‰å“ä¸­ä¾èµ–agpæ˜¯é€šè¿‡å¦‚ä¸‹çš„æ–¹å¼ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 buildscript { repositories { google() jcenter() } dependencies { classpath \u0026#39;com.android.tools.build:gradle:3.5.3\u0026#39; // NOTE: Do not place your application dependencies here; they belong // in the individual module build.gradle files } } allprojects { repositories { google() jcenter() } } buildscriptæ˜¯rootProjectçš„æ–¹æ³•ï¼Œå®ƒå£°æ˜æ’ä»¶çš„ä»“åº“ã€æ·»åŠ æ’ä»¶ä¸“ç”¨é—­åŒ… allprojectsä¸»è¦æ˜¯æŒ‡æ‰€æœ‰çš„æ¨¡å—éœ€è¦çš„ä¸‰æ–¹ä¾èµ–åº“æ—¶å€™çš„ä»“åº“ åƒä¸Šé¢å®šäº†agpæ’ä»¶3.5.3ï¼Œç„¶ååœ¨appæ¨¡å—ä¸­é€šè¿‡apply plugin: 'com.android.application'æ¥ä½¿ç”¨è¿™ä¸ªæ’ä»¶ï¼Œè€Œappæ¨¡å—é€‰çš„android{}å°±æ˜¯æ¥è‡ªäºè¯¥æ’ä»¶ï¼Œæˆ‘ä»¬å«ä»–æ˜¯DSLé…ç½®å—ã€‚ å…¶å®åƒandroid{}çš„å®ç°åœ¨æ’ä»¶ä¸­æ˜¯é€šè¿‡delegate+é—­åŒ…å®ç° DSL é…ç½®å—\né¦–å…ˆæŠŠé—­åŒ…å®šä¹‰å¥½ï¼š 1 2 3 4 5 6 7 8 9 10 11 12 def android = { compileSdkVersion 25 buildToolsVersion \u0026#34;25.0.2\u0026#34; // è¿™ä¸ªå¯¹åº”ç›¸åº”çš„æ–¹æ³• defaultConfig { minSdkVersion 15 targetSdkVersion 25 versionCode 1 versionName \u0026#34;1.0\u0026#34; } } å®šä¹‰æ•°æ®æ¨¡å‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 class Android { int mCompileSdkVersion String mBuildToolsVersion BefaultConfig mBefaultConfig Android() { this.mBefaultConfig = new BefaultConfig() } void defaultConfig(Closure closure) { closure.setDelegate(mProductFlavor) closure.setResolveStrategy(Closure.DELEGATE_FIRST) closure.call() } } class BefaultConfig { int mVersionCode String mVersionName int mMinSdkVersion int mTargetSdkVersion } ç»‘å®šæ•°æ® 1 2 3 Android bean = new Android() android.delegate = bean//å°†ä¸Šé¢å®šä¹‰å¥½çš„beanç»™è®¾ç½®åˆ°é—­åŒ…é‡Œé¢ android.call()//é—­åŒ…çš„è°ƒç”¨ Gradleæ„å»ºè¿‡ç¨‹ å…¶å®æ„å»ºè¿‡ç¨‹å°±æ˜¯æŒ‡ç¼–è¯‘å¯¹åº”çš„.gradleæ–‡ä»¶ï¼Œç„¶åç”Ÿæˆå¯¹è±¡ï¼Œæœ€åæ‰§è¡Œtaskã€‚ ä¸»è¦åˆ†ä¸ºä¸‰ä¸ªæ­¥éª¤ï¼š\nInitializationï¼šåˆå§‹åŒ–é˜¶æ®µï¼ŒæŒ‰é¡ºåºæ‰§è¡Œinit.gradleï¼Œsetting.gradleï¼Œç”ŸæˆGradleã€Settingã€Projectå¯¹è±¡ Configurationï¼šé…ç½®é˜¶æ®µï¼ŒæŒ‰é¡ºåºæ‰§è¡Œ root build.gradle -\u0026gt; å­é¡¹ç›® build.gradle è„šæœ¬ï¼Œç”Ÿæˆ Task æ‰§è¡Œæµç¨‹å›¾ Executionï¼šæ‰§è¡Œé˜¶æ®µï¼ŒæŒ‰ç…§ Task æ‰§è¡Œå›¾é¡ºåºè¿è¡Œæ¯ä¸€ä¸ª Taskï¼Œå®Œæˆä¸€ä¸ªä¸ªæ­¥å¥ï¼Œç”Ÿæˆæœ€ç»ˆ APK æ–‡ä»¶ æ•´ä¸ªæµç¨‹å¦‚ä¸‹ï¼š é€šè¿‡æµç¨‹å›¾è§‚å¯Ÿï¼Œæˆ‘ä»¬å¯ä»¥åœ¨åˆé€‚çš„æ—¶æœºç›‘å¬gradleçš„æ„å»ºè¿‡ç¨‹ï¼Œä¹Ÿå°±æ˜¯é’©å­æ–¹æ³•ã€‚ ä¸‹é¢é€šè¿‡è¿™äº›é’©å­æ–¹æ³•æ¥è·å–é¡¹ç›®æ„å»ºå„ä¸ªé˜¶æ®µã€ä»»åŠ¡çš„è€—æ—¶æƒ…å†µï¼Œåœ¨setting.gradleä¸­æ·»åŠ å¦‚ä¸‹ä»£ç ï¼š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 long beginOfSetting = System.currentTimeMillis() def beginOfConfig def configHasBegin = false def beginOfProjectConfig = new HashMap() def beginOfProjectExcute gradle.projectsLoaded { println \u0026#39;åˆå§‹åŒ–é˜¶æ®µï¼Œè€—æ—¶ï¼š\u0026#39; + (System.currentTimeMillis() - beginOfSetting) + \u0026#39;ms\u0026#39; } gradle.beforeProject { project -\u0026gt; if (!configHasBegin) { configHasBegin = true beginOfConfig = System.currentTimeMillis() } beginOfProjectConfig.put(project, System.currentTimeMillis()) } gradle.afterProject { project -\u0026gt; def begin = beginOfProjectConfig.get(project) println \u0026#39;é…ç½®é˜¶æ®µï¼Œ\u0026#39; + project + \u0026#39;è€—æ—¶ï¼š\u0026#39; + (System.currentTimeMillis() - begin) + \u0026#39;ms\u0026#39; } gradle.taskGraph.whenReady { println \u0026#39;é…ç½®é˜¶æ®µï¼Œæ€»å…±è€—æ—¶ï¼š\u0026#39; + (System.currentTimeMillis() - beginOfConfig) + \u0026#39;ms\u0026#39; beginOfProjectExcute = System.currentTimeMillis() } gradle.taskGraph.beforeTask { task -\u0026gt; task.doFirst { task.ext.beginOfTask = System.currentTimeMillis() } task.doLast { println \u0026#39;æ‰§è¡Œé˜¶æ®µï¼Œ\u0026#39; + task + \u0026#39;è€—æ—¶ï¼š\u0026#39; + (System.currentTimeMillis() - task.beginOfTask) + \u0026#39;ms\u0026#39; } } gradle.buildFinished { println \u0026#39;æ‰§è¡Œé˜¶æ®µï¼Œè€—æ—¶ï¼š\u0026#39; + (System.currentTimeMillis() - beginOfProjectExcute) + \u0026#39;ms\u0026#39; } ç”±äºåœ¨setting.gradleæ‰§è¡Œå‰ï¼ŒGradleå¯¹è±¡å…¶å®å·²ç»ç”Ÿæˆï¼Œæ‰€ä»¥é€šè¿‡gradleå¯¹è±¡çš„projectsLoadedå›è°ƒè·å–åˆå§‹åŒ–æ—¶é—´ã€‚ç¬¬ä¸€æ¬¡è¿›å…¥åˆ°beforeProjectçš„æ—¶å€™è®°å½•é…ç½®çš„èµ·å§‹æ—¶é—´ï¼Œå¹¶è®°å½•æ¯ä¸€ä¸ªprojectçš„é…ç½®èµ·å§‹æ—¶é—´ï¼Œç„¶ååœ¨afterProjectä¸­ç®—å‡ºæ¯ä¸€ä¸ªprojecté…ç½®çš„æ—¶é—´ã€‚ç„¶åé€šè¿‡gradle.taskGraphæ¥è·å–æœ‰åºæ— å‘å›¾ï¼Œç„¶åé€šè¿‡whenReadyæ–¹æ³•å›è°ƒç®—å‡ºæ€»çš„é…ç½®æ—¶é—´ã€‚æœ€åé€šè¿‡æœ‰åºæ— å‘å›¾çš„beforeTaskæ¥æ·»åŠ taskçš„å¼€å§‹å’Œç»“æŸçš„æ‰§è¡Œæ—¶é—´æ¥ç®—å‡ºtaskçš„æ‰§è¡Œè€—æ—¶ã€‚æœ€åé€šè¿‡gradleçš„buildFinishæ¥è·å–æ€»å…±çš„æ„å»ºæ—¶é—´ã€‚\ngradleæ‰“åŒ…é€Ÿåº¦ä¼˜åŒ– é¦–å…ˆäº†è§£ä¸‹å®‰å“ä¸­çš„variantæ˜¯ä»€ä¹ˆæ„æ€ï¼Œå®ƒè¡¨ç¤ºä¸€ä¸ªåŒ…çš„å˜ä½“ï¼Œå…¶ä¸­å˜ä½“æ˜¯ç”±productFlavorï¼ˆäº§å“é£å‘³ï¼‰å’ŒbuildTypeï¼ˆæ„å»ºç±»å‹ï¼‰ç»„åˆè€Œæˆçš„ã€‚å…¶ä¸­productFlavoræ˜¯ç”±ç»´åº¦å’Œæ¸ é“æ„æˆçš„ï¼ŒbuildTypeæŒ‡çš„æ˜¯debugè¿˜æ˜¯releaseï¼Œæ¯”å¦‚ç»´åº¦å¯ä»¥é…ç½®ä»·æ ¼å’Œæ¸ é“çš„ä¸¤ä¸ªç»´åº¦ï¼Œè€Œæ¸ é“å¯ä»¥é…ç½®googleã€xiaomiç­‰æ¸ é“ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 android { // å®šä¹‰ buildTypesï¼ˆæ„å»ºç±»å‹ï¼‰ buildTypes { debug { minifyEnabled false applicationIdSuffix \u0026#34;.debug\u0026#34; } release { minifyEnabled true proguardFiles getDefaultProguardFile(\u0026#39;proguard-android-optimize.txt\u0026#39;), \u0026#39;proguard-rules.pro\u0026#39; } } // å®šä¹‰ productFlavorsï¼ˆäº§å“é£å‘³ï¼‰ flavorDimensions \u0026#39;channel\u0026#39;, \u0026#39;pricing\u0026#39; productFlavors { //é…ç½®æ¸ é“ç»´åº¦ä¸‹ä¸¤ä¸ªå˜ä½“ google { dimension \u0026#39;channel\u0026#39; } xiaomi { dimension \u0026#39;channel\u0026#39; } //é…ç½®ä»·æ ¼ä¸‹ä¸¤ä¸ªå˜ä½“ free { dimension \u0026#39;pricing\u0026#39; } vip { dimension \u0026#39;pricing\u0026#39; } } // åœ¨è¿™é‡Œçš„ `productFlavors` å’Œ `buildTypes` ç»„åˆå½¢æˆä¸åŒçš„ variants } æ‰€ä»¥ä¸Šé¢é€šè¿‡ç»´åº¦å’Œæ¸ é“ç»„åˆåçš„productFlavoræœ‰googleFreeã€googleVipã€xiaomiFreeã€xiaomiVipå››ä¸ªï¼Œå†å’ŒbuildTypeç»„åˆåï¼Œå°±æ˜¯8ä¸ªå˜ä½“ï¼Œåˆ†åˆ«æ˜¯ï¼š\ngoogleFreeDebug googleFreeRelease googleVipDebug googleVipRelease xiaomiFreeDebug xiaomiFreeRelease xiaomiVipDebug xiaomiVipRelease çŸ¥é“äº†variantåï¼Œä¸‹é¢å°±æ˜¯äº†è§£ä¸‹æ‰“åŒ…äº†ï¼Œä¸€èˆ¬é€šè¿‡build AnalyzeæŸ¥çœ‹buildè¿‡ç¨‹ä¸­çš„ä¸€äº›è­¦å‘Šï¼Œä½¿ç”¨è¯¥å·¥å…·éœ€è¦å…ˆè¿›è¡Œbuildï¼Œç¬¬äºŒä¸ªå·¥å…·æ˜¯gradle profileå·¥å…·ï¼Œä¸€èˆ¬é€šè¿‡å¦‚ä¸‹å‘½ä»¤ï¼š\n1 2 ./gradlew installGoogleFreeDebug --build-cache -x lint -x test --warning-mode=none -Pkotlin.compiler.execution.strategy=in-process -PcompilerArgs=-Xlint:deprecation --no-configuration-cache --profile adb shell am start -n åŒ…å/åº”ç”¨ä¸»å…¥å£ å¦‚æœé€šè¿‡adbå‘½ä»¤å¯åŠ¨ä¸»å…¥å£çš„è¯ï¼Œéœ€è¦åœ¨æ¸…å•æ–‡ä»¶ä¸­ç»™ä¸»å…¥å£åŠ ä¸Šandroid:exported=\u0026quot;true\u0026quot;å±æ€§ï¼Œè£…åŒ…å®Œäº†åï¼Œæœ¬åœ°ä¼šç”Ÿæˆä¸€ä¸ªhtmlæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶ä¼šæœ‰gradleæ¯ä¸ªé˜¶æ®µçš„è€—æ—¶æƒ…å†µï¼Œå¹¶ä¸”ä¼šæœ‰æ¯ä¸ªtaskçš„è€—æ—¶ã€‚\nå†ä¸ªå°±æ˜¯gradle scanå·¥å…·ï¼Œä¸€èˆ¬é€šè¿‡å¦‚ä¸‹å‘½ä»¤ï¼š\n1 2 ./gradlew installGoogleFreeDebug --build-cache -x lint -x test --warning-mode=none -Pkotlin.compiler.execution.strategy=in-process -PcompilerArgs=-Xlint:deprecation --no-configuration-cache --scan adb shell am start -n åŒ…å/åº”ç”¨ä¸»å…¥å£ scanä¼šç”Ÿæˆä¸€ä¸ªåœ¨çº¿çš„ç½‘é¡µï¼Œç¬¬ä¸€æ¬¡ä½¿ç”¨éœ€è¦é‚®ç®±æ ¡éªŒï¼Œå®ƒçš„ä¿¡æ¯æ¯”profileæ›´å…¨é¢ï¼Œæ›´åŠ æ™ºèƒ½ï¼Œå…¶ä¸­performanceè·Ÿprofileä¸­æ•ˆæœå·®ä¸å¤šï¼Œå®ƒå¤šäº†timelineé€‰é¡¹ï¼Œè¡¨ç¤ºä»€ä¹ˆæ—¶å€™æ‰§è¡Œäº†ä»€ä¹ˆtaskï¼Œswitchsé€‰é¡¹è¡¨ç¤ºä¸€äº›å»ºè®®ï¼Œæ¯”å¦‚ç¼“å­˜æ²¡å¼€ï¼Œä¼šæç¤ºoffã€‚ å…¶å®gradleä¼˜åŒ–æœ€ç›´æ¥æ˜¯é€šè¿‡ç»„ä»¶åŒ–æ¥å¼€å‘ï¼Œå¦‚æœå…¨appç¼–è¯‘çš„è¯ï¼Œç»„ä»¶è¶Šå¤šï¼Œéœ€è¦çš„æ—¶é—´è¶Šé•¿ï¼Œæ‰€ä»¥é€šè¿‡ç»„ä»¶åŒ–æ¥é™ä½æ‰“åŒ…æ—¶é—´æ˜¯æœ€ç›´æ¥çš„ï¼ŒæŠŠä¸€äº›å…¶ä»–ä¾èµ–çš„ç»„ä»¶é€šè¿‡aarè¿›è¡Œä¾èµ–æˆ–è¿œç¨‹ä¾èµ–ã€‚ å‚è€ƒï¼š Gradle çˆ¬å‘æŒ‡å— \u0026ndash; æ¦‚å¿µåˆè§£ã€Grovvy è¯­æ³•ã€å¸¸è§ API Gradle çˆ¬å‘æŒ‡å— \u0026ndash; ç†è§£ Pluginã€Taskã€æ„å»ºæµç¨‹ æ·±åº¦æ¢ç´¢ Gradle è‡ªåŠ¨åŒ–æ„å»ºæŠ€æœ¯ï¼ˆä¸‰ã€Gradle æ ¸å¿ƒè§£å¯†ï¼‰\n","date":"2025-02-07T00:00:00Z","permalink":"http://xiangcman.xyz/p/gradle%E5%BF%85%E5%A4%87/","title":"Gradleå¿…å¤‡"},{"content":"Recyclerviewç³»åˆ— ç¼“å­˜ç›¸å…³ RecyclerView ç¼“å­˜æœºåˆ¶ | å¦‚ä½•å¤ç”¨è¡¨é¡¹ï¼Ÿ RecyclerView ç¼“å­˜æœºåˆ¶ | å›æ”¶äº›ä»€ä¹ˆï¼Ÿ RecyclerView ç¼“å­˜æœºåˆ¶ | å›æ”¶åˆ°å“ªå»ï¼Ÿ RecyclerViewç¼“å­˜æœºåˆ¶ | scrap view çš„ç”Ÿå‘½å‘¨æœŸ RecyclerView é¢è¯•é¢˜ | æ»šåŠ¨æ—¶è¡¨é¡¹æ˜¯å¦‚ä½•è¢«å¡«å……æˆ–å›æ”¶çš„ï¼Ÿ RecyclerView é¢è¯•é¢˜ | å“ªäº›æƒ…å†µä¸‹è¡¨é¡¹ä¼šè¢«å›æ”¶åˆ°ç¼“å­˜æ± ï¼Ÿ RecyclerView åˆ·æ–°åˆ—è¡¨æ•°æ®çš„ notifyDataSetChanged() ä¸ºä»€ä¹ˆæ˜¯æ˜‚è´µçš„? æŒæ¡è¿™17å¼ å›¾ï¼Œæ²¡äººæ¯”ä½ æ›´æ‡‚RecyclerViewçš„é¢„åŠ è½½ ã€åŠ¨ç”»å›¾è§£ã€‘è¿™ä¸ªå€¼å–å¯¹äº†ï¼ŒViewPager2æ‰èƒ½çºµäº«ä¸æ»‘ åŠ¨ç”»ç›¸å…³ RecyclerView åŠ¨ç”»åŸç† | æ¢ä¸ªå§¿åŠ¿çœ‹æºç ï¼ˆpre-layoutï¼‰ RecyclerView åŠ¨ç”»åŸç† | pre-layoutï¼Œpost-layout ä¸ scrap ç¼“å­˜çš„å…³ç³»ï¼‰ RecyclerView åŠ¨ç”»åŸç† | å¦‚ä½•å­˜å‚¨å¹¶åº”ç”¨åŠ¨ç”»å±æ€§å€¼ï¼Ÿï¼‰ ä¼˜åŒ–ç›¸å…³ æµ…è°ˆRecyclerViewçš„æ€§èƒ½ä¼˜åŒ– RecyclerView æ€§èƒ½ä¼˜åŒ– | æŠŠåŠ è½½è¡¨é¡¹è€—æ—¶å‡åŠ (ä¸€) RecyclerViewæ€§èƒ½ä¼˜åŒ–ä¹‹å¼‚æ­¥é¢„åŠ è½½ Kotlinç³»åˆ— Kotlinä¸­çš„åç¨‹ã€ä¸Šä¸‹æ–‡å’Œä½œç”¨åŸŸ æŠ½ä¸å‰¥èŒ§èŠåç¨‹ä¹‹æ·±å…¥ç†è§£ContinuationåŸç† Kotlin æºç é‡Œæˆå¨çš„ noinline å’Œ crossinline æ˜¯å¹²å˜›çš„ï¼Ÿçœ‹å®Œè¿™ä¸ªè§†é¢‘ä½ è½¬å¤´ä¹Ÿå†™äº†ä¸€å¨ æŠ½ä¸å‰¥èŒ§èŠKotlinåç¨‹ä¹‹åç¨‹å¼‚å¸¸å¤„ç†æœºåˆ¶åˆ†æ kotlinçš„æ³›å‹ SurfaceFlingerç³»åˆ— Androidåº”ç”¨ç¨‹åºä¸SurfaceFlingeræœåŠ¡çš„å…³ç³»æ¦‚è¿°å’Œå­¦ä¹ è®¡åˆ’ Androidç³»ç»ŸSurfaceæœºåˆ¶çš„SurfaceFlingeræœåŠ¡ç®€è¦ä»‹ç»å’Œå­¦ä¹ è®¡åˆ’ Activityç³»åˆ— Androidåº”ç”¨ç¨‹åºçª—å£ï¼ˆActivityï¼‰å®ç°æ¡†æ¶ç®€è¦ä»‹ç»å’Œå­¦ä¹ è®¡åˆ’ WMSç³»åˆ— Androidçª—å£ç®¡ç†æœåŠ¡WindowManagerServiceçš„ç®€è¦ä»‹ç»å’Œå­¦ä¹ è®¡åˆ’ èµ„æºæ‰“åŒ…ç³»åˆ— Androidåº”ç”¨ç¨‹åºèµ„æºçš„ç¼–è¯‘å’Œæ‰“åŒ…è¿‡ç¨‹åˆ†æ Androidåº”ç”¨ç¨‹åºèµ„æºçš„æŸ¥æ‰¾è¿‡ç¨‹åˆ†æ Android Apk ç¼–è¯‘æ‰“åŒ…æµç¨‹ï¼Œäº†è§£ä¸€ä¸‹~ AssetManagerç³»åˆ— Androidèµ„æºç®¡ç†æ¡†æ¶ï¼ˆAsset Managerï¼‰ç®€è¦ä»‹ç»å’Œå­¦ä¹ è®¡åˆ’ ç¡¬ä»¶åŠ é€Ÿç³»åˆ— Androidåº”ç”¨ç¨‹åºUIç¡¬ä»¶åŠ é€Ÿæ¸²æŸ“æŠ€æœ¯ç®€è¦ä»‹ç»å’Œå­¦ä¹ è®¡åˆ’ ASMç›¸å…³ Android è¿›é˜¶ä¹‹è·¯ï¼šASM ä¿®æ”¹å­—èŠ‚ç ï¼Œè¿™æ ·å­¦å°±å¯¹äº†ï¼ Gradleç›¸å…³ Gradle çˆ¬å‘æŒ‡å— \u0026ndash; å¯¼è®º Gradle çˆ¬å‘æŒ‡å— \u0026ndash; æ¦‚å¿µåˆè§£ã€Grovvy è¯­æ³•ã€å¸¸è§ API Gradle çˆ¬å‘æŒ‡å— \u0026ndash; ç†è§£ Pluginã€Taskã€æ„å»ºæµç¨‹ Gradle çˆ¬å‘æŒ‡å— \u0026ndash; Gradle æ ¸å¿ƒæ¨¡å‹ã€Hook å‡½æ•°ã€ext æ‰©å±•å±æ€§ã€Project API æ·±åº¦æ¢ç´¢ Gradle è‡ªåŠ¨åŒ–æ„å»ºæŠ€æœ¯ï¼ˆä¸€ã€Gradle æ ¸å¿ƒé…ç½®ç¯‡ï¼‰ æ·±åº¦æ¢ç´¢ Gradle è‡ªåŠ¨åŒ–æ„å»ºæŠ€æœ¯ï¼ˆäºŒã€Groovy ç­‘åŸºç¯‡ï¼‰ æ·±åº¦æ¢ç´¢ Gradle è‡ªåŠ¨åŒ–æ„å»ºæŠ€æœ¯ï¼ˆä¸‰ã€Gradle æ ¸å¿ƒè§£å¯†ï¼‰ æ·±åº¦æ¢ç´¢ Gradle è‡ªåŠ¨åŒ–æ„å»ºæŠ€æœ¯ï¼ˆå››ã€è‡ªå®šä¹‰ Gradle æ’ä»¶ï¼‰ æ·±åº¦æ¢ç´¢ Gradle è‡ªåŠ¨åŒ–æ„å»ºæŠ€æœ¯ï¼ˆäº”ã€Gradle æ’ä»¶æ¶æ„å®ç°åŸç†å‰–æ â€” ä¸Šï¼‰ æ·±åº¦æ¢ç´¢ Gradle è‡ªåŠ¨åŒ–æ„å»ºæŠ€æœ¯ï¼ˆäº”ã€Gradle æ’ä»¶æ¶æ„å®ç°åŸç†å‰–æ â€” ä¸‹ï¼‰ æ·±å…¥æ¢ç´¢ Gradle è‡ªåŠ¨åŒ–æ„å»ºæŠ€æœ¯ï¼ˆä¹ã€Gradle æ’ä»¶å¹³å°åŒ–æ¡†æ¶ ByteX æ¢ç§˜ä¹‹æ—…ï¼‰ è®¾è®¡æ¨¡å¼ç›¸å…³ Javaå¸¸ç”¨è®¾è®¡æ¨¡å¼(ä¸€) Javaå¸¸ç”¨è®¾è®¡æ¨¡å¼(äºŒ) Javaå¸¸ç”¨è®¾è®¡æ¨¡å¼(ä¸‰) ã€ŠAndroidæºç è®¾è®¡æ¨¡å¼è§£æã€‹è¯»ä¹¦ç¬”è®°â€”â€”Androidä¸­ä½ åº”è¯¥çŸ¥é“çš„è®¾è®¡æ¨¡å¼ æ€§èƒ½åˆ†æ Profilerç›¸å…³ä½¿ç”¨ Android Studioä¸­System Traceå‡ å¤§æ¿å— Android Studioä¸­æ–¹æ³•è°ƒç”¨(Call Chartã€Flame Chartã€Top Downã€Bottom Upã€Event)çš„å‡ ç§å±•ç°å½¢å¼è®²è§£ Android Studioä¸­å¡é¡¿æ£€æµ‹æ¨¡å—è®²è§£ Android Studioä¸­è€—ç”µé‡è®²è§£ Android Studioä¸­ç”Ÿæˆtraceçš„è·¯å¾„ Android Studioä¸­Heap Dumpè·å–å †çš„å¿«ç…§ Android Studioä¸­å¯¹traceè¿›è¡Œé‡‡æ ·æ”¶é›† Android Studioä¸­é‡‡é›†Javaæˆ–Kotlinçš„å†…å­˜å ç”¨ Android Studioä¸­é‡‡é›†Javaæˆ–Kotlinçš„æ–¹æ³•è°ƒç”¨ Android Studioä¸­é‡‡é›†nativeæ–¹æ³•çš„å†…å­˜å ç”¨ æ¸²æŸ“ç›¸å…³ æ£€æŸ¥GPUæ¸²æŸ“é€Ÿåº¦å’Œè¿‡åº¦ç»˜åˆ¶ å‡å°‘è¿‡åº¦ç»˜åˆ¶ æ€§èƒ½å’Œè§†å›¾å±‚æ¬¡ç»“æ„ ä½¿ç”¨ GPU æ¸²æŸ“æ¨¡å¼åˆ†æå·¥å…·è¿›è¡Œåˆ†æ æ”¹å–„å¸ƒå±€æ€§èƒ½ perfetto ä½¿ç”¨adbè¿›è¡Œæ•æ‰perfettoæ–‡ä»¶ perfettoå®˜ç½‘ä»‹ç» åœ¨å®‰å“å¹³å°è¿›è¡Œæ•æ‰perfettoæ–‡ä»¶ SystemTrace å¦‚ä½•è¿›è¡Œæµè§ˆsystemtraceæŠ¥å‘Š é€šè¿‡å‘½ä»¤å¯åŠ¨System Trace æ‰‹æœºä¸Šå¯åŠ¨System Trace å¤§ä½¬åšå®¢ç³»åˆ— è€ç½— Gracker ç¨‹åºå‘˜æ±ŸåŒå­¦ ","date":"2025-01-22T00:00:00Z","permalink":"http://xiangcman.xyz/p/%E9%AB%98%E8%B4%A8%E9%87%8F%E6%96%87%E7%AB%A0%E6%B1%87%E6%80%BB/","title":"é«˜è´¨é‡æ–‡ç« æ±‡æ€»"},{"content":"ä¸Šä¸€ç¯‡(RecyclerViewæ€§èƒ½ä¼˜åŒ–)ç†è®ºçŸ¥è¯†è®²è¿‡recyclerviewæœ‰å“ªäº›ä¼˜åŒ–ç‚¹ï¼Œè¯¥ç¯‡ä¸»è¦ç»“åˆç†è®ºçŸ¥è¯†æ¥å®è·µä¸‹ä¼˜åŒ–æ‰‹æ®µã€‚\nxmlå¸ƒå±€æ›¿æ¢ä¸ºåŠ¨æ€åˆ›å»º ä¸€ä¸ªç®€å•çš„textviewå…ˆé€šè¿‡xmlåˆ›å»ºï¼Œé€šè¿‡traceviewè§‚å¯Ÿè€—æ—¶ è¿™æ¬¡ä¸‰æ¬¡åˆ›å»ºviewholderçš„è€—æ—¶ï¼Œå…¶ä¸­ç¬¬ä¸€æ¬¡ç”±äºéœ€è¦ç±»åŠ è½½åˆ°jvmä¸­ï¼Œæ‰€ä»¥ä¼šè€—æ—¶é•¿ä¸€äº›ï¼Œåé¢çš„è¯ï¼ŒåŸºæœ¬åœ¨5mså·¦å³ã€‚ é€šè¿‡newçš„å½¢å¼åˆ›å»ºviewholderï¼š ç¬¬ä¸€æ¬¡è€—æ—¶åœ¨6msï¼Œç¬¬äºŒæ¬¡è€—æ—¶åœ¨4msï¼ŒåŸºæœ¬æ¯”xmlçš„å½¢å¼è¦å°‘ä¸ª1ms æ³¨æ„ï¼šè¿™é‡Œæ¼”ç¤ºçš„åªæ˜¯ä¸€ä¸ªç®€å•çš„textviewï¼Œå¦‚æœå¹³æ—¶å¼€å‘çš„å¸ƒå±€æ˜¯æ¯”è¾ƒå¤æ‚ï¼Œå¹¶ä¸”åµŒå¥—å±‚çº§æ¯”è¾ƒæ·±çš„è¯ï¼Œè¿™ç§å·®è·ä¼šæ›´åŠ æ˜æ˜¾ã€‚ é€šè¿‡perfettoè§‚å¯Ÿcreateè¿‡ç¨‹ï¼š åŸºæœ¬æ•°æ®å’Œtraceviewä¿æŒä¸€è‡´ã€‚ recyclerview.setHasFixSize(true) ç”¨äº†sethasfixsize(true)çš„æ—¶å€™ï¼Œä¼šé€šè¿‡consumePendingUpdateOperationsè§¦å‘recyclerviewçš„layoutè¿‡ç¨‹ï¼Œæ²¡æœ‰èµ°ä»æ ¹viewåˆ°recyclerviewçš„measureã€layoutè¿‡ç¨‹ï¼Œå®é™…sethasfixsize(true)ä¼šç»™choreographerå‘é€ä¸€æ¡callback_animalçš„æ¶ˆæ¯ï¼š å…¶å®æˆ‘ä»¬çš„å±æ€§åŠ¨ç”»ä¹Ÿæ˜¯è¿™ä¹ˆåšçš„ï¼Œç»™choreographerå‘é€ä¸€æ¡animalçš„æ¶ˆæ¯ã€‚sethasfixsize(true)åœ¨è¡¨é¡¹å°ºå¯¸ä¸å‘ç”Ÿå˜åŒ–çš„æ—¶å€™ä½¿ç”¨ï¼Œå‡å°‘ä¸å¿…è¦çš„measureè¿‡ç¨‹ã€‚\nsethasstableids(true)å’Œé‡å†™getItemIdï¼š è°ƒç”¨notifydatasetChangeåï¼Œä¸ä¼šèµ°oncreateviewholderï¼š ä»traceåˆ†æï¼š detachè¿‡ç¨‹è°ƒç”¨çš„æ˜¯scrapçš„ç¼“å­˜ï¼Œå¹¶ä¸”æ­¤æ—¶ä¸ä¼šå›è°ƒondetachfromwindowè¿‡ç¨‹ï¼Œå¹¶ä¸”éƒ½åŠ å…¥åˆ°äº†attachçš„scrapç¼“å­˜ä¸­ï¼Œåœ¨fillé˜¶æ®µé€šè¿‡é‡å†™çš„getItemIdæ‹¿åˆ°äº†viewholderï¼š è‡³äºä¸ºä»€ä¹ˆä¼šonbindï¼Œæ˜¯å› ä¸ºnotifyè¿‡åçš„itemçš„çŠ¶æ€å˜æˆäº†invalidçŠ¶æ€ï¼Œæ‰€ä»¥ä¼šé‡æ–°èµ°onbindè¿‡ç¨‹ã€‚\nrecyclerpoolå‡å°‘oncreateviewholderæ¬¡æ•°ï¼š tablayout+viewpager2ï¼Œå­é¡µé¢æ˜¯fragmentï¼Œæ¯ä¸ªfragmentä¸­çš„rvç”¨çš„viewholderæ˜¯åŒç§ç±»å‹ï¼Œæˆ‘ä»¬å°†recyclerpoolè®¾ç½®åœ¨activityä¸­ï¼Œç„¶åä¼ ç»™å­fragmentï¼Œè®¾ç½®recyclerpooléœ€è¦åœ¨setadapterä¹‹å‰ã€‚ æˆ‘ä»¬åœ¨ç¬¬ä¸€ä¸ªé¡µé¢æ»‘åŠ¨çš„æ—¶å€™ï¼Œä¼šæœ‰viewholderæ”¾åˆ°äº†recyclerpoolä¸­ï¼Œæ­¤æ—¶æˆ‘ä»¬æ»‘åŠ¨åˆ°ç¬¬äºŒä¸ªfragmentçš„æ—¶å€™ä¼šç”¨åˆ°recycerlpoolä¸­çš„viewholderã€‚ ä»debugçœ‹ï¼Œç»™å¦å¤–ä¸€ä¸ªrecyclerviewè®¾ç½®recyclerpoolæ—¶å€™ï¼Œå·²ç»å­˜åœ¨ä¸€ä¸ªviewholderï¼Œæ‰€ä»¥çŒœæµ‹è¯¥fragmentä¼šä½¿ç”¨åˆ°viewholderï¼Œæ—¥å¿—éªŒè¯ï¼š ä»æ—¥å¿—æ¥çœ‹ï¼Œç¬¬ä¸€ä¸ªviewholderåªæœ‰bindè¿‡ç¨‹ï¼Œæ²¡æœ‰createã€‚\n","date":"2025-01-17T00:00:00Z","permalink":"http://xiangcman.xyz/p/recyclerview%E4%BC%98%E5%8C%96%E5%AE%9E%E8%B7%B5/","title":"RecyclerViewä¼˜åŒ–å®è·µ"},{"content":" è¯´èµ·é¢„åŠ è½½ï¼Œå…¶å®ä¹‹å‰é¢è¯•çš„æ—¶å€™è¢«é—®åˆ°çš„ï¼Œç„¶åæœ€è¿‘çœ‹åˆ°ä¸€ç¯‡å…³äºé¢„åŠ è½½çš„æ–‡ç« ï¼Œç„¶åé¢‡æœ‰æ„Ÿå—ï¼Œå› æ­¤æ‰æœ‰è¯¥ç¯‡æ–‡ç« ã€‚ åœ¨recyclerviewçš„onAttachedToWindowæœ‰è¿™ä¹ˆä¸€å¥ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 /** * On L+, with RenderThread, the UI thread has idle time after it has passed a frame off to * RenderThread but before the next frame begins. We schedule prefetch work in this window. */ static final boolean ALLOW_THREAD_GAP_WORK = Build.VERSION.SDK_INT \u0026gt;= 21; @Override protected void onAttachedToWindow() { super.onAttachedToWindow(); //çœç•¥ä»£ç  if (ALLOW_THREAD_GAP_WORK) { // Register with gap worker mGapWorker = GapWorker.sGapWorker.get(); if (mGapWorker == null) { mGapWorker = new GapWorker(); // break 60 fps assumption if data from display appears valid // NOTE: we only do this query once, statically, because it\u0026#39;s very expensive (\u0026gt; 1ms) Display display = ViewCompat.getDisplay(this); float refreshRate = 60.0f; if (!isInEditMode() \u0026amp;\u0026amp; display != null) { float displayRefreshRate = display.getRefreshRate(); if (displayRefreshRate \u0026gt;= 30.0f) { refreshRate = displayRefreshRate; } } mGapWorker.mFrameIntervalNs = (long) (1000000000 / refreshRate); GapWorker.sGapWorker.set(mGapWorker); } mGapWorker.add(this); } } å¯ä»¥çœ‹åˆ°æœ‰ä¸€ä¸ªé™æ€å˜é‡ï¼ŒALLOW_THREAD_GAP_WORKæ˜¯å¤§äºç­‰äº21ï¼ˆAndroid5.0ï¼‰æ‰ä¼šä¸ºtrueï¼Œè¿™æ˜¯å› ä¸ºåœ¨5.0ä¹‹åï¼Œå¼•è¿›äº†RenderThreadçº¿ç¨‹ï¼Œä¸“é—¨ç”¨æ¥æ¸²æŸ“uiçº¿ç¨‹ç»˜åˆ¶å¥½çš„æ•°æ®ï¼Œæ¸²æŸ“å®Œåï¼Œä¼šæäº¤åˆ°äº‹å…ˆç”³è¯·çš„bufferqueueä¸­ï¼Œç„¶åå½“vsync-sfä¿¡å·æ¥çš„æ—¶å€™ï¼Œsufaceflingerä¼šå»å¯¹åº”appçš„bufferqueueä¸­å–å‡ºå‰é¢æäº¤çš„bufferæ•°æ®ï¼Œç„¶åè¿›è¡Œåˆæˆlayerï¼Œæœ€ç»ˆå±å¹•ï¼ˆhwcï¼‰æ”¶åˆ°è¯¥è¯·æ±‚åï¼Œè¿›è¡Œå›¾å±‚è¿›è¡Œåˆæˆï¼Œæœ€ç»ˆé€åˆ°å±å¹•ç¡¬ä»¶ä¸Šæ˜¾ç¤ºã€‚è¿™å°±æ˜¯ä¸€é’ˆä»åˆ›å»ºåˆ°æ¶ˆè´¹çš„è¿‡ç¨‹ã€‚ ç”±äºuiçº¿ç¨‹æŠŠç»˜åˆ¶å¥½çš„æ•°æ®ç»˜åˆ¶å¥½åï¼Œä¼šé€šçŸ¥renderthreadçº¿ç¨‹è¿›è¡Œæ¸²æŸ“ï¼Œç›´åˆ°ä¸‹ä¸€é’ˆæ¥çš„æ—¶å€™æ‰å¼€å§‹å·¥ä½œï¼Œæ­¤æ—¶ä¼šæœ‰ä¸»çº¿ç¨‹ç©ºé—²çš„æ—¶å€™ï¼Œrecyclerviewæ­£æ˜¯åˆ©ç”¨æ­¤ç©ºé—²æ—¶é—´æ¥è¿›è¡Œé¢„åŠ è½½ï¼Œè€Œå¦‚æœåœ¨ä¸‹ä¸€é’ˆæ¥ä¸´çš„æ—¶å€™ï¼Œé¢„åŠ è½½è¿˜æ²¡æœ‰å®Œæˆï¼Œé‚£ä¹ˆæ­¤æ—¶ä¼šæ”¾å¼ƒæ­¤æ¬¡çš„é¢„åŠ è½½ï¼Œäº†è§£åŸç†åï¼Œå¼€å§‹åˆ†æè¿‡ç¨‹ï¼š é¢„åŠ è½½çš„å¤„ç†ç±»æ˜¯GapWorkerç±»ï¼Œä¸€ä¸ªçº¿ç¨‹å¯¹åº”ä¸€ä¸ªGapWorkerï¼Œå®ƒæ˜¯å­˜å‚¨åœ¨ThreadLocalä¸­ã€‚GapWorkeræ˜¯ä¸€ä¸ªrunnableç±»ï¼Œå®ƒå¦‚ä½•è¦å·¥ä½œçš„è¯ï¼Œæ˜¯é€šè¿‡GapWorker.postFromTraversalå·¥ä½œçš„ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 void postFromTraversal(RecyclerView recyclerView, int prefetchDx, int prefetchDy) { if (recyclerView.isAttachedToWindow()) { if (RecyclerView.DEBUG \u0026amp;\u0026amp; !mRecyclerViews.contains(recyclerView)) { throw new IllegalStateException(\u0026#34;attempting to post unregistered view!\u0026#34;); } if (mPostTimeNs == 0) { mPostTimeNs = recyclerView.getNanoTime(); recyclerView.post(this); } } recyclerView.mPrefetchRegistry.setPrefetchVector(prefetchDx, prefetchDy); } å¯ä»¥çœ‹å‡ºæ¥å®é™…æ˜¯é€šè¿‡recyclerview.postï¼Œç„¶åä¼ çš„æ˜¯è‡ªå·±ï¼Œå› æ­¤ä¼šç›´æ¥runæ–¹æ³•ã€‚é¢„åŠ è½½æ—¶æœºåœ¨æºç é‡Œé¢æœ‰ä¸¤å¤„è°ƒç”¨äº†ï¼š\nRecyclerviewè¢«æ‹–åŠ¨æ—¶ï¼š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 @Override public boolean onTouchEvent(MotionEvent e) { ... switch (action) { ... case MotionEvent.ACTION_MOVE: { ... if (mScrollState == SCROLL_STATE_DRAGGING) { ... // å¤„äºæ‹–åŠ¨çŠ¶æ€å¹¶ä¸”å­˜åœ¨æœ‰æ•ˆçš„æ‹–åŠ¨è·ç¦»æ—¶ if (mGapWorker != null \u0026amp;\u0026amp; (dx != 0 || dy != 0)) { mGapWorker.postFromTraversal(this, dx, dy); } } } break; ... } ... return true; } Recyclerviewæƒ¯æ€§æ»‘åŠ¨æ—¶ï¼š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 class ViewFlinger implements Runnable { ... @Override public void run() { ... if (!smoothScrollerPending \u0026amp;\u0026amp; doneScrolling) { ... } else { ... if (mGapWorker != null) { mGapWorker.postFromTraversal(RecyclerView.this, consumedX, consumedY); } } } ... } çœ‹ä¸‹GapWorkerçš„runæ–¹æ³•å¦‚ä½•å®ç°çš„é¢„åŠ è½½ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 @Override public void run() { try { TraceCompat.beginSection(RecyclerView.TRACE_PREFETCH_TAG); if (mRecyclerViews.isEmpty()) { // abort - no work to do return; } // Query most recent vsync so we can predict next one. Note that drawing time not yet // valid in animation/input callbacks, so query it here to be safe. final int size = mRecyclerViews.size(); long latestFrameVsyncMs = 0; for (int i = 0; i \u0026lt; size; i++) { RecyclerView view = mRecyclerViews.get(i); if (view.getWindowVisibility() == View.VISIBLE) { latestFrameVsyncMs = Math.max(view.getDrawingTime(), latestFrameVsyncMs); } } if (latestFrameVsyncMs == 0) { // abort - either no views visible, or couldn\u0026#39;t get last vsync for estimating next return; } long nextFrameNs = TimeUnit.MILLISECONDS.toNanos(latestFrameVsyncMs) + mFrameIntervalNs; prefetch(nextFrameNs); // TODO: consider rescheduling self, if there\u0026#39;s more work to do } finally { mPostTimeNs = 0; TraceCompat.endSection(); } } åœ¨è°ƒç”¨prefetchå‰ä¼ å…¥nextFrameNsï¼Œè¯¥å€¼è¡¨ç¤ºé¢„ä¼°çš„ä¸‹ä¸€ä¸ªvsyncæ¥ä¸´çš„æ—¶é—´ï¼Œé¦–å…ˆè·å–ä¸Šä¸€é’ˆçš„ç»˜åˆ¶èµ·å§‹æ—¶é—´ï¼Œä¹Ÿå°±æ˜¯latestFrameVsyncMsï¼Œè€ŒmFrameIntervalNsæ˜¯é€šè¿‡åˆ·æ–°ç‡ç®—å‡ºæ¥çš„ä¸€é’ˆéœ€è¦çš„æ—¶é—´ï¼Œæ¯”å¦‚60hzçš„æ‰‹æœºï¼Œä¸€ç§’æ˜¯60å¸§ï¼Œé‚£ä¹ˆmFrameIntervalNsçš„å€¼æ˜¯ä¸€é’ˆéœ€è¦16msï¼ŒmFrameIntervalNsçš„å•ä½æ˜¯çº³ç§’ï¼Œè¿™ä¸ªæ—¶é—´åœ¨å¼€ç¯‡çš„onAttachedToWindowæ–¹æ³•ä¸­è®¡ç®—çš„ï¼Œæ‰€ä»¥å¯ä»¥çœ‹å‡ºæ¥ï¼ŒnextFrameNsæ—¶é—´å°±æ˜¯é¢„åŠ è½½æœ€åçš„æœŸé™æ—¶é—´ï¼Œè¶…è¿‡è¿™ä¸ªæ—¶é—´å°±ä¼šæ”¾å¼ƒè¯¥é¢„åŠ è½½ï¼Œä¸Šé¢æåˆ°çš„ä¸Šä¸€é’ˆæ—¶é—´æ˜¯ç”¨è¿‡recyclerviewçš„getDrawingTimeè·å–çš„ï¼Œå®ƒæ˜¯è·å–çš„attachInfoçš„mDrawingTimeæ—¶é—´ï¼Œè€ŒmDrawingTimeæ˜¯åœ¨viewRootImplä¸­drawæ–¹æ³•ç»™èµ‹å€¼çš„ï¼š\n1 2 3 4 5 6 private boolean draw(boolean fullRedrawNeeded, boolean forceDraw) { //çœç•¥ä»£ç  mAttachInfo.mDrawingTime = mChoreographer.getFrameTimeNanos() / TimeUtils.NANOS_PER_MS; //çœç•¥ä»£ç  } å¯ä»¥çœ‹å‡ºæ¥ï¼Œå®ƒæ˜¯é€šè¿‡Choreographerçš„getFrameTimeNanosæ–¹æ³•æ¥è·å–çš„ï¼š\n1 2 3 4 5 @UnsupportedAppUsage public long getFrameTimeNanos() { //çœç•¥ä»£ç  return USE_FRAME_TIME ? mLastFrameTimeNanos : System.nanoTime(); } mLastFrameTimeNanosæ˜¯åœ¨doFrameä¸­å°†å‚æ•°frameTimeNanosç»™èµ‹å€¼çš„ï¼Œè€ŒframeTimeNanoså‚æ•°è¡¨ç¤ºçš„å°±æ˜¯å½“å‰vsnycä¿¡å·æ¥ä¸´çš„æ—¶é—´ã€‚æ‰€ä»¥æœ€ç»ˆç»“è®ºå°±æ˜¯é€šè¿‡éå†recyclerviewçš„drawingtimeï¼Œæ¥è·å–æœ€è¿‘ä¸€æ¬¡çš„vsyncæ—¶é—´ï¼Œå¹¶åŠ ä¸Šå½“å‰è®¾å¤‡ä¸€é’ˆæ‰€éœ€è¦çš„æ—¶é—´ï¼Œä»è€Œå¾—åˆ°ä¸‹ä¸€ä¸ªvsyncä¿¡å·æ¥ä¸´çš„æ—¶é—´ï¼Œä¹Ÿå°±æ˜¯é¢„åŠ è½½è¦å®Œæˆçš„æœ€æ™šæ—¶é—´ã€‚ç»§ç»­è·Ÿè¿›GapWorkerçš„prefetchæ–¹æ³•ï¼š\n1 2 3 4 void prefetch(long deadlineNs) { buildTaskList(); flushTasksWithDeadline(deadlineNs); } buildTaskListï¼Œå®ƒæ˜¯ç”¨æ¥æ„å»ºé¢„åŠ è½½çš„taskåˆ—è¡¨ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 private void buildTaskList() { // Update PrefetchRegistry in each view final int viewCount = mRecyclerViews.size(); int totalTaskCount = 0; for (int i = 0; i \u0026lt; viewCount; i++) { RecyclerView view = mRecyclerViews.get(i); if (view.getWindowVisibility() == View.VISIBLE) { //æ”¶é›†è¦é¢„åŠ è½½çš„viewçš„position view.mPrefetchRegistry.collectPrefetchPositionsFromView(view, false); totalTaskCount += view.mPrefetchRegistry.mCount; } } //çœç•¥ä»£ç  } é¦–å…ˆæ˜¯è°ƒç”¨äº†view.mPrefetchRegistry.collectPrefetchPositionsFromView(view, false)æ¥æ”¶é›†é¢„åŠ è½½çš„viewï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 void collectPrefetchPositionsFromView(RecyclerView view, boolean nested) { mCount = 0; if (mPrefetchArray != null) { Arrays.fill(mPrefetchArray, -1); } final RecyclerView.LayoutManager layout = view.mLayout; if (view.mAdapter != null \u0026amp;\u0026amp; layout != null \u0026amp;\u0026amp; layout.isItemPrefetchEnabled()) { //çœç•¥ä»£ç  if (!view.hasPendingAdapterUpdates()) { layout.collectAdjacentPrefetchPositions(mPrefetchDx, mPrefetchDy, view.mState, this); } //çœç•¥ä»£ç  } } å¯ä»¥çœ‹å‡ºæ¥è°ƒç”¨äº†layoutmanagerçš„collectAdjacentPrefetchPositionsçš„æ–¹æ³•ï¼ŒæŠŠéœ€è¦é¢„åŠ è½½çš„æ°´å¹³å’Œç«–ç›´æ–¹å‘çš„åç§»é‡ä¼ å…¥å…¶ä¸­ï¼Œçœ‹ä¸‹LinearLayoutManagerçš„è¯¥æ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 @Override public void collectAdjacentPrefetchPositions(int dx, int dy, RecyclerView.State state, LayoutPrefetchRegistry layoutPrefetchRegistry) { int delta = (mOrientation == HORIZONTAL) ? dx : dy; if (getChildCount() == 0 || delta == 0) { // can\u0026#39;t support this scroll, so don\u0026#39;t bother prefetching return; } ensureLayoutState(); final int layoutDirection = delta \u0026gt; 0 ? LayoutState.LAYOUT_END : LayoutState.LAYOUT_START; final int absDelta = Math.abs(delta); updateLayoutState(layoutDirection, absDelta, true, state); collectPrefetchPositionsForLayoutState(state, mLayoutState, layoutPrefetchRegistry); } é€šè¿‡æ–¹æ³•æ¥åˆ¤æ–­åç§»é‡ï¼Œç„¶åæŠŠæ–¹å‘æ ‡è¯†ä¼ å…¥åˆ°updateLayoutStateä¸­ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 private void updateLayoutState(int layoutDirection, int requiredSpace, boolean canUseExistingSpace, RecyclerView.State state) { //çœç•¥ä»£ç  if (layoutToEnd) { //è·å–å¯è§çš„æœ€åä¸€ä¸ªè¡¨é¡¹ final View child = getChildClosestToEnd(); //åˆ¤æ–­æ˜¯å¦æ˜¯reverseçš„ mLayoutState.mItemDirection = mShouldReverseLayout ? LayoutState.ITEM_DIRECTION_HEAD : LayoutState.ITEM_DIRECTION_TAIL; //è·å–é¢„åŠ è½½çš„position mLayoutState.mCurrentPosition = getPosition(child) + mLayoutState.mItemDirection; mLayoutState.mOffset = mOrientationHelper.getDecoratedEnd(child); //è·å–è¦é¢„åŠ è½½çš„è¡¨é¡¹ä¸recyclerviewåº•éƒ¨çš„è·ç¦» scrollingOffset = mOrientationHelper.getDecoratedEnd(child) - mOrientationHelper.getEndAfterPadding(); } else { //çœç•¥ä»£ç  } //çœç•¥ä»£ç  mLayoutState.mScrollingOffset = scrollingOffset; } æ­¤å¤„åªä¿ç•™ä»ä¸Šåˆ°ä¸‹çš„æ»‘åŠ¨ï¼Œå…ˆæ˜¯è·å–é¡µé¢æ»šåŠ¨çš„æœ€åä¸€ä¸ªè¡¨é¡¹ï¼Œç„¶ååˆ¤æ–­æ˜¯ä¸æ˜¯reverseLayoutï¼Œå¦‚æœä¸æ˜¯åˆ™å–LayoutState.ITEM_DIRECTION_TAIL(è¯¥å€¼ç­‰äº1)ï¼Œé¢„åŠ è½½çš„positionç­‰äºæœ€åä¸€ä¸ªè¡¨é¡¹çš„position+1ï¼Œæ¥ç€ç®—å‡ºé¢„åŠ è½½çš„è¡¨é¡¹ç¦»recyclerviewåº•éƒ¨çš„è·ç¦»ã€‚å®ƒæ˜¯é€šè¿‡mOrientationHelper.getDecoratedEnd(child)- mOrientationHelper.getEndAfterPadding()å¾—åˆ°çš„ã€‚ mOrientationHelper.getDecoratedEnd(child)å®ƒæ˜¯åœ¨OrientationHelperä¸­å®šä¹‰çš„createVerticalHelperæ–¹æ³•ä¸­å®ç°çš„ï¼š\n1 2 3 4 5 6 @Override public int getDecoratedEnd(View view) { final RecyclerView.LayoutParams params = (RecyclerView.LayoutParams) view.getLayoutParams(); return mLayoutManager.getDecoratedBottom(view) + params.bottomMargin; } 1 2 3 public int getDecoratedBottom(@NonNull View child) { return child.getBottom() + getBottomDecorationHeight(child); } getDecoratedBottomæ˜¯è·å–childçš„bottom+childçš„åº•éƒ¨é—´è·é«˜åº¦ï¼Œæ‰€ä»¥getDecoratedEndæ˜¯è·å–childçš„bottom+childçš„åº•éƒ¨é—´è·é«˜åº¦+ä¸‹é—´è·ã€‚ mOrientationHelper.getEndAfterPadding()ä¹Ÿæ˜¯åœ¨OrientationHelperä¸­å®šä¹‰çš„createVerticalHelperæ–¹æ³•ä¸­å®ç°çš„ï¼š\n1 2 3 4 @Override public int getEndAfterPadding() { return mLayoutManager.getHeight() - mLayoutManager.getPaddingBottom(); } getEndAfterPaddingæ˜¯recyclerviewçš„é«˜åº¦-recyclerviewçš„ä¸‹å†…è¾¹è·ã€‚æ‰€ä»¥scrollingOffsetæ˜¯å³å°†è¦é¢„åŠ è½½çš„è¡¨é¡¹ç¦»recyclerviewåº•éƒ¨çš„é—´è·ã€‚æ¥ç€çœ‹ä¸‹collectPrefetchPositionsForLayoutStateæ–¹æ³•ï¼š\n1 2 3 4 5 6 7 void collectPrefetchPositionsForLayoutState(RecyclerView.State state, LayoutState layoutState, LayoutPrefetchRegistry layoutPrefetchRegistry) { final int pos = layoutState.mCurrentPosition; if (pos \u0026gt;= 0 \u0026amp;\u0026amp; pos \u0026lt; state.getItemCount()) { layoutPrefetchRegistry.addPosition(pos, Math.max(0, layoutState.mScrollingOffset)); } } å°†åˆšæ‰ç®—çš„é¢„åŠ è½½çš„postionå’Œåç§»é‡ä¼ å…¥åˆ°addPositionä¸­ï¼Œè¯¥æ–¹æ³•æ˜¯åœ¨GapWorkerä¸­å®ç°çš„ï¼š\n1 2 3 4 5 6 7 8 @Override public void addPosition(int layoutPosition, int pixelDistance) { //çœç•¥ä»£ç  final int storagePosition = mCount * 2; mPrefetchArray[storagePosition] = layoutPosition; mPrefetchArray[storagePosition + 1] = pixelDistance; mCount++; } å°†positionå’Œåç§»é‡æˆå¯¹ä¿å­˜åœ¨mPrefetchArrayæ•°ç»„ä¸­ã€‚æ„å»ºå®Œæ•°ç»„ä¸­ï¼Œæ¥ç€å°±æ˜¯å°†æ•°ç»„çš„æ•°æ®å­˜åˆ°taskä¸­ã€‚è¿™å—é€»è¾‘åœ¨buildTaskListä¸­ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 private void buildTaskList() { for (int i = 0; i \u0026lt; viewCount; i++) { RecyclerView view = mRecyclerViews.get(i); if (view.getWindowVisibility() != View.VISIBLE) { // Invisible view, don\u0026#39;t bother prefetching continue; } LayoutPrefetchRegistryImpl prefetchRegistry = view.mPrefetchRegistry; final int viewVelocity = Math.abs(prefetchRegistry.mPrefetchDx) + Math.abs(prefetchRegistry.mPrefetchDy); for (int j = 0; j \u0026lt; prefetchRegistry.mCount * 2; j += 2) { final Task task; if (totalTaskIndex \u0026gt;= mTasks.size()) { task = new Task(); mTasks.add(task); } else { task = mTasks.get(totalTaskIndex); } final int distanceToItem = prefetchRegistry.mPrefetchArray[j + 1]; task.immediate = distanceToItem \u0026lt;= viewVelocity; task.viewVelocity = viewVelocity; task.distanceToItem = distanceToItem; task.view = view; task.position = prefetchRegistry.mPrefetchArray[j]; totalTaskIndex++; } } } taskä¿¡æ¯ç”±ç”±ä»¥ä¸‹ç»„æˆï¼š immediateï¼šè¡¨ç¤ºæ˜¯å¦ç«‹å³æ‰§è¡Œï¼Œåˆ¤æ–­ä¾æ®é¢„åŠ è½½çš„è¡¨é¡¹ç¦»recyclerviewåº•éƒ¨è·ç¦»æ˜¯å¦å°äºæ»‘åŠ¨çš„é€Ÿåº¦ viewVelocityï¼šæ»‘åŠ¨çš„é€Ÿåº¦ distanceToItemï¼šé¢„åŠ è½½çš„è¡¨é¡¹ç¦»recyclerviewåº•éƒ¨è·ç¦» viewï¼šrecyclerview positionï¼šé¢„åŠ è½½è¡¨é¡¹çš„ä½ç½® ä»ä¸Šé¢å¯ä»¥çœ‹å‡ºæ¥ä»mPrefetchArrayæ•°ç»„ä¸­å–å€¼æ˜¯æ¯ä¸¤ä¸ªå€¼å–å‡ºçš„ï¼Œå’Œä¸Šé¢buildè¿‡ç¨‹å¯¹åº”ã€‚æ‰€æœ‰çš„å®Œäº‹åï¼Œåœ¨buildTaskListä¸­å°±æ˜¯å¯¹taskè¿›è¡Œæ’åºï¼š\n1 2 3 4 5 private void buildTaskList() { ... // 3.å¯¹ä»»åŠ¡åˆ—è¡¨è¿›è¡Œä¼˜å…ˆçº§æ’åº Collections.sort(mTasks, sTaskComparator); } ä¸Šé¢å°±æ˜¯æ•´ä¸ªbuildTaskListçš„é€»è¾‘ï¼Œæ¥ç€å°±æ˜¯æ ¹æ®æ„å»ºçš„taskæ¥åˆ›å»ºviewholderï¼Œè¯¥é€»è¾‘æ˜¯åœ¨flushTasksWithDeadlineæ–¹æ³•ä¸­ï¼š\n1 2 3 4 5 6 7 8 9 10 private void flushTasksWithDeadline(long deadlineNs) { for (int i = 0; i \u0026lt; mTasks.size(); i++) { final Task task = mTasks.get(i); if (task.view == null) { break; // done with populated tasks } flushTaskWithDeadline(task, deadlineNs); task.clear(); } } flushTaskWithDeadline:\n1 2 3 4 5 6 private void flushTaskWithDeadline(Task task, long deadlineNs) { long taskDeadlineNs = task.immediate ? RecyclerView.FOREVER_NS : deadlineNs; RecyclerView.ViewHolder holder = prefetchPositionWithDeadline(task.view, task.position, taskDeadlineNs); //çœç•¥ä»£ç  } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 private RecyclerView.ViewHolder prefetchPositionWithDeadline(RecyclerView view, int position, long deadlineNs) { RecyclerView.Recycler recycler = view.mRecycler; RecyclerView.ViewHolder holder; holder = recycler.tryGetViewHolderForPositionByDeadline( position, false, deadlineNs); if (holder != null) { if (holder.isBound() \u0026amp;\u0026amp; !holder.isInvalid()) { //å¦‚æœholderå·²ç»ç»‘å®šè¿‡å¹¶ä¸”æ˜¯å¯ç”¨çš„ï¼ŒåŠ å…¥åˆ°cacheviewç¼“å­˜ä¸­ recycler.recycleView(holder.itemView); } else { //å¦åˆ™åŠ å…¥åˆ°RecycledViewPoolä¸­ recycler.addViewHolderToRecycledViewPool(holder, false); } } return holder; } ä¸Šé¢é€šè¿‡tryGetViewHolderForPositionByDeadlineè·å–viewholderï¼Œå’Œæ­£å¸¸è·å–viewholderçš„åŒºåˆ«æ˜¯ä¼ å…¥äº†deadlineNsï¼Œç›´æ¥çœ‹è¯¥æ–¹æ³•æ˜¯å¦‚ä½•æ”¾å¼ƒè¶…æ—¶çš„viewholderï¼š\n1 2 3 4 5 6 7 8 9 10 ViewHolder tryGetViewHolderForPositionByDeadline(int position, boolean dryRun, long deadlineNs) { if (holder == null) { long start = getNanoTime(); if (deadlineNs != FOREVER_NS \u0026amp;\u0026amp; !mRecyclerPool.willCreateInTime(type, start, deadlineNs)) { return null; } } } å¦‚æœdeadlineNsä¸æ˜¯FOREVER_NSï¼Œæ™®é€šè°ƒç”¨è¯¥æ–¹æ³•ä¼ å…¥çš„deadlineNsæ˜¯FOREVER_NSï¼Œæ‰€ä»¥æ˜¯é€šè¿‡è¯¥å€¼åŒºåˆ†æ˜¯ä¸æ˜¯é¢„åŠ è½½è°ƒç”¨çš„ï¼Œæ¥ç€é€šè¿‡willCreateInTimeè¿”å›å€¼åˆ¤æ–­è¦ä¸è¦æ”¾å¼ƒï¼š\n1 2 3 4 boolean willCreateInTime(int viewType, long approxCurrentNs, long deadlineNs) { long expectedDurationNs = getScrapDataForType(viewType).mCreateRunningAverageNs; return expectedDurationNs == 0 || (approxCurrentNs + expectedDurationNs \u0026lt; deadlineNs); } expectedDurationNså–çš„æ˜¯å¯¹åº”viewholderçš„å¹³å‡åˆ›å»ºæ—¶é—´ï¼Œå…¶å®ä¹Ÿä¸å«å¹³å‡æ—¶é—´ï¼š\n1 2 3 4 5 6 7 8 9 10 11 void factorInCreateTime(int viewType, long createTimeNs) { ScrapData scrapData = getScrapDataForType(viewType); scrapData.mCreateRunningAverageNs = runningAverage( scrapData.mCreateRunningAverageNs, createTimeNs); } long runningAverage(long oldAverage, long newValue) { if (oldAverage == 0) { return newValue; } return (oldAverage / 4 * 3) + (newValue / 4); } æ¯æ¬¡å°†ä¹‹å‰çš„åˆ›å»ºviewholderæ—¶é—´å 3åˆ†ä¹‹4ï¼Œå½“å‰åˆ›å»ºçš„æ—¶é—´å 1åˆ†ä¹‹4ã€‚æ‰€ä»¥willCreateInTimeçš„è¿”å›å€¼æ˜¯å¦‚æœå½“å‰æ—¶é—´+å¹³å‡åˆ›å»ºviewholderæ—¶é—´å°äºæœ€æ™šçº¦å®šæ—¶é—´åˆ™ä¸ä¼šæ”¾å¼ƒï¼Œå¦åˆ™ç›´æ¥æ”¾å¼ƒã€‚å¦‚æœä¸æ”¾å¼ƒæ¥ç€ä¼šåˆ¤æ–­bindè¿‡ç¨‹æœ‰æ²¡æœ‰è¶…è¿‡çº¦å®šæ—¶é—´ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 private boolean tryBindViewHolderByDeadline(@NonNull ViewHolder holder, int offsetPosition, int position, long deadlineNs) { final int viewType = holder.getItemViewType(); long startBindNs = getNanoTime(); if (deadlineNs != FOREVER_NS \u0026amp;\u0026amp; !mRecyclerPool.willBindInTime(viewType, startBindNs, deadlineNs)) { return false; } mAdapter.bindViewHolder(holder, offsetPosition); long endBindNs = getNanoTime(); mRecyclerPool.factorInBindTime(holder.getItemViewType(), endBindNs - startBindNs); return true; } bindè¿‡ç¨‹æ˜¯é€šè¿‡willBindInTimeæ–¹æ³•æ¥åˆ¤æ–­æœ‰æ²¡æœ‰è¶…è¿‡çº¦å®šæ—¶é—´çš„ï¼Œæ•´ä¸ªé€»è¾‘å¾ˆæ¸…æ™°ã€‚\nå‰é¢åˆ†æè¿‡å¦‚æœholderæ˜¯bindè¿‡çš„ï¼Œåˆ™ä¼šåŠ å…¥åˆ°cacheviewç¼“å­˜ä¸­ï¼Œå¦åˆ™åŠ å…¥åˆ°RecycledViewPoolä¸­ï¼Œæ­£å¸¸æ»‘åŠ¨çš„æ—¶å€™ç¦»å±çš„viewholderä¹Ÿæ˜¯æ·»åŠ åˆ°cacheviewç¼“å­˜ä¸­çš„ï¼Œé‚£ä¸¤è€…åœ¨ç¼“å­˜ä¸­åˆæ˜¯æ€ä¹ˆåŒºåˆ†çš„å‘¢ï¼Ÿç›´æ¥çœ‹recyclerçš„recycleViewHolderInternalæ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 void recycleViewHolderInternal(ViewHolder holder) { //çœç•¥ä»£ç  //é»˜è®¤æ’å…¥cacheviewç¼“å­˜çš„ç´¢å¼•æ˜¯æœ«å°¾ int targetCacheIndex = cachedViewSize; if (ALLOW_THREAD_GAP_WORK \u0026amp;\u0026amp; cachedViewSize \u0026gt; 0 \u0026amp;\u0026amp; !mPrefetchRegistry.lastPrefetchIncludedPosition(holder.mPosition)) {//å¦‚æœæ˜¯æ­£å¸¸ç¦»å±çš„viewholder //é»˜è®¤æŒ‡å‘æœ€åä¸€ä¸ªå…ƒç´  int cacheIndex = cachedViewSize - 1; while (cacheIndex \u0026gt;= 0) { int cachedPos = mCachedViews.get(cacheIndex).mPosition; //å¦‚æœå½“å‰è¡¨é¡¹ä¸æ˜¯é¢„æ‹‰å–çš„è¡¨é¡¹åˆ™é€€å‡º if (!mPrefetchRegistry.lastPrefetchIncludedPosition(cachedPos)) { break; } cacheIndex--; } targetCacheIndex = cacheIndex + 1; } mCachedViews.add(targetCacheIndex, holder); //çœç•¥ä»£ç  } é»˜è®¤æ’å…¥cacheviewç¼“å­˜çš„ç´¢å¼•æ˜¯åœ¨æœ«å°¾ï¼Œåœ¨æ’å…¥æ­£å¸¸ç¦»å±çš„viewholderæ—¶å€™å¦‚æœé‡åˆ°é¢„æ‹‰å–çš„viewholderï¼Œåˆ™å¾€å‰æ‰¾ç›´åˆ°æœ€åä¸€ä¸ªç¦»å±çš„viewholderï¼Œç„¶åæ’å…¥åˆ°å®ƒåé¢ã€‚æ‰€ä»¥ä¸éš¾çœ‹å‡ºï¼Œé¢„æ‹‰å–çš„ä¼šåœ¨åé¢ï¼Œç¦»å±çš„ä¼šåœ¨å‰é¢ã€‚è¿™æ ·çš„å¥½å¤„æ˜¯é¢„åŠ è½½çš„viewholderç”±äºåœ¨åé¢ä½¿ç”¨çš„æœºä¼šä¼šå¾ˆå¤§ï¼Œæ”¾åœ¨é›†åˆçš„åé¢åˆ é™¤çš„æ¦‚ç‡è¦å°ã€‚\nå‚è€ƒï¼šæŒæ¡è¿™17å¼ å›¾ï¼Œæ²¡äººæ¯”ä½ æ›´æ‡‚RecyclerViewçš„é¢„åŠ è½½\n","date":"2025-01-17T00:00:00Z","permalink":"http://xiangcman.xyz/p/recyclerview%E7%9A%84%E9%A2%84%E5%8A%A0%E8%BD%BD%E5%AE%9E%E7%8E%B0/","title":"RecyclerViewçš„é¢„åŠ è½½å®ç°"},{"content":" å…³äºRecyclerViewçš„ä¼˜åŒ–ï¼Œå…¶å®æ— éä¸¤ç‚¹ï¼Œå°½å¯èƒ½çš„æœ€å¤§åŒ–ä½¿ç”¨viewholderçš„ç¼“å­˜ï¼Œå¦‚æœä¸èƒ½ä½¿ç”¨ç¼“å­˜ï¼Œå°†æ„å»ºå’Œç»‘å®šviewholderçš„è¿‡ç¨‹è€—æ—¶é™ä½åˆ°æœ€ä½ã€‚\nç¼“å­˜ è¿™é‡Œå†æ€»ç»“ä¸‹RecyclerViewçš„ç¼“å­˜çŸ¥è¯†ï¼š\nåˆ†ç±» scrapç¼“å­˜ï¼šç”¨äºç¼“å­˜é¡µé¢æš‚æ—¶åˆ†ç¦»çš„viewholderï¼Œåˆ†ä¸ºchangeScrapå’ŒattachScrapï¼ŒchangeScrapç”¨äºç¼“å­˜è¦updateçš„viewholderï¼Œattachscrapç¼“å­˜éupdateçš„viewholderã€‚ ä¸ä½œç”¨äºé¡µé¢æ»‘åŠ¨ï¼Œå¼€å‘å¹²é¢„ä¸äº†è¯¥ç¼“å­˜ã€‚å®ƒç¼“å­˜çš„ä¸ªæ•°æ˜¯ä¸€å±çš„viewholderã€‚ cacheviewç¼“å­˜ï¼šæ˜¯ä¸€ä¸ªarraylistçš„ç»“æ„ï¼Œåœ¨æ»‘åŠ¨çš„æ—¶å€™ï¼Œæ»‘å‡ºå±å¹•çš„viewholderä¼šä¿å­˜åˆ°è¯¥ç¼“å­˜ä¸­ï¼Œé»˜è®¤ä¿å­˜çš„æ•°é‡æ˜¯2ä¸ªï¼Œå½“è¶…è¿‡2ä¸ªçš„æ—¶å€™ï¼Œä¼šå…ˆç§»é™¤é›†åˆä¸­ç¬¬ä¸€ä¸ªviewholderï¼Œå¹¶æŠŠè¯¥viewholderè¿›è¡Œé‡ç½®ã€‚ ç„¶ååŠ å…¥åˆ°recyclerpoolç¼“å­˜ä¸­ï¼Œæœ€åæŠŠæ–°çš„viewholderåŠ å…¥åˆ°cacheviewç¼“å­˜å°¾éƒ¨ï¼Œæ•´ä¸ªè¿‡ç¨‹ï¼Œcacheviewç¼“å­˜ç›¸å½“äºæ˜¯ä¸€ä¸ªé˜Ÿåˆ—ï¼Œå…ˆè¿›å…ˆå‡ºçš„è§„åˆ™ã€‚å®ƒæ˜¯æ ¹æ®positionæ¥å–çš„ï¼Œä¸éœ€è¦é‡æ–°bind ViewCacheExtensionï¼šmViewCacheExtensionåˆç§°æ‹“å±•ç¼“å­˜ï¼Œä¸ºå¼€å‘è€…é¢„ç•™çš„ç¼“å­˜æ± ï¼Œå¼€å‘è€…å¯ä»¥è‡ªå·±æ‹“å±•å›æ”¶æ± ï¼Œä¸€èˆ¬ä¸ä¼šç”¨åˆ°ã€‚ æœ€åå°±æ˜¯recyclerpoolç¼“å­˜ï¼Œå®ƒæ˜¯åœ¨cacheviewæ»¡äº†çš„æ—¶å€™ï¼ŒåŠ å…¥åˆ°è¯¥ç¼“å­˜ä¸­çš„ï¼Œå®ƒæ˜¯æ ¹æ®viewtypeç¼“å­˜çš„ã€‚åœ¨å®ƒé‡Œé¢çš„viewholderéƒ½è¢«é‡ç½®è¿‡äº†çš„ï¼Œæ‰€ä»¥ä»å®ƒé‡Œé¢å–å‡ºæ¥çš„viewholderéƒ½éœ€è¦é‡æ–°bindã€‚ ç¼“å­˜å›æ”¶ åœ¨ä¸æ»šåŠ¨æƒ…å†µä¸‹ï¼š ä¼šæŠŠé¡µé¢ä¸Šå¯è§çš„viewholderç¼“å­˜åˆ°scrapä¸­ï¼Œå¦‚æœviewholderä¸­æœ‰flag_updateæ ‡è®°çš„æ—¶å€™ï¼Œåˆ™æŠŠå®ƒæ·»åŠ åˆ°changeScrapä¸­ï¼Œå¦åˆ™åŠ å…¥åˆ°attachScrapä¸­ã€‚ åœ¨æ»šåŠ¨æƒ…å†µä¸‹ï¼š ä¼šæŠŠæ»‘å‡ºrecyclerviewçš„viewholderå…ˆæ·»åŠ åˆ°cacheViewç¼“å­˜ä¸­ï¼Œå¦‚æœcacheViewç¼“å­˜æ»¡äº†è¯ï¼Œä¼šæŠŠé›†åˆå¼€å§‹çš„ä½ç½®viewholderç»™æ”¾åˆ°RecycledViewPoolä¸­ï¼ŒRecycledViewPoolä¼šæŒ‰ç…§æ¯ç§viewtypeçš„viewholderä¸º5çš„å®¹é‡è¿›è¡Œå›æ”¶ï¼Œå¦‚æœè¶…è¿‡5ä¸ªçš„æ—¶å€™ï¼Œå°±ä¸ä¼šå¾€é‡Œé¢å­˜äº†ã€‚\nç¼“å­˜å¤ç”¨ å¦‚æœæ˜¯åœ¨pre-layouté˜¶æ®µï¼Œä¼šå»changeScrapç¼“å­˜ä¸­é€šè¿‡positionæŸ¥æ‰¾viewholderï¼Œå¦‚æœé€šè¿‡positionæ‰¾ä¸åˆ°ï¼Œåˆ™é€šè¿‡idå»æŸ¥æ‰¾ï¼Œä»changeScrapç¼“å­˜ä¸­å–å‡ºçš„ã€‚ åœ¨pre-layoutå’Œpost-layouté˜¶æ®µä¼šå…ˆä»attachScrapç¼“å­˜ä¸­é€šè¿‡positionæŸ¥æ‰¾viweholderï¼Œå¦‚æœæ²¡æ‰¾åˆ°åˆ™ä¼šä»cacheviewç¼“å­˜ä¸­é€šè¿‡positionæŸ¥æ‰¾viewholderï¼Œå¦‚æœæ²¡æ‰¾åˆ°å†é€šè¿‡idä»attchScrapå’Œcacheviewä¸­æ‰¾viewholderï¼Œå¦‚æœè¿˜æ²¡æ‰¾åˆ°ï¼Œåˆ™ä»ViewCacheExtensionä¸­æ‰¾ï¼Œå¦‚æœè¿˜æ²¡æ‰¾åˆ°åˆ™ä»RecycledViewPoolä¸­æ‰¾ï¼Œå¦‚æœéƒ½æ²¡æ‰¾åˆ°ï¼Œåˆ™åˆ›å»ºviewholderï¼Œç”±äºchangeScrapä¸å‚ä¸post-layouté˜¶æ®µï¼Œæ‰€ä»¥åœ¨post-layouté˜¶æ®µä¼šèµ°åˆ›å»ºè¡¨é¡¹å’Œç»‘å®šè¡¨é¡¹ï¼ŒattachScrapç”±äºæ˜¯ç²¾å‡†åŒ¹é…ï¼Œæ‰€ä»¥æ— éœ€åˆ›å»ºå’Œç»‘å®šï¼Œcacheviewç¼“å­˜ä¹Ÿæ˜¯ç²¾å‡†åŒ¹é…ï¼ŒRecycledViewPoolä¸­çš„viewholderç”±äºéƒ½é‡ç½®äº†ï¼Œæ‰€ä»¥éœ€è¦èµ°ç»‘å®šã€‚\nç¼“å­˜è¯´æ˜ scrapç¼“å­˜åªä¼šåœ¨éæ»‘åŠ¨åœºæ™¯ä¸‹è¿›è¡Œä¿å­˜ï¼Œå¹¶ä¸”å®ƒä¿å­˜çš„æ•°é‡æ˜¯ä¸€å±çš„æ•°æ®ï¼Œè¯¥ç¼“å­˜å¼€å‘æ— æ³•å¹²é¢„ï¼Œcacheviewç¼“å­˜çš„æ˜¯å¯ä»¥ç›´æ¥ç”¨çš„viewholderï¼Œæ— éœ€bindå’Œcreateï¼Œä½†æ˜¯é»˜è®¤å®¹é‡å¾ˆå°ï¼Œå¯ä»¥åŠ¨æ€è®¾ç½®ï¼ŒRecycledViewPoolé‡Œé¢çš„viewholderéƒ½æ˜¯é‡ç½®è¿‡çš„ï¼Œéœ€è¦é‡æ–°bindï¼ŒæŒ‰viewtypeè¿›è¡Œå­˜å‚¨ï¼Œæ¯ç§viewtypeçš„å®¹é‡é»˜è®¤æ˜¯5ï¼Œä¹Ÿæ˜¯å¯ä»¥è®¾ç½®å¤§å°ã€‚è€ŒViewCacheExtensionç¼“å­˜è™½ç„¶æ˜¯æ‰©å±•ç¼“å­˜ï¼Œä½†æ˜¯å¾ˆå°‘å»ç”¨ï¼Œæ‰€ä»¥å¯ä¼˜åŒ–çš„ç¼“å­˜åªæœ‰cacheviewå’ŒRecycledViewPool\nå¦‚ä½•æœ€å¤§åŒ–ä½¿ç”¨ç¼“å­˜ï¼Ÿ å¤šä½¿ç”¨scrapç¼“å­˜æ¥å±€éƒ¨åˆ·æ–° å‰é¢åˆ†æè¿‡ä½¿ç”¨notifyDataSetChangeçš„æ—¶å€™ä¼šä½¿å¯è§çš„viewholderå’Œç¼“å­˜ä¸­çš„viewholderéƒ½å¤±æ•ˆäº†ï¼Œå¯¼è‡´æ‰€æœ‰çš„viewhodleréƒ½ä¼šå…ˆä»poolç¼“å­˜ä¸­æ‰¾ä¸€éï¼Œå¦‚æœæœ‰çš„è¯ï¼Œå°±éœ€è¦é‡æ–°bindï¼Œå¦‚æœæ‰¾ä¸åˆ°åˆ™å…ˆèµ°åˆ›å»ºï¼Œç„¶åèµ°bindè¿‡ç¨‹ï¼Œæ‰€ä»¥å±€éƒ¨åˆ·æ–°ä½¿ç”¨notifyItemChangeå’ŒnotifyItemRemoveï¼Œå¦‚æœåªæ˜¯åˆ·æ–°viewholderä¸­çš„æŸä¸€ä¸ªå­viewï¼Œåˆ™ä½¿ç”¨payloadçš„å½¢å¼ã€‚ ä½¿ç”¨diffutilsæ¥å®ç°å±€éƒ¨åˆ·æ–°ï¼Œæ— éœ€å…³å¿ƒåˆ·æ–°çš„ç´¢å¼•ï¼Œåªéœ€è¦æä¾›å˜åŒ–çš„æ•°æ®æº åˆç†ä½¿ç”¨poolç¼“å­˜ï¼Œå¦‚æœä¸€å±å±•ç¤ºçš„viewholderæ¯”è¾ƒå¤šï¼Œåˆ™å¯ä»¥é€‚å½“å¢åŠ poolç¼“å­˜çš„æœ€å¤§æ•°é‡ï¼Œå‡å°‘é¢‘ç¹åˆ›å»ºviewholder åˆç†è®¾ç½®cacheviewçš„ç¼“å­˜ï¼Œå¦‚æœrecyclerviewéœ€è¦ç»å¸¸æ¥å›æ»‘åŠ¨ï¼Œåˆ™å¯ä»¥é€‚å½“å¢åŠ cacheviewçš„ç¼“å­˜æ•°é‡ é‡å†™adapterçš„getItemIdå¹¶ä¸”ç»™recyclerviewè®¾ç½®setHasStableIdsä¸ºtrueæ¥ç»™æ¯ä¸€ä¸ªviewholderå¢åŠ å”¯ä¸€ç´¢å¼•ï¼Œè¿™æ ·åœ¨ç¼“å­˜æŸ¥æ‰¾çš„æ—¶å€™èƒ½å¢å¤§å¤ç”¨ã€‚ å¦‚æœä¸¤ä¸ªrecyclerviewçš„viewholderæœ‰éƒ¨åˆ†ç›¸åŒæˆ–è€…åŸºæœ¬ç›¸åŒçš„æƒ…å†µä¸‹ï¼Œç»™è¿™ä¸¤ä¸ªrecyclerviewè®¾ç½®åŒä¸€ä¸ªRecycledViewPoolæ¥å¢åŠ viewholderçš„å¤ç”¨åº¦ï¼Œæ³¨æ„æ­¤æ—¶ç»™recyclerviewè®¾ç½®poolçš„æ—¶å€™ï¼Œéœ€è¦åœ¨è®¾ç½®adapterä¹‹å‰ å¦‚æœåŒä¸€ä¸ªrecyclerviewéœ€è¦åˆ‡æ¢è§†å›¾çš„æ—¶å€™ï¼Œå¹¶ä¸”è§†å›¾çš„æ ·å¼æ˜¯ä¸åŒçš„adapterçš„æ—¶å€™ï¼Œæ­¤æ—¶å¯ä»¥è€ƒè™‘ç”¨swapadapteræ¥åˆ‡æ¢adapterï¼Œswapadapteræ˜¯æŠŠattachScrapç»™æ¸…ç©ºï¼Œå¹¶æŠŠcacheviewä¸­çš„ç¼“å­˜åŠ å…¥åˆ°RecycledViewPoolä¸­ï¼Œè€ŒsetAdapteræ˜¯æ¸…ç©ºæ‰€æœ‰çš„ç¼“å­˜ã€‚ç”±äºswapadapteræ˜¯å¤ç”¨äº†RecycledViewPoolä¸­çš„ç¼“å­˜ï¼Œå› æ­¤è¦æ±‚å‰åçš„viewholderæ˜¯åŒä¸€ç§ç±»å‹ï¼Œå¦åˆ™ä¼šå‡ºç°å¼‚å¸¸ã€‚ æ„å»ºè¿‡ç¨‹å¦‚ä½•é™ä½åˆ°æœ€ä½ï¼Ÿ æ‰€è°“æ„å»ºå°±æ˜¯æŒ‡viewholderçš„createè¿‡ç¨‹ï¼Œè¯¥é˜¶æ®µä¸»è¦æ˜¯é€šè¿‡è§£æxmlï¼Œæ¥åˆ›å»ºviewï¼Œè¯¥é˜¶æ®µæ¶‰åŠåˆ°æ–‡ä»¶è¯»å–çš„ioæ“ä½œï¼Œä»¥åŠåå°„ç”Ÿæˆviewã€‚ä¸€èˆ¬æˆ‘ä»¬å¯ä»¥é€šè¿‡åŠ¨æ€åˆ›å»ºviewçš„å½¢å¼æ¥æ¶ˆé™¤ioæ“ä½œå’Œåå°„ç”Ÿæˆviewã€‚æˆ–è€…å°†xmlçš„å±‚çº§é™åˆ°æœ€ä½ï¼Œå‡å°‘inflateçš„æ—¶é—´ã€‚ æå‰è§£æxmlï¼Œç„¶åå­˜æ”¾åˆ°ç¼“å­˜æ± ä¸­ï¼Œç­‰åˆ°ä½¿ç”¨çš„æ—¶å€™ç›´æ¥ä»æ± å­ä¸­å–ã€‚ ç»‘å®šè¿‡ç¨‹å¦‚ä½•é™ä½åˆ°æœ€ä½ï¼Ÿ ç»™è§†å›¾è®¾ç½®ç›‘å¬å™¨çš„æ—¶å€™ï¼Œä¸è¦é€šè¿‡ç›´æ¥åˆ›å»ºlistenerçš„å½¢å¼ï¼Œé€šè¿‡å¤–ç•Œä¼ å…¥è¿›æ¥ï¼Œç„¶ååœ¨å¤–ç•Œå¤„ç†é€»è¾‘ ç»‘å®šè§†å›¾çš„æ—¶å€™ä¸è¦åšè®¡ç®—é€»è¾‘ï¼Œå°†è®¡ç®—é€»è¾‘å‰ç½®åŒ–ï¼Œç»‘å®šåº”è¯¥æ˜¯ä¸€ä¸ªçº¯å±•ç¤ºçš„è¿‡ç¨‹ å…¶å®ƒ å¦‚æœitemçš„å¤§å°æ˜¯å›ºå®šçš„ï¼Œåˆ™ä½¿ç”¨setHasFixedSize(true)ï¼Œè¿™æ ·å¯ä»¥é¿å…åœ¨æ›´æ–°ã€æ·»åŠ ã€åˆ é™¤è¡¨é¡¹çš„æ—¶å€™é‡æ–°requestLayoutï¼Œè€Œè¯¥è¿‡ç¨‹ä¼šç­‰åˆ°ä¸‹ä¸€ä¸ªvsyncä¿¡å·æ¥çš„æ—¶å€™ï¼Œèµ°ç»˜åˆ¶æµç¨‹ï¼Œç„¶åæ‰æ˜¯æµ‹é‡ï¼Œä½¿ç”¨è¯¥æ–¹æ³•åï¼Œä¼šç»™Choreographerå‘é€ä¸€æ¡animtionçš„æ¶ˆæ¯ï¼Œåœ¨ä¸‹ä¸€ä¸ªvsyncæ¥çš„æ—¶å€™ï¼Œç›´æ¥è¿›è¡Œrecyclerviewçš„dispatchLayoutã€‚ å¼€å¯recyclerviewçš„é¢„åŠ è½½ï¼Œrecyclerviewçš„é¢„åŠ è½½é»˜è®¤æ˜¯å¼€å¯çš„ï¼Œå¦‚æœè¦å…³é—­é€šè¿‡layout.setItemPrefetchEnabled(false)æ¥å…³é—­ï¼Œå¦‚æœæ˜¯è‡ªå®šä¹‰layoutmanagerï¼Œåˆ™é€šè¿‡é‡å†™collectAdjacentPrefetchPositionsæ¥å®ç°é¢„åŠ è½½ recyclerviewä¼šåŠ è½½å±å†…å¯è§çš„viewholderï¼Œå¦‚æœviewholderå¯¹åº”çš„itemviewé«˜åº¦æˆ–å®½åº¦å¾ˆå¤§çš„æ—¶å€™ï¼Œå¯èƒ½åŠ è½½çš„å±å¤–viewholderå¾ˆå°‘ï¼Œæ­¤æ—¶é‡å†™layoutmanagerçš„calculateExtraLayoutSpaceæ¥å®ç°å±å¤–çš„viewholderåŠ è½½ï¼Œå…³äºè¿™å—å¯ä»¥çœ‹viewpager2å¦‚ä½•å®ç°çš„å±å¤–viewholderçš„åŠ è½½ã€‚ å‚è€ƒï¼š RecyclerView æ€§èƒ½ä¼˜åŒ– | æŠŠåŠ è½½è¡¨é¡¹è€—æ—¶å‡åŠ (ä¸€) æµ…è°ˆRecyclerViewçš„æ€§èƒ½ä¼˜åŒ– RecyclerViewæ€§èƒ½ä¼˜åŒ–ä¹‹å¼‚æ­¥é¢„åŠ è½½ RecyclerViewçš„é¢„åŠ è½½ ã€åŠ¨ç”»å›¾è§£ã€‘è¿™ä¸ªå€¼å–å¯¹äº†ï¼ŒViewPager2æ‰èƒ½çºµäº«ä¸æ»‘ ","date":"2025-01-13T00:00:00Z","permalink":"http://xiangcman.xyz/p/recyclerview%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/","title":"RecyclerViewæ€§èƒ½ä¼˜åŒ–"},{"content":"å¤§å®¶æœ‰æ²¡æœ‰æƒ³è¿‡ï¼Œscrapç¼“å­˜å­˜åœ¨çš„æ„ä¹‰æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆå­˜äº†åï¼ŒåˆæŠŠå®ƒé‡Œé¢çš„viewholderåˆç»™åˆ äº†ï¼Ÿ\nåœ¨ä¸Šä¸€ç¯‡(RecyclerViewæºç èµ°è¯»)ä¸­æˆ‘ä»¬åˆ†æè¿‡æ›´æ–°å’Œåˆ é™¤è¡¨é¡¹çš„è¿‡ç¨‹ï¼Œä¸‹é¢æ¥æ€»ç»“ä¸‹scrapç¼“å­˜çš„è¿‡ç¨‹ï¼š\næ›´æ–°è¡¨é¡¹:\né¡µé¢ä¸Šæœ‰è¡¨é¡¹0åˆ°9ï¼Œæ€»å…±æœ‰10ä¸ªè¡¨é¡¹ï¼Œç„¶åæ›´æ–°è¡¨é¡¹0ï¼Œåœ¨dispatchLayout1é˜¶æ®µï¼ˆpre-layoutï¼‰ï¼Œå…ˆæŠŠé¡µé¢ä¸Šçš„è¡¨é¡¹0åˆ°9å­˜åˆ°scrapç¼“å­˜ä¸­ï¼Œç”±äºè¡¨é¡¹0æ˜¯æ›´æ–°çš„æ‰€ä»¥ä¼šæŠŠè¡¨é¡¹0æ”¾åˆ°changeScrapç¼“å­˜ä¸­ï¼ŒæŠŠè¡¨é¡¹1åˆ°9å­˜åˆ°attachScrapç¼“å­˜ä¸­ã€‚åŒæ—¶ä¼šæŠŠè¿™10ä¸ªè¡¨é¡¹ä»é¡µé¢ä¸Šåˆ†ç¦»ï¼ˆchildçš„parentç½®ç©ºï¼Œå¹¶æŠŠviewgroupä¸­å¯¹åº”çš„childç»™ç½®ç©ºï¼‰ï¼Œæ¥ç€ä»scrapç¼“å­˜ä¸­å–å‡ºviewholderï¼Œç”±äºå­˜åœ¨æ›´æ–°è¡¨é¡¹ï¼Œæ‰€ä»¥ä¼šå»åˆ›å»ºè¡¨é¡¹10çš„viewholderåˆ°recyclerviewä¸Šã€‚æ­¤æ—¶recyclerviewä¸­æœ‰11ä¸ªè¡¨é¡¹äº†ï¼ŒåŒæ—¶æŠŠä»–ä»¬ä»scrapç¼“å­˜ä¸­ç§»é™¤ã€‚ åœ¨dispatchLayout2é˜¶æ®µï¼ˆpost-layoutï¼‰ï¼Œä¼šæŠŠè¿™11ä¸ªè¡¨é¡¹åŠ å…¥åˆ°scrapç¼“å­˜ä¸­ï¼Œè¡¨é¡¹0è¿˜æ˜¯æ”¾åˆ°changeScrapä¸­ï¼Œè¡¨é¡¹1åˆ°10åŠ å…¥åˆ°attachScrapç¼“å­˜ä¸­ã€‚æ¥ç€æŠŠä»–ä»¬ä»é¡µé¢ä¸Šåˆ†ç¦»ã€‚ç„¶ååœ¨fillä¸­ï¼Œä»scrapç¼“å­˜ä¸­è·å–viewholderï¼Œç”±äºchangeScrapä¸ä¼šåœ¨dispatchLayout2é˜¶æ®µç”Ÿæ•ˆï¼Œæ‰€ä»¥ä¼šåˆ›å»ºäº†è¡¨é¡¹0ï¼Œå…¶ä½™çš„è¡¨é¡¹æ­£å¸¸ä»attachScrapç¼“å­˜ä¸­è·å–ã€‚æ¥ç€æŠŠæ‰€æœ‰çš„è¡¨é¡¹æ·»åŠ åˆ°recyclerviewä¸­ï¼Œå¹¶æŠŠscrapä¸­çš„viewholderç¼“å­˜ç§»é™¤æ‰ã€‚ä½†æ˜¯è¡¨é¡¹10ä¸ä¼šæ·»åŠ åˆ°recyclerviewä¸­ï¼Œå› ä¸ºåˆ°è¡¨é¡¹9çš„æ—¶å€™ï¼Œå‰©ä½™ç©ºé—´å°±ä¸å¤Ÿäº†ï¼Œæ‰€ä»¥recyclerviewä¸­åªæœ‰0åˆ°9çš„è¡¨é¡¹ã€‚æ³¨æ„ï¼šæ­¤æ—¶è¿˜æœ‰è¡¨é¡¹0å’Œè¡¨é¡¹10åˆ†åˆ«å­˜åœ¨äºchangeScrapå’ŒattachScrapä¸­ã€‚\nä¸Šé¢æ›´æ–°è¡¨é¡¹ç»å†äº†ä¸¤æ¬¡çš„å¸ƒå±€ï¼Œåˆ†åˆ«æ˜¯dispatchLayout1å’ŒdispatchLayout2ï¼Œåœ¨è¿™ä¸¤ä¸ªæ­¥éª¤ä¸­ï¼Œå…ˆåŠ å…¥åˆ°scrapç¼“å­˜ä¸­ï¼Œç„¶åå†ä»scrapç¼“å­˜ä¸­ç§»é™¤ã€‚ä»ç°è±¡æ¥çœ‹ï¼ŒdispatchLayout1ä¸­ä¼šç”Ÿæˆ11ä¸ªè¡¨é¡¹ï¼Œåˆ†åˆ«æ˜¯0åˆ°10ï¼Œç„¶ååœ¨dispatchLayout2å…ˆç§»é™¤æ‰€æœ‰çš„è¡¨é¡¹ï¼Œç„¶åæ·»åŠ 0åˆ°9çš„è¡¨é¡¹ï¼Œè€Œåœ¨dispatchLayout2ä¸­è¡¨é¡¹0æ˜¯é‡æ–°ç”Ÿæˆçš„ï¼Œå› ä¸ºå®ƒè¦å®ç°æ›´æ–°ã€‚è€Œè°ƒç”¨ä¸¤æ¬¡çš„å¸ƒå±€æ˜¯ä¸ºäº†å®ç°åŠ¨ç”»è€Œè¿™ä¹ˆåšï¼Œå…ˆç”Ÿæˆ11ä¸ªè¡¨é¡¹ï¼Œæ¥æŠŠä»–ä»¬çš„ä½ç½®éƒ½è®°å½•ä¸‹æ¥ï¼Œç„¶åç¬¬äºŒæ¬¡å¸ƒå±€çš„æ—¶å€™æŠŠ10ä¸ªè¡¨é¡¹çš„ä½ç½®ä¹Ÿè®°å½•ä¸‹æ¥ï¼Œç„¶åæœ€åæ ¹æ®å­˜å‚¨çš„ä½ç½®ä¿¡æ¯åšåŠ¨ç”»ã€‚ä¸‹é¢æ¥åˆ†æä¸‹åŠ¨ç”»å¦‚ä½•å®ç°çš„ï¼š\nåœ¨dispatchLayoutStep1å°†é¡µé¢ä¸Šå¯è§çš„è¡¨é¡¹åŠ å…¥åˆ°ViewInfoStoreä¸­ï¼š 1 2 3 4 5 6 7 8 9 void addToPreLayout(RecyclerView.ViewHolder holder, RecyclerView.ItemAnimator.ItemHolderInfo info) { InfoRecord record = mLayoutHolderMap.get(holder); if (record == null) { record = InfoRecord.obtain(); mLayoutHolderMap.put(holder, record); } record.preInfo = info; record.flags |= FLAG_PRE; } å°†viewholderå’ŒinfoRecordç»‘å®šå¥½å…³ç³»ï¼Œç„¶åç»™è¯¥recordæ·»åŠ ä¸ŠFLAG_PREæ ‡è®°ã€‚æ³¨æ„ï¼šæ­¤å¤„çš„InforRecordä½¿ç”¨äº†å¯¹è±¡æ± ã€‚ å‰é¢åˆ†æè¿‡åœ¨fillå®Œä¹‹åï¼Œé¡µé¢ä¸Šä¼šå¤šå‡ºä¸€ä¸ªè¡¨é¡¹10ï¼Œæ­¤æ—¶ä¹Ÿä¼šæ·»åŠ åˆ°ViewInfoStoreä¸­ï¼š å¯ä»¥çœ‹åˆ°åœ¨onLayoutChildrenä¹‹åä¼šè°ƒç”¨addToAppearedInPreLayoutHoldersï¼Œæ­¤æ—¶åªæœ‰è¡¨é¡¹10ä¼šè°ƒç”¨addToAppearedInPreLayoutHoldersï¼š\n1 2 3 4 5 6 7 8 9 void addToAppearedInPreLayoutHolders(RecyclerView.ViewHolder holder, RecyclerView.ItemAnimator.ItemHolderInfo info) { InfoRecord record = mLayoutHolderMap.get(holder); if (record == null) { record = InfoRecord.obtain(); mLayoutHolderMap.put(holder, record); } record.flags |= FLAG_APPEAR; record.preInfo = info; } æ‰€ä»¥åªæœ‰è¡¨é¡¹10æ·»åŠ äº†FLAG_APPEARæ ‡è®°ã€‚\nåœ¨dispatchLayoutStep2èµ°å®Œåï¼Œé¡µé¢ä¸Šå¯è§çš„è¡¨é¡¹å°±åªå‰©0åˆ°9äº†ï¼Œåœ¨dispatchLayoutStep3ä¸­å°†å˜åŒ–çš„viewholderè°ƒç”¨animateChangeï¼Œè€Œå…¶ä»–çš„viewholderè°ƒç”¨äº†addToPostLayoutï¼Œåœ¨è¯¥ä¾‹å­ä¸­è¡¨é¡¹0ä¼šè°ƒç”¨animateChangeï¼Œè¡¨é¡¹1åˆ°9ä¼šè°ƒç”¨addToPostLayoutï¼š\nanimateChangeï¼šå½“æœ‰viewholderå‘ç”Ÿå˜åŒ–çš„æ—¶å€™ï¼Œä¼šè§¦å‘è¯¥æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šè§¦å‘mItemAnimatorçš„animateChangeæ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 private void animateChange(@NonNull ViewHolder oldHolder, @NonNull ViewHolder newHolder, @NonNull ItemHolderInfo preInfo, @NonNull ItemHolderInfo postInfo, boolean oldHolderDisappearing, boolean newHolderDisappearing) { //çœç•¥ä»£ç  if (mItemAnimator.animateChange(oldHolder, newHolder, preInfo, postInfo)) { postAnimationRunner(); } } è°ƒç”¨äº†mItemAnimatorçš„animateChangeæ–¹æ³•ï¼Œå¹¶æŠŠæ”¹å˜ä¹‹å‰çš„holderã€itemholderinfoå’Œæ”¹å˜ä¹‹åçš„holderã€itemholderinfoä¼ è¿›å»äº†ï¼Œé»˜è®¤çš„itemAnimatoræ˜¯DefaultItemAnimatorï¼Œä¹Ÿæ˜¯ä¸€ä¸ªSimpleItemAnimator:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 @Override public boolean animateChange(@NonNull RecyclerView.ViewHolder oldHolder, @NonNull RecyclerView.ViewHolder newHolder, @NonNull ItemHolderInfo preInfo, @NonNull ItemHolderInfo postInfo) { if (DEBUG) { Log.d(TAG, \u0026#34;CHANGED: \u0026#34; + oldHolder + \u0026#34; with view \u0026#34; + oldHolder.itemView); } final int fromLeft = preInfo.left; final int fromTop = preInfo.top; final int toLeft, toTop; if (newHolder.shouldIgnore()) { toLeft = preInfo.left; toTop = preInfo.top; } else { toLeft = postInfo.left; toTop = postInfo.top; } return animateChange(oldHolder, newHolder, fromLeft, fromTop, toLeft, toTop); } fromLeftã€fromTopæ˜¯è€çš„holderçš„åæ ‡ï¼ŒtoLeftã€toTopæ˜¯æ–°çš„holderçš„åæ ‡ï¼Œæœ€åè°ƒç”¨äº†å¦å¤–ä¸€ä¸ªanimateChangeï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 @Override public boolean animateChange(RecyclerView.ViewHolder oldHolder, RecyclerView.ViewHolder newHolder, int fromX, int fromY, int toX, int toY) { if (oldHolder == newHolder) { // Don\u0026#39;t know how to run change animations when the same view holder is re-used. // run a move animation to handle position changes. return animateMove(oldHolder, fromX, fromY, toX, toY); } final float prevTranslationX = oldHolder.itemView.getTranslationX(); final float prevTranslationY = oldHolder.itemView.getTranslationY(); final float prevAlpha = oldHolder.itemView.getAlpha(); resetAnimation(oldHolder); int deltaX = (int) (toX - fromX - prevTranslationX); int deltaY = (int) (toY - fromY - prevTranslationY); // recover prev translation state after ending animation oldHolder.itemView.setTranslationX(prevTranslationX); oldHolder.itemView.setTranslationY(prevTranslationY); oldHolder.itemView.setAlpha(prevAlpha); if (newHolder != null) { // carry over translation values resetAnimation(newHolder); newHolder.itemView.setTranslationX(-deltaX); newHolder.itemView.setTranslationY(-deltaY); newHolder.itemView.setAlpha(0); } mPendingChanges.add(new ChangeInfo(oldHolder, newHolder, fromX, fromY, toX, toY)); return true; } å¦‚æœæ–°è€holderæ˜¯åŒä¸€ä¸ªï¼Œåˆ™è°ƒç”¨animateMoveï¼Œå‰é¢åˆ†æè¿‡oldHolderå’ŒnewHolderä¸æ˜¯åŒä¸€ä¸ªï¼Œæ‰€ä»¥å…ˆæŠŠnewHolderçš„translationXå’ŒtranslationXè®¾ç½®åˆ°ç›®æ ‡ä½ç½®ï¼Œå…¶å®æ­¤æ—¶çš„deltaXå’ŒdeltaYä¸º0ï¼Œå› ä¸ºç›®æ ‡çš„viewholderä½ç½®ä¹Ÿåœ¨åŸæ¥è¡¨é¡¹0çš„ä½ç½®ï¼Œæ¥ç€æŠŠé€æ˜åº¦è®¾ç½®ä¸º0ï¼Œæœ€ååˆ›å»ºäº†ChangeInfoï¼Œæ”¾å…¥åˆ°mPendingChangesä¸­ã€‚å½“animateChangeè¿”å›trueåï¼Œä¼šè°ƒç”¨postAnimationRunneræ–¹æ³•ï¼š\n1 2 3 4 5 6 void postAnimationRunner() { if (!mPostedAnimatorRunner \u0026amp;\u0026amp; mIsAttached) { ViewCompat.postOnAnimation(this, mItemAnimatorRunner); mPostedAnimatorRunner = true; } } ViewCompat.postOnAnimation(this, mItemAnimatorRunner)æ˜¯ç»™Choreographerä¸­æ·»åŠ ä¸€æ¡CALLBACK_ANIMATIONç±»å‹çš„äº‹ä»¶ï¼Œç­‰åˆ°ä¸‹ä¸€ä¸ªvsyncä¿¡å·æ¥çš„æ—¶å€™ï¼Œå°±ä¼šæ‰§è¡ŒmItemAnimatorRunnerï¼š\n1 2 3 4 5 6 7 8 9 private Runnable mItemAnimatorRunner = new Runnable() { @Override public void run() { if (mItemAnimator != null) { mItemAnimator.runPendingAnimations(); } mPostedAnimatorRunner = false; } }; æœ€ç»ˆä¼šæ‰§è¡ŒDefaultItemAnimatorçš„runPendingAnimationsæ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šæ‰§è¡ŒchangesPendingçš„é€»è¾‘ï¼Œæœ€ç»ˆä¼šæ‰§è¡ŒanimateChangeImplï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 void animateChangeImpl(final ChangeInfo changeInfo) { final RecyclerView.ViewHolder holder = changeInfo.oldHolder; final View view = holder == null ? null : holder.itemView; final RecyclerView.ViewHolder newHolder = changeInfo.newHolder; final View newView = newHolder != null ? newHolder.itemView : null; if (view != null) {//æ”¹å˜ä¹‹å‰çš„view final ViewPropertyAnimator oldViewAnim = view.animate().setDuration( getChangeDuration()); mChangeAnimations.add(changeInfo.oldHolder); oldViewAnim.translationX(changeInfo.toX - changeInfo.fromX); oldViewAnim.translationY(changeInfo.toY - changeInfo.fromY); oldViewAnim.alpha(0).setListener(new AnimatorListenerAdapter() { @Override public void onAnimationStart(Animator animator) { dispatchChangeStarting(changeInfo.oldHolder, true); } @Override public void onAnimationEnd(Animator animator) { oldViewAnim.setListener(null); view.setAlpha(1); view.setTranslationX(0); view.setTranslationY(0); dispatchChangeFinished(changeInfo.oldHolder, true); mChangeAnimations.remove(changeInfo.oldHolder); dispatchFinishedWhenDone(); } }).start(); } if (newView != null) {//æ”¹å˜ä¹‹åçš„view final ViewPropertyAnimator newViewAnimation = newView.animate(); mChangeAnimations.add(changeInfo.newHolder); newViewAnimation.translationX(0).translationY(0).setDuration(getChangeDuration()) .alpha(1).setListener(new AnimatorListenerAdapter() { @Override public void onAnimationStart(Animator animator) { dispatchChangeStarting(changeInfo.newHolder, false); } @Override public void onAnimationEnd(Animator animator) { newViewAnimation.setListener(null); newView.setAlpha(1); newView.setTranslationX(0); newView.setTranslationY(0); dispatchChangeFinished(changeInfo.newHolder, false); mChangeAnimations.remove(changeInfo.newHolder); dispatchFinishedWhenDone(); } }).start(); } } è¯¥æ–¹æ³•é‡Œé¢é€šè¿‡viewçš„animateæ–¹æ³•ç»™viewåšåŠ¨ç”»ï¼Œæ”¹å˜ä¹‹å‰çš„viewä½ç½®ä¸ä¼šå‘ç”Ÿå˜åŒ–ï¼Œåªä¼šå‘ç”Ÿalphaçš„åŠ¨ç”»ï¼Œè€Œæ”¹å˜ä¹‹åçš„viewä¼šåšä»0åˆ°1çš„é€æ˜åº¦åŠ¨ç”»ã€‚æ‰€ä»¥æœ€ç»ˆé¡µé¢ä¸Šä¼šå‡ºç°é—ªçš„ä¸€ä¸‹ï¼Œè¿™ä¸ªæ˜¯åšæ›´æ–°æ“ä½œã€‚ ä¸Šé¢åˆ†æçš„æ˜¯è¡¨é¡¹0ä¼šè°ƒç”¨animateChangeï¼Œè¡¨é¡¹1åˆ°9ä¼šæ‰§è¡ŒaddToPostLayoutï¼š\n1 2 3 4 5 6 7 8 9 void addToPostLayout(RecyclerView.ViewHolder holder, RecyclerView.ItemAnimator.ItemHolderInfo info) { InfoRecord record = mLayoutHolderMap.get(holder); if (record == null) { record = InfoRecord.obtain(); mLayoutHolderMap.put(holder, record); } record.postInfo = info; record.flags |= FLAG_POST; } åœ¨dispatchLayout1çš„æ—¶å€™ï¼Œè¡¨é¡¹1åˆ°9ä¼šæ·»åŠ ä¸ŠFLAG_PREæ ‡è®°ï¼Œæ¥ç€åœ¨æ­¤å¤„åˆæ·»åŠ ä¸ŠFLAG_POSTæ ‡è®°ï¼Œè¡¨é¡¹10æ·»åŠ äº†FLAG_APPEARæ ‡è®°ã€‚æ‰€æœ‰çš„æ ‡è®°æ·»åŠ å®Œåï¼Œæœ€ç»ˆä¼šæ‰§è¡ŒViewInfoStoreçš„processï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 void process(ProcessCallback callback) { for (int index = mLayoutHolderMap.size() - 1; index \u0026gt;= 0; index--) { final RecyclerView.ViewHolder viewHolder = mLayoutHolderMap.keyAt(index); final InfoRecord record = mLayoutHolderMap.removeAt(index); if ((record.flags \u0026amp; FLAG_PRE_AND_POST) == FLAG_PRE_AND_POST) { // Persistent in both passes. Animate persistence callback.processPersistent(viewHolder, record.preInfo, record.postInfo); } else if ((record.flags \u0026amp; FLAG_APPEAR) != 0) { // Scrap view. RecyclerView will handle removing/recycling this. } InfoRecord.recycle(record); } } è¿™é‡Œçœç•¥äº†æ— å…³ç´§è¦çš„ä»£ç ï¼Œè¡¨é¡¹1åˆ°9ä¼šè°ƒç”¨callback.processPersistentå›è°ƒï¼Œè¡¨é¡¹10ä¸åšç›¸å…³æ›´æ–°ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 @Override public void processPersistent(ViewHolder viewHolder, @NonNull ItemHolderInfo preInfo, @NonNull ItemHolderInfo postInfo) { viewHolder.setIsRecyclable(false); if (mDataSetHasChangedAfterLayout) { // since it was rebound, use change instead as we\u0026#39;ll be mapping them from // stable ids. If stable ids were false, we would not be running any // animations if (mItemAnimator.animateChange(viewHolder, viewHolder, preInfo, postInfo)) { postAnimationRunner(); } } else if (mItemAnimator.animatePersistence(viewHolder, preInfo, postInfo)) { postAnimationRunner(); } } ç”±äºmDataSetHasChangedAfterLayoutæ˜¯åœ¨setAdapterä¸­è®¾ç½®çš„ï¼Œæ‰€ä»¥ä¼šèµ°mItemAnimator.animateChangeé€»è¾‘ï¼Œåœ¨ä¸Šé¢åˆ†æè¿‡ï¼Œå¦‚æœä¸¤ä¸ªviewholderæ˜¯åŒä¸€ä¸ªï¼Œåˆ™è°ƒç”¨animateMoveæ–¹æ³•ï¼Œè€Œä½ç½®ä¿¡æ¯åˆä¸å‘ç”Ÿå˜åŒ–ï¼Œæ‰€ä»¥animateChangeè¿”å›falseï¼Œå› æ­¤ä¹Ÿä¸ä¼šè§¦å‘postAnimationRunnerã€‚\nrecyclerviewä¸­åªè¦è¢«æ·»åŠ åˆ°é¡µé¢ä¸Šçš„viewholderï¼Œå¹¶ä¸”æ˜¯scrapç¼“å­˜ä¸­çš„ï¼Œæœ€ç»ˆéƒ½ä¼šä»scrapç¼“å­˜ä¸­ç§»é™¤ã€‚è€Œåœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œåˆ†ædispatchLayout2çš„æ—¶å€™æ€»å…±æœ‰11ä¸ªè¡¨é¡¹ï¼Œåˆ†åˆ«æ˜¯åŸæ¥çš„è¡¨é¡¹0ï¼ˆå­˜åœ¨äºchangeScrapç¼“å­˜ä¸­ï¼‰ï¼ŒdispatchLayout1åˆ›å»ºçš„è¡¨é¡¹10ï¼ˆå­˜åœ¨äºattachScrapä¸­ï¼‰ã€‚åœ¨dispatchLayout3åšå®ŒåŠ¨ç”»åï¼Œä¼šæ¸…ç©ºæ‰scrapç¼“å­˜ï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨äº†mLayout.removeAndRecycleScrapIntæ–¹æ³•ï¼š\n1 2 3 4 5 void removeAndRecycleScrapInt(Recycler recycler) { //çœç•¥ä»£ç  recycler.clearScrap(); //çœç•¥ä»£ç  } æœ€ç»ˆä¼šè°ƒç”¨clearScrapæ¥æ¸…ç©ºscrapç¼“å­˜ã€‚\nå…³äºåˆ é™¤è¡¨é¡¹çš„åŠ¨ç”»å¤„ç†ï¼Œå¯ä»¥çœ‹è¿™é‡Œ:RecyclerView åŠ¨ç”»åŸç† | å¦‚ä½•å­˜å‚¨å¹¶åº”ç”¨åŠ¨ç”»å±æ€§å€¼ï¼Ÿ\n","date":"2025-01-09T00:00:00Z","permalink":"http://xiangcman.xyz/p/recyclerview%E5%8A%A8%E7%94%BB%E5%8E%9F%E7%90%86/","title":"RecyclerViewåŠ¨ç”»åŸç†"},{"content":"åˆå§‹åŒ–è¿‡ç¨‹ å½“æˆ‘ä»¬appæ”¶åˆ°choregrapherçš„vsyncä¿¡å·çš„æ—¶å€™ï¼Œchoregrapherä¸­ä¼šç»™ä¸»çº¿ç¨‹çš„messageQueueå‘é€ä¸€æ¡æ¶ˆæ¯ï¼Œ å‘Šè¯‰appéœ€è¦ç»˜åˆ¶äº†ï¼Œè€Œæ­¤æ—¶å‘é€æ˜¯é€šè¿‡ç»™ä¸»çº¿ç¨‹çš„messageQueueè®¾ç½®ä¸€ä¸ªcallbackï¼ˆrunnableï¼‰ï¼Œæ‰€ä»¥ä¼šè§¦å‘handlerçš„dispatchMessage-\u0026gt;handleCallbackï¼Œæ¥ç€å°±æ˜¯è§¦å‘FrameDisplayEventReceiverï¼ˆrunnableï¼‰çš„doFrameæ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šè®¡ç®—ä¸¢å¸§æ•°ï¼Œä»¥åŠæ‰§è¡ŒcallbackQueueæ•°ç»„ä¸­çš„callbackQueueï¼Œä¹Ÿå°±æ‰§è¡Œåˆ°äº†æˆ‘ä»¬çš„performTraversalæ–¹æ³•ï¼Œè¯¥æ–¹æ³•é‡Œé¢ä¼šæ‰§è¡Œåˆ°measureï¼Œæœ€åæ‰§è¡Œåˆ°recyclerviewçš„onMeasureï¼Œrecyclerviewçš„onMeasureä¸­ä¼šåˆ¤æ–­è‡ªå·±çš„æµ‹é‡æ¨¡å¼ï¼Œå¦‚æœæ˜¯ç²¾ç¡®çš„æ¨¡å¼ï¼Œåˆ™ä¸æµ‹é‡å­itemã€‚\ntraceå›¾å¦‚ä¸‹ï¼š æ¥ç€èµ°åˆ°recyclerviewçš„onlayoutï¼Œåœ¨onlayouté‡Œé¢è§¦å‘dispatchlayoutï¼Œè¯¥æ–¹æ³•é‡Œé¢ä¼šåˆ¤æ–­stateçš„stepï¼Œé»˜è®¤æ˜¯STEP_STARTï¼Œå› æ­¤ä¼šè§¦å‘dispatchLayoutStep1å’ŒdispatchLayoutStep2ï¼Œåœ¨dispatchLayoutStep1ä¸­å¦‚æœæœ‰åŠ¨ç”»è¦å¤„ç†ï¼Œåˆ™ä¼šè§¦å‘layoutManagerçš„onlayoutChildren\næœ‰åŠ¨ç”»çš„æ¡ä»¶æ˜¯ï¼š æœ‰è¡¨é¡¹æ–°å¢æˆ–ç§»é™¤ã€æœ‰æ›´æ”¹çš„æ—¶å€™ã€‚é»˜è®¤æ˜¯æ²¡æœ‰åŠ¨ç”»è¦å¤„ç†ï¼Œç´§æ¥ç€æ¥åˆ°äº†dispatchLayout2ï¼Œè¯¥æ–¹æ³•ä¸»è¦æ˜¯è§¦å‘äº†layoutManager.onLayoutChildrenã€‚ è°ƒç”¨é“¾å¦‚ä¸‹ï¼š linearlayoutmanager.fill-\u0026gt;layoutmanager.layoutChunk-\u0026gt;layoutstate.next-\u0026gt;recycler.getviewforposition-\u0026gt;recycler.tryGetViewHolderForPostionByDeadline-\u0026gt;adapter.createViewHolder-\u0026gt;adapter.bindViewHolderåˆ°è¿™é‡Œä¸€ä¸ªholderçš„åˆ›å»ºå’Œbindè¿‡ç¨‹å°±ç»“æŸäº†ï¼Œç´§æ¥ç€åœ¨layoutchunkä¸­è§¦å‘layoutmanager.addViewå’Œlayoutmanager.measureChildWithMarginï¼Œåˆ°è¿™é‡Œè¡¨é¡¹æ‰ä¼šè¢«åŠ å…¥åˆ°recyclerviewä¸­ï¼Œä½†æ˜¯æ­¤æ—¶ä¸ä¼šåˆ·æ–°recyclerviewã€‚ ä¸Šé¢è¯´åˆ°çš„layoutchunkä¼šåœ¨ä¸€ä¸ªwhileå¾ªç¯ä¸­å¤šæ¬¡æ‰§è¡Œï¼Œç›´åˆ°recyclerviewçš„ç©ºé—´æ²¡æœ‰äº†æ‰ä¸ä¼šæ‰§è¡Œï¼Œè€Œlayoutchunkåˆä¼šèµ°recycler.nextå»ä»ç¼“å­˜ä¸­æ‹¿viewholderï¼Œè€Œæ­¤æ—¶ç¼“å­˜ä¸­æ²¡æœ‰viewholderï¼Œå› æ­¤ä¼šèµ°createviewholderå’Œbindviewholderï¼Œæ‰€ä»¥ä¸€å¼€å§‹createå’Œbindæ¬¡æ•°æ˜¯ä¸€å±èƒ½å±•ç¤ºå¤šå°‘ä¸ªè¡¨é¡¹çš„æ¬¡æ•°ã€‚ æ¥ç€åœ¨dispatchlayoutä¸­ä¼šè°ƒç”¨dispatchlayoutstep3ï¼Œè¯¥æ–¹æ³•é‡Œé¢ä¸»è¦æ˜¯æ‰§è¡Œscrapç¼“å­˜çš„é‡Šæ”¾ï¼Œä»¥åŠåŠ¨ç”»çš„æ‰§è¡Œ\nåˆ°è¿™é‡Œï¼Œæµ‹é‡å’Œlayoutå·²ç»æ¢³ç†å®Œäº†ï¼Œæœ€åå°±å‰©drawäº†ï¼š drawé‡Œé¢åŸºæœ¬æ²¡å¹²ä»€ä¹ˆï¼Œè¿˜æ˜¯æ²¿ç”¨äº†viewgroupçš„drawchildæ–¹æ³•ï¼Œç»¿è‰²è¡¨ç¤ºéç³»ç»Ÿæ–¹æ³•ï¼Œå› æ­¤å¯ä»¥çœ‹å‡ºæ¥recyclerviewæ˜¯é‡å†™äº†è¯¥æ–¹æ³•ï¼š æ€»ç»“ï¼š åˆå§‹åŒ–åˆ†ä¸ºonmeasureé˜¶æ®µï¼šå¦‚æœrecyclerviewè®¾ç½®äº†å›ºå®šå®½é«˜ï¼Œåˆ™ç›´æ¥è·³è¿‡æµ‹é‡ï¼Œè°ƒç”¨åˆ°mLayoutä¸­ï¼Œå¦‚æœä¸æ˜¯å›ºå®šå®½é«˜ï¼Œåˆ™ä¼šèµ°dispatchLayoutStep1ï¼ŒdispatchLayoutStep2ã€‚å…¶ä¸­dispatchLayoutStep1æ˜¯é¢„å¸ƒå±€å¤„ç†ï¼Œå¦‚æœæœ‰åŠ¨ç”»è¦å¤„ç†æ‰ä¼šåœ¨è¯¥é˜¶æ®µè°ƒç”¨åˆ°layoutçš„onLayoutChildrenã€‚åœ¨dispatchLayoutStep2ä¸­å¤„ç†è¡¨é¡¹çš„æµ‹é‡ã€‚ åœ¨onlayouté˜¶æ®µï¼šä¼šåˆ¤æ–­stepè¿˜æ˜¯ä¸æ˜¯startçŠ¶æ€ï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œåˆ™å†æ¬¡æ‰§è¡ŒdispatchLayoutStep1å’ŒdispatchLayoutStep2ã€‚æœ€åè°ƒç”¨dispatchLayoutStep3ç”¨æ¥åšåŠ¨ç”»æ‰§è¡Œå¹¶é‡Šæ”¾ç›¸å…³èµ„æºã€‚ åœ¨drawé˜¶æ®µåŸºæœ¬ä»€ä¹ˆéƒ½æ²¡åšï¼ŒdispatchDrawæœ¬èº«ä¼šè°ƒç”¨åˆ°drawChildï¼Œrecyclerviewåªæ˜¯é‡å†™äº†è¯¥æ–¹æ³•ã€‚\næ»‘åŠ¨è¿‡ç¨‹ æ»‘åŠ¨è¿‡ç¨‹ä¸­ä¼šè°ƒç”¨åˆ°scrollByInternal-\u0026gt;layoutmanager.scrollBy-\u0026gt;fill-\u0026gt;layoutchunckã€‚ layoutchuncké‡Œé¢ä¼šä»ç¼“å­˜ä¸­å–æ•°æ®ï¼Œå¦‚æœæœ‰åˆ™å‘½ä¸­ï¼Œæ²¡æœ‰åˆ™èµ°createå’Œbindï¼Œæ¥ç€åˆ’å‡ºå±å¹•çš„è¡¨é¡¹ä¼šå…ˆåŠ å…¥åˆ°cacheç¼“å­˜ä¸­ï¼Œå¦‚æœcacheç¼“å­˜æ»¡äº†ï¼Œåˆ™é‡ç½®è¯¥è¡¨é¡¹ï¼ŒåŠ å…¥åˆ°recyclerpoolä¸­ï¼Œä¸‹æ¬¡æ‰€ä»¥å–çš„æ—¶å€™ä»recyclerpoolæ ¹æ®viewtypeå–éœ€è¦é‡æ–°bindï¼Œä¸éœ€è¦createï¼Œæ‰€ä»¥åœ¨æ»‘åŠ¨è¿‡ç¨‹ä¸­createçš„æ¬¡æ•°æ˜¯cacheçš„å¤§å°æ¬¡æ•°ï¼Œç­‰åˆ°recyclerpoolä¸­æœ‰ç¼“å­˜çš„æ—¶å€™å°±ä¸éœ€è¦createäº†ã€‚\nåœ¨fillè¿‡ç¨‹ä¸­ï¼Œä¼šæ‰¾åˆ°åˆ’å‡ºå±å¹•çš„è¡¨é¡¹ï¼Œç„¶åå…ˆè°ƒç”¨recycleByLayoutStateï¼Œæ¥ç€è°ƒç”¨åˆ°äº†Linearlayoutmanager.recycleChildrenï¼Œæ¥ç€ä¼šè§¦å‘recyclerview.removeAndRecycleViewAtæ–¹æ³•ï¼Œæ¥ç€å°±è§¦å‘äº†adapter.onViewDetachedFromWindow(viewHolder)ï¼Œæ¥ç€å°±æŠŠviewholderç¼“å­˜åˆ°cacheå’Œrecyclerpoolä¸­ï¼Œå¯¹åº”çš„æ–¹æ³•æ˜¯recycler.recycleView-\u0026gt;recycleViewHolderInternal,å…¶ä¸­cacheç¼“å­˜ä¸­é»˜è®¤æ˜¯2ä¸ªï¼Œå¦‚æœå¤§äº2çš„è¯ï¼Œä¼šæŠŠæœ€å‰é¢çš„é‚£ä¸ªç»™æ”¾åˆ°recyclerpoolä¸­ï¼Œæ¥ç€å†æŠŠæ–°çš„viewholderæ”¾è¿›æ¥ã€‚\nåœ¨fiilè¿‡ç¨‹ä¸­ï¼Œä¼šé€šè¿‡LayoutState.nextä»ç¼“å­˜ä¸­è·å–viewholderï¼Œè·å–çš„æ—¶å€™ä¼šå…ˆåˆ¤æ–­æ˜¯ä¸æ˜¯preLayoutçŠ¶æ€ï¼Œå¦‚æœæ˜¯åˆ™ä»changeScrapç¼“å­˜ä¸­è·å–ï¼Œä»changeScrapä¸­è·å–ç¼“å­˜å…ˆé€šè¿‡positionè·å–ï¼Œå¦‚æœç”¨positionè·å–ä¸åˆ°ï¼Œåˆ™å†ç”¨idå»è·å–ï¼ˆå¿…é¡»adapterè®¾ç½®setHasStableIdsä¸ºtrueï¼Œå¹¶ä¸”adapteré‡å†™äº†getItemIdï¼‰ã€‚å¦‚æœæ²¡è·å–åˆ°åˆ™ä»attacheScrapå’Œcacheä¸­è·å–ï¼Œå¦‚æœä»attachå’Œcacheä¸­æ‰¾ä¸åˆ°ï¼Œåˆ™ç»§ç»­é€šè¿‡idä»attachScrapä¸­è·å–ï¼Œå¦‚æœè¿˜æ²¡è·å–åˆ°åˆ™ä»viewcacheExtensionä¸­å»è·å–ï¼Œå¦‚æœè¿˜è·å–ä¸åˆ°åˆ™å†ä»recyclerpoolä¸­å»è·å–ï¼Œå¦‚æœè¿˜è·å–ä¸åˆ°åˆ™é€šè¿‡createæ¥åˆ›å»ºviewholderï¼Œæ¥ç€èµ°bindé€»è¾‘ã€‚\næ‰€ä»¥æ•´ä¸ªç¼“å­˜è·å–é¡ºåºï¼š changeScrap(preLayoutçŠ¶æ€ï¼Œå…ˆé€šè¿‡positionè·å–ï¼Œæ²¡è·å–åˆ°å†é€šè¿‡idè·å–)-\u0026gt;attacheScrap-\u0026gt;cache-\u0026gt;attachScrap(idæ–¹å¼è·å–)-\u0026gt;viewcacheExtension-\u0026gt;recyclerpool-\u0026gt;createholder-\u0026gt;bindholder è¿™å°±æ˜¯layoutstate.nextè·å–viewholderæ•´ä¸ªé€»è¾‘ï¼Œä¸Šé¢å“ªäº›ä¼šè§¦å‘createholderå’Œbindholder å¦‚æœä»å‡ ä¸ªç¼“å­˜ä¸­éƒ½æ‹¿ä¸åˆ°viewholderï¼Œåˆ™ä¼šèµ°createholderçš„é€»è¾‘ã€‚\nä»€ä¹ˆæƒ…å†µä¸‹ä¼šè°ƒç”¨onBindViewHolderï¼Ÿ ä¸æ˜¯boundçŠ¶æ€ boundæ ‡å¿—ä½ï¼šæ˜¯åœ¨bindViewHolderçš„æ—¶å€™è®¾ç½®çš„ï¼Œå› æ­¤ä¸æ˜¯boundè¡¨ç¤ºæ²¡æœ‰bindè¿‡ã€‚æ²¡æœ‰bindè¿‡æœ‰ï¼š1ï¼Œcreateholderï¼›2ï¼Œä»recyclerpoolå–çš„viewholderã€‚ needsUpdateï¼šè¯¥çŠ¶æ€è¡¨ç¤ºä»€ä¹ˆï¼Ÿä»€ä¹ˆæ—¶å€™æ‰ä¼šæ˜¯needUpdate()å‘¢ï¼Ÿ åœ¨viewRangeUpdateè®¾ç½®çš„ã€‚çŒœæµ‹æ˜¯åœ¨viewholderå‘ç”Ÿå˜åŒ–çš„æ—¶å€™è®¾ç½®çš„ï¼ŒéªŒè¯çŒœæƒ³ï¼š recyclerview.processAdapterUpdatesAndSetAnimationFlags-\u0026gt;AdapterHelper.preProcess-\u0026gt;applyUpdate-\u0026gt;postponeAndUpdateViewHolders -\u0026gt;markViewHoldersUpdated-\u0026gt;viewRangeUpdateï¼Œæ‰€ä»¥åœ¨dispatchLayout1è¿‡ç¨‹ä¸­ç»™flagè®¾ç½®äº†updateçŠ¶æ€\nisInvalidï¼šè¡¨ç¤ºä»€ä¹ˆçŠ¶æ€ï¼Ÿä»€ä¹ˆæ—¶å€™èµ‹å€¼çš„ï¼Ÿ markKnownViewsInvalidä¼šå¯¹æ‰€æœ‰é¡µé¢ä¸Šå¯è§çš„viewholderè®¾ç½®ä¸ºFLAG_INVALIDï¼Œå¹¶ä¸”æŠŠcacheç¼“å­˜ä¸­çš„viewholderè®¾ç½®ä¸ºFLAG_INVALIDï¼Œå®ƒæ˜¯åœ¨notifydataSetChangeæ—¶å€™è°ƒç”¨ åœ¨holderç¼“å­˜è·å–çš„æ—¶å€™ï¼Œå¦‚æœå‘ç°holderçš„viewtypeå’Œadapterä¸­é‡å†™çš„viewtypeä¸ä¸€è‡´ä¼šé‡ç½®ï¼Œä¼šç»™viewholderæ·»åŠ è¯¥æ ‡å¿—ä½ ä»ç¼“å­˜ï¼ˆattachScrapã€cacheviewï¼‰ä¸­è·å–viewholderçš„æ—¶å€™ï¼Œå¦‚æœå‘ç°typeå’Œholderçš„typeä¸ä¸€è‡´ï¼Œåˆ™ä¼šæ ¡éªŒä¸é€šè¿‡ã€‚æˆ–è€…è®¾ç½®äº†stableidsä¸ºtrueçš„æ—¶å€™ï¼Œå¦‚æœadapterä¸­çš„idå’Œholderçš„idä¸€è‡´ï¼Œåˆ™ä¹Ÿé€šè¿‡ã€‚ æ‰€ä»¥ç»“è®ºå°±æ˜¯ï¼Œéœ€è¦boundçš„æ¡ä»¶ï¼šæ²¡æœ‰boundè¿‡ï¼ˆcreateholderçš„holderè¿˜æ²¡æœ‰boundè¿‡æˆ–è€…æ˜¯ä»recyclerpoolä¸­è·å–çš„holderï¼‰ï¼›needupdateçš„ï¼Œholderå‘ç”Ÿæ›´æ–°äº†ã€‚invalidï¼Œä»attachscrapã€cacheè·å–åï¼Œ å¦‚æœtypeä¸ä¸€è‡´ä¹Ÿéœ€è¦é‡æ–°boundï¼Œæˆ–è€…æ˜¯è°ƒç”¨äº†notifydataSetChangeåï¼Œæ‰€æœ‰çš„viewholderéƒ½ä¼šæ·»åŠ nvalidæ ‡å¿—ä½ï¼Œæ­¤æ—¶ä¹Ÿéœ€è¦bindã€‚\næ›´æ–°è¡¨é¡¹ notifyItemChange(0)ï¼šæ›´æ–°è¡¨é¡¹ç¬¬0çš„ä½ç½®\né¦–å…ˆæ˜¯è¿›å…¥é¡µé¢åˆ›å»ºäº†10ä¸ªè¡¨é¡¹ï¼Œç„¶åæ›´æ–°åæ—¥å¿—å¦‚ä¸‹ï¼š é¦–å…ˆç»™æˆ‘åˆ›å»ºäº†ç´¢å¼•ä¸º10çš„è¡¨é¡¹ï¼Œä¹Ÿå°±æ˜¯å±å¹•ä¸Šä¸å¯è§çš„ï¼Œæ¥ç€åˆåˆ›å»ºäº†è¡¨é¡¹0ï¼Œé€šè¿‡traceviewåˆ†æï¼š æ•´ä½“çœ‹ç»å†äº†rvçš„layoutè¿‡ç¨‹ï¼Œåˆ†åˆ«å¯¹åº”äº†dispatchLayoutStep1ã€dispatchLayoutStep2ã€dispatchLayoutStep3ã€‚\ndispatchLayoutStep1 detachAndScrapAttachedViews å…±ç»å†äº†10æ¬¡scrapOrRecycleViewï¼š å®ƒæ˜¯åå‘éå†é¡µé¢ä¸Šçš„viewï¼Œç„¶åæ·»åŠ åˆ°srapç¼“å­˜ä¸­ï¼š ä»scrapOrRecycleViewçš„è°ƒç”¨æ ˆæ¥çœ‹ï¼Œæ˜¯èµ°äº†elseéƒ¨åˆ†ï¼Œä¹Ÿå°±æ˜¯å¾€scrapç¼“å­˜ä¸­åŠ å…¥viewholderã€‚ç”±äºviewHolderçš„isInvalidä¸ºfalseï¼Œæ‰€ä»¥ä¼šèµ°elseã€‚ scrapç¼“å­˜åˆ†ä¸¤ç§ï¼ŒattachScrapå’ŒchangeScrapã€‚ä¸æ˜¯updateçš„ä¼šæ”¾åˆ°attachScrapä¸­ï¼Œæ‰€ä»¥æˆ‘ä»¬æ›´æ–°ç¬¬0ä¸ªçš„æ—¶å€™ä¼šæ”¾åˆ°changeScrapä¸­ï¼Œåœ¨detachçš„æ—¶å€™ç”±äºæ˜¯åå‘åŠ å…¥åˆ°scrapç¼“å­˜ä¸­çš„ï¼Œå› æ­¤æˆ‘ä»¬çœ‹ç¬¬10ä¸ªçš„traceè°ƒç”¨ï¼š ä»è¿™é‡Œçœ‹ç¬¬0ä¸ªè¡¨é¡¹åœ¨detachçš„æ—¶å€™ä¼šåŠ å…¥åˆ°changeScrapä¸­ã€‚ ç»“è®ºï¼šåœ¨dispatchLayout1ä¸­ï¼Œå…ˆå°†é¡µé¢ä¸Šå¯è§çš„viewholderä»é¡µé¢ä¸Šåˆ†ç¦»ï¼Œç„¶åå°†updateçš„viewholderæ”¾å…¥åˆ°changeScrapä¸­ï¼ŒæŠŠéupdateçš„viewholderæ”¾å…¥åˆ°attachScrapä¸­ã€‚\nfill fillé˜¶æ®µå‘ç”Ÿäº†layoutChunk11æ¬¡ï¼Œè€Œæˆ‘ä»¬åˆšå¼€å§‹åˆ—è¡¨æ˜¯åˆå§‹åŒ–äº†10ä¸ªè¡¨é¡¹ï¼Œé‚£ä¹ˆè¯´æ˜dispatchLayout1é˜¶æ®µæ·»åŠ äº†ä¸€ä¸ªæ–°çš„viewholderï¼Œå…³äºè¿™å—æˆ‘ä»¬å¯ä»¥ç»™å‡ºç»“è®ºï¼Œå¦‚æœviewhodlerè¢«è®¾ç½®äº†removeæˆ–è€…updateæ ‡è®°çš„æ—¶å€™ï¼Œåˆ™ä¼šç»™åˆ—è¡¨æ·»åŠ ä¸€ä¸ªæ–°çš„viewholderã€‚å…³äºè¿™å—å¯ä»¥çœ‹ï¼šhttps://juejin.cn/post/6890288761783975950 åœ¨fillçš„whileå¾ªç¯ä¸­ä¼šåˆ¤æ–­remainingSpaceæ—¶å€™å¤§äº0ï¼Œè€Œæ¯æ¬¡layoutChunkè¿‡ç¨‹ä¸­ä¼šå°†remainingSpaceå‡å°ï¼Œè€ŒlayoutChunkResult.mIgnoreConsumedå°±æ˜¯åˆ¤æ–­æ˜¯å¦è¦å‡å°ï¼Œæ„æ€æ˜¯å¦‚æœä¸å¿½ç•¥æ‰ä¼šå‡å°ï¼Œé‚£ä»€ä¹ˆæ—¶å€™ä¼šå¿½ç•¥å‘¢ï¼Ÿ layoutChunkä¸­åˆ¤æ–­viewholderå¦‚æœæ˜¯removeæˆ–è€…æ˜¯changeæ—¶å€™ï¼Œæ‰ä¼šå¿½ç•¥å‡å°ã€‚æ‰€ä»¥æˆ‘ä»¬ä¼šæœ‰11æ¬¡çš„layoutChunkï¼Œè€Œæœ€åä¸€æ¬¡çš„layoutChunkä¼šèµ°createViewHolderï¼Œä¹Ÿå°±å¯¹åº”äº†ä¸Šé¢çš„æ—¥å¿—å…ˆæ·»åŠ äº†position=10çš„viewholderã€‚ä»traceä¸Šçœ‹ä¸‹ï¼š ç»“è®ºï¼š dispatchLayout1è¿‡ç¨‹ä¸­ï¼Œå°†ç¬¬0ä¸ªæ”¾å…¥åˆ°changeScrapä¸­ï¼Œ1-9æ”¾å…¥åˆ°äº†attacheScrapä¸­ï¼Œå¹¶ä¸”åˆ›å»ºäº†ç´¢å¼•ä¸º10çš„viewhodlerã€‚\næ³¨æ„ï¼š åœ¨dispatchLayout1è¿‡ç¨‹ä¸­ï¼Œå¦‚æœviewholderç»è¿‡äº†addViewä¹‹åï¼Œåˆ™ä¼šæŠŠå®ƒä»changescrapæˆ–è€…æ˜¯attachscrapç¼“å­˜ä¸­ç§»é™¤ï¼Œæ‰€ä»¥åœ¨dispatchlayout2è¿‡ç¨‹ä¸­changeå’Œattachçš„ç¼“å­˜ä¸ºç©ºçš„ã€‚ å…¶å®åœ¨dispatchLayout2è¿‡ç¨‹ä¸­æ·»åŠ viewholderçš„viewæ—¶å€™ä¹Ÿæ˜¯è¦ä»scrapç¼“å­˜ä¸­ç§»é™¤ã€‚\ndispatchLayoutStep2 detachAndScrapAttachedViews ç”±äºåœ¨dispatchLayout1è¿‡ç¨‹ä¸­åˆ›å»ºäº†position=10çš„viewholderï¼Œå› æ­¤ä¼šæœ‰11æ¬¡ï¼Œè¿™11ä¸ªé‡Œé¢ç¬¬0ä¸ªè¿˜æ˜¯æ·»åŠ åˆ°äº†changeScrapä¸­ï¼Œ1-10æ˜¯æ·»åŠ åˆ°attachScrapä¸­ã€‚\nfill ä¸ºä»€ä¹ˆæ­¤è¿‡ç¨‹åªæœ‰10æ¬¡layoutChunckå‘¢ï¼Ÿè¿™å—å…¶å®è¿˜æ˜¯å›åˆ°remainingSpaceçš„è®¡ç®—è¯´èµ·ï¼š æ‰€ä»¥åœ¨dispatchLayout2è¿‡ç¨‹ä¸­å½“æ·»åŠ åˆ°ç´¢å¼•ç­‰äº9çš„æ—¶å€™remainingSpaceå°±ä¸º0äº†ï¼Œæ‰€ä»¥ç´¢å¼•ç­‰äº10çš„æ—¶å€™æ·»åŠ ä¸ä¸Šï¼Œå› æ­¤åªä¼šæœ‰10æ¬¡layoutChunckã€‚\nlayoutChunck æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç¬¬0ä¸ªèµ°äº†createViewholderå’ŒbindViewholderï¼š æ˜¯ç”±äºç¬¬0ä¸ªviewholderè¢«æ·»åŠ åˆ°äº†changeScrapç¼“å­˜ä¸­ï¼Œè€Œ1-9çš„viewholderæ·»åŠ åˆ°äº†attachScrapä¸­ï¼Œè€ŒchangeScrapåªä¼šåœ¨pre-layoutè¿‡ç¨‹ä¸­æ‰ä¼šç”Ÿæ•ˆï¼š æ‰€ä»¥å¯ä»¥çœ‹åˆ°ä¸Šé¢æ—¥å¿—ä¸­ä¼šèµ°äº†position=0çš„createViewHolderå’ŒbindViewHolderã€‚\næ€»ç»“: æ›´æ–°è¡¨é¡¹çš„æ—¶å€™ï¼Œä¼šç»å†dispatchLayout1ï¼ŒdispatchLayout2ï¼Œå…¶ä¸­åœ¨dispatchLayout1ï¼ˆpre-layouté˜¶æ®µï¼‰ä¼šå…ˆæŠŠå¯è§çš„è¡¨é¡¹ç»™å›æ”¶åˆ°scrapç¼“å­˜ä¸­ï¼Œå›æ”¶åï¼Œä¼šæŠŠå¯è§çš„è¡¨é¡¹ä»recyclerviewä¸­åˆ†ç¦»ï¼Œå…¶ä¸­éœ€è¦å˜åŒ–çš„è¡¨é¡¹ä¼šåŠ å…¥åˆ° changeScrapä¸­ï¼ˆç¬¬1ä¸ªè¡¨é¡¹ï¼‰ï¼Œä¸å˜åŒ–çš„åŠ å…¥åˆ°attachScrapä¸­ï¼ˆç¬¬2ä¸ªåˆ°ç¬¬10ä¸ªè¡¨é¡¹ï¼‰ã€‚æ¥ç€åœ¨fillé˜¶æ®µä¼šä»scrapç¼“å­˜ä¸­å–è¡¨é¡¹ï¼Œç”±äºæœ‰è¡¨é¡¹æ›´æ–°ï¼Œæ‰€ä»¥æ­¤æ—¶ä¼šå»åˆ›å»ºä¸å¯è§çš„è¡¨é¡¹ï¼ˆç¬¬11ä¸ªè¡¨é¡¹ï¼‰ï¼Œæœ€åä¼šæ·»åŠ åˆ°recyclerviewä¸Šã€‚ åœ¨dispatchLayout2ï¼ˆpost-layouté˜¶æ®µï¼‰åŒæ ·ä¼šæŠŠdispatchLayout1æ·»åŠ è¿›æ¥çš„è¡¨é¡¹ç»™æ·»åŠ åˆ°changeScrapï¼ˆç¬¬1ä¸ªè¡¨é¡¹ï¼‰å’ŒattachScrapï¼ˆç¬¬2ä¸ªåˆ°ç¬¬11ä¸ªè¡¨é¡¹ï¼‰ç¼“å­˜ä¸­ï¼Œæ³¨æ„æ­¤æ—¶çš„è¡¨é¡¹ä¼šæ˜¯11ä¸ªè¡¨é¡¹ã€‚åœ¨fillé˜¶æ®µä¼šå»åˆ›å»ºè¡¨é¡¹0ï¼Œ å› ä¸ºpost-layouté˜¶æ®µä¸ä¼šå»å–changeScrapä¸­çš„viewholderï¼Œæ‰€ä»¥è¡¨é¡¹0ä¼šç»å†åˆ›å»ºã€‚å¹¶ä¸”æ­¤æ—¶ä¸ä¼šæ·»åŠ ç¬¬11ä¸ªè¡¨é¡¹ï¼Œå› ä¸ºåœ¨fillå®Œç¬¬10ä¸ªè¡¨é¡¹çš„æ—¶å€™ï¼Œå…¶å®rvçš„å¯ç”¨ç©ºé—´å·²ç»ä¸å¤Ÿäº†ã€‚ä¸Šé¢æåˆ°è¡¨é¡¹æ·»åŠ åˆ°rvåï¼Œä¼šå°†viewholderä»scrapç¼“å­˜ä¸­ç§»é™¤æ‰ï¼Œè€Œç”±äºåŸæ¥çš„è¡¨é¡¹0å’Œè¡¨é¡¹10æ²¡æœ‰è¢«æ·»åŠ åˆ°rvä¸Šã€‚æ‰€ä»¥è¿˜åœ¨scrapç¼“å­˜ä¸­ï¼Œè¿™ä¸¤ä¸ªscrapç¼“å­˜æ˜¯åœ¨dispatchLayout3ä¸­è¢«ç§»é™¤çš„ã€‚\nåˆ é™¤è¡¨é¡¹ notifyItemRemove(0)\ndispatchLayout1 detachAndScrapAttachedViews è°ƒç”¨äº†10æ¬¡scrapOrRecycleView ç¬¬0ä¸ªè°ƒç”¨scrapViewæ·»åŠ åˆ°attachScrapç¼“å­˜ä¸­ 1-9çš„è¡¨é¡¹ä¹Ÿæ˜¯æ·»åŠ åˆ°attachScrapç¼“å­˜ä¸­ï¼Œè¿™ä¸ªå¯ä»¥ä»traceä¸­çœ‹åˆ°ã€‚ fill å’Œupdateè¿‡ç¨‹ä¸€æ ·ï¼Œåœ¨dispatchlayout1æœ‰11æ¬¡layoutChunkï¼Œdeleteå’Œupdateçš„viewholderä¸ä½œä¸ºæ¶ˆè´¹remainingSpaceã€‚ æ¥ç€è°ƒç”¨layoutstate.nextè·å–viewholderï¼Œæ­¤æ—¶åªæœ‰ç´¢å¼•ç­‰äº10çš„æ—¶å€™ä¼šå»åˆ›å»ºviewholderã€‚æ³¨æ„äº†ï¼šæ­¤æ—¶åˆ›å»ºå®Œviewholderåï¼Œbindè¿‡ç¨‹ä¼ çš„position=9ï¼š åœ¨bindè¿‡ç¨‹ä¸­ä¼šä¼ å…¥postion=10ï¼Œè€Œæ­¤æ—¶çš„mPostponedListä¸­æœ‰ä¸€ä¸ªopæ˜¯removeç±»å‹çš„ï¼Œæ‰€ä»¥postionä¼šå‡ä¸€ï¼Œå› æ­¤å®ƒçš„postionæ˜¯9ï¼š dispatchLayout2 detachAndScrapAttachedViews æ­¤å¤„scrapOrRecyclerviewå‘ç”Ÿäº†11æ¬¡ï¼Œå› ä¸ºåœ¨dispatchLayout1åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„viewholderï¼Œ11ä¸ªviewholderéƒ½åŠ å…¥åˆ°äº†attachScrapç¼“å­˜ä¸­ã€‚ fill layoutChunkè°ƒç”¨äº†10æ¬¡ï¼š åœ¨ç¬¬ä¸€ä¸ªviewholderè·å–çš„æ—¶å€™è·å–åˆ°åŸæ¥çš„ç¬¬äºŒä¸ªè¡¨é¡¹äº†ï¼ŒåŸæ¥çš„ç¬¬ä¸€ä¸ªè¡¨é¡¹çš„positionè¢«ç½®ä¸º-1äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬0-9çš„è¡¨é¡¹éƒ½ä¸ä¼šé‡æ–°åˆ›å»ºviewholderã€‚ä¹Ÿå°±å¯¹åº”ä¸Šé¢çš„æ—¥å¿—ã€‚ ç–‘é—®ï¼š æ­¤å¤„çš„positionèµ‹å€¼è²Œä¼¼éƒ½é‡æ–°èµ‹å€¼äº†ï¼Œå› æ­¤æˆ‘ä»¬çœ‹ä¸‹æ˜¯å“ªé‡Œé‡æ–°èµ‹å€¼äº†ï¼š å½“è°ƒç”¨notifyItemRemove(0)çš„æ—¶å€™ï¼Œåœ¨dispatchlayout1è¿‡ç¨‹ä¸­ä¼šè§¦å‘offsetPositionRecordsForRemoveæ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šé€šè¿‡removeçš„itemCountæ•°é‡æ–°ç»™æ¯ä¸€ä¸ªé¡µé¢ä¸Šçš„viewhodleré‡æ–°ç»™èµ‹ä¸Špositionçš„å€¼ï¼Œæ‰€ä»¥ä¼šçœ‹åˆ°ä¸Šé¢çš„attachScrapç¼“å­˜ä¸­æœ€åä¸€ä¸ªviewholderçš„postion=-1äº†ã€‚ scrapç¼“å­˜ åœ¨fillä¹‹å‰ä¼šæŠŠé¡µé¢ä¸Šçš„viewholderå…ˆdetachæ‰ï¼Œæœ€ç»ˆä¼šè°ƒç”¨åˆ°viewgroupçš„detachViewFromParentæ–¹æ³•ï¼ŒremoveViewä¹Ÿä¼šè°ƒç”¨è¯¥æ–¹æ³•ï¼Œåªä¸è¿‡viewholderçš„detachä¸ä¼šç«‹é©¬requestLayoutã€‚æ¥ç€å°±æ˜¯è°ƒç”¨scrapViewã€‚ scrapç¼“å­˜åˆ†ä¸¤ç§ï¼Œä¸€ç§æ˜¯attachã€å¦å¤–ä¸€ç§æ˜¯changeï¼Œå¦‚æœviewholderæ˜¯å‘ç”Ÿäº†å˜åŒ–ï¼ˆnotifyItemChangeï¼‰ï¼Œåˆ™ä¼šåŠ å…¥åˆ°changeä¸­ï¼Œå¦åˆ™åŠ å…¥åˆ°attachä¸­ã€‚æ¥ç€åœ¨layoutChunkè¿‡ç¨‹ä¸­ï¼Œä¼šä»scrapç¼“å­˜ä¸­æ‰¾viewholderã€‚ åœ¨dispatchLayout3è¿‡ç¨‹ä¸­ï¼Œä¼šè°ƒç”¨layout.removeAndRecycleScrapIntæ–¹æ³•ï¼š é‡Œé¢ä¼šè°ƒç”¨recycler.clearScrapï¼š ä¼šæ¸…ç©ºscrapç¼“å­˜ã€‚ æ€»ç»“ï¼šscrapç¼“å­˜åœ¨æ¯æ¬¡layoutChildä¹‹å‰ä¼šå…ˆæŠŠé¡µé¢çš„viewholderå…ˆæ”¾åˆ°scrapç¼“å­˜ä¸­ï¼Œåœ¨dispatchLayout3çš„æ—¶å€™ï¼Œä¼šæŠŠè¯¥ç¼“å­˜æ¸…ç©ºæ‰ã€‚\nAdapter.onViewAttachedToWindow åˆšè¿›å…¥å±å¹•ä¼šè§¦å‘onViewAttachedToWindowï¼Œä»0-9éƒ½æ‰“å°äº†ã€‚ ä»traceæ¥çœ‹ï¼Œåˆæ¬¡æ¯ä¸ªviewholderéƒ½ä¼šç»å†onViewAttachedToWindowæ–¹æ³•ã€‚\nä¸‹é¢çœ‹çœ‹ä»€ä¹ˆæ—¶å€™ä¸ä¼šè°ƒç”¨onViewAttachedToWindowæ–¹æ³•ï¼Ÿ æ¯æ¬¡åœ¨layoutChunkçš„æ—¶å€™ï¼Œä»ç¼“å­˜ä¸­å»æ‹¿viewholderï¼Œå¦‚æœä»scrapç¼“å­˜ä¸­æ‹¿åˆ°äº†ï¼Œåˆ™ä¸è§¦å‘childHelperçš„addViewï¼Œä¹Ÿå°±ä¸ä¼šè§¦å‘adapter.onViewAttachedToWindowï¼›å¦‚æœå½“å‰viewçš„parentæ˜¯å½“å‰recyclerviewçš„æ—¶å€™ï¼Œä¹Ÿä¸è§¦å‘childhelperçš„addviewã€‚å¦‚æœéƒ½ä¸æ»¡è¶³åˆ™è§¦å‘adapter.onViewAttachedToWindowã€‚\næ»‘åŠ¨çš„æ—¶å€™æ˜¯å¦è§¦å‘ï¼Ÿ æ»‘åŠ¨è¿‡ç¨‹ä¸­è¡¨é¡¹ä»ä¸å¯è§åˆ°å¯è§ä¼šè§¦å‘onViewAttachedToWindowï¼Œå› ä¸ºå®ƒä¸æ˜¯ä»scrapç¼“å­˜ä¸­è·å–åˆ°çš„ï¼Œå®ƒæ˜¯ä»cacheç¼“å­˜æˆ–è€…æ˜¯recyclerpoolä¸­è·å–çš„ã€‚onViewAttachedToWindowè§¦å‘ä¸ä¸€å®šä¼šè§¦å‘oncreateViewHolderï¼Œä¹Ÿä¸ä¸€å®šä¼šè§¦å‘onBindViewholderã€‚å¦‚æœcacheç¼“å­˜å’Œpoolç¼“å­˜ä¸­éƒ½æ²¡æœ‰è¯¥viewholderï¼Œåˆ™ä¼šè§¦å‘oncreateViewHolderå’ŒonBindViewholderã€‚å¦‚cacheä¸­æœ‰ï¼Œåˆ™åªè§¦å‘onViewAttachedToWindowã€‚å¦‚æœä»poolä¸­æ‹¿åˆ°ç¼“å­˜ï¼Œåˆ™ä¼šè§¦å‘onBindViewholderå’ŒonViewAttachedToWindowã€‚\næ›´æ–°åˆ—è¡¨æ˜¯å¦ä¼šè§¦å‘ï¼Ÿ æ‹¿ä¸Šé¢æ›´æ–°è¡¨é¡¹0æ¥çœ‹ï¼Œç”±äºåœ¨dispatchLayout1(pre-layout)è¿‡ç¨‹ä¸­ä¼šåˆ›å»ºè¡¨é¡¹10ï¼Œæ‰€ä»¥ä¼šç»å†è¡¨é¡¹10çš„oncreateå’Œonbindï¼Œå¹¶ä¸”æŠŠå®ƒæ·»åŠ åˆ°rvä¸­ï¼Œæ‰€ä»¥ä¼šæœ‰ä¸€æ¬¡çš„è¡¨é¡¹10çš„onViewAttachedToWindowï¼Œæ¥ç€ä¼šåœ¨dispatchLayout2è¿‡ç¨‹ä¸­ä¼šåˆ›å»ºè¡¨é¡¹0ï¼ˆå› ä¸ºè¡¨é¡¹0å­˜åœ¨äº†changeScrapç¼“å­˜ä¸­ï¼‰ï¼Œæ‰€ä»¥ä¼šèµ°è¡¨é¡¹0çš„onViewAttachedToWindowã€‚\nAdapter.onViewDetachedFromWindow æ»‘åŠ¨è¿‡ç¨‹ä¸­ï¼Œåˆ’å‡ºå±å¹•çš„è¡¨é¡¹ä¼šè°ƒç”¨onViewDetachedFromWindowã€‚\nfindViewHolderForAdapterPositionå’ŒfindViewHolderForLayoutPositionåŒºåˆ«ï¼š ç»“è®ºï¼šæ­£å¸¸æƒ…å†µä¸‹adapterPostionå’ŒlayoutPositionæ˜¯ç›¸ç­‰çš„ï¼Œå½“æœ‰addã€removeã€moveçš„æ—¶å€™ä¸¤è€…æ˜¯ä¸ä¸€æ ·çš„ã€‚adapterPostionä¼šç®—ä¸Šè¦æ”¹å˜çš„è¡¨é¡¹ï¼Œæ¯”å¦‚ä¸Šé¢æˆ‘è¦åˆ é™¤ç¬¬ä¸€ä¸ªè¡¨é¡¹ï¼Œé‚£ä¹ˆæ‹¿åˆ°çš„è¡¨é¡¹å°±æ˜¯ç¬¬äºŒä¸ªã€‚è€ŒlayoutPostionæ˜¯é¡µé¢æœ€ç»ˆå‘ˆç°çš„è¡¨é¡¹ï¼Œä¸Šé¢ä¾‹å­ä¸­ç­‰åˆ°postå®Œåï¼Œæ‰ä¼šçœŸæ­£çš„åˆ é™¤æ‰ã€‚æ‰€ä»¥postï¼ˆç»˜åˆ¶åï¼‰ålayoutpositionè·å–åˆ°çš„æ˜¯åŸæ¥çš„ç¬¬äºŒä¸ªè¡¨é¡¹ã€‚\nnotifydatasetChangeé—®é¢˜ å…ˆæ˜¯æŠŠé¡µé¢ä¸Šæ‰€æœ‰çš„éƒ½detachæ‰ï¼Œç„¶ååˆèµ°äº†æ‰€æœ‰çš„viewholderçš„onbindè¿‡ç¨‹ï¼Œä»ç´¢å¼•ä¸º5çš„viewholderèµ°äº†oncreateviewholderã€‚ä¸‹é¢çœ‹ä¸‹traceï¼š layoutè¿‡ç¨‹åªèµ°äº†dispatchLayout2ï¼Œåœ¨é‡Œé¢èµ°åˆ°äº†linearlayoutManager.onLayoutChildrenï¼Œé‡Œé¢ä¼šè§¦å‘fillã€‚åœ¨fillä¹‹å‰ä¼šèµ°detaché€»è¾‘ï¼Œé‡Œé¢ä¼šåå‘éå†å¯è§çš„å­viewï¼Œå¹¶è°ƒç”¨scrapOrRecylerviewï¼š æ¯ä¸€ä¸ªå­viewå›æ”¶éƒ½èµ°äº†removeViewAt: æ­¤å¤„ç”±äºæ‰€æœ‰çš„viewholderéƒ½æ˜¯invalidçŠ¶æ€äº†ï¼Œå› ä¸ºåœ¨notifyDatasetChangeåœ¨è°ƒç”¨requestLayoutä¹‹å‰æŠŠé¡µé¢ä¸Šçš„å­viewéƒ½è®¾ç½®æˆinvalidçŠ¶æ€äº†ï¼š æ‰€ä»¥åœ¨fillä¹‹å‰éƒ½ä¼šè°ƒç”¨removeViewAtï¼Œè€Œè¯¥æ–¹æ³•ä¼šè§¦å‘onViewDetachedFromWindowï¼Œå› æ­¤å¯ä»¥çœ‹åˆ°å‰é¢æ—¥å¿—ä¸­å…ˆåå‘æ‰“å°äº†9-\u0026gt;0çš„onViewDetachedFromWindowã€‚æ¥ç€ä¼šè°ƒç”¨recycler.recycleViewHolderInternalï¼Œè¯¥æ–¹æ³•æ˜¯æŠŠviewholderåŠ å…¥åˆ°cacheæˆ–è€…æ˜¯recyclerpoolä¸­ï¼š å¦‚æœå­˜åœ¨invalidçŠ¶æ€ï¼Œåˆ™ä¼šæŠŠviewholderåŠ å…¥åˆ°poolç¼“å­˜ä¸­ï¼ŒtraceéªŒè¯ä¸‹ï¼š è€Œpoolç¼“å­˜æ˜¯5ä¸ªï¼Œå› æ­¤å…ˆæŠŠ9-\u0026gt;5å­˜åˆ°pooä¸­æ—¶ï¼Œå‘ç°poolæ»¡äº†ï¼Œåˆ™æŠŠ9ç»™ç§»é™¤æ‰ï¼Œå› æ­¤æœ€ååªå‰©ä¸‹5ä¸ªviewholderåœ¨poolä¸­ã€‚æ¥ç€åœ¨layoutChunké˜¶æ®µï¼Œä¼šä»ç¼“å­˜ä¸­æ‹¿viewholderçš„æ—¶å€™ï¼Œåªæœ‰poolä¸­5ä¸ªviewholdçš„ç¼“å­˜ï¼Œå–å®Œä¸€ä¸ªremoveæ‰ä¸€ä¸ªï¼Œå½“ç´¢å¼•ä¸º5çš„æ—¶å€™ï¼Œpoolä¸­å·²ç»æ‹¿å®Œäº†ï¼Œå› æ­¤5-9ä¼šå»åˆ›å»ºviewholderã€‚\nå‚è€ƒï¼š\nRecyclerView ç¼“å­˜æœºåˆ¶ | å¦‚ä½•å¤ç”¨è¡¨é¡¹ï¼Ÿ RecyclerView ç¼“å­˜æœºåˆ¶ | å›æ”¶äº›ä»€ä¹ˆï¼Ÿ RecyclerView ç¼“å­˜æœºåˆ¶ | å›æ”¶åˆ°å“ªå»ï¼Ÿ RecyclerViewç¼“å­˜æœºåˆ¶ | scrap view çš„ç”Ÿå‘½å‘¨æœŸ ","date":"2025-01-02T00:00:00Z","permalink":"http://xiangcman.xyz/p/recyclerview%E6%BA%90%E7%A0%81%E8%B5%B0%E8%AF%BB/","title":"RecyclerViewæºç èµ°è¯»"},{"content":"suspendCoroutine åœ¨androidä¸­æ— å¤„ä¸åœ¨è·å–viewçš„å®½é«˜ï¼Œè€Œè·å–å®½é«˜æ˜¯éœ€è¦åœ¨viewç»˜åˆ¶å®Œåæ‰èƒ½è·å–ï¼Œæ‰€ä»¥è¿™æ˜¯ä¸€ä¸ªæ—¶æœºé—®é¢˜ï¼Œé€šå¸¸é€šè¿‡view.postæ¥è·å–ï¼Œé‚£ä¹ˆç”¨åç¨‹å¦‚ä½•å½¢å¦‚åŒæ­¥è·å–å®½é«˜å‘¢ï¼Ÿä¸‹é¢æ¥è¯•è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 GlobalScope.launch { val wh = getViewWh(view) Log.d(TAG, \u0026#34;width:${wh.first}\u0026#34;) Log.d(TAG, \u0026#34;height:${wh.second}\u0026#34;) } Log.d(TAG, \u0026#34;outer coroutine\u0026#34;) private suspend fun getViewWh(view: View) = suspendCoroutine\u0026lt;Pair\u0026lt;Int, Int\u0026gt;\u0026gt; { continuation -\u0026gt; view.post { val width = view.width val height = view.height continuation.resume(Pair(width, height)) } } æ—¥å¿—å¦‚ä¸‹ï¼š\n1 2 3 11:00:57.708 D outer coroutine 11:00:57.810 D width:1080 11:00:57.810 D height:2206 ä½¿ç”¨äº†suspendCoroutineæ–¹æ³•ï¼Œæ–¹æ³•çš„è¿”å›å€¼ï¼Œæ˜¯suspendCoroutineæŒ‡å®šçš„æ³›å‹ã€‚ å¯ä»¥çœ‹åˆ°æ—¥å¿—æ­£å¸¸è·å–ï¼Œä¸‹é¢æ¥çœ‹çœ‹å­—èŠ‚ç æ˜¯å¦‚ä½•å®ç°çš„ï¼š launchå¯åŠ¨çš„æ—¶å€™ï¼Œå†…éƒ¨çš„åç¨‹ä»£ç å—ç¼–è¯‘ç»“æœæ˜¯SuspendCoroutineActivity$onCreate$1ï¼š è°ƒç”¨äº†SuspendCoroutineActivityçš„é™æ€æ–¹æ³•access$getViewWhï¼š\né™æ€æ–¹æ³•æ˜¯ç›´æ¥è°ƒç”¨äº†æˆå‘˜æ–¹æ³•getViewWhï¼Œå®ƒæ˜¯æœ¬æ¬¡çš„é‡è¦å®ç°ï¼š\nä¼ è¿›æ¥çš„Continuationå¯¹åº”äº†SuspendCoroutineActivity$onCreate$1ï¼Œå®ƒæ˜¯ä¼ ç»™äº†SafeContinuationï¼Œæ­¤å¤„æ³¨æ„åˆ°è°ƒç”¨äº†continuationçš„interceptedæ–¹æ³•ï¼Œå®ƒæ˜¯continuationçš„æ‰©å±•æ–¹æ³•ï¼Œå®ƒæ˜¯åœ¨continuationImplä¸­å®ç°äº†ï¼Œå®ƒå®é™…æ˜¯çœ‹contextä¸­æ˜¯å¦æœ‰dispatcherï¼Œè¿™å—åœ¨åç¨‹åˆ‡æ¢çº¿ç¨‹ä¸­è®²è¿‡ï¼Œå®ƒå®é™…æ˜¯ç”Ÿæˆäº†ä¸€ä¸ªCoroutineDispatcherã€‚\næ¥ç€çœ‹åˆè°ƒç”¨äº†SuspendCoroutineActivity$getViewWh$2$1è¿™ä¸ªRunnableå¯¹è±¡ï¼Œå¹¶æŠŠSafeContinuationä¼ è¿›å»äº†ï¼š æ­¤å¤„çš„Runnableå°±å¯¹åº”äº†postä¸­çš„ä»£ç å—ï¼Œæœ€ç»ˆåœ¨runæ–¹æ³•ä¸­è°ƒç”¨äº†continuationçš„resumeWithæ–¹æ³•ï¼Œå¹¶æŠŠå®½é«˜å›è°ƒå‡ºå»äº†ã€‚æ­¤å¤„çš„continuationæ˜¯SafeContinuationï¼Œçœ‹ä¸‹å®ƒçš„resumeWithæ–¹æ³•ï¼š æ­¤å¤„çš„resulté»˜è®¤å€¼æ˜¯UNDECIDEDï¼š ç”±äºé»˜è®¤å€¼æ˜¯UNDECIDEDï¼Œåœ¨ä¸Šé¢getViewWhä¸­å…ˆè°ƒç”¨äº†safeContinuationçš„getOrThrowæ–¹æ³•ï¼š æ‰€ä»¥ä¼šç»™resultè®¾ç½®ä¸Šäº†COROUTINE_SUSPENDEDæ ‡è®°ï¼Œæ‰€ä»¥åœ¨ä¸Šé¢çš„suspendLambdaçš„invokeSuspendæ–¹æ³•ä¸­èƒ½è¢«æŒ‚èµ·ï¼Œç­‰åˆ°æ‰§è¡ŒsafeContinuationçš„resumeWithçš„æ—¶å€™ï¼Œä¸Šé¢çš„suspendLambdaå°±æ¢å¤äº†ã€‚æœ€ç»ˆè·å–åˆ°ç»“æœï¼Œæ•´ä¸ªæµç¨‹å°±ç»“æŸã€‚\nsuspendCoroutineçš„å›è°ƒä¸­è¿˜æœ‰ä¸€ä¸ªresumeWithExceptionæ–¹æ³•ï¼Œç”¨äºè¿”å›å¤±è´¥çš„ç»“æœï¼Œå¦‚æœè¿”å›å¤±è´¥çš„æ—¶å€™ï¼Œéœ€è¦æ•æ‰å¼‚å¸¸ã€‚\nsuspendCancellableCoroutine å®ƒå’ŒsuspendCoroutineåŒºåˆ«æ˜¯å›è°ƒä¸­æ˜¯ä¸€ä¸ªCancellableContinuationImplï¼Œå®ƒæä¾›äº†cancelæ–¹æ³•ï¼Œå½“cancelçš„æ—¶å€™ï¼Œç¨‹åºä¸ä¼šå´©æºƒã€‚å®ƒä¼šæŠŠcancelçš„ç»“æœåˆ†å‘åˆ°delegateä¸­ï¼Œæ­¤å¤„çš„delegateå…¶å®å°±æ˜¯å¯¹åº”äº†GlobalScope.launchå¯åŠ¨æ—¶çš„suspendLambdaï¼Œæœ€åå®ƒä¼šåˆ†å‘åˆ°çˆ¶jobä¸­ã€‚çœ‹ä¸‹CancellableContinuationImplçš„cancelæ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 public override fun cancel(cause: Throwable?): Boolean { _state.loop { state -\u0026gt; if (state !is NotCompleted) return false // false if already complete or cancelling // Active -- update to final state val update = CancelledContinuation(this, cause, handled = state is CancelHandler || state is Segment\u0026lt;*\u0026gt;) if (!_state.compareAndSet(state, update)) return@loop // retry on cas failure // Invoke cancel handler if it was present when (state) { is CancelHandler -\u0026gt; callCancelHandler(state, cause) is Segment\u0026lt;*\u0026gt; -\u0026gt; callSegmentOnCancellation(state, cause) } // Complete state update detachChildIfNonResuable() dispatchResume(resumeMode) // no need for additional cancellation checks return true } } æ­¤å¤„ä¼šæ„é€ å‡ºCancelledContinuationï¼Œå®ƒæ˜¯CompletedExceptionallyå¯¹è±¡ï¼Œè¿™ä¸ªå…¶å®å°±æ˜¯åç¨‹å¼‚å¸¸çš„æ‰©å±•ç±»ï¼Œæœ€ç»ˆæŠŠè¯¥å¯¹è±¡è®¾ç½®åˆ°CancellableContinuationImplçš„stateä¸Šã€‚ ä¸€è·¯è·Ÿåˆ°DispatchedTaskçš„dispatchæ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 internal fun \u0026lt;T\u0026gt; DispatchedTask\u0026lt;T\u0026gt;.dispatch(mode: Int) { assert { mode != MODE_UNINITIALIZED } // invalid mode value for this method val delegate = this.delegate val undispatched = mode == MODE_UNDISPATCHED if (!undispatched \u0026amp;\u0026amp; delegate is DispatchedContinuation\u0026lt;*\u0026gt; \u0026amp;\u0026amp; mode.isCancellableMode == resumeMode.isCancellableMode) { // dispatch directly using this instance\u0026#39;s Runnable implementation val dispatcher = delegate.dispatcher val context = delegate.context if (dispatcher.isDispatchNeeded(context)) { dispatcher.dispatch(context, this) } else { resumeUnconfined() } } else { // delegate is coming from 3rd-party interceptor implementation (and does not support cancellation) // or undispatched mode was requested resume(delegate, undispatched) } } æ­¤å¤„ä¼šèµ°dispatcher.dispatché€»è¾‘ï¼Œå› ä¸ºä¸Šé¢çš„GlobalScope.launchå…¶å®åˆ›å»ºçš„dispatcheræ˜¯ä¸€ä¸ªDispatcher.Defaultç±»å‹çš„ã€‚DispatchedTaskæ˜¯ä¸€ä¸ªrunnableæ¥å£ï¼Œçœ‹ä¸‹å®ƒçš„runæ–¹æ³•ï¼š æœ€ç»ˆä¹Ÿæ˜¯é€šè¿‡continuationçš„resumeWithExceptionæ–¹æ³•å›è°ƒå‡ºå»ï¼Œç„¶åäº¤ç»™äº†çˆ¶jobå»å¤„ç†ï¼Œæ­¤æ—¶çš„exceptionæ˜¯ä¸€ä¸ªCancellationExceptionï¼Œå…¶å®ä¸Šé¢çš„suspendCoroutineä¹Ÿå¯ä»¥é€šè¿‡resumeWithExceptionå›è°ƒä¸€ä¸ªCancellationExceptionï¼Œç¨‹åºä¹Ÿä¸ä¼šå´©æºƒã€‚\nå‚è€ƒï¼šhttps://juejin.cn/post/7121517604644061192\n","date":"2024-12-30T00:00:00Z","permalink":"http://xiangcman.xyz/p/%E5%8D%8F%E7%A8%8B%E5%A6%82%E4%BD%95%E4%BC%98%E9%9B%85%E7%9A%84%E5%A4%84%E7%90%86%E5%BC%82%E6%AD%A5%E5%9B%9E%E8%B0%83/","title":"åç¨‹å¦‚ä½•ä¼˜é›…çš„å¤„ç†å¼‚æ­¥å›è°ƒ"},{"content":"æœ¬æ–‡é€šè¿‡æ¡ˆä¾‹æ¥ç†Ÿæ‚‰å­åç¨‹åˆ°çˆ¶åç¨‹ä¹‹é—´çš„å¼‚å¸¸æ˜¯å¦‚ä½•å¤„ç†çš„ã€‚\næ¡ˆä¾‹ä¸€ï¼šå­åç¨‹å¼‚å¸¸ï¼Œçˆ¶åç¨‹handleræ•æ‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 private fun demo1() { val handler = CoroutineExceptionHandler { coroutineContext, throwable -\u0026gt; Log.d(TAG, \u0026#34;onCreate: CoroutineExceptionHandler:${throwable.message}\u0026#34;) } GlobalScope.launch(handler) { Log.d(TAG, \u0026#34;onCreate: parentJob start\u0026#34;) withContext(Dispatchers.IO) { throw RuntimeException(\u0026#34;runtime exception\u0026#34;) delay(1000) Log.d(TAG, \u0026#34;onCreate: withContext end\u0026#34;) } Log.d(TAG, \u0026#34;onCreate: parentJob end\u0026#34;) } } å…ˆä¸Šæ—¥å¿—ï¼š\n1 2 com.example.coroutinescopedemo D onCreate: parentJob start com.example.coroutinescopedemo D onCreate: CoroutineExceptionHandler:withContext runtime exception ç»“è®ºï¼šå¼‚å¸¸èƒ½è¢«launchæŒ‡å®šçš„handleræ‰€æ•æ‰ã€‚\nåˆ†æï¼š launchå¯åŠ¨çš„åç¨‹ç”¨åˆ°çš„coroutineScopeæ˜¯ä¸€ä¸ªStandaloneCoroutineï¼ŒwithContextå¯åŠ¨çš„åç¨‹å¯¹åº”çš„coroutineScopeæ˜¯ä¸€ä¸ªDispatchedCoroutineï¼ˆå› ä¸ºçˆ¶contextå’Œå­contextçš„dispatcherä¸ä¸€æ ·ï¼Œæ‰€ä»¥åˆ›å»ºçš„æ˜¯DispatchedCoroutineï¼‰ã€‚ åœ¨withContextä¸­å‘ç”Ÿå¼‚å¸¸çš„æ—¶å€™ï¼Œé¦–å…ˆä¼šå›è°ƒåˆ°DispatchedCoroutineçš„resumeWithï¼Œæœ€ç»ˆä¼šèµ°åˆ°finalizeFinishingStateæ–¹æ³•ï¼Œè¯¥æ–¹æ³•é‡Œé¢ä¼šåˆ¤æ–­æ˜¯å¦å­˜åœ¨å¼‚å¸¸ï¼Œå¦‚æœæœ‰å¼‚å¸¸ä¼šè°ƒç”¨cancelParentæ–¹æ³•ï¼š\nå¯ä»¥çœ‹åˆ°å¦‚æœisScopedCoroutineä¸ºtrueçš„æ—¶å€™ï¼ŒcancelParentç›´æ¥è¿”å›trueï¼Œå¦‚æœè¿”å›trueï¼Œé‚£ä¹ˆå°±ä¸è§¦å‘è‡ªå·±çš„ä¸Šé¢çš„handleJobExceptionï¼Œä¹Ÿå°±æ˜¯æŠŠå¼‚å¸¸ç»§ç»­å¾€ä¸ŠæŠ›äº†ã€‚ä¾‹å­ä¸­ä¹Ÿå°±æ˜¯launchå¯¹åº”çš„StandaloneCoroutineã€‚è€Œåœ¨StandaloneCoroutineä¸­ä¸ä¼šå»cancelParentï¼Œå› ä¸ºå®ƒçš„parentæ˜¯nullï¼Œæ‰€ä»¥ä¼šæŠŠå¼‚å¸¸äº¤ç»™äº†handleJobExceptionäº†ï¼Œæ‰€ä»¥ä¸Šé¢çš„launchä¸­ä¼ å…¥çš„CoroutineExceptionHandlerèƒ½æ•è·åˆ°è¯¥å¼‚å¸¸ã€‚\næ€»ç»“ï¼šå¦‚æœå­jobä¸­åœ¨å¤„ç†å¼‚å¸¸çš„æ—¶å€™ï¼ŒcancelParentä¸­å¦‚æœisScopedCoroutineä¸ºtrueçš„æ—¶å€™ï¼Œåˆ™ä¸è§¦å‘è‡ªå·±çš„handleJobExceptionï¼Œä¹Ÿå°±æ˜¯æŠŠå¼‚å¸¸äº¤ç»™äº†çˆ¶jobï¼Œå¦‚æœçˆ¶jobä¸å¤„ç†è¯¥å¼‚å¸¸ï¼Œåˆ™ä¼šç¨‹åºå´©æºƒã€‚\næ¡ˆä¾‹äºŒï¼šå­åç¨‹å¼‚å¸¸ï¼Œå­åç¨‹try-catchæ•æ‰ ä¸Šé¢ä»£ç å¦‚æœæŠŠwithContextä¸­çš„å¼‚å¸¸é€šè¿‡try-catchä½ï¼Œçˆ¶jobå°±æ”¶ä¸åˆ°è¯¥å¼‚å¸¸äº†ï¼š å­åç¨‹æŠŠå¼‚å¸¸catchä½åï¼Œçˆ¶åç¨‹çš„handleræ•æ‰ä¸åˆ°å¼‚å¸¸ï¼Œå¹¶ä¸”çˆ¶åç¨‹çš„invokeOnCompletionæ”¶ä¸åˆ°å¼‚å¸¸ï¼Œçˆ¶åç¨‹ä¹‹åçš„ä»£ç ä¹Ÿèƒ½æ­£å¸¸æ‰§è¡Œã€‚å› ä¸ºåœ¨å­åç¨‹å¯¹åº”çš„SuspendLambdaä¸­çš„invokeSuspendæ–¹æ³•ç»™try-catchä½ï¼Œä¸ä¼šæŠŠå¼‚å¸¸å¾€ä¸ŠæŠ›ã€‚\næ¡ˆä¾‹ä¸‰ï¼šå­åç¨‹çš„handleræ— æ³•æ•æ‰ å­åç¨‹ç»™contextä¼ é€’coroutineExceptionHandlerï¼š å­åç¨‹æŠ›äº†å¼‚å¸¸ï¼Œç„¶åå­åç¨‹ä¹Ÿä¼ äº†CoroutineExceptionHandlerï¼Œä½†æ˜¯å­åç¨‹çš„CoroutineExceptionHandlerä¸èµ·ä½œç”¨ï¼Œè¿˜æ˜¯æŠŠå¼‚å¸¸ä¼ ç»™äº†çˆ¶åç¨‹ã€‚å¹¶ä¸”çˆ¶åç¨‹çš„invokeOnCompletionæ”¶åˆ°äº†å¼‚å¸¸å›è°ƒï¼Œè€Œä¸”å‘ç°çˆ¶åç¨‹çš„invokeSuspendæ–¹æ³•ä¹Ÿæ²¡èµ°å®Œï¼Œæ‰€ä»¥onCreate: parentJob endæ²¡æœ‰è¾“å‡ºã€‚\nåˆ†æï¼šå‰é¢å·²ç»åˆ†æè¿‡withContextå¼€å¯çš„åç¨‹å¯¹åº”çš„coroutineScopeæ˜¯ä¸€ä¸ªDispatchedCoroutineé‡å†™äº†isScopedCoroutine=trueï¼Œå¦‚æœå®ƒä¸ºtrueï¼ŒcancelParentæ–¹æ³•åˆ™è¿”å›trueï¼Œé‚£ä¹ˆå®ƒè‡ªå·±çš„handleJobExceptionå°±ä¸ä¼šè§¦å‘ï¼Œæ‰€ä»¥å°±ä¸ä¼šèµ°åˆ°è‡ªå·±çš„CoroutineExceptionHandlerå›è°ƒäº†ã€‚\næ¡ˆä¾‹å››ï¼šå­åç¨‹æŠ›CancellationExceptionï¼Œçˆ¶åç¨‹æ— æ³•æ•æ‰ å½“å­åç¨‹æŠ›çš„æ˜¯CancellationExceptionï¼Œçˆ¶åç¨‹æ•æ‰ä¸åˆ°è¯¥å¼‚å¸¸ï¼š æ­¤å¤„handleræ²¡æœ‰æ•æ‰åˆ°å¼‚å¸¸ï¼Œå¹¶ä¸”ç¨‹åºä¹Ÿæ²¡å´©æºƒï¼Œè¿™æ˜¯å› ä¸ºåœ¨å­åç¨‹æŠŠå¼‚å¸¸å›è°ƒç»™çˆ¶åç¨‹åï¼Œçˆ¶åç¨‹å¯¹åº”çš„scopeï¼Œä¹Ÿå°±æ˜¯StandaloneCoroutineåœ¨cancelParentä¸­åˆ¤æ–­æ˜¯CancelationExceptionï¼Œå®ƒç›´æ¥è¿”å›trueï¼Œæ‰€ä»¥ä¸ä¼šè°ƒç”¨handleJobExceptionæ–¹æ³•ï¼Œè€Œå‘å¤–æŠ›å¼‚å¸¸çš„æ­£æ˜¯è¯¥æ–¹æ³•ã€‚æ‰€ä»¥å½“å­åç¨‹æŠ›å‡ºCancellationExceptionæ—¶å€™ä¸ä¼šä½¿çˆ¶åç¨‹å´©æºƒã€‚\næ¡ˆä¾‹äº”ï¼šå­åç¨‹æŠ›å¼‚å¸¸ï¼Œçˆ¶åç¨‹åˆ†å‘åˆ°å…¶å®ƒå­åç¨‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 private fun demo2() { val handler = CoroutineExceptionHandler { coroutineContext, throwable -\u0026gt; Log.d(TAG, \u0026#34;handler:${throwable.message}\u0026#34;) } val job = Job() val coroutineScope = CoroutineScope(job + handler) val job1 = coroutineScope.launch { delay(100) Log.d(TAG, \u0026#34;job1 end\u0026#34;) throw RuntimeException(\u0026#34;runtime exception\u0026#34;) } job1.invokeOnCompletion { Log.d(TAG, \u0026#34;job1 invokeOnCompletion:${it?.message}\u0026#34;) } val job2 = coroutineScope.launch { delay(200) Log.d(TAG, \u0026#34;job2 end\u0026#34;) } job2.invokeOnCompletion { Log.d(TAG, \u0026#34;job2 invokeOnCompletion:${it?.message}\u0026#34;) } val job3 = coroutineScope.launch { delay(300) Log.d(TAG, \u0026#34;job3 end\u0026#34;) } job3.invokeOnCompletion { Log.d(TAG, \u0026#34;job3 invokeOnCompletion:${it?.javaClass?.simpleName}\u0026#34;) Log.d(TAG, \u0026#34;job3 invokeOnCompletion:${it?.message}\u0026#34;) } } æ—¥å¿—å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 com.example.coroutinescopedemo D job1 end com.example.coroutinescopedemo D job2 invokeOnCompletion:Parent job is Cancelling com.example.coroutinescopedemo D job3 invokeOnCompletion:JobCancellationException com.example.coroutinescopedemo D job3 invokeOnCompletion:Parent job is Cancelling com.example.coroutinescopedemo D handler:runtime exception com.example.coroutinescopedemo D job1 invokeOnCompletion:runtime exception æ•°æ®ç»“æ„:çˆ¶åç¨‹çš„jobå¯åŠ¨äº†ä¸‰ä¸ªå­åç¨‹ï¼Œåœ¨job1ä¸­æŠ›å‡ºå¼‚å¸¸ï¼Œjob2å’Œjob3æ”¶åˆ°äº†JobCancellationExceptionã€‚å…¶ä¸­çˆ¶jobæ˜¯ä¸€ä¸ªJobImplå¯¹è±¡ï¼Œåœ¨æ¯ä¸ªå­åç¨‹å¯åŠ¨è¿‡ç¨‹ä¸­éƒ½ä¼šåˆ›å»ºä¸€ä¸ªChildHandleNodeå¯¹è±¡ï¼Œå…¶ä¸­jobæŒ‡å‘äº†çˆ¶Jobï¼Œä¹Ÿå°±æ˜¯JobImplï¼ŒchildJobæŒ‡å‘äº†å½“å‰å­jobï¼Œä¹Ÿå°±æ˜¯StandaloneCoroutineï¼Œæœ€ååœ¨å­Jobä¸­é€šè¿‡parentHandleæŒ‡å‘äº†çˆ¶jobï¼ˆé€šè¿‡ChildHandleNodeçš„parentæŒ‡å‘äº†çˆ¶jobï¼‰ï¼ŒstateæŒ‡å‘äº†InvokeOnCompletionå¯¹è±¡(æ˜¯é€šè¿‡invokeOnCompletionæ·»åŠ çš„)ã€‚çˆ¶jobä¸­é€šè¿‡stateæŒ‡å‘äº†ä¸€ä¸ªNodeListï¼Œæ¯ä¸€ä¸ªnextèŠ‚ç‚¹æŒ‡å‘äº†ä¸‰ä¸ªå­jobï¼ˆåˆ†åˆ«éƒ½æ˜¯ChildHandleNodeå¯¹è±¡ï¼‰ã€‚åœ¨ä¸‰ä¸ªå­jobä¸­é€šè¿‡delayå®ç°æŒ‚èµ·ï¼Œåœ¨delayçš„æ—¶å€™ï¼Œä¼šåˆ›å»ºCancellableContinuationImplï¼Œå®ƒæ˜¯ç”¨æ¥ç›‘å¬jobå–æ¶ˆçš„taskï¼Œå®ƒä¼šé€šè¿‡ChildContinuationè¿›è¡ŒæŒæœ‰ï¼Œæœ€åChildContinuationæ·»åŠ åˆ°å½“å‰å­jobçš„stateä¸Šï¼Œæ‰€ä»¥ç›®å‰æ¯ä¸€ä¸ªå­jobçš„stateä¸Šæœ‰ä¸¤ä¸ªå¯¹è±¡ï¼Œä¸€ä¸ªæ˜¯InvokeOnCompletionå¯¹è±¡ï¼Œä¸€ä¸ªæ˜¯ChildContinuationï¼Œç»„åˆæˆä¸€ä¸ªNodeListå¯¹è±¡ã€‚\nå¼‚å¸¸å¤„ç†:å½“ç¬¬ä¸€ä¸ªjobå‘ç”Ÿå¼‚å¸¸åï¼Œå…ˆå°†è‡ªå·±çš„stateè®¾ç½®ä¸ŠFinishingçŠ¶æ€ï¼Œå¹¶ä¸”ç»™Finishæ·»åŠ å¼‚å¸¸ä¿¡æ¯ï¼Œæ¥ç€ä¼šè°ƒç”¨åˆ°job1çš„cancelParenté€»è¾‘ï¼Œè¯¥æ–¹æ³•ä¸­ä¼šè°ƒç”¨åˆ°parentHandleçš„childCancelledé€»è¾‘ï¼Œå®ƒæ˜¯ä¸€ä¸ªChildHandleNodeå¯¹è±¡ï¼Œåœ¨å®ƒçš„childCancelledæ–¹æ³•ä¸­ï¼Œä¼šè§¦å‘çˆ¶jobçš„childCancelledæ–¹æ³•ï¼Œæœ€ç»ˆä¼šæ¥åˆ°çˆ¶jobçš„cancelImplæ–¹æ³•ã€‚åœ¨cancelImplä¸­ä¼šè§¦å‘cancelMakeCompleting-\u0026gt;tryMakeCompleting-\u0026gt;tryMakeCompletingSlowPathï¼Œåœ¨tryMakeCompletingSlowPathé‡Œé¢ä¹Ÿä¼šç»™çˆ¶jobè®¾ç½®ä¸ŠFinishingçŠ¶æ€ï¼ŒåŒæ—¶ä¼šè§¦å‘æ¯ä¸€ä¸ªChildHandleNodeå¯¹è±¡çš„invokeï¼Œåœ¨invokeé‡Œé¢åˆä¼šè§¦å‘childJobçš„parentCancelledæ–¹æ³•ã€‚æ­¤æ—¶åˆä¼šæ¥åˆ°æ¯ä¸ªå­jobçš„cancelImplæ–¹æ³•ï¼Œåœ¨é‡Œé¢ä¼šè§¦å‘makeCancellingæ–¹æ³•ã€‚ç”±äºç¬¬ä¸€ä¸ªjobçš„stateæ˜¯FinishingçŠ¶æ€ï¼Œæ‰€ä»¥ä¼šç»™stateæ·»åŠ ä¸€ä¸ªJobCancellationExceptionå¼‚å¸¸ï¼Œä½†æ˜¯ä¸ä¼šè¦†ç›–åŸå§‹å¼‚å¸¸ã€‚åœ¨job2å’Œjob3è§¦å‘åˆ°cancelImplæ–¹æ³•æ—¶å€™ï¼Œåœ¨makeCancellingé‡Œé¢ï¼Œç”±äºjob2å’Œjob3çš„stateæ˜¯ä¸€ä¸ªIncompleteå¯¹è±¡ï¼Œæ‰€ä»¥ä¼šåˆ›å»ºJobCancellationExceptionå¼‚å¸¸ï¼Œæ¥ç€è°ƒç”¨äº†tryMakeCancellingæ–¹æ³•ï¼Œåœ¨è¯¥æ–¹æ³•é‡Œé¢ä¼šç»™job2å’Œjob3çš„stateè®¾ç½®ä¸ŠFinishingçŠ¶æ€ï¼Œå¹¶ä¸”ä¼šè§¦å‘å‰é¢åˆ›å»ºçš„ChildContinuationçš„invokeæ–¹æ³•ï¼Œåœ¨ChildContinuationçš„invokeä¸­ä¼šè§¦å‘CancellableContinuationImplçš„parentCancelledæ–¹æ³•ï¼Œåœ¨é‡Œé¢æœ€ç»ˆä¼šè§¦å‘åˆ°SuspnedLambdaçš„resumeWithï¼Œæœ€åä¼šè§¦å‘job2å’Œjob3çš„resumeæ–¹æ³•ï¼Œæœ€ç»ˆä¼šæŠŠJobCancellationExceptionå¼‚å¸¸åˆ†å‘åˆ°å½“å‰stateçš„InvokeOnCompletionä¸Šã€‚åˆ†å‘å®Œå­Jobçš„cancelImplåï¼Œç»§ç»­å›åˆ°çˆ¶Jobçš„tryMakeCompletingSlowPathæµç¨‹ä¸­ï¼Œç»™å½“å‰å‡ºç°å¼‚å¸¸çš„jobçš„stateæ·»åŠ ä¸€ä¸ªChildCompletionå¯¹è±¡å¹¶ç»“æŸäº†tryMakeCompletingSlowPathæµç¨‹ã€‚å½“job1çš„cancelParenté€»è¾‘éƒ½å¤„ç†å®Œåï¼Œä¹Ÿå°±æ˜¯åœ¨finalizeFinishingStateæ–¹æ³•ä¸­ã€‚æ­¤æ—¶çš„cancelParentè¿”å›falseï¼Œæ˜¯å› ä¸ºè°ƒç”¨çˆ¶jobçš„childCancelledæ—¶å€™handlesExceptionå˜é‡ä¸ºfalseï¼Œæ‰€ä»¥cancelParentæ–¹æ³•è¿”å›falseï¼Œé‚£ä¹ˆæ­¤æ—¶ä¼šå›è°ƒhandleJobExceptionæ–¹æ³•ï¼Œå›è°ƒåˆ°CoroutineExceptionHandlerï¼Œæœ€åç»™stateè®¾ç½®ä¸ŠCompletedExceptionallyã€‚æ¥ç€ä¼šè§¦å‘è‡ªå·±stateçš„NodeListä¸Šçš„JobNodeï¼Œä¸€ä¸ªæ˜¯InvokeOnCompletionï¼Œä¸€ä¸ªæ˜¯ChildCompletionï¼Œåœ¨ChildCompletionä¸­ä¼šè§¦å‘çˆ¶jobçš„continueCompletingæ–¹æ³•ï¼Œåœ¨è¯¥æ–¹æ³•ä¸­ä¼šè§¦å‘finalizeFinishingStateé€»è¾‘ï¼Œåœ¨è¯¥æ–¹æ³•é‡Œé¢ä¼šå°†å¼‚å¸¸ç»™åˆ°CoroutineExceptionHandlerå¤„ç†ï¼Œä½†æ˜¯æ­¤æ—¶çš„çˆ¶jobï¼ˆJobImplï¼‰æ²¡æœ‰é‡å†™handleJobExceptionæ–¹æ³•ï¼Œæ‰€ä»¥ä¸ä¼šåˆ†å‘åˆ°CoroutineExceptionHandlerã€‚æœ€åå°†stateè®¾ç½®ä¸ºCompletedExceptionallyï¼Œåˆ°æ­¤æ•´ä¸ªæµç¨‹ç»“æŸã€‚\næ‰€ä»¥ä¸Šé¢çš„æ—¥å¿—å…ˆæ˜¯job2å’Œjob3çš„InvokeOnCompletionæ”¶åˆ°JobCancellationExceptionå¼‚å¸¸ï¼Œæ¥ç€æ˜¯contextä¸­çš„CoroutineExceptionHandleræ”¶åˆ°åŸå§‹å¼‚å¸¸ï¼Œæœ€åæ˜¯job1çš„InvokeOnCompletionæ”¶åˆ°åŸå§‹å¼‚å¸¸ã€‚\nä¸Šé¢æ¶‰åŠåˆ°å‡ ä¸ªå…³é”®çš„ç±»ï¼ŒæŠŠå…³é”®ç±»çš„ç»“æ„æ¢³ç†ä¸‹ï¼š æ¡ˆä¾‹å…­ï¼šçˆ¶Jobä½¿ç”¨SupervisorJobï¼Œå¼‚å¸¸ä¸åˆ†å‘åˆ°å…¶å®ƒå­åç¨‹ï¼Œå¼‚å¸¸åç¨‹è‡ªå·±å¤„ç†å¼‚å¸¸ æŠŠæ¡ˆä¾‹äº”ä¸­çš„Job()æ¢æˆSupervisorJob()\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 private fun demo3() { val handler = CoroutineExceptionHandler { coroutineContext, throwable -\u0026gt; Log.d(TAG, \u0026#34;handler:${throwable.message}\u0026#34;) } val coroutineScope = CoroutineScope(SupervisorJob() + handler) val job1 = coroutineScope.launch { delay(100) Log.d(TAG, \u0026#34;job1 end\u0026#34;) throw RuntimeException(\u0026#34;runtime exception\u0026#34;) } job1.invokeOnCompletion { Log.d(TAG, \u0026#34;job1 invokeOnCompletion:${it?.message}\u0026#34;) } val job2 = coroutineScope.launch { delay(200) Log.d(TAG, \u0026#34;job2 end\u0026#34;) } job2.invokeOnCompletion { Log.d(TAG, \u0026#34;job2 invokeOnCompletion:${it?.message}\u0026#34;) } val job3 = coroutineScope.launch { delay(300) Log.d(TAG, \u0026#34;job3 end\u0026#34;) } job3.invokeOnCompletion { Log.d(TAG, \u0026#34;job3 invokeOnCompletion:${it?.javaClass?.simpleName}\u0026#34;) Log.d(TAG, \u0026#34;job3 invokeOnCompletion:${it?.message}\u0026#34;) } } åªæ˜¯æ¢äº†ä¸ªjobï¼Œjob1è¿˜æ˜¯ä¸€æ ·æ”¶åˆ°äº†åŸå§‹å¼‚å¸¸ï¼Œjob2å’Œjob3æ­£å¸¸æ‰§è¡Œï¼Œå¹¶èƒ½æ‰§è¡Œå®Œã€‚æŒ‰ç…§ä¸Šé¢åˆ†æï¼Œå½“job1å‘ç”Ÿå¼‚å¸¸çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨åˆ°cancelParentï¼Œå®ƒä¼šåˆ†å‘åˆ°çˆ¶jobçš„childCancelledæ–¹æ³•ï¼Œè€ŒSupervisorJobé‡å†™äº†è¯¥æ–¹æ³•ç›´æ¥è¿”å›falseã€‚æ‰€ä»¥å¼‚å¸¸ä¸ä¼šåˆ†å‘åˆ°å­åç¨‹ä¸­ï¼Œå½“job1çš„cancelParentè¿”å›falseçš„æ—¶å€™ï¼Œä¼šæ‰§è¡Œåˆ°handleJobExceptionï¼Œè€Œjob1ä½¿ç”¨çš„contextä¸­çš„CoroutineExceptionHandleræ˜¯ä½¿ç”¨çš„çˆ¶jobä¸­æŒ‡å®šçš„CoroutineExceptionHandlerã€‚å› ä¸ºcontextæ˜¯pluså åŠ çš„æ–¹å¼ã€‚æ‰€ä»¥æœ€åhandlerä¸­æ”¶åˆ°äº†å¼‚å¸¸ã€‚\nä»¥ä¸‹çš„æ¡ˆä¾‹æ¥è‡ªäºhttps://juejin.cn/post/7049537608262615070\næ¡ˆä¾‹ä¸ƒï¼štry-catchåœ¨éå¼‚å¸¸åç¨‹ä½ç½®ï¼Œæ— æ³•æ•æ‰ ç»“æœï¼štry-catchç«Ÿç„¶æ•è·ä¸ä½ï¼Œç¨‹åºç›´æ¥æŠ›å¼‚å¸¸äº†\nå¦‚æœæƒ³è¦è°ƒè¯•çš„è¯ï¼Œå¯ä»¥ç»™åç¨‹æ‹¼æ¥CoroutineNameï¼Œè¿™æ ·åœ¨è°ƒè¯•çš„æ—¶å€™çŸ¥é“jobå¯¹åº”çš„contextä¸­CoroutineNameã€‚ä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 private fun demo7() { val scope = CoroutineScope(Dispatchers.Main + Job()) scope.launch(CoroutineName(\u0026#34;job1\u0026#34;)) { Log.d(TAG, \u0026#34;scope1:$this\u0026#34;) try { thirdApi(this) } catch (e: Exception) { Log.d(TAG, \u0026#34;demo7: e:${e.message}\u0026#34;) } } } private fun thirdApi(coroutineScope: CoroutineScope) { coroutineScope.launch(CoroutineName(\u0026#34;job2\u0026#34;)) { Log.d(TAG, \u0026#34;thirdApi: start\u0026#34;) delay(100) Log.d(TAG, \u0026#34;thirdApi: end\u0026#34;) throw NullPointerException(\u0026#34;null pointer exception\u0026#34;) } } æ­¤å¤„try-catchçš„ä½ç½®ä¸åœ¨å­åç¨‹çš„SuspendInvokeä½ç½®ï¼Œå®ƒæ˜¯åœ¨ä¸»åç¨‹çš„launchä½ç½®ï¼Œå…¶å®å®ƒæ˜¯åœ¨invokeSuspendä¸­è°ƒç”¨å†…éƒ¨launchçš„æ—¶å€™åŠ äº†try-catchï¼Œå¯¹åº”çš„classä»£ç å¦‚ä¸‹ï¼š\nä»å­—èŠ‚ç æ¥çœ‹ï¼Œåªæ˜¯å¯åŠ¨å­åç¨‹çš„æ—¶å€™ç»™try-catchã€‚\nç¬¬ä¸€é˜¶æ®µï¼šjob1ç»™job2çš„stateæ·»åŠ ChildCompletionç›‘å¬\njob1çš„SuspendLambdaåœ¨æ­£å¸¸æ‰§è¡ŒinvokeSuspendï¼Œæ‰§è¡Œåˆ°job1çš„æ—¶å€™ï¼Œæ¥åˆ°äº†tryMakeCompletingSlowPathæ–¹æ³•ï¼Œåœ¨è¯¥æ–¹æ³•ä¸­ä¼šç»™job2çš„stateæ·»åŠ ChildCompletionå›è°ƒ\nç¬¬äºŒé˜¶æ®µï¼šjob2è§¦å‘job1çš„childCancelled\nä»åŸç†ä¸Šåˆ†æï¼Œå½“å­job2å‘ç”Ÿå¼‚å¸¸åï¼Œåœ¨cancelParentä¸­ä¼šè°ƒç”¨job1çš„childCancelledæ–¹æ³•ï¼Œæ¥ç€è°ƒç”¨åˆ°cancelImplï¼Œç”±äºjob1æ˜¯ä¸€ä¸ªStandaloneCoroutineï¼Œæ‰€ä»¥æ¥ç€è°ƒç”¨makeCancellingï¼Œæ­¤æ—¶job1çš„stateæ˜¯ä¸€ä¸ªFinishingï¼ŒisCancellingè¿˜æ˜¯falseã€‚æ‰€ä»¥ä¼šæŠŠå¼‚å¸¸åŠ å…¥åˆ°stateä¸­ã€‚æ¥ç€è§¦å‘äº†notifyCancellingæ–¹æ³•ï¼Œåœ¨é‡Œé¢è°ƒç”¨äº†notifyHandlersã€‚\nç¬¬ä¸‰é˜¶æ®µï¼šjob1è§¦å‘job2çš„parentCancelled\nåœ¨é‡Œé¢è°ƒç”¨åˆ°ChildHandleNodeçš„invokeï¼Œç»§è€Œè§¦å‘äº†job2çš„parentCancelledæ–¹æ³•ï¼Œæ¥åˆ°äº†job2çš„cancelImplï¼Œç”±äºjob2ä¹Ÿæ˜¯ä¸€ä¸ªStandaloneCoroutineã€‚æ‰€ä»¥ä¼šè§¦å‘job2çš„makeCancellingï¼Œæ­¤æ—¶job2ä¸­çš„stateæ˜¯ä¸€ä¸ªFinishingï¼Œå¹¶ä¸”isCancellingä¸ºtrueï¼Œæ‰€ä»¥job2çš„makeCancellingç»“æŸã€‚\nç¬¬å››é˜¶æ®µï¼šjob1è§¦å‘çˆ¶jobçš„childCancelled\nç»§ç»­å›åˆ°job1çš„notifyCancellingæ–¹æ³•ï¼Œæ¥ç€è°ƒç”¨äº†cancelParentæ–¹æ³•ï¼Œåˆæ¥åˆ°äº†çˆ¶jobï¼ˆJobImplï¼‰ï¼Œä¹Ÿå°±æ˜¯çˆ¶jobçš„cancelImplï¼Œç”±äºçˆ¶jobæ˜¯ä¸€ä¸ªjobImplï¼Œæ‰€ä»¥ä¼šè°ƒç”¨cancelMakeCompletingï¼Œä¸€è·¯æ¥åˆ°äº†tryMakeCompletingSlowPathæ–¹æ³•ã€‚\nç¬¬äº”é˜¶æ®µï¼šçˆ¶jobè§¦å‘job1çš„parentCancelled åœ¨è¯¥æ–¹æ³•ä¸­æ¥ç€è§¦å‘äº†çˆ¶jobçš„ChildHandleNodeçš„invokeï¼Œä¹Ÿå°±æ¥åˆ°äº†job1çš„parentCancelledã€‚åˆæ¥åˆ°äº†job1çš„cancelImplï¼Œæ­¤æ—¶job1çš„stateæ˜¯Finishedï¼Œå¹¶ä¸”isCancelling = trueï¼Œæ‰€ä»¥ç»“æŸäº†makeCancellingã€‚\nç¬¬å…­é˜¶æ®µï¼šçˆ¶jobç»§ç»­æ‰§è¡ŒtryMakeCompletingSlowPath çˆ¶job1è§¦å‘å®ŒparentCancelledåï¼Œåœ¨tryMakeCompletingSlowPathé‡Œé¢é€šè¿‡è‡ªå·±çš„ChildHandleNodeçš„childJobï¼ˆä¹Ÿå°±æ˜¯job1ï¼‰çš„stateæ·»åŠ ä¸€ä¸ªChildCompletionå¯¹è±¡ã€‚\nç¬¬ä¸ƒé˜¶æ®µï¼šjob2ç»§ç»­æ‰§è¡ŒcancelParentä¹‹åçš„é€»è¾‘\njob2åœ¨finalizeFinishingStateæ–¹æ³•ä¸­æ‰§è¡Œå®ŒcancelParentä¹‹åï¼Œä¼šæ‰§è¡ŒcompleteStateFinalizationé€»è¾‘ï¼Œåœ¨é‡Œé¢ä¼šå›è°ƒåˆ°ç¬¬ä¸€é˜¶æ®µæ·»åŠ çš„ChildCompletioné€»è¾‘ä¸­ï¼Œåœ¨é‡Œé¢ä¼šè°ƒç”¨job1çš„continueCompletingæ–¹æ³•ï¼Œåœ¨è¯¥é€»è¾‘ä¸­ä¼šè°ƒç”¨cancelParentï¼Œè€ŒcancelParentä¼šå›è°ƒfalseï¼Œæ‰€ä»¥ä¼šè§¦å‘handleJobExceptionï¼Œè€Œjob1å¯¹åº”çš„æ˜¯StandaloneCoroutineï¼Œå®ƒé‡Œé¢ä¼šæ‹¿contextä¸­çš„CoroutineExceptionHandlerï¼Œå¦‚æœæ²¡æ‹¿åˆ°ç›´æ¥æŠ›å¼‚å¸¸ã€‚\næ¡ˆä¾‹å…«ï¼šå¼‚å¸¸jobçš„çˆ¶jobå¤„å¢åŠ CoroutineExceptionHandleræ•æ‰å¼‚å¸¸ ç»“æœï¼šæ­¤å¤„ä¸ä¼šå‘ç”Ÿå¼‚å¸¸ï¼Œå¼‚å¸¸è¢«exceptionHandleræ•æ‰ã€‚\nåˆ†æï¼šç»“åˆæ¡ˆä¾‹ä¸ƒçš„åˆ†æï¼Œåœ¨ç¬¬ä¸ƒé˜¶æ®µï¼Œjob1å¤„ç†å¼‚å¸¸çš„æ—¶å€™ï¼Œä¼šäº¤ç»™handleJobExceptionæ–¹æ³•ï¼Œå¹¶è®©CoroutineExceptionHandleræ•æ‰å¼‚å¸¸ï¼Œå› æ­¤ä¸ä¼šå´©æºƒã€‚\næ¡ˆä¾‹ä¹ï¼šhandlerç»™åˆ°å¼‚å¸¸åç¨‹ï¼Œhandleræ•è·ä¸åˆ°å¼‚å¸¸ åˆ†æï¼šç»“åˆæ¡ˆä¾‹ä¸ƒçš„åˆ†æï¼Œæœ€ç»ˆæ˜¯åœ¨job1ä¸­å¤„ç†å¼‚å¸¸ï¼Œè€Œæ­¤å¤„è®¾ç½®çš„handleræ˜¯è®¾ç½®åˆ°job2å¤„äº†ï¼Œæ‰€ä»¥ç¨‹åºå´©æºƒäº†ã€‚\næ¡ˆä¾‹åï¼šå¢åŠ coroutineScopeï¼Œå¼‚å¸¸åç¨‹çš„çˆ¶åç¨‹å¢åŠ try-catchæ•æ‰å¼‚å¸¸ ç»“æœï¼šç¨‹åºä¸ä¼šå´©æºƒï¼Œå¼‚å¸¸è¢«try catchæ•è·ä½ï¼Œè€Œä¸æ˜¯è¢«exceptionHandleræ•è·ä½ã€‚\nå‰é¢åˆ†æè¿‡å½“å­åç¨‹å‘ç”Ÿå¼‚å¸¸åï¼Œä¼šæŠŠå¼‚å¸¸åˆ†å‘ç»™åˆ°çˆ¶jobï¼Œåœ¨çˆ¶jobä¸­éœ€è¦ç­‰å­jobéƒ½å¤„ç†å®Œå¼‚å¸¸äº†ï¼Œæ‰ä¼šå¾€ä¸‹èµ°ï¼Œè¯¥å¤„é€»è¾‘ä¸»è¦ä½“ç°åœ¨å­jobä¸­æ·»åŠ äº†ä¸€ä¸ªChildCompletionèŠ‚ç‚¹åˆ°stateä¸­ï¼Œåœ¨invokeä¸­ä¼šæ‰§è¡Œåˆ°parent.continueCompletionæ–¹æ³•ï¼š æ­¤å¤„çš„parentå®é™…æ˜¯coroutineScopeä½œç”¨åŸŸçš„jobï¼Œå®ƒæ˜¯ScopeCoroutineï¼Œçœ‹ä¸‹å®ƒçš„continueCompletingå®ç°ï¼š æœ€ç»ˆä¼šæŠŠç»“æœå›è°ƒç»™åˆ°äº†ä¼ é€’è¿›æ¥çš„continuationï¼Œä¹Ÿå°±æ˜¯æœ€å¤–å±‚launchå¯åŠ¨çš„æ—¶å€™çš„SuspendLambdaï¼Œæœ€ç»ˆä¼šè°ƒç”¨å®ƒçš„invokeSuspendæ–¹æ³•ï¼š æ‰€ä»¥æœ€ç»ˆè¢«try-catchæ•æ‰åˆ°å¼‚å¸¸ã€‚\næ¡ˆä¾‹åä¸€ï¼šå¢åŠ supervisorScopeä½œä¸ºå¼‚å¸¸åç¨‹çš„ä½œç”¨åŸŸï¼Œå¼‚å¸¸èƒ½è¢«å¼‚å¸¸åç¨‹çš„handleræ‰€æ•è· ç»“æœï¼šç¨‹åºè¢«å†…å±‚launchæŒ‡å®šçš„exceptionHandleræ•æ‰äº† supervisorScopeç”¨åˆ°çš„jobæ˜¯SupervisorCoroutineï¼Œå®ƒé‡å†™äº†childCancelæ–¹æ³•ï¼Œå¹¶è¿”å›falseï¼Œæ‰€ä»¥å½“å­jobå‘ç”Ÿå¼‚å¸¸çš„æ—¶å€™ï¼Œä¸ä¼šæŠ›ç»™çˆ¶jobï¼Œå¹¶æ‰§è¡Œè‡ªå·±çš„handleJobExceptionæ–¹æ³•ï¼Œæ‰€ä»¥è¢«è‡ªå·±çš„handleræ•è·åˆ°ã€‚\næ¡ˆä¾‹åäºŒ é›†åˆæ¡ˆä¾‹ä¸ƒåˆ†æï¼Œåœ¨ç¬¬ä¸ƒé˜¶æ®µï¼Œjob1åœ¨å¤„ç†å¼‚å¸¸æ—¶ï¼Œä¼šæ‰¾åˆ°è‡ªå·±çš„handlerï¼Œæœ€ç»ˆå¼‚å¸¸è¢«å¤–å±‚çš„handleræ‰€æ•è·ã€‚\næ¡ˆä¾‹åä¸‰ï¼šå¢åŠ supervisorScopeä½œä¸ºå¼‚å¸¸åç¨‹çš„ä½œç”¨åŸŸï¼Œå¼‚å¸¸è¢«å†…éƒ¨çš„handleræ‰€æ•è· æ­¤æ—¶è¢«å†…å±‚launchçš„handleræ‰€æ•æ‰ï¼ŒåŸå› æ˜¯supervisorScopeå¯åŠ¨çš„åç¨‹ä¸ä¼šå¾€ä¸ŠæŠ›ï¼Œäº¤ç»™äº†å­åç¨‹è‡ªå·±å¤„ç†ã€‚\næ€»ç»“ çˆ¶å­åç¨‹å…³ç³»ï¼šçˆ¶å­åç¨‹ä¹‹é—´é€šè¿‡jobå»ºç«‹èµ·å…³ç³»ï¼Œåœ¨å­åç¨‹çš„jobåˆå§‹åŒ–çš„æ—¶å€™ï¼Œä¼šé€šè¿‡childHandleNodeç»‘å®šåˆ°çˆ¶å­å…³ç³»ï¼Œå…¶ä¸­å­jobæŒ‡å‘childHandleNodeçš„childJobï¼Œçˆ¶jobæŒ‡å‘childHandleNodeçš„jobä¸Šï¼Œæœ€åå­jobé€šè¿‡parentHandleæŒæœ‰è¯¥childHandleNodeã€‚çˆ¶åç¨‹ä¸­å¦‚ä½•åŒ…å«äº†å¤šä¸ªå­åç¨‹ï¼Œæ­¤æ—¶çˆ¶jobçš„stateä¼šæ˜¯ä¸€ä¸ªNodeListï¼Œä¹Ÿå°±æ˜¯é“¾è¡¨ç»“æ„çš„å¯¹è±¡ï¼Œç„¶åNodeListçš„nextèŠ‚ç‚¹æŒæœ‰äº†ç¬¬ä¸€ä¸ªå­åç¨‹çš„childHandleNodeï¼Œç¬¬ä¸€ä¸ªå­åç¨‹çš„childHandleNodeçš„nextèŠ‚ç‚¹æŒæœ‰äº†ç¬¬äºŒä¸ªå­åç¨‹çš„childHandleNodeï¼Œä¾æ¬¡ç±»æ¨ã€‚\nå¼‚å¸¸å¤„ç†ï¼šå½“æŸä¸ªå­åç¨‹å‘ç”Ÿå¼‚å¸¸åï¼Œä¼šå°†è‡ªå·±çš„stateç»™ç½®ä¸ºFinishingçŠ¶æ€ï¼Œå¹¶ä¸”ç»™FinishingçŠ¶æ€æ·»åŠ å¼‚å¸¸ä¿¡æ¯ï¼Œæ¥ç€å°†å¼‚å¸¸ç»™åˆ°çˆ¶åç¨‹ï¼Œå¦‚æœæ­¤æ—¶çˆ¶åç¨‹ä¸å¤„ç†å¼‚å¸¸ï¼Œåˆ™äº¤ç»™è‡ªå·±çš„contextä¸­çš„CoroutineExceptionHandlerå¤„ç†ï¼Œå¦‚æœcontextä¸­æ‰¾ä¸åˆ°CoroutineExceptionHandlerï¼Œåˆ™å°†å¼‚å¸¸æŠ›ç»™ç³»ç»Ÿï¼Œç›´åˆ°appå´©æºƒã€‚å¦‚æœçˆ¶åç¨‹å¤„ç†å¼‚å¸¸ï¼Œåˆ™ä¼šå…ˆå–æ¶ˆæ‰è‡ªå·±ä¸‹é¢çš„å…¶ä»–å­åç¨‹çš„jobï¼Œç„¶åå°†å¼‚å¸¸ç»§ç»­æŠ›ç»™è‡ªå·±çš„çˆ¶åç¨‹ï¼Œä¾æ¬¡è¿™æ ·å»å¤„ç†å¼‚å¸¸ã€‚\n","date":"2024-12-17T00:00:00Z","image":"http://xiangcman.xyz/p/%E5%8D%8F%E7%A8%8B%E4%B8%AD%E5%AD%90%E5%8D%8F%E7%A8%8B%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/cover_hu_398ba822a3953d68.jpg","permalink":"http://xiangcman.xyz/p/%E5%8D%8F%E7%A8%8B%E4%B8%AD%E5%AD%90%E5%8D%8F%E7%A8%8B%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/","title":"åç¨‹ä¸­å­åç¨‹å¼‚å¸¸å¤„ç†"},{"content":"invokeOnCompletionç›‘å¬åç¨‹çŠ¶æ€ åœ¨äº†è§£åç¨‹çš„å¼‚å¸¸å¤„ç†ä¹‹å‰ï¼Œå…ˆæ¥ç†Ÿæ‚‰ä¸‹åç¨‹ä¹‹é—´jobæ˜¯å¦‚ä½•ç»‘å®šå…³ç³»ï¼Œè¿˜æ˜¯é€šè¿‡ä¸€ä¸ªä¾‹å­æ¥ç†Ÿæ‚‰ä»–ä»¬ä¹‹é—´çš„å…³ç³»ï¼š\n1 2 3 4 5 6 7 8 private fun demo(){ val job = GlobalScope.launch { Log.d(TAG, \u0026#34;demo: launchä»£ç \u0026#34;) } job.invokeOnCompletion { Log.d(TAG, \u0026#34;demo: invokeOnCompletion\u0026#34;) } } æ‰§è¡Œç»“æœï¼š\n1 2 CoroutineJobActivity com.example.coroutinescopedemo D demo: launchä»£ç  CoroutineJobActivity com.example.coroutinescopedemo D demo: invokeOnCompletion å¯ä»¥çœ‹å‡ºæ¥invokeOnCompletionæ˜¯jobæ‰§è¡Œå®Œæ¯•çš„å›è°ƒã€‚\né€šè¿‡launchåˆ›å»ºåç¨‹å†…éƒ¨ä¼šæ„é€ ä¸€ä¸ªStandaloneCoroutineï¼Œå®ƒå°±æ˜¯ä¸€ä¸ªjobï¼Œå¹¶ä¸”launchè¿”å›çš„å°±æ˜¯è¯¥jobï¼š StandaloneCoroutineç»§æ‰¿è‡ªAbstractCoroutineï¼š å› æ­¤parentHandleä¸ºNonDisposableHandleï¼Œç„¶åæ–¹æ³•ç»“æŸã€‚ æ­¤æ—¶æ‰§è¡Œå®Œlaunchåï¼Œç»§ç»­æ‰§è¡Œäº†jobçš„invokeOnCompletionæ–¹æ³•ï¼Œå®ƒæ˜¯ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œå®ç°æ–¹æ³•åœ¨jobSupportç±»ï¼š æˆ‘ä»¬çœ‹ä¸‹makeNodeæ–¹æ³•å®ç°ï¼š ä»è°ƒç”¨é“¾ä¸Šçœ‹onCancellingä¼ è¿›æ¥çš„æ˜¯falseï¼Œå¹¶ä¸”æ­¤æ—¶çš„handlerè¿˜ä¸æ˜¯ä¸€ä¸ªJobNodeèŠ‚ç‚¹ï¼Œæ‰€ä»¥ä¼šåˆ›å»ºäº†ä¸€ä¸ªInvokeOnCompletionå¯¹è±¡ï¼Œå¹¶æŠŠå¤–é¢ä¼ è¿›æ¥çš„ComppletionHandlerä¼ åˆ°InvokeOnCompletionä¸­ï¼Œçœ‹ä¸‹InvokeOnCompletionå¯¹è±¡ï¼š\n1 2 3 4 5 private class InvokeOnCompletion( private val handler: CompletionHandler ) : JobNode() { override fun invoke(cause: Throwable?) = handler.invoke(cause) } InvokeOnCompletionæ˜¯ä¸€ä¸ªJobNodeèŠ‚ç‚¹ï¼š\n1 2 3 4 5 6 7 8 9 10 internal abstract class JobNode : CompletionHandlerBase(), DisposableHandle, Incomplete { /** * Initialized by [JobSupport.makeNode]. */ lateinit var job: JobSupport override val isActive: Boolean get() = true override val list: NodeList? get() = null override fun dispose() = job.removeNode(this) override fun toString() = \u0026#34;$classSimpleName@$hexAddress[job@${job.hexAddress}]\u0026#34; } JobNodeå®ç°äº†CompletionHandlerBaseæŠ½è±¡ç±»ï¼š\n1 2 3 internal actual abstract class CompletionHandlerBase actual constructor() : LockFreeLinkedListNode(), CompletionHandler { actual abstract override fun invoke(cause: Throwable?) } å®ƒä¹Ÿæ˜¯å®ç°äº†CompletionHandleræ¥å£ï¼ŒCompletionHandleræ˜¯ä¸€ä¸ªé—­åŒ…ï¼Œä»ä¸Šé¢ç»§æ‰¿ä»¥åŠJobNodeå®ç°æ¥çœ‹ï¼Œåœ¨å®ƒçš„invokeå®ç°é‡Œé¢ï¼Œä¼šè§¦å‘ä¼ è¿›æ¥çš„CompletionHandlerçš„invokeå®ç°ï¼Œä»å®ç°æ¥çœ‹å…¶å®è¿™å°±æ˜¯ä¸ªé™æ€ä»£ç†çš„æ¨¡å¼ã€‚\nç»“è®ºï¼š makeNodeå†…éƒ¨ä¼šè¿”å›ä¸€ä¸ªInvokeOnCompletionå¯¹è±¡ï¼Œå®ƒæ˜¯ä¸€ä¸ªJobNodeèŠ‚ç‚¹ã€‚\nå›åˆ°ä¸Šé¢çš„invokeOnComletionçš„å®ç°ï¼Œåˆ›å»ºäº†InvokeOnCompletionåï¼Œä¼šèµ°åˆ°loopOnStateçš„å‡½æ•°ï¼Œå®ƒæ˜¯éå†stateï¼Œå®ƒçš„åˆå§‹çŠ¶æ€æ˜¯ä¸€ä¸ªEmptyçŠ¶æ€ï¼Œå¹¶ä¸”state.isActive=trueã€‚æ‰€ä»¥æœ€ç»ˆæŠŠåˆšæ‰åˆ›å»ºçš„InvokeOnCompletionè®¾ç½®åˆ°äº†stateä¸Šï¼Œå¹¶ä¸”è¿”å›äº†è¯¥InvokeOnCompletionã€‚\nç»“è®ºï¼š å½“è°ƒç”¨äº†jobçš„invokeOnCompletionæ–¹æ³•åï¼Œä¼šæŠŠå¤–ç•Œåˆ›å»ºå¥½çš„CompletionHandlerä¼ ç»™äº†InvokeCompletionï¼ŒInvokeCompletionæ˜¯ä¸€ä¸ªJobNodeï¼Œåœ¨å®ƒçš„invokeå®ç°ä¸­ï¼Œä¼šå›è°ƒåˆ°å¤–ç•Œçš„CompletionHandlerä¸­ã€‚å¹¶ä¸”æŠŠåˆ›å»ºçš„InvokeCompletionè®¾ç½®åˆ°å½“å‰jobçš„stateä¸Šäº†ã€‚\nåç¨‹ä½“æ‰§è¡Œå®Œjobçš„æ‰§è¡Œï¼š åœ¨ä¹‹å‰åˆ†æåç¨‹ä½“å…¶å®æ˜¯ä¸€ä¸ªSuspendLambdaï¼Œåœ¨å®ƒçš„invokeSuspendè°ƒç”¨å®Œåï¼Œä¼šæ‰§è¡Œå®ƒçš„continuationçš„resumeWithæ–¹æ³•ï¼Œåœ¨ä¸Šé¢ä¾‹å­ä¸­å…¶å®æ˜¯StandaloneCoroutineï¼Œå®ƒæ˜¯ä¸€ä¸ªjobï¼Œæ‰€ä»¥çœ‹ä¸‹å®ƒçš„resumeWithå®ç°ï¼š\n1 2 3 4 5 public final override fun resumeWith(result: Result\u0026lt;T\u0026gt;) { val state = makeCompletingOnce(result.toState()) if (state === COMPLETING_WAITING_CHILDREN) return afterResume(state) } å°†åç¨‹ä½“çš„ç»“æœä¼ åˆ°äº†makeCompletingOnceæ–¹æ³•ä¸­ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 internal fun makeCompletingOnce(proposedUpdate: Any?): Any? { loopOnState { state -\u0026gt; val finalState = tryMakeCompleting(state, proposedUpdate) when { finalState === COMPLETING_ALREADY -\u0026gt; throw IllegalStateException( \u0026#34;Job $this is already complete or completing, \u0026#34; + \u0026#34;but is being completed with $proposedUpdate\u0026#34;, proposedUpdate.exceptionOrNull ) finalState === COMPLETING_RETRY -\u0026gt; return@loopOnState else -\u0026gt; return finalState // COMPLETING_WAITING_CHILDREN or final state } } } è½®è®­è·å–stateï¼Œå¹¶è°ƒç”¨äº†tryMakeCompletingæ–¹æ³•ï¼š ä»ä¸Šé¢çš„åˆ†æçŸ¥é“stateå®ƒæ˜¯ä¸€ä¸ªJobNodeï¼Œå®ƒæ˜¯ä¸€ä¸ªInvokeCompletionï¼Œå®ƒä¸æ˜¯ä¸€ä¸ªChildHandleNodeï¼Œå¹¶ä¸”proposedUpdateä¸æ˜¯CompletedExceptionallyï¼Œæ‰€ä»¥ä¼šæ‰§è¡ŒtryFinalizeSimpleStateï¼š å†…éƒ¨è°ƒç”¨äº†completeStateFinalizationæ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 private fun completeStateFinalization(state: Incomplete, update: Any?) { /* * Now the job in THE FINAL state. We need to properly handle the resulting state. * Order of various invocations here is important. * * 1) Unregister from parent job. */ parentHandle?.let { it.dispose() // volatile read parentHandle _after_ state was updated parentHandle = NonDisposableHandle // release it just in case, to aid GC } val cause = (update as? CompletedExceptionally)?.cause /* * 2) Invoke completion handlers: .join(), callbacks etc. * It\u0026#39;s important to invoke them only AFTER exception handling and everything else, see #208 */ if (state is JobNode) { // SINGLE/SINGLE+ state -- one completion handler (common case) try { state.invoke(cause) } catch (ex: Throwable) { handleOnCompletionException(CompletionHandlerException(\u0026#34;Exception in completion handler $state for $this\u0026#34;, ex)) } } else { state.list?.notifyCompletion(cause) } } è¯¥æ–¹æ³•ä¸­åˆ¤æ–­stateæ˜¯å¦æ˜¯JobNodeï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œä¼šè°ƒç”¨invokeæ–¹æ³•ã€‚åœ¨ä¸Šé¢åˆ†æè¿‡stateæ˜¯ä¸€ä¸ªInvokeOnCompletionå¯¹è±¡ï¼Œåœ¨å®ƒçš„invokeé‡Œé¢ä¼šå›è°ƒåˆ°ä¼ è¿›æ¥çš„CompletionHandlerçš„invokeä¸­ï¼Œæ‰€ä»¥åœ¨ä¸Šé¢ä¾‹å­ä¸­æ‰“å°äº†jobæ‰§è¡Œå®Œæˆçš„æ—¥å¿—ã€‚\ninvokeOnCompletionç›‘å¬jobçš„å¼‚å¸¸ è¿˜æ˜¯é€šè¿‡ä¸€ä¸ªä¾‹å­æ¥åˆ†æä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 private fun demo3(){ val exceptionHandler =CoroutineExceptionHandler{ coroutineContext, throwable -\u0026gt; Log.d(TAG, \u0026#34;demo3: CoroutineExceptionHandler--å¼‚å¸¸ä¿¡æ¯ï¼š${throwable?.message}\u0026#34;) } val job = GlobalScope.launch(exceptionHandler) { Log.d(TAG, \u0026#34;demo3: launchä»£ç \u0026#34;) throw RuntimeException(\u0026#34;åç¨‹ä½“é‡Œé¢å‘ç”Ÿå¼‚å¸¸äº†\u0026#34;) } job.invokeOnCompletion { Log.d(TAG, \u0026#34;demo3: invokeOnCompletion--å¼‚å¸¸ä¿¡æ¯ï¼š${it?.message}\u0026#34;) } } æ­¤å¤„ç”¨äº†ä¸€ä¸ªCoroutineExceptionHandleræ–¹æ³•ï¼Œæ¥åˆ›å»ºCoroutineExceptionHandlerå¯¹è±¡æ¥æ‹¦æˆªå¼‚å¸¸çš„ï¼Œè¿™å—å…ˆä¸ç”¨ç®¡ï¼Œæˆ‘ä»¬çœ‹ä¸‹æ—¥å¿—ï¼š\n1 2 3 com.example.coroutinescopedemo D demo3: launchä»£ç  com.example.coroutinescopedemo D demo3: CoroutineExceptionHandler--å¼‚å¸¸ä¿¡æ¯ï¼šåç¨‹ä½“é‡Œé¢å‘ç”Ÿå¼‚å¸¸äº† com.example.coroutinescopedemo D demo3: invokeOnCompletion--å¼‚å¸¸ä¿¡æ¯ï¼šåç¨‹ä½“é‡Œé¢å‘ç”Ÿå¼‚å¸¸äº† å¯ä»¥çœ‹å‡ºæ¥ï¼ŒinvokeOnCompletionä¸­ä¹Ÿèƒ½æ”¶åˆ°å¼‚å¸¸çš„æ¶ˆæ¯ã€‚ ä½†æ˜¯å¼‚å¸¸å’Œæ­£å¸¸æ”¶æ•°æ®å¯èƒ½ä¸å¤ªä¸€æ ·ï¼Œä¸»è¦åŒºåˆ«æ˜¯åœ¨resumeWithä¹‹åçš„å¤„ç†ä¸å¤ªä¸€æ ·ï¼š å¦‚æœæ˜¯éå¼‚å¸¸çš„è¯ï¼Œä¼šèµ°tryFinalizeSimpleStateï¼›å¦‚æœæ˜¯å¼‚å¸¸çš„æ—¶å€™ä¼šèµ°tryMakeCompletingSlowPathï¼Œåœ¨è¯¥æ–¹æ³•é‡Œé¢ä¼šè§¦å‘finalizeFinishingStateæ–¹æ³•ï¼Œè¯¥æ–¹æ³•æœ‰ä¸ªå¾ˆé‡è¦é€»è¾‘ï¼š ç”±äºcancelParentè¿”å›falseï¼Œæ‰€ä»¥ä¼šè§¦å‘handleJobExceptionï¼ŒStandaloneCoroutineé‡å†™äº†è¯¥æ–¹æ³•ï¼š handleCoroutineExceptionï¼š å¦‚æœcontextä¸­CoroutineExceptionHandlerä¸ä¸ºç©ºï¼Œåˆ™å¼‚å¸¸ä¸ä¼šå¾€ä¸ŠæŠ›äº†ï¼Œæ‰€ä»¥æ­¤ä¾‹ä¸­å®šä¹‰äº†contextçš„CoroutineExceptionHandlerç¨‹åºä¸ä¼šå´©æºƒã€‚ å›åˆ°ä¸Šé¢å†æ¥çœ‹invokeOnCompletionçš„CompletionHandlerè§¦å‘æ—¶æœºï¼Œå®ƒæ˜¯åœ¨finalizeFinishingStateä¸­è§¦å‘ï¼Œæ¥ç€ä¼šè°ƒç”¨åˆ°completeStateFinalizationï¼Œæœ€ç»ˆåœ¨é‡Œé¢è§¦å‘äº†invokeOnCompletionä¼ è¿›æ¥çš„CompletionHandlerã€‚\nåç¨‹å¼‚å¸¸tryä½ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 private fun demo4() { val exceptionHandler = CoroutineExceptionHandler { coroutineContext, throwable -\u0026gt; Log.d(TAG, \u0026#34;demo4: CoroutineExceptionHandler--å¼‚å¸¸ä¿¡æ¯ï¼š${throwable?.message}\u0026#34;) } val job = GlobalScope.launch(exceptionHandler) { try { Log.d(TAG, \u0026#34;demo4: launchä»£ç \u0026#34;) throw RuntimeException(\u0026#34;åç¨‹ä½“é‡Œé¢å‘ç”Ÿå¼‚å¸¸äº†\u0026#34;) } catch (e: Exception) { Log.d(TAG, \u0026#34;demo4: catchä¸­ä»£ç \u0026#34;) } } job.invokeOnCompletion { Log.d(TAG, \u0026#34;demo4: invokeOnCompletion--å¼‚å¸¸ä¿¡æ¯ï¼š${it?.message}\u0026#34;) } } æ—¥å¿—å¦‚ä¸‹ï¼š\n1 2 3 com.example.coroutinescopedemo D demo4: launchä»£ç  com.example.coroutinescopedemo D demo4: catchä¸­ä»£ç  com.example.coroutinescopedemo D demo4: invokeOnCompletion--å¼‚å¸¸ä¿¡æ¯ï¼šnull ä»æ—¥å¿—ä¸­çœ‹ï¼Œæ­¤å¤„çš„CoroutineExceptionHandlerä¸å›è°ƒï¼Œå¹¶ä¸”invokeOnCompletionæ”¶ä¸åˆ°å¼‚å¸¸ä¿¡æ¯ã€‚ æˆ‘ä»¬é€šè¿‡å­—èŠ‚ç å¯ä»¥çœ‹åˆ°åŸå› ï¼š æ­¤å¤„çš„å¼‚å¸¸catchä½åï¼Œç»™åˆ°JobSupportå°±ä¸æ˜¯å¼‚å¸¸äº†ï¼Œæ‰€ä»¥æŒ‰ç…§æˆåŠŸçš„å¤„ç†æ–¹å¼ä¸€æ ·ã€‚\næ€»ç»“ï¼š jobåˆå§‹åŒ–é˜¶æ®µï¼šé€šè¿‡å¼•å…¥invokeOnCompletionæ–¹æ³•ï¼Œæ¥ç†Ÿæ‚‰jobå¦‚ä½•åˆ†å‘å¼‚å¸¸ï¼Œåœ¨ä¸Šé¢äº‹ä¾‹ä¸­ï¼Œé€šè¿‡launchå¯åŠ¨çš„åç¨‹ï¼Œå®ƒå¯¹åº”çš„jobæ˜¯StandaloneCoroutineï¼Œå®ƒçš„çˆ¶ç±»æ˜¯AbstractCoroutineï¼Œåœ¨å®ƒçš„æ„é€ æ–¹æ³•é‡Œé¢ä¼šè°ƒç”¨initParentJobæ–¹æ³•ï¼Œè¯¥æ–¹æ³•å°±æ˜¯æ„å»ºçˆ¶jobå’Œå½“å‰jobçš„å…³ç³»ï¼Œç”±äºä¸Šé¢launchå¯åŠ¨çš„åç¨‹çš„çˆ¶jobæ˜¯ç©ºçš„ï¼Œå› æ­¤parentHandleæŒ‡å‘äº†NonDisposableHandleå¯¹è±¡ã€‚æ¥ç€å½“è°ƒç”¨äº†invokeOnCompletionæ–¹æ³•çš„æ—¶å€™ï¼Œä¼šæ„é€ InvokeOnCompletionå¯¹è±¡ï¼Œå¹¶æŠŠä¸šåŠ¡æ–¹æ„é€ çš„CompletionHandlerä¼ åˆ°äº†InvokeOnCompletionå¯¹è±¡ä¸­ï¼Œå½“InvokeOnCompletionå¯¹è±¡çš„invokeè¢«è°ƒç”¨çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨åˆ°å¤–ç•Œä¼ å…¥çš„CompletionHandlerçš„invokeæ–¹æ³•ã€‚InvokeOnCompletionæ˜¯ä¸€ä¸ªJobNodeå¯¹è±¡ï¼Œæœ€ç»ˆä¼šè¢«æ·»åŠ åˆ°jobçš„stateä¸Šã€‚ jobæ‰§è¡Œé˜¶æ®µï¼šå‰é¢æˆ‘ä»¬åˆ†æè¿‡SuspendLambdaæ‰§è¡Œå®ŒinvokeSuspendé€»è¾‘åï¼Œä¼šæ¥ç€è°ƒç”¨ä¸Šçº§continuationçš„resumeæ–¹æ³•ï¼Œé€šè¿‡resumeWith-\u0026gt;makeCompletingOnce-\u0026gt;tryMakeCompletingã€‚ å¼‚å¸¸å¤„ç†ï¼šæ¥ç€ä¼šåˆ¤æ–­æ˜¯ä¸æ˜¯å¼‚å¸¸ç±»å‹ï¼Œå¦‚æœæ˜¯å¼‚å¸¸ç±»å‹ï¼Œåˆ™ä¼šè§¦å‘tryMakeCompletingSlowPath-\u0026gt;finalizeFinishingState-\u0026gt;completeStateFinalizationï¼Œå…¶ä¸­åœ¨finalizeFinishingStateæ˜¯jobå¤„ç†å¼‚å¸¸çš„å…³é”®é€»è¾‘ï¼Œå¦‚æœcancelParentä¸ºfalseï¼Œåˆ™è¡¨ç¤ºçˆ¶jobä¸å¤„ç†å¼‚å¸¸ï¼Œåˆ™ä¼šè°ƒç”¨è‡ªå·±çš„handleJobExceptionæ–¹æ³•ï¼Œåœ¨è¯¥æ–¹æ³•ä¸­çœ‹contextä¸­æ˜¯å¦æœ‰CoroutineExceptionHandlerï¼Œå¦‚æœæœ‰åˆ™æ•è·åˆ°å¼‚å¸¸ï¼Œå°†å¼‚å¸¸åˆ†å‘ç»™CoroutineExceptionHandlerã€‚å¦‚æœæ²¡æœ‰åˆ™å°†å¼‚å¸¸å¾€ä¸ŠæŠ›ï¼Œç›´åˆ°ç¨‹åºå´©æºƒã€‚å¦‚æœä¸å´©æºƒä¼šåœ¨completeStateFinalizationä¸­æ‹¿åˆ°jobçš„stateä¸­çš„InvokeOnCompletionå¯¹è±¡ï¼Œç„¶åè§¦å‘å¤–ç•Œä¼ å…¥çš„CompletionHandlerã€‚ éå¼‚å¸¸å¤„ç†ï¼šå¦‚æœæ˜¯éå¼‚å¸¸åœ¨tryMakeCompletingä¸­ä¼šèµ°tryFinalizeSimpleState-\u0026gt;completeStateFinalizationï¼Œæœ€ç»ˆä¹Ÿä¼šè§¦å‘åˆ°InvokeOnCompletionå¯¹è±¡ã€‚\nInvokeOnCompletionç±»å›¾ å¼‚å¸¸å¤„ç†æ—¶åºå›¾ ","date":"2024-12-16T00:00:00Z","permalink":"http://xiangcman.xyz/p/%E5%8D%8F%E7%A8%8B%E7%9A%84%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/","title":"åç¨‹çš„å¼‚å¸¸å¤„ç†"},{"content":"é¦–å…ˆçœ‹ä¸€ä¸ªä¾‹å­ï¼š æ—¥å¿—å¦‚ä¸‹ï¼š å’ŒwithContextçš„åŒºåˆ«æ˜¯launchåé¢çš„ä»£ç æ— éœ€ç­‰åˆ°asyncæ‰§è¡Œå®Œæ‰æ‰§è¡Œã€‚ å­—èŠ‚ç å¦‚ä¸‹ï¼š launchéƒ¨åˆ†å¯åŠ¨çš„åç¨‹çš„invokeSuspendé€»è¾‘é‡Œé¢ï¼Œåªæœ‰label0çš„é€»è¾‘ï¼Œå’ŒwithContextä¸åŒçš„æ˜¯ä¼šæœ‰æŒ‚èµ·éƒ¨åˆ†çš„åˆ¤æ–­ï¼Œæ‰€ä»¥æ˜¯åŒæ­¥æ‰§è¡Œçš„ã€‚\nasyncçš„å¼‚æ­¥æ‰§è¡Œï¼š æ—¥å¿—å¦‚ä¸‹ï¼š å¯ä»¥çœ‹åˆ°async2æ˜¯å…ˆæ‰§è¡Œçš„ï¼Œå› ä¸ºå®ƒæ²¡æœ‰è¿›è¡Œdelayï¼Œç­‰åˆ°ä¸¤ä¸ªasyncæ‰§è¡Œå®Œäº†åï¼Œæ‰ä¼šæ‰§è¡Œlaunché‡Œé¢çš„ä»£ç ã€‚ å­—èŠ‚ç å¦‚ä¸‹ï¼š ç¼–è¯‘åçš„ä»£ç ï¼š label=0çš„æ—¶å€™ï¼Œé€šè¿‡asyncå¯åŠ¨äº†ä¸¤ä¸ªåç¨‹ï¼Œæˆ‘ä»¬è¿™é‡Œå«async1å’Œasync2ï¼Œå¹¶ä¸”åœ¨é‡Œé¢é€šè¿‡awaitæŒ‚èµ·äº†launchå¯åŠ¨çš„åç¨‹ã€‚ åˆ†æï¼šasync1è°ƒç”¨awaitåï¼Œç”±äºçŠ¶æ€æ˜¯COROUTINE_SUSPENDEDï¼Œæ‰€ä»¥ç¬¬ä¸€æ¬¡invokeSuspendæ–¹æ³•ç»“æŸï¼Œæ­¤æ—¶label=1ã€‚ç­‰åˆ°awaité€»è¾‘æ‰§è¡Œå®Œåï¼Œåˆä¼šç¬¬äºŒæ¬¡æ‰§è¡ŒinvokeSuspendæ–¹æ³•ï¼Œæ­¤æ—¶ç”±äºlable=1ï¼Œä¼šæ‰§è¡Œasync2çš„awaitæ–¹æ³•ï¼Œæ­¤æ—¶è¿”å›COROUTINE_SUSPENDEDï¼Œæ‰€ä»¥invokeSuspendç¬¬äºŒæ¬¡ç»“æŸï¼Œæ­¤æ—¶label=2ã€‚ç­‰åˆ°async2çš„awaitæ‰§è¡Œå®Œåï¼Œç¬¬ä¸‰æ¬¡æ‰§è¡ŒinvokeSuspendæ–¹æ³•ï¼Œç”±äºæ­¤æ—¶label=2ï¼Œæ‰€ä»¥æ­¤æ—¶åˆ‡å›åˆ°è‡ªå·±çš„çº¿ç¨‹ï¼Œæ‰§è¡Œlaunchéƒ¨åˆ†çš„ä»£ç é€»è¾‘ã€‚\næ€»ç»“ï¼š asyncçš„åŒæ­¥æ‰§è¡Œæ˜¯å› ä¸ºæ²¡æœ‰æŒ‚èµ·SuspendLambdaçš„invokeSuspendæ–¹æ³•ï¼Œæ‰€ä»¥çˆ¶åç¨‹ä¸ä¼šæŒ‚èµ·ï¼Œè€Œawaitæ–¹æ³•æ˜¯æŒ‚èµ·å‡½æ•°ï¼Œé»˜è®¤æ˜¯è¿”å›COROUTINE_SUSPENDEDï¼Œæ‰€ä»¥çˆ¶åç¨‹æŒ‚èµ·ï¼Œå½“å­åç¨‹é€»è¾‘æ‰§è¡Œå®Œåï¼Œä¼šå›è°ƒçˆ¶åç¨‹çš„invokeSuspendï¼Œå½“å†æ¬¡æ‰§è¡ŒinvokeSuspendçš„æ—¶å€™ï¼Œlabelå€¼å‘ç”Ÿäº†å˜åŒ–ï¼Œå› æ­¤ä¼šæ‰§è¡Œlaunchéƒ¨åˆ†çš„é€»è¾‘ã€‚\n","date":"2024-11-28T00:00:00Z","permalink":"http://xiangcman.xyz/p/%E5%8D%8F%E7%A8%8B%E7%9A%84%E5%90%8C%E6%AD%A5%E6%89%A7%E8%A1%8C%E5%8E%9F%E7%90%86/","title":"åç¨‹çš„åŒæ­¥æ‰§è¡ŒåŸç†"},{"content":"å…ˆæ¥ä¸€ä¸ªä¾‹å­ï¼š æ—¥å¿—å¦‚ä¸‹ï¼š å¯ä»¥çœ‹åˆ°ä¸Šé¢å…ˆæ˜¯æ‰§è¡Œäº†withContextä¸­çš„ä»£ç ï¼Œç„¶åæ‰§è¡Œäº†launchä¸­çš„ä»£ç ï¼Œæ³¨æ„åˆ°launchä¸­ä¹Ÿæ˜¯åœ¨å•ç‹¬çº¿ç¨‹ä¸­æ‰§è¡Œçš„ï¼Œå…¶ä¸­launchä¸­ä½¿ç”¨çš„Dispatcheræ˜¯Dispatchers.Defaultç±»å‹çš„ã€‚å‰é¢åˆ†æè¿‡launchè°ƒåº¦æƒ…å†µï¼Œæœ€åä¼šæ‰§è¡Œåˆ°continuationçš„resumeWithï¼Œç„¶åè°ƒç”¨å®ƒçš„invokeSuspendæ–¹æ³•ï¼š å¯ä»¥çœ‹åˆ°å…ˆæ‰§è¡ŒwithContextï¼Œå› ä¸ºwithContextå¯åŠ¨çš„æ—¶å€™ï¼Œé»˜è®¤çš„çŠ¶æ€æ˜¯COROUTINE_SUSPENDEDï¼Œæ‰€ä»¥é€€å‡ºäº†invokeSuspendæ–¹æ³•ï¼Œè¿”å›äº†var2ï¼Œæ­¤æ—¶çš„label=1äº†ã€‚å½“æ‰§è¡Œå®ŒwithContextçš„æ—¶å€™ï¼Œä¼šé€šçŸ¥ä¼ ç»™withContextçš„continuationï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢çš„CoroutineDispatchersActivity$demo2$1è¿™ä¸ªSuspendLambdaã€‚æ‰€ä»¥ä¼šå†æ¬¡æ‰§è¡Œå®ƒçš„invokeSuspendæ–¹æ³•ï¼Œæ­¤æ—¶lable=1ï¼Œæ‰€ä»¥æœ€åè¿”å›äº†Unit.INSTANCEï¼Œæ•´ä¸ªinvokeSuspendç»“æŸï¼Œè¿™å°±æ˜¯æŒ‚èµ·çš„åŸå› ã€‚ è‡³äºä¸ºä»€ä¹ˆåœ¨CoroutineDispatchersActivity$demo2$1ä¸­é‡åˆ°äº†è¿”å›å€¼ä¸ºCOROUTINE_SUSPENDEDæ—¶å€™ï¼Œä¸ä¼šç»§ç»­æ‰§è¡Œäº†å‘¢ï¼Ÿçœ‹ä¸‹BaseContinuationImplä¸­çš„resumeWithé€»è¾‘ï¼š åœ¨BaseContinuationImplçš„resumeWithä¸­ï¼Œå¦‚æœinvokeSuspendè¿”å›å€¼æ˜¯COROUTINE_SUSPENDEDï¼Œåˆ™ç›´æ¥returnäº†ï¼Œä¸å¾€ä¸Šå±‚çš„continuationè°ƒç”¨äº†ã€‚\nè‡³äºå†æ¬¡æ‰§è¡ŒCoroutineDispatchersActivity$demo2$1çš„invokeSuspendæ–¹æ³•æ˜¯åœ¨ä»€ä¹ˆæ—¶å€™ï¼Œå¯ä»¥è¿½æº¯åˆ°withContextä¸­ï¼š æ‰§è¡Œäº†blockçš„startCoroutineCancellableï¼š æ­¤å¤„å¾ˆç†Ÿæ‚‰å•Šï¼Œè¿™ä¸åˆå¯åŠ¨äº†ä¸€ä¸ªåç¨‹å—ï¼Ÿåç¨‹å¥—åç¨‹å•Šã€‚å¥½å§ï¼Œæˆ‘ä»¬ç›´æ¥çœ‹completionçš„å›è°ƒï¼Œåœ¨åç¨‹æŒ‚èµ·å‡½æ•°æ‰§è¡Œå®Œåï¼Œä¼šæ‰§è¡Œcompleteçš„resumeWithæ–¹æ³•ï¼Œæ­¤å¤„æ˜¯DispatchedCoroutineå¯¹è±¡ï¼Œç»§æ‰¿è‡ªScopeCoroutineï¼š å®ƒæ˜¯å…ˆå–continuationä¸­contextçš„ContinuationInterceptorï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢launchå¯åŠ¨çš„dispatchersï¼Œå¯¹åº”çš„æ˜¯Dispatchers.Defaultï¼Œæœ€ç»ˆæ‰§è¡ŒDispatchersçš„resumeCancellableWithæ–¹æ³•ï¼Œåœ¨è¯¥æ–¹æ³•é‡Œé¢æœ€ç»ˆä¼šåœ¨åç¨‹æŒ‡å®šçš„çº¿ç¨‹ä¸­æ‰§è¡Œåç¨‹ä»£ç å—ã€‚æ‰€ä»¥åœ¨ä¸Šé¢æ—¥å¿—ä¸­èƒ½çœ‹åˆ°withContextæ‰§è¡Œå®Œåï¼Œlaunchä¹‹åçš„ä»£ç èƒ½å›åˆ°æŒ‡å®šçš„çº¿ç¨‹ä¸­æ‰§è¡Œã€‚\nwithcontextæ‰§è¡Œå®Œäº†åä¼šæ‰§è¡Œå¤–é¢åç¨‹çš„resumeWithï¼Œæ‰€ä»¥launchçš„invokeSuspendå†æ¬¡æ‰§è¡Œã€‚å†æ¬¡æ‰§è¡Œçš„æ—¶å€™ä¼šå›åˆ°è‡ªå·±çš„çº¿ç¨‹ã€‚çœŸç›¸å¤§ç™½äº†ï¼\næ€»ç»“ï¼š é¦–å…ˆæ¯ä¸€ä¸ªåç¨‹ä»£ç å—éƒ½ä¼šè¢«ç¼–è¯‘æˆSuspendLambdaå¯¹è±¡ï¼Œå®ƒä¹Ÿæ˜¯ä¸€ä¸ªContinuationå¯¹è±¡ï¼Œæ¯æ¬¡åœ¨æ‰§è¡Œåˆ°SuspendLambdaçš„resumeæ—¶å€™ï¼Œéƒ½ä¼šå»æ‰§è¡ŒinvokeSuspendæ–¹æ³•ï¼Œè€Œè¯¥æ–¹æ³•é‡Œé¢ä¼šå»æ‰§è¡Œå­åç¨‹ï¼Œå¦‚æœå­åç¨‹è¿”å›COROUTINE_SUSPENDEDçŠ¶æ€çš„æ—¶å€™ï¼Œçˆ¶åç¨‹çš„resumeæ–¹æ³•ä¼šç›´æ¥returnäº†ã€‚å½“å­åç¨‹æ‰§è¡Œå®Œåï¼Œä¼šé€šçŸ¥çˆ¶åç¨‹ï¼Œæ­¤æ—¶çˆ¶åç¨‹çš„çš„invokeSuspendæ–¹æ³•å†æ¬¡è¢«æ‰§è¡Œï¼Œè€Œæ­¤æ—¶çš„çŠ¶æ€æœºä¼šå‘ç”Ÿå˜åŒ–ï¼Œå¦‚æœæ­¤æ—¶çŠ¶æ€æ¢å¤åï¼Œä¼šæ‰§è¡Œçˆ¶åç¨‹ä¸­çš„Continuationï¼Œä¹Ÿå°±æ˜¯çˆ¶çˆ¶åç¨‹çš„æ‰§è¡Œã€‚\n","date":"2024-11-15T00:00:00Z","permalink":"http://xiangcman.xyz/p/%E5%8D%8F%E7%A8%8B%E6%8C%82%E8%B5%B7%E5%8E%9F%E7%90%86/","title":"åç¨‹æŒ‚èµ·åŸç†"},{"content":"åœ¨ä¸Šä¸€èŠ‚ä»‹ç»è¿‡Dispatchers.IOï¼Œå®ƒæ˜¯ä¸€ä¸ªCoroutineDispatcherå¯¹è±¡ï¼ŒCoroutineDispatcherçš„æ‰§è¡Œæ˜¯åœ¨DispatchedContinuationä¸­çš„resumeCancellableWithæ–¹æ³•ï¼Œå¦‚æœCoroutineDispatcherçš„isDispatchNeededè¿”å›trueï¼Œåˆ™ä¼šæ‰§è¡ŒCoroutineDispatcherçš„dispatchæ–¹æ³•ã€‚å¦åˆ™ç›´æ¥æ‰§è¡Œè¯¥runnableã€‚\nDispatchers.Main åœ¨å®‰å“å¹³å°ä¸‹ï¼Œå®ƒå…¶å®æ˜¯ä¸€ä¸ªHandlerContextå¯¹è±¡ï¼š çœ‹ä¸‹å®ƒçš„isDispatchNeededå’Œdispatchæ–¹æ³•ï¼š æ­¤æ—¶invokeImmediatelyé»˜è®¤æ˜¯falseï¼Œå› æ­¤isDispatchNeededè¿”å›trueã€‚æ‰€ä»¥ä¼šæ‰§è¡Œå®ƒçš„dispatchæ–¹æ³•ã€‚åœ¨dispatchæ–¹æ³•ä¸­å°†runnableç»™åˆ°äº†ä¸»çº¿ç¨‹çš„æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œç„¶åç­‰ä¸»çº¿ç¨‹ä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­å–è¯¥runnableã€‚æ‰€ä»¥åœ¨ä¸Šä¸€èŠ‚ä¾‹å­ä¸­å®ƒæ˜¯æ™šäºonCreateæ–¹æ³•æ‰§è¡Œçš„ã€‚\nDispatchers.Main.immediate å®ƒæ˜¯HandlerContextä¸­çš„immediateå˜é‡: å¯ä»¥çœ‹åˆ°å®ƒæ˜¯æ–°åˆ›å»ºäº†ä¸€ä¸ªHandlerContextï¼Œå¹¶ä¸”invokeImmediatelyæ˜¯trueã€‚åœ¨ä¸Šä¸€èŠ‚çš„ä¾‹å­ä¸­ï¼Œå®ƒçš„isDispatchNeededè¿”å›falseã€‚æ‰€ä»¥å®ƒæ˜¯ç›´æ¥æ‰§è¡ŒSuspendLambdaçš„resumeWithæ–¹æ³•ï¼Œå› æ­¤ä¸Šä¸€èŠ‚ä¾‹å­ä¸­å®ƒæ˜¯è¦æ—©äºDispatchs.Mainæ‰§è¡Œçš„ã€‚\nDispatchers.IO çœ‹ä¸‹å®ƒçš„CoroutineDispatcherï¼Œå¯¹åº”çš„å­ç±»æ˜¯DefaultIoSchedulerï¼ŒCoroutineDispatcherçš„isDispatchNeededæ–¹æ³•é»˜è®¤è¿”å›trueï¼Œæ‰€ä»¥ä¼šæ‰§è¡Œå®ƒçš„dispatchæ–¹æ³•ï¼š åœ¨dispatchæ–¹æ³•ä¸­è°ƒç”¨äº†defaultçš„dispatchæ–¹æ³•ï¼Œdefaultå®é™…æ˜¯ä¸€ä¸ªLimitedDispatcherå¯¹è±¡ï¼Œçœ‹ä¸‹å®ƒçš„dispatchæ–¹æ³•ï¼š åœ¨ä¸Šé¢2å¤„ï¼Œåˆ¤æ–­å½“å‰runningWokersçš„æ•°é‡ï¼Œå¦‚æœå¤§äºparallelismçš„æ—¶å€™ï¼Œåˆ™ä¸åˆ›å»ºWorkerï¼Œæ­¤å¤„çš„parallelismçš„å¤§å°æ˜¯64ã€‚ä»æ­¤å¤„ä¹Ÿèƒ½çœ‹å‡ºæ¥Dispatchers.IOçš„çº¿ç¨‹æ•°é‡ä¸ä¼šè¶…è¿‡64ä¸ªã€‚ æœ€ç»ˆè¯¥æ–¹æ³•é‡Œé¢ä¼šé€šè¿‡DefaultScheduler.dispatchWithContextæ¥åˆ›å»ºCoroutineSchedulerï¼Œæ¥çœ‹ä¸‹åˆ›å»ºçº¿ç¨‹æ± çš„å‡ ä¸ªå‚æ•°ï¼š æ ¸å¿ƒçº¿ç¨‹æ•°ï¼š æœ€å°2ä¸ªï¼Œæœ€å¤§æ˜¯cpuçš„æ ¸æ•°ã€‚ æœ€å¤§çº¿ç¨‹æ•°ï¼š æœ€å¤§çº¿ç¨‹æ•°å–å€¼(1 shl BLOCKING_SHIFT) - 2ï¼šæœ€ç»ˆå¾—åˆ°çš„å€¼æ˜¯2^21-2 = 2097150ã€‚ éæ ¸å¿ƒçº¿ç¨‹ç©ºé—²æ—¶é—´æ˜¯60sã€‚\nç»“è®ºï¼šDispatchers.IOæŒ‡å®šçš„çº¿ç¨‹æ± æœ€å°‘çº¿ç¨‹æ•°æ˜¯cpuçš„æ ¸æ•°ï¼Œæœ€å¤§çº¿ç¨‹æ•°æ˜¯64ä¸ªã€‚\nDispatchers.Default å®ƒæ˜¯ç”±DefaultScheduleræ„å»ºçš„çº¿ç¨‹æ± ï¼Œå®ƒæ‰€åˆ›å»ºçš„æœ€å¤§çš„çº¿ç¨‹ä¸ªæ•°ä¸º:Math.max(2,cpuæ ¸æ•°)ã€‚ ä¸Šé¢ä¸¤è€…åœ¨æºç ä¸­ä¸»è¦ä½“ç°åœ¨é€šè¿‡CoroutineSchedulerçš„corePoolSizeæ¥æ§åˆ¶æœ€å¤§çº¿ç¨‹æ•°ï¼Œè€Œä¸Šé¢çš„Dispatchers.IOçš„æœ€å¤§64ä¸ªçº¿ç¨‹å…¶å®åœ¨LimitedDispatcherä¸­é€šè¿‡runningWorkersçš„åŸå­ç±»æ¥æ§åˆ¶ç€æœ€å¤§çš„ä»»åŠ¡æ•°ï¼Œå½“è¶…è¿‡64ä¸ªä»»åŠ¡çš„æ—¶å€™ï¼Œå°±ä¸å…è®¸å¾€é‡Œé¢æ·»åŠ äº†ã€‚å®ƒæ˜¯é€šè¿‡æŠŠä»»åŠ¡æ·»åŠ åˆ°queueä¸­ï¼Œå¦‚æœå½“å‰æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡æ•°å°äº64ä¸ªçš„æ—¶å€™ï¼Œæ‰ä¼šä»queueå–èµ°æœ€å‰é¢çš„taskï¼Œå¦‚æœå½“å‰å¤§äºæ­£åœ¨æ‰§è¡Œå¤§äº64ä¸ªï¼Œåˆ™ä¸ä¼šä»queueä¸­å–æœ€å‰é¢çš„taskã€‚\nDispatchers.IOå’ŒDispatchers.Defaultéƒ½æ˜¯ç”±DefaultScheduleræ„å»ºçš„ï¼Œè€ŒDefaultSchedulerå…¶å®æ˜¯ä¸€ä¸ªå•ä¾‹ï¼Œå› æ­¤ä¸éš¾çœ‹å‡ºå®ƒä¸¤æ˜¯å…±ç”¨ä¸€ä¸ªçº¿ç¨‹æ± çš„ï¼Œåªä¸è¿‡å½“Dispatchers.IOæ—¶å€™ï¼Œæœ€å¤§çº¿ç¨‹ä¸ªæ•°æ§åˆ¶åœ¨Math.min(64,cpuæ ¸æ•°)ï¼Œæœ€å¤šä¸ä¼šè¶…è¿‡64ä¸ªï¼ŒDispatchers.Defaultæ§åˆ¶åœ¨cpuæ ¸æ•°ä¸ªæ•°ä¸Šã€‚Dispatchers.Defaultå¸¸ç”¨ä½œcpuå¯†é›†å‹çš„ä»»åŠ¡ï¼Œæ¯”å¦‚å›¾ç‰‡æ¨¡ç³Šå¤„ç†ã€ç¹æ‚çš„è®¡ç®—å‹å¯ä»¥ç”¨è¿™ç§ç±»å‹çš„çº¿ç¨‹æ± ã€‚Dispatchers.IOç”±äºå®ƒçš„çº¿ç¨‹æ•°é‡å¤šï¼Œå¹¶ä¸”å®ƒä¸èƒ½æ¶ˆè€—cpuèµ„æºï¼Œå› æ­¤å¸¸ç”¨ä½œioå¤„ç†ï¼Œæ–‡ä»¶è¯»å†™ç­‰æ“ä½œä¸Šã€‚ å…³äºè¿™ç‚¹ï¼Œå¯ä»¥çœ‹è¿™ç¯‡æ–‡ç« ï¼šdispatcheræ‹†è§£\n","date":"2024-11-13T00:00:00Z","image":"http://xiangcman.xyz/p/%E5%8D%8F%E7%A8%8B%E4%B8%AD%E7%9A%84%E7%BA%BF%E7%A8%8B/cover_hu_398ba822a3953d68.jpg","permalink":"http://xiangcman.xyz/p/%E5%8D%8F%E7%A8%8B%E4%B8%AD%E7%9A%84%E7%BA%BF%E7%A8%8B/","title":"åç¨‹ä¸­çš„çº¿ç¨‹"},{"content":"åœ¨è®²è§£å¦‚ä½•åˆ‡æ¢çº¿ç¨‹ä¹‹å‰ï¼Œæœ‰å¿…è¦å…ˆäº†è§£ä¸‹CoroutineScopeã€‚åç¨‹ä½œç”¨åŸŸï¼Œå®ƒé‡Œé¢æŒæœ‰CoroutineContextï¼Œç”¨æ¥ç®¡ç†å®ƒçš„ä½œç”¨åŸŸèŒƒå›´å†…çš„æ‰€æœ‰åç¨‹ã€‚\nCoroutineScope(åç¨‹ä½œç”¨åŸŸ) CoroutineScopeç»„æˆ å¯è§å®ƒåªæ˜¯ä¸€ä¸ªæ¥å£ï¼Œé‡Œé¢å®šä¹‰äº†ä¸€ä¸ªcoroutineContextã€‚å‰é¢ä»‹ç»è¿‡coroutineContextæ˜¯åç¨‹çš„ä¸Šä¸‹æ–‡ï¼Œå®ƒé‡Œé¢æ˜¯ç”±Elementæ‹¼æ¥è€Œæˆçš„ï¼Œè€ŒElementä¸»è¦åˆ†ä¸ºå¦‚ä¸‹å‡ ç§ï¼š\nCoroutineDispatcherï¼šå®ƒæ˜¯çº¿ç¨‹åˆ†å‘å™¨ã€‚å…¶ä¸­Dispatcher.IOå’ŒDispatcher.Mainã€Dispatchers.Main.immediateéƒ½æ˜¯ç»§æ‰¿è‡ªäºå®ƒ Jobï¼šå®ƒæ˜¯ç”¨æ¥å–æ¶ˆåç¨‹ã€çˆ¶åç¨‹ä¸å­åç¨‹å–å¾—è”ç³»çš„æ¡¥æ¢ã€‚å¸¸è§çš„æœ‰SupervisorJob CoroutineNameï¼šç”¨æ¥ç»™åç¨‹èµ·åå­—çš„ä½œç”¨ CoroutineExceptionHandlerï¼šå®ƒæ˜¯ç”¨æ¥æ•æ‰åç¨‹å¼‚å¸¸çš„å›è°ƒå™¨ æ‰€ä»¥å®Œæ•´çš„CoroutineContextç»„æˆéƒ¨åˆ†å¦‚ä¸‹ï¼š job+dispatchers+CoroutineName+CoroutineExceptionHandler\nCoroutineScopeåˆ†ç±» ç›®å‰kotlinå·²ç»å†…ç½®äº†å„ç§CoroutineScopeï¼Œä¸‹é¢æ¥è¯´ä¸‹ä»–ä»¬çš„åŒºåˆ«\nGlobalScope ä¸Šé¢ç”¨åˆ°çš„GlobalScopeå°±æ˜¯ä¸€ä¸ªåç¨‹ä½œç”¨åŸŸï¼š å¯ä»¥çœ‹å‡ºæ¥å®ƒæ˜¯ä¸€ä¸ªå•ä¾‹çš„scopeï¼Œç”Ÿå‘½å‘¨æœŸå’Œappä¿æŒä¸€è‡´ï¼Œå¹¶ä¸”å®ƒçš„contextæ˜¯ä¸€ä¸ªEmptyCoroutineContextã€‚å¹³æ—¶å¼€å‘æ—¶å€™ä¸ä¼šå»ç”¨å®ƒ\nrunBlocking æ˜¯ä¸€ä¸ªé˜»å¡å¼çš„åç¨‹ä½œç”¨åŸŸï¼Œä¼šé˜»å¡åç¨‹å¤–é¢çš„çº¿ç¨‹ï¼Œå†…éƒ¨æ˜¯é€šè¿‡javaçš„LockSupport.parké˜»å¡ä½çº¿ç¨‹æ¥å®ç°çš„ã€‚ MainScope å®ƒæ˜¯ä¸€ä¸ªæŒ‡å®šåç¨‹åˆ†å‘åœ¨ä¸»çº¿ç¨‹ä¸­ï¼Œå¹¶ä¸”ä½¿ç”¨åˆ°çš„Jobæ˜¯SupervisorJobï¼Œå®ƒçš„ä½œç”¨æ˜¯å½“å­åç¨‹å‡ºé”™çš„æ—¶å€™ï¼Œä¸å½±å“åˆ°çˆ¶åç¨‹ä¸­çš„å…¶ä»–å­åç¨‹ å®ƒæ˜¯ä¸€ä¸ªContextScopeï¼Œç»§æ‰¿è‡ªCoroutineScopeï¼Œå¹¶ä¸”å®ƒçš„contextæ˜¯ç”±SupervisorJob()å’ŒDispatchers.Mainç»„æˆçš„ä¸€ä¸ªcontextã€‚æˆ‘ä»¬ä¸€èˆ¬è‡ªå®šä¹‰CoroutineScopeçš„æ—¶å€™ä¹Ÿæ˜¯å®šä¹‰ä¸€ä¸ªContextScopeï¼Œä»–çš„æ„é€ æ–¹æ³•éœ€è¦ä¼ å…¥ä¸€ä¸ªCoroutineContextã€‚ CoroutineScopeé¡¶çº§æ–¹æ³• å®ƒä¹Ÿæ˜¯ä¸€ä¸ªContextScopeï¼Œå®ƒçš„ä¸Šä¸‹æ–‡å…ˆçœ‹ä¼ è¿›æ¥çš„contextä¸­çš„jobæ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºï¼Œåˆ™åˆå§‹åŒ–ä¸€ä¸ªjobã€‚å¦‚æœä¸ä¸ºç©ºï¼Œåˆ™ä½¿ç”¨ä¼ è¿›æ¥çš„contextã€‚\ncoroutineScopeé¡¶çº§æ–¹æ³• å®ƒæ˜¯ä¸€ä¸ªsuspendæ–¹æ³•ï¼Œå®ƒæ˜¯é€šè¿‡é—­åŒ…çš„å½¢å¼è¿”å›ä¸€ä¸ªCoroutineScopeï¼Œå¯¹åº”çš„å­—èŠ‚ç å¦‚ä¸‹ï¼š ä¼šå°†ScopeCoroutineç»™åˆ°blockï¼Œä¹Ÿå°±æ˜¯é—­åŒ…ä¸­çš„CoroutineScopeï¼Œæ¥ç€ä¼šè°ƒç”¨UndispatchedKt.startUndispatchedOrReturn: æœ€ç»ˆè°ƒç”¨äº†block.invokeæ–¹æ³•ï¼Œå†™ä¸ªdemoçœ‹ä¸‹æ•ˆæœï¼š æ—¥å¿—å¦‚ä¸‹ï¼š ä»æ—¥å¿—å¯ä»¥çœ‹å‡ºæ¥ï¼Œå®ƒæ˜¯å…ˆç­‰åˆ°coroutineScopeé‡Œé¢delayæ‰§è¡Œå®Œäº†ï¼Œæ‰æ‰§è¡Œå¤–é¢çš„é€»è¾‘ã€‚åœ¨å­—èŠ‚ç å±‚é¢ï¼Œå®ƒä¼šæŠŠcoroutineScopeå¤–é¢çš„ä»£ç ç¼–è¯‘æˆSuspendLambdaï¼Œå®ƒä¹Ÿæ˜¯ä¸ªContinuationï¼Œç­‰åˆ°æ‰§è¡Œå®Œäº†coroutineScopeå†…éƒ¨çš„ä»£ç ï¼Œæ‰ä¼šå›è°ƒåˆ°coroutineScopeå¤–é¢çš„SuspendLambdaä¸­æ¥ï¼š ä¸Šé¢åˆ†æè¿‡UndispatchedKt.startUndispatchedOrReturnä¸­è°ƒç”¨äº†blockçš„invokeæ–¹æ³•ï¼Œæ­¤å¤„çš„blockæ­£å¯¹åº”äº†CoroutineDispatchersActivity$demo7$1è¿™ä¸ªSuspendLambdaå¯¹è±¡ï¼š åœ¨demo7ä¸­å°†CoroutineDispatchersActivity$demo7$1è¿™ä¸ªcontinuationä¼ é€’åˆ°coroutineScopeä¸­ï¼Œè€Œå®ƒçš„invokeæ–¹æ³•å¦‚ä¸‹ï¼š åˆ›å»ºäº†CoroutineDispatchersActivity$demo7$1åï¼Œç»§è€Œè°ƒç”¨äº†invokeSuspendæ–¹æ³•ï¼Œè€ŒinvokeSuspendé‡Œé¢æ˜¯è¦ç­‰åˆ°coroutineScopeé—­åŒ…ä¸­çš„delayæŒ‚èµ·ç»“æŸåï¼Œæ‰ä¼šå†æ¬¡å›åˆ°invokeSuspendæ–¹æ³•ï¼Œæœ€åæ‰ä¼šè¾“å‡ºã€Œdemo7: coroutineScope outsideã€çš„æ—¥å¿—ï¼Œè¿™ä¹Ÿæ˜¯åç¨‹æŒ‚èµ·çš„è°ƒç”¨é¡ºåºã€‚\nsupervisorScopeé¡¶çº§æ–¹æ³• å®ƒå’Œä¸Šé¢çš„coroutineScopeé¡¶çº§æ–¹æ³•å·®ä¸å¤šï¼Œä¹Ÿæ˜¯å…ˆè°ƒç”¨å®Œé—­åŒ…ä¸­çš„é€»è¾‘ï¼Œç„¶åæ‰æ‰§è¡ŒsupervisorScopeå¤–é¢çš„ä»£ç ã€‚çœ‹ä¸‹å®ƒçš„å®ç°å°±çŸ¥é“åŒºåˆ«äº†ï¼š ä»–æ‰€ä½¿ç”¨çš„CoroutineScopeæ˜¯ä¸€ä¸ªSupervisorCoroutineï¼Œå®ƒå’Œä¸Šé¢ç”¨åˆ°çš„ScopeCoroutineåŒºåˆ«æ˜¯é‡å†™äº†childCancelledæ–¹æ³•ï¼Œå¹¶è¿”å›falseï¼Œæ­¤æ–¹æ³•æ˜¯å­åç¨‹å‘ç”Ÿå¼‚å¸¸åï¼Œè¯¥ä¸è¯¥å–æ¶ˆå…¶å®ƒçš„å­åç¨‹ï¼Œä¸‹é¢æ¥éªŒè¯ä¸‹ï¼š åœ¨supervisorScopeé—­åŒ…ä¸­launch1å‘ç”Ÿå¼‚å¸¸äº†ï¼Œç”±äºsupervisorScopeä¸ä¼šå»å¤„ç†å¼‚å¸¸ï¼Œå°†å¼‚å¸¸äº¤ç»™äº†launch1å¤„ç†ï¼Œæ‰€ä»¥launch2ä¸­çš„ä»£ç èƒ½ç»§ç»­æ‰§è¡Œã€‚è€Œåœ¨coroutineScopeä¸­ï¼Œå½“launch1å‘ç”Ÿå¼‚å¸¸çš„æ—¶å€™ï¼Œä¼šå°†å¼‚å¸¸äº¤ç»™äº†coroutineScopeï¼Œæœ€ç»ˆå¯¼è‡´launch2çš„åç¨‹æ— æ³•ç»§ç»­æ‰§è¡Œã€‚\nJob Jobå®ç°äº†CoroutineContext.Elementï¼Œå¯ä»¥ç”¨æ¥å–æ¶ˆã€å¯åŠ¨ä¸€ä¸ªåç¨‹ï¼Œå¹¶ä¸”å’Œçˆ¶åç¨‹ç»‘å®šäº†å…³ç³»ï¼š å®ƒä¸‹é¢æœ‰å‡ ä¸ªå…³é”®çš„å­ç±»ï¼š ä»å›¾ä¸Šå¯ä»¥çœ‹å‡ºæ¥å‰é¢åˆ†æçš„coroutineScopeå’ŒsupervisorScopeä¸¤ä¸ªé¡¶çº§æ–¹æ³•æ‰€ä½¿ç”¨çš„ä½œç”¨åŸŸScopeCoroutineæœ€ç»ˆä¹Ÿæ˜¯ä¸€ä¸ªJobã€‚\nçº¿ç¨‹ä¾‹å­ å…ˆçœ‹ä¸€ä¸ªä¾‹å­ï¼š åˆ†åˆ«æŒ‡å®šäº†å››ç§çº¿ç¨‹çš„ç”¨æ³•ï¼Œæ—¥å¿—å¦‚ä¸‹ï¼š ç¬¬ä¸€æ¬¡ï¼š ç¬¬äºŒæ¬¡ï¼š Dispatchers.Main.immediateï¼šæŒ‡å®šçš„ä¸»çº¿ç¨‹ä¼šæœ€å…ˆæ‰§è¡Œ Dispatchers.Mainï¼šæŒ‡å®šçš„ä¸»çº¿ç¨‹ä¼šæ™šäºåç¨‹å¤–é¢çš„ä¸»çº¿ç¨‹ Dispatchers.IOå’ŒDispatchers.Defaultï¼šæŒ‡å®šçš„çº¿ç¨‹æ²¡æœ‰å…ˆåä¹‹åˆ†\nCoroutineScope.lanuch lanuchæ–¹æ³•æ˜¯åç¨‹ä½œç”¨åŸŸçš„æ‰©å±•æ–¹æ³•ï¼Œæ¯”å¦‚ä¸Šé¢ä¾‹å­ä¸­çš„GlobalScopeå®ƒå°±æ˜¯ç»§æ‰¿è‡ªCoroutineScope:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 public fun CoroutineScope.launch( context: CoroutineContext = EmptyCoroutineContext, start: CoroutineStart = CoroutineStart.DEFAULT, block: suspend CoroutineScope.() -\u0026gt; Unit ): Job { //â‘  val newContext = newCoroutineContext(context) //â‘¡ val coroutine = if (start.isLazy) LazyStandaloneCoroutine(newContext, block) else StandaloneCoroutine(newContext, active = true) //â‘¢ coroutine.start(start, coroutine, block) //â‘£ return coroutine } å‚æ•°ï¼š contextï¼šlauncä¼ è¿›æ¥çš„contextï¼Œæ¯”å¦‚ä¸Šé¢ä¾‹å­ä¸­ä¼ è¿›æ¥çš„Dispatchers.Mainã€Dispatchers.IOè¿™äº›éƒ½æ˜¯CoroutineContextã€‚å¦‚æœæ²¡ä¼ å°±ç”¨EmptyCoroutineContextã€‚ startï¼šCoroutineStartçš„æšä¸¾ç±»ï¼Œè¡¨ç¤ºå¯åŠ¨æ¨¡å¼ï¼Œé»˜è®¤æ˜¯DEFAULT blockï¼šåç¨‹ä»£ç å—ï¼Œæ˜¯ä¸€ä¸ªCoroutineScopeçš„æ‰©å±•æŒ‚èµ·å‡½æ•° å°†å¤–ç•Œä¼ è¿›æ¥çš„contextå’Œå½“å‰CoroutineScopeçš„contextè¿›è¡Œåˆå¹¶å¤„ç† é»˜è®¤æ˜¯DEFAULTæ¨¡å¼ï¼Œæ‰€ä»¥ä¼šåˆå§‹åŒ–ä¸€ä¸ªStandaloneCoroutineï¼Œä¼šæŠŠnewContextä½œä¸ºè‡ªå·±çš„parentContextï¼Œå®ƒæ—¢æ˜¯ä¸€ä¸ªContinuationï¼Œä¹Ÿæ˜¯ä¸€ä¸ªCoroutineScope è°ƒç”¨StandaloneCoroutineçš„startæ–¹æ³•ï¼Œå¹¶æŠŠå¯åŠ¨æ¨¡å¼ï¼ŒStandaloneCoroutineï¼Œåç¨‹æŒ‚èµ·å‡½æ•°ä¼ è¿›å»äº† StandaloneCoroutineä½œä¸ºlauchçš„è¿”å›å€¼ StandaloneCoroutineå®ƒæ˜¯ä¸€ä¸ªJobç±»å‹ï¼Œä¹Ÿæ˜¯ç»§æ‰¿è‡ªAbstractCoroutineï¼Œçœ‹ä¸‹å®ƒçš„startæ–¹æ³•ï¼š è¿™é‡Œè°ƒç”¨äº†startå˜é‡çš„invokeæ–¹æ³•ï¼Œå› ä¸ºCoroutineStarté‡å†™äº†invokeæ–¹æ³•ï¼Œæ‰€ä»¥èƒ½ç›´æ¥è¿™ä¹ˆè°ƒï¼Œç›¸å½“äºæ˜¯ä¸€ä¸ªé—­åŒ…çš„è°ƒç”¨æ–¹å¼ï¼Œè¿™é‡Œè°ƒç”¨äº†ä¸‰å‚çš„invokeï¼š ç¬¬ä¸€ä¸ªå‚æ•°ï¼šæŒ‚èµ·å‡½æ•°é—­åŒ…ï¼Œä¹Ÿå°±æ˜¯åç¨‹è¦æ‰§è¡Œçš„ä»£ç å— ç¬¬äºŒä¸ªå‚æ•°ï¼šstartæ–¹æ³•ä¼ è¿›æ¥çš„StandaloneCoroutine ç¬¬ä¸‰ä¸ªå‚æ•°ï¼šstartæ–¹æ³•ä¼ è¿›æ¥çš„thisï¼Œä¹Ÿæ˜¯StandaloneCoroutine CoroutineStartæ˜¯DEFAULTç±»å‹ï¼Œæ‰€ä»¥ä¼šè°ƒç”¨æŒ‚èµ·å‡½æ•°çš„startCoroutineCancellableæ–¹æ³•ï¼š åœ¨ä¸Šé¢åˆ†æcreateCoroutineæ—¶å€™ä¹Ÿæ˜¯é€šè¿‡createCoroutineUnintercepted(receiver, completion).intercepted()ï¼Œåˆ›å»ºäº†delegateï¼Œæœ€ç»ˆæ˜¯ä¸€ä¸ªContinuationï¼Œä¹Ÿæ˜¯ä¸€ä¸ªsuspendLambdaã€‚æˆ‘ä»¬ç›´æ¥çœ‹ContinuationImplçš„interceptedæ–¹æ³•ï¼š interceptedæ–¹æ³•é‡Œé¢å–contextå˜é‡ä¸­çš„keyä¸ºContinuationInterceptorçš„contextï¼Œè€Œcontextæœ€ç»ˆæ˜¯completionçš„contextï¼Œcompletionæ˜¯å‰é¢startæ–¹æ³•ä¼ è¿›æ¥çš„StandaloneCoroutineï¼Œå®ƒæ˜¯ç»§æ‰¿è‡ªAbstractCoroutineï¼š parentContextæ˜¯launchæ–¹æ³•ä¼ è¿›æ¥çš„context+CoroutineScopeè‡ªå·±çš„contextæ‹¼æ¥çš„ä¸€ä¸ªcontext thisï¼šAbstractCoroutineå®ç°äº†jobæ¥å£ï¼Œjobä¹Ÿæ˜¯ä¸€ä¸ªCoroutineContext åœ¨ä¸Šé¢ä¾‹å­ä¸­lauchæ–¹æ³•æ˜¯é€šè¿‡GlobalScopeå¯åŠ¨çš„ï¼Œå®ƒçš„contextæ˜¯ä¸€ä¸ªEmptyCoroutineContextï¼Œæ‰€ä»¥ä¼ ç»™AbstractCoroutineçš„parentContextå…¶å®å°±æ˜¯launchæ–¹æ³•ä¼ è¿›å»çš„contextï¼Œä¹Ÿå°±æ˜¯Dispatchers.ioã€Dispatchers.mainç­‰ã€‚ å›åˆ°ContinuationImplçš„interceptedæ–¹æ³•ï¼Œå–contextçš„ContinuationInterceptor,ç„¶åè°ƒç”¨interceptContinuationæ–¹æ³•ï¼Œçœ‹ä¸‹Dispatchers.ioï¼Œå®ƒæœ€ç»ˆç»§æ‰¿è‡ªCoroutineDispatcherï¼š ç»“è®ºï¼š å¦‚æœlauchä¼ çš„æ˜¯Dispatchers.ioï¼Œåˆ™lauchå…ˆåˆ›å»ºDispatchedContinuationï¼Œç„¶åè°ƒç”¨resumeCancellableWithæ–¹æ³•ï¼š å¦‚æœdispatcher.isDispatchNeededï¼ˆé»˜è®¤æ˜¯trueï¼‰ï¼Œæ‰ä¼šè¿›å…¥åˆ°dispatché€»è¾‘ï¼Œçœ‹ä¸‹dispatchers.ioï¼š è°ƒç”¨äº†default.dispatchæ–¹æ³•ï¼Œdiefaultæ˜¯ç”±UnlimitedIoScheduler.limitedParallelismåˆ›å»ºçš„LimitedDispatcherï¼Œæœ€ç»ˆä¼šæ‰§è¡Œåˆ°UnlimitedIoScheduler.dispatchæ–¹æ³•ï¼š DefaultSchedulerçš„dispatchWithContextæ–¹æ³•å¦‚ä¸‹ï¼š coroutineScheduleråˆ›å»ºå¦‚ä¸‹ï¼š æœ€ç»ˆä¼šæ‰§è¡Œåˆ°CoroutineSchedulerçš„dispatchæ–¹æ³•ï¼Œé‡Œé¢çš„ä»£ç å°±ä¸ç»†çœ‹äº†ï¼Œæ˜¯çº¿ç¨‹æ± éƒ¨åˆ†æ‰§è¡Œblockï¼Œå…³äºè¿™éƒ¨åˆ†åé¢å¯ä»¥æ·±ç©¶ä¸‹ï¼Œè€Œblockæ˜¯åœ¨DispatchedContinuationä¸­resumeCancellableWithæ–¹æ³•é‡Œé¢æŠŠthisç»™åˆ°äº†dispatcherçš„dispatchæ–¹æ³•ï¼Œè¯´æ˜DispatchedContinuationå®ç°äº†Runnableæ¥å£ï¼Œç›´æ¥çœ‹å®ƒçš„runæ–¹æ³•ï¼Œè¯¥æ–¹æ³•å®šä¹‰åœ¨å®ƒçš„çˆ¶ç±»DispatchedTaskä¸­ï¼š æ­¤å¤„æ‰§è¡Œäº†delegateçš„resumeæ–¹æ³•ï¼Œresumeæ–¹æ³•æ‰§è¡Œäº†resumeWithï¼Œæ³¨æ„æ­¤å¤„çš„delegateæ˜¯DispatchedContinuationä¸­ä¼ è¿›æ¥çš„continuationï¼Œå®ƒæ˜¯createCoroutineUnintercepted(receiver, completion).intercepted()åˆ›å»ºçš„delegateï¼Œæ˜¯ä¸€ä¸ªcontinuationå¯¹è±¡ï¼Œä¹Ÿæ˜¯suspendlambdaï¼Œåœ¨ä¸Šé¢åˆ›å»ºåç¨‹åˆ†æè¿‡baseContinuationImplçš„resumeWithæ–¹æ³•ï¼Œé‡Œé¢ä¼šæ‰§è¡Œåç¨‹çš„invokeSuspendæ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„åç¨‹æ‰§è¡Œä»£ç ã€‚æ‰§è¡Œå®Œäº†åä¼šæ‰§è¡Œcompleteçš„resumeWithï¼Œè€Œé€šè¿‡lauchåˆ›å»ºçš„åç¨‹ï¼Œæ­¤å¤„çš„completeæ˜¯launchæ–¹æ³•æ„é€ çš„StandaloneCoroutineå¯¹è±¡ï¼Œå®ƒçš„resumeWithæ–¹æ³•å®šä¹‰åœ¨AbstractCoroutineä¸­ï¼š AbstractCoroutineçš„afterCompletionï¼š æ­¤å¤„æ²¡æœ‰é€»è¾‘æ‰§è¡Œã€‚ æˆ‘ä»¬æ³¨æ„åˆ°åœ¨è®²è§£åç¨‹å¯åŠ¨çš„æ—¶å€™ï¼Œåˆ›å»ºdelegateçš„continuationæ—¶å€™è°ƒç”¨createCoroutineUninterceptedåªä¼ äº†completeï¼Œæ²¡æœ‰ä¼ receiverã€‚è€Œåœ¨launchå¯åŠ¨åç¨‹æ—¶å€™ï¼Œå°†StandaloneCoroutineä½œä¸ºreceiverä¼ ç»™äº†createCoroutineUninterceptedæ–¹æ³•ï¼š é»˜è®¤çš„æŒ‚èµ·å‡½æ•°çš„createæ–¹æ³•æ˜¯æŠ›å¼‚å¸¸çš„ï¼Œéœ€è¦SuspendLambdaçš„å­ç±»è‡ªå·±å»å®ç°ï¼š ç¼–è¯‘åçš„SuspendLambdaçš„å­ç±»createå®ç°ï¼š æ­¤å¤„å°†receiverä¼ åˆ°createä¸­æ²¡æœ‰ç”¨åˆ°ï¼Œæ‰€ä»¥å…¶å®è·Ÿå•å‚æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«å•Šã€‚\næ€»ç»“ ç»“è®ºï¼šåç¨‹åœ¨å¯åŠ¨è¿‡ç¨‹ä¸­ä¼šå–CoroutineContextä¸­çš„ContinuationInterceptorï¼Œç„¶åæ‰§è¡ŒinterceptContinuationã€‚è€Œæ­¤æ—¶å¦‚æœæ˜¯ä¸€ä¸ªDispatchers.IOï¼Œå®ƒåˆæ˜¯ç»§æ‰¿è‡ªCoroutineDispatcherï¼Œæ‰€ä»¥ä¼šæ‰§è¡Œåˆ°äº†CoroutineDispatcherçš„interceptContinuationã€‚æ­¤æ—¶å¾—åˆ°çš„æ˜¯ä¸€ä¸ªDispatchedContinuationå¯¹è±¡ï¼Œå¹¶æŠŠå½“å‰çš„CoroutineDispatcherå’Œåç¨‹å¯åŠ¨è¿‡ç¨‹ä¸­åˆ›å»ºçš„StandaloneCoroutineä¼ ç»™äº†DispatchedContinuationã€‚æ¥ç€ä¼šæ‰§è¡ŒDispatchedContinuationçš„resumeCancellableWithæ–¹æ³•ï¼Œåœ¨è¯¥æ–¹æ³•é‡Œé¢ä¼šåˆ¤æ–­CoroutineDispatcher.isDispatchNeededï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œä¼šè°ƒç”¨CoroutineDispatcherçš„dispatchæ–¹æ³•ï¼Œæœ€ç»ˆä¼šé€šè¿‡çº¿ç¨‹æ± ä¼šæ‰§è¡Œåˆ°DispatchedContinuationçš„runæ–¹æ³•ï¼Œå› ä¸ºå®ƒæ˜¯ä¸€ä¸ªRunnableå¯¹è±¡ã€‚åœ¨runæ–¹æ³•é‡Œé¢ï¼Œä¼šæ‰§è¡Œcontinuationçš„resumeæ–¹æ³•ï¼Œè€Œæ­¤å¤„çš„continuationæ˜¯ç¼–è¯‘å™¨ç»™æˆ‘ä»¬åˆ›å»ºçš„SuspendLambdaçš„å­ç±»ï¼Œæœ€ç»ˆä¼šæ‰§è¡Œå®ƒçš„invokeSuspendæ–¹æ³•ã€‚æ‰§è¡Œå®Œåä¼šæ‰§è¡Œåç¨‹å¯åŠ¨è¿‡ç¨‹ä¸­çš„StandaloneCoroutineçš„resumeWithæ–¹æ³•ã€‚\næ—¶åºå›¾: ","date":"2024-11-05T00:00:00Z","permalink":"http://xiangcman.xyz/p/%E5%8D%8F%E7%A8%8B%E5%A6%82%E4%BD%95%E5%88%87%E6%8D%A2%E7%BA%BF%E7%A8%8B/","title":"åç¨‹å¦‚ä½•åˆ‡æ¢çº¿ç¨‹"},{"content":" åœ¨è®²åç¨‹çš„å¦‚ä½•åˆ‡æ¢çº¿ç¨‹ä¹‹å‰ï¼Œæœ‰å¿…è¦å…ˆäº†è§£ä¸‹åç¨‹çš„ä¸Šä¸‹æ–‡æ˜¯ä»€ä¹ˆï¼Ÿå®ƒçš„ç»“æ„æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿä»¥åŠæˆ‘ä»¬å¦‚ä½•ä½¿ç”¨å®ƒï¼Ÿä»Šå¤©å¸¦ç€è¯¥é—®é¢˜æ¥è®¤è¯†å®ƒã€‚\nCoroutineContext åç¨‹ä¸Šä¸‹æ–‡éƒ½æ˜¯ç»§æ‰¿è‡ªCoroutineContextï¼Œå®ƒæ˜¯ä¸€ä¸ªæ¥å£ï¼Œå†…éƒ¨æ–¹æ³•ä»¥åŠå†…éƒ¨ç±»å¦‚ä¸‹ï¼š\nå®ƒçš„å®ç°å­ç±»æœ‰å¦‚ä¸‹ï¼š\næ¯”å¦‚æˆ‘ä»¬å¸¸è§çš„EmptyCoroutineContextï¼Œå®ƒçš„å†…éƒ¨å®ç°å¦‚ä¸‹ï¼š\nå¯ä»¥çœ‹åˆ°å®ƒçš„getã€foldã€plusã€minusKeyå‡ ä¸ªæ–¹æ³•éƒ½æ˜¯é»˜è®¤å®ç°ï¼Œä½ å¯ä»¥ç†è§£å®ƒå°±æ˜¯ä¸ªç©ºå£³å­çš„contextã€‚\nElement åœ¨è®²CoroutineContextå†…éƒ¨ç»“æ„ä¹‹å‰ï¼Œå…ˆæ¥è®¤è¯†ä¸‹Elementï¼Œå®ƒä¹Ÿå®ç°äº†CoroutineContextæ¥å£ï¼š\nElementä¸­æœ‰ä¸€ä¸ªkeyçš„å±æ€§ï¼Œè¿™é‡Œå¯ä»¥ç†è§£keyå°±æ˜¯å½“å‰Elementçš„å”¯ä¸€æ ‡è¯†ã€‚å®ç°ä¸€ä¸ªcontextçš„æ—¶å€™éœ€è¦æŒ‡æ˜å®ƒçš„keyæ˜¯å•¥ï¼Œæ­¤å¤„å°±æ˜¯ç”¨è¯¥keyæ¥æ ‡è¯† getï¼šå¦‚æœä¼ è¿›æ¥çš„keyå’Œè‡ªå·±çš„keyç›¸ç­‰ï¼Œåˆ™è¿”å›è‡ªå·±ï¼Œå¦åˆ™è¿”å›null foldï¼šå°†åˆå§‹å€¼å’Œå½“å‰elementè¿”å›ç»™lambdaï¼Œè®©lambdaè‡ªå·±å»å¤„ç† minusKeyï¼šå¦‚æœä¼ è¿›æ¥çš„keyå’Œè‡ªå·±ç›¸åŒï¼Œåˆ™è¿”å›EmptyCoroutineContextï¼Œå¦åˆ™è¿”å›è‡ªå·±ï¼Œå…¶å®æ˜¯åˆ é™¤å¯¹åº”keyçš„context.\nå†™äº†3ä¸ªcontextï¼Œç„¶åç”¨\u0026quot;+\u0026ldquo;æ‹¼æ¥ï¼š\nè‡ªå®šä¹‰contextçš„æ—¶å€™ï¼Œéœ€è¦ç»§æ‰¿è‡ªAbstractCoroutineContextElementï¼Œå®ƒæ˜¯ç»§æ‰¿è‡ªElementï¼Œå› ä¸ºå®ƒå¼ºåˆ¶è¦æ±‚éœ€è¦ä¸€ä¸ªkeyä½œä¸ºcontextçš„æ ‡è¯†ï¼Œä¸€èˆ¬keyçš„elementæ ‡è¯†æ˜¯å½“å‰contextï¼Œçœ‹ä¸Šé¢çš„Oneè¿™ä¸ªcontextï¼Œå®ƒçš„keyæ‹¥æœ‰çš„elementæ˜¯Oneã€‚\nè¾“å‡ºæ—¥å¿—å¦‚ä¸‹ï¼š\nOne()+Two()+Three()å¾—åˆ°çš„æ˜¯ä¸€ä¸ªCombinedContextï¼Œgetæ–¹æ³•é€šè¿‡Oneè¿™ä¸ªkeyå–åˆ°äº†Oneè¿™ä¸ªå–å¯¹åº”çš„Context\næ—¥å¿—å¦‚ä¸‹ï¼š å¯ä»¥çœ‹åˆ°æˆ‘ç»™Oneçš„contextæ‹¼æ¥äº†ä¸€ä¸ªEmptyCoroutineContextæ—¶å€™ï¼Œå¾—åˆ°çš„æ˜¯å®ƒè‡ªå·±ï¼Œ\u0026quot;+\u0026ldquo;æ˜¯é‡è½½äº†contextçš„plusæ–¹æ³•ï¼Œçœ‹ä¸‹plusæ–¹æ³•çš„å®ç°ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 public operator fun plus(context: CoroutineContext): CoroutineContext = //â‘  if (context === EmptyCoroutineContext) this else // fast path -- avoid lambda creation //â‘¡ context.fold(this) { acc, element -\u0026gt; //â‘¢ val removed = acc.minusKey(element.key) //â‘¢.1 if (removed === EmptyCoroutineContext) element else { // make sure interceptor is always last in the context (and thus is fast to get when present) //â‘£ val interceptor = removed[ContinuationInterceptor] //â‘¤ if (interceptor == null) CombinedContext(removed, element) else { //â‘¥ val left = removed.minusKey(ContinuationInterceptor) //â‘¦ if (left === EmptyCoroutineContext) CombinedContext(element, interceptor) else //â‘§ CombinedContext(CombinedContext(left, element), interceptor) } } } 1.å¦‚æœä¼ è¿›æ¥çš„contextæ˜¯EmptyCoroutineContextï¼Œåˆ™è¿”å›è‡ªå·±ï¼Œæ‰€ä»¥ä¸Šé¢çš„One()+EmptyCoroutineContextï¼Œå¾—åˆ°çš„æ˜¯Oneè¿™ä¸ªcontext 2.context.foldï¼Œä¼šæŠŠåˆå§‹å€¼å’Œcontextä¼ ç»™é—­åŒ…ï¼Œæ‰€ä»¥accæ˜¯å½“å‰contextï¼Œelementæ˜¯ä¼ è¿›æ¥çš„context 3.acc.minuskey(element.key)ï¼Œå¦‚æœä¼ è¿›æ¥çš„contextçš„keyå’Œå½“å‰contextçš„keyç›¸ç­‰ï¼Œåˆ™è¿”å›ä¼ è¿›æ¥çš„contextï¼Œæ‰€ä»¥æ–°çš„contextä¼šæŠŠæ—§çš„contextç»™è¦†ç›–æ‰äº† 4.å¦‚æœä¼ è¿›æ¥çš„contextçš„keyå’Œå½“å‰contextçš„keyä¸ç›¸ç­‰ï¼Œremovedåˆ™æ˜¯å½“å‰contextï¼ŒæŸ¥çœ‹å½“å‰contextä¸­æ˜¯å¦æœ‰ContinuationInterceptorç±»å‹çš„contextï¼Œæˆ‘ä»¬çš„dispatcheréƒ½æ˜¯å±äºè¯¥ç±»å‹ï¼Œéœ€è¦å•ç‹¬å¤„ç† 5.å¦‚æœcontextä¸­æ²¡æœ‰ContinuationInterceptorç±»å‹çš„contextï¼Œåˆ™åˆå§‹åŒ–å‡ºä¸€ä¸ªCombinedContextçš„contextï¼Œæ‰€ä»¥ä¸Šé¢çš„One()+Two()+Three()æ˜¯ä¸€ä¸ªCombinedContextçš„context 6.å¦‚æœå½“å‰contextä¸­å­˜åœ¨ContinuationInterceptorç±»å‹çš„contextï¼Œåˆ™ç»§ç»­åˆ¤æ–­å½“å‰contextæ˜¯ä¸æ˜¯ContinuationInterceptorç±»å‹çš„context 7.å¦‚æœæ˜¯ContinuationInterceptorç±»å‹çš„contextï¼Œåˆ™æŠŠä¼ è¿›æ¥çš„contextå’Œå½“å‰çš„contextç»„åˆæˆCombinedContextçš„context 8.å¦‚æœå½“å‰çš„contextä¸æ˜¯ä¸€ä¸ªContinuationInterceptorç±»å‹çš„contextï¼Œåˆ™æŠŠå½“å‰å½“å‰çš„contextå’Œä¼ è¿›æ¥çš„contextæ–°ç»„åˆæˆä¸€ä¸ªCombinedContextçš„contextï¼Œå†å’Œå‰é¢çš„ContinuationInterceptorç»„åˆæˆä¸€ä¸ªæ–°çš„CombinedContextçš„context\nCombinedContext 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 internal class CombinedContext( private val left: CoroutineContext, private val element: Element ) : CoroutineContext, Serializable { override fun \u0026lt;E : Element\u0026gt; get(key: Key\u0026lt;E\u0026gt;): E? { var cur = this while (true) { cur.element[key]?.let { return it } val next = cur.left if (next is CombinedContext) { cur = next } else { return next[key] } } } public override fun \u0026lt;R\u0026gt; fold(initial: R, operation: (R, Element) -\u0026gt; R): R = operation(left.fold(initial, operation), element) public override fun minusKey(key: Key\u0026lt;*\u0026gt;): CoroutineContext { //â‘  element[key]?.let { return left } //â‘¡ val newLeft = left.minusKey(key) return when { //â‘¢ newLeft === left -\u0026gt; this //â‘£ newLeft === EmptyCoroutineContext -\u0026gt; element //â‘¤ else -\u0026gt; CombinedContext(newLeft, element) } } override fun toString(): String = \u0026#34;[\u0026#34; + fold(\u0026#34;\u0026#34;) { acc, element -\u0026gt; if (acc.isEmpty()) element.toString() else \u0026#34;$acc, $element\u0026#34; } + \u0026#34;]\u0026#34; } å®ƒæ˜¯ç›´æ¥ç»§æ‰¿è‡ªCoroutineContextï¼Œæœ‰ä¸¤ä¸ªæ¯”è¾ƒé‡è¦çš„å±æ€§ï¼š\nleftï¼šCoroutineContextï¼Œå®ƒæ˜¯å·¦è¾¹çš„èŠ‚ç‚¹\nelementï¼šElementï¼Œå½“å‰èŠ‚ç‚¹\nå…¶å®å’Œé“¾è¡¨çš„ç»“æ„æœ‰ç‚¹ç±»ä¼¼ï¼Œleftç›¸å½“äºnextèŠ‚ç‚¹ã€‚\ngetï¼šé€’å½’èŠ‚ç‚¹ï¼Œç›´åˆ°leftèŠ‚ç‚¹ä¸æ˜¯CombinedContextç±»å‹çš„\nfoldï¼šå…ˆæŠŠleftå’Œåˆå§‹å€¼ç»„æˆä¸€ä¸ªåˆå§‹å€¼ï¼Œç„¶åå†æŠŠè¿™ä¸ªåˆå§‹å€¼å’Œå½“å‰èŠ‚ç‚¹ä¼ ç»™é—­åŒ…\nminusKeyï¼š\n1.å¦‚æœå½“å‰èŠ‚ç‚¹ä¸­æ‰¾åˆ°äº†è¯¥keyï¼Œåˆ™è¿”å›leftèŠ‚ç‚¹\n2.å¦‚æœæ‰¾ä¸åˆ°ï¼Œåˆ™ç»§ç»­åœ¨leftèŠ‚ç‚¹ä¸­æ‰¾\n3.å¦‚æœæ‰¾ä¸åˆ°è¿”å›this\n4.å¦‚æœæ‰¾åˆ°äº†åˆ™è¿”å›å½“å‰èŠ‚ç‚¹\n5.å¦åˆ™ç»§ç»­å¾€å·¦è¾¹å†æ‰¾\næ•´ä¸ªåˆ†ææ¥çœ‹ï¼Œåç¨‹ä¸­çš„contextå¦‚æœæ˜¯å¤šä¸ªcontextæ‹¼æ¥çš„æ—¶å€™å¦‚æœä¼ è¿›æ¥çš„æ˜¯EmptyCoroutineContextï¼Œåˆ™åªä¿å­˜è‡ªå·±ã€‚å¦‚æœä¼ è¿›æ¥çš„contextçš„keyå’Œå½“å‰contextçš„keyä¸€æ ·ï¼Œåˆ™ä¼šè¦†ç›–æ‰åŸæ¥çš„contextã€‚å¦‚æœéƒ½ä¸æ»¡è¶³ï¼Œåˆ™é‡‡ç”¨é“¾è¡¨çš„å½¢å¼æ’å…¥åˆ°åŸæ¥çš„contextå¤´èŠ‚ç‚¹ä¸Šï¼Œå¦‚æœä¼ è¿›æ¥çš„æ˜¯ContinuationInterceptorç±»å‹çš„ï¼Œåˆ™ä¼šæŠŠè¯¥ç±»å‹æ”¾åˆ°å¤´èŠ‚ç‚¹ã€‚\næ€»ç»“ CoroutineContextæ˜¯åç¨‹é‡è¦çš„å¯¹è±¡ï¼Œå®ƒé€šè¿‡é‡è½½äº†plusæ–¹æ³•ï¼Œè½»æ¾çš„å°†æ¯ä¸€ä¸ªCoroutineContextæ‹¼æ¥æˆä¸€ä¸ªæ–°çš„CoroutineContextï¼Œä¸€èˆ¬çš„CoroutineContextä¼šåˆ†ä¸ºEmptyCoroutineContextï¼Œå®ƒæ˜¯ç›´æ¥å®ç°äº†CoroutineContextæ¥å£ï¼Œå¯ä»¥ç†è§£å®ƒæ˜¯æ²¡æœ‰ä»»ä½•ä¿¡æ¯çš„CoroutineContextã€‚è€ŒElementæ˜¯å¸¦æœ‰keyçš„CoroutineContextï¼Œæ‰€ä»¥å¦‚æœå¾€CoroutineContextæ·»åŠ ä¸€ä¸ªElementä¼šé€šè¿‡å®ƒçš„keyæ¥æ‰¾åˆ°å¯¹åº”çš„Elementï¼ŒElementä¸‹é¢å¸¸è§çš„å­ç±»æœ‰ContinuationInterceptorï¼Œå®ƒæ˜¯æˆ‘ä»¬åç¨‹åˆ‡æ¢çº¿ç¨‹çš„CoroutineContextï¼Œè¿˜æœ‰å¸¸è§çš„CoroutineExceptionHandlerï¼Œå®ƒæ˜¯æˆ‘ä»¬åç¨‹æ•æ‰å¼‚å¸¸çš„CoroutineContextï¼Œè¿˜æœ‰å¸¸è§çš„Jobï¼Œå®ƒæ˜¯æˆ‘ä»¬åç¨‹æ„å»ºç»“æ„åŒ–çš„CoroutineContextï¼Œè¿˜æœ‰ä¸å¸¸ç”¨çš„CoroutineNameï¼Œå®ƒæ˜¯ç”¨æ¥ç»™åç¨‹èµ·åå­—çš„CoroutineContextã€‚åœ¨é€šè¿‡+(plus)æ‹¼æ¥CoroutineContextçš„æ—¶å€™ï¼Œå¦‚æœå‘ç°ä¼ è¿›æ¥çš„æ˜¯EmptyCoroutineContextï¼Œåˆ™è¿˜æ˜¯è¿”å›è‡ªå·±ï¼Œå¦‚æœä¸æ˜¯EmptyCoroutineContextåˆ™ä¼šæ‹¼æ¥æˆä¸€ä¸ªCombinedContextï¼Œå®ƒæ˜¯ä¸€ä¸ªé“¾è¡¨ç»“æ„çš„CoroutineContextï¼Œå¦‚æœåœ¨+è¿‡ç¨‹ä¸­å‘ç°è¦æ·»åŠ çš„CoroutineContextå·²ç»å­˜åœ¨äºåŸæœ‰çš„CoroutineContextä¸­ï¼Œåˆ™ä¼šç”¨æ–°çš„è¦†ç›–æ‰åŸæœ‰çš„CoroutineContextã€‚ä½†æ˜¯åœ¨CombinedContextä¸­ä¼šå°†ContinuationInterceptorç±»å‹çš„CoroutineContextæ”¾åˆ°é“¾è¡¨çš„æœ€å‰é¢ã€‚\nå†æ¥ä¸€å¼ æœ¬æ¬¡è®²è§£çš„contextç±»å›¾ï¼š\n","date":"2024-11-04T00:00:00Z","permalink":"http://xiangcman.xyz/p/%E5%8D%8F%E7%A8%8B%E4%B8%8A%E4%B8%8B%E6%96%87/","title":"åç¨‹ä¸Šä¸‹æ–‡"},{"content":"kotlinä¸­inlineï¼Œnoinlineï¼ŒcrossinlineåŒºåˆ«ï¼Ÿ é»˜è®¤å‡½æ•°ä¸­å¦‚æœæ²¡åŠ inlineï¼Œé‚£å°±æ˜¯éå†…è”å‡½æ•°ï¼Œæ­¤æ—¶lambdaä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„ç±»ï¼Œè¯¥ç±»æ˜¯ç»§æ‰¿è‡ªLambdaæŠ½è±¡ç±»ï¼Œå¹¶å®ç°äº†Functionæ¥å£ï¼Œå…¶ä¸­invokeæ–¹æ³•å°±æ˜¯Functionæ¥å£çš„æ–¹æ³•ï¼Œinvokeä¸­çš„æ–¹æ³•å°±æ˜¯lambdaä»£ç å—çš„ä»£ç ã€‚ å†…è”å‡½æ•°(åŠ inlineå…³é”®å­—)çš„lambdaå¦‚æœæ²¡åŠ noinlineæˆ–crossinlineï¼Œé»˜è®¤ä¼šæŠŠlambdaçš„ä»£ç å—ç»™å¹³é“ºåˆ°è°ƒç”¨å¤„ï¼Œæ‰€ä»¥æ­¤æ—¶å¦‚æœåœ¨lambdaä¸­åŠ returnçš„è¯ï¼Œä¼šç›´æ¥ä¸æ‰§è¡Œå¤–å±‚å‡½æ•°åç»­ä»£ç ã€‚å¦‚æœæ˜¯éå†…è”å‡½æ•°çš„è¯ï¼Œç”±äºå®ƒæ˜¯ç”Ÿæˆä¸€ä¸ªå•ç‹¬çš„ç±»ï¼Œä¸å­˜åœ¨å¹³é“ºä»£ç ï¼Œæ‰€ä»¥returnæ˜¯ç¼–è¯‘ä¸è¿‡å»çš„ã€‚ noinlineå’Œinlineæ˜¯å¯¹ç«‹å…³ç³»ï¼Œå®ƒæ˜¯å°†lambdaä¸å†…è”å¤„ç†ï¼Œå¦‚æœä½ éœ€è¦å¯¹è¯¥lambdaä½œä¸ºå¯¹è±¡æ¥ä½¿ç”¨çš„æ—¶å€™ï¼Œæ­¤æ—¶éœ€è¦ç”¨åˆ°noinlineï¼Œå¦‚æœä¸€ä¸ªå†…è”å‡½æ•°éƒ½æ˜¯noinlineçš„lambdaè¡¨è¾¾å¼ï¼Œé‚£ä¹ˆæ­¤æ—¶asä¼šæç¤ºä½ æ­¤å¤„å¯ä»¥å»æ‰inlineå…³é”®å­—äº†ï¼Œå½“åšæ™®é€šçš„é«˜é˜¶å‡½æ•°æ¥å¤„ç†å°±è¡Œã€‚ é»˜è®¤å†…è”å‡½æ•°æ˜¯èƒ½æ·»åŠ returnæ¥ä½œä¸ºå±€éƒ¨è¿”å›ï¼Œç”±äºå­˜åœ¨å¹³é“ºä»£ç çš„ç‰¹æ€§ï¼Œæ‰€ä»¥å®ƒèƒ½é˜»æ­¢è°ƒç”¨lambdaçš„å¤–å±‚å‡½æ•°çš„æ‰§è¡Œï¼Œé‚£å¦‚æœlambdaä½œä¸ºé—´æ¥è°ƒç”¨çš„æ—¶å€™ï¼Œæ­¤æ—¶æ·»åŠ returnè¯­å¥ä¼šç¼–è¯‘å¤±è´¥ï¼Œå› ä¸ºé—´æ¥è°ƒç”¨ï¼ˆæ¯”å¦‚åŒ¿åå†…éƒ¨ç±»æˆ–å›è°ƒï¼‰ä¸èƒ½é˜»æ­¢å¤–å±‚å‡½æ•°çš„è°ƒç”¨ï¼Œæ˜¯ä¸ºäº†é¿å…å¤šçº¿ç¨‹æˆ–å›è°ƒä¸­æ„å¤–ç»ˆæ­¢å¤–å±‚å‡½æ•°ï¼Œæ‰€ä»¥kotlinç¼–è¯‘å™¨æ­¤æ—¶éœ€è¦ä½ æ·»åŠ crossinlineï¼Œä¸¾ä¸ªä¾‹å­å°±æ¸…æ¥šäº†ï¼š æ­¤å¤„çš„runé—­åŒ…ï¼Œå®ƒçš„è°ƒç”¨æ˜¯åœ¨runnableæ¥å£ä¸­çš„ï¼Œæ­¤æ—¶ç¼–è¯‘å™¨æç¤º it may contain non-local returns ï¼Œæ„æ€æ˜¯æ­¤æ—¶å­˜åœ¨é—´æ¥è°ƒç”¨ï¼Œåœ¨é—´æ¥è°ƒç”¨lambdaçš„æ—¶å€™ï¼Œä¸å…è®¸åœ¨lambdaä¸­æ·»åŠ returnæ¥é˜»æ­¢å¤–å±‚çš„å¤–å±‚å‡½æ•°çš„æ‰§è¡Œã€‚æ‰€ä»¥æ­¤å¤„é€šè¿‡æ·»åŠ crossinlineæ¥é˜»æ­¢lambdaä¸­æ·»åŠ return\nç–‘æƒ‘ï¼šcrossinlineæ·»åŠ åï¼Œå†…è”æ•ˆæœè¿˜åœ¨å—ï¼Ÿè¿˜æ˜¯ä»¥ä¸Šé¢çš„ä¾‹å­æ¥è¯´æ˜ï¼š å‡å¦‚ä¸Šé¢çš„helloæ–¹æ³•æˆ‘å°±ä½œä¸ºæ™®é€šçš„æ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 object TestInline1 { @JvmStatic fun main(args: Array\u0026lt;String\u0026gt;) { hello { println(\u0026#34;helloçš„é—­åŒ…\u0026#34;) } } fun hello(run: () -\u0026gt; Unit) { val runnable = Runnable { println(\u0026#34;runnable run\u0026#34;) run() } runnable.run() } } å¯¹åº”çš„å­—èŠ‚ç å¦‚ä¸‹ï¼š\nå¦‚æœæˆ‘æŠŠå®ƒä½œä¸ºå†…è”å‡½æ•°æ¥å¤„ç†ï¼Œå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 object TestInline1 { @JvmStatic fun main(args: Array\u0026lt;String\u0026gt;) { hello { println(\u0026#34;helloçš„é—­åŒ…\u0026#34;) } } inline fun hello(crossinline run: () -\u0026gt; Unit) { val runnable = Runnable { println(\u0026#34;runnable run\u0026#34;) run() } runnable.run() } } å¯¹åº”çš„å­—èŠ‚ç å¦‚ä¸‹ï¼š\nå¯ä»¥çœ‹å‡ºæ¥crossinlineè¿˜æ˜¯æœ‰å†…è”æ•ˆæœï¼Œé—­åŒ…ç›´æ¥åœ¨runnableä¸­å¹³é“ºå¼€æ¥äº†ã€‚ ç›¸å…³æ–‡æ¡£ï¼šhttps://juejin.cn/post/6869954460634841101\njava lambdaå’Œkotlin lambdaåŒºåˆ« åœ¨javaä¸­å¦‚æœä½¿ç”¨åŒ¿åå†…éƒ¨ç±»çš„å½¢å¼ï¼Œåœ¨ç¼–è¯‘æ—¶å®ƒæ˜¯ä¼šå•ç‹¬ç”Ÿæˆä¸€ä¸ªç±»ï¼Œå…¶ä¸­ç±»åæ˜¯ã€Œå¤–éƒ¨ç±»å$index.classã€è¿™ç§å½¢å¼ã€‚å¦‚æœä½¿ç”¨lambdaçš„å½¢å¼ï¼Œå®ƒä¸ä¼šåœ¨ç¼–è¯‘æ—¶å•ç‹¬ç”Ÿæˆä¸€ä¸ªç±»ï¼Œå®ƒæ˜¯æ‰§è¡Œäº†invokedynamicæŒ‡ä»¤ï¼Œåœ¨è¿è¡Œæ—¶åŠ¨æ€ç”Ÿæˆlambdaçš„ç±»ï¼Œå…¶ä¸­ç±»åæ˜¯ã€Œå¤–éƒ¨ç±»å$Lambda$index.classã€è¿™ç§å½¢å¼ã€‚ å‚è€ƒ:https://juejin.cn/post/7004642395060961310 kotlin lambdaå®ƒæ˜¯åœ¨ç¼–è¯‘æ—¶çœ‹æ˜¯å¦éœ€è¦ç”Ÿæˆå•ç‹¬çš„ç±»ï¼Œå¦‚æœæ˜¯å†…è”çš„æ—¶å€™å°±ç›´æ¥å¹³é“ºä»£ç ï¼Œå¦‚æœæ˜¯éå†…è”çš„æ—¶å€™æ‰ç”Ÿæˆå•ç‹¬çš„ç±»ã€‚ åç¨‹æ˜¯æ€ä¹ˆæŒ‚èµ·çš„ï¼Ÿæ€ä¹ˆæ¢å¤çš„ï¼Ÿ é¦–å…ˆæ¯ä¸€ä¸ªåç¨‹ä»£ç å—éƒ½ä¼šè¢«ç¼–è¯‘æˆSuspendLambdaå¯¹è±¡ï¼Œå®ƒä¹Ÿæ˜¯ä¸€ä¸ªContinuationå¯¹è±¡ï¼Œæ¯æ¬¡åœ¨æ‰§è¡Œåˆ°SuspendLambdaçš„resumeæ—¶å€™ï¼Œéƒ½ä¼šå»æ‰§è¡ŒinvokeSuspendæ–¹æ³•ï¼Œè€Œè¯¥æ–¹æ³•é‡Œé¢ä¼šå»æ‰§è¡Œå­åç¨‹ï¼Œå¦‚æœå­åç¨‹è¿”å›COROUTINE_SUSPENDEDçŠ¶æ€çš„æ—¶å€™ï¼Œçˆ¶åç¨‹çš„resumeæ–¹æ³•ä¼šç›´æ¥returnäº†ã€‚å½“å­åç¨‹æ‰§è¡Œå®Œåï¼Œä¼šé€šçŸ¥çˆ¶åç¨‹ï¼Œæ­¤æ—¶çˆ¶åç¨‹çš„çš„invokeSuspendæ–¹æ³•å†æ¬¡è¢«æ‰§è¡Œï¼Œè€Œæ­¤æ—¶çš„çŠ¶æ€æœºä¼šå‘ç”Ÿå˜åŒ–ï¼Œå¦‚æœæ­¤æ—¶çŠ¶æ€æ¢å¤åï¼Œä¼šæ‰§è¡Œçˆ¶åç¨‹ä¸­çš„Continuationï¼Œä¹Ÿå°±æ˜¯çˆ¶çˆ¶åç¨‹çš„æ‰§è¡Œã€‚ åç¨‹ä¸­çš„dispatheræ˜¯æ€ä¹ˆæŒ‡å®šåœ¨å“ªä¸ªçº¿ç¨‹ä¸Šæ‰§è¡Œçš„ï¼Ÿ é¦–å…ˆdispatherå®ƒæ˜¯CoroutineContextï¼ˆä¸Šä¸‹æ–‡ï¼‰çš„ä¸€éƒ¨åˆ†ï¼Œåœ¨åç¨‹å¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œä¼šå–CoroutineContextä¸­çš„CoroutineDispathceréƒ¨åˆ†ã€‚æ­¤æ—¶ä¼šæ„é€ ä¸€ä¸ªDispathedContinuationå¯¹è±¡ï¼Œå¹¶æŠŠå‰é¢å–åˆ°çš„Dispatherä¼ åˆ°DispathedContinuationä¸­ï¼Œæ­¤æ—¶ä¼šå°†DispathedContinuationæ‰”åˆ°çº¿ç¨‹æ± ä¸­ï¼Œæœ€ç»ˆä¼šæ‰§è¡ŒDispathedContinuationçš„runæ–¹æ³•ï¼Œåœ¨runé‡Œé¢ä¼šæ‰§è¡Œåˆ°SuspendLambdaï¼Œä¹Ÿå°±æ˜¯åç¨‹çš„ä»£ç å—ï¼Œæœ€ç»ˆä¼šæ‰§è¡Œå®ƒçš„invokeSuspendæ–¹æ³•ã€‚æ‰€ä»¥åç¨‹ä»£ç å—ä¸­ä»£ç è¦æ‰§è¡Œåœ¨å“ªä¸ªçº¿ç¨‹æ˜¯åç¨‹ä¸Šä¸‹æ–‡çš„dispatheréƒ¨åˆ†æŒ‡å®šçš„çº¿ç¨‹ã€‚ ç›¸å…³æ–‡æ¡£ï¼šhttps://www.xiangcman.fun/p/%E5%8D%8F%E7%A8%8B%E5%A6%82%E4%BD%95%E5%88%87%E6%8D%A2%E7%BA%BF%E7%A8%8B/\nLinkedListç‰¹æ€§ LinkedListç»§æ‰¿è‡ªDequeï¼Œå®ƒæ˜¯ä¸€ä¸ªåŒç«¯é˜Ÿåˆ—ï¼Œå…è®¸åœ¨é˜Ÿåˆ—çš„ä¸¤ç«¯æ’å…¥å’Œåˆ é™¤å…ƒç´ ã€‚å¯ä»¥ä½œä¸ºæ ˆï¼ˆLIFOï¼‰æˆ–é˜Ÿåˆ—ï¼ˆFIFOï¼‰ä½¿ç”¨ã€‚åŸºäºé“¾è¡¨ï¼ˆåŒå‘é“¾è¡¨ï¼‰å®ç°ï¼Œå¯ä»¥é«˜æ•ˆåœ°æ’å…¥å’Œåˆ é™¤å…ƒç´ ã€‚ offerï¼šç»™é“¾è¡¨å°¾éƒ¨æ’å…¥å…ƒç´ ï¼Œè¿”å›å€¼è¡¨ç¤ºæ˜¯å¦æ’å…¥æˆåŠŸ peekï¼šå–å‡ºå¤´éƒ¨èŠ‚ç‚¹ï¼Œå¦‚æœæ²¡æœ‰åˆ™è¿”å›null pollï¼šå–å‡ºå¤´éƒ¨èŠ‚ç‚¹ï¼Œå¦‚æœæ²¡æœ‰åˆ™è¿”å›nullï¼Œå–å®Œåå¹¶æŠŠå¤´éƒ¨èŠ‚ç‚¹ä»é˜Ÿåˆ—ä¸­ç§»é™¤ removeï¼šç§»é™¤å¤´éƒ¨èŠ‚ç‚¹ï¼Œå¦‚æœæ²¡æœ‰å¤´éƒ¨èŠ‚ç‚¹åˆ™æŠ›å¼‚å¸¸ï¼Œæœ‰çš„è¯ï¼Œåˆ™è¿”å› pushï¼šç»™é“¾è¡¨å¤´éƒ¨æ’å…¥å…ƒç´ ï¼Œæ²¡æœ‰è¿”å›å€¼ popï¼šå’Œremoveä¸€æ ·çš„ï¼Œéƒ½æ˜¯ç§»é™¤å¤´éƒ¨èŠ‚ç‚¹ï¼Œå¦‚æœæ²¡æœ‰å¤´éƒ¨èŠ‚ç‚¹åˆ™æŠ›å¼‚å¸¸ï¼Œæœ‰çš„è¯ï¼Œåˆ™è¿”å›\nå¦‚æœæƒ³å®ç°é˜Ÿåˆ—çš„è¯ï¼Œåˆ™ä½¿ç”¨offerå’Œpollè¿™ä¸€å¯¹æ–¹æ³•ï¼›å¦‚æœæƒ³å®ç°æ ˆçš„è¯ï¼Œå¯ä»¥é€šè¿‡offerLastå’ŒpollLastæ¥å®ç°ï¼Œæˆ–è€…é€šè¿‡offerFirstå’ŒpollFirstæ¥å®ç°ã€‚\nArrayDequeç‰¹æ€§ å®ƒä¹Ÿæ˜¯ç»§æ‰¿è‡ªDequeï¼Œå’ŒLinkedListçš„ç‰¹æ€§ä¸€æ ·çš„ï¼Œåªä¸è¿‡ArrayDequeæ˜¯é€šè¿‡æ•°ç»„å®ç°çš„åŒç«¯é˜Ÿåˆ—ï¼Œå†…éƒ¨ç”¨ä¸€ä¸ªæ•°ç»„æ¥æ”¾æ‰€æœ‰çš„èŠ‚ç‚¹ï¼Œå¹¶ä¸”æœ‰ä¸¤ä¸ªintå€¼ç”¨æ¥å­˜æ”¾å¤´ç»“ç‚¹å’Œå°¾ç»“ç‚¹çš„ç´¢å¼•ã€‚å¹¶ä¸”ArrayDequeå†…éƒ¨çš„é»˜è®¤èŠ‚ç‚¹å®¹é‡æ˜¯16ä¸ªï¼Œä¹Ÿå¯ä»¥åˆå§‹åŒ–å®¹é‡å¤§å°ã€‚\nåŒºåˆ«ï¼šå¦‚æœé¢‘ç¹è¦æ’å…¥å’Œåˆ é™¤æ“ä½œï¼Œé‚£ä¹ˆä½¿ç”¨LinkedListï¼Œå¦‚æœæ˜¯æŸ¥è¯¢æƒ…å†µæ¯”è¾ƒå¤šï¼Œå¯ä»¥ä¼˜å…ˆä½¿ç”¨ArrayDequeã€‚\nPools. Pool 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 class Pools private constructor() { /** * Interface for managing a pool of objects. * * @param T The pooled type. */ interface Pool\u0026lt;T : Any\u0026gt; { /** * @return An instance from the pool if such, null otherwise. */ fun acquire(): T? /** * Release an instance to the pool. * * @param instance The instance to release. * @return Whether the instance was put in the pool. * * @throws IllegalStateException If the instance is already in the pool. */ fun release(instance: T): Boolean } /** * Simple (non-synchronized) pool of objects. * * @param maxPoolSize The maximum pool size * @param T The pooled type. */ open class SimplePool\u0026lt;T : Any\u0026gt;( /** * The max pool size */ @IntRange(from = 1) maxPoolSize: Int ) : Pool\u0026lt;T\u0026gt; { private val pool: Array\u0026lt;Any?\u0026gt; private var poolSize = 0 init { require(maxPoolSize \u0026gt; 0) { \u0026#34;The max pool size must be \u0026gt; 0\u0026#34; } pool = arrayOfNulls(maxPoolSize) } override fun acquire(): T? { if (poolSize \u0026gt; 0) { val lastPooledIndex = poolSize - 1 @Suppress(\u0026#34;UNCHECKED_CAST\u0026#34;) val instance = pool[lastPooledIndex] as T pool[lastPooledIndex] = null poolSize-- return instance } return null } override fun release(instance: T): Boolean { check(!isInPool(instance)) { \u0026#34;Already in the pool!\u0026#34; } if (poolSize \u0026lt; pool.size) { pool[poolSize] = instance poolSize++ return true } return false } private fun isInPool(instance: T): Boolean { for (i in 0 until poolSize) { if (pool[i] === instance) { return true } } return false } } /** * Synchronized pool of objects. * * @param maxPoolSize The maximum pool size * @param T The pooled type. */ open class SynchronizedPool\u0026lt;T : Any\u0026gt;(maxPoolSize: Int) : SimplePool\u0026lt;T\u0026gt;(maxPoolSize) { private val lock = Any() override fun acquire(): T? { synchronized(lock) { return super.acquire() } } override fun release(instance: T): Boolean { synchronized(lock) { return super.release(instance) } } } } å¾ˆæ˜æ˜¾è¿™æ˜¯ä¸€ä¸ªå¯¹è±¡æ± ï¼ŒSimplePoolç»§æ‰¿è‡ªPoolï¼Œå¹¶ä¸”å¯ä»¥æŒ‡å®šå¯¹è±¡æ± çš„å¤§å°ã€‚æ¯æ¬¡è¦å›æ”¶çš„æ—¶å€™è°ƒç”¨releaseï¼Œåªæœ‰å½“å‰sizeå°äºå¯¹è±¡æ± æœ€å¤§å®¹é‡çš„æ—¶å€™æ‰èƒ½å›æ”¶ï¼Œæ¯æ¬¡é€šè¿‡acquireæ¥è¿›è¡Œè·å–å¯¹è±¡æ± ä¸­çš„å…ƒç´ ã€‚ å…¶ä¸­åœ¨recyclerviewåŠ¨ç”»ç¯‡ç« ä¸­ï¼Œåˆ†æåˆ°InfoRecordå¯¹è±¡ä¸­ä¼šä½¿ç”¨Pools. SimplePoolï¼ŒInfoRecordå­˜å‚¨çš„æ˜¯ViewHolderåœ¨pre-layouté˜¶æ®µçš„åæ ‡ä¿¡æ¯å’Œpost-layouté˜¶æ®µçš„åæ ‡ä¿¡æ¯ï¼Œä»¥åŠViewHolderçš„flagä¿¡æ¯ã€‚å› ä¸ºViewHolderçš„è¿™äº›ä¿¡æ¯åœ¨åŠ¨ç”»å¤„ç†è¿‡ç¨‹ä¸­ä¼šé¢‘ç¹ä½¿ç”¨ï¼Œæ‰€ä»¥æ­¤å¤„ä½¿ç”¨äº†å¯¹è±¡æ± æ¥ç®¡ç†ã€‚\njavaä¸­ç±»åŠ è½½æœºåˆ¶ é¦–å…ˆé€šè¿‡classçš„nameæŸ¥çœ‹æœ‰æ²¡æœ‰åŠ è½½è¿‡ï¼Œå¦‚æœæ²¡æœ‰åŠ è½½è¿‡ï¼Œçœ‹è‡ªå·±çš„çˆ¶ç±»åŠ è½½å™¨æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨ï¼Œåˆ™é€šè¿‡çˆ¶ç±»åŠ è½½çš„loadClasså»åŠ è½½ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™è¯´æ˜å½“å‰ç±»åŠ è½½å™¨æ˜¯BootstrapClassLoaderåŠ è½½å™¨ï¼Œåˆ™é€šè¿‡BootstrapClassLoaderå»åŠ è½½ï¼Œå¦‚æœè¿˜æ²¡æœ‰æ‰¾åˆ°åˆ™é€šè¿‡è‡ªå·±çš„findClasså»åŠ è½½ã€‚æ•´ä½“è¿‡ç¨‹ç†è§£ä¸ºå…ˆè®©çˆ¶ç±»åŠ è½½å™¨å»åŠ è½½classï¼Œå¦‚æœæ‰¾ä¸åˆ°åˆ™è‡ªå·±å»åŠ è½½ã€‚ ç±»åŠ è½½å™¨åˆ†ç±»ï¼š BootstrapClassLoaderï¼šæœ€é¡¶å±‚çš„ç±»åŠ è½½å™¨ï¼Œå®ƒç”¨æ¥åŠ è½½JAVA_HOME/jre/lib/rt.jarä¸­çš„ç±» ExtClassLoaderï¼šæ‰©å±•ç±»åŠ è½½å™¨ï¼Œå®ƒç”¨æ¥åŠ è½½JAVA_HOME/jre/lib/extç›®å½•ä¸‹çš„æ‰€æœ‰jarä¸­çš„ç±»ï¼Œå®ƒçš„çˆ¶åŠ è½½å™¨æ˜¯BootstrapClassLoaderï¼Œç»§æ‰¿è‡ªURLClassLoader AppClassLoaderï¼šåº”ç”¨ç±»åŠ è½½å™¨ï¼Œå®ƒç”¨æ¥åŠ è½½åº”ç”¨çš„ç±»ï¼Œä¹Ÿå°±æ˜¯ClassPathï¼Œå®ƒçš„çˆ¶åŠ è½½å™¨æ˜¯ExtClassLoaderï¼Œç»§æ‰¿è‡ªURLClassLoader è‡ªå®šä¹‰ClassLoaderï¼šç”¨æˆ·å®ç°ï¼Œä»»æ„è·¯å¾„ï¼ˆå¦‚ç½‘ç»œã€æ–‡ä»¶ï¼‰ï¼Œå¯ä»¥é€šè¿‡ç»§æ‰¿è‡ªClassLoaderæˆ–è€…æ˜¯URLClassLoader ç±»åŠ è½½å™¨é‡‡ç”¨åŒäº²å§”æ‰˜æ¨¡å¼æ¥åŠ è½½classï¼Œä¸»è¦æ˜¯ä¸ºäº†ç³»ç»Ÿçš„classçš„å®‰å…¨ï¼Œä¼˜å…ˆä½¿ç”¨ç³»ç»Ÿçš„classæ¥åŠ è½½ã€‚ åŒæ¸…å§”æ‰˜æ¨¡å¼çš„æ ¸å¿ƒä»£ç ï¼š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 protected Class\u0026lt;?\u0026gt; loadClass(String name, boolean resolve) throws ClassNotFoundException { synchronized (getClassLoadingLock(name)) { // First, check if the class has already been loaded Class\u0026lt;?\u0026gt; c = findLoadedClass(name); if (c == null) { long t0 = System.nanoTime(); try { if (parent != null) { c = parent.loadClass(name, false); } else { c = findBootstrapClassOrNull(name); } } catch (ClassNotFoundException e) { // ClassNotFoundException thrown if class not found // from the non-null parent class loader } if (c == null) { // If still not found, then invoke findClass in order // to find the class. long t1 = System.nanoTime(); c = findClass(name); // this is the defining class loader; record the stats sun.misc.PerfCounter.getParentDelegationTime().addTime(t1 - t0) sun.misc.PerfCounter.getFindClassTime().addElapsedTimeFrom(t1); sun.misc.PerfCounter.getFindClasses().increment(); } } if (resolve) { resolveClass(c); } return c; } } androidä¸­ç±»åŠ è½½æœºåˆ¶ androidç±»åŠ è½½æœºåˆ¶ä¹Ÿæ˜¯æŒ‰ç…§åŒäº²å§”æ‰˜æ¨¡å‹ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡è‡ªå®šä¹‰ç±»åŠ è½½å™¨ç»•è¿‡åŒäº²å§”æ´¾ï¼Œå®ç°ç±»çš„éš”ç¦»æˆ–å¤ç”¨ ç±»åŠ è½½å™¨åˆ†ç±»ï¼š BootClassLoaderï¼šç³»ç»Ÿç±»åŠ è½½å™¨ï¼ŒåŠ è½½æ¡†æ¶å±‚çš„æ ¸å¿ƒç±»ï¼ˆå¦‚ android.ã€java. ç­‰ç³»ç»Ÿç±»ï¼‰\nPathClassLoaderï¼šåº”ç”¨ç±»åŠ è½½å™¨ï¼ŒåŠ è½½å·²å®‰è£… APK ä¸­çš„ç±»ï¼ˆå³åº”ç”¨è‡ªèº«çš„ç±»å’Œ classes.dexï¼‰ï¼Œå®ƒçš„çˆ¶ç±»åŠ è½½å™¨æ˜¯BootClassLoaderï¼Œç»§æ‰¿è‡ªBaseDexClassLoaderï¼Œç”¨äºåŠ è½½ /data/app//base.apk ä¸­çš„ä»£ç ï¼Œæ— æ³•åŠ è½½å¤–éƒ¨å­˜å‚¨çš„dexã€jaræ–‡ä»¶\nDexClassLoaderï¼šåŠ¨æ€åŠ è½½å™¨ï¼ŒåŠ¨æ€åŠ è½½å¤–éƒ¨å­˜å‚¨çš„ DEX/JAR æ–‡ä»¶æˆ– APKï¼ˆå¦‚æ’ä»¶åŒ–ã€çƒ­ä¿®å¤åœºæ™¯ï¼‰ï¼Œçˆ¶åŠ è½½å™¨é€šå¸¸æ˜¯PathClassLoaderï¼Œä¹Ÿæ˜¯ç»§æ‰¿è‡ªBaseDexClassLoader\nä¸Šé¢æåˆ°androidç±»åŠ è½½ä¹Ÿæ˜¯é€šè¿‡åŒäº²å§”æ‰˜æ¨¡å¼æ¥åŠ è½½ç±»ï¼Œä½†æ˜¯å®‰å“åŠ è½½ç±»æ˜¯é€šè¿‡è§£ædexæ–‡ä»¶æ¥åŠ è½½çš„ï¼Œæ‰€ä»¥å¯¹äºPathClassLoaderå’ŒDexClassLoaderéƒ½æ˜¯é€šè¿‡dexæ¥åŠ è½½classçš„ï¼Œå¯¹äºBootClassLoaderï¼Œå®ƒä»ç„¶é€šè¿‡åŠ è½½ç³»ç»Ÿæ ¸å¿ƒçš„DEXæ–‡ä»¶æ¥å®ç°ç±»çš„åŠ è½½ï¼Œåªä¸è¿‡è¿™ä¸ªè¿‡ç¨‹æ˜¯ç”±è™šæ‹Ÿæœºåœ¨åº•å±‚ç›´æ¥å¤„ç†çš„ï¼Œä¸éœ€è¦é€šè¿‡BaseDexClassLoaderçš„DexPathListå’ŒDexFileæœºåˆ¶ã€‚è¿™ç§è®¾è®¡å¯èƒ½æ˜¯ä¸ºäº†ä¼˜åŒ–ç³»ç»Ÿå¯åŠ¨é€Ÿåº¦å’Œæ ¸å¿ƒç±»çš„è®¿é—®æ•ˆç‡ã€‚\nBaseDexClassLoaderå®Œæˆäº†æ•´ä¸ªdexè½¬æ¢æˆclassçš„è¿‡ç¨‹ï¼Œé¦–å…ˆç†è§£å‡ ä¸ªæ¦‚å¿µï¼Œ DexPathList ï¼Œ DexFile ï¼Œ Element :\nDexPathListï¼šè¢«BaseDexClassLoaderæŒæœ‰ Elementï¼šè¢«DexPathListæŒæœ‰ï¼Œå†…éƒ¨æŒæœ‰ä¸€ä¸ªElementçš„æ•°ç»„ DexFileï¼šè¢«ElementæŒæœ‰ DexPathListé€šè¿‡ä¼ å…¥çš„dexPathï¼Œç„¶åé€šè¿‡;æˆ–:è¿›è¡Œsplitï¼Œå¾—åˆ°Listï¼š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 //DexPathList.splitPaths private static List\u0026lt;File\u0026gt; splitPaths(String searchPath, boolean directoriesOnly) { List\u0026lt;File\u0026gt; result = new ArrayList\u0026lt;\u0026gt;(); if (searchPath != null) { for (String path : searchPath.split(File.pathSeparator)) { //çœç•¥ä»£ç  result.add(new File(path)); } } return result; } //DexPathList.makeDexElements private static Element[] makeDexElements(List\u0026lt;File\u0026gt; files, File optimizedDirectory, List\u0026lt;IOException\u0026gt; suppressedExceptions, ClassLoader loader) { Element[] elements = new Element[files.size()]; int elementsPos = 0; for (File file : files) { if (file.isDirectory()) { elements[elementsPos++] = new Element(file); } else if (file.isFile()) { String name = file.getName(); if (name.endsWith(DEX_SUFFIX)) { DexFile dex = loadDexFile(file, optimizedDirectory, loader, elements); elements[elementsPos++] = new Element(dex, null); } else { DexFile dex = loadDexFile(file, optimizedDirectory, loader, elements); if (dex == null) { elements[elementsPos++] = new Element(file); } else { elements[elementsPos++] = new Element(dex, file); } } } else { System.logW(\u0026#34;ClassLoader referenced unknown path: \u0026#34; + file); } } if (elementsPos != elements.length) { elements = Arrays.copyOf(elements, elementsPos); } return elements; } //DexPathList.loadDexFile private static DexFile loadDexFile(File file, File optimizedDirectory, ClassLoader loader,Element[] elements) throws IOException { if (optimizedDirectory == null) { return new DexFile(file, loader, elements); } else { String optimizedPath = optimizedPathFor(file, optimizedDirectory); return DexFile.loadDex(file.getPath(), optimizedPath, 0, loader, elements); } } ä»ä¸Šé¢å¯ä»¥çœ‹å‡ºæ¥ï¼ŒDexPathListé‡Œé¢ä¼šå…ˆsplitå‡ºdexPathï¼Œç„¶åé€šè¿‡è·¯å¾„ç”ŸæˆoptimizedPathçš„è·¯å¾„ï¼Œé€šè¿‡è¯¥è·¯å¾„ç”ŸæˆDexFileå¯¹è±¡ï¼Œå®ƒå°±æ˜¯è¡¨ç¤ºä¸€ä¸ªdexæ–‡ä»¶ã€‚ç„¶åæŠŠDexFileå¡å…¥åˆ°Elementæ•°ç»„ä¸­ï¼Œæœ€åè¯¥Elementæ•°ç»„å…³è”åˆ°BaseDexClassLoaderä¸­ã€‚\næ¥ç€çœ‹ä¸‹å¦‚æœé€šè¿‡dexåŠ è½½åˆ°classï¼Œè¯¥å¤„ç†æ˜¯åœ¨BaseDexClassLoaderä¸­çš„findClassï¼š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 //BaseDexClassLoader.findClass protected Class\u0026lt;?\u0026gt; findClass(String name) throws ClassNotFoundException { List\u0026lt;Throwable\u0026gt; suppressedExceptions = new ArrayList\u0026lt;Throwable\u0026gt;(); Class c = pathList.findClass(name, suppressedExceptions); if (c == null) { ClassNotFoundException cnfe = new ClassNotFoundException( \u0026#34;Didn\u0026#39;t find class \\\u0026#34;\u0026#34; + name + \u0026#34;\\\u0026#34; on path: \u0026#34; + pathList); for (Throwable t : suppressedExceptions) { cnfe.addSuppressed(t); } throw cnfe; } return c; } //DexPathList.findClass public Class\u0026lt;?\u0026gt; findClass(String name, List\u0026lt;Throwable\u0026gt; suppressed) { for (Element element : dexElements) { Class\u0026lt;?\u0026gt; clazz = element.findClass(name, definingContext, suppressed); if (clazz != null) { return clazz; } } if (dexElementsSuppressedExceptions != null) { suppressed.addAll(Arrays.asList(dexElementsSuppressedExceptions)); } return null; } //Element.findClass public Class\u0026lt;?\u0026gt; findClass(String name, ClassLoader definingContext, List\u0026lt;Throwable\u0026gt; suppressed) { return dexFile != null ? dexFile.loadClassBinaryName(name, definingContext, suppressed) : null; } //DexFile.loadClassBinaryName public Class loadClassBinaryName(String name, ClassLoader loader, List\u0026lt;Throwable\u0026gt; suppressed) { return defineClass(name, loader, mCookie, this, suppressed); } //DexFile.defineClass private static Class defineClass(String name, ClassLoader loader, Object cookie, DexFile dexFile, List\u0026lt;Throwable\u0026gt; suppressed) { Class result = null; try { result = defineClassNative(name, loader, cookie, dexFile); } catch (NoClassDefFoundError e) { if (suppressed != null) { suppressed.add(e); } } catch (ClassNotFoundException e) { if (suppressed != null) { suppressed.add(e); } } return result; } //DexFileä¸­çš„nativeæ–¹æ³• private static native Class defineClassNative(String name, ClassLoader loader, Object cookie,DexFile dexFile) throws ClassNotFoundException, NoClassDefFoundError; ä»ä¸Šé¢å¯ä»¥çœ‹åˆ°BaseDexClassLoaderæœ€ç»ˆæ˜¯é€šè¿‡DexPathList-\u0026gt;Element-\u0026gt;DexFile-\u0026gt;nativeæ¥åŠ è½½åˆ°class\nandroidä¸­Choreographerå·¥ä½œå†…å®¹ï¼ˆandroid 29ï¼‰ å½“æŸä¸ªviewå‘èµ·ç»˜åˆ¶ï¼ˆrequestLayoutæˆ–invalidateï¼‰çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨åˆ°ViewRootImplçš„scheduleTraversalsï¼Œè¯¥æ–¹æ³•é‡Œé¢ä¼šç»™ä¸»çº¿ç¨‹çš„looperä¸­çš„æ¶ˆæ¯é˜Ÿåˆ—æ’å…¥äº†ä¸€æ¡æ¶ˆæ¯å±éšœï¼Œæ¥ç€ç»™Choreographeræ’å…¥äº†ä¸€æ¡CALLBACK_TRAVERSALç±»å‹çš„callbackï¼š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 void scheduleTraversals() { //å¦‚æœæ²¡æœ‰å‘èµ·ç»˜åˆ¶ï¼Œæ‰ä¼šå¾€ä¸‹èµ° if (!mTraversalScheduled) { mTraversalScheduled = true; //ç»™ä¸»çº¿ç¨‹çš„looperä¸­çš„æ¶ˆæ¯é˜Ÿåˆ—æ’å…¥äº†ä¸€æ¡æ¶ˆæ¯å±éšœ mTraversalBarrier = mHandler.getLooper().getQueue().postSyncBarrier(); //ç»™Choreographeræ’å…¥äº†ä¸€æ¡CALLBACK_TRAVERSALç±»å‹çš„callback mChoreographer.postCallback( Choreographer.CALLBACK_TRAVERSAL, mTraversalRunnable, null); if (!mUnbufferedInputDispatch) { scheduleConsumeBatchedInput(); } notifyRendererOfFramePending(); pokeDrawLockIfNeeded(); } } æœ€ç»ˆä¼šèµ°åˆ°Choreographerçš„scheduleFrameLockedï¼Œé»˜è®¤ä¼šèµ°USE_VSYNCï¼Œå¹¶ä¸”é»˜è®¤è¯¥çº¿ç¨‹çš„looperæ˜¯ä¸»çº¿ç¨‹çš„looperï¼Œèµ°åˆ°å¦‚ä¸‹é€»è¾‘ï¼Œä¼šèµ°åˆ°scheduleVsyncLockedï¼Œæœ€ç»ˆä¼šèµ°åˆ°DisplayEventReceiverçš„nativeæ–¹æ³•nativeScheduleVsyncï¼Œè¡¨ç¤ºç›‘å¬åº•å±‚çš„vsyncä¿¡å·ï¼Œå½“vsyncä¿¡å·æ¥çš„æ—¶å€™ä¼šå›è°ƒonVsyncæ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šç»™ä¸»çº¿ç¨‹å‘é€ä¸€æ¡å¼‚æ­¥æ¶ˆæ¯åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼š 1 2 3 4 5 6 7 8 9 10 //timestampNanosï¼šVSyncè„‰å†²çš„æ—¶é—´æˆ³ //frameï¼šå¸§å·ç ï¼Œè‡ªå¢ @Override public void onVsync(long timestampNanos, long physicalDisplayId, int frame) { mTimestampNanos = timestampNanos; mFrame = frame; Message msg = Message.obtain(mHandler, this); msg.setAsynchronous(true); mHandler.sendMessageAtTime(msg, timestampNanos / TimeUtils.NANOS_PER_MS); } å¯ä»¥çœ‹åˆ°onVsyncä¸­å°†è‡ªå·±ï¼ˆFrameDisplayEventReceiverï¼‰å‘é€åˆ°ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œå¹¶ä¸”æ‰§è¡Œæ—¶é—´æ˜¯timestampNanosï¼Œè¯´æ˜è¯¥ä»»åŠ¡æ˜¯è¦ç­‰åˆ°vsyncä¿¡å·æŒ‡å®šçš„æ—¶é—´æ‰ä¼šæ‰§è¡Œï¼Œå®ƒæ˜¯ä¸€ä¸ªrunnableå¯¹è±¡ï¼Œåˆ°äº†æ‰§è¡Œè¯¥ä»»åŠ¡çš„æ—¶å€™ä¼šæ‰§è¡Œå®ƒçš„runæ–¹æ³•ï¼Œrunæ–¹æ³•ä¼šæ‰§è¡ŒdoFrameï¼Œä»»åŠ¡é˜Ÿåˆ—æ˜¯æ‰§è¡Œå®Œä¸Šä¸€ä¸ªä»»åŠ¡æ‰ä¼šæ‰§è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡ï¼Œæ‰€ä»¥å¦‚æœå‰é¢çš„ä»»åŠ¡ä¸€ç›´é˜»å¡ç€ï¼ŒdoFrameå…¶å®ä¸ä¼šåœ¨timestampNanosæ—¶é—´åˆ°äº†çš„æ—¶å€™ï¼Œä¼šç«‹é©¬æ‰§è¡Œçš„ï¼Œçœ‹ä¸‹doFrameå¤„ç†é€»è¾‘ï¼š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 void doFrame(long frameTimeNanos, int frame) { final long startNanos; synchronized (mLock) { //æœŸæœ›çš„æ—¶é—´ long intendedFrameTimeNanos = frameTimeNanos; startNanos = System.nanoTime(); //å½“å‰æ—¶é—´-æœŸæœ›æ—¶é—´=å»¶è¿Ÿæ—¶é—´ final long jitterNanos = startNanos - frameTimeNanos; //å»¶è¿Ÿæ—¶é—´å¦‚æœå¤§äºä¸€å¸§æ‰€éœ€è¦çš„æ—¶é—´ if (jitterNanos \u0026gt;= mFrameIntervalNanos) { final long skippedFrames = jitterNanos / mFrameIntervalNanos; //å¦‚æœå»¶è¿Ÿæ‰§è¡Œçš„æ—¶é—´å¤§äº30å¸§çš„æ—¶é—´åˆ™ç»™å‡ºæç¤º if (skippedFrames \u0026gt;= SKIPPED_FRAME_WARNING_LIMIT) { Log.i(TAG, \u0026#34;Skipped \u0026#34; + skippedFrames + \u0026#34; frames! \u0026#34; + \u0026#34;The application may be doing too much work on its main thread.\u0026#34;); } final long lastFrameOffset = jitterNanos % mFrameIntervalNanos; //é‡æ–°è®¡ç®—vsyncä¿¡å·æ¥çš„æ—¶é—´ frameTimeNanos = startNanos - lastFrameOffset; } //å¦‚æœæœŸæœ›çš„æ—¶é—´æ¯”ä¸Šä¸€å¸§çš„æ—¶é—´è¿˜å°ï¼Œåˆ™è¯´æ˜ä¸Šä¸€å¸§è¿˜æ²¡ç»“æŸï¼Œæ‰€ä»¥å½“å‰å¸§ä¸å¤„ç†ï¼Œç›´æ¥ç›‘å¬ä¸‹ä¸€ä¸ªvsyncä¿¡å· if (frameTimeNanos \u0026lt; mLastFrameTimeNanos) { scheduleVsyncLocked(); return; } mFrameInfo.setVsync(intendedFrameTimeNanos, frameTimeNanos); mFrameScheduled = false; //ç»™ä¸Šä¸€å¸§çš„æ—¶é—´é™„ä¸Šæ ‡è®° mLastFrameTimeNanos = frameTimeNanos; } try { Trace.traceBegin(Trace.TRACE_TAG_VIEW, \u0026#34;Choreographer#doFrame\u0026#34;); AnimationUtils.lockAnimationClock(frameTimeNanos / TimeUtils.NANOS_PER_MS); mFrameInfo.markInputHandlingStart(); //å¤„ç†inputç±»å‹çš„callback doCallbacks(Choreographer.CALLBACK_INPUT, frameTimeNanos); mFrameInfo.markAnimationsStart(); //å¤„ç†animationç±»å‹çš„callback doCallbacks(Choreographer.CALLBACK_ANIMATION, frameTimeNanos); doCallbacks(Choreographer.CALLBACK_INSETS_ANIMATION, frameTimeNanos); mFrameInfo.markPerformTraversalsStart(); //å¤„ç†traversalç±»å‹çš„callback doCallbacks(Choreographer.CALLBACK_TRAVERSAL, frameTimeNanos); //å¤„ç†commitç±»å‹çš„callback doCallbacks(Choreographer.CALLBACK_COMMIT, frameTimeNanos); } finally { AnimationUtils.unlockAnimationClock(); Trace.traceEnd(Trace.TRACE_TAG_VIEW); } } doFrameä¸»è¦æ˜¯å…ˆçœ‹å½“å‰æ—¶é—´å’ŒæœŸæœ›çš„æ—¶é—´è¿›è¡Œæ¯”è¾ƒï¼Œå¾—åˆ°å»¶è¿Ÿæ—¶é—´ï¼Œå¦‚æœè¯¥æ—¶é—´å¤§äºä¸€å¸§æ‰€éœ€è¦çš„æ—¶é—´ï¼ˆ60hzåˆ·æ–°ç‡çš„è®¾å¤‡ï¼Œé‚£ä¹ˆä¸€å¸§çš„æ—¶é—´æ˜¯1000/60=16msï¼‰ï¼Œå¹¶ä¸”è¯¥æ—¶é—´å¤§äº30å¸§çš„æ—¶é—´æ—¶å€™ç»™å‡ºæç¤ºï¼Œè¿™ä¸ªæ—¶é—´è·Ÿviewç»˜åˆ¶çš„anræ—¶é—´å·®ä¸å¤šã€‚å¦‚æœæœŸæœ›çš„æ—¶é—´æ¯”ä¸Šä¸€å¸§çš„æ—¶é—´è¿˜å°ï¼Œåˆ™è¯´æ˜ä¸Šä¸€å¸§è¿˜æ²¡ç»“æŸï¼Œæ‰€ä»¥å½“å‰å¸§ä¸å¤„ç†ï¼Œç›´æ¥ç›‘å¬ä¸‹ä¸€ä¸ªvsyncä¿¡å·ã€‚æ¥ç€å°±æ˜¯å¤„ç†å„ç§callbackï¼ˆinputã€animationã€traversalã€commitï¼‰ã€‚è€Œå¼€å¤´viewå‘èµ·ç»˜åˆ¶çš„æ—¶å€™ï¼Œä¼šæ’å…¥ä¸€æ¡traversalç±»å‹çš„callbackï¼Œæ‰€ä»¥ä¼šæ‰§è¡Œåˆ°viewçš„ç»˜åˆ¶æµç¨‹ã€‚\nå½“viewå‘èµ·ç»˜åˆ¶çš„æ—¶å€™ï¼Œä¸ä¼šç«‹é©¬æ‰§è¡Œï¼Œè€Œæ˜¯å…ˆç»™Choreographeræ’å…¥ä¸€æ¡traversalç±»å‹çš„callbackï¼ŒåŒæ—¶è®©Choreographerç›‘å¬ä¸‹ä¸€ä¸ªvsyncä¿¡å·çš„åˆ°æ¥ï¼Œå½“vsyncä¿¡å·æ¥çš„æ—¶å€™ï¼Œä¼šç»™ä¸»çº¿ç¨‹çš„æ¶ˆæ¯é˜Ÿåˆ—å‘é€ä¸€æ¡å¼‚æ­¥æ¶ˆæ¯ï¼Œå½“å¤„ç†è¯¥æ¶ˆæ¯çš„æ—¶å€™æ ¡éªŒæ˜¯å¦æœ‰æ‰å¸§å¤„ç†ï¼Œå¦‚æœæœ‰æ‰30å¸§çš„æ—¶å€™ï¼Œä¼šç»™å‡ºæç¤ºï¼Œæœ€åå¤„ç†å„ç§ç±»å‹çš„callbackã€‚ vsyncä¿¡å·çš„ä½œç”¨ VSyncï¼ˆå‚ç›´åŒæ­¥ï¼‰åœ¨å®‰å“å±å¹•åˆ·æ–°ä¸­çš„ä½œç”¨ä¸»è¦æ˜¯åè°ƒå±å¹•åˆ·æ–°ä¸å›¾åƒæ¸²æŸ“ï¼Œé¿å…ç”»é¢æ’•è£‚å¹¶æå‡æ˜¾ç¤ºæµç•…åº¦ã€‚å…·ä½“ä½œç”¨å¦‚ä¸‹ï¼š é˜²æ­¢ç”»é¢æ’•è£‚ å½“å±å¹•åˆ·æ–°ä¸å›¾åƒæ¸²æŸ“ä¸åŒæ­¥æ—¶ï¼Œå¯èƒ½å‡ºç°ç”»é¢æ’•è£‚ã€‚VSyncé€šè¿‡åŒæ­¥ä¸¤è€…çš„é¢‘ç‡ï¼Œç¡®ä¿å±å¹•åœ¨å®Œæ•´åˆ·æ–°ä¸€å¸§åå†æ˜¾ç¤ºä¸‹ä¸€å¸§ï¼Œä»è€Œé¿å…è¿™ä¸€é—®é¢˜ã€‚ æå‡æµç•…åº¦ VSyncç¡®ä¿å¸§ç‡ä¸å±å¹•åˆ·æ–°ç‡ä¸€è‡´ï¼Œå‡å°‘å¸§ç‡æ³¢åŠ¨ï¼Œä½¿åŠ¨ç”»å’Œæ»šåŠ¨æ›´åŠ å¹³æ»‘ã€‚ ä¼˜åŒ–æ€§èƒ½ VSyncé€šè¿‡æ§åˆ¶æ¸²æŸ“èŠ‚å¥ï¼Œé¿å…GPUè¿‡åº¦æ¸²æŸ“ï¼Œå‡å°‘èµ„æºæµªè´¹ï¼Œæå‡ç³»ç»Ÿæ•ˆç‡ã€‚ åŒç¼“å†²ä¸ä¸‰ç¼“å†² VSyncå¸¸ä¸åŒç¼“å†²æˆ–ä¸‰ç¼“å†²ç»“åˆä½¿ç”¨ã€‚åŒç¼“å†²é€šè¿‡äº¤æ›¿ä½¿ç”¨å‰åç¼“å†²åŒºå‡å°‘ç­‰å¾…æ—¶é—´ï¼Œè€Œä¸‰ç¼“å†²è¿›ä¸€æ­¥å‡å°‘å¡é¡¿ï¼Œæå‡æ€§èƒ½ã€‚ å‡å°‘å»¶è¿Ÿ è™½ç„¶VSyncå¯èƒ½å¢åŠ å°‘é‡å»¶è¿Ÿï¼Œä½†é€šè¿‡åˆç†ä½¿ç”¨åŒç¼“å†²æˆ–ä¸‰ç¼“å†²ï¼Œå¯ä»¥åœ¨ä¿è¯æµç•…åº¦çš„åŒæ—¶å°½é‡é™ä½å»¶è¿Ÿã€‚ æ€»ç»“æ¥è¯´ï¼ŒVSyncé€šè¿‡åŒæ­¥å±å¹•åˆ·æ–°ä¸å›¾åƒæ¸²æŸ“ï¼Œé˜²æ­¢ç”»é¢æ’•è£‚ã€æå‡æµç•…åº¦ã€ä¼˜åŒ–æ€§èƒ½ï¼Œå¹¶å‡å°‘å»¶è¿Ÿã€‚ æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯å±éšœ æ¶ˆæ¯å±éšœä¸»è¦æ˜¯ä¸å¤„ç†å±éšœåé¢çš„åŒæ­¥æ¶ˆæ¯ï¼Œä¼˜å…ˆå¤„ç†å¼‚æ­¥æ¶ˆæ¯ï¼Œå®ç°åŸç†æ˜¯æ¶ˆæ¯å±éšœæœ¬èº«æ˜¯ä¸€ä¸ªæ²¡æœ‰æŒæœ‰handlerçš„æ¶ˆæ¯ï¼Œåœ¨è·å–æ¶ˆæ¯çš„æ—¶å€™ï¼Œå¦‚æœå‘ç°é˜Ÿåˆ—å¤´éƒ¨æ˜¯ä¸€ä¸ªæ¶ˆæ¯å±éšœï¼Œåˆ™ä¸è·å–åé¢çš„åŒæ­¥æ¶ˆæ¯ï¼Œåªè·å–åé¢çš„å¼‚æ­¥æ¶ˆæ¯ï¼Œä¸€èˆ¬ä½œç”¨äºä¼˜å…ˆçº§æ¯”è¾ƒé«˜çš„åœºæ™¯ï¼Œæ¯”å¦‚viewçš„ç»˜åˆ¶æµç¨‹ã€‚å½“å¤„ç†å®Œå¼‚æ­¥æ¶ˆæ¯åï¼Œéœ€è¦ç§»é™¤æ‰è¯¥æ¶ˆæ¯å±éšœã€‚ androidä¸­å¼‚å¸¸å¤„ç† é¦–å…ˆç†è§£ä¸‹javaä¸­çº¿ç¨‹å¼‚å¸¸æœºåˆ¶ï¼Œå¦‚æœçº¿ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸äº†ï¼Œæ²¡æœ‰è¿›è¡Œtry-catché»˜è®¤ä¼šæŠ›ç»™ defaultUncaughtExceptionHandler çš„uncaughtExceptionï¼Œè€Œandroidä¸­å¯åŠ¨è¿›ç¨‹åä¼šåœ¨RuntimeInitçš„commonInitæ–¹æ³•ä¸­ç»™ä¸»çº¿ç¨‹è®¾ç½®ä¸ŠdefaultUncaughtExceptionHandlerï¼Œå¯¹åº”çš„æ˜¯KillApplicationHandlerï¼Œåœ¨å®ƒçš„uncaughtExceptionæ–¹æ³•ä¸­å…ˆæ”¶é›†æ—¥å¿—ï¼Œç„¶åkillæ‰è¿›ç¨‹ã€‚å¦‚æœæœ‰è®¾ç½®çº¿ç¨‹çš„uncaughtExceptionHandlerï¼Œé‚£ä¹ˆæ­¤æ—¶javaå¼‚å¸¸æœºåˆ¶æ˜¯å°±ä¸èµ°defaultUncaughtExceptionHandleräº†ï¼Œæ‰€ä»¥ä¸ä¼šèµ°KillApplicationHandlerï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®uncaughtExceptionHandlerï¼Œè€Œé€šè¿‡Thread.uncaughtExceptionHandler.uncaughtException(Exception)çš„æ—¶å€™ï¼Œå…¶å®æ˜¯å…ˆè·å–åˆ°çº¿ç¨‹çš„ThreadGroupï¼Œè€Œåœ¨ThreadGroupä¸­çš„uncaughtExceptionä¸­å…ˆçœ‹parentæœ‰æ²¡æœ‰ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä¹Ÿæ˜¯å›è°ƒåˆ°defaultUncaughtExceptionHandlerä¸­ã€‚\nå…³äºå¤šå¼ bitmapè½¬æˆwebpçš„åŸç† é¦–å…ˆå¾—ç†è§£webpæ˜¯åŸºäºVP8/VP8L/VP9è§†é¢‘ç¼–ç æŠ€æœ¯ï¼Œæ”¯æŒæœ‰æŸå‹ç¼©ã€æ— æŸå‹ç¼©ã€é€æ˜åº¦å’ŒåŠ¨ç”»ã€‚å…¶å†…éƒ¨æ ¼å¼åŸºäºRIFFï¼ˆResource Interchange File Formatï¼‰æ–‡ä»¶ç»“æ„ï¼Œç±»ä¼¼äºWAVæˆ–AVIçš„å®¹å™¨æ ¼å¼ã€‚webpæ–‡ä»¶ä»¥RIFFå¤´éƒ¨å¼€å§‹ï¼Œæ•´ä½“ç»“æ„å¦‚ä¸‹ï¼š\n1 RIFF {FileSize} WEBP {Chunks...} RIFFï¼šå›ºå®š 4 å­—èŠ‚æ ‡è¯†ç¬¦ã€‚ FileSizeï¼š4 å­—èŠ‚ï¼Œè¡¨ç¤ºæ–‡ä»¶æ€»å¤§å°ï¼ˆåŒ…æ‹¬ RIFF å¤´éƒ¨å’Œ WEBP æ ‡ç­¾ï¼‰ã€‚ WEBPï¼šå›ºå®š 4 å­—èŠ‚æ ‡è¯†ç¬¦ï¼Œè¡¨æ˜æ–‡ä»¶ç±»å‹ã€‚ å…¶ä¸­RIFFã€FileSizeã€WEBPè¿™ä¸‰ä¸ªå½’ä¸ºheaderéƒ¨åˆ†ï¼Œchunkså½’ä¸ºå—éƒ¨åˆ†ã€‚å…¶ä¸­å—å¯ä»¥åˆ†ä¸ºå¦‚ä¸‹éƒ¨åˆ†ï¼š VP8/VP8L/VP9 å›¾åƒæ•°æ®å—ï¼š VP8ï¼šç”¨äºæœ‰æŸå‹ç¼©å›¾åƒï¼ˆç±»ä¼¼ JPEGï¼‰ï¼Œå—æ ‡è¯†ç¬¦ä¸º VP8 ï¼ˆæ³¨æ„æœ«å°¾ç©ºæ ¼ï¼‰ã€‚ VP8Lï¼šç”¨äºæ— æŸå‹ç¼©å›¾åƒï¼ˆç±»ä¼¼ PNGï¼‰ï¼Œå—æ ‡è¯†ç¬¦ä¸º VP8Lã€‚ VP9ï¼šç”¨äºæ›´é«˜æ•ˆçš„å‹ç¼©ï¼ˆè¾ƒå°‘è§ï¼‰ï¼Œå—æ ‡è¯†ç¬¦ä¸º VP9 ã€‚ VP8Xï¼ˆæ‰©å±•å…ƒæ•°æ®å—ï¼‰ï¼š æ ‡è¯†ç¬¦ä¸º VP8Xï¼Œç”¨äºå­˜å‚¨æ‰©å±•ä¿¡æ¯ï¼ˆå¦‚å®½åº¦ã€é«˜åº¦ã€åŠ¨ç”»æ ‡å¿—ã€Alpha é€šé“ç­‰ï¼‰ã€‚ å¿…é¡»å‡ºç°åœ¨å…¶ä»–å—ä¹‹å‰ï¼ˆé™¤ RIFF å’Œ WEBP å¤–ï¼‰ã€‚ åŒ…å«ä»¥ä¸‹æ ‡å¿—ä½ï¼š åŠ¨ç”»ï¼ˆAnimationï¼‰ Alpha é€šé“ï¼ˆAlphaï¼‰ EXIF å…ƒæ•°æ® XMP å…ƒæ•°æ® ICC é¢œè‰²é…ç½®æ–‡ä»¶ ANIMï¼ˆåŠ¨ç”»æ§åˆ¶å—ï¼‰ï¼š æ ‡è¯†ç¬¦ä¸º ANIMï¼Œä»…ç”¨äºåŠ¨ç”» WebPã€‚ åŒ…å«èƒŒæ™¯é¢œè‰²å’Œå¾ªç¯æ¬¡æ•°ã€‚ ANMFï¼ˆåŠ¨ç”»å¸§å—ï¼‰ï¼š æ ‡è¯†ç¬¦ä¸º ANMFï¼Œæ¯ä¸ªåŠ¨ç”»å¸§å¯¹åº”ä¸€ä¸ª ANMF å—ã€‚ åŒ…å«å¸§çš„ä½ç½®ã€æ—¶é—´å»¶è¿Ÿã€å®½åº¦ã€é«˜åº¦ç­‰ã€‚ äº†è§£æ–‡ä»¶ç»“æ„åï¼Œä¸‹é¢æ¥ä»‹ç»å¦‚ä½•å°†å¤šä¸ªbitmapç”Ÿæˆwebpï¼š é¦–å…ˆå°†bitmapå‹ç¼©æˆwebpæ ¼å¼çš„å›¾ç‰‡ï¼ŒæŒ‰ç…§50çš„å‹ç¼©æ¯”ï¼Œæ”¾åˆ°å­—èŠ‚è¾“å…¥æµä¸­ è¯»å–webpçš„headeréƒ¨åˆ† è¯»å–RIFFéƒ¨åˆ† è¯»å–æ–‡ä»¶å¤§å° è¯»å–WEBPéƒ¨åˆ† è¯»å–ç¬¬ä¸€ä¸ªå¸¦æœ‰playloadçš„chunkå— ç”±äºå‰é¢æŒ‡å®šäº†bitmapè½¬webpçš„æ—¶å€™æ˜¯æœ‰æŸï¼Œå› æ­¤è¯»å–chunkçš„æ—¶å€™ç›´æ¥å»è¯»WP8å—ï¼Œæ¥ç€è¯»å–å®ƒçš„payloadä¿¡æ¯ï¼Œplayloadå¤§å°å°±æ˜¯chunkå¤§å°ï¼Œ4å­—èŠ‚ã€‚ è¯»å–å®Œåï¼Œæ¥ç€å°±æ˜¯å†™å…¥åˆ°è¾“å‡ºæµä¸­ï¼Œåˆ¤æ–­å¦‚æœæ˜¯ç¬¬ä¸€ä¸ªbitmapï¼Œåˆ™åˆ›å»ºheaderéƒ¨åˆ†ï¼Œå…¶ä¸­headerä¹Ÿæ˜¯æŒ‰ç…§RIFFã€FileSizeã€WEBPä¸‰ä¸ªåŒºåŸŸå†™å›ï¼Œæ¥ç€å†™å…¥VP8Xæ•°æ®å—ï¼Œæ ‡æ˜å®½é«˜ã€åŠ¨ç”»ã€é€šé“ã€å…ƒæ•°æ®ç­‰ä¿¡æ¯ã€‚æ¥ç€åˆ›å»ºANIMåŠ¨ç”»æ§åˆ¶å—ï¼Œæ ‡æ˜èƒŒæ™¯é¢œè‰²å’Œå¾ªç¯æ¬¡æ•°ã€‚æœ€ååˆ›å»ºæ¯ä¸€ä¸ªbitmapå¯¹åº”çš„ANMFåŠ¨ç”»å¸§å—ï¼Œå°†æŒ‡å®šæ¯ä¸€å¸§çš„çš„å°ºå¯¸ã€æ—¶é•¿playloadæ•°æ®ã€‚ kotlinä¸­ == å’Œ === åŒºåˆ« kotlinä¸­çš„==ï¼šå¦‚æœæ˜¯å¯¹è±¡ç±»å‹ï¼Œæ¯”è¾ƒçš„æ˜¯equalsæ–¹æ³•ï¼›å¦‚æœæ˜¯åŸºæœ¬ç±»å‹ï¼Œæ¯”è¾ƒçš„æ˜¯å€¼ã€‚ kotlinä¸­çš„===ï¼šå¦‚æœæ˜¯å¯¹è±¡ç±»å‹ï¼Œæ¯”è¾ƒçš„æ˜¯å†…å­˜åœ°å€ï¼ŒæŒ‡å‘çš„æ˜¯ä¸æ˜¯åŒä¸€ä¸ªå¯¹è±¡ï¼›å¦‚æœæ˜¯åŸºæœ¬ç±»å‹ã€‚æ¯”è¾ƒçš„è¿˜æ˜¯å€¼ã€‚\nkotlinä¸­lazyçš„åŸç† Lazyæœ¬èº«æ˜¯ä¸€ä¸ªæ¥å£ï¼Œä¼šæä¾›ä¸€ä¸ªvalueå±æ€§å’ŒisInitializedçš„æ–¹æ³•ï¼Œæ³¨æ„äº†åœ¨kotlinæ¥å£ä¸­æä¾›å±æ€§ï¼Œå…¶å®å¯¹åº”javaä¸­çš„get**æ–¹æ³•ï¼Œå¹³æ—¶å†™çš„by lazy{}ï¼Œå»å®šä¹‰ä¸€ä¸ªå±æ€§çš„æ—¶å€™ï¼Œå…¶å®å®ƒæ˜¯ä¸€ç§å±æ€§å§”æ‰˜çš„å†™æ³•ï¼Œä½†æ˜¯lazyå®ƒæ˜¯åªè¯»çš„å§”æ‰˜æ¨¡å¼ï¼Œæ‰€ä»¥åœ¨å®šä¹‰å±æ€§çš„æ—¶å€™å¿…é¡»ç”¨valæ¥ä¿®é¥°å˜é‡ã€‚å½“æˆ‘ä»¬å»è¯»å–lazyçš„å˜é‡çš„æ—¶å€™ï¼Œå®é™…æ˜¯è°ƒç”¨äº†å‰é¢å®šä¹‰çš„valueå±æ€§ï¼Œå¯¹åº”javaä»£ç å…¶å®æ˜¯getValueæ–¹æ³•ï¼Œå½“é¦–æ¬¡å»è·å–å±æ€§çš„æ—¶å€™ï¼Œå‘ç°_valueä¸ºç©ºï¼Œæ‰€ä»¥ä¼šé€šè¿‡é—­åŒ…å»è·å–ï¼Œè·å–åˆ°åä¼šå°†è¿”å›å€¼ç»™åˆ°_valueï¼Œä¸‹æ¬¡å†è°ƒç”¨getValueçš„æ—¶å€™ï¼Œç›´æ¥è¿”å›è¯¥_valueã€‚\n1 public actual fun \u0026lt;T\u0026gt; lazy(lock: Any?, initializer: () -\u0026gt; T): Lazy\u0026lt;T\u0026gt; = SynchronizedLazyImpl(initializer, lock) ç¬¬ä¸€ä¸ªå‚æ•°lockæ˜¯å¯ä»¥ä¼ å…¥å¯¹è±¡é” ç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¼ è¿›æ¥çš„é—­åŒ…ï¼Œæ˜¯éç©º è¿”å›å€¼ï¼šå®é™…æ˜¯ä¸€ä¸ªSynchronizedLazyImplå¯¹è±¡ï¼š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 private class SynchronizedLazyImpl\u0026lt;out T\u0026gt;(initializer: () -\u0026gt; T, lock: Any? = null) : Lazy\u0026lt;T\u0026gt;, Serializable { private var initializer: (() -\u0026gt; T)? = initializer //ä½¿ç”¨Volatileå…³é”®å­—ä¿®é¥°_valueå˜é‡ï¼Œåœ¨å¤šçº¿ç¨‹ä¸‹èƒ½è¾¾åˆ°å¯è§æ€§çš„æ•ˆæœ @Volatile private var _value: Any? = UNINITIALIZED_VALUE // final field is required to enable safe publication of constructed instance private val lock = lock ?: this//å¦‚æœä¼ è¿›æ¥çš„å¯¹è±¡é”ä¸ºç©ºï¼Œåˆ™å½“å‰å¯¹è±¡ä½œä¸ºé” override val value: T get() { val _v1 = _value if (_v1 !== UNINITIALIZED_VALUE) { @Suppress(\u0026#34;UNCHECKED_CAST\u0026#34;) return _v1 as T } //é€šè¿‡synchronizedæ¥ä¿è¯åˆ›å»ºå¯¹è±¡æ˜¯åŸå­æ“ä½œ return synchronized(lock) { val _v2 = _value if (_v2 !== UNINITIALIZED_VALUE) { @Suppress(\u0026#34;UNCHECKED_CAST\u0026#34;) (_v2 as T) } else { val typedValue = initializer!!() _value = typedValue initializer = null typedValue } } } } ç»¼ä¸Šæ¥çœ‹ï¼Œlazyé»˜è®¤æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œé»˜è®¤ä½¿ç”¨çš„å¯¹è±¡é”æ˜¯å½“å‰lazyå¯¹è±¡ï¼Œä¹Ÿå¯ä»¥è‡ªå·±ä¼ å…¥é”å¯¹è±¡ã€‚ä½¿ç”¨Volatileæ¥ä¿è¯å¯¹è±¡çš„å¯è§æ€§ï¼Œé€šè¿‡synchronizedä¿è¯åˆ›å»ºå¯¹è±¡æ˜¯åŸå­æ“ä½œã€‚\nkotlinå§”æ‰˜æ¨¡å¼ å±æ€§å§”æ‰˜ï¼šå…è®¸ä½ æŠŠå±æ€§çš„getterã€setteré€»è¾‘å§”æ‰˜ç»™ä¸€ä¸ªç‹¬ç«‹çš„å¯¹è±¡æ¥ç®¡ç†\né€šè¿‡ã€Œvar å±æ€§ by å§”æ‰˜ç±»ã€çš„å½¢å¼å®šä¹‰ä¸€ä¸ªå±æ€§å§”æ‰˜çš„è¿‡ç¨‹ï¼Œå½“ä½¿ç”¨varçš„æ—¶å€™ï¼Œè¯´æ˜è¯¥å±æ€§èƒ½å¯è¯»å’Œå¯å†™ï¼Œåœ¨å±æ€§å†™çš„æ—¶å€™å®é™…ç¼–è¯‘å™¨ä¼šå»è°ƒå§”æ‰˜ç±»çš„setValueæ–¹æ³•ï¼Œå½“å±æ€§è¯»çš„æ—¶å€™å®é™…ç¼–è¯‘å™¨ä¼šå»è°ƒå§”æ‰˜ç±»çš„getValueæ–¹æ³•ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 class Delegate { operator fun getValue(thisRef: Any?, property: KProperty\u0026lt;*\u0026gt;): String { return \u0026#34;å±æ€§ ${property.name} è¢«ä»£ç†äº†\u0026#34; } operator fun setValue(thisRef: Any?, property: KProperty\u0026lt;*\u0026gt;, value: String) { println(\u0026#34;å±æ€§ ${property.name} èµ‹å€¼ä¸º $value\u0026#34;) } } class Example { var message: String by Delegate() } fun main() { val e = Example() println(e.message) // è®¿é—®æ—¶è°ƒç”¨ getValue() e.message = \u0026#34;Hello\u0026#34; // èµ‹å€¼æ—¶è°ƒç”¨ setValue() } å®é™…å¯¹åº”çš„å­—èŠ‚ç ï¼š\n1 2 3 4 5 6 7 class Example { private val message$delegate = Delegate() // å§”æ‰˜å¯¹è±¡å˜ä¸ºä¸€ä¸ªç§æœ‰å±æ€§ var message: String get() = message$delegate.getValue(this, ::message) set(value) = message$delegate.setValue(this, ::message, value) } by Delegate() å…¶å®æ˜¯ Kotlin ç¼–è¯‘å™¨ç”Ÿæˆçš„ get() å’Œ set() æ–¹æ³•ã€‚ getValue() å’Œ setValue() ç”± Delegate è¿™ä¸ªå§”æ‰˜å¯¹è±¡å®ç°ã€‚ ç±»å§”æ‰˜ï¼šå…è®¸ä¸€ä¸ªç±» å°†å®ç°æŸä¸ªæ¥å£çš„åŠŸèƒ½å§”æ‰˜ç»™å¦ä¸€ä¸ªå¯¹è±¡ï¼Œå‡å°‘ä»£ç é‡å¤ã€‚\nby å…³é”®å­— å¯ä»¥è®© Kotlin è‡ªåŠ¨ç”Ÿæˆå§”æ‰˜æ–¹æ³•ï¼Œé¿å…æ‰‹å†™é‡å¤ä»£ç  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 interface Printer { fun printMessage() } class RealPrinter : Printer { override fun printMessage() { println(\u0026#34;RealPrinter: æ‰“å°å†…å®¹\u0026#34;) } } class ProxyPrinter(printer: Printer) : Printer by printer fun main() { val realPrinter = RealPrinter() val proxy = ProxyPrinter(realPrinter) proxy.printMessage() // è°ƒç”¨çš„æ˜¯ realPrinter çš„æ–¹æ³• } ä¸Šé¢çš„ProxyPrinterè¢«ç¼–è¯‘å™¨ç¼–è¯‘ä¸ºå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 class ProxyPrinter(printer: Printer) : Printer { private val printerDelegate: Printer = printer override fun printMessage() { printerDelegate.printMessage() } } by printer è®© ProxyPrinter è‡ªåŠ¨å®ç° Printer æ¥å£çš„æ–¹æ³•ï¼Œè€Œä¸éœ€è¦æ‰‹åŠ¨å®ç°ã€‚ ç¼–è¯‘å™¨åœ¨å­—èŠ‚ç å±‚é¢ä¼šè‡ªåŠ¨æ’å…¥ä»£ç†æ–¹æ³•ï¼Œæé«˜ä»£ç ç®€æ´æ€§ã€‚ ä¸ºä»€ä¹ˆreifiedå¿…é¡»å’Œinlineä¸€èµ·ä½¿ç”¨ï¼Ÿ reifiedå…³é”®å­—æ˜¯ç”¨æ¥ä¿®é¥°æ³›å‹ï¼Œè€Œæ³›å‹åœ¨ç¼–è¯‘åä¼šè¢«æ“¦é™¤æ‰ï¼Œæ‰€ä»¥å¦‚æœè¦åœ¨è¿è¡Œæ—¶è·å–åˆ°æ³›å‹çš„ç±»å‹ï¼Œå°±å¾—ç”¨reifiedå…³é”®å­—ï¼Œè€Œinlineçš„ä½œç”¨æ˜¯ä¿®é¥°æ–¹æ³•å†…è”ï¼Œä¹‹å‰è®²å†…è”å‡½æ•°çš„ç‰¹ç‚¹æ˜¯å°†å‡½æ•°ä½“å¹³é“ºåˆ°è°ƒç”¨å¤„ã€‚é‚£å®ƒä¸¤æœ‰ä»€ä¹ˆè”ç³»å‘¢ï¼Ÿå…ˆæ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼š\næ­¤å¤„æç¤ºæˆ‘ï¼Œä½¿ç”¨reifiedå…³é”®å­—æ¥ä¿®é¥°æ³›å‹ï¼Œå› ä¸ºæ³›å‹åœ¨ç¼–è¯‘åï¼Œä¼šè¢«æ“¦é™¤æ‰ï¼Œæ‰€ä»¥æ˜¯è·å–ä¸åˆ°å®ƒçš„ç±»å‹ï¼Œåªæœ‰æ·»åŠ reifiedæ‰èƒ½ä¿è¯å®ƒçš„ç±»å‹å­˜åœ¨ã€‚é‚£æ·»åŠ å®Œreifiedåæç¤ºä¸ºä»€ä¹ˆè¿˜è¦æ·»åŠ inlineå‘¢ï¼Ÿ è¿™æ˜¯å› ä¸ºåªæœ‰å†…è”å‡½æ•°å°†å‡½æ•°ä½“è¿›è¡Œå¹³é“ºï¼Œç„¶åå°†æ³›å‹é€šè¿‡ã€ŒçœŸç±»å‹ã€ä»£å…¥åˆ°å‡½æ•°ä½“ä¸­ï¼Œçœ‹ä¸‹ç¼–è¯‘åçš„ä»£ç ï¼š\nå…³äºviewModelçš„ä¸€äº›æ€è€ƒ åˆ›å»ºï¼šé»˜è®¤éƒ½æ˜¯é€šè¿‡ViewModelProviderçš„getæ–¹æ³•è·å–åˆ°viewModelï¼Œé‡Œé¢é€šè¿‡factoryï¼ˆå·¥å‚æ–¹æ³•æ¨¡å¼ï¼‰çš„createæ¥åˆ›å»ºviewModelï¼Œåˆ›å»ºå®Œä¹‹åä¼šæŠŠviewModelä¿å­˜åˆ°ViewModelStoreä¸­ã€‚ViewModelStoreå®é™…æ˜¯ç”¨ä¸€ä¸ªhashMapæ¥å­˜å‚¨viewModelï¼Œkeyæ˜¯viewModelçš„class nameæ‹¼ä¸Šå‰ç¼€ï¼Œvalueå°±æ˜¯å½“å‰viewModelã€‚androidä¸­é»˜è®¤çš„factoryæ˜¯ViewModelProvider. AndroidViewModelFactoryï¼Œåœ¨å®ƒçš„createæ–¹æ³•é‡Œé¢é€šè¿‡å‰é¢ä¼ è¿›æ¥çš„viewModelçš„classåå°„åˆ›å»ºviewModelã€‚ å­˜å‚¨ï¼šåƒå¹³æ—¶å†™çš„activityéƒ½æ˜¯ç»§æ‰¿è‡ªComponentActivityï¼Œå®ƒæ˜¯å®ç°äº†ViewModelStoreOwneræ¥å£ï¼Œè¯¥æ¥å£éœ€è¦æŒæœ‰ä¸€ä¸ªViewModelStoreï¼ŒViewModelStoreæ˜¯åœ¨ensureViewModelStoreæ–¹æ³•ä¸­åˆ›å»ºçš„ï¼š 1 2 3 4 5 6 7 8 9 10 11 12 13 void ensureViewModelStore() { if (mViewModelStore == null) { NonConfigurationInstances nc = (NonConfigurationInstances) getLastNonConfigurationInstance(); if (nc != null) { // Restore the ViewModelStore from NonConfigurationInstances mViewModelStore = nc.viewModelStore; } if (mViewModelStore == null) { mViewModelStore = new ViewModelStore(); } } } getLastNonConfigurationInstance()æ–¹æ³•æ˜¯è·å–Activityä¸­çš„mLastNonConfigurationInstanceså±æ€§çš„activityå±æ€§ï¼Œç»“æ„å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 static final class NonConfigurationInstances { Object activity; HashMap\u0026lt;String, Object\u0026gt; children; FragmentManagerNonConfig fragments; ArrayMap\u0026lt;String, LoaderManager\u0026gt; loaders; VoiceInteractor voiceInteractor; } ç¬¬ä¸€æ¬¡æ‰“å¼€activityçš„æ—¶å€™mLastNonConfigurationInstanceså±æ€§æ˜¯ç©ºçš„ï¼Œå› æ­¤åœ¨ensureViewModelStoreä¸­æ˜¯ç›´æ¥åˆ›å»ºäº†ViewModelStoreã€‚é‚£ä»€ä¹ˆæ—¶å€™mLastNonConfigurationInstancesä¸ä¸ºç©ºå‘¢ï¼Ÿæˆ‘ä»¬æ³¨æ„åˆ°mLastNonConfigurationInstancesæ˜¯åœ¨activityçš„attachä¸­èµ‹å€¼çš„ï¼Œå®ƒçš„ä¸Šçº§æ¥æºæ˜¯ActivityClientRecordä¸­çš„lastNonConfigurationInstanceså±æ€§ï¼Œé‚£ä»€ä¹ˆæ—¶å€™ç»™ActivityClientRecordçš„lastNonConfigurationInstanceså±æ€§èµ‹å€¼å‘¢ï¼Ÿè¿™ä¸ªå¯ä»¥åœ¨aospä¸­çš„ frameworks/base/core/java/android/app/Activity.java ç±»ä¸­çš„performDestroyActivityæ–¹æ³•ä¸­æ‰¾åˆ°ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 void performDestroyActivity(ActivityClientRecord r, boolean finishing, boolean getNonConfigInstance, String reason) { Class\u0026lt;? extends Activity\u0026gt; activityClass; if (getNonConfigInstance) { try { //é€šè¿‡è°ƒç”¨activityçš„retainNonConfigurationInstancesæ–¹æ³•æ¥ç»™ActivityClientRecordçš„lastNonConfigurationInstanceså±æ€§èµ‹å€¼ r.lastNonConfigurationInstances = r.activity.retainNonConfigurationInstances(); } catch (Exception e) { if (!mInstrumentation.onException(r.activity, e)) { throw new RuntimeException(\u0026#34;Unable to retain activity \u0026#34; + r.intent.getComponent().toShortString() + \u0026#34;: \u0026#34; + e.toString(), e); } } } } è€Œactivityçš„retainNonConfigurationInstancesæ–¹æ³•ä¸­ä¼šç»„è£…NonConfigurationInstancesä¸­çš„activityå±æ€§ï¼Œæ˜¯é€šè¿‡onRetainNonConfigurationInstanceæ–¹æ³•æ¥æ”¶é›†çš„ï¼š\n1 2 3 4 5 6 NonConfigurationInstances retainNonConfigurationInstances() { Object activity = onRetainNonConfigurationInstance(); NonConfigurationInstances nci = new NonConfigurationInstances(); nci.activity = activity;//æ‰‹æœºactivityå±æ€§ return nci; } onRetainNonConfigurationInstanceæ–¹æ³•çš„è°ƒç”¨æ˜¯åœ¨ ComponentActivity ä¸­å®ç°äº†ï¼š\n1 2 3 4 5 6 7 8 9 @Override @Nullable @SuppressWarnings(\u0026#34;deprecation\u0026#34;) public final Object onRetainNonConfigurationInstance() { ViewModelStore viewModelStore = mViewModelStore; NonConfigurationInstances nci = new NonConfigurationInstances(); nci.viewModelStore = viewModelStore; return nci; } å¯ä»¥çœ‹åˆ°æœ€ç»ˆviewModelStoreé€šè¿‡ComponentActivityä¸­çš„NonConfigurationInstanceså­˜å‚¨èµ·æ¥äº†ï¼Œæœ€ç»ˆè¢«ActivityClientRecordæŒæœ‰ã€‚å½“æ¨ªç«–å±åˆ‡æ¢çš„æ—¶å€™ä¼šè§¦å‘ActivityThreadçš„handleRelaunchActivityï¼Œåœ¨è¯¥æ–¹æ³•é‡Œé¢ä¼šå…ˆå°†activityçš„lastNonConfigurationInstancesä¿å­˜åˆ°ActivityClientRecordï¼Œç­‰åˆ°åˆ›å»ºactivityçš„æ—¶å€™ä¼šæŠŠlastNonConfigurationInstancesç»™åˆ°activityï¼Œæ‰€ä»¥viewmodelStoreæ­¤æ—¶æ‹¿åˆ°çš„è¿˜æ˜¯ä¹‹å‰çš„ã€‚\nfragmentä¸­çš„viewModelæ˜¯æ€ä¹ˆå­˜å‚¨çš„ï¼Ÿ fragmentä¹Ÿæ˜¯å®ç°äº†viewModelOwneræ¥å£ï¼Œæ‰€ä»¥å®ƒä¹Ÿæœ‰è‡ªå·±çš„viewModelStoreï¼Œå®ƒçš„viewModelStoreæ˜¯é€šè¿‡FragmentManagerViewModelæ¥ç®¡ç†çš„ï¼ŒFragmentManagerViewModelçš„åˆ›å»ºæ˜¯çœ‹å½“å‰fragmentæœ‰æ²¡æœ‰parentFragmentï¼Œå¦‚æœæœ‰ï¼Œåˆ™é€šè¿‡parentFragmentçš„fragmentManagerçš„getChildNonConfigæ–¹æ³•æ¥è·å–ã€‚å¦‚æœparentä¸ºç©ºï¼Œåˆ™é€šè¿‡activityçš„viewModelStoreæ¥åˆ›å»ºã€‚æ‰€ä»¥fragmentçš„viewModelStoreå­˜å‚¨ä¹Ÿæ˜¯ä¾èµ–äºactivityï¼Œå› ä¸ºæœ€ç»ˆè¯¥FragmentManagerViewModelæ˜¯é€šè¿‡activityçš„viewModelStoreæ¥å­˜å‚¨çš„ã€‚ ViewModelä¼ å‚é—®é¢˜ ä½¿ç”¨è‡ªå®šä¹‰ViewModelProvider.Factory 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 // ViewModel éœ€è¦å‚æ•° class UserDetailViewModel( private val userId: String? ) : ViewModel() { // ... init { Log.d(\u0026#34;UserDetailViewModel\u0026#34;, \u0026#34;userId:${userId}\u0026#34;) } fun test() {} } // Activity ä¸­ä½¿ç”¨ class UserDetailActivity : AppCompatActivity() { private val userId = \u0026#34;å¼ ä¸‰\u0026#34; // âœ… ä½¿ç”¨ extrasProducer ä¼ é€’å‚æ•° private val viewModel: UserDetailViewModel by viewModels( factoryProducer = { object : ViewModelProvider.Factory { override fun \u0026lt;T : ViewModel\u0026gt; create( modelClass: Class\u0026lt;T\u0026gt; ): T { return UserDetailViewModel(userId) as T } } } ) override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) viewModel.test() } companion object { val USER_ID_KEY = object : CreationExtras.Key\u0026lt;String\u0026gt; {} } } ä½¿ç”¨è‡ªå®šä¹‰ViewModelProvider.Factory+CreationExtrasç»™ViewModelä¼ å€¼ åœ¨activityçš„viewmodelsæ‰©å±•å‡½æ•°ä¸­ä¼ å…¥extrasProducerå’ŒfactoryProducerï¼Œä»–ä¸¤éƒ½æ˜¯é—­åŒ…ï¼ŒextrasProducerå‚æ•°æŒ‡å®šé—­åŒ…ä¸­è¿”å›çš„æ˜¯MutableCreationExtrasï¼ŒfactoryProducerå‚æ•°æŒ‡å®šçš„æ˜¯ä¸€ä¸ªViewModelProvider.Factoryçš„åŒ¿åç±»ï¼Œé‡å†™createæ–¹æ³•ï¼Œè¿”å›éœ€è¦çš„ViewModelï¼š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 // ViewModel éœ€è¦å‚æ•° class UserDetailViewModel( private val userId: String? ) : ViewModel() { // ... init { Log.d(\u0026#34;UserDetailViewModel\u0026#34;, \u0026#34;userId:${userId}\u0026#34;) } fun test() {} } // Activity ä¸­ä½¿ç”¨ class UserDetailActivity : AppCompatActivity() { private val userId = \u0026#34;å¼ ä¸‰\u0026#34; // âœ… ä½¿ç”¨ extrasProducer ä¼ é€’å‚æ•° private val viewModel: UserDetailViewModel by viewModels( extrasProducer = { MutableCreationExtras().apply { set(USER_ID_KEY, userId) } //MutableCreationExtraså¯ä»¥é€šè¿‡ä¼ å…¥å…¶å®ƒçš„CreationExtras,æ¯”å¦‚æ­¤å¤„ä¼ å…¥äº†defaultViewModelCreationExtrasï¼Œç„¶ååšä¸€ä¸ªæ‹¼æ¥ //MutableCreationExtras(defaultViewModelCreationExtras).apply { // set(USER_ID_KEY, userId) //} }, factoryProducer = { object : ViewModelProvider.Factory { override fun \u0026lt;T : ViewModel\u0026gt; create( modelClass: Class\u0026lt;T\u0026gt;, extras: CreationExtras ): T { return UserDetailViewModel(extras.get(USER_ID_KEY)) as T } } } ) override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) viewModel.test() } companion object { val USER_ID_KEY = object : CreationExtras.Key\u0026lt;String\u0026gt; {} } } é€šè¿‡SavedStateHandleå­˜å‚¨ViewModelä¸­çš„å€¼ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 class MyViewModel( private val savedStateHandle: SavedStateHandle ) : ViewModel() { var userName: String? get() = savedStateHandle.get\u0026lt;String\u0026gt;(\u0026#34;user_name\u0026#34;) set(value) = savedStateHandle.set(\u0026#34;user_name\u0026#34;, value) } // Activity ä¸­ä½¿ç”¨ class UserDetailActivity : ComponentActivity() { // âœ… é»˜è®¤ä¼šè‡ªåŠ¨æä¾› SavedStateHandle private val viewModel: MyViewModel by viewModels() override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) viewModel.userName = \u0026#34;å¼ ä¸‰\u0026#34; val userName = viewModel.userName Log.d(\u0026#34;UserDetailActivity\u0026#34;, \u0026#34;onCreate:${userName}\u0026#34;) } // æˆ–è€…æ˜¾å¼æŒ‡å®šï¼ˆæ•ˆæœç›¸åŒï¼‰ //private val viewModel: MyViewModel by viewModels( // extrasProducer = { // defaultViewModelCreationExtras // åŒ…å« SavedStateHandle // } //) } SavedStateHandleä½œä¸ºviewModelä¸­å­˜å‚¨å€¼çš„ä»‹è´¨ï¼Œå®ƒèƒ½å¤Ÿä¿å­˜å˜é‡ï¼Œå®ƒåœ¨è¿›ç¨‹è¢«æ€åï¼Œè¿˜èƒ½æ¢å¤é‡Œé¢çš„å†…å®¹ï¼Œå®ƒç›¸å½“äºviewModel+onSaveInstanceStateçš„ç»“åˆä½“ã€‚ viewModelç›´æ¥å–Intentä¸­å­˜å‚¨çš„å€¼ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 class UserDetailViewModel( private val savedStateHandle: SavedStateHandle ) : ViewModel() { // âœ… ä» Intent è·å–å‚æ•°ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ private val userId: String get() = savedStateHandle.get\u0026lt;String\u0026gt;(\u0026#34;user_id\u0026#34;) ?: throw IllegalStateException(\u0026#34;user_id is required\u0026#34;) init { Log.d(\u0026#34;UserDetailViewModel\u0026#34;, \u0026#34;userId:$userId\u0026#34;) // å¦‚æœ Intent ä¸­æœ‰ user_idï¼Œä¼šè‡ªåŠ¨ä¿å­˜åˆ° savedStateHandle // å¯ä»¥é€šè¿‡ get() è·å– } fun test(){} } // Activity ä¸­ä¼ é€’å‚æ•° class UserDetailActivity : ComponentActivity() { private val viewModel: UserDetailViewModel by viewModels() override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) viewModel.test() } } å‡å¦‚å…¶ä»–çš„é¡µé¢è·³è½¬åˆ°UserDetailActivityæ—¶å€™ï¼Œä¼šå°†intentå‚æ•°ä¼ ç»™UserDetailActivityï¼Œæ­¤æ—¶åœ¨UserDetailViewModelä¸­èƒ½é€šè¿‡SavedStateHandleè·å–åˆ°Intentä¸­çš„å‚æ•°ã€‚ LiveDataçš„ä¸€äº›æ€è€ƒ liveDataæ˜¯åŸºäºç›‘å¬lifecycleç”Ÿå‘½å‘¨æœŸçš„æ•°æ®é©±åŠ¨æ¡†æ¶ï¼Œåœ¨lifecycleä¸ºSTARTEDæ‰ä¼šè§¦å‘è§¦å‘æ•°æ®é©±åŠ¨ï¼Œå¹¶ä¸”åœ¨lifecycleä¸ºDESTROYEDçš„æ—¶å€™è‡ªåŠ¨è§£ç»‘observerã€‚ æ¯”å¦‚æˆ‘åœ¨lifecycleçš„CREATEDçŠ¶æ€ç»™livedataçŒæ•°æ®ï¼Œç­‰åˆ°lifecycleçŠ¶æ€ä¸ºSTARTEDçš„æ—¶å€™å°±ä¼šç»™livedataçš„observerç»™å‘é€æ•°æ®ã€‚ å½“æå‰ç»™livedataçŒè¾“æ•°æ®çš„æ—¶å€™ï¼Œä½†æ˜¯æ­¤æ—¶è¿˜æ²¡æ·»åŠ observerï¼Œç­‰åˆ°æ·»åŠ observerçš„æ—¶å€™ï¼Œä¼šè‡ªåŠ¨æŠŠæ•°æ®åˆ†å‘åˆ°observerä¸­äº†ã€‚è¿™ä¸ªå°±æ˜¯æ•°æ®å€’çŒã€‚ä¸»è¦æ˜¯å› ä¸ºç»™livedataå‘é€æ•°æ®çš„æ—¶å€™ï¼Œlivedataä¸­çš„ç‰ˆæœ¬å·ä¼š+1ï¼Œä½†æ˜¯æ–°æ·»åŠ çš„observeræ­¤æ—¶çš„ç‰ˆæœ¬å·è¿˜æ˜¯-1ï¼Œæ‰€ä»¥åœ¨æ³¨å†Œçš„æ—¶å€™ï¼Œä¼šæŠŠæ•°æ®åˆ†å‘ç»™observerã€‚é€šå¸¸æ•°æ®å€’çŒçš„è§£å†³æ–¹æ¡ˆæ˜¯ï¼š æ¯æ¬¡åœ¨æ·»åŠ observerçš„æ—¶å€™ï¼Œåå°„å°†livedataä¸­çš„ç‰ˆæœ¬å·ç»™ç½®ä¸º0 é‡å†™livedataï¼Œç„¶åæ·»åŠ ä¸€ä¸ªå·²ç»æ³¨å†Œçš„æ ‡è®°(AtomicBoolean)ï¼Œç¬¬ä¸€æ¬¡è°ƒç”¨observeçš„æ—¶å€™æ‰ä¼šç»™è¯¥æ ‡è®°ç½®ä¸ºéç©ºã€‚æ­¤æ—¶åœ¨å‘é€æ•°æ®çš„æ—¶å€™åˆ¤æ–­å¦‚æœè¯¥æ ‡è®°ä¸ä¸ºç©ºï¼Œæ‰ä¼šç½®ä¸ºtrueï¼Œåœ¨observeçš„åœ°æ–¹é€šè¿‡åŒ…è£…ä¸€ä¸ªobserverï¼Œåªæœ‰è¯¥æ ‡è®°ç½®ä¸ºtrueäº†ï¼Œæ‰ä¼šç»™åˆ°ç›®æ ‡observerä¼ é€’æ•°æ®ã€‚ï¼ˆè¿™ç§æ–¹æ¡ˆåªé€‚åˆæ·»åŠ å•observerçš„åœºæ™¯ï¼Œå¦‚æœå¤šobserverå°±ä¸é€‚åˆäº†ï¼‰ ç»§æ‰¿livedataï¼Œç”¨ä¸€ä¸ªmapè®°å½•observeræ˜¯å¦æ¥æ”¶è¿‡æ¶ˆæ¯ï¼Œå¦‚æœæ¥æ”¶è¿‡äº†å°±ä¸èƒ½å†æ¥æ”¶ livedataä¸­çš„getVersionæ–¹æ³•æ˜¯åŒ…å†…å¯è§çš„ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥æ–°å»ºå’ŒlivedataåŒæ ·çš„åŒ…åçš„ç±»ï¼Œè¿™æ ·å°±èƒ½è®¿é—®getVersionæ–¹æ³•ï¼Œç„¶ååœ¨observeæ–¹æ³•ä¸­åˆ¤æ–­å¦‚æœversion\u0026gt;START_VERSIONæ‰ä¼šèƒ½æ¶ˆè´¹äº‹ä»¶ livedataä¸­setValueæ˜¯åŒæ­¥æ–¹æ³•ï¼Œæ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ã€‚postValueåœ¨ä¸€ä¸ªçº¿ç¨‹çš„æ—¶å€™ï¼Œå¦‚æœå‘é€æ•°æ®æ¯”è¾ƒé¢‘ç¹çš„æ—¶å€™ï¼Œåªä¼šæŠŠæœ€åä¸€ä¸ªæ•°æ®å‘é€ç»™observerï¼Œå› ä¸ºpostValueæ˜¯é€šè¿‡ç»™ä¸»çº¿ç¨‹çš„æ¶ˆæ¯é˜Ÿåˆ—å‘é€æ•°æ®ï¼Œç„¶åå‘é€ç»™observerã€‚åœ¨å¤šçº¿ç¨‹æƒ…å†µä¸‹è™½ç„¶è®¾ç½®æ•°æ®æ˜¯åŠ äº†åŒæ­¥å—ï¼Œä½†æ˜¯å› ä¸ºè¿˜æ˜¯ç»™ä¸»çº¿ç¨‹çš„æ¶ˆæ¯é˜Ÿåˆ—å‘é€æ¶ˆæ¯æ¥åˆ‡æ¢çº¿ç¨‹ï¼Œå¯¼è‡´å‰é¢çš„æ•°æ®ä¼šè¢«åé¢çš„æ•°æ®ç»™è¦†ç›–ã€‚ glideç¼“å­˜ glideç¼“å­˜åˆ†ä¸ºå†…å­˜å’Œç¡¬ç›˜ä¸¤ç±»ï¼Œå…¶ä¸­å†…å­˜ç¼“å­˜åˆåˆ†ä¸ºæ´»è·ƒç¼“å­˜å’ŒLRUç¼“å­˜ï¼Œç¡¬ç›˜ç¼“å­˜åˆ†ä¸ºè§£ç åæŒ‰ç…§viewå°ºå¯¸å±•ç¤ºçš„bitmapç¼“å­˜ï¼Œå¦å¤–ä¸€éƒ¨åˆ†æ˜¯åŸå§‹å›¾ç‰‡çš„ç¼“å­˜ã€‚ æ´»è·ƒç¼“å­˜ï¼šå®ƒçš„ç»“æ„æ˜¯ä¸€ä¸ªhashmapï¼Œå…¶ä¸­keyæ˜¯æŒ‰ç…§urlã€å°ºå¯¸ç­‰ä¿¡æ¯æ‹¼æˆçš„ï¼Œvalueæ˜¯ä¸€ä¸ªå¼±å¼•ç”¨å¯¹è±¡ï¼Œå…¶ä¸­å¼±å¼•ç”¨ä¸­æ”¾çš„æ‰æ˜¯å›¾ç‰‡ç¼“å­˜å¯¹è±¡ã€‚ LRUç¼“å­˜ï¼šå®ƒåº•å±‚æ˜¯ä¸€ä¸ªLRUç­–ç•¥çš„ç¼“å­˜ï¼Œkeyä¹Ÿæ˜¯å’Œä¸Šé¢æ´»è·ƒç¼“å­˜ç”¨çš„æ˜¯åŒä¸€ä¸ªã€‚valueå­˜çš„æ˜¯è§£ç åçš„å›¾ç‰‡ç¼“å­˜ã€‚ è§£ç åçš„ç¡¬ç›˜ç¼“å­˜ï¼šä¹Ÿæ˜¯ä½¿ç”¨çš„LRUç­–ç•¥çš„ç¼“å­˜ï¼Œå…¶ä¸­keyæ˜¯æŒ‰ç…§æŒ‡å®šå°ºå¯¸æ¥æ„å»ºçš„ï¼Œç„¶åä»DiskLruCacheä¸­è·å–ç¼“å­˜ã€‚ åŸå§‹å›¾ç‰‡çš„ç¡¬ç›˜ç¼“å­˜ï¼šä¹Ÿæ˜¯ä½¿ç”¨çš„LRUç­–ç•¥çš„ç¼“å­˜ï¼Œå…¶ä¸­keyä¸æ˜¯é€šè¿‡æŒ‡å®šå°ºå¯¸æ¥æ„å»ºçš„ï¼Œç„¶åä¹Ÿæ˜¯ä»DiskLruCacheä¸­è·å–ç¼“å­˜ã€‚ ç¼“å­˜è·å–æ­¥éª¤ï¼š LRUçš„å†…å­˜ç¼“å­˜æ˜¯åœ¨ä»€ä¹ˆå­˜å‚¨çš„ï¼Ÿ ä»ä¸Šé¢æµç¨‹å›¾æ¥çœ‹æ¯æ¬¡ä»éæ´»è·ƒç¼“å­˜ä¸­è·å–åˆ°å›¾ç‰‡ç¼“å­˜åï¼Œéƒ½ä¼šæ”¾å…¥åˆ°æ´»è·ƒç¼“å­˜ä¸­ï¼Œé‚£ä»€ä¹ˆæ—¶å€™ä¼šæ”¾åˆ°å†…å­˜çš„LRUç¼“å­˜ä¸­å‘¢ï¼Ÿå½“viewè§¦å‘onViewDetachedFromWindowçš„æ—¶å€™ï¼Œä¹Ÿå°±æ˜¯å½“å‰viewé”€æ¯åï¼Œä¼šæŸ¥çœ‹å½“å‰viewç»‘å®šçš„å›¾ç‰‡è¢«æ­£åœ¨ä½¿ç”¨æ ‡è®°çš„æ¬¡æ•°ï¼Œå¦‚æœæ¬¡æ•°ä¸º0äº†ï¼Œåˆ™å°†å½“å‰å›¾ç‰‡åŠ å…¥åˆ°LRUçš„å†…å­˜ç¼“å­˜ä¸­ã€‚ glideä¸ºä»€ä¹ˆè¦è®¾è®¡ä¸¤å±‚çš„å†…å­˜ç¼“å­˜ï¼Ÿ å†…å­˜ç¼“å­˜åˆ†ä¸ºæ´»è·ƒçš„ç¼“å­˜ï¼Œå®ƒæ˜¯ä¸€ä¸ªmapæ•°æ®ç»“æ„ï¼Œvalueå­˜å‚¨çš„æ˜¯å¼±å¼•ç”¨åŒ…è£…äº†ç¼“å­˜æ•°æ®ï¼Œå¦å¤–ä¸€å±‚æ˜¯LRUçº§åˆ«çš„ç¼“å­˜ã€‚æ´»è·ƒæ•°æ®æŒ‡çš„æ˜¯å½“å‰æ­£åœ¨ä½¿ç”¨çš„èµ„æºï¼Œæ¯”å¦‚æ­£åœ¨æ˜¾ç¤ºçš„å›¾ç‰‡ï¼Œè¿™éƒ¨åˆ†ç”¨å¼±å¼•ç”¨æ¥ä¿å­˜ï¼Œè¿™æ ·å½“å›¾ç‰‡ä¸å†è¢«ä½¿ç”¨æ—¶ï¼Œåƒåœ¾å›æ”¶å™¨å¯ä»¥è‡ªåŠ¨å›æ”¶ï¼Œé¿å…å†…å­˜æ³„æ¼ã€‚è€ŒLRUç¼“å­˜åˆ™æ˜¯æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„ç¼“å­˜ï¼Œä½¿ç”¨å¼ºå¼•ç”¨ï¼Œå½“å†…å­˜ä¸è¶³æ—¶ï¼Œä¼šç§»é™¤æœ€ä¹…æœªä½¿ç”¨çš„èµ„æºã€‚ å¦‚æœåªæœ‰LRUç¼“å­˜çš„æ—¶å€™ï¼Œæ­£åœ¨ä½¿ç”¨çš„å›¾ç‰‡å¯èƒ½æ˜¯é•¿æ—¶é—´æ²¡æœ‰è¢«è®¿é—®çš„å›¾ç‰‡ï¼Œè€Œæ­¤æ—¶å¦‚æœåªæœ‰LRUç¼“å­˜çš„æ—¶å€™ï¼Œå¯èƒ½ä¼šæŠŠæ­£åœ¨ä½¿ç”¨çš„å›¾ç‰‡ç¼“å­˜ç»™ç§»é™¤æ‰äº†ï¼Œè¿™æ ·çš„è¯ï¼Œå½“å†ä½¿ç”¨è¯¥å›¾ç‰‡çš„æ—¶å€™ï¼Œä¼šä»ç£ç›˜ä¸­å»è·å–è¯¥å›¾ç‰‡ï¼Œè¿™æ ·å¢å¤§äº†è·å–å›¾ç‰‡çš„æ—¶é—´ã€‚å¦‚æœåªæœ‰å¼±å¼•ç”¨ç¼“å­˜çš„æ—¶å€™ï¼Œæ­¤æ—¶å›¾ç‰‡ä¸è¢«ä½¿ç”¨äº†ï¼Œè¢«GCç»™å›æ”¶äº†ï¼Œé‚£æ­¤æ—¶ä¹Ÿåªèƒ½ä»ç£ç›˜ä¸­è·å–ï¼Œå¢å¤§äº†è·å–å›¾ç‰‡çš„æ—¶é—´ã€‚å¦‚æœæ­¤æ—¶æœ‰LRUç¼“å­˜ï¼Œèƒ½åœ¨å†…å­˜ä¸­ä¿ç•™ä¸€æ®µæ—¶é—´ï¼Œé™ä½ä»ç£ç›˜ä¸­è¯»å–çš„å¯èƒ½ã€‚ kotlinä¸­Sequenceå’Œæ™®é€šé›†åˆçš„åŒºåˆ« SequenceåŸç†æ˜¯æŒæœ‰äº†åŸæœ‰é›†åˆçš„iteratorï¼Œåœ¨ç­‰åˆ°è°ƒç”¨toListçš„æ—¶å€™ï¼Œæ‰ä¼šæ‹¿åˆ°Sequenceçš„iteratorè¿›è¡Œéå†ï¼Œç„¶åæ·»åŠ åˆ°æ–°çš„é›†åˆä¸­ã€‚ä¸­é—´çš„æ“ä½œç¬¦éƒ½ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„sequenceï¼Œç„¶åæ¯éå†ä¸€ä¸ªå…ƒç´ éƒ½ä¼šå»æ‰§è¡Œä¸€æ¬¡ä¸­é—´æ“ä½œç¬¦çš„iteratorçš„nextæ–¹æ³•ï¼Œç„¶åå°†ç»“æœç»™åˆ°ä¸‹ä¸€ä¸ªsequenceï¼Œæœ€åæ·»åŠ åˆ°æ–°çš„é›†åˆä¸­ã€‚ ä¼˜ç‚¹ï¼šç›¸è¾ƒäºæ™®é€šçš„é›†åˆï¼Œå®ƒæ˜¯æƒ°æ€§æ‰§è¡Œä¸­é—´æ“ä½œç¬¦ï¼Œå¹¶ä¸”ä¸­é—´çš„æ“ä½œç¬¦åªæ˜¯é€šè¿‡iteratorè¿›è¡Œè¿­ä»£æ¯ä¸€ä¸ªå…ƒç´ ï¼Œè€Œæ™®é€šçš„é›†åˆæ˜¯æ¯ä¸€ä¸ªæ“ä½œç¬¦ä¼šæ–°ç”Ÿæˆä¸€ä¸ªé›†åˆï¼Œå¯¼è‡´å†…å­˜ä¼šå¢é«˜ã€‚Sequenceçš„ä½¿ç”¨åœºæ™¯æ˜¯ä¸­é—´æ“ä½œç¬¦æ¯”è¾ƒå¤šçš„æƒ…å†µä¸‹è¿›è¡Œä½¿ç”¨ï¼Œä¸ä¼šå¢åŠ æ–°çš„é›†åˆï¼Œå¹¶ä¸”æ˜¯æƒ°æ€§éå†å…ƒç´ ã€‚ æ¯”å¦‚ä¸‹é¢è¿™ä¸ªæ“ä½œï¼š\n1 2 3 4 5 6 7 8 9 10 11 listOf(1, 2, 3, 4, 5) .asSequence() .map { println(\u0026#34;sequence map:$it\u0026#34;) it * 2 } .filter { println(\u0026#34;sequence filter:$it\u0026#34;) it \u0026gt; 5 } .toList() åœ¨è°ƒç”¨toListæ—¶å€™ï¼Œæ‰ä¼šæ‰§è¡Œä¸Šé¢çš„mapå’Œfilteræ–¹æ³•ï¼Œå¹¶ä¸”mapå’Œfilteréå†å…ƒç´ çš„æ—¶å€™ï¼Œæ˜¯æ¯ä¸ªå…ƒç´ ä¾æ¬¡è°ƒç”¨åˆ°mapå’Œfilterï¼Œä¸­é—´æ˜¯é€šè¿‡sequenceçš„iteratorè¿›è¡Œéå†ï¼Œä¸ä¼šäº§ç”Ÿä¸­é—´çš„é›†åˆã€‚ æ—¥å¿—å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 sequence map:1 sequence filter:2 sequence map:2 sequence filter:4 sequence map:3 sequence filter:6 sequence map:4 sequence filter:8 sequence map:5 sequence filter:10 å†æ¥çœ‹ä¸‹æ™®é€šé›†åˆçš„æ“ä½œï¼š\n1 2 3 4 5 6 7 listOf(1, 2, 3, 4, 5).map { println(\u0026#34;list map:$it\u0026#34;) it * 2 }.filter { println(\u0026#34;list filter:$it\u0026#34;) it \u0026gt; 5 } ä¸Šé¢çš„mapå’Œfilteræ˜¯åˆ†å¼€æ‰§è¡Œçš„ï¼Œä¸ä¼šç­‰åˆ°æœ€åæ‰æ‰§è¡Œï¼Œæ‰€ä»¥æ²¡æœ‰æƒ°æ€§ï¼Œmapå’Œfilteréƒ½ä¼šäº§ç”Ÿæ–°çš„é›†åˆï¼Œå¹¶ä¸”åœ¨éå†å…ƒç´ çš„æ—¶å€™ï¼Œæ¯ä¸€ä¸ªæ“ä½œç¬¦æ˜¯å…ˆéå†å®Œæ¯ä¸€ä¸ªå…ƒç´ ï¼Œç„¶åæ‰æ‰§è¡Œä¸‹ä¸€ä¸ªæ“ä½œç¬¦çš„éå†ã€‚ æ—¥å¿—å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 list map:1 list map:2 list map:3 list map:4 list map:5 list filter:2 list filter:4 list filter:6 list filter:8 list filter:10 kotlinä¸­Sequenceå’Œé›†åˆçš„StreamåŒºåˆ« Streamæ˜¯java1.8ä¹‹åå‡ºçš„è¯­æ³•ï¼Œå’ŒSequenceä¸€æ ·æ”¯æŒæµå¼å’Œæƒ°æ€§çš„ç‰¹ç‚¹ï¼Œå®ƒåœ¨éå†å…ƒç´ çš„æ—¶å€™ä¹Ÿæ˜¯æ¯ä¸ªå…ƒç´ éƒ½ä¼šæŒ‰é¡ºåºç»è¿‡ä¸­é—´çš„æ“ä½œç¬¦ï¼Œä¸åƒæ™®é€šçš„é›†åˆé‚£æ ·æ¯ä¸ªå…ƒç´ å¿…é¡»å…ˆæ‰§è¡Œå®Œä¸€ä¸ªæ“ä½œç¬¦ï¼Œç„¶åæ‰è¿›è¡Œä¸‹ä¸€ä¸ªæ“ä½œç¬¦ã€‚ä½†æ˜¯Streamåªèƒ½ä¸€æ¬¡æ€§æ¶ˆè´¹ï¼Œæ¶ˆè´¹å®Œåï¼Œå°±ä¸èƒ½å†ä½¿ç”¨è¯¥streamã€‚è€ŒSequenceå¯ä»¥å¤šæ¬¡ä½¿ç”¨ã€‚åŒæ—¶Streamçš„parallelStreamæ–¹æ³•æ”¯æŒå¹¶å‘å¤„ç†ï¼Œéå†å…ƒç´ çš„æ—¶å€™ï¼Œä¸æ˜¯æŒ‰ç…§å…ƒç´ ä¼šé¡ºåºæ‰§è¡Œæ¯ä¸€ä¸ªæ“ä½œç¬¦ï¼Œå½“æ•°æ®é‡å¤§çš„æ—¶å€™å¯ä»¥è€ƒè™‘ä½¿ç”¨parallelStreamã€‚\ncompanion objectå’Œobjectä¸­å®šä¹‰å˜é‡ åœ¨companion objectå®šä¹‰éconstå˜é‡çš„æ—¶å€™ï¼Œä¼šåœ¨Companionå†…éƒ¨ç±»ä¸­æä¾›getæ–¹æ³•ï¼Œåœ¨å¤–éƒ¨ç±»ä¸­å®šä¹‰è¯¥å¸¸é‡ï¼š\n1 2 3 4 5 class Test { companion object{ val name=\u0026#34;å¼ ä¸‰\u0026#34; } } ç”Ÿæˆçš„classä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 public final class Test { @NotNull private static final String name = \u0026#34;å¼ ä¸‰\u0026#34;; @NotNull public static final Companion Companion = new Companion((DefaultConstructorMarker)null); public static final class Companion { @NotNull public final String getName() { return Test.name; } private Companion() { } // $FF: synthetic method public Companion(DefaultConstructorMarker $constructor_marker) { this(); } } } å¦‚æœkotlinä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 class Test { companion object{ const val name=\u0026#34;å¼ ä¸‰\u0026#34; } } å¯¹åº”classä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 public final class Test { @NotNull public static final String name = \u0026#34;å¼ ä¸‰\u0026#34;; @NotNull public static final Companion Companion = new Companion((DefaultConstructorMarker)null); public static final class Companion { private Companion() { } // $FF: synthetic method public Companion(DefaultConstructorMarker $constructor_marker) { this(); } } } åœ¨æœ‰constçš„æ—¶å€™ï¼Œä¸ä¼šåœ¨Companionå†…éƒ¨ç±»ä¸­æä¾›getæ–¹æ³•ã€‚åªä¼šåœ¨å¤–éƒ¨ç±»æä¾›å…¬å¼€ç±»å‹çš„å¸¸é‡ã€‚ å¦‚æœåœ¨objectç±»ä¸­å®šä¹‰constå˜é‡ï¼Œå¦‚ä¸‹ï¼š\n1 2 3 object Test { const val name=\u0026#34;å¼ ä¸‰\u0026#34; } ä¼šç”Ÿæˆå¦‚ä¸‹classï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 public final class Test { @NotNull public static final String name = \u0026#34;å¼ ä¸‰\u0026#34;; @NotNull public static final Test INSTANCE; private Test() { } static { Test var0 = new Test(); INSTANCE = var0; } } å¦‚æœå»æ‰constä¼šç”Ÿæˆå¦‚ä¸‹class:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 public final class Test { @NotNull private static final String name; @NotNull public static final Test INSTANCE; @NotNull public final String getName() { return name; } private Test() { } static { Test var0 = new Test(); INSTANCE = var0; name = \u0026#34;å¼ ä¸‰\u0026#34;; } } ä»ä¸Šé¢ä¼´ç”Ÿå¯¹è±¡å’Œobjectç±»å‘ç°ä¼´ç”Ÿå¯¹è±¡ä¼šç”Ÿæˆå†…éƒ¨ç±»ï¼Œå¹¶é€šè¿‡é¥¿æ±‰å¼ç”Ÿæˆå•ä¾‹ã€‚objectæ˜¯åœ¨å†…åŠ è½½çš„æ—¶å€™ç”Ÿæˆå•ä¾‹ã€‚\nè®°å½•ä¸€æ¬¡gradleç¼–è¯‘é—®é¢˜ é—®é¢˜ï¼šåœ¨æ·»åŠ æŸä¸ªå¹¿å‘Šsdkåï¼Œå‘ç°å·¥ç¨‹ä¸­ç¼–è¯‘ä¼šæŠ¥é”™ï¼ŒæŠ¥é”™ä¿¡æ¯å¦‚ä¸‹ï¼š Caused by: org.jetbrains.kotlin.gradle.tasks. CompilationErrorException: Compilation error. See log for more details \u0026lsquo;onNewIntent\u0026rsquo; overrides nothing è¯¥é—®é¢˜è¯´activityçš„å­ç±»ï¼ˆkotlinç±»ï¼‰ä¸­å‡ºç°äº†onNewIntentæ–¹æ³•ä¸­çš„intentå‚æ•°å®šä¹‰å¯ä¸ºç©ºäº†ï¼Œå°±å¢åŠ äº†ä¸€ä¸ªå¹¿å‘Šçš„sdkåï¼Œæ€ä¹ˆå°±æç¤ºintentè¦å®šä¹‰æˆä¸ä¸ºç©ºçš„å‘¢ã€‚æ—¢ç„¶æ˜¯å¹¿å‘Šsdkå¯¼è‡´çš„ï¼Œé‚£ä¹ˆä¸‹é¢å°±æŒ‰ç…§ä¾èµ–å…³ç³»æŠŠé—®é¢˜æ‰¾åˆ°ï¼Œæ‰§è¡Œgradleçš„å‘½ä»¤å¦‚ä¸‹ï¼š 1 ./gradlew app:dependencies --configuration debugRuntimeClasspath \u0026gt; dependencies.txt ä¸Šé¢å‘½ä»¤ä¼šæ‰¾åˆ°appä¾èµ–çš„æ‰€æœ‰moduleçš„é—´æ¥ä¾èµ–ï¼Œå¹¶è¾“å‡ºåˆ°æ–‡ä»¶ä¸­ï¼Œç›´æ¥çœ‹æ–°å¢çš„å¹¿å‘Šsdkçš„moduleä¿¡æ¯ï¼š\n1 +--- androidx.activity:activity-ktx:1.7.1 -\u0026gt; 1.9.2 (*) å¯ä»¥çœ‹åˆ°ï¼Œåœ¨å¹¿å‘Šsdkä¸­ä¼šæŠŠactivity-ktxçš„ç‰ˆæœ¬ä»1.7.1å‡çº§åˆ°1.9.2ï¼Œç»§ç»­é¡ºè—¤æ‘¸ç“œï¼Œå‘ç°åœ¨1.9.2çš„ç‰ˆæœ¬ä¸­ ComponentActivity ï¼Œä¼šç»™onNewIntentæ–¹æ³•çš„intentå‚æ•°åŠ ä¸Šäº† @Suppress(\u0026quot;InvalidNullabilityOverride\u0026quot;) æ³¨è§£ï¼Œè€Œåœ¨1.7.1ç‰ˆæœ¬ä¸­æ˜¯åŠ ä¸Š @SuppressLint({\u0026quot;UnknownNullness\u0026quot;, \u0026quot;MissingNullability\u0026quot;}) æ³¨è§£ã€‚é€šè¿‡Geminiå¯¹æ¯”ä¸¤è€…çš„åŒºåˆ«ï¼Œæœ€ç»ˆå¾—å‡ºç»“è®ºï¼š\n@Suppress(\u0026ldquo;InvalidNullabilityOverride\u0026rdquo;) å¦‚æœä¸€ä¸ª Java æ–¹æ³•çš„å‚æ•°æ˜¯ String paramï¼ŒKotlin ç¼–è¯‘å™¨å¯èƒ½æ— æ³•ç¡®å®šå®ƒæ˜¯å¯ç©º (String?) è¿˜æ˜¯éç©º (String)ã€‚å¦‚æœä½ å°†å…¶é‡å†™ä¸º param: String?ï¼ˆå¯ç©ºï¼‰ï¼Œä½† Kotlin ç¼–è¯‘å™¨å†…éƒ¨æ¨æ–­å®ƒåº”è¯¥æ˜¯ Stringï¼ˆéç©ºï¼‰ï¼Œæˆ–è€…åä¹‹ï¼Œå°±ä¼šè§¦å‘ InvalidNullabilityOverride è­¦å‘Šã€‚ @SuppressLint({\u0026quot;UnknownNullness\u0026quot;, \u0026quot;MissingNullability\u0026quot;}) å®ƒæ˜¯lintä¸­çš„æ³¨è§£ï¼Œç”¨äºæŠ‘åˆ¶ Lint å·¥å…·å‘å‡ºçš„ç‰¹å®šè­¦å‘Šæˆ–é”™è¯¯ã€‚UnknownNullnessï¼šå½“ Lint å·¥å…·æ— æ³•ç¡®å®šæŸä¸ªå˜é‡ã€å‚æ•°æˆ–è¿”å›ç±»å‹çš„ç©ºå®‰å…¨æ€§æ—¶ï¼ˆé€šå¸¸æ˜¯å› ä¸ºå®ƒæ¥è‡ªæ²¡æœ‰ç©ºå®‰å…¨æ³¨è§£çš„ Java ä»£ç æˆ–ç¬¬ä¸‰æ–¹åº“ï¼‰ï¼Œå®ƒä¼šå‘å‡ºæ­¤è­¦å‘Šï¼Œæé†’ä½ å…¶ç©ºå®‰å…¨æ€§æ˜¯æœªçŸ¥çš„ã€‚MissingNullabilityï¼šå½“ Lint è®¤ä¸ºæŸä¸ªåœ°æ–¹åº”è¯¥æœ‰ç©ºå®‰å…¨æ³¨è§£ï¼ˆ@NonNull æˆ– @Nullableï¼‰ï¼Œä½†å´ç¼ºå¤±äº†æ—¶ï¼Œå®ƒä¼šå‘å‡ºæ­¤è­¦å‘Šã€‚è¿™é€šå¸¸å‘ç”Ÿåœ¨ä½ åœ¨ç¼–å†™ Java ä»£ç ï¼Œä½†æ²¡æœ‰ä¸ºå‚æ•°æˆ–è¿”å›ç±»å‹æ˜ç¡®æ·»åŠ ç©ºå®‰å…¨æ³¨è§£æ—¶ã€‚ ç›®çš„ï¼š å‘Šè¯‰ Lint å·¥å…·ï¼šâ€œæˆ‘å·²ç»æ„è¯†åˆ°è¿™é‡Œå­˜åœ¨ç©ºå®‰å…¨æ³¨è§£ç¼ºå¤±æˆ–æœªçŸ¥ç©ºå®‰å…¨æ€§çš„é—®é¢˜ï¼Œä½†æˆ‘æœ‰ç†ç”±ä¸æ·»åŠ æ³¨è§£æˆ–æ¥å—å½“å‰çŠ¶æ€ï¼Œè¯·ä¸è¦å†è­¦å‘Šæˆ‘ã€‚â€ ä»ä¸Šé¢åˆ†æå¯çŸ¥ï¼Œè€Œactivityä¸­çš„onNewIntentæ–¹æ³•ä¸­ç¡®å®æ²¡æœ‰ä»»ä½•éç©ºå’Œå¯ç©ºçš„æ³¨è§£ï¼Œåœ¨1.7.1ç‰ˆæœ¬ä¸­é€šè¿‡lintæ³¨è§£æ¥å‘Šè¯‰lintï¼Œè¿™é‡Œçš„intentå‚æ•°æ˜¯ä¸å¯ç¡®å®šçš„ç©ºå‚æ•°ï¼Œä¸éœ€è¦å‘å‡ºè­¦å‘Šã€‚è€Œåœ¨1.9.2ç‰ˆæœ¬ä¸­å¼ºåˆ¶è¦æ±‚å­ç±»ä¸­å¿…é¡»ä¸ºéç©ºçš„ï¼Œå› æ­¤å½“ä¹‹å‰çš„å­ç±»æ˜¯å¯ç©ºçš„æ—¶å€™ï¼Œå°±ä¼šå‡ºç°å‰é¢æ‰€è¯´çš„ç¼–è¯‘é—®é¢˜ æ–¹æ¡ˆï¼šç›´æ¥åœ¨æ·»åŠ å¹¿å‘Šsdkçš„åœ°æ–¹ï¼Œæ’é™¤æ‰activity-ktxçš„ä¾èµ–ï¼š 1 exclude group: \u0026#34;androidx.activity\u0026#34;, module: \u0026#34;activity-ktx\u0026#34; kotlinåç¨‹ä¸­çš„withTimeoutOrNullä½œç”¨ åœºæ™¯adbä¸­å‘½ä»¤ é€šè¿‡åŒ…åæŸ¥çœ‹pid adb shell pidof åŒ…å è¿”å›è¿›ç¨‹çš„idï¼Œé€šè¿‡è¯¥idåé¢å¯ä»¥åšå¾ˆå¤šäº‹æƒ… adb shell cat /proc/pid/stat è·å–App cpuä½¿ç”¨æ—¶é—´ 3541 (è¿›ç¨‹å) S 906 906 0 0 -1 1077952832 801953 19794 170 1 195874 29787 16 55 10 -10 247 0 76295047 29784014848 99929 18446744073709551615 1 1 0 0 0 0 4612 1 1073775868 0 0 0 17 4 0 0 3 0 0 0 0 0 0 0 0 0 0 ä¸Šé¢çš„14-17éƒ¨åˆ†æ˜¯æˆ‘ä»¬å…³å¿ƒçš„æ•°æ® 195874ï¼šutimeï¼ˆè¿›ç¨‹çš„ç”¨æˆ·æ€æ—¶é—´ï¼‰ 29787ï¼šstimeï¼ˆè¿›ç¨‹çš„å†…æ ¸æ€æ—¶é—´ï¼‰ 16ï¼šcutimeï¼ˆå­è¿›ç¨‹çš„ç”¨æˆ·æ€æ—¶é—´ï¼‰ 55ï¼šcstimeï¼ˆå­è¿›ç¨‹çš„å†…æ ¸æ€æ—¶é—´ï¼‰ æŠŠè¿™å‡ ä¸ªåŠ èµ·æ¥å°±å¯ä»¥å¾—åˆ°å½“å‰Appæ€»CPUä½¿ç”¨æ—¶é—´ å¿«é€ŸæŸ¥çœ‹æŸä¸ªåº”ç”¨çš„activityæ ˆçš„æƒ…å†µ adb shell dumpsys activity activities | grep Hist | grep åŒ…å é˜¿é‡Œäº‘åŸŸåå¦‚ä½•å…³è”github page é¦–å…ˆæ¥åˆ° äº‘è§£æDNS/å…¬ç½‘æƒå¨è§£ææ¨¡å— ï¼Œç„¶åæ‰¾åˆ°è´­ä¹°çš„åŸŸåï¼Œè¿›å…¥åˆ°è§£æè®¾ç½®çš„tabï¼Œé€‰æ‹© æ·»åŠ è®°å½• ï¼Œæ·»åŠ ä¸¤é¡¹ä¿¡æ¯ï¼š\nå…¶ä¸­æ­¤å¤„çš„ `185.199.108.153` æ˜¯githubé»˜è®¤çš„ipåœ°å€ Class.isAssignableFrom() åˆ¤æ–­å½“å‰classæ˜¯ä¸æ˜¯å‚æ•°ä¸­classçš„çˆ¶ç±»ç±»å‹æˆ–å½“å‰ç±»å‹ï¼Œæ¯”å¦‚Drawable.class.isAssignableFrom(BitmapDrawable.class)è¿”å›ä¸ºtrueã€‚\nurlè½¬uri 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 private static Uri parseUri(String model) { Uri uri; if (TextUtils.isEmpty(model)) { return null; // See https://pmd.github.io/pmd-6.0.0/pmd_rules_java_performance.html#simplifystartswith } else if (model.charAt(0) == \u0026#39;/\u0026#39;) { uri = toFileUri(model); } else { uri = Uri.parse(model); String scheme = uri.getScheme(); if (scheme == null) { uri = toFileUri(model); } } return uri; } private static Uri toFileUri(String path) { return Uri.fromFile(new File(path)); } å¦‚æœæ˜¯å½¢å¦‚/path1/path2è¿™ç§å½¢å¼ç›´æ¥é€šè¿‡toFileUriè½¬åŒ–æˆUriï¼Œå¦‚æœä¸æ˜¯ï¼Œåˆ™é€šè¿‡Uri.parseè½¬åŒ–æˆUriï¼Œå¹¶åˆ¤æ–­Uriçš„schemeï¼Œschemeæ˜¯ä»€ä¹ˆï¼š scheme = â€œhttpsâ€ ä¹Ÿå°±æ˜¯ https:// å‰é¢è¿™ä¸€æ®µã€‚ scheme è¡¨ç¤º URI ä½¿ç”¨çš„åè®®ï¼ˆProtocolï¼‰æˆ–è®¿é—®æ–¹å¼ï¼ˆAccess Methodï¼‰ã€‚ å®ƒå‘Šè¯‰ç³»ç»Ÿæˆ–æµè§ˆå™¨ï¼š\nè¿™ä¸ªèµ„æºåº”è¯¥ç”¨å“ªç§åè®®æ¥è®¿é—®ã€‚\næ¯”å¦‚å¸¸è§schemeï¼š\nscheme å«ä¹‰ http é€šè¿‡ HTTP åè®®è®¿é—®èµ„æº https é€šè¿‡ HTTPSï¼ˆåŠ å¯†çš„ HTTPï¼‰åè®®è®¿é—®èµ„æº ftp ä½¿ç”¨ FTP ä¸‹è½½/ä¸Šä¼ æ–‡ä»¶ file æœ¬åœ°æ–‡ä»¶ï¼Œä¾‹å¦‚ file:///sdcard/test.txt content Android çš„ ContentProviderï¼Œä¾‹å¦‚ Uri.fromFile æˆ– content://media data Data URIï¼Œç›´æ¥æŠŠæ•°æ®ç¼–ç åœ¨ URI å†… mailto æ‰“å¼€é‚®ç®±ï¼Œä¾‹å¦‚ mailto:xxx@gmail.com Mathç›¸å…³æ–¹æ³• Math.ceil: å‘ä¸Šå–æ•´ï¼Œæ¯”å¦‚6.1å‘ä¸Šå–æ•´å¾—åˆ°7 Math.floor: å‘ä¸‹å–æ•´ï¼Œæ¯”å¦‚6.7å‘ä¸‹å–æ•´å¾—åˆ°6 Math.round: å››èˆäº”å…¥è®¡ç®—å–æ•´ plantUmlä¸­classå…³ç³»è¯´æ˜ ç»§æ‰¿ï¼šA \u0026ndash;|\u0026gt; B å®ç°ï¼šA ..|\u0026gt; B æ„æˆï¼šA \u0026ndash;* Bï¼Œè¡¨ç¤ºAå¼ºä¾èµ–Bï¼Œæ•´ä½“ä¸éƒ¨åˆ†ä¸å¯åˆ†ç¦» 1 2 3 class Car { private Engine engine = new Engine(); // Car æ­» Engine å¿…æ­» } Car \u0026ndash;* Engine èšåˆï¼šA \u0026ndash;o Bï¼Œå¼±ä¾èµ–ï¼Œæ•´ä½“ä¸éƒ¨åˆ†å¯ç‹¬ç«‹å­˜åœ¨ã€‚ 1 2 3 class Team { private List\u0026lt;Player\u0026gt; players; // players ä¸éš team å¼ºåˆ¶é”€æ¯ } Team \u0026ndash;o Player 5. ä¾èµ–ï¼šA \u0026ndash;\u0026gt; Bï¼Œç±»åœ¨è¿è¡Œæ—¶ä½¿ç”¨å¦ä¸€ä¸ªç±»ï¼Œé€šå¸¸è¡¨ç¤ºå±€éƒ¨å˜é‡ã€æ–¹æ³•å‚æ•°ã€‚\n1 2 3 4 5 class OrderService { void createOrder(Order order) { OrderValidator validator = new OrderValidator(); // ä¾èµ– } } OrderService \u0026ndash;\u0026gt; OrderValidator\nadbå¿«é€Ÿæ— çº¿è¿æ¥ è®¾ç½®adbçš„ç«¯å£å·ï¼š 1 adb tcpip 5555 é¦–å…ˆæ˜¾ç¤ºwifiçš„ipåœ°å€ï¼š 1 adb shell ip addr show wlan0 è¿æ¥è®¾å¤‡ 1 adb connect åé¢è·Ÿipåœ°å€ javaä¸­byteè½¬æˆint é¦–å…ˆbyteçš„å–å€¼èŒƒå›´æ˜¯-128åˆ°127ï¼Œå®ƒæ˜¯å ç”¨2ä¸ªå­—èŠ‚ï¼Œå®ƒçš„æœ€å¤§å€¼æ˜¯0111 1111,ä¹Ÿå°±æ˜¯2^7-1 = 127ã€‚æœ€å°å€¼æ˜¯1000 0000ï¼Œæœ€é«˜ä½ä¸º1ï¼Œä¹Ÿå°±æ˜¯è´Ÿæ•°ï¼Œæ‰€ä»¥æ˜¯-2^7=-128ã€‚ å¦‚æœbyteçš„äºŒè¿›åˆ¶ç›´æ¥å¾—åˆ°intçš„è¯ï¼Œä¼šçœ‹å®ƒçš„æœ€é«˜ä½ï¼Œå¦‚æœæ˜¯1çš„è¯ï¼Œåˆ™æ˜¯è´Ÿæ•°ã€‚è´Ÿæ•°æ˜¯ç”¨è¡¥ç (å–å)+1ï¼š 1 2 byte b = (byte) 0xF0;//1111 0000ï¼Œæœ€é«˜ä¸€ä½æ˜¯1ï¼Œæ‰€ä»¥æ˜¯è´Ÿæ•°ï¼Œè´Ÿæ•°æ˜¯ç”¨è¡¥ç (å–å)+1ï¼Œå…ˆå–å:0000 1111,å†åŠ ä¸€:0001 0000ï¼Œå¾—åˆ°-16 System.out.println(\u0026#34;b = \u0026#34; + b); æ‰€ä»¥ä¸ºäº†æ¶ˆé™¤byteè¡¨ç¤ºæ•´æ•°çš„é—®é¢˜ï¼Œé‚£ä¹ˆéœ€è¦å…ˆå°†byteæ•°å’Œ0xffè¿›è¡Œç›¸ä¸ï¼Œç„¶åå°±å¾—åˆ°æ•´æ•°ï¼š 1 2 3 byte b = (byte) 0xF0; int i = b \u0026amp; 0xFF; System.out.println(\u0026#34;i = \u0026#34; + i);//240=2^7+2^6+2^5+2^4 javaä¸­å­—èŠ‚æµçš„å¤„ç† javaä¸­å­—èŠ‚æµä¸»è¦æŒ‡BufferedInputStreamï¼Œå®ƒå¯ä»¥é€šè¿‡å°†FileInputStreamä½œä¸ºè¢«è£…é¥°å¯¹è±¡ï¼Œç„¶åè¿›è¡Œæ‰©å±•ï¼Œè¿™ä¹Ÿæ˜¯javaä¸­ioä½¿ç”¨åˆ°äº†è£…é¥°è€…æ¨¡å¼ã€‚è£…é¥°è€…åˆ†ä¸ºæŠ½è±¡ç»„ä»¶å’Œå…·ä½“ç»„ä»¶ã€‚è£…é¥°å™¨åˆ†ä¸ºæŠ½è±¡è£…é¥°å™¨å’Œå…·ä½“è£…é¥°å™¨ã€‚å…¶ä¸­InputStreamæ˜¯æŠ½è±¡ç»„ä»¶ï¼ŒFileInputStreamæ˜¯å…·ä½“ç»„ä»¶ã€‚FilterInputStreamæ˜¯æŠ½è±¡è£…é¥°å™¨ï¼Œä¹Ÿå°±æ˜¯BufferedInputStreamçš„çˆ¶ç±»ï¼Œå®ƒä¹Ÿç»§æ‰¿è‡ªæŠ½è±¡ç»„ä»¶InputStreamã€‚è€ŒBufferedInputStreamæ˜¯å…·ä½“çš„è£…é¥°å™¨ã€‚å¯ä»¥åœ¨å­—èŠ‚å¤„ç†ä¸Šè¿›è¡Œæ‰©å±•ã€‚ BufferedInputStreamå®ƒæ˜¯å¸¦æœ‰ä¸€ä¸ªbyteæ•°ç»„çš„ç¼“å†²åŒºï¼Œå®ƒå¯ä»¥å°†å†…å®¹è¯»å–åˆ°è¯¥ç¼“å†²åŒºä¸­ï¼Œç„¶åé€šè¿‡ç¼“å†²åŒºè·å–åˆ°æ–‡ä»¶ä¸­çš„å†…å®¹ã€‚ ä¾‹å­ï¼šæœ‰ä¸ª12345678æ•°å­—çš„test.txtæ–‡ä»¶ï¼Œæƒ³é€šè¿‡BufferedInputStreamæ¥è¯»å–ï¼š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 public class TestBufferInputStream { public static void main(String[] args) throws IOException { //æ­¤å¤„çš„test.txtæ–‡ä»¶æ˜¯8ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥åœ¨ä¸‹é¢çš„æ•°æ®ä¸­æ˜¯8æ¬¡ BufferedInputStream bufferedInputStream = new BufferedInputStream(new FileInputStream(\u0026#34;./test.txt\u0026#34;), 4); int data = 0; //readæ–¹æ³•BufferedInputStreamä¼šç»å†ä¸¤æ¬¡fillï¼Œfillå®Œåä¼šå°†byteæ•°æ®æ”¾åˆ°ç¼“å†²åŒºä¸­ while ((data = bufferedInputStream.read()) != -1) { System.out.println(\u0026#34;char data = \u0026#34; + ((char) data)); } byte[] bytes = new byte[4]; FileInputStream fileInputStream = new FileInputStream(\u0026#34;./test.txt\u0026#34;); //è¯»å–ç¬¬ä¸€æ¬¡ï¼Œåªè¯»å–4ä¸ªå­—èŠ‚ fileInputStream.read(bytes,0,4); for (byte aByte : bytes) { char result = (char)(aByte \u0026amp; 0xff); System.out.println(\u0026#34;result = \u0026#34; + result); } System.out.println(\u0026#34;=========\u0026#34;); //è¯»å–ç¬¬äºŒæ¬¡ï¼Œæ¯æ¬¡è¯»å–åˆ°çš„å†…å®¹éƒ½ä¼šä»ä¸Šä¸€æ¬¡è¯»å–çš„ä½ç½®å¼€å§‹è¯»å–å†…å®¹ fileInputStream.read(bytes,0,4); for (byte aByte : bytes) { char result = (char)(aByte \u0026amp; 0xff); System.out.println(\u0026#34;result = \u0026#34; + result); } } } è¯»å–ç»“æœï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 char data = 1 char data = 2 char data = 3 char data = 4 char data = 5 char data = 6 char data = 7 char data = 8 result = 1 result = 2 result = 3 result = 4 ========= result = 5 result = 6 result = 7 result = 8 åœ¨ä¸Šé¢å®šä¹‰äº†ç¼“å†²åŒºçš„å¤§å°ä¸º4å­—èŠ‚ï¼Œè€Œæ–‡ä»¶å†…å®¹æ˜¯8å­—èŠ‚ã€‚å½“ç¼“å†²åŒºå†…å®¹æ»¡çš„æ—¶å€™ï¼Œä¼šå†æ¬¡ç»™ç¼“å†²åŒºå¡«å……å†…å®¹ï¼Œè€Œå¡«å……å†…å®¹çš„æ—¶å€™ï¼Œåº•å±‚æµä¼šè®°ä½fillå‰çš„ä½ç½®ï¼Œæ‰€ä»¥å½“ç¬¬äºŒæ¬¡fillæ—¶å€™ï¼Œä¼šæŠŠå‰©ä½™çš„4å­—èŠ‚æ•°æ®åˆè¯»å–åˆ°ç¼“å†²åŒºä¸­ã€‚æ¯æ¬¡filléƒ½ä¼šæŠŠåŸæ¥çš„æ•°æ®ç»™è¦†ç›–æ‰äº†ï¼Œå› ä¸ºåœ¨fillä¸­åˆ¤æ–­markPosæ˜¯å¦ä¸º0ï¼Œå¦‚æœä¸º0ã€‚åˆ™æ–°ä½ç½®ä»0å¼€å§‹ã€‚\nBufferedInputStreamå¸¦æœ‰æ ‡è®°åŠŸèƒ½ï¼Œé€šè¿‡markæ–¹æ³•æ¥æ ‡è®°å½“å‰çš„ä½ç½®ï¼Œå½“å‘ç°æœ‰markæ—¶å€™ï¼Œfillä¸­ä¼šå°†markä¹‹åä½ç½®æ•°æ®ç»™æ”¾åˆ°ç¼“å†²åŒºçš„å¼€å¤´ä½ç½®ã€‚è€Œå°†å‰©ä½™çš„ç©ºé—´è®©ç»™æ–°çš„æ•°æ®ç»§ç»­è¯»å–ã€‚ BufferedInputStreamçš„å›é€€èƒ½åŠ›ï¼Œå¦‚æœæ ‡è®°åï¼Œæˆ‘ä»¬æƒ³å›åˆ°è¢«æ ‡è®°ä½ç½®ï¼Œè°ƒç”¨resetæ–¹æ³•èƒ½å›åˆ°è¢«æ ‡è®°çš„ä½ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 public class TestBufferInputStream1 { public static void main(String[] args) throws IOException { //æ­¤å¤„çš„test.txtæ–‡ä»¶æ˜¯8ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥åœ¨ä¸‹é¢çš„æ•°æ®ä¸­æ˜¯8æ¬¡ BufferedInputStream bufferedInputStream = new BufferedInputStream(new FileInputStream(\u0026#34;./test.txt\u0026#34;)); char a = (char)bufferedInputStream.read(); char b = (char)bufferedInputStream.read(); bufferedInputStream.mark(3);//åœ¨pos=2ï¼Œä¹Ÿå°±æ˜¯ç¬¬3ä¸ªä½ç½®åšæ ‡è®°ï¼Œmarklimit=3 char e = (char)bufferedInputStream.read(); char f = (char)bufferedInputStream.read(); System.out.println(\u0026#34;a = \u0026#34; + a);//1 System.out.println(\u0026#34;b = \u0026#34; + b);//2 System.out.println(\u0026#34;e = \u0026#34; + e);//3 System.out.println(\u0026#34;f = \u0026#34; + f);//4 bufferedInputStream.reset();//resetæ–¹æ³•åä¼šå°†è¯»å–ä½ç½®å›é€€åˆ°æ ‡è®°ä½ç½®ï¼Œä¹Ÿå°±æ˜¯ç¬¬ä¸‰ä¸ªä½ç½® char c = (char)bufferedInputStream.read(); char d = (char)bufferedInputStream.read(); System.out.println(\u0026#34;c = \u0026#34; + c);//è¯»å–åˆ°3 System.out.println(\u0026#34;d = \u0026#34; + d);//è¯»å–åˆ°4 } } RandomAccessFile RandomAccessFileèƒ½æŒ‰ç…§å­—èŠ‚ä½ç½®è¿›è¡Œç§»åŠ¨ï¼Œç„¶ååœ¨æŒ‡å®šä½ç½®èƒ½å†™å…¥æ•°æ®ï¼Œä½†æ˜¯å®ƒå†™å…¥æ•°æ®æ˜¯è¦†ç›–æ‰åŸæ¥ä½ç½®çš„æ•°æ®ï¼Œæ¯”å¦‚ä¸‹é¢ä¾‹å­çš„å¤„ç†ï¼š 1 2 3 4 5 6 7 8 9 10 11 12 public class TestRandomAccessFile { public static void main(String[] args) throws IOException { //RandomAccessFileèƒ½éšæ„å®šä½åˆ°æ–‡ä»¶çš„å…·ä½“ä½ç½® RandomAccessFile r = new RandomAccessFile(\u0026#34;./test.txt\u0026#34;, \u0026#34;rw\u0026#34;); r.seek(2);//æŒ‰å­—èŠ‚ä½ç½®è¿›è¡Œseekï¼Œtest.txtæ–‡ä»¶æ˜¯8ä¸ªå­—èŠ‚ï¼Œé€šè¿‡seekèƒ½è®¿é—®åˆ°å¯¹åº”å­—èŠ‚ä½ç½®çš„å­—ç¬¦ r.write(\u0026#34;9\u0026#34;.getBytes());//æ­¤å¤„æ˜¯ç›´æ¥è¦†ç›–æ‰ç¬¬ä¸‰ä¸ªä½ç½®çš„æ•°æ® int temp = -1; while ((temp = r.read())!=-1){//ç”±äºreadæ–¹æ³•ä¼šå‘åæŒ‰ç…§å­—èŠ‚è¯»å–ï¼Œå› æ­¤ä»ç¬¬4ä¸ªä½ç½®å¼€å§‹è¯»å– System.out.println(\u0026#34;temp = \u0026#34; + ((char) temp)); } } } é¦–å…ˆé€šè¿‡seekå°†ä½ç½®ç§»åŠ¨åˆ°ç¬¬ä¸‰ä¸ªä½ç½®ï¼Œç„¶åwriteæ›¿æ¢æ‰åŸæ¥æ•°æ®ï¼Œæ­¤æ—¶æ–‡ä»¶å†…å®¹ä¼šç”±åŸæ¥çš„12345678å˜æˆ12945678 RandomAccessFileä¸nio(new io)ç»“åˆä½¿ç”¨ã€‚å°†ä¸Šé¢çš„ä¾‹å­æ”¹æˆæ’å…¥æ“ä½œï¼Œè€Œä¸æ˜¯è¦†ç›–ï¼Œæ­¤æ—¶å¯ä»¥ç”¨åˆ°nioä¸­çš„FileChannelã€‚RandomAccessFileçš„FileChannelï¼Œè®©ä½ ä½¿ç”¨ NIOï¼ˆNew I/Oï¼‰é«˜é€Ÿæ–‡ä»¶é€šé“ï¼Œè®©ä½ èƒ½å¯¹æ–‡ä»¶è¿›è¡Œæ›´å¿«ã€æ›´åº•å±‚çš„æ“ä½œï¼Œç„¶åé€šè¿‡mapæ–¹æ³•å°†fileå†…å®¹æ˜ å°„åˆ°å†…å­˜ï¼Œä»è€Œä¸åƒæ™®é€šioä¸€æ ·read/writeé‚£æ ·ç³»ç»Ÿè°ƒç”¨ï¼Œä¸éœ€è¦ç”¨æˆ·æ€å†…æ ¸æ€æ‹·è´ï¼Œè¿”å›çš„MappedByteBuffer æ˜¯å†…å­˜æ˜ å°„æ–‡ä»¶ï¼Œå¯¹ ByteBuffer çš„æ“ä½œå°±æ˜¯åœ¨ç›´æ¥ä¿®æ”¹æ–‡ä»¶å†…å®¹ã€‚æ¯”å¦‚ä¸‹é¢é€šè¿‡putæ–¹æ³•ç»™æŒ‡å®šä½ç½®æ’å…¥å­—ç¬¦çš„äº‹ä¾‹ï¼š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 public class TestRandomAccessFile1 { public static void main(String[] args) throws IOException { int insertPos = 3; byte value = (byte) \u0026#39;9\u0026#39;; RandomAccessFile raf = new RandomAccessFile(\u0026#34;./test.txt\u0026#34;, \u0026#34;rw\u0026#34;); FileChannel channel = raf.getChannel(); long oldLen = channel.size(); long newLen = oldLen + 1; // 1. æ‰©å±•æ–‡ä»¶é•¿åº¦ raf.setLength(newLen); // 2. é‡æ–° map å…¨æ–‡ä»¶åŒºåŸŸ MappedByteBuffer buffer = channel.map( FileChannel.MapMode.READ_WRITE, 0, newLen ); // 3. ä»åå¾€å‰ç§»åŠ¨æ•°æ®ï¼ˆé¿å…è¦†ç›–ï¼‰ for (long i = oldLen - 1; i \u0026gt;= insertPos; i--) { byte b = buffer.get((int) i); buffer.put((int) (i + 1), b); } // 4. æ’å…¥æ–°çš„å­—èŠ‚ buffer.put(insertPos, value); channel.close(); raf.close(); } } ä¸Šé¢æ“ä½œå®Œåï¼Œæ–‡ä»¶å†…å®¹ç”±åŸæ¥çš„12345678å˜æˆäº†123945678ã€‚ å›¾ç‰‡çš„å­—èŠ‚è¯»å– é¦–å…ˆå°†å›¾ç‰‡è½¬åŒ–æˆByteBufferæ•°æ®ï¼š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 public static ByteBuffer fromFile(@NonNull File file) throws IOException { RandomAccessFile raf = null; FileChannel channel = null; try { long fileLength = file.length(); // See #2240. if (fileLength \u0026gt; Integer.MAX_VALUE) { throw new IOException(\u0026#34;File too large to map into memory\u0026#34;); } // See b/67710449. if (fileLength == 0) { throw new IOException(\u0026#34;File unsuitable for memory mapping\u0026#34;); } raf = new RandomAccessFile(file, \u0026#34;r\u0026#34;); channel = raf.getChannel(); return channel.map(FileChannel.MapMode.READ_ONLY, 0, fileLength).load(); } finally { if (channel != null) { try { channel.close(); } catch (IOException e) { // Ignored. } } if (raf != null) { try { raf.close(); } catch (IOException e) { // Ignored. } } } } è·å–RandomAccessFileçš„FileChannelï¼Œè®©ä½ ä½¿ç”¨ NIOï¼ˆNew I/Oï¼‰é«˜é€Ÿæ–‡ä»¶é€šé“ï¼Œè®©ä½ èƒ½å¯¹æ–‡ä»¶è¿›è¡Œæ›´å¿«ã€æ›´åº•å±‚çš„æ“ä½œï¼Œç„¶åé€šè¿‡mapæ–¹æ³•å°†fileå†…å®¹æ˜ å°„åˆ°å†…å­˜ï¼Œä»è€Œä¸åƒæ™®é€šioä¸€æ ·read/writeé‚£æ ·ç³»ç»Ÿè°ƒç”¨ï¼Œä¸éœ€è¦ç”¨æˆ·æ€å†…æ ¸æ€æ‹·è´ï¼Œè¿”å›çš„MappedByteBuffer æ˜¯å†…å­˜æ˜ å°„æ–‡ä»¶ï¼Œå¯¹ ByteBuffer çš„æ“ä½œå°±æ˜¯åœ¨ç›´æ¥ä¿®æ”¹æ–‡ä»¶å†…å®¹ã€‚\nå›¾ç‰‡å­—èŠ‚æ•°æ®è§£æ è·å–åˆ°å›¾ç‰‡çš„å­—èŠ‚æ•°æ®åï¼Œæ¥ç€å°±å¯ä»¥è§£æå›¾ç‰‡çš„æ ¼å¼ã€æ—‹è½¬è§’åº¦ç­‰ä¿¡æ¯ã€‚\nå›¾ç‰‡æ ¼å¼\né¦–å…ˆè¯»å–åˆ°ByteBufferæ•°æ® ç„¶åæŒ‰ç…§å­—èŠ‚æ•°é‡è¿›è¡Œè¯»å– å¦‚æœå‰ä¸¤ä¸ªå­—èŠ‚ç­‰äº0xFFD8ï¼Œåˆ™æ˜¯JPEGæ ¼å¼ å¦‚æœå‰å››ä¸ªå­—èŠ‚ç­‰äº0x89504E47ï¼Œåˆ™æ˜¯PNGæ ¼å¼ æ¥ç€åœ¨PNGé‡Œé¢åˆ¤æ–­æ˜¯å¦å¸¦é€æ˜æ ¼å¼ é€æ˜åº¦æ˜¯è¯»å–ç¬¬25ä¸ªå­—èŠ‚æ•°æ®ï¼Œå¦‚æœæ•°å€¼å¤§äºç­‰äº3ï¼Œåˆ™è¯´æ˜æ˜¯PNGå¸¦é€æ˜åº¦çš„å›¾ç‰‡ï¼Œå¦åˆ™å°±ä¸å¸¦é€æ˜åº¦çš„PNGå›¾ç‰‡ã€‚ æ¥ç€åˆ¤æ–­æ˜¯ä¸æ˜¯webpæ ¼å¼ï¼Œwebpå›¾ç‰‡æ˜¯RIFFå®¹å™¨æ ¼å¼ï¼Œå®ƒæ˜¯ç”±RIFF+æ–‡ä»¶å¤§å°+WEBP+VP8(æœ‰æŸ)/VP8Læ— æŸ/VP8X(æ‰©å±•ï¼Œæ”¯æŒ alpha / animation / ICC) åç§» ASCII 16è¿›åˆ¶ å«ä¹‰ 0x00 RIFF 52 49 46 46 RIFFæ ‡è¯† 0x04 size xx xx xx xx æ–‡ä»¶å¤§å° - 8ï¼ˆå°ç«¯ï¼‰ 0x08 WEBP 57 45 42 50 WebP æ ‡è¯† 8. VP8(æœ‰æŸWebP) Chunkå¤´ï¼ˆ8å­—èŠ‚ï¼‰ åç§» ASCII 16è¿›åˆ¶ å«ä¹‰ 0x00 VP8 56 50 38 20 VP8 æ ‡è¯† 0x04 size xx xx xx xx æ–‡ä»¶å¤§å° - 8ï¼ˆå°ç«¯ï¼‰ VP8L(æ— æŸWebP) Chunkå¤´ï¼ˆ8å­—èŠ‚ï¼‰ åç§» ASCII 16è¿›åˆ¶ å«ä¹‰ 0x00 VP8 56 50 38 4C VP8 æ ‡è¯† 0x04 size xx xx xx xx æ–‡ä»¶å¤§å° - 8ï¼ˆå°ç«¯ï¼‰ VP8X(æ‰©å±•) Chunkå¤´ï¼ˆ8å­—èŠ‚ï¼‰ åç§» ASCII 16è¿›åˆ¶ å«ä¹‰ 0x00 VP8 56 50 38 58 VP8 æ ‡è¯† 0x04 size xx xx xx xx æ–‡ä»¶å¤§å° - 8ï¼ˆå°ç«¯ï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 public class TestRandomAccessFile2 { static final int EXIF_MAGIC_NUMBER = 0xFFD8; private static final int PNG_HEADER = 0x89504E47; private static final int GIF_HEADER = 0x474946; // WebP-related // \u0026#34;RIFF\u0026#34; private static final int RIFF_HEADER = 0x52494646; // \u0026#34;WEBP\u0026#34; private static final int WEBP_HEADER = 0x57454250; // \u0026#34;VP8\u0026#34; null. private static final int VP8_HEADER = 0x56503800; private static final int VP8_HEADER_MASK = 0xFFFFFF00; private static final int VP8_HEADER_TYPE_MASK = 0x000000FF; // \u0026#39;X\u0026#39; private static final int VP8_HEADER_TYPE_EXTENDED = 0x00000058; // \u0026#39;L\u0026#39; private static final int VP8_HEADER_TYPE_LOSSLESS = 0x0000004C; private static final int WEBP_EXTENDED_ANIMATION_FLAG = 1 \u0026lt;\u0026lt; 1; private static final int WEBP_EXTENDED_ALPHA_FLAG = 1 \u0026lt;\u0026lt; 4; private static final int WEBP_LOSSLESS_ALPHA_FLAG = 1 \u0026lt;\u0026lt; 3; public static void main(String[] args) throws Exception { RandomAccessFile raf = new RandomAccessFile(\u0026#34;./test.png\u0026#34;, \u0026#34;rw\u0026#34;); FileChannel channel = raf.getChannel(); // 2. é‡æ–° map å…¨æ–‡ä»¶åŒºåŸŸ MappedByteBuffer buffer = channel.map( FileChannel.MapMode.READ_ONLY, 0, raf.length() ); buffer.order(ByteOrder.BIG_ENDIAN); ByteBuffer dup = buffer.duplicate(); dup.position(0);// ä»å¤´è¯» byte[] data = new byte[dup.remaining()]; dup.get(data); int i=0; //è¿™ä¸ªå°±æ˜¯éå†å…¨éƒ¨çš„byteæ•°æ® for (byte datum : data) { int mdata = (datum\u0026amp; 0xFF); System.out.println((i++)+\u0026#34;mdata = \u0026#34; + Integer.toHexString(mdata));//16è¿›åˆ¶æ•°è½¬æˆ10è¿›åˆ¶çš„å­—ç¬¦ä¸² } //è¯»å–å‰ä¸¤ä¸ªå­—èŠ‚çš„æ•°æ® int firstTwoBytes = getUInt16(buffer); System.out.println(\u0026#34;firstTwoBytes = \u0026#34; + Integer.toHexString(firstTwoBytes)); //å¦‚æœå‰ä¸¤ä¸ªbyteç­‰äº0xFFD8,åˆ™è¯´æ˜æ˜¯JPEGæ ¼å¼ if (firstTwoBytes == EXIF_MAGIC_NUMBER) { System.out.println(\u0026#34;å½“å‰å›¾ç‰‡æ˜¯JPEG\u0026#34;); } //å‰ä¸¤ä¸ªbyteæ•°å·¦ç§»8ä½ï¼Œç„¶åå†è¯»å–ä¸€ä¸ª8ä½è¿›è¡Œæˆ–è¿ç®—å°±å¾—åˆ°äº†å‰3ä¸ªå­—èŠ‚çš„16è¿›åˆ¶æ•°æ® final int firstThreeBytes = (firstTwoBytes \u0026lt;\u0026lt; 8) | getUInt8(buffer); //å¦‚æœå‰ä¸‰ä¸ªå­—èŠ‚çš„æ•°æ®ç­‰äº0x474946ï¼Œåˆ™è¯´æ˜æ˜¯GIFæ ¼å¼ if (firstThreeBytes == GIF_HEADER) { return GIF; } //åŒç†å‰3ä¸ªå­—èŠ‚çš„æ•°æ®å†è¯»å–åˆ°ä¸€ä¸ª8ä½è¿›è¡Œæˆ–è¿ç®—å¾—åˆ°å‰4ä¸ªå­—èŠ‚çš„16è¿›åˆ¶æ•°æ® final int firstFourBytes = (firstThreeBytes \u0026lt;\u0026lt; 8) | getUInt8(buffer); //å¦‚æœå‰4ä¸ªå­—èŠ‚çš„æ•°æ®ç­‰äº0x89504E47ï¼Œåˆ™è¯´æ˜æ˜¯PNGç±»å‹ if (firstFourBytes == PNG_HEADER) { // See: http://stackoverflow.com/questions/2057923/how-to-check-a-png-for-grayscale-alpha // -color-type //ç¬¬25ä½è¯»å–é€æ˜åº¦ä¿¡æ¯ï¼Œç”±äºå‰é¢å·²ç»è¯»å–äº†4ä½ï¼Œå› æ­¤å‡å»4 skip(buffer, 25 - 4); try { //ç„¶åè¯»å–åˆ°ç¬¬25ä½çš„å­—èŠ‚ç´ å…· int alpha = getUInt8(buffer); System.out.println(\u0026#34;alpha = \u0026#34; + Integer.toHexString(alpha)); // A RGB indexed PNG can also have transparency. Better safe than sorry! //å¦‚æœå¤§äºç­‰äº3åˆ™è¯´æ˜å¸¦é€æ˜åº¦ä¿¡æ¯ if (alpha \u0026gt;= 3) { System.out.println(\u0026#34;å½“å‰å›¾ç‰‡æ˜¯å¸¦é€æ˜çš„PNGå›¾ç‰‡\u0026#34;); } else { System.out.println(\u0026#34;å½“å‰å›¾ç‰‡æ˜¯ä¸å¸¦é€æ˜çš„PNGå›¾ç‰‡\u0026#34;); } } catch (Exception e) { // TODO(b/143917798): Re-enable this logging when dependent tests are fixed. // if (Log.isLoggable(TAG, Log.ERROR)) { // Log.e(TAG, \u0026#34;Unexpected EOF, assuming no alpha\u0026#34;, e); // } System.out.println(\u0026#34;å¼‚å¸¸ï¼šå½“å‰å›¾ç‰‡æ˜¯ä¸å¸¦é€æ˜çš„PNGå›¾ç‰‡\u0026#34;); } } //webpå›¾ç‰‡æ ¼å¼è¯»å–ï¼Œé¦–å…ˆè¯»å–RIFFæ ‡è¯†ï¼Œå¦‚æœä¸æ˜¯åˆ™æŒ‰ç…§AVIFæ ¼å¼è¯»å– if (firstFourBytes != RIFF_HEADER) { // Check for AVIF (reads up to 32 bytes). If it is a valid AVIF stream, then the // firstFourBytes will be the size of the FTYP box. return sniffAvif(reader, /* boxSize= */ firstFourBytes); } // WebP (reads up to 21 bytes). // See https://developers.google.com/speed/webp/docs/riff_container for details. // Bytes 4 - 7 contain length information. Skip these. //åç§»å››ä½ï¼ŒæŠŠsizeçš„4ä¸ªå­—èŠ‚ç»™è·³è¿‡ reader.skip(4); //ç¬¬ä¸‰ä¸ª4å­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯WebPæ ‡è¯† final int thirdFourBytes = (reader.getUInt16() \u0026lt;\u0026lt; 16) | reader.getUInt16(); //åˆ¤æ–­ç¬¬ä¸‰ä¸ª4å­—èŠ‚æ˜¯ä¸æ˜¯0x57454250 if (thirdFourBytes != WEBP_HEADER) { return UNKNOWN; } //ç¬¬4ä¸ª4å­—èŠ‚ final int fourthFourBytes = (reader.getUInt16() \u0026lt;\u0026lt; 16) | reader.getUInt16(); //åˆ¤æ–­æœ‰æ²¡æœ‰VP8å—ï¼Œè¿™é‡ŒæŠ¹æ‰äº†æœ€ä½byteæ•°ï¼Œå› ä¸ºé«˜3ä½éƒ½æ˜¯ä¸€æ ·çš„ï¼Œä¸éœ€è¦æ¯”è¾ƒæœ€ä½ä¸€ä½ if ((fourthFourBytes \u0026amp; VP8_HEADER_MASK) != VP8_HEADER) { return UNKNOWN; } //åˆ¤æ–­æœ€ä½ä¸€ä¸ªå­—èŠ‚æ˜¯ä¸æ˜¯16è¿›åˆ¶çš„58ï¼Œä¹Ÿå°±æ˜¯æ˜¯ä¸æ˜¯VP8X if ((fourthFourBytes \u0026amp; VP8_HEADER_TYPE_MASK) == VP8_HEADER_TYPE_EXTENDED) { // Skip some more length bytes and check for transparency/alpha flag. //è·³è¿‡sizeçš„4ä½ reader.skip(4); //è·å–åˆ°flagä½å ä¸€ä¸ªbyte short flags = reader.getUInt8(); //å¦‚æœflagç­‰äº2ï¼Œåˆ™æ˜¯å¸¦Animation if ((flags \u0026amp; WEBP_EXTENDED_ANIMATION_FLAG) != 0) { return ANIMATED_WEBP; } else if ((flags \u0026amp; WEBP_EXTENDED_ALPHA_FLAG) != 0) {//åˆ¤æ–­flagç­‰äº16,ä¹Ÿå°±æ˜¯å¸¦alpha return ImageType.WEBP_A; } else { return ImageType.WEBP;//å¦åˆ™æ˜¯æ™®é€šçš„ } } //åˆ¤æ–­æœ€ä½ä¸€ä¸ªå­—èŠ‚æ˜¯ä¸æ˜¯16è¿›åˆ¶çš„4C,ä¹Ÿå°±æ˜¯æ˜¯ä¸æ˜¯VP8L if ((fourthFourBytes \u0026amp; VP8_HEADER_TYPE_MASK) == VP8_HEADER_TYPE_LOSSLESS) { // See chromium.googlesource.com/webm/libwebp/+/master/doc/webp-lossless-bitstream-spec.txt // for more info. //è·³è¿‡sizeå ç”¨çš„4å­—èŠ‚ä½ç½® reader.skip(4); //è¯»å–flagæ ‡å¿— short flags = reader.getUInt8(); //åˆ¤æ–­flagæ˜¯å¦ç­‰äº8,ä¹Ÿå°±æ˜¯æ˜¯ä¸æ˜¯å¸¦alpha return (flags \u0026amp; WEBP_LOSSLESS_ALPHA_FLAG) != 0 ? ImageType.WEBP_A : ImageType.WEBP; } //æœ€åç”¨webpæ ¼å¼å…œåº• return ImageType.WEBP; channel.close(); raf.close(); } private static short getUInt8(ByteBuffer buffer) throws Exception { return (short) (buffer.get() \u0026amp; 0xFF); } private static int getUInt16(ByteBuffer buffer) throws Exception { return ((int) getUInt8(buffer) \u0026lt;\u0026lt; 8) | getUInt8(buffer); } private static long skip(ByteBuffer byteBuffer, long total) { int toSkip = (int) Math.min(byteBuffer.remaining(), total); System.out.println(\u0026#34;skip:\u0026#34;+(byteBuffer.position() + toSkip)); byteBuffer.position(byteBuffer.position() + toSkip); return toSkip; } } ","date":"2024-11-04T00:00:00Z","permalink":"http://xiangcman.xyz/p/%E7%AC%94%E8%AE%B0%E6%95%B4%E7%90%86/","title":"ç¬”è®°æ•´ç†"},{"content":"åç¨‹åˆ›å»º demo 1 2 3 4 5 6 7 8 9 10 11 12 suspend { Log.d(TAG, \u0026#34;suspend block:\u0026#34;) \u0026#34;123\u0026#34; }.createCoroutine(object : Continuation\u0026lt;String\u0026gt; { override val context: CoroutineContext get() = EmptyCoroutineContext override fun resumeWith(result: Result\u0026lt;String\u0026gt;) { val value = result.getOrNull() Log.d(TAG, \u0026#34;resumeWith:$value\u0026#34;) } }).resume(Unit) Log.d(TAG, \u0026#34;onCreate\u0026#34;) ä¸Šé¢æ—¥å¿—å…ˆæ‰“å°suspendä¸­çš„ä»£ç å—ï¼Œç„¶åæ‰§è¡ŒContinuationçš„resumeWithï¼Œæœ€åæ‰§è¡Œä¸»çº¿ç¨‹çš„ä»£ç ã€‚\ncreateCoroutine æ˜¯æŒ‚èµ·å‡½æ•°çš„æ‰©å±•æ–¹æ³•ï¼Œæ–¹æ³•å‚æ•°æ˜¯Continuationç±»å‹ï¼Œå¯¹åº”ä¸Šé¢çš„åŒ¿åå†…éƒ¨ç±»ã€‚åˆ›å»ºäº†ä¸€ä¸ªSafeContinuationå¯¹è±¡ï¼Œå®ƒä¹Ÿæ˜¯ä¸€ä¸ªContinuationç±»å‹ï¼Œå¹¶ä¼ é€’ä¸¤ä¸ªå‚æ•°ã€‚\nresume resumeæ–¹æ³•ä¼šè°ƒç”¨resumeWithï¼Œçœ‹ä¸‹SafeContinuationçš„resumeWithæ–¹æ³•ï¼š æ­¤å¤„æé†’ä¸‹ï¼Œkotlinçš„æºç éœ€è¦åˆ°å¯¹åº”çš„** Jvmç±»ä¸‹æ‰¾ï¼Œè¦ä¸ç„¶æ–¹æ³•åªæ˜¯ä¸€ä¸ªç”³æ˜ã€‚æ­¤å¤„çš„resultæ˜¯æ„é€ SafeContinuationä¼ é€’è¿›æ¥çš„COROUTINE_SUSPENDEDï¼Œå› æ­¤ä¼šæ‰§è¡Œdelegate.resumeWith(result)ï¼Œæ­¤å¤„çš„delegateæ˜¯createCoroutineUnintercepted(completion).intercepted()åˆ›å»ºçš„ã€‚\ncreateCoroutineUnintercepted å®ƒæ˜¯æŒ‚èµ·å‡½æ•°çš„æ‰©å±•æ–¹æ³•ï¼š\nåˆ¤æ–­å½“å‰æŒ‚èµ·å‡½æ•°æ˜¯ä¸æ˜¯BaseContinuationImplç±»å‹ï¼Œå¦‚æœæ˜¯åˆ™è°ƒç”¨createæ–¹æ³•ã€‚\næ­¤æ—¶å¯ä»¥æ‰“å¼€å­—èŠ‚ç ï¼Œçœ‹ä¸‹ä¸Šé¢çš„(suspend () -\u0026gt; T)æ˜¯ä»€ä¹ˆå¯¹è±¡ï¼Ÿ\nå¯ä»¥çœ‹åˆ°createCoroutineæ–¹æ³•ä¼ å…¥äº†ä¸¤ä¸ªå‚æ•°ï¼Œæˆ‘ä»¬éƒ½çŸ¥é“æ‰©å±•å‡½æ•°æœ€ç»ˆç¼–è¯‘å‡ºæ¥çš„æ–¹æ³•ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯è¢«æ‰©å±•å¯¹è±¡ï¼Œæ‰€ä»¥æ­¤å¤„çš„CoroutineActivity$onCreate$1å°±æ˜¯(suspend () -\u0026gt; T)ï¼ŒCoroutineActivity$onCreate$2å¯¹åº”çš„æ˜¯ä¾‹å­ä¸­çš„ContinuationåŒ¿åå†…éƒ¨ç±»ã€‚æˆ‘ä»¬æ³¨æ„ä¸‹ï¼Œæ­¤æ—¶ä¼ å…¥CoroutineActivity$onCreate$1ä¸­çš„Continuationå‚æ•°æ˜¯nullã€‚\nè€ŒSuspendLambdaçš„ç»§æ‰¿å…³ç³»å¦‚ä¸‹ï¼š\næ‰€ä»¥ä¼šè°ƒç”¨æŒ‚èµ·å‡½æ•°çš„createæ–¹æ³•ï¼š\nçˆ¶ç±»ä¸­è¦æ±‚å­ç±»å¿…é¡»é‡å†™è¯¥æ–¹æ³•ï¼Œæˆ‘ä»¬çœ‹CoroutineActivity$onCreate$1çš„createæ–¹æ³•ï¼š\næ­¤æ—¶é‡æ–°newäº†ä¸€ä¸ªCoroutineActivity$onCreate$1ï¼Œå¹¶æŠŠcompletionä¼ å…¥å…¶ä¸­ï¼Œè€Œæ­¤å¤„çš„completionå°±æ˜¯ä¸Šé¢çš„CoroutineActivity$onCreate$2ï¼Œå®ƒæ˜¯ä¸€ä¸ªContinuationã€‚è€Œå¼€ç«¯åœ¨åˆ†æcreateCoroutineçš„æ—¶å€™ï¼Œåˆ›å»ºCoroutineActivity$onCreate$1ä¼ å…¥çš„Continuationæ˜¯nullã€‚\nä¸å¤ªæ˜ç™½ï¼Œä¸ºä»€ä¹ˆä¸åœ¨createCoroutineæ—¶å€™ç›´æ¥ç›´æ¥æŠŠCoroutineActivity$onCreate$2ä¼ å…¥åˆ°CoroutineActivity$onCreate$1ä¸­ï¼Œè€Œéè¦é€šè¿‡createæ–¹æ³•å†åˆ›å»ºä¸€ä¸ªCoroutineActivity$onCreate$1ã€‚\næˆ‘ä»¬å†æ¥çœ‹interceptedæ–¹æ³•ã€‚\nintercepted æ˜¯Continueationçš„æ‰©å±•æ–¹æ³•ï¼Œå½“ç„¶äº†ï¼Œåˆšåˆšcreateåˆ›å»ºçš„CoroutineActivity$onCreate$1æ˜¯ä¸€ä¸ªsuspendLambdaå¯¹è±¡ï¼Œæ‰€ä»¥å®ƒä¹Ÿæ˜¯ContinueationImplï¼Œæ‰€ä»¥ä¼šèµ°ContinueationImplçš„interceptedæ–¹æ³•ï¼š\næ­¤å¤„çœ‹contextä¸­æœ‰æ²¡æœ‰ContinuationInterceptorç±»å‹çš„Elementï¼Œå¦‚æœæ²¡æœ‰åˆ™è¿”å›è‡ªå·±ï¼Œæˆ‘ä»¬åªè¦çŸ¥é“å…ˆè¿”å›è‡ªå·±ã€‚å› ä¸ºè¿™ä¸ªæ¶‰åŠåˆ°contextçš„ç»“æ„ï¼Œåé¢å†è®²ã€‚\nå°èŠ‚ï¼š â‘ ã€createCoroutineåˆ›å»ºäº†ä¸€ä¸ªSafeContinuationï¼Œå¹¶æŠŠCoroutineActivity$onCreate$1å’Œä¸€ä¸ªæ ‡å¿—ä½COROUTINE_SUSPENDEDä¼ å…¥å…¶ä¸­ã€‚CoroutineActivity$onCreate$1ç»§æ‰¿è‡ªSuspendLambdaï¼Œå¹¶ä¸”æ˜¯ä¸€ä¸ªFunctionæ¥å£çš„å®ä¾‹ã€‚SuspendLambdaç»§æ‰¿è‡ªContinuationImplï¼ŒContinuationImplç»§æ‰¿è‡ªBaseContinuationImplï¼ŒBaseContinuationImplç»§æ‰¿è‡ªContinuationï¼ŒCoroutineActivity$onCreate$1ç»§æ‰¿è‡ªSuspendLambdaï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢çš„åæˆè¦æ‰§è¡Œçš„é—­åŒ…ã€‚CoroutineActivity$onCreate$1æŒæœ‰äº†CoroutineActivity$onCreate$2ï¼Œå®ƒå®ç°äº†Continuationã€‚CoroutineActivity$onCreate$1é‡å†™äº†createæ–¹æ³•ï¼Œè¿”å›äº†ä¸€ä¸ªæ–°çš„CoroutineActivity$onCreate$1å¯¹è±¡ã€‚ â‘¡ã€resumeæ–¹æ³•ä¸­ä¼šè°ƒç”¨åˆ°SafeContinuationçš„resumeWithæ–¹æ³•ï¼Œæœ€ç»ˆä¼šè§¦å‘CoroutineActivity$onCreate$1çš„resumeWithæ–¹æ³•ã€‚\nåç¨‹æ‰§è¡Œ CoroutineActivity$onCreate$1ç»§æ‰¿è‡ªSuspendLambdaï¼Œæœ€ç»ˆä¼šç»§æ‰¿è‡ªBaseContinuationImplï¼Œæ¥çœ‹ä¸‹å®ƒçš„resumeWithï¼š\nresumeWithä¸­é¦–å…ˆè°ƒç”¨invokeSuspendæ–¹æ³•ï¼Œå¦‚æœinvokeSuspendæ–¹æ³•è¿”å›COROUTINE_SUSPENDEDï¼Œåˆ™resumeWithç›´æ¥ä¸å¾€ä¸‹æ‰§è¡Œã€‚å¦åˆ™çœ‹comppletionæ˜¯ä¸æ˜¯BaseContinuationImplï¼Œæ˜¯çš„è¯ï¼Œåˆ™ç»§ç»­è½®è®­ï¼Œç›´åˆ°comppletionä¸æ˜¯BaseContinuationImplï¼Œåˆ™æ‰§è¡Œå®ƒçš„resumeWithæ–¹æ³•ã€‚æ­¤å¤„çš„completionå®é™…æ˜¯CoroutineActivity$onCreate$2ï¼Œæ‰€ä»¥ä¼šæ‰§è¡Œå®ƒçš„resumeWithæ–¹æ³•ã€‚æˆ‘ä»¬çœ‹ä¸‹CoroutineActivity$onCreate$1çš„invokeSuspendæ–¹æ³•ï¼š\nå®ƒçš„è¿”å›å€¼ä¸æ˜¯COROUTINE_SUSPENDEDï¼Œæ‰€æœ‰ä¸Šé¢çš„invokeSuspendæ–¹æ³•è¿˜ä¼šç»§ç»­å¾€ä¸‹æ‰§è¡Œã€‚æ‰€ä»¥æœ€ç»ˆä¼šæ‰§è¡Œäº†CoroutineActivity$onCreate$2ï¼Œä¹Ÿå°±æ˜¯ä¾‹å­ä¸­çš„åŒ¿åå†…éƒ¨ç±»çš„resumeWithæ–¹æ³•ã€‚\næ­¤æ—¶æˆ‘ä»¬å†åˆ†æä¾‹å­ä¸­æ—¥å¿—çš„æ‰“å°ï¼š\nå¯ä»¥çœ‹åˆ°æ‰§è¡ŒSafeContinuationçš„resumeWithçš„æ—¶å€™æ˜¯ä¸€ä¸ªwhile(true)ï¼Œä¼ å…¥çš„this.resumeæ˜¯ä¸€ä¸ªCOROUTINE_SUSPENDEDæ ‡å¿—ä½ï¼Œæ‰€ä»¥ä¼šæŠŠCoroutineActivity$onCreate$1çš„resumeWithæ‰§è¡Œå®Œåï¼Œæ‰è·³å‡ºwhileå¾ªç¯ã€‚å› æ­¤æ—¥å¿—æœ€åè¾“å‡ºåæˆå¤–çš„ä»£ç ã€‚\næ€»ç»“ è¿‡ç¨‹ åç¨‹åˆ†ä¸ºåˆ›å»ºå’Œæ‰§è¡Œï¼Œåœ¨åˆ›å»ºè¿‡ç¨‹ä¸­é¦–å…ˆä¼šåˆ›å»ºä¸€ä¸ªSuspendLambdaçš„å­ç±»ï¼Œä½†æ˜¯è¯¥å­ç±»å®ƒçš„completion(Continuation)æ˜¯ç©ºçš„ï¼Œç„¶ååœ¨createCoroutineUninterceptedæ–¹æ³•ä¸­ä¼šè°ƒç”¨åˆ°è¯¥SuspendLambdaçš„å­ç±»çš„createæ–¹æ³•ï¼Œåœ¨createæ–¹æ³•é‡Œé¢ä¼šå†æ¬¡åˆ›å»ºä¸€ä¸ªSuspendLambdaçš„å­ç±»ï¼Œæ­¤æ—¶SuspendLambdaçš„å­ç±»ä¸­completion(Continuation)æ˜¯éç©ºçš„ï¼ŒæŒ‡å‘äº†createCoroutineæ–¹æ³•ä¼ å…¥çš„Continuationå†…éƒ¨ç±»ã€‚æ¥ç€æ¥åˆ°äº†æ‰§è¡Œé˜¶æ®µï¼Œæ‰§è¡Œæ˜¯è°ƒç”¨äº†SuspendLambdaçš„å­ç±»çš„resumeæ–¹æ³•ï¼Œå®ƒä¼šæ‰§è¡ŒresumeWithæ–¹æ³•ã€‚åœ¨resumeWithä¸­ä¼šè°ƒç”¨åˆ°invokeSuspendæ–¹æ³•ï¼Œè€ŒinvokeSuspendä¸­çš„ä»£ç å®é™…æ˜¯suspendä»£ç å—ä¸­çš„ä»£ç ï¼Œæ‰€ä»¥suspendä»£ç å—ä¸­çš„ä»£ç æœ€å…ˆæ‰§è¡Œã€‚æ‰§è¡Œå®ŒinvokeSuspendåä¼šæ‰§è¡Œcompletionçš„resumeWithæ–¹æ³•ï¼Œæ‰€ä»¥createCoroutineæ–¹æ³•ä¼ å…¥çš„Continuationå†…éƒ¨ç±»çš„resumeWithè¢«æ‰§è¡Œã€‚è€Œä¸ºä»€ä¹ˆä¸»çº¿ç¨‹åœ¨æœ€åæ‰æ‰§è¡Œå‘¢ï¼Ÿè¿™æ˜¯å› ä¸ºåœ¨åˆ›å»ºåç¨‹çš„æ—¶å€™å®é™…åŒ…è£…äº†ä¸€ä¸ªSafeContinuationå¯¹è±¡ï¼Œåœ¨å®ƒçš„resumeWithé‡Œé¢ä¼šå¯åŠ¨while(true)å¾ªç¯ï¼Œç­‰åˆ°æ‰§è¡Œå®Œdeletate(ä¹Ÿå°±æ˜¯SuspendLambdaçš„å­ç±»)çš„resumeWithåæ‰ä¼šé€€å‡ºwhile(true)å¾ªç¯ï¼Œæ‰€ä»¥æœ€åæ‰ä¼šæ‰§è¡Œä¸»çº¿ç¨‹åé¢çš„ä»£ç ã€‚\nç±»å›¾ æœ€åè¾“å‡ºæ­¤æ¬¡çš„ç±»å›¾ç»“æ„ï¼Œä»¥ä½œå›é¡¾ï¼š\n","date":"2024-11-02T00:00:00Z","image":"http://xiangcman.xyz/p/android-%E5%8D%8F%E7%A8%8B%E5%90%AF%E5%8A%A8%E5%88%B0%E6%89%A7%E8%A1%8C/cover_hu_398ba822a3953d68.jpg","permalink":"http://xiangcman.xyz/p/android-%E5%8D%8F%E7%A8%8B%E5%90%AF%E5%8A%A8%E5%88%B0%E6%89%A7%E8%A1%8C/","title":"Android åç¨‹å¯åŠ¨åˆ°æ‰§è¡Œ"},{"content":"Bytecode-viewer ä¸€æ¬¾æŸ¥çœ‹classæ–‡ä»¶çš„å·¥å…·\nä½¿ç”¨ï¼š ç›®å½•å®šä½åˆ°è¯¥jaråŒ…ä¸‹é¢ï¼Œç„¶åä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ï¼š\njava -jar Bytecode-Viewer-2.12.jar\nshè„šæœ¬æ‰§è¡Œæ–‡ä»¶ï¼š Bytecode-Viewer.sh\nè„šæœ¬æ–‡ä»¶ï¼š\nBytecode-Viewer-2.12.jar\næ¥æº:https://github.com/Konloch/bytecode-viewer\nRectangleçª—å£å¤§å°è°ƒæ•´ Rectangleæ˜¯ä¸€ä¸ªåœ¨macä¸ŠåŠ¨æ€è°ƒæ•´åº”ç”¨çª—å£çš„å·¥å…·ï¼Œæ¯”å¦‚æˆ‘æƒ³åœ¨å±å¹•ä¸ŠåŒæ—¶å±•ç¤ºå¤šä¸ªåº”ç”¨ï¼Œè¿™ä¸ªå·¥å…·ä½¿ç”¨ä¸Šéå¸¸å¥½ç”¨ã€‚ Rectangleä¸‹è½½ Alfredå·¥å…· Alfredæ˜¯ä¸€æ¬¾åœ¨macä¸Šå…¨å±€æœç´¢çš„å·¥å…·ï¼Œèƒ½æŒ‡å®šæœç´¢æ–‡ä»¶ã€æ–‡ä»¶å¤¹ã€åº”ç”¨çš„ä¸€æ¬¾å·¥å…·ã€‚ å»ºè®®ä½ åœ¨è®¾ç½®ä¸­å°†è¦æœç´¢çš„æ–‡ä»¶ç±»å‹ç»™å‹¾é€‰ä½ï¼š å…³äºæ›´å¤šä½¿ç”¨çœ‹å®˜ç½‘ï¼Œæˆ‘çš„å¿«æ·é”®æ˜¯åŒå‡»commandï¼š åŠ¨ç”»å·®å€¼å™¨ åœ¨çº¿é¢„è§ˆï¼šhttps://inloop.github.io/interpolator/\nVsCodeç¼–è¾‘å™¨ æ’ä»¶åˆ—è¡¨ PlantUMLï¼šå¯¹äºå†™mdçš„æ–‡ä»¶ï¼Œæ¯”è¾ƒä¸é”™ Peacockï¼šä¸€æ¬¾èƒ½åŠ¨æ€ä¿®æ”¹å·¥ä½œåŒºçš„é¢œè‰²ï¼Œè¿™æ ·å°±èƒ½çŸ¥é“å½“å‰æ˜¯å“ªä¸ªé¡¹ç›® Paste Imageï¼šèƒ½å¿«é€Ÿåœ¨é¡¹ç›®ç›®å½•å¤åˆ¶å›¾ç‰‡ï¼Œå¹¶ç²˜è´´åˆ°æ–‡æ¡£ä¸­ One Dark Proï¼šä¸€æ¬¾ä¸é”™çš„Color Themeçš„ä¸»é¢˜æ’ä»¶ Material Icon Themeï¼šä¸€æ¬¾ä¸é”™çš„File Icon Theme(æ–‡ä»¶æ ·å¼)çš„ä¸»é¢˜æ’ä»¶ Material Product Iconsï¼šä¸€æ¬¾ä¸é”™çš„å·¦è¾¹æ çš„åŠŸèƒ½æŒ‰é’®çš„æ ·å¼ä¸»é¢˜ markdownlintï¼šmarkdownè¯­æ³•çš„æ£€æµ‹æ’ä»¶ Markdown All in Oneï¼šå†™markdownè¯­æ³•é«˜äº®ã€å¿«æ·è®¾ç½®ã€å¿«é€Ÿç”Ÿæˆç›®å½•çš„æ’ä»¶ indent-rainbowï¼šä»£ç å¯è§†åŒ–ç¼©è¿›å·¥å…· CodeSnapï¼šæ‹–åŠ¨æ–‡ä»¶ä¸­æ–‡å­—ï¼Œèƒ½å¿«é€Ÿç”Ÿæˆä»£ç æ ¼å¼çš„å›¾ç‰‡ Markdown Preview Enhancedï¼šmarkdowné¢„è§ˆæ’ä»¶ï¼Œæ”¯æŒè‡ªå®šä¹‰æ ·å¼è¿›è¡Œé¢„è§ˆ macä¸Šå¿«é€Ÿæ‹·è´æ–‡ä»¶ æŒ‰ä½optioné”®ï¼Œç„¶åé¼ æ ‡å³é”®ç‚¹å‡»ï¼Œä¼šå‡ºç°\u0026quot;å°†**æ‹·è´ä¸ºæ–‡ä»¶è·¯å¾„\u0026quot;ï¼Œç„¶åé€‰ä¸­å®ƒå°±æ‹·è´è·¯å¾„äº†ã€‚\n","date":"2024-11-02T00:00:00Z","permalink":"http://xiangcman.xyz/p/%E5%B7%A5%E5%85%B7%E6%95%B4%E7%90%86/","title":"å·¥å…·æ•´ç†"},{"content":" Contextç›¸å…³æºç æ˜¯åœ¨android33çš„ç‰ˆæœ¬ä¸Šåˆ†æçš„ã€‚\nç±»å›¾ Contextåˆ›å»º Activityç»§æ‰¿è‡ªContextThemeWrapperï¼ŒContextThemeWrapperç»§æ‰¿è‡ªContextWrapperï¼Œå½“activityåˆ›å»ºçš„ä¹‹å‰ï¼Œä¼šå…ˆåˆ›å»ºContextImplï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ActivityThread.performLaunchActivityä¸­æ‰¾åˆ°ContextImplçš„åˆ›å»ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 private Activity performLaunchActivity(ActivityClientRecord r, Intent customIntent) { ContextImpl appContext = createBaseContextForActivity(r); Activity activity = null; java.lang.ClassLoader cl = appContext.getClassLoader(); activity = mInstrumentation.newActivity( cl, component.getClassName(), r.intent); appContext.setOuterContext(activity); activity.attach(appContext, this, getInstrumentation(), r.token, r.ident, app, r.intent, r.activityInfo, title, r.parent, r.embeddedID, r.lastNonConfigurationInstances, config, r.referrer, r.voiceInteractor, window, r.activityConfigCallback, r.assistToken, r.shareableActivityToken); return activity; } é€šè¿‡createBaseContextForActivityæ–¹æ³•åˆ›å»ºäº†ContextImplï¼š\næ¥ç€ä¼šè°ƒç”¨contextImplçš„setOuterContextï¼Œä¼ å…¥çš„æ˜¯activityã€‚\nç»“è®ºï¼šcontextImplä¸­çš„outerContextæŒ‡å‘äº†activityã€‚\nContextä¼ é€’ åœ¨activityä¸­çš„attachè°ƒç”¨äº†attachBaseContextï¼Œå¹¶æŠŠcontextImplä¼ è¿›å»äº†ï¼š\nè¯¥æ–¹æ³•æ˜¯ContextWrapperä¸­çš„æ–¹æ³•ï¼Œå¹¶æŒ‡å‘äº†mBaseå˜é‡ã€‚Activityä¸­getBaseContextå’ŒgetApplicationContextåŒºåˆ«ï¼š\ngetBaseContextæŒ‡å‘äº†åˆšåˆšattachæ–¹æ³•ä¼ è¿›æ¥çš„contextImplã€‚\næŒ‡å‘äº†mBase.getApplicationContextï¼š\nmPackageInfoæ˜¯åœ¨åˆ›å»ºcontextImplçš„æ—¶å€™ä¼ å…¥çš„ï¼Œå®ƒæ˜¯loadedApkå¯¹è±¡ï¼Œå®ƒçš„getApplicationæ–¹æ³•æ˜¯è·å–åº”ç”¨çš„Applicationå¯¹è±¡ï¼š\nç»“è®ºï¼šgetBaseContextè·å–çš„æ˜¯contextImplå¯¹è±¡ï¼ŒgetApplicationContextè·å–çš„æ˜¯Applicationå¯¹è±¡ã€‚\nä¸»é¢˜è®¾ç½® å›åˆ°performLaunchActivityï¼Œç»™activityè®¾ç½®ä¸»é¢˜ï¼š\nå°†themeçš„residä¼ è¿›æ¥ï¼Œæœ€ç»ˆä¼šæŠŠresidè¿™ä¸ªthemeè¿½åŠ åˆ°mThemeä¸Šã€‚è¿™é‡Œç‰µæ‰¯åˆ°èµ„æºåŠ è½½ï¼Œåé¢å†è¯´ã€‚\nLayoutInflaterä¸­çš„context LayoutInflater.from(context)ï¼š æ­¤å¤„çš„contextä¸€èˆ¬æ˜¯activityï¼Œçœ‹activity.getSystemServiceæ–¹æ³•ï¼Œactivityæ˜¯ç»§æ‰¿è‡ªContextThemeWrapperï¼Œæ‰€ä»¥ä¼šè°ƒç”¨ContextThemeWrapperçš„getSystemServiceï¼š\nå¦‚æœnameæ˜¯LAYOUT_INFLATER_SERVICEï¼Œåˆ™é€šè¿‡LayoutInflater.from(getBaseContext()).cloneInContext(this)æ¥åˆ›å»ºï¼Œä¸Šé¢åˆ†æè¿‡activityä¸­çš„getBaseContext()æ˜¯æŒ‡å‘äº†contextImplå¯¹è±¡ï¼Œæ‰€ä»¥å…œå…œè½¬è½¬ï¼Œæœ€ç»ˆè°ƒç”¨äº†contextImplä¸­çš„getSystemServiceæ¥è·å–LayoutInflaterå¯¹è±¡ã€‚\né‚£å¦‚æœfromä¼ è¿›æ¥çš„ä¸æ˜¯Activityï¼Œè€Œæ˜¯applicationä¼šæ€ä¹ˆæ ·å‘¢ï¼Ÿapplicationå®ƒæ˜¯ç»§æ‰¿è‡ªContextWrapperï¼š\nbaseæ˜¯contextImplï¼Œæœ€ç»ˆè°ƒç”¨çš„æ˜¯contextImplçš„getSystemServiceï¼Œactivityäº¦æ˜¯å¦‚æ­¤ï¼š\nä»SYSTEM_SERVICE_FETCHERSä¸­è·å–ï¼š\næœ€ç»ˆæ˜¯åœ¨æ­¤å¤„æ·»åŠ äº†ä¸€ä¸ªPhoneLayoutInflaterå¯¹è±¡ï¼Œå¹¶æŠŠcontextImpl.getOuterContextä¼ è¿›å»äº†ï¼Œæ­¤å¤„ä¼ è¿›å»çš„æ˜¯Activityæˆ–è€…æ˜¯applicationå¯¹è±¡ã€‚ å¦‚æœfromä¸­ä¼ å…¥çš„æ˜¯activityï¼Œåœ¨contextThemeWrapperçš„getSystemServiceæ–¹æ³•ä¸­è·å–åˆ°PhoneLayoutInflateråï¼Œåˆè°ƒç”¨äº†cloneInContextï¼Œå°†å½“å‰çš„contextä¼ å…¥å…¶ä¸­ï¼š æ­¤å¤„ä¸ºä»€ä¹ˆè¦é€šè¿‡cloneInContextæ„é€ ä¸€ä¸ªæ–°çš„PhoneLayoutInflaterå‘¢ï¼Ÿ åœ¨ä¸Šé¢åˆ†æPhoneLayoutInflateråˆ›å»ºçš„æ—¶å€™ï¼Œæ˜¯é€šè¿‡SystemServiceRegistryçš„SYSTEM_SERVICE_FETCHERSä¸­mapè·å–çš„ï¼Œè€Œåœ¨ä¼ å…¥PhoneLayoutInflaterçš„contextæ˜¯é€šè¿‡ContextImplçš„getOuterContextæ–¹æ³•æ¥è·å–çš„ï¼Œä¸Šé¢åˆ†æè¿‡ContextImplçš„outerContextå¯èƒ½æ˜¯Activityï¼Œä¹Ÿå¯èƒ½æ˜¯Applicationï¼Œæ¯”å¦‚åœ¨Aè¿™ä¸ªActivityä¸­åˆ›å»ºäº†PhoneLayoutInflaterï¼Œè€Œåœ¨Bè¿™ä¸ªActivityä¸­è·å–PhoneLayoutInflaterçš„æ—¶å€™ï¼Œå¦‚æœæ²¡æœ‰cloneInContextï¼Œé‚£ä¹ˆè·å–è¿˜æ˜¯Aè¿™ä¸ªactivityä¸­çš„PhoneLayoutInflaterï¼Œè€Œlayoutinflaterè§£æxmlæ˜¯å¼ºä¾èµ–äºcontextï¼Œæ‰€ä»¥ä¸ºäº†ç¡®ä¿å½“å‰activityåˆ›å»ºçš„layoutinflaterä½¿ç”¨çš„æ˜¯å½“å‰contextï¼Œæ‰€ä»¥å°†å½“å‰çš„contextä¼ å…¥å…¶ä¸­æ„é€ ä¸€ä¸ªæ–°çš„layoutinflaterã€‚\nlayoutInflater.inflate: æ­¤è¿‡ç¨‹è°ƒç”¨createViewFromTagæ¥åˆ›å»ºviewï¼š\næ­¤å¤„çœ‹viewæœ‰æ²¡æœ‰themeå±æ€§ï¼Œæœ‰çš„è¯ï¼Œåˆ™æ„é€ ä¸€ä¸ªcontextThemeWrapperå‡ºæ¥ï¼Œä¸¾ä¸ªä¾‹å­ï¼š\næ­¤å¤„å®šä¹‰äº†ä¸€ä¸ªthemeå±æ€§ï¼Œé‚£ä¹ˆç»™è¯¥viewçš„æ„é€ å™¨ä¼ å…¥çš„contextå°±æ˜¯ä¸€ä¸ªcontextThemeWrapperå¯¹è±¡ã€‚æ‰€ä»¥viewçš„contextä¸ä¸€å®šæ˜¯activityçš„contextï¼Œå¦‚æœè®¾ç½®äº†themeå±æ€§ï¼Œé‚£ä¹ˆå°±æ˜¯ä¸€ä¸ªcontextThemeWrapperçš„contextã€‚\nå†æ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼Œåˆ›å»ºåˆ›å»ºlayoutinflaterçš„æ—¶å€™æŒ‡å®šcontextThemeWrapperå¯¹è±¡ï¼š åœ¨fromæ–¹æ³•é‡Œé¢ï¼Œä¼ å…¥ä¸€ä¸ªcontextthemewrapperå¯¹è±¡ï¼Œå¹¶æºå¸¦ä¸€ä¸ªstyleã€‚æ ¹æ®ä¸Šé¢åˆ†æfromæ–¹æ³•æ—¶ï¼Œcontextthemewrapperæ˜¯é€šè¿‡LayoutInflater.from(getBaseContext()).cloneInContext(this)ã€‚æ­¤å¤„çš„getBaseContext()åˆæ˜¯activityï¼Œåˆå› ä¸ºactivity.getSystemServiceï¼Œè°ƒç”¨base.getSystemServiceï¼Œæ‰€ä»¥æœ€ç»ˆåˆå›åˆ°äº†contextimpl.getSystemServiceã€‚è€Œåœ¨åˆ›å»ºPhoneLayoutInflaterçš„æ—¶å€™ï¼Œåˆé€šè¿‡contextimpl.getOuterContextä¼ å…¥åˆ°PhoneLayoutInflateræ„é€ å™¨ä¸­ï¼Œä½†æ˜¯åœ¨contextthemewrapperä¸­æœ€ååˆè°ƒäº†PhoneLayoutInflaterçš„cloneInContextï¼š\næ‰€ä»¥æ­¤ç§æƒ…å†µä¸‹ï¼Œæœ€ç»ˆç»™viewä¼ çš„contextä¹Ÿæ˜¯ä¸€ä¸ªcontextthemewrapperçš„contextã€‚\nAttréƒ¨åˆ† ä»ä¸»é¢˜ä¸­è·å–å±æ€§ï¼š\næœ€ç»ˆè¿™äº›å±æ€§æ˜¯é€šè¿‡contextçš„obtainStyledAttributesè·å–å±æ€§å€¼ã€‚å¸¸è§çš„æ–¹æ³•æ˜¯ï¼š\nAttributeSetè¡¨ç¤ºæ‰€æœ‰çš„å±æ€§é›†ï¼Œå®ƒæ˜¯åœ¨inflateè¿‡ç¨‹ä¸­è§£æåˆ°viewçš„å±æ€§é›†ã€‚ attrsè¡¨ç¤ºçš„æ˜¯è¦ä»å“ªä¸ªå±æ€§é›†ä¸­å–åˆ°å±æ€§ã€‚ ä¾‹å¦‚ï¼š\nattrsæ–‡ä»¶ä¸­å®šä¹‰ä¸€ä¸ªdeclare-styleableå±æ€§é›†ï¼Œaaptå·¥å…·ä¼šç”Ÿæˆå¯¹åº”çš„R.classï¼Œä½†æ˜¯æ­¤æ—¶æ˜¯ä¸€ä¸ªR.jaræ–‡ä»¶ï¼š\nè¯¥æ–‡ä»¶åœ¨app/build/intermediates/compile_and_runtime_not_namespaced_r_class_jar/debug/R.jarï¼Œåç¼–è¯‘è¯¥jaræ–‡ä»¶ï¼š\næœ€ç»ˆæ‰€æœ‰çš„èµ„æºç±»å‹éƒ½ä¼šç”Ÿæˆä¸€ä¸ªR$**.classçš„ç±»ï¼Œè€ŒR.classå…¶å®æ˜¯ä¸€ä¸ªç©ºå£³ï¼š\nçœ‹åˆšæ‰å®šä¹‰çš„declare-styleableç”Ÿæˆå¦‚ä¸‹ï¼š\nå¹¶ä¸”ä¼šåœ¨R$attr.classä¸‹é¢ä¹Ÿä¼šç”Ÿæˆä¸€ä¸ªä¸¤ä¸ªintå€¼ï¼š\nç”Ÿæˆäº†ä¸€ä¸ªR$styleable.TestViewçš„æ•°ç»„å’Œä¸¤ä¸ªintå€¼ï¼Œåˆ†åˆ«æ˜¯R$styleable.TestView_attr1å’ŒR$styleable.TestView_attr2ï¼Œå®ƒä¸¤åˆ†åˆ«ä»£è¡¨TestViewæ•°ç»„çš„ç´¢å¼•ï¼Œè€Œå¯¹åº”çš„å€¼æ˜¯å®šä¹‰åœ¨resource.arscæ–‡ä»¶ä¸­ï¼š\næ‰€ä»¥æœ€ç»ˆå¾—å‡ºç»“è®ºæ˜¯ï¼šé€šè¿‡context.obtainStyledAttributesä¼ å…¥attrbutesetå’Œattrsæ•°ç»„ï¼Œå¾—åˆ°äº†typearrayï¼Œç„¶åé€šè¿‡typearrayçš„ç´¢å¼•å¾—åˆ°æ‰€æœ‰çš„å±æ€§ï¼š\ndefStyleAttrã€defStyleRes æ–°å¢ä¸€ä¸ªä¸åœ¨declare-styleableæ•°ç»„ä¸­çš„attr11ï¼Œè§Ræ–‡ä»¶ï¼š\nåœ¨R$styleableç±»ä¸­æ²¡æœ‰attr11çš„å®šä¹‰ï¼Œå®ƒåœ¨R$attrç±»ä¸­å®šä¹‰äº†ï¼š\nåœ¨ä¸Šé¢å±æ€§ä¸­attr7å’Œattr11æ˜¯å¼•ç”¨ç±»å‹çš„ï¼Œä»–ä»¬å¯ä»¥æŒ‡å‘å¦å¤–ä¸€ä¸ªå¼•ç”¨ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 public class TestView1 extends View { public TestView1(Context context) { this(context, null); } public TestView1(Context context, @Nullable AttributeSet attrs) { this(context, attrs, R.attr.attr11); } public TestView1(Context context, @Nullable AttributeSet attrs, int defStyleAttr) { this(context, attrs, defStyleAttr, R.style.DefStyleRes); } public TestView1(Context context, @Nullable AttributeSet attrs, int defStyleAttr, int defStyleRes) { super(context, attrs, defStyleAttr, defStyleRes); TypedArray ta = context.obtainStyledAttributes(attrs, R.styleable.gui, defStyleAttr, defStyleRes); log(\u0026#34;TypedArray lengthï¼š\u0026#34; + ta.length()); for (int i = 0; i \u0026lt; ta.length(); i++) { int attrIndex = ta.getIndex(i); switch (attrIndex) { case R.styleable.gui_attr1: log(ta.getString(attrIndex)); break; case R.styleable.gui_attr2: log(ta.getString(attrIndex)); break; case R.styleable.gui_attr3: log(ta.getString(attrIndex)); break; case R.styleable.gui_attr4: log(ta.getString(attrIndex)); break; case R.styleable.gui_attr5: log(ta.getString(attrIndex)); break; case R.styleable.gui_attr6: log(ta.getString(attrIndex)); break; case R.styleable.gui_attr7: log(ta.getString(attrIndex)); break; default: break; } } ta.recycle(); } private void log(String msg) { Log.v(getClass().getSimpleName(), \u0026#34;\u0026#34; + msg); } } TestView1ä¸­defStyleAtträ¼ å…¥R.attr.attr11ï¼ŒdefStyleResä¼ å…¥R.style.DefStyleResã€‚ å¸ƒå±€æ–‡ä»¶å¦‚ä¸‹ï¼š\nå…¶ä¸­themeä¸­å¼•ç”¨äº†attr11çš„å¼•ç”¨ï¼Œè€Œthemestyleä¸­å¼•ç”¨äº†attr1-attr4ï¼ŒDefStyleResä¸­ä¹Ÿå¼•ç”¨äº†attr1-attr4ã€‚æ—¥å¿—å¦‚ä¸‹ï¼š\nR.styleable.guiæ€»å…±é•¿åº¦æ˜¯7ï¼Œattr1ç”¨çš„xmlä¸­å®šä¹‰çš„ï¼Œattr2æ˜¯å¸ƒå±€ä¸­å®šä¹‰çš„styleä¸­çš„å±æ€§ï¼Œattr3å’Œattr4å–çš„æ˜¯themeä¸­attr11å®šä¹‰çš„attr3å’Œattr4ï¼Œç”±äºattr5æ²¡æœ‰åœ¨attr11ä¸­çš„styleä¸­å®šä¹‰ï¼Œæ‰€ä»¥å–çš„æ˜¯themeä¸­çš„attr5å±æ€§ã€‚ ä¼˜å…ˆçº§ï¼šå¸ƒå±€ä¸­çš„attr\u0026gt;å¸ƒå±€ä¸­çš„styleä¸­çš„attr\u0026gt;defStyleAtträ¸­çš„attr\u0026gt;themeä¸­çš„attr æ­¤æ—¶æ— è®ºæ€ä¹ˆåœ¨DefStyleResä¸­å®šä¹‰å±æ€§ï¼Œéƒ½ä¸ä¼šåœ¨è¯¥styleé‡Œé¢çš„attrå–å€¼ï¼Œå› ä¸ºæ­¤æ—¶å®šä¹‰äº†defStyleAttr æ­¤æ—¶å¦‚æœå»æ‰defStyleAttrï¼Œåˆ™ä¼šåœ¨DefStyleResä¸­å–å€¼ï¼š\nç»“æœå¦‚ä¸‹ï¼š\næ€»ç»“ï¼šdefStyleAttrå®šä¹‰äº†åï¼ŒdefStyleResä¸­çš„attrå°±ä¸èµ·ä½œç”¨äº†ã€‚\nå‚è€ƒï¼šhttps://blog.csdn.net/GracefulGuigui/article/details/104069265\n","date":"2024-10-25T00:00:00Z","permalink":"http://xiangcman.xyz/p/android-context%E6%80%BB%E7%BB%93/","title":"Android contextæ€»ç»“"}]