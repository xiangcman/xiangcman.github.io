[{"content":"åˆ›å»ºè„šæœ¬ é¦–å…ˆåœ¨ç»ˆç«¯ä¸‹åˆ›å»ºä¸€ä¸ªè„šæœ¬æ–‡ä»¶\n1 touch apkcompare ç»™è„šæœ¬èµ‹äºˆæ‰§è¡Œæƒé™ 1 chmod +x apkcompare æ‰“å¼€è„šæœ¬ ä½¿ç”¨zshä¸­è£…çš„sublimeæ’ä»¶æ‰“å¼€è„šæœ¬æ–‡ä»¶\n1 st apkcompare ç¼–è¾‘è„šæœ¬å†…å®¹ 1 2 3 4 5 6 7 #!/bin/bash echo \u0026#34;è¯·è¾“å…¥æ”¹å˜å‰çš„apkè·¯å¾„ï¼š\u0026#34; read path1 echo \u0026#34;è¯·è¾“å…¥æ”¹å˜åçš„apkè·¯å¾„ï¼š\u0026#34; read path2 cd /Users/xiangcheng/downloads java -jar apkcompare-1.0.jar $path1 $path2 compare_result_file æ‰§è¡Œè„šæœ¬ 1 ./apkcompare å°†è„šæœ¬å®šåˆ¶æˆåº”ç”¨ å¹³æ—¶ä½¿ç”¨shellè„šæœ¬çš„æ—¶å€™ï¼Œæ¯æ¬¡éƒ½è¦æ‰¾åˆ°shellè„šæœ¬çš„æ‰§è¡Œæ–‡ä»¶éå¸¸éº»çƒ¦ï¼Œç„¶åæƒ³åˆ°å¦‚æœèƒ½å°†shellè„šæœ¬åˆ¶ä½œæˆä¸€ä¸ªåº”ç”¨é‚£å°±éå¸¸niceäº†ã€‚ ä¸‹é¢å°±ä»¥å¹³æ—¶ç”¨çš„æ¯”è¾ƒå¤šçš„åç¼–è¯‘è„šæœ¬jadxä¸ºä¾‹æ¥å®è·µã€‚\nå…ˆé€šè¿‡Alfredå·¥å…·æœç´¢å‡ºæœ¬æœºçš„Automatorå·¥å…·ï¼š é€‰å–åº”ç”¨ç¨‹åº æ·»åŠ shellè„šæœ¬ åœ¨å·¦ä¾§æœç´¢ â€œè¿è¡Œ Shell è„šæœ¬â€ï¼ˆRun Shell Scriptï¼‰ã€‚ æ‹–åŠ¨åˆ°å³ä¾§å·¥ä½œåŒºã€‚ åœ¨ Shell é€‰é¡¹é‡Œï¼Œé€‰æ‹© /bin/bashï¼ˆæˆ– /bin/zshï¼‰ã€‚ åœ¨æ–‡æœ¬æ¡†é‡Œè¾“å…¥å¦‚ä¸‹ä»£ç ï¼š 1 2 #!/bin/bash /opt/homebrew/Cellar/jadx/1.5.1/bin/jadx-gui æˆ‘æ˜¯é€šè¿‡homebrewè£…çš„jadxå·¥å…·ï¼Œæ‰€ä»¥æŒ‡å®šä¸‹è‡ªå·±çš„jadxç›®å½•ã€‚\nä¿å­˜åº”ç”¨ ç»™åº”ç”¨å®šåˆ¶å›¾æ ‡ macä¸‹åº”ç”¨çš„å›¾æ ‡éƒ½æ˜¯é€šè¿‡åº”ç”¨ä¸‹çš„Info.plistæ–‡ä»¶æ¥æ§åˆ¶çš„ï¼š å®ƒæ˜¯é€šè¿‡CFBundleIconFileå­—æ®µæ§åˆ¶çš„ï¼Œè¿™é‡Œæˆ‘æŠŠå›¾æ ‡æ”¾åœ¨äº†åº”ç”¨çš„Resourcesæ–‡ä»¶ä¸‹ï¼š å¯ä»¥çœ‹åˆ°éœ€è¦ä¸€ä¸ª.icnsçš„æ–‡ä»¶ï¼Œè¿™é‡Œæˆ‘æ˜¯é€šè¿‡åœ¨çº¿ç½‘ç«™https://cloudconvert.com/png-to-icnsæ¥å®ç°png-\u0026gt;icnsçš„ã€‚ä¸€åˆ‡æ›¿æ¢å®Œåï¼Œè¿˜éœ€è¦åˆ·æ–° Launch Servicesï¼Œå¦åˆ™ macOS å¯èƒ½ä¸ä¼šç«‹åˆ»è¯†åˆ«æ–°å›¾æ ‡ï¼Œæ‰§è¡Œå¦‚ä¸‹è„šæœ¬ï¼š\n1 2 touch /Applications/Jadx.app killall Finder æˆ‘åœ¨chatgptæœç´¢çš„æ—¶å€™ï¼Œå®ƒæ˜¯é€šè¿‡touch ~/Applications/Jadx.appæ¥æ‰§è¡Œçš„ï¼Œä½†æ˜¯æˆ‘å‘ç°æˆ‘çš„Jadx.appæ˜¯åœ¨å¦‚ä¸‹ç›®å½•ï¼š æ‰€ä»¥ä¸ç”¨å®šä½åˆ°Users/ç”¨æˆ·åï¼Œè¦ä¸ç„¶ä¼šæŠ¥é”™æ‰¾ä¸åˆ°Jadxåº”ç”¨ã€‚è¿™é‡Œæä¸€å¥macä¸‹~è¡¨ç¤ºçš„ç›®å½•æ˜¯Users/ç”¨æˆ·åï¼Œæ¯”å¦‚æˆ‘çš„å¦‚ä¸‹ï¼š æ“ä½œå®Œåï¼Œä¸€ä¸ªå¸¦å›¾æ ‡çš„shellè„šæœ¬çš„åº”ç”¨å°±åˆ›å»ºæˆåŠŸäº†ã€‚\n","date":"2025-02-19T00:00:00Z","permalink":"https://example.com/p/mac%E4%B8%8B%E5%BF%AB%E9%80%9F%E5%86%99%E4%B8%80%E4%B8%AA%E8%84%9A%E6%9C%AC/","title":"macä¸‹å¿«é€Ÿå†™ä¸€ä¸ªè„šæœ¬"},{"content":"boosteræ˜¯åŸºäºgradle transformã€asmè¿›è¡Œå­—èŠ‚ç æ“ä½œçš„æ¡†æ¶ï¼Œå†…éƒ¨æœ‰å¾ˆå¤šgradle transformæ¥æ“ä½œå¯¹åº”çš„å­—èŠ‚ç ï¼Œé¦–å…ˆæˆ‘ä»¬å°†å¯¹åº”çš„æ’ä»¶ä¾èµ–è¿›æ¥ï¼Œæˆ‘ä»¬ä»¥toastæ’ä»¶æ›¿æ¢ä¸ºæµ‹è¯•ï¼Œçœ‹ä¸‹æ•ˆæœ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 buildscript { ext { plugin_version = \u0026#34;0.3.0\u0026#34; booster_version = \u0026#34;1.0.0\u0026#34; } // ext.plugin_version = \u0026#34;0.3.0\u0026#34; repositories { google() jcenter() maven { url \u0026#34;https://artifact.bytedance.com/repository/byteX/\u0026#34; } } dependencies { classpath \u0026#39;com.android.tools.build:gradle:3.5.3\u0026#39; //booster classpath \u0026#34;com.didiglobal.booster:booster-gradle-plugin:$booster_version\u0026#34; //booster toastæ’ä»¶ classpath \u0026#34;com.didiglobal.booster:booster-transform-toast:$booster_version\u0026#34; //bytex base // classpath \u0026#34;com.bytedance.android.byteX:base-plugin:${plugin_version}\u0026#34; // Add bytex plugins\u0026#39; dependencies on demand. æŒ‰éœ€æ·»åŠ æ’ä»¶ä¾èµ– // classpath \u0026#34;com.bytedance.android.byteX:method-call-opt-plugin:${plugin_version}\u0026#34; // NOTE: Do not place your application dependencies here; they belong // in the individual module build.gradle files } } ç„¶åä½¿ç”¨æ’ä»¶ï¼š\n1 2 apply plugin: \u0026#39;com.android.application\u0026#39; apply plugin: \u0026#39;com.didiglobal.booster\u0026#39; // â‘¢ åœ¨MainActivityä¸­æ·»åŠ å¦‚ä¸‹ä»£ç ï¼š ç„¶åçœ‹ç¼–è¯‘åçš„ç±»ï¼Œè¿™é‡Œæœ‰ä¸ªç»†èŠ‚ï¼Œå¤§å®¶å¾—ç†Ÿæ‚‰æ‰“åŒ…æµç¨‹ï¼Œjavacç¼–è¯‘æˆclassåï¼Œç„¶åæŠŠclassè½¬åŒ–æˆdexæ–‡ä»¶ï¼Œtransformå°±æ˜¯ä½œç”¨äºclassè½¬æˆdexä¹‹é—´ï¼Œæ‰€ä»¥å¦‚æœçœ‹javacä¹‹åçš„classæ˜¯çœ‹ä¸åˆ°æœ€ç»ˆtoastæ’ä»¶ä½œç”¨çš„æ•ˆæœï¼Œéœ€è¦åç¼–è¯‘çœ‹æœ€ç»ˆçš„apkæˆ–è€…dexæ–‡ä»¶ï¼š å¯ä»¥çœ‹åˆ°æ­¤æ—¶æ˜¯æ›¿æ¢æˆäº†ShadowToastä¸­çš„showæ–¹æ³•äº†ã€‚ä¸‹é¢ç»“åˆæºç çœ‹ä¸‹boosterå¦‚ä½•åšåˆ°classæ›¿æ¢çš„ï¼Œæœ¬æ¬¡é€šè¿‡gradleä¸‹è½½çš„æ’ä»¶æºç æ¥åˆ†æï¼Œboosteræ’ä»¶ä¸‹è½½çš„åœ°å€åœ¨/Users/xiangcheng/.gralde/cache/modules-2/files-2.1/com.didiglobal.boosterä¸‹ï¼š booster-gradle-plugin æ˜¯boosterå®šä¹‰æ’ä»¶çš„æ¨¡å—ï¼Œä¸‹é¢æ‰“å¼€å®ƒçš„æºç ï¼Œæ‰¾åˆ°å®ƒçš„pluginï¼š\n","date":"2025-02-17T00:00:00Z","permalink":"https://example.com/p/booster%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/","title":"boosteræºç åˆ†æ"},{"content":"gradleçš„å¾ˆå¤šæ’ä»¶æ¶‰åŠåˆ°äº†å­—èŠ‚ç ä¿®æ”¹ï¼Œå†…éƒ¨ä¿®æ”¹å­—èŠ‚ç åŸºæœ¬éƒ½æ˜¯é€šè¿‡asmæ¥ä¿®æ”¹ï¼Œæœ¬æ–‡ç« å°±æ˜¯é€šè¿‡asmæ¥ä¿®æ”¹classã€‚æœ¬æ–‡åŸºäºintellij ideaæ¥ä½“éªŒçš„ã€‚\nä¸‹è½½ä¾èµ– é¦–å…ˆæˆ‘åˆ›å»ºçš„å·¥ç¨‹æ˜¯ä¸€ä¸ªjavaå·¥ç¨‹ï¼Œç„¶åå°†é¡¹ç›®é…ç½®æˆmavenå·¥ç¨‹ï¼š æ¥ç€å»mavenå®˜ç½‘æ‰¾ä¸‹å¯¹åº”ä¾èµ–ï¼š ç„¶ååœ¨å·¥ç¨‹é‡Œé¢æ·»åŠ ä¾èµ–ï¼š è¯»å–class é¦–å…ˆå®šä¹‰ä¸€ä¸ªæ™®é€šçš„ç±»ï¼š 1 2 3 4 5 6 7 8 9 10 11 public class User { private String name;//Ljava/lang/Stringè¡¨ç¤ºstringç±»å‹ private int age;//Iè¡¨ç¤ºintç±»å‹ private long lang;//åœ¨classä¸­Jè¡¨ç¤ºlongç±»å‹ public String getName() { return name; } public int getAge() { return age; } } è¯»å–åˆ°Userç±»å¯¹åº”classçš„è·¯å¾„ 1 2 3 4 5 6 7 8 9 public class Utils { public static String getClassFilePath(Class clazz) { // file:/Users/xiangcheng/IdeaProject/Asm/target/classes/ String buildDir = clazz.getProtectionDomain().getCodeSource().getLocation().getFile();//è·å–åˆ°æ–‡ä»¶æ‰€åœ¨ä½ç½® String fileName = clazz.getSimpleName() + \u0026#34;.class\u0026#34;; File file = new File(buildDir + clazz.getPackage().getName().replaceAll(\u0026#34;[.]\u0026#34;, \u0026#34;/\u0026#34;) + \u0026#34;/\u0026#34;, fileName); return file.getAbsolutePath(); } } é€šè¿‡ClassReaderè·å–åˆ°classçš„è¯»å– 1 2 3 4 Class clazz = User.class; String clazzFilePath = Utils.getClassFilePath(clazz); //é¦–å…ˆé€šè¿‡classçš„è·¯å¾„è·å–åˆ°classReaderï¼Œç„¶åé€šè¿‡classReaderçš„acceptæ–¹æ³•ï¼Œä¼ å…¥ä¸€ä¸ªclassNodeï¼Œç„¶åä½¿ç”¨classNodeè·å–åˆ°æ–¹æ³•å’Œå±æ€§ ClassReader classReader = new ClassReader(new FileInputStream(clazzFilePath)); é€šè¿‡classReaderè·å–åˆ°classNode 1 2 ClassNode classNode = new ClassNode(Opcodes.ASM5); classReader.accept(classNode, 0); ClassNodeè¯»å–æ–¹æ³•å’Œå±æ€§ 1 2 3 4 5 6 7 8 9 10 List\u0026lt;MethodNode\u0026gt; methods = classNode.methods; List\u0026lt;FieldNode\u0026gt; fields = classNode.fields; System.out.println(\u0026#34;methods:\u0026#34;); for (MethodNode methodNode : methods) { System.out.println(methodNode.name + \u0026#34;, \u0026#34; + methodNode.desc); } System.out.println(\u0026#34;fields:\u0026#34;); for (FieldNode fieldNode : fields) { System.out.println(fieldNode.name + \u0026#34;, \u0026#34; + fieldNode.desc); } è·å–ä¿¡æ¯å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 methods: \u0026lt;init\u0026gt;, ()V getName, ()Ljava/lang/String; getAge, ()I fields: name, Ljava/lang/String; age, I lang, J æˆ‘ä»¬é€šè¿‡jclasslibéªŒè¯ä¸‹ï¼š å…¶ä¸­å±æ€§çš„åå­—ï¼Œæè¿°ç¬¦ï¼Œè®¿é—®æ ‡è¯†éƒ½å’Œä¸Šé¢çš„å¯¹åº”çš„ä¸Šã€‚æ–¹æ³•ä¹Ÿæ˜¯å¦‚æ­¤ã€‚ ä¸Šé¢æ˜¯é€šè¿‡classNodeæ ‘å½¢ç»“æ„è®¿é—®çš„ï¼Œä¸‹é¢é€šè¿‡visitå›è°ƒçš„å½¢å¼è®¿é—®å±æ€§å’Œæ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 Class clazz = User.class; String clazzFilePath = Utils.getClassFilePath(clazz); ClassReader classReader = new ClassReader(new FileInputStream(clazzFilePath)); //å‰é¢ä»‹ç»çš„classNodeæ˜¯ç»§æ‰¿è‡ªclassVisitorï¼ŒclassNodeæ˜¯æŠŠæ‰€æœ‰çš„æ–¹æ³•å’Œå±æ€§å…¨éƒ¨éƒ½è¯»åˆ°å†…å­˜ä¸­ï¼Œç„¶åå†éå†ï¼ŒClassVisitorè¾¹è¯»è¾¹éå† ClassVisitor classVisitor = new ClassVisitor(Opcodes.ASM5) { @Override public FieldVisitor visitField(int access, String name, String descriptor, String signature, Object value) { System.out.println(\u0026#34;visit field:\u0026#34; + name + \u0026#34; , desc = \u0026#34; + descriptor); return super.visitField(access, name, descriptor, signature, value); } @Override public MethodVisitor visitMethod(int access, String name, String descriptor, String signature, String[] exceptions) { System.out.println(\u0026#34;visit method:\u0026#34; + name + \u0026#34; , desc = \u0026#34; + descriptor); return super.visitMethod(access, name, descriptor, signature, exceptions); } }; classReader.accept(classVisitor, 0); é€šè¿‡ClassVisitorä¹Ÿèƒ½è®¿é—®åˆ°å±æ€§å’Œæ–¹æ³•ï¼Œä¸Šé¢ä»‹ç»çš„ClassNodeæ˜¯ç»§æ‰¿è‡ªClassVisitorï¼ŒClassVisitoræ˜¯è¾¹è¯»è¾¹éå†ï¼Œè€ŒClassNodeæ˜¯æŠŠæ–¹æ³•å’Œå±æ€§å…¨éƒ¨éƒ½è¯»åˆ°å†…å­˜ä¸­ï¼Œç„¶åå†éå†ã€‚\nä¿®æ”¹class ä¸Šé¢ä»‹ç»çš„éƒ½æ˜¯è¯»å–classï¼Œæˆ‘ä»¬æœ€ç»ˆçš„ç›®çš„æ˜¯ä¿®æ”¹classï¼Œä¸‹é¢ä¹Ÿé€šè¿‡ä¸€ä¸ªğŸŒ°æ¥ä»‹ç»å¦‚ä½•ä¿®æ”¹classï¼Œè¿˜æ˜¯å…ˆæ¥ä¸€ä¸ªç±»ï¼š\n1 2 3 4 5 6 7 public class C { public void m() throws Exception { Thread.sleep(100); } } æˆ‘ä»¬è¦æŠŠå®ƒä¿®æ”¹æˆå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 public class C { public static long timer; public void m() throws Exception { timer -= System.currentTimeMillis(); Thread.sleep(100L); timer += System.currentTimeMillis(); } } asmä¿®æ”¹å­—èŠ‚ç å…ˆé€šè¿‡ClassReaderæŠŠclassä¿¡æ¯è¯»å–åˆ°ï¼Œç„¶åé€šè¿‡ClassWriteræŠŠä¿®æ”¹åçš„classå†å†™ä¼šåˆ°æ–‡ä»¶é‡Œé¢ï¼Œå…ˆä»‹ç»ä¸‹é€šè¿‡ClassWriteræŠŠclasså†™åˆ°æ–‡ä»¶ä¸­ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 Class clazz = C.class; String clazzFilePath = Utils.getClassFilePath(clazz); ClassReader classReader = new ClassReader(new FileInputStream(clazzFilePath)); ClassWriter classWriter = new ClassWriter(0); classReader.accept(classWriter, 0); // å†™å…¥æ–‡ä»¶ byte[] bytes = classWriter.toByteArray(); String buildDir = clazz.getProtectionDomain().getCodeSource().getLocation().getFile(); FileOutputStream fos = new FileOutputStream(buildDir + clazz.getPackage().getName().replaceAll(\u0026#34;[.]\u0026#34;, \u0026#34;/\u0026#34;) +\u0026#34;/copyed.class\u0026#34;); fos.write(bytes); fos.flush(); fos.close(); å¯ä»¥çœ‹åˆ°classReaderçš„acceptæ–¹æ³•ä¹Ÿå¯ä»¥æ¥å—ä¸€ä¸ªclassWriterå¯¹è±¡ï¼Œå®ƒä¹Ÿæ˜¯ç»§æ‰¿è‡ªclassVisitorï¼Œç„¶åæŠŠå®ƒè½¬åŒ–æˆbyteæ•°ç»„ï¼Œæœ€åé€šè¿‡æ–‡ä»¶è¾“å‡ºæµæŠŠbyteæ•°ç»„å†™ä¼šåˆ°æ–‡ä»¶ä¸­ï¼Œæ•´ä¸ªè¿‡ç¨‹å¾ˆç®€å•ã€‚ä¿®æ”¹classä¹Ÿæ˜¯å¦‚æ­¤æŠŠä¿®æ”¹åçš„byteæ•°ç»„ä¹Ÿæ˜¯å†™ä¼šåˆ°æ–‡ä»¶ä¸­çš„ã€‚\nåœ¨ä¸Šé¢æˆ‘ä»¬çŸ¥é“classVisitoræ˜¯è¯»å–classçš„æ ¸å¿ƒç±»ï¼Œæœ€ç»ˆæŠŠè¯¥classVistorä¼ åˆ°acceptæ–¹æ³•ä¸­ï¼Œè€ŒclassWriterä¹Ÿéœ€è¦ä¼ åˆ°acceptæ–¹æ³•ä¸­ã€‚æ‰€ä»¥çœ‹ä¸‹ä¸¤è€…éƒ½è¦ä½¿ç”¨çš„è¯ï¼Œè¯¥æ€ä¹ˆå¤„ç†ï¼š å¯ä»¥çœ‹åˆ°æ„é€ å™¨ä¸­å¯ä»¥ä¼ å…¥classVisitorï¼Œæœ€ç»ˆé‡Œé¢çš„æ‰€æœ‰visit**æ–¹æ³•éƒ½æ˜¯è°ƒç”¨äº†ä¼ å…¥è¿›æ¥çš„classVisitoræ–¹æ³•ã€‚æ‰€ä»¥ä¸éš¾çœ‹å‡ºæ¥è¿™æ˜¯ä¸ªä»£ç†æ¨¡å¼ï¼Œä¼ å…¥è¿›æ¥çš„classVisitoræ˜¯ä¸€ä¸ªè¢«ä»£ç†å¯¹è±¡ï¼Œè¯¥classVisitoræ˜¯ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œé¦–å…ˆè‡ªå®šä¹‰ä¸€ä¸ªclassVisitorï¼š\n1 2 3 4 5 6 public class AddTimerClassVisitor extends ClassVisitor { public AddTimerClassVisitor(int api, ClassVisitor classVisitor) { super(api, classVisitor); } } ç„¶åçœ‹ä¸‹æ€ä¹ˆè°ƒç”¨AddTimerClassVisitorï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 Class clazz = C.class; String clazzFilePath = Utils.getClassFilePath(clazz); ClassReader classReader = new ClassReader(new FileInputStream(clazzFilePath)); //ClassWriter.COMPUTE_FRAMESè¡¨ç¤ºè‡ªåŠ¨è®¡ç®—æ–¹æ³•æ ˆæ•° ClassWriter classWriter = new ClassWriter(ClassWriter.COMPUTE_FRAMES); //é€šè¿‡æ„é€ ä¸€ä¸ªæ–°çš„classVisitorï¼Œç„¶åå°†classWriterä¼ å…¥åˆ°è¯¥classVistorä¸­ï¼Œå®é™…å¹²æ´»çš„è¿˜æ˜¯classWriterï¼ŒAddTimerClassVisitoråªæ˜¯ä½œä¸ºä¸€ä¸ªä»£ç†ç±»ï¼Œè¿›è¡Œæ·»åŠ å±æ€§ AddTimerClassVisitor addTimerClassVisitor = new AddTimerClassVisitor(Opcodes.ASM5, classWriter); classReader.accept(addTimerClassVisitor, 0); // å†™å…¥æ–‡ä»¶ byte[] bytes = classWriter.toByteArray(); FileOutputStream fos = new FileOutputStream(clazzFilePath); fos.write(bytes); fos.flush(); fos.close(); å°†ClassWriterä¼ åˆ°AddTimerClassVisitorä¸­ï¼Œå¯ä»¥çœ‹å‡ºæ¥ClassWriteræ˜¯è¢«ä»£ç†çš„å¯¹è±¡ï¼ŒAddTimerClassVisitoræ˜¯ä»£ç†å¯¹è±¡ï¼Œåœ¨å‰é¢æˆ‘ä»¬é€šè¿‡é‡å†™visitFieldè®¿é—®åˆ°å±æ€§ï¼Œé€šè¿‡visitMethodè®¿é—®åˆ°æ–¹æ³•ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•æ˜¯å¤šæ¬¡è¢«è°ƒç”¨ï¼Œè€Œæˆ‘ä»¬æ˜¯æƒ³æ·»åŠ ä¸€ä¸ªé™æ€çš„timerå±æ€§ï¼Œå’Œä¿®æ”¹æ–¹æ³•mï¼Œé‚£æ­¤æ—¶visitFieldè‚¯å®šä¸ä¼šè¢«è°ƒç”¨åˆ°ï¼Œåœ¨classå¼€å§‹è®¿é—®å’Œç»“æŸè®¿é—®çš„æ—¶å€™ä¼šåˆ†åˆ«è°ƒç”¨visitå’ŒvisitEndæ–¹æ³•ï¼Œé‚£æ·»åŠ timerå±æ€§å¯ä»¥æ”¾åˆ°visitEndä¸­ï¼Œä¿®æ”¹æ–¹æ³•å¯ä»¥åœ¨visitMethodä¸­é€šè¿‡è¿‡æ»¤æ¥è¾¾åˆ°ä¿®æ”¹çš„ç›®çš„ï¼Œè€Œæœ€ç»ˆçš„å­—èŠ‚ç ç…§æ ·å¯ä»¥å…ˆæŠŠç»“æœé€šè¿‡jclasslibæ¥æŸ¥çœ‹ï¼š åœ¨classä¸­åå­—æ˜¯timerï¼Œæè¿°ç¬¦æ˜¯Jï¼Œè®¿é—®æ ‡å¿—æ˜¯public+staticï¼Œé‚£ä¹ˆé€šè¿‡asmå¦‚ä½•æ·»åŠ è¯¥å±æ€§ï¼š\n1 2 3 4 5 6 7 8 9 10 11 @Override public void visitEnd() { System.out.println(\u0026#34;AddTimerClassVisitor visitEnd\u0026#34;); //é€šè¿‡visitFieldæ–¹æ³•æ·»åŠ å±æ€§,cvæ˜¯ä¼ è¿›æ¥çš„classWriterï¼Œå®é™…å¹²æ´»çš„è¿˜æ˜¯classWriterï¼Œæ­¤å¤„ç”¨åˆ°äº†ä»£ç†æ¨¡å¼ FieldVisitor fv = cv.visitField(Opcodes.ACC_PUBLIC + Opcodes.ACC_STATIC, \u0026#34;timer\u0026#34;, \u0026#34;J\u0026#34;, null, null);//visitFieldæ–¹æ³•ç¬¬ä¸€ä¸ªå‚æ•°å®šä¹‰è®¿é—®æ ‡å¿—ï¼Œå®ƒæ˜¯public+staticç±»å‹ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯å‚æ•°çš„åå­—ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯å‚æ•°çš„æè¿°ç¬¦ï¼Œè¡¨ç¤ºä»€ä¹ˆç±»å‹ï¼Œlongç±»å‹ç”¨Jè¡¨ç¤º if (fv != null) { fv.visitEnd(); } cv.visitEnd(); } é€šè¿‡cvï¼ˆä¼ è¿›æ¥çš„classWriterï¼‰æ¥è®¿é—®å±æ€§æ¥æ·»åŠ timerå±æ€§ï¼Œå’Œä¸Šé¢ç”¨jclasslibå·¥å…·æŸ¥çœ‹çš„ç»“æœä¸€æ ·ã€‚ä¸‹é¢å†çœ‹ä¸‹å¦‚æœä¿®æ”¹mæ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 @Override public MethodVisitor visitMethod(int access, String name, String descriptor, String signature, String[] exceptions) { System.out.println(\u0026#34;AddTimerClassVisitor visitMethod\u0026#34;); MethodVisitor methodVisitor = super.visitMethod(access, name, descriptor, signature, exceptions); if (methodVisitor != null \u0026amp;\u0026amp; !name.equals(\u0026#34;\u0026lt;init\u0026gt;\u0026#34;)) { NewMethodVisitor newMethodVisitor = new NewMethodVisitor(Opcodes.ASM5, methodVisitor, mOwner); return newMethodVisitor; } return methodVisitor; } é¦–å…ˆæ˜¯æ‹¿åˆ°å½“å‰çš„MethodVisitorï¼Œç„¶ååˆ¤æ–­æ–¹æ³•ä¸æ˜¯æ„é€ å‡½æ•°ï¼Œæœ€åæ”¾å›ä¸€ä¸ªæ–°çš„NewMethodVisitorï¼Œå¦åˆ™è¿”å›åŸæ¥çš„MethodVisitorï¼Œä¸‹æ¥æ¥çœ‹ä¸‹NewMethodVisitorå¦‚ä½•ä¿®æ”¹æ–¹æ³•mï¼Œå…ˆçœ‹ä¸‹jclasslibä¿®æ”¹åclassçš„æ–¹æ³•mï¼š å…¶å®æˆ‘ä»¬é€šè¿‡javap -v com.xc.asm.Cæ¥æŸ¥çœ‹å­—èŠ‚ç ï¼š æ›´å¤šçš„javapå‘½ä»¤å¦‚ä¸‹ï¼š æœ‰äº†ä¸Šé¢åç¼–è¯‘çš„å­—èŠ‚ç åï¼Œå…¶å®å°±æ˜¯asmå¯¹åº”çš„æ–¹æ³•æ“ä½œäº†ï¼Œåœ¨NewMethodVisitorä¸­é‡å†™visitCodeæ–¹æ³•ï¼Œåœ¨è®¿é—®è¯¥æ–¹æ³•ä¹‹å‰æ·»åŠ å¯¹åº”çš„å­—èŠ‚ç ï¼Œé‡å†™visitInsnæ–¹æ³•ï¼Œåœ¨æ–¹æ³•returnä¹‹å‰æ·»åŠ å¯¹åº”çš„å­—èŠ‚ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 public class NewMethodVisitor extends MethodVisitor { private String mOwner; public NewMethodVisitor(int api, MethodVisitor methodVisitor, String mOwner) { super(api, methodVisitor); this.mOwner = mOwner; } @Override public void visitCode() { mv.visitCode(); mv.visitFieldInsn(GETSTATIC, mOwner, \u0026#34;timer\u0026#34;, \u0026#34;J\u0026#34;); mv.visitMethodInsn(INVOKESTATIC, \u0026#34;java/lang/System\u0026#34;, \u0026#34;currentTimeMillis\u0026#34;, \u0026#34;()J\u0026#34;); mv.visitInsn(LSUB); mv.visitFieldInsn(PUTSTATIC, mOwner, \u0026#34;timer\u0026#34;, \u0026#34;J\u0026#34;); } @Override public void visitInsn(int opcode) { if ((opcode \u0026gt;= IRETURN \u0026amp;\u0026amp; opcode \u0026lt;= RETURN) || opcode == ATHROW) { mv.visitFieldInsn(GETSTATIC, mOwner, \u0026#34;timer\u0026#34;, \u0026#34;J\u0026#34;); mv.visitMethodInsn(INVOKESTATIC, \u0026#34;java/lang/System\u0026#34;, \u0026#34;currentTimeMillis\u0026#34;, \u0026#34;()J\u0026#34;); mv.visitInsn(LADD); mv.visitFieldInsn(PUTSTATIC, mOwner, \u0026#34;timer\u0026#34;, \u0026#34;J\u0026#34;); } mv.visitInsn(opcode); } } å¯ä»¥ç»“åˆä¸Šé¢çš„åç¼–è¯‘çš„å­—èŠ‚ç ï¼Œå¯¹åº”ç€çœ‹asmçš„æ“ä½œã€‚æœ€åasmæ“ä½œå®Œåï¼Œå°±æ˜¯é€šè¿‡è¾“å‡ºæµæŠŠbyteæ•°ç»„å†™ä¼šåˆ°æ–‡ä»¶ä¸­ã€‚\nå‚è€ƒ: Android è¿›é˜¶ä¹‹è·¯ï¼šASM ä¿®æ”¹å­—èŠ‚ç ï¼Œè¿™æ ·å­¦å°±å¯¹äº†ï¼ asmä¾èµ– asmå®˜ç½‘ jclasslib\n","date":"2025-02-10T00:00:00Z","permalink":"https://example.com/p/asm%E4%BF%AE%E6%94%B9%E5%AD%97%E8%8A%82%E7%A0%81%E5%88%9D%E4%BD%93%E9%AA%8C/","title":"asmä¿®æ”¹å­—èŠ‚ç åˆä½“éªŒ"},{"content":"å¹³æ—¶å·¥ä½œä¸­éœ€è¦ç»å¸¸å˜jdkçš„ç‰ˆæœ¬é…ç½®ï¼Œä½¿ç”¨jenvæ¥ç®¡ç†jdkçš„æ—¶å€™ï¼Œä¸ç”¨æ¥å›é…ç½®ç¯å¢ƒå˜é‡ã€‚\nå®‰è£…jenv 1 brew install jenv é…ç½®.zshrc 1 2 export PATH=\u0026#34;$HOME/.jenv/bin:$PATH\u0026#34; eval \u0026#34;$(jenv init -)\u0026#34; åŒæ­¥.zshrc 1 source ~/.zshrc æŸ¥çœ‹æœ¬æœºå®‰è£…äº†å“ªäº›jdk 1 /usr/libexec/java_home -V ç»“æœå¦‚ä¸‹ï¼š æ·»åŠ jdk 1 2 3 jenv add /Users/xiangcheng/Library/Java/JavaVirtualMachines/corretto-18.0.2/Contents/Home jenv add /Users/xiangcheng/Library/Java/JavaVirtualMachines/corretto-11.0.23/Contents/Home jenv add /Users/xiangcheng/Library/Java/JavaVirtualMachines/corretto-1.8.0_412/Contents/Home æŸ¥çœ‹jenvç®¡ç†çš„jdkç‰ˆæœ¬ 1 jenv versions ç»“æœå¦‚ä¸‹ï¼š åˆ‡æ¢å…¨å±€çš„jdkç‰ˆæœ¬ 1 jenv global 18 å½“å‰ shell åˆ‡æ¢ JDK 1 jenv shell 18 é¡¹ç›®ç›®å½•æŒ‡å®š JDK 1 2 cd ~/my_project jenv local 18 ","date":"2025-02-10T00:00:00Z","permalink":"https://example.com/p/%E4%BD%BF%E7%94%A8jenv%E7%AE%A1%E7%90%86%E5%A4%9A%E4%B8%AAjdk/","title":"ä½¿ç”¨jenvç®¡ç†å¤šä¸ªjdk"},{"content":"zshçš„æ’ä»¶åˆ†ä¸ºé¢„è£…çš„æ’ä»¶å’Œè‡ªå®šä¹‰çš„æ’ä»¶ï¼Œè‡ªå®šä¹‰æ’ä»¶åœ¨.oh-my-zsh/customæ–‡ä»¶å¤¹ä¸‹ï¼Œé¢„è£…çš„æ’ä»¶åœ¨pluginsæ–‡ä»¶å¤¹ä¸‹ï¼š æˆ‘æ˜¯è£…äº†4ä¸ªè‡ªå®šä¹‰æ’ä»¶ï¼Œå…³äºè‡ªå®šä¹‰æ’ä»¶çš„å®‰è£…å¯ä»¥åœ¨å¯¹åº”çš„æ’ä»¶ä»‹ç»ä¸­æ‰¾åˆ°\nsublimeæ’ä»¶ sublimeæ’ä»¶èƒ½å¿«é€Ÿæ‰“å¼€æŸä¸ªæ–‡ä»¶æˆ–æ–‡ä»¶ï¼Œå¹¶åœ¨sublimeåº”ç”¨ä¸­å±•ç¤ºã€‚å®ƒæ˜¯é¢„è£…çš„æ’ä»¶ï¼Œæ‰€ä»¥ä¸ç”¨å•ç‹¬å®‰è£… ä½¿ç”¨ï¼š\n1 2 st . # æ‰“å¼€å½“å‰ç›®å½• st myfile.txt # æ‰“å¼€ myfile.txt å‚è€ƒï¼š ohmyzsh zsh-autosuggestions zsh-completions zsh-syntax-highlighting\n","date":"2025-02-08T00:00:00Z","permalink":"https://example.com/p/oh-my-zsh%E6%8F%92%E4%BB%B6%E5%BF%85%E5%A4%87/","title":"oh-my-zshæ’ä»¶å¿…å¤‡"},{"content":"GradleåŸºç¡€ gradleæ˜¯ä¸€ä¸ªè„šæœ¬æ¡†æ¶ï¼Œç”¨æ¥æ„å»ºandroidç¨‹åºçš„ä¸€ä¸ªè„šæœ¬ï¼Œåœ¨è®¤è¯†å‰ï¼Œæˆ‘ä»¬å…ˆä»¥æœ€åŸºç¡€çš„æ–¹å¼æ¥è®¤è¯†å®ƒã€‚\ngradleé…ç½® é¦–å…ˆåœ¨å®˜ç½‘ä¸‹è½½å¯¹åº”çš„ç‰ˆæœ¬ï¼Œè¿™é‡Œæˆ‘é€‰æ‹©6.6.1-allçš„ç‰ˆæœ¬ï¼Œä¸‹è½½å®Œåï¼Œæ”¾åˆ°æŒ‡å®šçš„ç›®å½•ï¼Œç„¶åé…ç½®gradleçš„ç¯å¢ƒå˜é‡:\nopen -e .bash_profile æ‰“å¼€é…ç½®æ–‡ä»¶ æ·»åŠ  GRADLE_HOMEã€PATH 1 2 3 4 5 6 7 export GRADLE_HOME=/Users/xiangcheng/gradle/gradle-6.6.1 export PATH=${PATH}:/Users/xiangcheng/gradle/gradle-6.6.1/bin ----------------å®˜æ–¹å†™æ³•å¦‚ä¸‹-------------------------------- export GRADLE_HOME=/Users/xiangcheng/gradle/gradle-6.6.1 export PATH=$PATH:$GRADLE_HOME/bin source .bash_profile é‡ç½®é…ç½®æ–‡ä»¶ï¼Œä»¥ä¾¿æ–° path ç”Ÿæ•ˆ open -e ~/.zshrc æ‰“å¼€å¦ä¸€ä¸ªé…ç½® åœ¨æœ€åä¸€è¡Œæ·»åŠ  source ~/.bash_profile source ~/.zshrc é‡ç½®é…ç½®æ–‡ä»¶ é…ç½® zshrc æ˜¯å› ä¸ºæœ‰çš„æœºå™¨ bash_profile é…ç½®ä¸ç®¡ç”¨ï¼Œæ·»åŠ è¿™ä¸ªå°±è¡Œäº†\nè¿è¡Œ gradle \u0026ndash;versionï¼Œå‡ºç°ç‰ˆæœ¬å·åˆ™ Gradle é…ç½®æˆåŠŸ æ³¨æ„ï¼šgradleç‰ˆæœ¬å’Œjdkç‰ˆæœ¬éœ€è¦æœ‰å¯¹åº”å…³ç³»ï¼š è¿™é‡Œæˆ‘å®‰è£…çš„æ˜¯gradle-6.6.1çš„ç‰ˆæœ¬ï¼Œå› æ­¤æˆ‘éœ€è¦è®¾ç½®JDK8ï¼Œå¦‚æœæœ¬åœ°å®‰è£…çš„jdkç‰ˆæœ¬å¤šä¸ªçš„è¯ï¼Œmacä¼šä½¿ç”¨æœ€é«˜çš„ç‰ˆæœ¬ï¼Œå…ˆæŸ¥çœ‹æœ¬åœ°å®‰è£…äº†å“ªäº›jdkç‰ˆæœ¬ 1 /usr/libexec/java_home -V è¾“å‡ºå¦‚ä¸‹ï¼š\n1 2 3 4 Matching Java Virtual Machines (3): 18.0.2 (arm64) \u0026#34;Amazon.com Inc.\u0026#34; - \u0026#34;Amazon Corretto 18\u0026#34; /Users/xiangcheng/Library/Java/JavaVirtualMachines/corretto-18.0.2/Contents/Home 11.0.23 (arm64) \u0026#34;Amazon.com Inc.\u0026#34; - \u0026#34;Amazon Corretto 11\u0026#34; /Users/xiangcheng/Library/Java/JavaVirtualMachines/corretto-11.0.23/Contents/Home 1.8.0_412 (arm64) \u0026#34;Amazon\u0026#34; - \u0026#34;Amazon Corretto 8\u0026#34; /Users/xiangcheng/Library/Java/JavaVirtualMachines/corretto-1.8.0_412/Contents/Home æ‰€ä»¥é»˜è®¤ç”¨çš„æ˜¯jdk18ï¼Œæˆ‘éœ€è¦æ”¹ä¸‹ç¯å¢ƒå˜é‡ï¼Œå°†jdkæ”¹æˆ8ï¼š\n1 2 export JAVA_HOME=/Users/xiangcheng/Library/Java/JavaVirtualMachines/corretto-1.8.0_412/Contents/Home export PATH=$JAVA_HOME/bin:$PATH å†è¿è¡Œï¼š\n1 source ~/.bash_profile ä¸Šé¢çš„jdké…ç½®å¥½åï¼Œç„¶åæ‰¾ä¸ªæ–‡ä»¶å¤¹ï¼Œåˆ›å»ºbuild.gradleï¼Œç„¶åè¾“å…¥ï¼š\n1 println(\u0026#34;hello world!\u0026#34;) ç„¶åç”¨gradle build.gradleè¿è¡Œè¯¥æ–‡ä»¶ï¼Œè¾“å‡ºå¦‚ä¸‹ï¼š è¯´æ˜å·²ç»æˆåŠŸäº†ã€‚\ngradleåˆå§‹åŒ–å·¥ç¨‹ å¹³æ—¶éƒ½æ˜¯ç›´æ¥é€šè¿‡asåˆ›å»ºå·¥ç¨‹ï¼Œä¸‹é¢é€šè¿‡gradleæ¥åˆ›å»ºä¸€ä¸ªå·¥ç¨‹ï¼š\nè¾“å…¥gradle initæ¥åˆå§‹åŒ– æ¥ç€ä¼šè¾“å…¥ç›¸å…³é…ç½®ä¿¡æ¯ï¼š å‘½ä»¤è¡Œæç¤ºé€‰æ‹©é¡¹ç›®æ¨¡æ¿ å‘½ä»¤è¡Œæç¤ºé€‰æ‹©å¼€å‘è¯­è¨€ å‘½ä»¤è¡Œæç¤ºé€‰æ‹©è„šæœ¬è¯­è¨€ è¾“å…¥å·¥ç¨‹å è¾“å…¥åŒ…å æœ€ç»ˆå·¥ç¨‹åˆ›å»ºå¦‚ä¸‹ï¼š å’Œandroid studioåˆ›å»ºçš„å·¥ç¨‹ç»“æ„æ˜¯ä¸€è‡´çš„ã€‚ Gradle Wrapper asåˆ›å»ºä¸€ä¸ªå·¥ç¨‹çš„æ—¶å€™ï¼Œé»˜è®¤ä¼šæœ‰Gradle Wrapperæ–‡ä»¶å¤¹ï¼Œå®ƒé‡Œé¢ä¼šæœ‰ä¸ªwrapper.propertiesæ–‡ä»¶å¤¹ï¼Œé…ç½®äº†gradleç›¸å…³ä¿¡æ¯ã€‚ Gradle Wrapper æ–‡ä»¶çš„ä½œç”¨å°±æ˜¯å¯ä»¥è®©ä½ çš„ç”µè„‘åœ¨ä¸å®‰è£…é…ç½® Gradle ç¯å¢ƒçš„å‰æä¸‹è¿è¡Œ Gradle é¡¹ç›®ï¼Œä½ çš„æœºå™¨è¦æ˜¯æ²¡æœ‰é… Gradle ç¯å¢ƒï¼Œé‚£ä¹ˆä½  clone gradle é¡¹ç›®ä¸‹æ¥ï¼Œæ‰§è¡Œ init å‘½ä»¤ï¼Œä¼šæ ¹æ® gradle-wrapper.properties æ–‡ä»¶ä¸­å£°æ˜çš„ gradle URL è¿œç¨‹è·¯å¾„å»ä¸‹è½½ gradle æ„å»ºå·¥å…·ï¼Œcd è¿›è¯¥é¡¹ç›®ï¼Œæ‰§è¡Œäº†./gradlew -vï¼Œç„¶åä¸‹è½½äº†å¯¹åº”ç‰ˆæœ¬çš„gradleï¼Œå¦‚æœæ­¤æ—¶æ‰§è¡Œçš„æ˜¯gradle -vï¼Œå°±ç”¨çš„æ˜¯æœ¬åœ°é…ç½®çš„ç¯å¢ƒå˜é‡ä¸­çš„gradleç‰ˆæœ¬ï¼Œæ­¤æ—¶ä¸ä¼šå»ä¸‹è½½ã€‚ ç„¶åå°±å¯ä»¥åœ¨é¡¹ç›®ç›®å½•ä¸‹è¿è¡Œ gradle å‘½ä»¤äº†ï¼Œä¸è¿‡è¿˜æ˜¯æ¨èå¤§å®¶åœ¨æœºå™¨é…ç½®ç»Ÿä¸€çš„ Gradle ç¯å¢ƒ\ngradlew \u0026ndash;\u0026gt; linux å¹³å°è„šæœ¬ gradlew.bat \u0026ndash;\u0026gt; window å¹³å°è„šæœ¬ gradle-wrapper.jar \u0026ndash;\u0026gt; Gradle ä¸‹è½½ã€ç®¡ç†ç›¸å…³ä»£ç  gradle-wrapper.properties \u0026ndash;\u0026gt; Gradle ä¸‹è½½ã€ç®¡ç†é…ç½®å‚æ•° gradle-wrapper.properties æ–‡ä»¶ä¸­å‚æ•°è¯¦è§£ï¼š\ndistributionUrl \u0026ndash;\u0026gt; Gradle å‹ç¼©åŒ…ä¸‹è½½åœ°å€\nzipStoreBase \u0026ndash;\u0026gt; æœ¬æœºå­˜æ”¾ Gradle å‹ç¼©åŒ…ä¸»åœ°å€\nzipStorePath \u0026ndash;\u0026gt; æœ¬æœºå­˜æ”¾ Gradle å‹ç¼©åŒ…ä¸»è·¯å¾„\nGradle å‹ç¼©åŒ…å®Œæ•´çš„è·¯å¾„æ˜¯ zipStoreBase + zipStorePath distributionBase \u0026ndash;\u0026gt; æœ¬æœº Gradle å‹ç¼©åŒ…è§£å‹åä¸»åœ°å€\ndistributionPath \u0026ndash;\u0026gt; æœ¬æœº Gradle å‹ç¼©åŒ…è§£å‹åè·¯å¾„\nGradle è§£å‹å®Œæ•´çš„è·¯å¾„æ˜¯ distributionBase + distributionPath distributionBase çš„è·¯å¾„æ˜¯ç¯å¢ƒ path ä¸­ GRADLE_USER_HOME çš„åœ°å€ Windowsï¼šC:/ç”¨æˆ·/ä½ ç”µè„‘ç™»å½•çš„ç”¨æˆ·å/.gradle/ MACï¼šï½/.gradle/ ä½  MAC è¦æ˜¯é…äº† Gradle ç¯å¢ƒå˜é‡ï¼ŒdistributionBase å°±æ˜¯ä½ è‡ªå·±è§£å‹ç¼©çš„ gradle è·¯å¾„ è¿™å‡ ä¸ªåœ°å€è¿˜æ˜¯è¦ææ¸…æ¥šçš„~\nå…³äºaså¦‚æœé…ç½®ç»Ÿä¸€çš„gradleç‰ˆæœ¬ï¼Œå¯ä»¥çœ‹å¦‚ä¸‹æˆªå›¾ï¼š gradle-wrapper.properties \u0026ndash; ä½¿ç”¨ wrapper ä¹Ÿå°±æ˜¯ AS æ¥ç®¡ç† Gradle Specifiled location \u0026ndash; ä½¿ç”¨æœ¬åœ°æ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬è‡ªå·±ç®¡ç† Gradleï¼Œè¿™æ ·æ¯ä¸ªå·¥ç¨‹çš„gradle-wrapper.propertieså°±ä¸èµ·ä½œç”¨äº†ï¼Œä½¿ç”¨æœ¬æœºé…ç½®çš„gradleç‰ˆæœ¬ gradlwå’ŒgradleåŒºåˆ« gradlewå®é™…æ˜¯ä¸€ä¸ªè„šæœ¬æ–‡ä»¶ï¼Œå®ƒæ˜¯åœ¨gradleå·¥ç¨‹çš„æ ¹ç›®å½•ä¸‹é¢ï¼Œå¦‚æœæ˜¯windowsçš„è¯ï¼Œä¼šæ‰§è¡Œgradlew.batæ–‡ä»¶ï¼Œè¿™ä¸ªåœ¨å‰é¢é€šè¿‡å‘½ä»¤åˆå§‹åŒ–å·¥ç¨‹çš„æ—¶å€™å¯ä»¥çœ‹åˆ°ï¼Œå…¶ä¸­gradlewè„šæœ¬ä¼šé€šè¿‡gradle/wrapper/gradle-wrapper.jaræ¥ä½¿ç”¨é¡¹ç›®ä¸­é…ç½®çš„gradleç‰ˆæœ¬ï¼Œè€Œgradleå‘½ä»¤æ˜¯ä½¿ç”¨æœ¬æœºé…ç½®çš„gradleç‰ˆæœ¬ã€‚\nGradleä¸­task taskå¯ä»¥è®¤ä¸ºæ˜¯gradleä¸­æœ€å°æ‰§è¡Œå•å…ƒï¼Œæ­£æ˜¯å› ä¸ºæœ‰äº†taskï¼Œgradleæ¡†æ¶æ‰èƒ½æœ‰åºçš„å·¥ä½œã€‚å®é™…ä¸Šæ ¹æ® Gradle æ„å»ºé¡¹ç›®çš„æµç¨‹ï¼Œæ˜¯å…ˆæŠŠæ‰€æœ‰çš„ .gradle è„šæœ¬æ‰§è¡Œä¸€éï¼Œç¼–è¯‘ç”Ÿæˆå¯¹åº”çš„ Gradleã€Settingã€Project å¯¹è±¡ï¼Œç„¶åæ ¹æ®æˆ‘ä»¬åœ¨æ„å»ºè„šæœ¬ä¸­è®¾ç½®çš„æ„å»ºé…ç½®ï¼Œç”Ÿæˆä¸€å¼  Task ç»„æˆçš„ï¼šæœ‰å‘æ— ç¯å›¾ï¼Œå…ˆæ¥çœ‹çœ‹è¿™å¼ å›¾: å·¦è¾¹è¡¨ç¤ºçš„æ˜¯taskä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œå³è¾¹è¡¨ç¤ºçš„æ˜¯é¡¹ç›®æ„å»ºè¿‡ç¨‹ä¸­è¦ç»è¿‡çš„ä»»åŠ¡ï¼Œæ­£æ˜¯å› ä¸ºæœ‰äº†è¿™äº›ä»»åŠ¡ï¼Œé¡¹ç›®æ‰èƒ½æ„å»ºå‡ºæ¥ã€‚\nå®é™…ä¸Šåœ¨gradleæ„å»ºè¿‡ç¨‹ä¸­ï¼Œä¼šæŠŠæ¯ä¸€ä¸ªå·¥ç¨‹çš„build.gradleæ–‡ä»¶ä¼šæ„å»ºæˆä¸€ä¸ªprojectå¯¹è±¡ï¼Œè€Œè¯¥projectå¯¹è±¡ç”±ä¸€ä¸ªä¸ªçš„taskç»„æˆï¼Œæ¯”å¦‚åœ¨æ„å»ºandroidé¡¹ç›®çš„æ—¶å€™ä¼šæœ‰ç¼–è¯‘javaä»£ç çš„taskï¼Œç¼–è¯‘èµ„æºçš„taskç­‰ã€‚è¿™äº›taskå…¶å®æ˜¯å®šä¹‰åœ¨androidæ’ä»¶ä¸­ï¼Œå…³äºæ’ä»¶åé¢å†è¯´ã€‚\næ¯”å¦‚androidå·¥ç¨‹ä¸­æœ‰å¾ˆå¤šæˆ‘ä»¬ç†Ÿæ‚‰çš„taskï¼š å¯ä»¥çœ‹åˆ°åœ¨buildè¿™ä¸ªåˆ†ç»„ä¸‹é¢æœ‰å¾ˆå¤šç†Ÿæ‚‰çš„taskï¼Œæ¯”å¦‚æœ‰assembleçš„taskï¼Œå®ƒæ˜¯ç”¨æ¥æ‰“åŒ…çš„taskã€‚è€Œå®ƒä»¬åˆä¾èµ–å…¶å®ƒçš„taskï¼Œæœ€ç»ˆä¸€ä¸ªä¸ªçš„taskè¢«æ‰§è¡Œå®Œï¼ŒåŒ…ä¹Ÿæ‰“å‡ºæ¥äº†ã€‚ æ¯”å¦‚æˆ‘åœ¨ç»ˆç«¯ä¸Šè¿è¡Œ./gradlew buildçš„æ—¶å€™ï¼Œä¼šæ‰§è¡Œä¸€å¤§å †çš„taskï¼š Task æ˜¯å®Œæˆä¸€ç±»ä»»åŠ¡ï¼Œå®é™…ä¸Šå¯¹åº”çš„ä¹Ÿæ˜¯ä¸€ä¸ªå¯¹è±¡ã€‚è€Œ Task æ˜¯ç”±æ— æ•°ä¸ª Action ç»„æˆçš„ï¼ŒAction ä»£è¡¨çš„æ˜¯ä¸€ä¸ªä¸ªå‡½æ•°ã€æ–¹æ³•ï¼Œæ¯ä¸ª Task éƒ½æ˜¯ä¸€å † Action æŒ‰åºç»„æˆçš„æ‰§è¡Œå›¾ï¼Œå°±å¥½åƒæˆ‘ä»¬åœ¨ Class çš„ main å‡½æ•°ä¸­æŒ‰ç…§é€»è¾‘è°ƒç”¨ä¸€ç³»åˆ—æ–¹æ³•ä¸€æ ·ã€‚\nåˆ›å»ºtask 1 2 3 4 5 6 7 8 9 10 11 task hello{ println \u0026#34;hello world\u0026#34; } task(hello2){ println \u0026#34;hello world2\u0026#34; } task (\u0026#39;hello3\u0026#39;){ println \u0026#34;hello world3\u0026#34; } è¿è¡Œtask é€šè¿‡./gradlew taskåæ¥è¿è¡Œtaskï¼Œè¿è¡Œç»“æœå¦‚ä¸‹ï¼š å¦‚æœæ˜¯å­æ¨¡å—çš„è¯ï¼Œåˆ™é€šè¿‡./gradlew æ¨¡å—å:taskåè¿è¡Œtaskï¼Œè¿è¡Œç»“æœå¦‚ä¸‹ï¼š è¿™æ˜¯åœ¨å·¥ç¨‹çš„æ ¹ç›®å½•ä¸‹build.gradleå®šä¹‰çš„ä¸‰ä¸ªtaskï¼Œç„¶åé€šè¿‡./gradlew helloå‘½ä»¤æ¥æ‰§è¡Œhelloè¿™ä¸ªtaskï¼Œè€Œå…¶å®ƒä¸¤ä¸ªtaskä¹Ÿè¾“å‡ºæ—¥å¿—ï¼Œæ˜¯å› ä¸ºè¿™å‡ æ¡æ—¥å¿—éƒ½æ˜¯åœ¨é…ç½®é˜¶æ®µè¾“å‡ºï¼Œå…³äºgradleçš„ç”Ÿå‘½å‘¨æœŸåé¢ä¼šè¯´ã€‚é‚£ä¸ºä»€ä¹ˆgradlewæ‰§è¡Œè„šæœ¬å°±åœ¨æ ¹ç›®å½•ä¸‹ï¼Œè¿˜éœ€è¦./æ¥æ‰§è¡Œè¯¥è„šæœ¬å‘¢ï¼Ÿ è¿™æ˜¯å› ä¸ºåœ¨ç»ˆç«¯é‡Œé¢ï¼Œéœ€è¦é€šè¿‡./æ¥è·å–å½“å‰ç›®å½•ï¼Œå¦‚æœä¸åŠ çš„è¯ï¼Œä¼šå¯¼è‡´ç»ˆç«¯åœ¨ç›®å½•ä¸‹æ‰¾ä¸åˆ°ã€‚\nå…¶å®taskæ˜¯projectçš„æ–¹æ³•ï¼Œprojectè¡¨ç¤ºçš„æ˜¯æ¨¡å—åœ¨åˆå§‹åŒ–é˜¶æ®µä¼šç”Ÿæˆï¼Œä¸Šé¢ä½¿ç”¨task hello{}ï¼Œåˆ›å»ºçš„taskå®é™…æ˜¯ä¼ å…¥äº†actionçš„é—­åŒ…ï¼Œå®ƒæ˜¯åœ¨æ„å»ºçš„æ—¶å€™è¢«è°ƒç”¨çš„ï¼š åœ¨åˆ›å»ºtaskçš„æ—¶å€™å¯ä»¥æŒ‡å®šå…¶ä»–å±æ€§ï¼Œå¯ä»¥é€šè¿‡taskå…¶ä»–çš„é‡è½½æ–¹æ³•æ¥åˆ›å»ºï¼š\n1 2 3 task demo1(group: \u0026#34;demoç»„\u0026#34;,name:\u0026#34;demo2\u0026#34;,description:\u0026#34;æˆ‘æ˜¯demo2çš„task\u0026#34;,action:{ println(\u0026#34;æˆ‘æ˜¯demo2 taskçš„action\u0026#34;) }) æ¯”å¦‚åœ¨æ„å»ºdemo1çš„æ—¶å€™ï¼Œç”³æ˜äº†å…¶å®ƒå±æ€§ï¼Œæ­¤å¤„çš„actionè·Ÿä¸Šé¢å†™åœ¨æ‹¬å·å¤–é¢æ˜¯ä¸€å›äº‹ï¼Œåªä¸è¿‡æ­¤å¤„æ˜¯é€šè¿‡mapæ¥åˆ›å»ºçš„ï¼Œè¿˜æœ‰ä¸€ç‚¹ï¼Œmapä¸­æŒ‡å®šçš„nameä¸ä¼šç”Ÿæ•ˆï¼Œä¼šè¢«demo1çš„åå­—ç»™è¦†ç›–äº†ï¼Œç›®å‰å‘ç°æ²¡ä»€ä¹ˆä½œç”¨ï¼Œæ‰§è¡Œç»“æœå¦‚ä¸‹ï¼š task.dofirstå’Œdolast doFirstæ˜¯taskæ‰§è¡Œå‰è¦è°ƒç”¨çš„actionï¼ŒdoLastæ˜¯taskæ‰§è¡Œåè¦è°ƒç”¨çš„actionï¼š\n1 2 3 4 5 6 7 8 9 task demo2{ println(\u0026#34;demo2\u0026#34;) doFirst{ println(\u0026#34;demo2 çš„ doFirst\u0026#34;) } doLast{ println(\u0026#34;demo2 çš„ doLast\u0026#34;) } } å…³äºtaskå…¶å®ƒçš„ä½¿ç”¨å¯ä»¥åœ¨çœ‹ä¸‰æ–¹æ’ä»¶çš„æ—¶å€™å†çœ‹ã€‚\nGradleæ’ä»¶ gradleæ’ä»¶ï¼ˆpluginï¼‰æ˜¯æ„å»ºé¡¹ç›®æ—¶å€™ç”¨åˆ°çš„ï¼Œå®ƒå…¶å®æ˜¯ç”±ä¸€ç³»åˆ—çš„taskç»„æˆçš„ï¼Œå…¶å®androidçš„å·¥ç¨‹ï¼Œgoogleå·²ç»å¸®æˆ‘ä»¬å®ç°äº†android gradle pluginï¼ˆagpï¼‰ã€‚googleä¹Ÿæ˜¯éµå¾ªäº†gradleçš„taskä¾èµ–æ³•åˆ™ï¼Œæ„æˆä¸€ä¸ªæœ‰åºæ— å‘å›¾ã€‚æœ€ç»ˆå»æ‰§è¡Œä¸€ä¸ªä¸ªçš„takã€‚\næ’ä»¶ä¸»è¦é€šè¿‡å®šä¹‰ä»“åº“ï¼Œç„¶åå®šä¹‰æ’ä»¶çš„åå­—ï¼Œæ¯”å¦‚å®‰å“ä¸­ä¾èµ–agpæ˜¯é€šè¿‡å¦‚ä¸‹çš„æ–¹å¼ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 buildscript { repositories { google() jcenter() } dependencies { classpath \u0026#39;com.android.tools.build:gradle:3.5.3\u0026#39; // NOTE: Do not place your application dependencies here; they belong // in the individual module build.gradle files } } allprojects { repositories { google() jcenter() } } buildscriptæ˜¯rootProjectçš„æ–¹æ³•ï¼Œå®ƒå£°æ˜æ’ä»¶çš„ä»“åº“ã€æ·»åŠ æ’ä»¶ä¸“ç”¨é—­åŒ… allprojectsä¸»è¦æ˜¯æŒ‡æ‰€æœ‰çš„æ¨¡å—éœ€è¦çš„ä¸‰æ–¹ä¾èµ–åº“æ—¶å€™çš„ä»“åº“ åƒä¸Šé¢å®šäº†agpæ’ä»¶3.5.3ï¼Œç„¶ååœ¨appæ¨¡å—ä¸­é€šè¿‡apply plugin: 'com.android.application'æ¥ä½¿ç”¨è¿™ä¸ªæ’ä»¶ï¼Œè€Œappæ¨¡å—é€‰çš„android{}å°±æ˜¯æ¥è‡ªäºè¯¥æ’ä»¶ï¼Œæˆ‘ä»¬å«ä»–æ˜¯DSLé…ç½®å—ã€‚ å…¶å®åƒandroid{}çš„å®ç°åœ¨æ’ä»¶ä¸­æ˜¯é€šè¿‡delegate+é—­åŒ…å®ç° DSL é…ç½®å—\né¦–å…ˆæŠŠé—­åŒ…å®šä¹‰å¥½ï¼š 1 2 3 4 5 6 7 8 9 10 11 12 def android = { compileSdkVersion 25 buildToolsVersion \u0026#34;25.0.2\u0026#34; // è¿™ä¸ªå¯¹åº”ç›¸åº”çš„æ–¹æ³• defaultConfig { minSdkVersion 15 targetSdkVersion 25 versionCode 1 versionName \u0026#34;1.0\u0026#34; } } å®šä¹‰æ•°æ®æ¨¡å‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 class Android { int mCompileSdkVersion String mBuildToolsVersion BefaultConfig mBefaultConfig Android() { this.mBefaultConfig = new BefaultConfig() } void defaultConfig(Closure closure) { closure.setDelegate(mProductFlavor) closure.setResolveStrategy(Closure.DELEGATE_FIRST) closure.call() } } class BefaultConfig { int mVersionCode String mVersionName int mMinSdkVersion int mTargetSdkVersion } ç»‘å®šæ•°æ® 1 2 3 Android bean = new Android() android.delegate = bean//å°†ä¸Šé¢å®šä¹‰å¥½çš„beanç»™è®¾ç½®åˆ°é—­åŒ…é‡Œé¢ android.call()//é—­åŒ…çš„è°ƒç”¨ Gradleæ„å»ºè¿‡ç¨‹ å…¶å®æ„å»ºè¿‡ç¨‹å°±æ˜¯æŒ‡ç¼–è¯‘å¯¹åº”çš„.gradleæ–‡ä»¶ï¼Œç„¶åç”Ÿæˆå¯¹è±¡ï¼Œæœ€åæ‰§è¡Œtaskã€‚ ä¸»è¦åˆ†ä¸ºä¸‰ä¸ªæ­¥éª¤ï¼š\nInitializationï¼šåˆå§‹åŒ–é˜¶æ®µï¼ŒæŒ‰é¡ºåºæ‰§è¡Œinit.gradleï¼Œsetting.gradleï¼Œç”ŸæˆGradleã€Settingã€Projectå¯¹è±¡ Configurationï¼šé…ç½®é˜¶æ®µï¼ŒæŒ‰é¡ºåºæ‰§è¡Œ root build.gradle -\u0026gt; å­é¡¹ç›® build.gradle è„šæœ¬ï¼Œç”Ÿæˆ Task æ‰§è¡Œæµç¨‹å›¾ Executionï¼šæ‰§è¡Œé˜¶æ®µï¼ŒæŒ‰ç…§ Task æ‰§è¡Œå›¾é¡ºåºè¿è¡Œæ¯ä¸€ä¸ª Taskï¼Œå®Œæˆä¸€ä¸ªä¸ªæ­¥å¥ï¼Œç”Ÿæˆæœ€ç»ˆ APK æ–‡ä»¶ æ•´ä¸ªæµç¨‹å¦‚ä¸‹ï¼š é€šè¿‡æµç¨‹å›¾è§‚å¯Ÿï¼Œæˆ‘ä»¬å¯ä»¥åœ¨åˆé€‚çš„æ—¶æœºç›‘å¬gradleçš„æ„å»ºè¿‡ç¨‹ï¼Œä¹Ÿå°±æ˜¯é’©å­æ–¹æ³•ã€‚ ä¸‹é¢é€šè¿‡è¿™äº›é’©å­æ–¹æ³•æ¥è·å–é¡¹ç›®æ„å»ºå„ä¸ªé˜¶æ®µã€ä»»åŠ¡çš„è€—æ—¶æƒ…å†µï¼Œåœ¨setting.gradleä¸­æ·»åŠ å¦‚ä¸‹ä»£ç ï¼š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 long beginOfSetting = System.currentTimeMillis() def beginOfConfig def configHasBegin = false def beginOfProjectConfig = new HashMap() def beginOfProjectExcute gradle.projectsLoaded { println \u0026#39;åˆå§‹åŒ–é˜¶æ®µï¼Œè€—æ—¶ï¼š\u0026#39; + (System.currentTimeMillis() - beginOfSetting) + \u0026#39;ms\u0026#39; } gradle.beforeProject { project -\u0026gt; if (!configHasBegin) { configHasBegin = true beginOfConfig = System.currentTimeMillis() } beginOfProjectConfig.put(project, System.currentTimeMillis()) } gradle.afterProject { project -\u0026gt; def begin = beginOfProjectConfig.get(project) println \u0026#39;é…ç½®é˜¶æ®µï¼Œ\u0026#39; + project + \u0026#39;è€—æ—¶ï¼š\u0026#39; + (System.currentTimeMillis() - begin) + \u0026#39;ms\u0026#39; } gradle.taskGraph.whenReady { println \u0026#39;é…ç½®é˜¶æ®µï¼Œæ€»å…±è€—æ—¶ï¼š\u0026#39; + (System.currentTimeMillis() - beginOfConfig) + \u0026#39;ms\u0026#39; beginOfProjectExcute = System.currentTimeMillis() } gradle.taskGraph.beforeTask { task -\u0026gt; task.doFirst { task.ext.beginOfTask = System.currentTimeMillis() } task.doLast { println \u0026#39;æ‰§è¡Œé˜¶æ®µï¼Œ\u0026#39; + task + \u0026#39;è€—æ—¶ï¼š\u0026#39; + (System.currentTimeMillis() - task.beginOfTask) + \u0026#39;ms\u0026#39; } } gradle.buildFinished { println \u0026#39;æ‰§è¡Œé˜¶æ®µï¼Œè€—æ—¶ï¼š\u0026#39; + (System.currentTimeMillis() - beginOfProjectExcute) + \u0026#39;ms\u0026#39; } ç”±äºåœ¨setting.gradleæ‰§è¡Œå‰ï¼ŒGradleå¯¹è±¡å…¶å®å·²ç»ç”Ÿæˆï¼Œæ‰€ä»¥é€šè¿‡gradleå¯¹è±¡çš„projectsLoadedå›è°ƒè·å–åˆå§‹åŒ–æ—¶é—´ã€‚ç¬¬ä¸€æ¬¡è¿›å…¥åˆ°beforeProjectçš„æ—¶å€™è®°å½•é…ç½®çš„èµ·å§‹æ—¶é—´ï¼Œå¹¶è®°å½•æ¯ä¸€ä¸ªprojectçš„é…ç½®èµ·å§‹æ—¶é—´ï¼Œç„¶ååœ¨afterProjectä¸­ç®—å‡ºæ¯ä¸€ä¸ªprojecté…ç½®çš„æ—¶é—´ã€‚ç„¶åé€šè¿‡gradle.taskGraphæ¥è·å–æœ‰åºæ— å‘å›¾ï¼Œç„¶åé€šè¿‡whenReadyæ–¹æ³•å›è°ƒç®—å‡ºæ€»çš„é…ç½®æ—¶é—´ã€‚æœ€åé€šè¿‡æœ‰åºæ— å‘å›¾çš„beforeTaskæ¥æ·»åŠ taskçš„å¼€å§‹å’Œç»“æŸçš„æ‰§è¡Œæ—¶é—´æ¥ç®—å‡ºtaskçš„æ‰§è¡Œè€—æ—¶ã€‚æœ€åé€šè¿‡gradleçš„buildFinishæ¥è·å–æ€»å…±çš„æ„å»ºæ—¶é—´ã€‚\ngradleæ‰“åŒ…é€Ÿåº¦ä¼˜åŒ– é¦–å…ˆäº†è§£ä¸‹å®‰å“ä¸­çš„variantæ˜¯ä»€ä¹ˆæ„æ€ï¼Œå®ƒè¡¨ç¤ºä¸€ä¸ªåŒ…çš„å˜ä½“ï¼Œå…¶ä¸­å˜ä½“æ˜¯ç”±productFlavorï¼ˆäº§å“é£å‘³ï¼‰å’ŒbuildTypeï¼ˆæ„å»ºç±»å‹ï¼‰ç»„åˆè€Œæˆçš„ã€‚å…¶ä¸­productFlavoræ˜¯ç”±ç»´åº¦å’Œæ¸ é“æ„æˆçš„ï¼ŒbuildTypeæŒ‡çš„æ˜¯debugè¿˜æ˜¯releaseï¼Œæ¯”å¦‚ç»´åº¦å¯ä»¥é…ç½®ä»·æ ¼å’Œæ¸ é“çš„ä¸¤ä¸ªç»´åº¦ï¼Œè€Œæ¸ é“å¯ä»¥é…ç½®googleã€xiaomiç­‰æ¸ é“ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 android { // å®šä¹‰ buildTypesï¼ˆæ„å»ºç±»å‹ï¼‰ buildTypes { debug { minifyEnabled false applicationIdSuffix \u0026#34;.debug\u0026#34; } release { minifyEnabled true proguardFiles getDefaultProguardFile(\u0026#39;proguard-android-optimize.txt\u0026#39;), \u0026#39;proguard-rules.pro\u0026#39; } } // å®šä¹‰ productFlavorsï¼ˆäº§å“é£å‘³ï¼‰ flavorDimensions \u0026#39;channel\u0026#39;, \u0026#39;pricing\u0026#39; productFlavors { //é…ç½®æ¸ é“ç»´åº¦ä¸‹ä¸¤ä¸ªå˜ä½“ google { dimension \u0026#39;channel\u0026#39; } xiaomi { dimension \u0026#39;channel\u0026#39; } //é…ç½®ä»·æ ¼ä¸‹ä¸¤ä¸ªå˜ä½“ free { dimension \u0026#39;pricing\u0026#39; } vip { dimension \u0026#39;pricing\u0026#39; } } // åœ¨è¿™é‡Œçš„ `productFlavors` å’Œ `buildTypes` ç»„åˆå½¢æˆä¸åŒçš„ variants } æ‰€ä»¥ä¸Šé¢é€šè¿‡ç»´åº¦å’Œæ¸ é“ç»„åˆåçš„productFlavoræœ‰googleFreeã€googleVipã€xiaomiFreeã€xiaomiVipå››ä¸ªï¼Œå†å’ŒbuildTypeç»„åˆåï¼Œå°±æ˜¯8ä¸ªå˜ä½“ï¼Œåˆ†åˆ«æ˜¯ï¼š\ngoogleFreeDebug googleFreeRelease googleVipDebug googleVipRelease xiaomiFreeDebug xiaomiFreeRelease xiaomiVipDebug xiaomiVipRelease çŸ¥é“äº†variantåï¼Œä¸‹é¢å°±æ˜¯äº†è§£ä¸‹æ‰“åŒ…äº†ï¼Œä¸€èˆ¬é€šè¿‡build AnalyzeæŸ¥çœ‹buildè¿‡ç¨‹ä¸­çš„ä¸€äº›è­¦å‘Šï¼Œä½¿ç”¨è¯¥å·¥å…·éœ€è¦å…ˆè¿›è¡Œbuildï¼Œç¬¬äºŒä¸ªå·¥å…·æ˜¯gradle profileå·¥å…·ï¼Œä¸€èˆ¬é€šè¿‡å¦‚ä¸‹å‘½ä»¤ï¼š\n1 2 ./gradlew installGoogleFreeDebug --build-cache -x lint -x test --warning-mode=none -Pkotlin.compiler.execution.strategy=in-process -PcompilerArgs=-Xlint:deprecation --no-configuration-cache --profile adb shell am start -n åŒ…å/åº”ç”¨ä¸»å…¥å£ å¦‚æœé€šè¿‡adbå‘½ä»¤å¯åŠ¨ä¸»å…¥å£çš„è¯ï¼Œéœ€è¦åœ¨æ¸…å•æ–‡ä»¶ä¸­ç»™ä¸»å…¥å£åŠ ä¸Šandroid:exported=\u0026quot;true\u0026quot;å±æ€§ï¼Œè£…åŒ…å®Œäº†åï¼Œæœ¬åœ°ä¼šç”Ÿæˆä¸€ä¸ªhtmlæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶ä¼šæœ‰gradleæ¯ä¸ªé˜¶æ®µçš„è€—æ—¶æƒ…å†µï¼Œå¹¶ä¸”ä¼šæœ‰æ¯ä¸ªtaskçš„è€—æ—¶ã€‚\nå†ä¸ªå°±æ˜¯gradle scanå·¥å…·ï¼Œä¸€èˆ¬é€šè¿‡å¦‚ä¸‹å‘½ä»¤ï¼š\n1 2 ./gradlew installGoogleFreeDebug --build-cache -x lint -x test --warning-mode=none -Pkotlin.compiler.execution.strategy=in-process -PcompilerArgs=-Xlint:deprecation --no-configuration-cache --scan adb shell am start -n åŒ…å/åº”ç”¨ä¸»å…¥å£ scanä¼šç”Ÿæˆä¸€ä¸ªåœ¨çº¿çš„ç½‘é¡µï¼Œç¬¬ä¸€æ¬¡ä½¿ç”¨éœ€è¦é‚®ç®±æ ¡éªŒï¼Œå®ƒçš„ä¿¡æ¯æ¯”profileæ›´å…¨é¢ï¼Œæ›´åŠ æ™ºèƒ½ï¼Œå…¶ä¸­performanceè·Ÿprofileä¸­æ•ˆæœå·®ä¸å¤šï¼Œå®ƒå¤šäº†timelineé€‰é¡¹ï¼Œè¡¨ç¤ºä»€ä¹ˆæ—¶å€™æ‰§è¡Œäº†ä»€ä¹ˆtaskï¼Œswitchsé€‰é¡¹è¡¨ç¤ºä¸€äº›å»ºè®®ï¼Œæ¯”å¦‚ç¼“å­˜æ²¡å¼€ï¼Œä¼šæç¤ºoffã€‚ å…¶å®gradleä¼˜åŒ–æœ€ç›´æ¥æ˜¯é€šè¿‡ç»„ä»¶åŒ–æ¥å¼€å‘ï¼Œå¦‚æœå…¨appç¼–è¯‘çš„è¯ï¼Œç»„ä»¶è¶Šå¤šï¼Œéœ€è¦çš„æ—¶é—´è¶Šé•¿ï¼Œæ‰€ä»¥é€šè¿‡ç»„ä»¶åŒ–æ¥é™ä½æ‰“åŒ…æ—¶é—´æ˜¯æœ€ç›´æ¥çš„ï¼ŒæŠŠä¸€äº›å…¶ä»–ä¾èµ–çš„ç»„ä»¶é€šè¿‡aarè¿›è¡Œä¾èµ–æˆ–è¿œç¨‹ä¾èµ–ã€‚ å‚è€ƒï¼š Gradle çˆ¬å‘æŒ‡å— \u0026ndash; æ¦‚å¿µåˆè§£ã€Grovvy è¯­æ³•ã€å¸¸è§ API Gradle çˆ¬å‘æŒ‡å— \u0026ndash; ç†è§£ Pluginã€Taskã€æ„å»ºæµç¨‹ æ·±åº¦æ¢ç´¢ Gradle è‡ªåŠ¨åŒ–æ„å»ºæŠ€æœ¯ï¼ˆä¸‰ã€Gradle æ ¸å¿ƒè§£å¯†ï¼‰\n","date":"2025-02-07T00:00:00Z","permalink":"https://example.com/p/gradle%E5%BF%85%E5%A4%87/","title":"Gradleå¿…å¤‡"},{"content":"Recyclerviewç³»åˆ— ç¼“å­˜ç›¸å…³ RecyclerView ç¼“å­˜æœºåˆ¶ | å¦‚ä½•å¤ç”¨è¡¨é¡¹ï¼Ÿ RecyclerView ç¼“å­˜æœºåˆ¶ | å›æ”¶äº›ä»€ä¹ˆï¼Ÿ RecyclerView ç¼“å­˜æœºåˆ¶ | å›æ”¶åˆ°å“ªå»ï¼Ÿ RecyclerViewç¼“å­˜æœºåˆ¶ | scrap view çš„ç”Ÿå‘½å‘¨æœŸ RecyclerView é¢è¯•é¢˜ | æ»šåŠ¨æ—¶è¡¨é¡¹æ˜¯å¦‚ä½•è¢«å¡«å……æˆ–å›æ”¶çš„ï¼Ÿ RecyclerView é¢è¯•é¢˜ | å“ªäº›æƒ…å†µä¸‹è¡¨é¡¹ä¼šè¢«å›æ”¶åˆ°ç¼“å­˜æ± ï¼Ÿ RecyclerView åˆ·æ–°åˆ—è¡¨æ•°æ®çš„ notifyDataSetChanged() ä¸ºä»€ä¹ˆæ˜¯æ˜‚è´µçš„? æŒæ¡è¿™17å¼ å›¾ï¼Œæ²¡äººæ¯”ä½ æ›´æ‡‚RecyclerViewçš„é¢„åŠ è½½ ã€åŠ¨ç”»å›¾è§£ã€‘è¿™ä¸ªå€¼å–å¯¹äº†ï¼ŒViewPager2æ‰èƒ½çºµäº«ä¸æ»‘ åŠ¨ç”»ç›¸å…³ RecyclerView åŠ¨ç”»åŸç† | æ¢ä¸ªå§¿åŠ¿çœ‹æºç ï¼ˆpre-layoutï¼‰ RecyclerView åŠ¨ç”»åŸç† | pre-layoutï¼Œpost-layout ä¸ scrap ç¼“å­˜çš„å…³ç³»ï¼‰ RecyclerView åŠ¨ç”»åŸç† | å¦‚ä½•å­˜å‚¨å¹¶åº”ç”¨åŠ¨ç”»å±æ€§å€¼ï¼Ÿï¼‰ ä¼˜åŒ–ç›¸å…³ æµ…è°ˆRecyclerViewçš„æ€§èƒ½ä¼˜åŒ– RecyclerView æ€§èƒ½ä¼˜åŒ– | æŠŠåŠ è½½è¡¨é¡¹è€—æ—¶å‡åŠ (ä¸€) RecyclerViewæ€§èƒ½ä¼˜åŒ–ä¹‹å¼‚æ­¥é¢„åŠ è½½ Kotlinç³»åˆ— Kotlinä¸­çš„åç¨‹ã€ä¸Šä¸‹æ–‡å’Œä½œç”¨åŸŸ æŠ½ä¸å‰¥èŒ§èŠåç¨‹ä¹‹æ·±å…¥ç†è§£ContinuationåŸç† Kotlin æºç é‡Œæˆå¨çš„ noinline å’Œ crossinline æ˜¯å¹²å˜›çš„ï¼Ÿçœ‹å®Œè¿™ä¸ªè§†é¢‘ä½ è½¬å¤´ä¹Ÿå†™äº†ä¸€å¨ æŠ½ä¸å‰¥èŒ§èŠKotlinåç¨‹ä¹‹åç¨‹å¼‚å¸¸å¤„ç†æœºåˆ¶åˆ†æ kotlinçš„æ³›å‹ SurfaceFlingerç³»åˆ— Androidåº”ç”¨ç¨‹åºä¸SurfaceFlingeræœåŠ¡çš„å…³ç³»æ¦‚è¿°å’Œå­¦ä¹ è®¡åˆ’ Androidç³»ç»ŸSurfaceæœºåˆ¶çš„SurfaceFlingeræœåŠ¡ç®€è¦ä»‹ç»å’Œå­¦ä¹ è®¡åˆ’ Activityç³»åˆ— Androidåº”ç”¨ç¨‹åºçª—å£ï¼ˆActivityï¼‰å®ç°æ¡†æ¶ç®€è¦ä»‹ç»å’Œå­¦ä¹ è®¡åˆ’ WMSç³»åˆ— Androidçª—å£ç®¡ç†æœåŠ¡WindowManagerServiceçš„ç®€è¦ä»‹ç»å’Œå­¦ä¹ è®¡åˆ’ èµ„æºæ‰“åŒ…ç³»åˆ— Androidåº”ç”¨ç¨‹åºèµ„æºçš„ç¼–è¯‘å’Œæ‰“åŒ…è¿‡ç¨‹åˆ†æ Androidåº”ç”¨ç¨‹åºèµ„æºçš„æŸ¥æ‰¾è¿‡ç¨‹åˆ†æ Android Apk ç¼–è¯‘æ‰“åŒ…æµç¨‹ï¼Œäº†è§£ä¸€ä¸‹~ AssetManagerç³»åˆ— Androidèµ„æºç®¡ç†æ¡†æ¶ï¼ˆAsset Managerï¼‰ç®€è¦ä»‹ç»å’Œå­¦ä¹ è®¡åˆ’ ç¡¬ä»¶åŠ é€Ÿç³»åˆ— Androidåº”ç”¨ç¨‹åºUIç¡¬ä»¶åŠ é€Ÿæ¸²æŸ“æŠ€æœ¯ç®€è¦ä»‹ç»å’Œå­¦ä¹ è®¡åˆ’ ASMç›¸å…³ Android è¿›é˜¶ä¹‹è·¯ï¼šASM ä¿®æ”¹å­—èŠ‚ç ï¼Œè¿™æ ·å­¦å°±å¯¹äº†ï¼ Gradleç›¸å…³ Gradle çˆ¬å‘æŒ‡å— \u0026ndash; å¯¼è®º Gradle çˆ¬å‘æŒ‡å— \u0026ndash; æ¦‚å¿µåˆè§£ã€Grovvy è¯­æ³•ã€å¸¸è§ API Gradle çˆ¬å‘æŒ‡å— \u0026ndash; ç†è§£ Pluginã€Taskã€æ„å»ºæµç¨‹ Gradle çˆ¬å‘æŒ‡å— \u0026ndash; Gradle æ ¸å¿ƒæ¨¡å‹ã€Hook å‡½æ•°ã€ext æ‰©å±•å±æ€§ã€Project API æ·±åº¦æ¢ç´¢ Gradle è‡ªåŠ¨åŒ–æ„å»ºæŠ€æœ¯ï¼ˆä¸€ã€Gradle æ ¸å¿ƒé…ç½®ç¯‡ï¼‰ æ·±åº¦æ¢ç´¢ Gradle è‡ªåŠ¨åŒ–æ„å»ºæŠ€æœ¯ï¼ˆäºŒã€Groovy ç­‘åŸºç¯‡ï¼‰ æ·±åº¦æ¢ç´¢ Gradle è‡ªåŠ¨åŒ–æ„å»ºæŠ€æœ¯ï¼ˆä¸‰ã€Gradle æ ¸å¿ƒè§£å¯†ï¼‰ æ·±åº¦æ¢ç´¢ Gradle è‡ªåŠ¨åŒ–æ„å»ºæŠ€æœ¯ï¼ˆå››ã€è‡ªå®šä¹‰ Gradle æ’ä»¶ï¼‰ æ·±åº¦æ¢ç´¢ Gradle è‡ªåŠ¨åŒ–æ„å»ºæŠ€æœ¯ï¼ˆäº”ã€Gradle æ’ä»¶æ¶æ„å®ç°åŸç†å‰–æ â€” ä¸Šï¼‰ æ·±åº¦æ¢ç´¢ Gradle è‡ªåŠ¨åŒ–æ„å»ºæŠ€æœ¯ï¼ˆäº”ã€Gradle æ’ä»¶æ¶æ„å®ç°åŸç†å‰–æ â€” ä¸‹ï¼‰ æ·±å…¥æ¢ç´¢ Gradle è‡ªåŠ¨åŒ–æ„å»ºæŠ€æœ¯ï¼ˆä¹ã€Gradle æ’ä»¶å¹³å°åŒ–æ¡†æ¶ ByteX æ¢ç§˜ä¹‹æ—…ï¼‰ è®¾è®¡æ¨¡å¼ç›¸å…³ Javaå¸¸ç”¨è®¾è®¡æ¨¡å¼(ä¸€) Javaå¸¸ç”¨è®¾è®¡æ¨¡å¼(äºŒ) Javaå¸¸ç”¨è®¾è®¡æ¨¡å¼(ä¸‰) ã€ŠAndroidæºç è®¾è®¡æ¨¡å¼è§£æã€‹è¯»ä¹¦ç¬”è®°â€”â€”Androidä¸­ä½ åº”è¯¥çŸ¥é“çš„è®¾è®¡æ¨¡å¼ å¤§ä½¬åšå®¢ç³»åˆ— è€ç½— Gracker ç¨‹åºå‘˜æ±ŸåŒå­¦ ","date":"2025-01-22T00:00:00Z","permalink":"https://example.com/p/%E9%AB%98%E8%B4%A8%E9%87%8F%E6%96%87%E7%AB%A0%E6%B1%87%E6%80%BB/","title":"é«˜è´¨é‡æ–‡ç« æ±‡æ€»"},{"content":"ä¸Šä¸€ç¯‡(RecyclerViewæ€§èƒ½ä¼˜åŒ–)ç†è®ºçŸ¥è¯†è®²è¿‡recyclerviewæœ‰å“ªäº›ä¼˜åŒ–ç‚¹ï¼Œè¯¥ç¯‡ä¸»è¦ç»“åˆç†è®ºçŸ¥è¯†æ¥å®è·µä¸‹ä¼˜åŒ–æ‰‹æ®µã€‚\nxmlå¸ƒå±€æ›¿æ¢ä¸ºåŠ¨æ€åˆ›å»º ä¸€ä¸ªç®€å•çš„textviewå…ˆé€šè¿‡xmlåˆ›å»ºï¼Œé€šè¿‡traceviewè§‚å¯Ÿè€—æ—¶ è¿™æ¬¡ä¸‰æ¬¡åˆ›å»ºviewholderçš„è€—æ—¶ï¼Œå…¶ä¸­ç¬¬ä¸€æ¬¡ç”±äºéœ€è¦ç±»åŠ è½½åˆ°jvmä¸­ï¼Œæ‰€ä»¥ä¼šè€—æ—¶é•¿ä¸€äº›ï¼Œåé¢çš„è¯ï¼ŒåŸºæœ¬åœ¨5mså·¦å³ã€‚ é€šè¿‡newçš„å½¢å¼åˆ›å»ºviewholderï¼š ç¬¬ä¸€æ¬¡è€—æ—¶åœ¨6msï¼Œç¬¬äºŒæ¬¡è€—æ—¶åœ¨4msï¼ŒåŸºæœ¬æ¯”xmlçš„å½¢å¼è¦å°‘ä¸ª1ms æ³¨æ„ï¼šè¿™é‡Œæ¼”ç¤ºçš„åªæ˜¯ä¸€ä¸ªç®€å•çš„textviewï¼Œå¦‚æœå¹³æ—¶å¼€å‘çš„å¸ƒå±€æ˜¯æ¯”è¾ƒå¤æ‚ï¼Œå¹¶ä¸”åµŒå¥—å±‚çº§æ¯”è¾ƒæ·±çš„è¯ï¼Œè¿™ç§å·®è·ä¼šæ›´åŠ æ˜æ˜¾ã€‚ é€šè¿‡perfettoè§‚å¯Ÿcreateè¿‡ç¨‹ï¼š åŸºæœ¬æ•°æ®å’Œtraceviewä¿æŒä¸€è‡´ã€‚ recyclerview.setHasFixSize(true) ç”¨äº†sethasfixsize(true)çš„æ—¶å€™ï¼Œä¼šé€šè¿‡consumePendingUpdateOperationsè§¦å‘recyclerviewçš„layoutè¿‡ç¨‹ï¼Œæ²¡æœ‰èµ°ä»æ ¹viewåˆ°recyclerviewçš„measureã€layoutè¿‡ç¨‹ï¼Œå®é™…sethasfixsize(true)ä¼šç»™choreographerå‘é€ä¸€æ¡callback_animalçš„æ¶ˆæ¯ï¼š å…¶å®æˆ‘ä»¬çš„å±æ€§åŠ¨ç”»ä¹Ÿæ˜¯è¿™ä¹ˆåšçš„ï¼Œç»™choreographerå‘é€ä¸€æ¡animalçš„æ¶ˆæ¯ã€‚sethasfixsize(true)åœ¨è¡¨é¡¹å°ºå¯¸ä¸å‘ç”Ÿå˜åŒ–çš„æ—¶å€™ä½¿ç”¨ï¼Œå‡å°‘ä¸å¿…è¦çš„measureè¿‡ç¨‹ã€‚\nsethasstableids(true)å’Œé‡å†™getItemIdï¼š è°ƒç”¨notifydatasetChangeåï¼Œä¸ä¼šèµ°oncreateviewholderï¼š ä»traceåˆ†æï¼š detachè¿‡ç¨‹è°ƒç”¨çš„æ˜¯scrapçš„ç¼“å­˜ï¼Œå¹¶ä¸”æ­¤æ—¶ä¸ä¼šå›è°ƒondetachfromwindowè¿‡ç¨‹ï¼Œå¹¶ä¸”éƒ½åŠ å…¥åˆ°äº†attachçš„scrapç¼“å­˜ä¸­ï¼Œåœ¨fillé˜¶æ®µé€šè¿‡é‡å†™çš„getItemIdæ‹¿åˆ°äº†viewholderï¼š è‡³äºä¸ºä»€ä¹ˆä¼šonbindï¼Œæ˜¯å› ä¸ºnotifyè¿‡åçš„itemçš„çŠ¶æ€å˜æˆäº†invalidçŠ¶æ€ï¼Œæ‰€ä»¥ä¼šé‡æ–°èµ°onbindè¿‡ç¨‹ã€‚\nrecyclerpoolå‡å°‘oncreateviewholderæ¬¡æ•°ï¼š tablayout+viewpager2ï¼Œå­é¡µé¢æ˜¯fragmentï¼Œæ¯ä¸ªfragmentä¸­çš„rvç”¨çš„viewholderæ˜¯åŒç§ç±»å‹ï¼Œæˆ‘ä»¬å°†recyclerpoolè®¾ç½®åœ¨activityä¸­ï¼Œç„¶åä¼ ç»™å­fragmentï¼Œè®¾ç½®recyclerpooléœ€è¦åœ¨setadapterä¹‹å‰ã€‚ æˆ‘ä»¬åœ¨ç¬¬ä¸€ä¸ªé¡µé¢æ»‘åŠ¨çš„æ—¶å€™ï¼Œä¼šæœ‰viewholderæ”¾åˆ°äº†recyclerpoolä¸­ï¼Œæ­¤æ—¶æˆ‘ä»¬æ»‘åŠ¨åˆ°ç¬¬äºŒä¸ªfragmentçš„æ—¶å€™ä¼šç”¨åˆ°recycerlpoolä¸­çš„viewholderã€‚ ä»debugçœ‹ï¼Œç»™å¦å¤–ä¸€ä¸ªrecyclerviewè®¾ç½®recyclerpoolæ—¶å€™ï¼Œå·²ç»å­˜åœ¨ä¸€ä¸ªviewholderï¼Œæ‰€ä»¥çŒœæµ‹è¯¥fragmentä¼šä½¿ç”¨åˆ°viewholderï¼Œæ—¥å¿—éªŒè¯ï¼š ä»æ—¥å¿—æ¥çœ‹ï¼Œç¬¬ä¸€ä¸ªviewholderåªæœ‰bindè¿‡ç¨‹ï¼Œæ²¡æœ‰createã€‚\n","date":"2025-01-17T00:00:00Z","permalink":"https://example.com/p/recyclerview%E4%BC%98%E5%8C%96%E5%AE%9E%E8%B7%B5/","title":"RecyclerViewä¼˜åŒ–å®è·µ"},{"content":" è¯´èµ·é¢„åŠ è½½ï¼Œå…¶å®ä¹‹å‰é¢è¯•çš„æ—¶å€™è¢«é—®åˆ°çš„ï¼Œç„¶åæœ€è¿‘çœ‹åˆ°ä¸€ç¯‡å…³äºé¢„åŠ è½½çš„æ–‡ç« ï¼Œç„¶åé¢‡æœ‰æ„Ÿå—ï¼Œå› æ­¤æ‰æœ‰è¯¥ç¯‡æ–‡ç« ã€‚ åœ¨recyclerviewçš„onAttachedToWindowæœ‰è¿™ä¹ˆä¸€å¥ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 /** * On L+, with RenderThread, the UI thread has idle time after it has passed a frame off to * RenderThread but before the next frame begins. We schedule prefetch work in this window. */ static final boolean ALLOW_THREAD_GAP_WORK = Build.VERSION.SDK_INT \u0026gt;= 21; @Override protected void onAttachedToWindow() { super.onAttachedToWindow(); //çœç•¥ä»£ç  if (ALLOW_THREAD_GAP_WORK) { // Register with gap worker mGapWorker = GapWorker.sGapWorker.get(); if (mGapWorker == null) { mGapWorker = new GapWorker(); // break 60 fps assumption if data from display appears valid // NOTE: we only do this query once, statically, because it\u0026#39;s very expensive (\u0026gt; 1ms) Display display = ViewCompat.getDisplay(this); float refreshRate = 60.0f; if (!isInEditMode() \u0026amp;\u0026amp; display != null) { float displayRefreshRate = display.getRefreshRate(); if (displayRefreshRate \u0026gt;= 30.0f) { refreshRate = displayRefreshRate; } } mGapWorker.mFrameIntervalNs = (long) (1000000000 / refreshRate); GapWorker.sGapWorker.set(mGapWorker); } mGapWorker.add(this); } } å¯ä»¥çœ‹åˆ°æœ‰ä¸€ä¸ªé™æ€å˜é‡ï¼ŒALLOW_THREAD_GAP_WORKæ˜¯å¤§äºç­‰äº21ï¼ˆAndroid5.0ï¼‰æ‰ä¼šä¸ºtrueï¼Œè¿™æ˜¯å› ä¸ºåœ¨5.0ä¹‹åï¼Œå¼•è¿›äº†RenderThreadçº¿ç¨‹ï¼Œä¸“é—¨ç”¨æ¥æ¸²æŸ“uiçº¿ç¨‹ç»˜åˆ¶å¥½çš„æ•°æ®ï¼Œæ¸²æŸ“å®Œåï¼Œä¼šæäº¤åˆ°äº‹å…ˆç”³è¯·çš„bufferqueueä¸­ï¼Œç„¶åå½“vsync-sfä¿¡å·æ¥çš„æ—¶å€™ï¼Œsufaceflingerä¼šå»å¯¹åº”appçš„bufferqueueä¸­å–å‡ºå‰é¢æäº¤çš„bufferæ•°æ®ï¼Œç„¶åè¿›è¡Œåˆæˆlayerï¼Œæœ€ç»ˆå±å¹•ï¼ˆhwcï¼‰æ”¶åˆ°è¯¥è¯·æ±‚åï¼Œè¿›è¡Œå›¾å±‚è¿›è¡Œåˆæˆï¼Œæœ€ç»ˆé€åˆ°å±å¹•ç¡¬ä»¶ä¸Šæ˜¾ç¤ºã€‚è¿™å°±æ˜¯ä¸€é’ˆä»åˆ›å»ºåˆ°æ¶ˆè´¹çš„è¿‡ç¨‹ã€‚ ç”±äºuiçº¿ç¨‹æŠŠç»˜åˆ¶å¥½çš„æ•°æ®ç»˜åˆ¶å¥½åï¼Œä¼šé€šçŸ¥renderthreadçº¿ç¨‹è¿›è¡Œæ¸²æŸ“ï¼Œç›´åˆ°ä¸‹ä¸€é’ˆæ¥çš„æ—¶å€™æ‰å¼€å§‹å·¥ä½œï¼Œæ­¤æ—¶ä¼šæœ‰ä¸»çº¿ç¨‹ç©ºé—²çš„æ—¶å€™ï¼Œrecyclerviewæ­£æ˜¯åˆ©ç”¨æ­¤ç©ºé—²æ—¶é—´æ¥è¿›è¡Œé¢„åŠ è½½ï¼Œè€Œå¦‚æœåœ¨ä¸‹ä¸€é’ˆæ¥ä¸´çš„æ—¶å€™ï¼Œé¢„åŠ è½½è¿˜æ²¡æœ‰å®Œæˆï¼Œé‚£ä¹ˆæ­¤æ—¶ä¼šæ”¾å¼ƒæ­¤æ¬¡çš„é¢„åŠ è½½ï¼Œäº†è§£åŸç†åï¼Œå¼€å§‹åˆ†æè¿‡ç¨‹ï¼š é¢„åŠ è½½çš„å¤„ç†ç±»æ˜¯GapWorkerç±»ï¼Œä¸€ä¸ªçº¿ç¨‹å¯¹åº”ä¸€ä¸ªGapWorkerï¼Œå®ƒæ˜¯å­˜å‚¨åœ¨ThreadLocalä¸­ã€‚GapWorkeræ˜¯ä¸€ä¸ªrunnableç±»ï¼Œå®ƒå¦‚ä½•è¦å·¥ä½œçš„è¯ï¼Œæ˜¯é€šè¿‡GapWorker.postFromTraversalå·¥ä½œçš„ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 void postFromTraversal(RecyclerView recyclerView, int prefetchDx, int prefetchDy) { if (recyclerView.isAttachedToWindow()) { if (RecyclerView.DEBUG \u0026amp;\u0026amp; !mRecyclerViews.contains(recyclerView)) { throw new IllegalStateException(\u0026#34;attempting to post unregistered view!\u0026#34;); } if (mPostTimeNs == 0) { mPostTimeNs = recyclerView.getNanoTime(); recyclerView.post(this); } } recyclerView.mPrefetchRegistry.setPrefetchVector(prefetchDx, prefetchDy); } å¯ä»¥çœ‹å‡ºæ¥å®é™…æ˜¯é€šè¿‡recyclerview.postï¼Œç„¶åä¼ çš„æ˜¯è‡ªå·±ï¼Œå› æ­¤ä¼šç›´æ¥runæ–¹æ³•ã€‚é¢„åŠ è½½æ—¶æœºåœ¨æºç é‡Œé¢æœ‰ä¸¤å¤„è°ƒç”¨äº†ï¼š\nRecyclerviewè¢«æ‹–åŠ¨æ—¶ï¼š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 @Override public boolean onTouchEvent(MotionEvent e) { ... switch (action) { ... case MotionEvent.ACTION_MOVE: { ... if (mScrollState == SCROLL_STATE_DRAGGING) { ... // å¤„äºæ‹–åŠ¨çŠ¶æ€å¹¶ä¸”å­˜åœ¨æœ‰æ•ˆçš„æ‹–åŠ¨è·ç¦»æ—¶ if (mGapWorker != null \u0026amp;\u0026amp; (dx != 0 || dy != 0)) { mGapWorker.postFromTraversal(this, dx, dy); } } } break; ... } ... return true; } Recyclerviewæƒ¯æ€§æ»‘åŠ¨æ—¶ï¼š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 class ViewFlinger implements Runnable { ... @Override public void run() { ... if (!smoothScrollerPending \u0026amp;\u0026amp; doneScrolling) { ... } else { ... if (mGapWorker != null) { mGapWorker.postFromTraversal(RecyclerView.this, consumedX, consumedY); } } } ... } çœ‹ä¸‹GapWorkerçš„runæ–¹æ³•å¦‚ä½•å®ç°çš„é¢„åŠ è½½ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 @Override public void run() { try { TraceCompat.beginSection(RecyclerView.TRACE_PREFETCH_TAG); if (mRecyclerViews.isEmpty()) { // abort - no work to do return; } // Query most recent vsync so we can predict next one. Note that drawing time not yet // valid in animation/input callbacks, so query it here to be safe. final int size = mRecyclerViews.size(); long latestFrameVsyncMs = 0; for (int i = 0; i \u0026lt; size; i++) { RecyclerView view = mRecyclerViews.get(i); if (view.getWindowVisibility() == View.VISIBLE) { latestFrameVsyncMs = Math.max(view.getDrawingTime(), latestFrameVsyncMs); } } if (latestFrameVsyncMs == 0) { // abort - either no views visible, or couldn\u0026#39;t get last vsync for estimating next return; } long nextFrameNs = TimeUnit.MILLISECONDS.toNanos(latestFrameVsyncMs) + mFrameIntervalNs; prefetch(nextFrameNs); // TODO: consider rescheduling self, if there\u0026#39;s more work to do } finally { mPostTimeNs = 0; TraceCompat.endSection(); } } åœ¨è°ƒç”¨prefetchå‰ä¼ å…¥nextFrameNsï¼Œè¯¥å€¼è¡¨ç¤ºé¢„ä¼°çš„ä¸‹ä¸€ä¸ªvsyncæ¥ä¸´çš„æ—¶é—´ï¼Œé¦–å…ˆè·å–ä¸Šä¸€é’ˆçš„ç»˜åˆ¶èµ·å§‹æ—¶é—´ï¼Œä¹Ÿå°±æ˜¯latestFrameVsyncMsï¼Œè€ŒmFrameIntervalNsæ˜¯é€šè¿‡åˆ·æ–°ç‡ç®—å‡ºæ¥çš„ä¸€é’ˆéœ€è¦çš„æ—¶é—´ï¼Œæ¯”å¦‚60hzçš„æ‰‹æœºï¼Œä¸€ç§’æ˜¯60å¸§ï¼Œé‚£ä¹ˆmFrameIntervalNsçš„å€¼æ˜¯ä¸€é’ˆéœ€è¦16msï¼ŒmFrameIntervalNsçš„å•ä½æ˜¯çº³ç§’ï¼Œè¿™ä¸ªæ—¶é—´åœ¨å¼€ç¯‡çš„onAttachedToWindowæ–¹æ³•ä¸­è®¡ç®—çš„ï¼Œæ‰€ä»¥å¯ä»¥çœ‹å‡ºæ¥ï¼ŒnextFrameNsæ—¶é—´å°±æ˜¯é¢„åŠ è½½æœ€åçš„æœŸé™æ—¶é—´ï¼Œè¶…è¿‡è¿™ä¸ªæ—¶é—´å°±ä¼šæ”¾å¼ƒè¯¥é¢„åŠ è½½ï¼Œä¸Šé¢æåˆ°çš„ä¸Šä¸€é’ˆæ—¶é—´æ˜¯ç”¨è¿‡recyclerviewçš„getDrawingTimeè·å–çš„ï¼Œå®ƒæ˜¯è·å–çš„attachInfoçš„mDrawingTimeæ—¶é—´ï¼Œè€ŒmDrawingTimeæ˜¯åœ¨viewRootImplä¸­drawæ–¹æ³•ç»™èµ‹å€¼çš„ï¼š\n1 2 3 4 5 6 private boolean draw(boolean fullRedrawNeeded, boolean forceDraw) { //çœç•¥ä»£ç  mAttachInfo.mDrawingTime = mChoreographer.getFrameTimeNanos() / TimeUtils.NANOS_PER_MS; //çœç•¥ä»£ç  } å¯ä»¥çœ‹å‡ºæ¥ï¼Œå®ƒæ˜¯é€šè¿‡Choreographerçš„getFrameTimeNanosæ–¹æ³•æ¥è·å–çš„ï¼š\n1 2 3 4 5 @UnsupportedAppUsage public long getFrameTimeNanos() { //çœç•¥ä»£ç  return USE_FRAME_TIME ? mLastFrameTimeNanos : System.nanoTime(); } mLastFrameTimeNanosæ˜¯åœ¨doFrameä¸­å°†å‚æ•°frameTimeNanosç»™èµ‹å€¼çš„ï¼Œè€ŒframeTimeNanoså‚æ•°è¡¨ç¤ºçš„å°±æ˜¯å½“å‰vsnycä¿¡å·æ¥ä¸´çš„æ—¶é—´ã€‚æ‰€ä»¥æœ€ç»ˆç»“è®ºå°±æ˜¯é€šè¿‡éå†recyclerviewçš„drawingtimeï¼Œæ¥è·å–æœ€è¿‘ä¸€æ¬¡çš„vsyncæ—¶é—´ï¼Œå¹¶åŠ ä¸Šå½“å‰è®¾å¤‡ä¸€é’ˆæ‰€éœ€è¦çš„æ—¶é—´ï¼Œä»è€Œå¾—åˆ°ä¸‹ä¸€ä¸ªvsyncä¿¡å·æ¥ä¸´çš„æ—¶é—´ï¼Œä¹Ÿå°±æ˜¯é¢„åŠ è½½è¦å®Œæˆçš„æœ€æ™šæ—¶é—´ã€‚ç»§ç»­è·Ÿè¿›GapWorkerçš„prefetchæ–¹æ³•ï¼š\n1 2 3 4 void prefetch(long deadlineNs) { buildTaskList(); flushTasksWithDeadline(deadlineNs); } buildTaskListï¼Œå®ƒæ˜¯ç”¨æ¥æ„å»ºé¢„åŠ è½½çš„taskåˆ—è¡¨ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 private void buildTaskList() { // Update PrefetchRegistry in each view final int viewCount = mRecyclerViews.size(); int totalTaskCount = 0; for (int i = 0; i \u0026lt; viewCount; i++) { RecyclerView view = mRecyclerViews.get(i); if (view.getWindowVisibility() == View.VISIBLE) { //æ”¶é›†è¦é¢„åŠ è½½çš„viewçš„position view.mPrefetchRegistry.collectPrefetchPositionsFromView(view, false); totalTaskCount += view.mPrefetchRegistry.mCount; } } //çœç•¥ä»£ç  } é¦–å…ˆæ˜¯è°ƒç”¨äº†view.mPrefetchRegistry.collectPrefetchPositionsFromView(view, false)æ¥æ”¶é›†é¢„åŠ è½½çš„viewï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 void collectPrefetchPositionsFromView(RecyclerView view, boolean nested) { mCount = 0; if (mPrefetchArray != null) { Arrays.fill(mPrefetchArray, -1); } final RecyclerView.LayoutManager layout = view.mLayout; if (view.mAdapter != null \u0026amp;\u0026amp; layout != null \u0026amp;\u0026amp; layout.isItemPrefetchEnabled()) { //çœç•¥ä»£ç  if (!view.hasPendingAdapterUpdates()) { layout.collectAdjacentPrefetchPositions(mPrefetchDx, mPrefetchDy, view.mState, this); } //çœç•¥ä»£ç  } } å¯ä»¥çœ‹å‡ºæ¥è°ƒç”¨äº†layoutmanagerçš„collectAdjacentPrefetchPositionsçš„æ–¹æ³•ï¼ŒæŠŠéœ€è¦é¢„åŠ è½½çš„æ°´å¹³å’Œç«–ç›´æ–¹å‘çš„åç§»é‡ä¼ å…¥å…¶ä¸­ï¼Œçœ‹ä¸‹LinearLayoutManagerçš„è¯¥æ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 @Override public void collectAdjacentPrefetchPositions(int dx, int dy, RecyclerView.State state, LayoutPrefetchRegistry layoutPrefetchRegistry) { int delta = (mOrientation == HORIZONTAL) ? dx : dy; if (getChildCount() == 0 || delta == 0) { // can\u0026#39;t support this scroll, so don\u0026#39;t bother prefetching return; } ensureLayoutState(); final int layoutDirection = delta \u0026gt; 0 ? LayoutState.LAYOUT_END : LayoutState.LAYOUT_START; final int absDelta = Math.abs(delta); updateLayoutState(layoutDirection, absDelta, true, state); collectPrefetchPositionsForLayoutState(state, mLayoutState, layoutPrefetchRegistry); } é€šè¿‡æ–¹æ³•æ¥åˆ¤æ–­åç§»é‡ï¼Œç„¶åæŠŠæ–¹å‘æ ‡è¯†ä¼ å…¥åˆ°updateLayoutStateä¸­ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 private void updateLayoutState(int layoutDirection, int requiredSpace, boolean canUseExistingSpace, RecyclerView.State state) { //çœç•¥ä»£ç  if (layoutToEnd) { //è·å–å¯è§çš„æœ€åä¸€ä¸ªè¡¨é¡¹ final View child = getChildClosestToEnd(); //åˆ¤æ–­æ˜¯å¦æ˜¯reverseçš„ mLayoutState.mItemDirection = mShouldReverseLayout ? LayoutState.ITEM_DIRECTION_HEAD : LayoutState.ITEM_DIRECTION_TAIL; //è·å–é¢„åŠ è½½çš„position mLayoutState.mCurrentPosition = getPosition(child) + mLayoutState.mItemDirection; mLayoutState.mOffset = mOrientationHelper.getDecoratedEnd(child); //è·å–è¦é¢„åŠ è½½çš„è¡¨é¡¹ä¸recyclerviewåº•éƒ¨çš„è·ç¦» scrollingOffset = mOrientationHelper.getDecoratedEnd(child) - mOrientationHelper.getEndAfterPadding(); } else { //çœç•¥ä»£ç  } //çœç•¥ä»£ç  mLayoutState.mScrollingOffset = scrollingOffset; } æ­¤å¤„åªä¿ç•™ä»ä¸Šåˆ°ä¸‹çš„æ»‘åŠ¨ï¼Œå…ˆæ˜¯è·å–é¡µé¢æ»šåŠ¨çš„æœ€åä¸€ä¸ªè¡¨é¡¹ï¼Œç„¶ååˆ¤æ–­æ˜¯ä¸æ˜¯reverseLayoutï¼Œå¦‚æœä¸æ˜¯åˆ™å–LayoutState.ITEM_DIRECTION_TAIL(è¯¥å€¼ç­‰äº1)ï¼Œé¢„åŠ è½½çš„positionç­‰äºæœ€åä¸€ä¸ªè¡¨é¡¹çš„position+1ï¼Œæ¥ç€ç®—å‡ºé¢„åŠ è½½çš„è¡¨é¡¹ç¦»recyclerviewåº•éƒ¨çš„è·ç¦»ã€‚å®ƒæ˜¯é€šè¿‡mOrientationHelper.getDecoratedEnd(child)- mOrientationHelper.getEndAfterPadding()å¾—åˆ°çš„ã€‚ mOrientationHelper.getDecoratedEnd(child)å®ƒæ˜¯åœ¨OrientationHelperä¸­å®šä¹‰çš„createVerticalHelperæ–¹æ³•ä¸­å®ç°çš„ï¼š\n1 2 3 4 5 6 @Override public int getDecoratedEnd(View view) { final RecyclerView.LayoutParams params = (RecyclerView.LayoutParams) view.getLayoutParams(); return mLayoutManager.getDecoratedBottom(view) + params.bottomMargin; } 1 2 3 public int getDecoratedBottom(@NonNull View child) { return child.getBottom() + getBottomDecorationHeight(child); } getDecoratedBottomæ˜¯è·å–childçš„bottom+childçš„åº•éƒ¨é—´è·é«˜åº¦ï¼Œæ‰€ä»¥getDecoratedEndæ˜¯è·å–childçš„bottom+childçš„åº•éƒ¨é—´è·é«˜åº¦+ä¸‹é—´è·ã€‚ mOrientationHelper.getEndAfterPadding()ä¹Ÿæ˜¯åœ¨OrientationHelperä¸­å®šä¹‰çš„createVerticalHelperæ–¹æ³•ä¸­å®ç°çš„ï¼š\n1 2 3 4 @Override public int getEndAfterPadding() { return mLayoutManager.getHeight() - mLayoutManager.getPaddingBottom(); } getEndAfterPaddingæ˜¯recyclerviewçš„é«˜åº¦-recyclerviewçš„ä¸‹å†…è¾¹è·ã€‚æ‰€ä»¥scrollingOffsetæ˜¯å³å°†è¦é¢„åŠ è½½çš„è¡¨é¡¹ç¦»recyclerviewåº•éƒ¨çš„é—´è·ã€‚æ¥ç€çœ‹ä¸‹collectPrefetchPositionsForLayoutStateæ–¹æ³•ï¼š\n1 2 3 4 5 6 7 void collectPrefetchPositionsForLayoutState(RecyclerView.State state, LayoutState layoutState, LayoutPrefetchRegistry layoutPrefetchRegistry) { final int pos = layoutState.mCurrentPosition; if (pos \u0026gt;= 0 \u0026amp;\u0026amp; pos \u0026lt; state.getItemCount()) { layoutPrefetchRegistry.addPosition(pos, Math.max(0, layoutState.mScrollingOffset)); } } å°†åˆšæ‰ç®—çš„é¢„åŠ è½½çš„postionå’Œåç§»é‡ä¼ å…¥åˆ°addPositionä¸­ï¼Œè¯¥æ–¹æ³•æ˜¯åœ¨GapWorkerä¸­å®ç°çš„ï¼š\n1 2 3 4 5 6 7 8 @Override public void addPosition(int layoutPosition, int pixelDistance) { //çœç•¥ä»£ç  final int storagePosition = mCount * 2; mPrefetchArray[storagePosition] = layoutPosition; mPrefetchArray[storagePosition + 1] = pixelDistance; mCount++; } å°†positionå’Œåç§»é‡æˆå¯¹ä¿å­˜åœ¨mPrefetchArrayæ•°ç»„ä¸­ã€‚æ„å»ºå®Œæ•°ç»„ä¸­ï¼Œæ¥ç€å°±æ˜¯å°†æ•°ç»„çš„æ•°æ®å­˜åˆ°taskä¸­ã€‚è¿™å—é€»è¾‘åœ¨buildTaskListä¸­ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 private void buildTaskList() { for (int i = 0; i \u0026lt; viewCount; i++) { RecyclerView view = mRecyclerViews.get(i); if (view.getWindowVisibility() != View.VISIBLE) { // Invisible view, don\u0026#39;t bother prefetching continue; } LayoutPrefetchRegistryImpl prefetchRegistry = view.mPrefetchRegistry; final int viewVelocity = Math.abs(prefetchRegistry.mPrefetchDx) + Math.abs(prefetchRegistry.mPrefetchDy); for (int j = 0; j \u0026lt; prefetchRegistry.mCount * 2; j += 2) { final Task task; if (totalTaskIndex \u0026gt;= mTasks.size()) { task = new Task(); mTasks.add(task); } else { task = mTasks.get(totalTaskIndex); } final int distanceToItem = prefetchRegistry.mPrefetchArray[j + 1]; task.immediate = distanceToItem \u0026lt;= viewVelocity; task.viewVelocity = viewVelocity; task.distanceToItem = distanceToItem; task.view = view; task.position = prefetchRegistry.mPrefetchArray[j]; totalTaskIndex++; } } } taskä¿¡æ¯ç”±ç”±ä»¥ä¸‹ç»„æˆï¼š immediateï¼šè¡¨ç¤ºæ˜¯å¦ç«‹å³æ‰§è¡Œï¼Œåˆ¤æ–­ä¾æ®é¢„åŠ è½½çš„è¡¨é¡¹ç¦»recyclerviewåº•éƒ¨è·ç¦»æ˜¯å¦å°äºæ»‘åŠ¨çš„é€Ÿåº¦ viewVelocityï¼šæ»‘åŠ¨çš„é€Ÿåº¦ distanceToItemï¼šé¢„åŠ è½½çš„è¡¨é¡¹ç¦»recyclerviewåº•éƒ¨è·ç¦» viewï¼šrecyclerview positionï¼šé¢„åŠ è½½è¡¨é¡¹çš„ä½ç½® ä»ä¸Šé¢å¯ä»¥çœ‹å‡ºæ¥ä»mPrefetchArrayæ•°ç»„ä¸­å–å€¼æ˜¯æ¯ä¸¤ä¸ªå€¼å–å‡ºçš„ï¼Œå’Œä¸Šé¢buildè¿‡ç¨‹å¯¹åº”ã€‚æ‰€æœ‰çš„å®Œäº‹åï¼Œåœ¨buildTaskListä¸­å°±æ˜¯å¯¹taskè¿›è¡Œæ’åºï¼š\n1 2 3 4 5 private void buildTaskList() { ... // 3.å¯¹ä»»åŠ¡åˆ—è¡¨è¿›è¡Œä¼˜å…ˆçº§æ’åº Collections.sort(mTasks, sTaskComparator); } ä¸Šé¢å°±æ˜¯æ•´ä¸ªbuildTaskListçš„é€»è¾‘ï¼Œæ¥ç€å°±æ˜¯æ ¹æ®æ„å»ºçš„taskæ¥åˆ›å»ºviewholderï¼Œè¯¥é€»è¾‘æ˜¯åœ¨flushTasksWithDeadlineæ–¹æ³•ä¸­ï¼š\n1 2 3 4 5 6 7 8 9 10 private void flushTasksWithDeadline(long deadlineNs) { for (int i = 0; i \u0026lt; mTasks.size(); i++) { final Task task = mTasks.get(i); if (task.view == null) { break; // done with populated tasks } flushTaskWithDeadline(task, deadlineNs); task.clear(); } } flushTaskWithDeadline:\n1 2 3 4 5 6 private void flushTaskWithDeadline(Task task, long deadlineNs) { long taskDeadlineNs = task.immediate ? RecyclerView.FOREVER_NS : deadlineNs; RecyclerView.ViewHolder holder = prefetchPositionWithDeadline(task.view, task.position, taskDeadlineNs); //çœç•¥ä»£ç  } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 private RecyclerView.ViewHolder prefetchPositionWithDeadline(RecyclerView view, int position, long deadlineNs) { RecyclerView.Recycler recycler = view.mRecycler; RecyclerView.ViewHolder holder; holder = recycler.tryGetViewHolderForPositionByDeadline( position, false, deadlineNs); if (holder != null) { if (holder.isBound() \u0026amp;\u0026amp; !holder.isInvalid()) { //å¦‚æœholderå·²ç»ç»‘å®šè¿‡å¹¶ä¸”æ˜¯å¯ç”¨çš„ï¼ŒåŠ å…¥åˆ°cacheviewç¼“å­˜ä¸­ recycler.recycleView(holder.itemView); } else { //å¦åˆ™åŠ å…¥åˆ°RecycledViewPoolä¸­ recycler.addViewHolderToRecycledViewPool(holder, false); } } return holder; } ä¸Šé¢é€šè¿‡tryGetViewHolderForPositionByDeadlineè·å–viewholderï¼Œå’Œæ­£å¸¸è·å–viewholderçš„åŒºåˆ«æ˜¯ä¼ å…¥äº†deadlineNsï¼Œç›´æ¥çœ‹è¯¥æ–¹æ³•æ˜¯å¦‚ä½•æ”¾å¼ƒè¶…æ—¶çš„viewholderï¼š\n1 2 3 4 5 6 7 8 9 10 ViewHolder tryGetViewHolderForPositionByDeadline(int position, boolean dryRun, long deadlineNs) { if (holder == null) { long start = getNanoTime(); if (deadlineNs != FOREVER_NS \u0026amp;\u0026amp; !mRecyclerPool.willCreateInTime(type, start, deadlineNs)) { return null; } } } å¦‚æœdeadlineNsä¸æ˜¯FOREVER_NSï¼Œæ™®é€šè°ƒç”¨è¯¥æ–¹æ³•ä¼ å…¥çš„deadlineNsæ˜¯FOREVER_NSï¼Œæ‰€ä»¥æ˜¯é€šè¿‡è¯¥å€¼åŒºåˆ†æ˜¯ä¸æ˜¯é¢„åŠ è½½è°ƒç”¨çš„ï¼Œæ¥ç€é€šè¿‡willCreateInTimeè¿”å›å€¼åˆ¤æ–­è¦ä¸è¦æ”¾å¼ƒï¼š\n1 2 3 4 boolean willCreateInTime(int viewType, long approxCurrentNs, long deadlineNs) { long expectedDurationNs = getScrapDataForType(viewType).mCreateRunningAverageNs; return expectedDurationNs == 0 || (approxCurrentNs + expectedDurationNs \u0026lt; deadlineNs); } expectedDurationNså–çš„æ˜¯å¯¹åº”viewholderçš„å¹³å‡åˆ›å»ºæ—¶é—´ï¼Œå…¶å®ä¹Ÿä¸å«å¹³å‡æ—¶é—´ï¼š\n1 2 3 4 5 6 7 8 9 10 11 void factorInCreateTime(int viewType, long createTimeNs) { ScrapData scrapData = getScrapDataForType(viewType); scrapData.mCreateRunningAverageNs = runningAverage( scrapData.mCreateRunningAverageNs, createTimeNs); } long runningAverage(long oldAverage, long newValue) { if (oldAverage == 0) { return newValue; } return (oldAverage / 4 * 3) + (newValue / 4); } æ¯æ¬¡å°†ä¹‹å‰çš„åˆ›å»ºviewholderæ—¶é—´å 3åˆ†ä¹‹4ï¼Œå½“å‰åˆ›å»ºçš„æ—¶é—´å 1åˆ†ä¹‹4ã€‚æ‰€ä»¥willCreateInTimeçš„è¿”å›å€¼æ˜¯å¦‚æœå½“å‰æ—¶é—´+å¹³å‡åˆ›å»ºviewholderæ—¶é—´å°äºæœ€æ™šçº¦å®šæ—¶é—´åˆ™ä¸ä¼šæ”¾å¼ƒï¼Œå¦åˆ™ç›´æ¥æ”¾å¼ƒã€‚å¦‚æœä¸æ”¾å¼ƒæ¥ç€ä¼šåˆ¤æ–­bindè¿‡ç¨‹æœ‰æ²¡æœ‰è¶…è¿‡çº¦å®šæ—¶é—´ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 private boolean tryBindViewHolderByDeadline(@NonNull ViewHolder holder, int offsetPosition, int position, long deadlineNs) { final int viewType = holder.getItemViewType(); long startBindNs = getNanoTime(); if (deadlineNs != FOREVER_NS \u0026amp;\u0026amp; !mRecyclerPool.willBindInTime(viewType, startBindNs, deadlineNs)) { return false; } mAdapter.bindViewHolder(holder, offsetPosition); long endBindNs = getNanoTime(); mRecyclerPool.factorInBindTime(holder.getItemViewType(), endBindNs - startBindNs); return true; } bindè¿‡ç¨‹æ˜¯é€šè¿‡willBindInTimeæ–¹æ³•æ¥åˆ¤æ–­æœ‰æ²¡æœ‰è¶…è¿‡çº¦å®šæ—¶é—´çš„ï¼Œæ•´ä¸ªé€»è¾‘å¾ˆæ¸…æ™°ã€‚\nå‰é¢åˆ†æè¿‡å¦‚æœholderæ˜¯bindè¿‡çš„ï¼Œåˆ™ä¼šåŠ å…¥åˆ°cacheviewç¼“å­˜ä¸­ï¼Œå¦åˆ™åŠ å…¥åˆ°RecycledViewPoolä¸­ï¼Œæ­£å¸¸æ»‘åŠ¨çš„æ—¶å€™ç¦»å±çš„viewholderä¹Ÿæ˜¯æ·»åŠ åˆ°cacheviewç¼“å­˜ä¸­çš„ï¼Œé‚£ä¸¤è€…åœ¨ç¼“å­˜ä¸­åˆæ˜¯æ€ä¹ˆåŒºåˆ†çš„å‘¢ï¼Ÿç›´æ¥çœ‹recyclerçš„recycleViewHolderInternalæ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 void recycleViewHolderInternal(ViewHolder holder) { //çœç•¥ä»£ç  //é»˜è®¤æ’å…¥cacheviewç¼“å­˜çš„ç´¢å¼•æ˜¯æœ«å°¾ int targetCacheIndex = cachedViewSize; if (ALLOW_THREAD_GAP_WORK \u0026amp;\u0026amp; cachedViewSize \u0026gt; 0 \u0026amp;\u0026amp; !mPrefetchRegistry.lastPrefetchIncludedPosition(holder.mPosition)) {//å¦‚æœæ˜¯æ­£å¸¸ç¦»å±çš„viewholder //é»˜è®¤æŒ‡å‘æœ€åä¸€ä¸ªå…ƒç´  int cacheIndex = cachedViewSize - 1; while (cacheIndex \u0026gt;= 0) { int cachedPos = mCachedViews.get(cacheIndex).mPosition; //å¦‚æœå½“å‰è¡¨é¡¹ä¸æ˜¯é¢„æ‹‰å–çš„è¡¨é¡¹åˆ™é€€å‡º if (!mPrefetchRegistry.lastPrefetchIncludedPosition(cachedPos)) { break; } cacheIndex--; } targetCacheIndex = cacheIndex + 1; } mCachedViews.add(targetCacheIndex, holder); //çœç•¥ä»£ç  } é»˜è®¤æ’å…¥cacheviewç¼“å­˜çš„ç´¢å¼•æ˜¯åœ¨æœ«å°¾ï¼Œåœ¨æ’å…¥æ­£å¸¸ç¦»å±çš„viewholderæ—¶å€™å¦‚æœé‡åˆ°é¢„æ‹‰å–çš„viewholderï¼Œåˆ™å¾€å‰æ‰¾ç›´åˆ°æœ€åä¸€ä¸ªç¦»å±çš„viewholderï¼Œç„¶åæ’å…¥åˆ°å®ƒåé¢ã€‚æ‰€ä»¥ä¸éš¾çœ‹å‡ºï¼Œé¢„æ‹‰å–çš„ä¼šåœ¨åé¢ï¼Œç¦»å±çš„ä¼šåœ¨å‰é¢ã€‚è¿™æ ·çš„å¥½å¤„æ˜¯é¢„åŠ è½½çš„viewholderç”±äºåœ¨åé¢ä½¿ç”¨çš„æœºä¼šä¼šå¾ˆå¤§ï¼Œæ”¾åœ¨é›†åˆçš„åé¢åˆ é™¤çš„æ¦‚ç‡è¦å°ã€‚\nå‚è€ƒï¼šæŒæ¡è¿™17å¼ å›¾ï¼Œæ²¡äººæ¯”ä½ æ›´æ‡‚RecyclerViewçš„é¢„åŠ è½½\n","date":"2025-01-17T00:00:00Z","permalink":"https://example.com/p/recyclerview%E7%9A%84%E9%A2%84%E5%8A%A0%E8%BD%BD%E5%AE%9E%E7%8E%B0/","title":"RecyclerViewçš„é¢„åŠ è½½å®ç°"},{"content":" å…³äºRecyclerViewçš„ä¼˜åŒ–ï¼Œå…¶å®æ— éä¸¤ç‚¹ï¼Œå°½å¯èƒ½çš„æœ€å¤§åŒ–ä½¿ç”¨viewholderçš„ç¼“å­˜ï¼Œå¦‚æœä¸èƒ½ä½¿ç”¨ç¼“å­˜ï¼Œå°†æ„å»ºå’Œç»‘å®šviewholderçš„è¿‡ç¨‹è€—æ—¶é™ä½åˆ°æœ€ä½ã€‚\nç¼“å­˜ è¿™é‡Œå†æ€»ç»“ä¸‹RecyclerViewçš„ç¼“å­˜çŸ¥è¯†ï¼š\nåˆ†ç±» scrapç¼“å­˜ï¼šç”¨äºç¼“å­˜é¡µé¢æš‚æ—¶åˆ†ç¦»çš„viewholderï¼Œåˆ†ä¸ºchangeScrapå’ŒattachScrapï¼ŒchangeScrapç”¨äºç¼“å­˜è¦updateçš„viewholderï¼Œattachscrapç¼“å­˜éupdateçš„viewholderã€‚ ä¸ä½œç”¨äºé¡µé¢æ»‘åŠ¨ï¼Œå¼€å‘å¹²é¢„ä¸äº†è¯¥ç¼“å­˜ã€‚å®ƒç¼“å­˜çš„ä¸ªæ•°æ˜¯ä¸€å±çš„viewholderã€‚ cacheviewç¼“å­˜ï¼šæ˜¯ä¸€ä¸ªarraylistçš„ç»“æ„ï¼Œåœ¨æ»‘åŠ¨çš„æ—¶å€™ï¼Œæ»‘å‡ºå±å¹•çš„viewholderä¼šä¿å­˜åˆ°è¯¥ç¼“å­˜ä¸­ï¼Œé»˜è®¤ä¿å­˜çš„æ•°é‡æ˜¯2ä¸ªï¼Œå½“è¶…è¿‡2ä¸ªçš„æ—¶å€™ï¼Œä¼šå…ˆç§»é™¤é›†åˆä¸­ç¬¬ä¸€ä¸ªviewholderï¼Œå¹¶æŠŠè¯¥viewholderè¿›è¡Œé‡ç½®ã€‚ ç„¶ååŠ å…¥åˆ°recyclerpoolç¼“å­˜ä¸­ï¼Œæœ€åæŠŠæ–°çš„viewholderåŠ å…¥åˆ°cacheviewç¼“å­˜å°¾éƒ¨ï¼Œæ•´ä¸ªè¿‡ç¨‹ï¼Œcacheviewç¼“å­˜ç›¸å½“äºæ˜¯ä¸€ä¸ªé˜Ÿåˆ—ï¼Œå…ˆè¿›å…ˆå‡ºçš„è§„åˆ™ã€‚å®ƒæ˜¯æ ¹æ®positionæ¥å–çš„ï¼Œä¸éœ€è¦é‡æ–°bind ViewCacheExtensionï¼šmViewCacheExtensionåˆç§°æ‹“å±•ç¼“å­˜ï¼Œä¸ºå¼€å‘è€…é¢„ç•™çš„ç¼“å­˜æ± ï¼Œå¼€å‘è€…å¯ä»¥è‡ªå·±æ‹“å±•å›æ”¶æ± ï¼Œä¸€èˆ¬ä¸ä¼šç”¨åˆ°ã€‚ æœ€åå°±æ˜¯recyclerpoolç¼“å­˜ï¼Œå®ƒæ˜¯åœ¨cacheviewæ»¡äº†çš„æ—¶å€™ï¼ŒåŠ å…¥åˆ°è¯¥ç¼“å­˜ä¸­çš„ï¼Œå®ƒæ˜¯æ ¹æ®viewtypeç¼“å­˜çš„ã€‚åœ¨å®ƒé‡Œé¢çš„viewholderéƒ½è¢«é‡ç½®è¿‡äº†çš„ï¼Œæ‰€ä»¥ä»å®ƒé‡Œé¢å–å‡ºæ¥çš„viewholderéƒ½éœ€è¦é‡æ–°bindã€‚ ç¼“å­˜å›æ”¶ åœ¨ä¸æ»šåŠ¨æƒ…å†µä¸‹ï¼š ä¼šæŠŠé¡µé¢ä¸Šå¯è§çš„viewholderç¼“å­˜åˆ°scrapä¸­ï¼Œå¦‚æœviewholderä¸­æœ‰flag_updateæ ‡è®°çš„æ—¶å€™ï¼Œåˆ™æŠŠå®ƒæ·»åŠ åˆ°changeScrapä¸­ï¼Œå¦åˆ™åŠ å…¥åˆ°attachScrapä¸­ã€‚ åœ¨æ»šåŠ¨æƒ…å†µä¸‹ï¼š ä¼šæŠŠæ»‘å‡ºrecyclerviewçš„viewholderå…ˆæ·»åŠ åˆ°cacheViewç¼“å­˜ä¸­ï¼Œå¦‚æœcacheViewç¼“å­˜æ»¡äº†è¯ï¼Œä¼šæŠŠé›†åˆå¼€å§‹çš„ä½ç½®viewholderç»™æ”¾åˆ°RecycledViewPoolä¸­ï¼ŒRecycledViewPoolä¼šæŒ‰ç…§æ¯ç§viewtypeçš„viewholderä¸º5çš„å®¹é‡è¿›è¡Œå›æ”¶ï¼Œå¦‚æœè¶…è¿‡5ä¸ªçš„æ—¶å€™ï¼Œå°±ä¸ä¼šå¾€é‡Œé¢å­˜äº†ã€‚\nç¼“å­˜å¤ç”¨ å¦‚æœæ˜¯åœ¨pre-layouté˜¶æ®µï¼Œä¼šå»changeScrapç¼“å­˜ä¸­é€šè¿‡positionæŸ¥æ‰¾viewholderï¼Œå¦‚æœé€šè¿‡positionæ‰¾ä¸åˆ°ï¼Œåˆ™é€šè¿‡idå»æŸ¥æ‰¾ï¼Œä»changeScrapç¼“å­˜ä¸­å–å‡ºçš„ã€‚ åœ¨pre-layoutå’Œpost-layouté˜¶æ®µä¼šå…ˆä»attachScrapç¼“å­˜ä¸­é€šè¿‡positionæŸ¥æ‰¾viweholderï¼Œå¦‚æœæ²¡æ‰¾åˆ°åˆ™ä¼šä»cacheviewç¼“å­˜ä¸­é€šè¿‡positionæŸ¥æ‰¾viewholderï¼Œå¦‚æœæ²¡æ‰¾åˆ°å†é€šè¿‡idä»attchScrapå’Œcacheviewä¸­æ‰¾viewholderï¼Œå¦‚æœè¿˜æ²¡æ‰¾åˆ°ï¼Œåˆ™ä»ViewCacheExtensionä¸­æ‰¾ï¼Œå¦‚æœè¿˜æ²¡æ‰¾åˆ°åˆ™ä»RecycledViewPoolä¸­æ‰¾ï¼Œå¦‚æœéƒ½æ²¡æ‰¾åˆ°ï¼Œåˆ™åˆ›å»ºviewholderï¼Œç”±äºchangeScrapä¸å‚ä¸post-layouté˜¶æ®µï¼Œæ‰€ä»¥åœ¨post-layouté˜¶æ®µä¼šèµ°åˆ›å»ºè¡¨é¡¹å’Œç»‘å®šè¡¨é¡¹ï¼ŒattachScrapç”±äºæ˜¯ç²¾å‡†åŒ¹é…ï¼Œæ‰€ä»¥æ— éœ€åˆ›å»ºå’Œç»‘å®šï¼Œcacheviewç¼“å­˜ä¹Ÿæ˜¯ç²¾å‡†åŒ¹é…ï¼ŒRecycledViewPoolä¸­çš„viewholderç”±äºéƒ½é‡ç½®äº†ï¼Œæ‰€ä»¥éœ€è¦èµ°ç»‘å®šã€‚\nç¼“å­˜è¯´æ˜ scrapç¼“å­˜åªä¼šåœ¨éæ»‘åŠ¨åœºæ™¯ä¸‹è¿›è¡Œä¿å­˜ï¼Œå¹¶ä¸”å®ƒä¿å­˜çš„æ•°é‡æ˜¯ä¸€å±çš„æ•°æ®ï¼Œè¯¥ç¼“å­˜å¼€å‘æ— æ³•å¹²é¢„ï¼Œcacheviewç¼“å­˜çš„æ˜¯å¯ä»¥ç›´æ¥ç”¨çš„viewholderï¼Œæ— éœ€bindå’Œcreateï¼Œä½†æ˜¯é»˜è®¤å®¹é‡å¾ˆå°ï¼Œå¯ä»¥åŠ¨æ€è®¾ç½®ï¼ŒRecycledViewPoolé‡Œé¢çš„viewholderéƒ½æ˜¯é‡ç½®è¿‡çš„ï¼Œéœ€è¦é‡æ–°bindï¼ŒæŒ‰viewtypeè¿›è¡Œå­˜å‚¨ï¼Œæ¯ç§viewtypeçš„å®¹é‡é»˜è®¤æ˜¯5ï¼Œä¹Ÿæ˜¯å¯ä»¥è®¾ç½®å¤§å°ã€‚è€ŒViewCacheExtensionç¼“å­˜è™½ç„¶æ˜¯æ‰©å±•ç¼“å­˜ï¼Œä½†æ˜¯å¾ˆå°‘å»ç”¨ï¼Œæ‰€ä»¥å¯ä¼˜åŒ–çš„ç¼“å­˜åªæœ‰cacheviewå’ŒRecycledViewPool\nå¦‚ä½•æœ€å¤§åŒ–ä½¿ç”¨ç¼“å­˜ï¼Ÿ å¤šä½¿ç”¨scrapç¼“å­˜æ¥å±€éƒ¨åˆ·æ–° å‰é¢åˆ†æè¿‡ä½¿ç”¨notifyDataSetChangeçš„æ—¶å€™ä¼šä½¿å¯è§çš„viewholderå’Œç¼“å­˜ä¸­çš„viewholderéƒ½å¤±æ•ˆäº†ï¼Œå¯¼è‡´æ‰€æœ‰çš„viewhodleréƒ½ä¼šå…ˆä»poolç¼“å­˜ä¸­æ‰¾ä¸€éï¼Œå¦‚æœæœ‰çš„è¯ï¼Œå°±éœ€è¦é‡æ–°bindï¼Œå¦‚æœæ‰¾ä¸åˆ°åˆ™å…ˆèµ°åˆ›å»ºï¼Œç„¶åèµ°bindè¿‡ç¨‹ï¼Œæ‰€ä»¥å±€éƒ¨åˆ·æ–°ä½¿ç”¨notifyItemChangeå’ŒnotifyItemRemoveï¼Œå¦‚æœåªæ˜¯åˆ·æ–°viewholderä¸­çš„æŸä¸€ä¸ªå­viewï¼Œåˆ™ä½¿ç”¨payloadçš„å½¢å¼ã€‚ ä½¿ç”¨diffutilsæ¥å®ç°å±€éƒ¨åˆ·æ–°ï¼Œæ— éœ€å…³å¿ƒåˆ·æ–°çš„ç´¢å¼•ï¼Œåªéœ€è¦æä¾›å˜åŒ–çš„æ•°æ®æº åˆç†ä½¿ç”¨poolç¼“å­˜ï¼Œå¦‚æœä¸€å±å±•ç¤ºçš„viewholderæ¯”è¾ƒå¤šï¼Œåˆ™å¯ä»¥é€‚å½“å¢åŠ poolç¼“å­˜çš„æœ€å¤§æ•°é‡ï¼Œå‡å°‘é¢‘ç¹åˆ›å»ºviewholder åˆç†è®¾ç½®cacheviewçš„ç¼“å­˜ï¼Œå¦‚æœrecyclerviewéœ€è¦ç»å¸¸æ¥å›æ»‘åŠ¨ï¼Œåˆ™å¯ä»¥é€‚å½“å¢åŠ cacheviewçš„ç¼“å­˜æ•°é‡ é‡å†™adapterçš„getItemIdå¹¶ä¸”ç»™recyclerviewè®¾ç½®setHasStableIdsä¸ºtrueæ¥ç»™æ¯ä¸€ä¸ªviewholderå¢åŠ å”¯ä¸€ç´¢å¼•ï¼Œè¿™æ ·åœ¨ç¼“å­˜æŸ¥æ‰¾çš„æ—¶å€™èƒ½å¢å¤§å¤ç”¨ã€‚ å¦‚æœä¸¤ä¸ªrecyclerviewçš„viewholderæœ‰éƒ¨åˆ†ç›¸åŒæˆ–è€…åŸºæœ¬ç›¸åŒçš„æƒ…å†µä¸‹ï¼Œç»™è¿™ä¸¤ä¸ªrecyclerviewè®¾ç½®åŒä¸€ä¸ªRecycledViewPoolæ¥å¢åŠ viewholderçš„å¤ç”¨åº¦ï¼Œæ³¨æ„æ­¤æ—¶ç»™recyclerviewè®¾ç½®poolçš„æ—¶å€™ï¼Œéœ€è¦åœ¨è®¾ç½®adapterä¹‹å‰ å¦‚æœåŒä¸€ä¸ªrecyclerviewéœ€è¦åˆ‡æ¢è§†å›¾çš„æ—¶å€™ï¼Œå¹¶ä¸”è§†å›¾çš„æ ·å¼æ˜¯ä¸åŒçš„adapterçš„æ—¶å€™ï¼Œæ­¤æ—¶å¯ä»¥è€ƒè™‘ç”¨swapadapteræ¥åˆ‡æ¢adapterï¼Œswapadapteræ˜¯æŠŠattachScrapç»™æ¸…ç©ºï¼Œå¹¶æŠŠcacheviewä¸­çš„ç¼“å­˜åŠ å…¥åˆ°RecycledViewPoolä¸­ï¼Œè€ŒsetAdapteræ˜¯æ¸…ç©ºæ‰€æœ‰çš„ç¼“å­˜ã€‚ç”±äºswapadapteræ˜¯å¤ç”¨äº†RecycledViewPoolä¸­çš„ç¼“å­˜ï¼Œå› æ­¤è¦æ±‚å‰åçš„viewholderæ˜¯åŒä¸€ç§ç±»å‹ï¼Œå¦åˆ™ä¼šå‡ºç°å¼‚å¸¸ã€‚ æ„å»ºè¿‡ç¨‹å¦‚ä½•é™ä½åˆ°æœ€ä½ï¼Ÿ æ‰€è°“æ„å»ºå°±æ˜¯æŒ‡viewholderçš„createè¿‡ç¨‹ï¼Œè¯¥é˜¶æ®µä¸»è¦æ˜¯é€šè¿‡è§£æxmlï¼Œæ¥åˆ›å»ºviewï¼Œè¯¥é˜¶æ®µæ¶‰åŠåˆ°æ–‡ä»¶è¯»å–çš„ioæ“ä½œï¼Œä»¥åŠåå°„ç”Ÿæˆviewã€‚ä¸€èˆ¬æˆ‘ä»¬å¯ä»¥é€šè¿‡åŠ¨æ€åˆ›å»ºviewçš„å½¢å¼æ¥æ¶ˆé™¤ioæ“ä½œå’Œåå°„ç”Ÿæˆviewã€‚æˆ–è€…å°†xmlçš„å±‚çº§é™åˆ°æœ€ä½ï¼Œå‡å°‘inflateçš„æ—¶é—´ã€‚ æå‰è§£æxmlï¼Œç„¶åå­˜æ”¾åˆ°ç¼“å­˜æ± ä¸­ï¼Œç­‰åˆ°ä½¿ç”¨çš„æ—¶å€™ç›´æ¥ä»æ± å­ä¸­å–ã€‚ ç»‘å®šè¿‡ç¨‹å¦‚ä½•é™ä½åˆ°æœ€ä½ï¼Ÿ ç»™è§†å›¾è®¾ç½®ç›‘å¬å™¨çš„æ—¶å€™ï¼Œä¸è¦é€šè¿‡ç›´æ¥åˆ›å»ºlistenerçš„å½¢å¼ï¼Œé€šè¿‡å¤–ç•Œä¼ å…¥è¿›æ¥ï¼Œç„¶ååœ¨å¤–ç•Œå¤„ç†é€»è¾‘ ç»‘å®šè§†å›¾çš„æ—¶å€™ä¸è¦åšè®¡ç®—é€»è¾‘ï¼Œå°†è®¡ç®—é€»è¾‘å‰ç½®åŒ–ï¼Œç»‘å®šåº”è¯¥æ˜¯ä¸€ä¸ªçº¯å±•ç¤ºçš„è¿‡ç¨‹ å…¶å®ƒ å¦‚æœitemçš„å¤§å°æ˜¯å›ºå®šçš„ï¼Œåˆ™ä½¿ç”¨setHasFixedSize(true)ï¼Œè¿™æ ·å¯ä»¥é¿å…åœ¨æ›´æ–°ã€æ·»åŠ ã€åˆ é™¤è¡¨é¡¹çš„æ—¶å€™é‡æ–°requestLayoutï¼Œè€Œè¯¥è¿‡ç¨‹ä¼šç­‰åˆ°ä¸‹ä¸€ä¸ªvsyncä¿¡å·æ¥çš„æ—¶å€™ï¼Œèµ°ç»˜åˆ¶æµç¨‹ï¼Œç„¶åæ‰æ˜¯æµ‹é‡ï¼Œä½¿ç”¨è¯¥æ–¹æ³•åï¼Œä¼šç»™Choreographerå‘é€ä¸€æ¡animtionçš„æ¶ˆæ¯ï¼Œåœ¨ä¸‹ä¸€ä¸ªvsyncæ¥çš„æ—¶å€™ï¼Œç›´æ¥è¿›è¡Œrecyclerviewçš„dispatchLayoutã€‚ å¼€å¯recyclerviewçš„é¢„åŠ è½½ï¼Œrecyclerviewçš„é¢„åŠ è½½é»˜è®¤æ˜¯å¼€å¯çš„ï¼Œå¦‚æœè¦å…³é—­é€šè¿‡layout.setItemPrefetchEnabled(false)æ¥å…³é—­ï¼Œå¦‚æœæ˜¯è‡ªå®šä¹‰layoutmanagerï¼Œåˆ™é€šè¿‡é‡å†™collectAdjacentPrefetchPositionsæ¥å®ç°é¢„åŠ è½½ recyclerviewä¼šåŠ è½½å±å†…å¯è§çš„viewholderï¼Œå¦‚æœviewholderå¯¹åº”çš„itemviewé«˜åº¦æˆ–å®½åº¦å¾ˆå¤§çš„æ—¶å€™ï¼Œå¯èƒ½åŠ è½½çš„å±å¤–viewholderå¾ˆå°‘ï¼Œæ­¤æ—¶é‡å†™layoutmanagerçš„calculateExtraLayoutSpaceæ¥å®ç°å±å¤–çš„viewholderåŠ è½½ï¼Œå…³äºè¿™å—å¯ä»¥çœ‹viewpager2å¦‚ä½•å®ç°çš„å±å¤–viewholderçš„åŠ è½½ã€‚ å‚è€ƒï¼š RecyclerView æ€§èƒ½ä¼˜åŒ– | æŠŠåŠ è½½è¡¨é¡¹è€—æ—¶å‡åŠ (ä¸€) æµ…è°ˆRecyclerViewçš„æ€§èƒ½ä¼˜åŒ– RecyclerViewæ€§èƒ½ä¼˜åŒ–ä¹‹å¼‚æ­¥é¢„åŠ è½½ RecyclerViewçš„é¢„åŠ è½½ ã€åŠ¨ç”»å›¾è§£ã€‘è¿™ä¸ªå€¼å–å¯¹äº†ï¼ŒViewPager2æ‰èƒ½çºµäº«ä¸æ»‘ ","date":"2025-01-13T00:00:00Z","permalink":"https://example.com/p/recyclerview%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/","title":"RecyclerViewæ€§èƒ½ä¼˜åŒ–"},{"content":"å¤§å®¶æœ‰æ²¡æœ‰æƒ³è¿‡ï¼Œscrapç¼“å­˜å­˜åœ¨çš„æ„ä¹‰æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆå­˜äº†åï¼ŒåˆæŠŠå®ƒé‡Œé¢çš„viewholderåˆç»™åˆ äº†ï¼Ÿ\nåœ¨ä¸Šä¸€ç¯‡(RecyclerViewæºç èµ°è¯»)ä¸­æˆ‘ä»¬åˆ†æè¿‡æ›´æ–°å’Œåˆ é™¤è¡¨é¡¹çš„è¿‡ç¨‹ï¼Œä¸‹é¢æ¥æ€»ç»“ä¸‹scrapç¼“å­˜çš„è¿‡ç¨‹ï¼š\næ›´æ–°è¡¨é¡¹:é¡µé¢ä¸Šæœ‰è¡¨é¡¹0åˆ°9ï¼Œæ€»å…±æœ‰10ä¸ªè¡¨é¡¹ï¼Œç„¶åæ›´æ–°è¡¨é¡¹0ï¼Œåœ¨dispatchLayout1é˜¶æ®µï¼ˆpre-layoutï¼‰ï¼Œå…ˆæŠŠé¡µé¢ä¸Šçš„è¡¨é¡¹0åˆ°9å­˜åˆ°scrapç¼“å­˜ä¸­ï¼Œç”±äºè¡¨é¡¹0æ˜¯æ›´æ–°çš„æ‰€ä»¥ä¼šæŠŠè¡¨é¡¹0æ”¾åˆ°changeScrapç¼“å­˜ä¸­ï¼ŒæŠŠè¡¨é¡¹1åˆ°9å­˜åˆ°attachScrapç¼“å­˜ä¸­ã€‚åŒæ—¶ä¼šæŠŠè¿™10ä¸ªè¡¨é¡¹ä»é¡µé¢ä¸Šåˆ†ç¦»ï¼ˆchildçš„parentç½®ç©ºï¼Œå¹¶æŠŠviewgroupä¸­å¯¹åº”çš„childç»™ç½®ç©ºï¼‰ï¼Œæ¥ç€ä»scrapç¼“å­˜ä¸­å–å‡ºviewholderï¼Œç”±äºå­˜åœ¨æ›´æ–°è¡¨é¡¹ï¼Œæ‰€ä»¥ä¼šå»åˆ›å»ºè¡¨é¡¹10çš„viewholderåˆ°recyclerviewä¸Šã€‚æ­¤æ—¶recyclerviewä¸­æœ‰11ä¸ªè¡¨é¡¹äº†ï¼ŒåŒæ—¶æŠŠä»–ä»¬ä»scrapç¼“å­˜ä¸­ç§»é™¤ã€‚ åœ¨dispatchLayout2é˜¶æ®µï¼ˆpost-layoutï¼‰é˜¶æ®µï¼Œä¼šæŠŠè¿™11ä¸ªè¡¨é¡¹åŠ å…¥åˆ°scrapç¼“å­˜ä¸­ï¼Œè¡¨é¡¹0è¿˜æ˜¯æ”¾åˆ°changeScrapä¸­ï¼Œè¡¨é¡¹1åˆ°10åŠ å…¥åˆ°attachScrapç¼“å­˜ä¸­ã€‚æ¥ç€æŠŠä»–ä»¬ä»é¡µé¢ä¸Šåˆ†ç¦»ã€‚ç„¶ååœ¨fillä¸­ï¼Œä»scrapç¼“å­˜ä¸­è·å–viewholderï¼Œç”±äºchangeScrapä¸ä¼šåœ¨dispatchLayout2é˜¶æ®µç”Ÿæ•ˆï¼Œæ‰€ä»¥ä¼šåˆ›å»ºäº†è¡¨é¡¹0ï¼Œå…¶ä½™çš„è¡¨é¡¹æ­£å¸¸ä»attachScrapç¼“å­˜ä¸­è·å–ã€‚æ¥ç€æŠŠæ‰€æœ‰çš„è¡¨é¡¹æ·»åŠ åˆ°recyclerviewä¸­ï¼Œå¹¶æŠŠscrapä¸­çš„viewholderç¼“å­˜ç§»é™¤æ‰ã€‚ä½†æ˜¯è¡¨é¡¹10ä¸ä¼šæ·»åŠ åˆ°recyclerviewä¸­ï¼Œå› ä¸ºåˆ°è¡¨é¡¹9çš„æ—¶å€™ï¼Œå‰©ä½™ç©ºé—´å°±ä¸å¤Ÿäº†ï¼Œæ‰€ä»¥recyclerviewä¸­åªæœ‰0åˆ°9çš„è¡¨é¡¹ã€‚æ³¨æ„ï¼šæ­¤æ—¶è¿˜æœ‰è¡¨é¡¹0ä¸ªè¡¨é¡¹10åˆ†åˆ«å­˜åœ¨äºchangeScrapå’ŒattachScrapä¸­ã€‚\nä¸Šé¢æ›´æ–°è¡¨é¡¹ç»å†äº†ä¸¤æ¬¡çš„å¸ƒå±€ï¼Œåˆ†åˆ«æ˜¯dispatchLayout1å’ŒdispatchLayout2ï¼Œåœ¨è¿™ä¸¤ä¸ªæ­¥éª¤ä¸­ï¼Œå…ˆåŠ å…¥åˆ°scrapç¼“å­˜ä¸­ï¼Œç„¶åå†ä»scrapç¼“å­˜ä¸­ç§»é™¤ã€‚ä»ç°è±¡æ¥çœ‹ï¼ŒdispatchLayout1ä¸­ä¼šç”Ÿæˆ11ä¸ªè¡¨é¡¹ï¼Œåˆ†åˆ«æ˜¯0åˆ°10ï¼Œç„¶ååœ¨dispatchLayout2å…ˆç§»é™¤æ‰€æœ‰çš„è¡¨é¡¹ï¼Œç„¶åæ·»åŠ 0åˆ°9çš„è¡¨é¡¹ï¼Œè€Œåœ¨dispatchLayout2ä¸­è¡¨é¡¹0æ˜¯é‡æ–°ç”Ÿæˆçš„ï¼Œå› ä¸ºå®ƒè¦å®ç°æ›´æ–°ã€‚è€Œè°ƒç”¨ä¸¤æ¬¡çš„å¸ƒå±€æ˜¯ä¸ºäº†å®ç°åŠ¨ç”»è€Œè¿™ä¹ˆåšï¼Œå…ˆç”Ÿæˆ11ä¸ªè¡¨é¡¹ï¼Œæ¥æŠŠä»–ä»¬çš„ä½ç½®éƒ½è®°å½•ä¸‹æ¥ï¼Œç„¶åç¬¬äºŒæ¬¡å¸ƒå±€çš„æ—¶å€™æŠŠ10ä¸ªè¡¨é¡¹çš„ä½ç½®ä¹Ÿè®°å½•ä¸‹æ¥ï¼Œç„¶åæœ€åæ ¹æ®å­˜å‚¨çš„ä½ç½®ä¿¡æ¯åšåŠ¨ç”»ã€‚ä¸‹é¢æ¥åˆ†æä¸‹åŠ¨ç”»å¦‚ä½•å®ç°çš„ï¼š\nåœ¨dispatchLayoutStep1å°†é¡µé¢ä¸Šå¯è§çš„è¡¨é¡¹åŠ å…¥åˆ°ViewInfoStoreä¸­ï¼š 1 2 3 4 5 6 7 8 9 void addToPreLayout(RecyclerView.ViewHolder holder, RecyclerView.ItemAnimator.ItemHolderInfo info) { InfoRecord record = mLayoutHolderMap.get(holder); if (record == null) { record = InfoRecord.obtain(); mLayoutHolderMap.put(holder, record); } record.preInfo = info; record.flags |= FLAG_PRE; } å°†viewholderå’ŒinfoRecordç»‘å®šå¥½å…³ç³»ï¼Œç„¶åç»™è¯¥recordæ·»åŠ ä¸ŠFLAG_PREæ ‡è®°ã€‚æ³¨æ„ï¼šæ­¤å¤„çš„InforRecordä½¿ç”¨äº†å¯¹è±¡æ± ã€‚ å‰é¢åˆ†æè¿‡åœ¨fillå®Œä¹‹åï¼Œé¡µé¢ä¸Šä¼šå¤šå‡ºä¸€ä¸ªè¡¨é¡¹10ï¼Œæ­¤æ—¶ä¹Ÿä¼šæ·»åŠ åˆ°ViewInfoStoreä¸­ï¼š å¯ä»¥çœ‹åˆ°åœ¨onLayoutChildrenä¹‹åä¼šè°ƒç”¨addToAppearedInPreLayoutHoldersï¼Œæ­¤æ—¶åªæœ‰è¡¨é¡¹10ä¼šè°ƒç”¨addToAppearedInPreLayoutHoldersï¼š\n1 2 3 4 5 6 7 8 9 void addToAppearedInPreLayoutHolders(RecyclerView.ViewHolder holder, RecyclerView.ItemAnimator.ItemHolderInfo info) { InfoRecord record = mLayoutHolderMap.get(holder); if (record == null) { record = InfoRecord.obtain(); mLayoutHolderMap.put(holder, record); } record.flags |= FLAG_APPEAR; record.preInfo = info; } æ‰€ä»¥åªæœ‰è¡¨é¡¹10æ·»åŠ äº†FLAG_APPEARæ ‡è®°ã€‚\nåœ¨dispatchLayoutStep2èµ°å®Œåï¼Œé¡µé¢ä¸Šå¯è§çš„è¡¨é¡¹å°±åªå‰©0åˆ°9äº†ï¼Œåœ¨dispatchLayoutStep3ä¸­å°†å˜åŒ–çš„viewholderè°ƒç”¨animateChangeï¼Œè€Œå…¶ä»–çš„viewholderè°ƒç”¨äº†addToPostLayoutï¼Œåœ¨è¯¥ä¾‹å­ä¸­è¡¨é¡¹0ä¼šè°ƒç”¨animateChangeï¼Œè¡¨é¡¹1åˆ°9ä¼šè°ƒç”¨addToPostLayoutï¼š\nanimateChangeï¼šå½“æœ‰viewholderå‘ç”Ÿå˜åŒ–çš„æ—¶å€™ï¼Œä¼šè§¦å‘è¯¥æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šè§¦å‘mItemAnimatorçš„animateChangeæ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 private void animateChange(@NonNull ViewHolder oldHolder, @NonNull ViewHolder newHolder, @NonNull ItemHolderInfo preInfo, @NonNull ItemHolderInfo postInfo, boolean oldHolderDisappearing, boolean newHolderDisappearing) { //çœç•¥ä»£ç  if (mItemAnimator.animateChange(oldHolder, newHolder, preInfo, postInfo)) { postAnimationRunner(); } } è°ƒç”¨äº†mItemAnimatorçš„animateChangeæ–¹æ³•ï¼Œå¹¶æŠŠæ”¹å˜ä¹‹å‰çš„holderã€itemholderinfoå’Œæ”¹å˜ä¹‹åçš„holderã€itemholderinfoä¼ è¿›å»äº†ï¼Œé»˜è®¤çš„itemAnimatoræ˜¯DefaultItemAnimatorï¼Œä¹Ÿæ˜¯ä¸€ä¸ªSimpleItemAnimator:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 @Override public boolean animateChange(@NonNull RecyclerView.ViewHolder oldHolder, @NonNull RecyclerView.ViewHolder newHolder, @NonNull ItemHolderInfo preInfo, @NonNull ItemHolderInfo postInfo) { if (DEBUG) { Log.d(TAG, \u0026#34;CHANGED: \u0026#34; + oldHolder + \u0026#34; with view \u0026#34; + oldHolder.itemView); } final int fromLeft = preInfo.left; final int fromTop = preInfo.top; final int toLeft, toTop; if (newHolder.shouldIgnore()) { toLeft = preInfo.left; toTop = preInfo.top; } else { toLeft = postInfo.left; toTop = postInfo.top; } return animateChange(oldHolder, newHolder, fromLeft, fromTop, toLeft, toTop); } fromLeftã€fromTopæ˜¯è€çš„holderçš„åæ ‡ï¼ŒtoLeftã€toTopæ˜¯æ–°çš„holderçš„åæ ‡ï¼Œæœ€åè°ƒç”¨äº†å¦å¤–ä¸€ä¸ªanimateChangeï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 @Override public boolean animateChange(RecyclerView.ViewHolder oldHolder, RecyclerView.ViewHolder newHolder, int fromX, int fromY, int toX, int toY) { if (oldHolder == newHolder) { // Don\u0026#39;t know how to run change animations when the same view holder is re-used. // run a move animation to handle position changes. return animateMove(oldHolder, fromX, fromY, toX, toY); } final float prevTranslationX = oldHolder.itemView.getTranslationX(); final float prevTranslationY = oldHolder.itemView.getTranslationY(); final float prevAlpha = oldHolder.itemView.getAlpha(); resetAnimation(oldHolder); int deltaX = (int) (toX - fromX - prevTranslationX); int deltaY = (int) (toY - fromY - prevTranslationY); // recover prev translation state after ending animation oldHolder.itemView.setTranslationX(prevTranslationX); oldHolder.itemView.setTranslationY(prevTranslationY); oldHolder.itemView.setAlpha(prevAlpha); if (newHolder != null) { // carry over translation values resetAnimation(newHolder); newHolder.itemView.setTranslationX(-deltaX); newHolder.itemView.setTranslationY(-deltaY); newHolder.itemView.setAlpha(0); } mPendingChanges.add(new ChangeInfo(oldHolder, newHolder, fromX, fromY, toX, toY)); return true; } å¦‚æœæ–°è€holderæ˜¯åŒä¸€ä¸ªï¼Œåˆ™è°ƒç”¨animateMoveï¼Œå‰é¢åˆ†æè¿‡oldHolderå’ŒnewHolderä¸æ˜¯åŒä¸€ä¸ªï¼Œæ‰€ä»¥å…ˆæŠŠnewHolderçš„translationXå’ŒtranslationXè®¾ç½®åˆ°ç›®æ ‡ä½ç½®ï¼Œå…¶å®æ­¤æ—¶çš„deltaXå’ŒdeltaYä¸º0ï¼Œå› ä¸ºç›®æ ‡çš„viewholderä½ç½®ä¹Ÿåœ¨åŸæ¥è¡¨é¡¹0çš„ä½ç½®ï¼Œæ¥ç€æŠŠé€æ˜åº¦è®¾ç½®ä¸º0ï¼Œæœ€ååˆ›å»ºäº†ChangeInfoï¼Œæ”¾å…¥åˆ°mPendingChangesä¸­ã€‚å½“animateChangeè¿”å›trueåï¼Œä¼šè°ƒç”¨postAnimationRunneræ–¹æ³•ï¼š\n1 2 3 4 5 6 void postAnimationRunner() { if (!mPostedAnimatorRunner \u0026amp;\u0026amp; mIsAttached) { ViewCompat.postOnAnimation(this, mItemAnimatorRunner); mPostedAnimatorRunner = true; } } ViewCompat.postOnAnimation(this, mItemAnimatorRunner)æ˜¯ç»™Choreographerä¸­æ·»åŠ ä¸€æ¡CALLBACK_ANIMATIONç±»å‹çš„äº‹ä»¶ï¼Œç­‰åˆ°ä¸‹ä¸€ä¸ªvsyncä¿¡å·æ¥çš„æ—¶å€™ï¼Œå°±ä¼šæ‰§è¡ŒmItemAnimatorRunnerï¼š\n1 2 3 4 5 6 7 8 9 private Runnable mItemAnimatorRunner = new Runnable() { @Override public void run() { if (mItemAnimator != null) { mItemAnimator.runPendingAnimations(); } mPostedAnimatorRunner = false; } }; æœ€ç»ˆä¼šæ‰§è¡ŒDefaultItemAnimatorçš„runPendingAnimationsæ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šæ‰§è¡ŒchangesPendingçš„é€»è¾‘ï¼Œæœ€ç»ˆä¼šæ‰§è¡ŒanimateChangeImplï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 void animateChangeImpl(final ChangeInfo changeInfo) { final RecyclerView.ViewHolder holder = changeInfo.oldHolder; final View view = holder == null ? null : holder.itemView; final RecyclerView.ViewHolder newHolder = changeInfo.newHolder; final View newView = newHolder != null ? newHolder.itemView : null; if (view != null) {//æ”¹å˜ä¹‹å‰çš„view final ViewPropertyAnimator oldViewAnim = view.animate().setDuration( getChangeDuration()); mChangeAnimations.add(changeInfo.oldHolder); oldViewAnim.translationX(changeInfo.toX - changeInfo.fromX); oldViewAnim.translationY(changeInfo.toY - changeInfo.fromY); oldViewAnim.alpha(0).setListener(new AnimatorListenerAdapter() { @Override public void onAnimationStart(Animator animator) { dispatchChangeStarting(changeInfo.oldHolder, true); } @Override public void onAnimationEnd(Animator animator) { oldViewAnim.setListener(null); view.setAlpha(1); view.setTranslationX(0); view.setTranslationY(0); dispatchChangeFinished(changeInfo.oldHolder, true); mChangeAnimations.remove(changeInfo.oldHolder); dispatchFinishedWhenDone(); } }).start(); } if (newView != null) {//æ”¹å˜ä¹‹åçš„view final ViewPropertyAnimator newViewAnimation = newView.animate(); mChangeAnimations.add(changeInfo.newHolder); newViewAnimation.translationX(0).translationY(0).setDuration(getChangeDuration()) .alpha(1).setListener(new AnimatorListenerAdapter() { @Override public void onAnimationStart(Animator animator) { dispatchChangeStarting(changeInfo.newHolder, false); } @Override public void onAnimationEnd(Animator animator) { newViewAnimation.setListener(null); newView.setAlpha(1); newView.setTranslationX(0); newView.setTranslationY(0); dispatchChangeFinished(changeInfo.newHolder, false); mChangeAnimations.remove(changeInfo.newHolder); dispatchFinishedWhenDone(); } }).start(); } } è¯¥æ–¹æ³•é‡Œé¢é€šè¿‡viewçš„animateæ–¹æ³•ç»™viewåšåŠ¨ç”»ï¼Œæ”¹å˜ä¹‹å‰çš„viewä½ç½®ä¸ä¼šå‘ç”Ÿå˜åŒ–ï¼Œåªä¼šå‘ç”Ÿalphaçš„åŠ¨ç”»ï¼Œè€Œæ”¹å˜ä¹‹åçš„viewä¼šåšä»0åˆ°1çš„é€æ˜åº¦åŠ¨ç”»ã€‚æ‰€ä»¥æœ€ç»ˆé¡µé¢ä¸Šä¼šå‡ºç°é—ªçš„ä¸€ä¸‹ï¼Œè¿™ä¸ªæ˜¯åšæ›´æ–°æ“ä½œã€‚ ä¸Šé¢åˆ†æçš„æ˜¯è¡¨é¡¹0ä¼šè°ƒç”¨animateChangeï¼Œè¡¨é¡¹1åˆ°9ä¼šæ‰§è¡ŒaddToPostLayoutï¼š\n1 2 3 4 5 6 7 8 9 void addToPostLayout(RecyclerView.ViewHolder holder, RecyclerView.ItemAnimator.ItemHolderInfo info) { InfoRecord record = mLayoutHolderMap.get(holder); if (record == null) { record = InfoRecord.obtain(); mLayoutHolderMap.put(holder, record); } record.postInfo = info; record.flags |= FLAG_POST; } åœ¨dispatchLayout1çš„æ—¶å€™ï¼Œè¡¨é¡¹1åˆ°9ä¼šæ·»åŠ ä¸ŠFLAG_PREæ ‡è®°ï¼Œæ¥ç€åœ¨æ­¤å¤„åˆæ·»åŠ ä¸ŠFLAG_POSTæ ‡è®°ï¼Œè¡¨é¡¹10æ·»åŠ äº†FLAG_APPEARæ ‡è®°ã€‚æ‰€æœ‰çš„æ ‡è®°æ·»åŠ å®Œåï¼Œæœ€ç»ˆä¼šæ‰§è¡ŒViewInfoStoreçš„processï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 void process(ProcessCallback callback) { for (int index = mLayoutHolderMap.size() - 1; index \u0026gt;= 0; index--) { final RecyclerView.ViewHolder viewHolder = mLayoutHolderMap.keyAt(index); final InfoRecord record = mLayoutHolderMap.removeAt(index); if ((record.flags \u0026amp; FLAG_PRE_AND_POST) == FLAG_PRE_AND_POST) { // Persistent in both passes. Animate persistence callback.processPersistent(viewHolder, record.preInfo, record.postInfo); } else if ((record.flags \u0026amp; FLAG_APPEAR) != 0) { // Scrap view. RecyclerView will handle removing/recycling this. } InfoRecord.recycle(record); } } è¿™é‡Œçœç•¥äº†æ— å…³ç´§è¦çš„ä»£ç ï¼Œè¡¨é¡¹1åˆ°9ä¼šè°ƒç”¨callback.processPersistentå›è°ƒï¼Œè¡¨é¡¹10ä¸åšç›¸å…³æ›´æ–°ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 @Override public void processPersistent(ViewHolder viewHolder, @NonNull ItemHolderInfo preInfo, @NonNull ItemHolderInfo postInfo) { viewHolder.setIsRecyclable(false); if (mDataSetHasChangedAfterLayout) { // since it was rebound, use change instead as we\u0026#39;ll be mapping them from // stable ids. If stable ids were false, we would not be running any // animations if (mItemAnimator.animateChange(viewHolder, viewHolder, preInfo, postInfo)) { postAnimationRunner(); } } else if (mItemAnimator.animatePersistence(viewHolder, preInfo, postInfo)) { postAnimationRunner(); } } ç”±äºmDataSetHasChangedAfterLayoutæ˜¯åœ¨setAdapterä¸­è®¾ç½®çš„ï¼Œæ‰€ä»¥ä¼šèµ°mItemAnimator.animateChangeé€»è¾‘ï¼Œåœ¨ä¸Šé¢åˆ†æè¿‡ï¼Œå¦‚æœä¸¤ä¸ªviewholderæ˜¯åŒä¸€ä¸ªï¼Œåˆ™è°ƒç”¨animateMoveæ–¹æ³•ï¼Œè€Œä½ç½®ä¿¡æ¯åˆä¸å‘ç”Ÿå˜åŒ–ï¼Œæ‰€ä»¥animateChangeè¿”å›falseï¼Œå› æ­¤ä¹Ÿä¸ä¼šè§¦å‘postAnimationRunnerã€‚\nrecyclerviewä¸­åªè¦è¢«æ·»åŠ åˆ°é¡µé¢ä¸Šçš„viewholderï¼Œå¹¶ä¸”æ˜¯scrapç¼“å­˜ä¸­çš„ï¼Œæœ€ç»ˆéƒ½ä¼šä»scrapç¼“å­˜ä¸­ç§»é™¤ã€‚è€Œåœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œåˆ†ædispatchLayout2çš„æ—¶å€™æ€»å…±æœ‰11ä¸ªè¡¨é¡¹ï¼Œåˆ†åˆ«æ˜¯åŸæ¥çš„è¡¨é¡¹0ï¼ˆå­˜åœ¨äºchangeScrapç¼“å­˜ä¸­ï¼‰ï¼ŒdispatchLayout1åˆ›å»ºçš„è¡¨é¡¹10ï¼ˆå­˜åœ¨äºattachScrapä¸­ï¼‰ã€‚åœ¨dispatchLayout3åšå®ŒåŠ¨ç”»åï¼Œä¼šæ¸…ç©ºæ‰scrapç¼“å­˜ï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨äº†mLayout.removeAndRecycleScrapIntæ–¹æ³•ï¼š\n1 2 3 4 5 void removeAndRecycleScrapInt(Recycler recycler) { //çœç•¥ä»£ç  recycler.clearScrap(); //çœç•¥ä»£ç  } æœ€ç»ˆä¼šè°ƒç”¨clearScrapæ¥æ¸…ç©ºscrapç¼“å­˜ã€‚\nå…³äºåˆ é™¤è¡¨é¡¹çš„åŠ¨ç”»å¤„ç†ï¼Œå¯ä»¥çœ‹è¿™é‡Œ:RecyclerView åŠ¨ç”»åŸç† | å¦‚ä½•å­˜å‚¨å¹¶åº”ç”¨åŠ¨ç”»å±æ€§å€¼ï¼Ÿ\n","date":"2025-01-09T00:00:00Z","permalink":"https://example.com/p/recyclerview%E5%8A%A8%E7%94%BB%E5%8E%9F%E7%90%86/","title":"RecyclerViewåŠ¨ç”»åŸç†"},{"content":"åˆå§‹åŒ–è¿‡ç¨‹ å½“æˆ‘ä»¬appæ”¶åˆ°choregrapherçš„vsyncä¿¡å·çš„æ—¶å€™ï¼Œchoregrapherä¸­ä¼šç»™ä¸»çº¿ç¨‹çš„messageQueueå‘é€ä¸€æ¡æ¶ˆæ¯ï¼Œ å‘Šè¯‰appéœ€è¦ç»˜åˆ¶äº†ï¼Œè€Œæ­¤æ—¶å‘é€æ˜¯é€šè¿‡ç»™ä¸»çº¿ç¨‹çš„messageQueueè®¾ç½®ä¸€ä¸ªcallbackï¼ˆrunnableï¼‰ï¼Œæ‰€ä»¥ä¼šè§¦å‘handlerçš„dispatchmessage-\u0026gt;handleCallbackï¼Œæ¥ç€å°±æ˜¯è§¦å‘FrameDisplayEventReceiverï¼ˆrunnableï¼‰çš„doframeæ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šè®¡ç®—ä¸¢å¸§æ•°ï¼Œä»¥åŠæ‰§è¡Œcallbackqueueæ•°ç»„ä¸­çš„callbackqueueï¼Œä¹Ÿå°±æ‰§è¡Œåˆ°äº†æˆ‘ä»¬çš„performTraversalæ–¹æ³•ï¼Œè¯¥æ–¹æ³•é‡Œé¢ä¼šæ‰§è¡Œåˆ°measureï¼Œæœ€åæ‰§è¡Œåˆ°recyclerviewçš„onMeauseï¼Œrecyclerviewçš„onMeasureä¸­ä¼šåˆ¤æ–­è‡ªå·±çš„æµ‹é‡æ¨¡å¼ï¼Œå¦‚æœæ˜¯ç²¾ç¡®çš„æ¨¡å¼ï¼Œåˆ™ä¸æµ‹é‡å­itemã€‚\ntraceå›¾å¦‚ä¸‹ï¼š æ¥ç€èµ°åˆ°recyclerviewçš„onlayoutï¼Œåœ¨onlayouté‡Œé¢è§¦å‘dispatchlayoutï¼Œè¯¥æ–¹æ³•é‡Œé¢ä¼šåˆ¤æ–­stateçš„stepï¼Œé»˜è®¤æ˜¯STEP_STARTï¼Œå› æ­¤ä¼šè§¦å‘dispatchLayoutStep1å’ŒdispatchLayoutStep2ï¼Œåœ¨dispatchLayoutStep1ä¸­å¦‚æœæœ‰åŠ¨ç”»è¦å¤„ç†ï¼Œåˆ™ä¼šè§¦å‘layoutManagerçš„onlayoutChildren\næœ‰åŠ¨ç”»çš„æ¡ä»¶æ˜¯ï¼š æœ‰è¡¨é¡¹æ–°å¢æˆ–ç§»é™¤ã€æœ‰æ›´æ”¹çš„æ—¶å€™ã€‚é»˜è®¤æ˜¯æ²¡æœ‰åŠ¨ç”»è¦å¤„ç†ï¼Œç´§æ¥ç€æ¥åˆ°äº†dispatchLayout2ï¼Œè¯¥æ–¹æ³•ä¸»è¦æ˜¯è§¦å‘äº†layoutManager.onLayoutChildrenã€‚ è°ƒç”¨é“¾å¦‚ä¸‹ï¼š linearlayoutmanager.fill-\u0026gt;layoutmanager.layoutChunk-\u0026gt;layoutstate.next-\u0026gt;recycler.getviewforposition-\u0026gt;recycler.tryGeyViewHolderForPostionByDeadline-\u0026gt;adapter.createViewHolder-\u0026gt;adapter.bindViewHolderåˆ°è¿™é‡Œä¸€ä¸ªholderçš„åˆ›å»ºäºbindè¿‡ç¨‹å°±ç»“æŸäº†ï¼Œç´§æ¥ç€åœ¨layoutchunkä¸­è§¦å‘layoutmanager.addViewå’Œlayoutmanager.measureChildWithMarginï¼Œåˆ°è¿™é‡Œè¡¨é¡¹æ‰ä¼šè¢«åŠ å…¥åˆ°recyclerviewä¸­ï¼Œä½†æ˜¯æ­¤æ—¶ä¸ä¼šåˆ·æ–°recyclerviewã€‚ ä¸Šé¢è¯´åˆ°çš„layoutchunkä¼šåœ¨ä¸€ä¸ªwhileå¾ªç¯ä¸­å¤šæ¬¡æ‰§è¡Œï¼Œç›´åˆ°recyclerviewçš„ç©ºé—´æ²¡æœ‰äº†æ‰ä¸ä¼šæ‰§è¡Œï¼Œè€Œlayoutchunkåˆä¼šèµ°recycler.nextå»ä»ç¼“å­˜ä¸­æ‹¿viewholderï¼Œè€Œæ­¤æ—¶ç¼“å­˜ä¸­æ²¡æœ‰viewholderï¼Œå› æ­¤ä¼šèµ°createviewholderå’Œbindviewholderï¼Œæ‰€ä»¥ä¸€å¼€å§‹createå’Œbindæ¬¡æ•°æ˜¯ä¸€å±èƒ½å±•ç¤ºå¤šå°‘ä¸ªè¡¨é¡¹çš„æ¬¡æ•°ã€‚ æ¥ç€åœ¨dispatchlayoutä¸­ä¼šè°ƒç”¨dispatchlayoutstep3ï¼Œè¯¥æ–¹æ³•é‡Œé¢ä¸»è¦æ˜¯æ‰§è¡Œscrapç¼“å­˜çš„é‡Šæ”¾ï¼Œä»¥åŠåŠ¨ç”»çš„æ‰§è¡Œ\nåˆ°è¿™é‡Œï¼Œæµ‹é‡å’Œlayoutå·²ç»æ¢³ç†å®Œäº†ï¼Œæœ€åå°±å‰©drawäº†ï¼š drawé‡Œé¢åŸºæœ¬æ²¡å¹²ä»€ä¹ˆï¼Œè¿˜æ˜¯æ²¿ç”¨äº†viewgroupçš„drawchildæ–¹æ³•ï¼Œç»¿è‰²è¡¨ç¤ºéç³»ç»Ÿæ–¹æ³•ï¼Œå› æ­¤å¯ä»¥çœ‹å‡ºæ¥recyclerviewæ˜¯é‡å†™äº†è¯¥æ–¹æ³•ï¼š æ€»ç»“ï¼š åˆå§‹åŒ–åˆ†ä¸ºonmeasureé˜¶æ®µï¼šå¦‚æœrecyclerviewè®¾ç½®äº†å›ºå®šå®½é«˜ï¼Œåˆ™ç›´æ¥è·³è¿‡æµ‹é‡ï¼Œè°ƒç”¨åˆ°mLayoutä¸­ï¼Œå¦‚æœä¸æ˜¯å›ºå®šå®½é«˜ï¼Œåˆ™ä¼šèµ°dispatchLayoutStep1ï¼ŒdispatchLayoutStep2ã€‚å…¶ä¸­dispatchLayoutStep1æ˜¯é¢„å¸ƒå±€å¤„ç†ï¼Œå¦‚æœæœ‰åŠ¨ç”»è¦å¤„ç†æ‰ä¼šåœ¨è¯¥é˜¶æ®µè°ƒç”¨åˆ°layoutçš„onLayoutChildrenã€‚åœ¨dispatchLayoutStep2ä¸­å¤„ç†è¡¨é¡¹çš„æµ‹é‡ã€‚ åœ¨onlayouté˜¶æ®µï¼šä¼šåˆ¤æ–­stepè¿˜æ˜¯ä¸æ˜¯startçŠ¶æ€ï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œåˆ™å†æ¬¡æ‰§è¡ŒdispatchLayoutStep1å’ŒdispatchLayoutStep2ã€‚æœ€åè°ƒç”¨dispatchLayoutStep3ç”¨æ¥åšåŠ¨ç”»æ‰§è¡Œå¹¶é‡Šæ”¾ç›¸å…³èµ„æºã€‚ åœ¨drawé˜¶æ®µåŸºæœ¬ä»€ä¹ˆéƒ½æ²¡åšï¼ŒdispatchDrawæœ¬èº«ä¼šè°ƒç”¨åˆ°drawChildï¼Œrecyclerviewåªæ˜¯é‡å†™äº†è¯¥æ–¹æ³•ã€‚\næ»‘åŠ¨è¿‡ç¨‹ æ»‘åŠ¨è¿‡ç¨‹ä¸­ä¼šè°ƒç”¨åˆ°scrollByInternal-\u0026gt;layoutmanager.scrollBy-\u0026gt;fill-\u0026gt;layoutchunckã€‚ layoutchuncké‡Œé¢ä¼šä»ç¼“å­˜ä¸­å–æ•°æ®ï¼Œå¦‚æœæœ‰åˆ™å‘½ä¸­ï¼Œæ²¡æœ‰åˆ™èµ°createå’Œbindï¼Œæ¥ç€åˆ’å‡ºå±å¹•çš„è¡¨é¡¹ä¼šå…ˆåŠ å…¥åˆ°cacheç¼“å­˜ä¸­ï¼Œå¦‚æœcacheç¼“å­˜æ»¡äº†ï¼Œåˆ™é‡ç½®è¯¥è¡¨é¡¹ï¼ŒåŠ å…¥åˆ°recyclerpoolä¸­ï¼Œä¸‹æ¬¡æ‰€ä»¥å–çš„æ—¶å€™ä»recyclerpoolæ ¹æ®viewtypeå–éœ€è¦é‡æ–°bindï¼Œä¸éœ€è¦createï¼Œæ‰€ä»¥åœ¨æ»‘åŠ¨è¿‡ç¨‹ä¸­createçš„æ¬¡æ•°æ˜¯cacheçš„å¤§å°æ¬¡æ•°ï¼Œç­‰åˆ°recyclerpoolä¸­æœ‰ç¼“å­˜çš„æ—¶å€™å°±ä¸éœ€è¦createäº†ã€‚\nåœ¨fillè¿‡ç¨‹ä¸­ï¼Œä¼šæ‰¾åˆ°åˆ’å‡ºå±å¹•çš„è¡¨é¡¹ï¼Œç„¶åå…ˆè°ƒç”¨recycleByLayoutStateï¼Œæ¥ç€è°ƒç”¨åˆ°äº†Linearlayoutmanager.recycleChildrenï¼Œæ¥ç€ä¼šè§¦å‘recyclerview.removeAndRecycleViewAtæ–¹æ³•ï¼Œæ¥ç€å°±è§¦å‘äº†adapter.onViewDetachedFromWindow(viewHolder)ï¼Œæ¥ç€å°±æŠŠviewholderç¼“å­˜åˆ°cacheå’Œrecyclerpoolä¸­ï¼Œå¯¹åº”çš„æ–¹æ³•æ˜¯recycler.recycleView-\u0026gt;recycleViewHolderInternal,å…¶ä¸­cacheç¼“å­˜ä¸­é»˜è®¤æ˜¯2ä¸ªï¼Œå¦‚æœå¤§äº2çš„è¯ï¼Œä¼šæŠŠæœ€å‰é¢çš„é‚£ä¸ªç»™æ”¾åˆ°recyclerpoolä¸­ï¼Œæ¥ç€å†æŠŠæ–°çš„viewholderæ”¾è¿›æ¥ã€‚\nåœ¨fiilè¿‡ç¨‹ä¸­ï¼Œä¼šé€šè¿‡LayoutState.nextä»ç¼“å­˜ä¸­è·å–viewholderï¼Œè·å–çš„æ—¶å€™ä¼šå…ˆåˆ¤æ–­æ˜¯ä¸æ˜¯preLayoutçŠ¶æ€ï¼Œå¦‚æœæ˜¯åˆ™ä»changeScrapç¼“å­˜ä¸­è·å–ï¼Œä»changeScrapä¸­è·å–ç¼“å­˜å…ˆé€šè¿‡positionè·å–ï¼Œå¦‚æœç”¨positionè·å–ä¸åˆ°ï¼Œåˆ™å†ç”¨idå»è·å–ï¼ˆå¿…é¡»adapterè®¾ç½®setHasStableIdsä¸ºtrueï¼Œå¹¶ä¸”adapteré‡å†™äº†getItemIdï¼‰ã€‚å¦‚æœæ²¡è·å–åˆ°åˆ™ä»attacheScrapå’Œcacheä¸­è·å–ï¼Œå¦‚æœä»attachå’Œcacheä¸­æ‰¾ä¸åˆ°ï¼Œåˆ™ç»§ç»­é€šè¿‡idä»attachScrapä¸­è·å–ï¼Œå¦‚æœè¿˜æ²¡è·å–åˆ°åˆ™ä»viewcacheExtensionä¸­å»è·å–ï¼Œå¦‚æœè¿˜è·å–ä¸åˆ°åˆ™å†ä»recyclerpoolä¸­å»è·å–ï¼Œå¦‚æœè¿˜è·å–ä¸åˆ°åˆ™é€šè¿‡createæ¥åˆ›å»ºviewholderï¼Œæ¥ç€èµ°bindé€»è¾‘ã€‚\næ‰€ä»¥æ•´ä¸ªç¼“å­˜è·å–é¡ºåºï¼š changeScrap(preLayoutçŠ¶æ€ï¼Œå…ˆé€šè¿‡positionè·å–ï¼Œæ²¡è·å–åˆ°å†é€šè¿‡idè·å–)-\u0026gt;attacheScrap-\u0026gt;cache-\u0026gt;attachScrap(idæ–¹å¼è·å–)-\u0026gt;viewcacheExtension-\u0026gt;recyclerpool-\u0026gt;createholder-\u0026gt;bindholder è¿™å°±æ˜¯layoutstate.nextè·å–viewholderæ•´ä¸ªé€»è¾‘ï¼Œä¸Šé¢å“ªäº›ä¼šè§¦å‘createholderå’Œbindholder å¦‚æœä»å‡ ä¸ªç¼“å­˜ä¸­éƒ½æ‹¿ä¸åˆ°viewholderï¼Œåˆ™ä¼šèµ°createholderçš„é€»è¾‘ã€‚\nä»€ä¹ˆæƒ…å†µä¸‹ä¼šè°ƒç”¨onBindViewHolderï¼Ÿ ä¸æ˜¯boundçŠ¶æ€ boundæ ‡å¿—ä½ï¼šæ˜¯åœ¨bindViewHolderçš„æ—¶å€™è®¾ç½®çš„ï¼Œå› æ­¤ä¸æ˜¯boundè¡¨ç¤ºæ²¡æœ‰bindè¿‡ã€‚æ²¡æœ‰bindè¿‡æœ‰ï¼š1ï¼Œcreateholderï¼›2ï¼Œä»recyclerpoolå–çš„viewholderã€‚ needsUpdateï¼šè¯¥çŠ¶æ€è¡¨ç¤ºä»€ä¹ˆï¼Ÿä»€ä¹ˆæ—¶å€™æ‰ä¼šæ˜¯needUpdate()å‘¢ï¼Ÿ åœ¨viewRangeUpdateè®¾ç½®çš„ã€‚çŒœæµ‹æ˜¯åœ¨viewholderå‘ç”Ÿå˜åŒ–çš„æ—¶å€™è®¾ç½®çš„ï¼ŒéªŒè¯çŒœæƒ³ï¼š recyclerview.processAdapterUpdatesAndSetAnimationFlags-\u0026gt;AdapterHelper.preProcess-\u0026gt;applyUpdate-\u0026gt;postponeAndUpdateViewHolders -\u0026gt;markViewHoldersUpdated-\u0026gt;viewRangeUpdateï¼Œæ‰€ä»¥åœ¨dispatchLayout1è¿‡ç¨‹ä¸­ç»™flagè®¾ç½®äº†updateçŠ¶æ€\nisInvalidï¼šè¡¨ç¤ºä»€ä¹ˆçŠ¶æ€ï¼Ÿä»€ä¹ˆæ—¶å€™èµ‹å€¼çš„ï¼Ÿ markKnownViewsInvalidä¼šå¯¹æ‰€æœ‰é¡µé¢ä¸Šå¯è§çš„viewholderè®¾ç½®ä¸ºFLAG_INVALIDï¼Œå¹¶ä¸”æŠŠcacheç¼“å­˜ä¸­çš„viewholderè®¾ç½®ä¸ºFLAG_INVALIDï¼Œå®ƒæ˜¯åœ¨notifydataSetChangeæ—¶å€™è°ƒç”¨ åœ¨holderç¼“å­˜è·å–çš„æ—¶å€™ï¼Œå¦‚æœå‘ç°holderçš„viewtypeå’Œadapterä¸­é‡å†™çš„viewtypeä¸ä¸€è‡´ä¼šé‡ç½®ï¼Œä¼šç»™viewholderæ·»åŠ è¯¥æ ‡å¿—ä½ ä»ç¼“å­˜ï¼ˆattachScrapã€cacheviewï¼‰ä¸­è·å–viewholderçš„æ—¶å€™ï¼Œå¦‚æœå‘ç°typeå’Œholderçš„typeä¸ä¸€è‡´ï¼Œåˆ™ä¼šæ ¡éªŒä¸é€šè¿‡ã€‚æˆ–è€…è®¾ç½®äº†stableidsä¸ºtrueçš„æ—¶å€™ï¼Œå¦‚æœadapterä¸­çš„idå’Œholderçš„idä¸€è‡´ï¼Œåˆ™ä¹Ÿé€šè¿‡ã€‚ æ‰€ä»¥ç»“è®ºå°±æ˜¯ï¼Œéœ€è¦boundçš„æ¡ä»¶ï¼šæ²¡æœ‰boundè¿‡ï¼ˆcreateholderçš„holderè¿˜æ²¡æœ‰boundè¿‡ï¼‰ï¼›needupdateçš„ï¼Œholderå‘ç”Ÿæ›´æ–°äº†ã€‚invalidï¼Œä»attachscrapã€cacheè·å–åï¼Œ å¦‚æœtypeä¸ä¸€è‡´ä¹Ÿéœ€è¦é‡æ–°boundï¼Œæˆ–è€…æ˜¯è°ƒç”¨äº†notifydataSetChangeåï¼Œæ‰€æœ‰çš„viewholderéƒ½ä¼šæ·»åŠ nvalidæ ‡å¿—ä½ï¼Œæ­¤æ—¶ä¹Ÿéœ€è¦bindã€‚\næ›´æ–°è¡¨é¡¹ notifyItemChange(0)ï¼šæ›´æ–°è¡¨é¡¹ç¬¬0çš„ä½ç½®\né¦–å…ˆæ˜¯è¿›å…¥é¡µé¢åˆ›å»ºäº†10ä¸ªè¡¨é¡¹ï¼Œç„¶åæ›´æ–°åæ—¥å¿—å¦‚ä¸‹ï¼š é¦–å…ˆç»™æˆ‘åˆ›å»ºäº†ç´¢å¼•ä¸º10çš„è¡¨é¡¹ï¼Œä¹Ÿå°±æ˜¯å±å¹•ä¸Šä¸å¯è§çš„ï¼Œæ¥ç€åˆåˆ›å»ºäº†è¡¨é¡¹0ï¼Œé€šè¿‡traceviewåˆ†æï¼š æ•´ä½“çœ‹ç»å†äº†rvçš„layoutè¿‡ç¨‹ï¼Œåˆ†åˆ«å¯¹åº”äº†dispatchLayoutStep1ã€dispatchLayoutStep2ã€dispatchLayoutStep3ã€‚\ndispatchLayoutStep1 detachAndScrapAttachedViews å…±ç»å†äº†10æ¬¡scrapOrRecycleViewï¼š å®ƒæ˜¯åå‘éå†é¡µé¢ä¸Šçš„viewï¼Œç„¶åæ·»åŠ åˆ°srapç¼“å­˜ä¸­ï¼š ä»scrapOrRecycleViewçš„è°ƒç”¨æ ˆæ¥çœ‹ï¼Œæ˜¯èµ°äº†elseéƒ¨åˆ†ï¼Œä¹Ÿå°±æ˜¯å¾€scrapç¼“å­˜ä¸­åŠ å…¥viewholderã€‚ç”±äºviewHolderçš„isInvalidä¸ºfalseï¼Œæ‰€ä»¥ä¼šèµ°elseã€‚ scrapç¼“å­˜åˆ†ä¸¤ç§ï¼ŒattachScrapå’ŒchangeScrapã€‚ä¸æ˜¯updateçš„ä¼šæ”¾åˆ°attachScrapä¸­ï¼Œæ‰€ä»¥æˆ‘ä»¬æ›´æ–°ç¬¬0ä¸ªçš„æ—¶å€™ä¼šæ”¾åˆ°changeScrapä¸­ï¼Œåœ¨detachçš„æ—¶å€™ç”±äºæ˜¯åå‘åŠ å…¥åˆ°scrapç¼“å­˜ä¸­çš„ï¼Œå› æ­¤æˆ‘ä»¬çœ‹ç¬¬10ä¸ªçš„traceè°ƒç”¨ï¼š ä»è¿™é‡Œçœ‹ç¬¬0ä¸ªè¡¨é¡¹åœ¨detachçš„æ—¶å€™ä¼šåŠ å…¥åˆ°changeScrapä¸­ã€‚ ç»“è®ºï¼šåœ¨dispatchLayout1ä¸­ï¼Œå…ˆå°†é¡µé¢ä¸Šå¯è§çš„viewholderä»é¡µé¢ä¸Šåˆ†ç¦»ï¼Œç„¶åå°†updateçš„viewholderæ”¾å…¥åˆ°changeScrapä¸­ï¼ŒæŠŠéupdateçš„viewholderæ”¾å…¥åˆ°attachScrapä¸­ã€‚\nfill fillé˜¶æ®µå‘ç”Ÿäº†layoutChunk11æ¬¡ï¼Œè€Œæˆ‘ä»¬åˆšå¼€å§‹åˆ—è¡¨æ˜¯åˆå§‹åŒ–äº†10ä¸ªè¡¨é¡¹ï¼Œé‚£ä¹ˆè¯´æ˜dispatchLayout1é˜¶æ®µæ·»åŠ äº†ä¸€ä¸ªæ–°çš„viewholderï¼Œå…³äºè¿™å—æˆ‘ä»¬å¯ä»¥ç»™å‡ºç»“è®ºï¼Œå¦‚æœviewhodlerè¢«è®¾ç½®äº†removeæˆ–è€…updateæ ‡è®°çš„æ—¶å€™ï¼Œåˆ™ä¼šç»™åˆ—è¡¨æ·»åŠ ä¸€ä¸ªæ–°çš„viewholderã€‚å…³äºè¿™å—å¯ä»¥çœ‹ï¼šhttps://juejin.cn/post/6890288761783975950 åœ¨fillçš„whileå¾ªç¯ä¸­ä¼šåˆ¤æ–­remainingSpaceæ—¶å€™å¤§äº0ï¼Œè€Œæ¯æ¬¡layoutChunkè¿‡ç¨‹ä¸­ä¼šå°†remainingSpaceå‡å°ï¼Œè€ŒlayoutChunkResult.mIgnoreConsumedå°±æ˜¯åˆ¤æ–­æ˜¯å¦è¦å‡å°ï¼Œæ„æ€æ˜¯å¦‚æœä¸å¿½ç•¥æ‰ä¼šå‡å°ï¼Œé‚£ä»€ä¹ˆæ—¶å€™ä¼šå¿½ç•¥å‘¢ï¼Ÿ layoutChunkä¸­åˆ¤æ–­viewholderå¦‚æœæ˜¯removeæˆ–è€…æ˜¯changeæ—¶å€™ï¼Œæ‰ä¼šå¿½ç•¥å‡å°ã€‚æ‰€ä»¥æˆ‘ä»¬ä¼šæœ‰11æ¬¡çš„layoutChunkï¼Œè€Œæœ€åä¸€æ¬¡çš„layoutChunkä¼šèµ°createViewHolderï¼Œä¹Ÿå°±å¯¹åº”äº†ä¸Šé¢çš„æ—¥å¿—å…ˆæ·»åŠ äº†position=10çš„viewholderã€‚ä»traceä¸Šçœ‹ä¸‹ï¼š ç»“è®ºï¼š dispatchLayout1è¿‡ç¨‹ä¸­ï¼Œå°†ç¬¬0ä¸ªæ”¾å…¥åˆ°changeScrapä¸­ï¼Œ1-9æ”¾å…¥åˆ°äº†attacheScrapä¸­ï¼Œå¹¶ä¸”åˆ›å»ºäº†ç´¢å¼•ä¸º10çš„viewhodlerã€‚\næ³¨æ„ï¼š åœ¨dispatchLayout1è¿‡ç¨‹ä¸­ï¼Œå¦‚æœviewholderç»è¿‡äº†addViewä¹‹åï¼Œåˆ™ä¼šæŠŠå®ƒä»changescrapæˆ–è€…æ˜¯attachscrapç¼“å­˜ä¸­ç§»é™¤ï¼Œæ‰€ä»¥åœ¨dispatchlayout2è¿‡ç¨‹ä¸­changeå’Œattachçš„ç¼“å­˜ä¸ºç©ºçš„ã€‚ å…¶å®åœ¨dispatchLayout2è¿‡ç¨‹ä¸­æ·»åŠ viewholderçš„viewæ—¶å€™ä¹Ÿæ˜¯è¦ä»scrapç¼“å­˜ä¸­ç§»é™¤ã€‚\ndispatchLayoutStep2 detachAndScrapAttachedViews ç”±äºåœ¨dispatchLayout1è¿‡ç¨‹ä¸­åˆ›å»ºäº†position=10çš„viewholderï¼Œå› æ­¤ä¼šæœ‰11æ¬¡ï¼Œè¿™11ä¸ªé‡Œé¢ç¬¬0ä¸ªè¿˜æ˜¯æ·»åŠ åˆ°äº†changeScrapä¸­ï¼Œ1-10æ˜¯æ·»åŠ åˆ°attachScrapä¸­ã€‚\nfill ä¸ºä»€ä¹ˆæ­¤è¿‡ç¨‹åªæœ‰10æ¬¡layoutChunckå‘¢ï¼Ÿè¿™å—å…¶å®è¿˜æ˜¯å›åˆ°remainingSpaceçš„è®¡ç®—è¯´èµ·ï¼š æ‰€ä»¥åœ¨dispatchLayout2è¿‡ç¨‹ä¸­å½“æ·»åŠ åˆ°ç´¢å¼•ç­‰äº9çš„æ—¶å€™remainingSpaceå°±ä¸º0äº†ï¼Œæ‰€ä»¥ç´¢å¼•ç­‰äº10çš„æ—¶å€™æ·»åŠ ä¸ä¸Šï¼Œå› æ­¤åªä¼šæœ‰10æ¬¡layoutChunckã€‚\nlayoutChunck æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç¬¬0ä¸ªèµ°äº†createViewholderå’ŒbindViewholderï¼š æ˜¯ç”±äºç¬¬0ä¸ªviewholderè¢«æ·»åŠ åˆ°äº†changeScrapç¼“å­˜ä¸­ï¼Œè€Œ1-9çš„viewholderæ·»åŠ åˆ°äº†attachScrapä¸­ï¼Œè€ŒchangeScrapåªä¼šåœ¨pre-layoutè¿‡ç¨‹ä¸­æ‰ä¼šç”Ÿæ•ˆï¼š æ‰€ä»¥å¯ä»¥çœ‹åˆ°ä¸Šé¢æ—¥å¿—ä¸­ä¼šèµ°äº†position=0çš„createViewHolderå’ŒbindViewHolderã€‚\næ€»ç»“: æ›´æ–°è¡¨é¡¹çš„æ—¶å€™ï¼Œä¼šç»å†dispatchLayout1ï¼ŒdispatchLayout2ï¼Œå…¶ä¸­åœ¨dispatchLayout1ï¼ˆpre-layouté˜¶æ®µï¼‰ä¼šå…ˆæŠŠå¯è§çš„è¡¨é¡¹ç»™å›æ”¶åˆ°scrapç¼“å­˜ä¸­ï¼Œå›æ”¶åï¼Œä¼šæŠŠå¯è§çš„è¡¨é¡¹ä»recyclerviewä¸­åˆ†ç¦»ï¼Œå…¶ä¸­éœ€è¦å˜åŒ–çš„è¡¨é¡¹ä¼šåŠ å…¥åˆ° changeScrapä¸­ï¼ˆç¬¬1ä¸ªè¡¨é¡¹ï¼‰ï¼Œä¸å˜åŒ–çš„åŠ å…¥åˆ°attachScrapä¸­ï¼ˆç¬¬2ä¸ªåˆ°ç¬¬10ä¸ªè¡¨é¡¹ï¼‰ã€‚æ¥ç€åœ¨fillé˜¶æ®µä¼šä»scrapç¼“å­˜ä¸­å–è¡¨é¡¹ï¼Œç”±äºæœ‰è¡¨é¡¹æ›´æ–°ï¼Œæ‰€ä»¥æ­¤æ—¶ä¼šå»åˆ›å»ºä¸å¯è§çš„è¡¨é¡¹ï¼ˆç¬¬11ä¸ªè¡¨é¡¹ï¼‰ï¼Œæœ€åä¼šæ·»åŠ åˆ°recyclerviewä¸Šã€‚ åœ¨dispatchLayout2ï¼ˆpost-layouté˜¶æ®µï¼‰åŒæ ·ä¼šæŠŠdispatchLayout1æ·»åŠ è¿›æ¥çš„è¡¨é¡¹ç»™æ·»åŠ åˆ°changeScrapï¼ˆç¬¬1ä¸ªè¡¨é¡¹ï¼‰å’ŒattachScrapï¼ˆç¬¬2ä¸ªåˆ°ç¬¬11ä¸ªè¡¨é¡¹ï¼‰ç¼“å­˜ä¸­ï¼Œæ³¨æ„æ­¤æ—¶çš„è¡¨é¡¹ä¼šæ˜¯11ä¸ªè¡¨é¡¹ã€‚åœ¨fillé˜¶æ®µä¼šå»åˆ›å»ºè¡¨é¡¹0ï¼Œ å› ä¸ºpost-layouté˜¶æ®µä¸ä¼šå»å–changeScrapä¸­çš„viewholderï¼Œæ‰€ä»¥è¡¨é¡¹0ä¼šç»å†åˆ›å»ºã€‚\nåˆ é™¤è¡¨é¡¹ notifyItemRemove(0)\ndispatchLayout1 detachAndScrapAttachedViews è°ƒç”¨äº†10æ¬¡scrapOrRecycleView ç¬¬0ä¸ªè°ƒç”¨scrapViewæ·»åŠ åˆ°attachScrapç¼“å­˜ä¸­ 1-9çš„è¡¨é¡¹ä¹Ÿæ˜¯æ·»åŠ åˆ°attachScrapç¼“å­˜ä¸­ï¼Œè¿™ä¸ªå¯ä»¥ä»traceä¸­çœ‹åˆ°ã€‚ fill å’Œupdateè¿‡ç¨‹ä¸€æ ·ï¼Œåœ¨dispatchlayout1æœ‰11æ¬¡layoutChunkï¼Œdeleteå’Œupdateçš„viewholderä¸ä½œä¸ºæ¶ˆè´¹remainingSpaceã€‚ æ¥ç€è°ƒç”¨layoutstate.nextè·å–viewholderï¼Œæ­¤æ—¶åªæœ‰ç´¢å¼•ç­‰äº10çš„æ—¶å€™ä¼šå»åˆ›å»ºviewholderã€‚æ³¨æ„äº†ï¼šæ­¤æ—¶åˆ›å»ºå®Œviewholderåï¼Œbindè¿‡ç¨‹ä¼ çš„position=9ï¼š åœ¨bindè¿‡ç¨‹ä¸­ä¼šä¼ å…¥postion=10ï¼Œè€Œæ­¤æ—¶çš„mPostponedListä¸­æœ‰ä¸€ä¸ªopæ˜¯removeç±»å‹çš„ï¼Œæ‰€ä»¥postionä¼šå‡ä¸€ï¼Œå› æ­¤å®ƒçš„postionæ˜¯9ï¼š dispatchLayout2 detachAndScrapAttachedViews æ­¤å¤„scrapOrRecyclerviewå‘ç”Ÿäº†11æ¬¡ï¼Œå› ä¸ºåœ¨dispatchLayout1åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„viewholderï¼Œ11ä¸ªviewholderéƒ½åŠ å…¥åˆ°äº†attachScrapç¼“å­˜ä¸­ã€‚ fill layoutChunkè°ƒç”¨äº†10æ¬¡ï¼š åœ¨ç¬¬ä¸€ä¸ªviewholderè·å–çš„æ—¶å€™è·å–åˆ°åŸæ¥çš„ç¬¬äºŒä¸ªè¡¨é¡¹äº†ï¼ŒåŸæ¥çš„ç¬¬ä¸€ä¸ªè¡¨é¡¹çš„positionè¢«ç½®ä¸º-1äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬0-9çš„è¡¨é¡¹éƒ½ä¸ä¼šé‡æ–°åˆ›å»ºviewholderã€‚ä¹Ÿå°±å¯¹åº”ä¸Šé¢çš„æ—¥å¿—ã€‚ ç–‘é—®ï¼š æ­¤å¤„çš„positionèµ‹å€¼è²Œä¼¼éƒ½é‡æ–°èµ‹å€¼äº†ï¼Œå› æ­¤æˆ‘ä»¬çœ‹ä¸‹æ˜¯å“ªé‡Œé‡æ–°èµ‹å€¼äº†ï¼š å½“è°ƒç”¨notifyItemRemove(0)çš„æ—¶å€™ï¼Œåœ¨dispatchlayout1è¿‡ç¨‹ä¸­ä¼šè§¦å‘offsetPositionRecordsForRemoveæ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šé€šè¿‡removeçš„itemCountæ•°é‡æ–°ç»™æ¯ä¸€ä¸ªé¡µé¢ä¸Šçš„viewhodleré‡æ–°ç»™èµ‹ä¸Špositionçš„å€¼ï¼Œæ‰€ä»¥ä¼šçœ‹åˆ°ä¸Šé¢çš„attachScrapç¼“å­˜ä¸­æœ€åä¸€ä¸ªviewholderçš„postion=-1äº†ã€‚ scrapç¼“å­˜ åœ¨fillä¹‹å‰ä¼šæŠŠé¡µé¢ä¸Šçš„viewholderå…ˆdetachæ‰ï¼Œæœ€ç»ˆä¼šè°ƒç”¨åˆ°viewgroupçš„detachViewFromParentæ–¹æ³•ï¼ŒremoveViewä¹Ÿä¼šè°ƒç”¨è¯¥æ–¹æ³•ï¼Œåªä¸è¿‡viewholderçš„detachä¸ä¼šç«‹é©¬requestLayoutã€‚æ¥ç€å°±æ˜¯è°ƒç”¨scrapViewã€‚ scrapç¼“å­˜åˆ†ä¸¤ç§ï¼Œä¸€ç§æ˜¯attachã€å¦å¤–ä¸€ç§æ˜¯changeï¼Œå¦‚æœviewholderæ˜¯å‘ç”Ÿäº†å˜åŒ–ï¼ˆnotifyItemChangeï¼‰ï¼Œåˆ™ä¼šåŠ å…¥åˆ°changeä¸­ï¼Œå¦åˆ™åŠ å…¥åˆ°attachä¸­ã€‚æ¥ç€åœ¨layoutChunkè¿‡ç¨‹ä¸­ï¼Œä¼šä»scrapç¼“å­˜ä¸­æ‰¾viewholderã€‚ åœ¨dispatchLayout3è¿‡ç¨‹ä¸­ï¼Œä¼šè°ƒç”¨layout.removeAndRecycleScrapIntæ–¹æ³•ï¼š é‡Œé¢ä¼šè°ƒç”¨recycler.clearScrapï¼š ä¼šæ¸…ç©ºscrapç¼“å­˜ã€‚ æ€»ç»“ï¼šscrapç¼“å­˜åœ¨æ¯æ¬¡layoutChildä¹‹å‰ä¼šå…ˆæŠŠé¡µé¢çš„viewholderå…ˆæ”¾åˆ°scrapç¼“å­˜ä¸­ï¼Œåœ¨dispatchLayout3çš„æ—¶å€™ï¼Œä¼šæŠŠè¯¥ç¼“å­˜æ¸…ç©ºæ‰ã€‚\nAdapter.onViewAttachedToWindow åˆšè¿›å…¥å±å¹•ä¼šè§¦å‘onViewAttachedToWindowï¼Œä»0-9éƒ½æ‰“å°äº†ã€‚ ä»traceæ¥çœ‹ï¼Œåˆæ¬¡æ¯ä¸ªviewholderéƒ½ä¼šç»å†onViewAttachedToWindowæ–¹æ³•ã€‚\nä¸‹é¢çœ‹çœ‹ä»€ä¹ˆæ—¶å€™ä¸ä¼šè°ƒç”¨onViewAttachedToWindowæ–¹æ³•ï¼Ÿ æ¯æ¬¡åœ¨layoutChunkçš„æ—¶å€™ï¼Œä»ç¼“å­˜ä¸­å»æ‹¿viewholderï¼Œå¦‚æœä»scrapç¼“å­˜ä¸­æ‹¿åˆ°äº†ï¼Œåˆ™ä¸è§¦å‘childHelperçš„addViewï¼Œä¹Ÿå°±ä¸ä¼šè§¦å‘adapter.onViewAttachedToWindowï¼›å¦‚æœå½“å‰viewçš„parentæ˜¯å½“å‰recyclerviewçš„æ—¶å€™ï¼Œä¹Ÿä¸è§¦å‘childhelperçš„addviewã€‚å¦‚æœéƒ½ä¸æ»¡è¶³åˆ™è§¦å‘adapter.onViewAttachedToWindowã€‚\næ»‘åŠ¨çš„æ—¶å€™æ˜¯å¦è§¦å‘ï¼Ÿ æ»‘åŠ¨è¿‡ç¨‹ä¸­è¡¨é¡¹ä»ä¸å¯è§åˆ°å¯è§ä¼šè§¦å‘onViewAttachedToWindowï¼Œå› ä¸ºå®ƒä¸æ˜¯ä»scrapç¼“å­˜ä¸­è·å–åˆ°çš„ï¼Œå®ƒæ˜¯ä»cacheç¼“å­˜æˆ–è€…æ˜¯recyclerpoolä¸­è·å–çš„ã€‚onViewAttachedToWindowè§¦å‘ä¸ä¸€å®šä¼šè§¦å‘oncreateViewHolderï¼Œä¹Ÿä¸ä¸€å®šä¼šè§¦å‘onBindViewholderã€‚å¦‚æœcacheç¼“å­˜å’Œpoolç¼“å­˜ä¸­éƒ½æ²¡æœ‰è¯¥viewholderï¼Œåˆ™ä¼šè§¦å‘oncreateViewHolderå’ŒonBindViewholderã€‚å¦‚cacheä¸­æœ‰ï¼Œåˆ™åªè§¦å‘onViewAttachedToWindowã€‚å¦‚æœä»poolä¸­æ‹¿åˆ°ç¼“å­˜ï¼Œåˆ™ä¼šè§¦å‘onBindViewholderå’ŒonViewAttachedToWindowã€‚\næ›´æ–°åˆ—è¡¨æ˜¯å¦ä¼šè§¦å‘ï¼Ÿ æ‹¿ä¸Šé¢æ›´æ–°è¡¨é¡¹0æ¥çœ‹ï¼Œç”±äºåœ¨dispatchLayout1(pre-layout)è¿‡ç¨‹ä¸­ä¼šåˆ›å»ºè¡¨é¡¹10ï¼Œæ‰€ä»¥ä¼šç»å†è¡¨é¡¹10çš„oncreateå’Œonbindï¼Œå¹¶ä¸”æŠŠå®ƒæ·»åŠ åˆ°rvä¸­ï¼Œæ‰€ä»¥ä¼šæœ‰ä¸€æ¬¡çš„è¡¨é¡¹10çš„onViewAttachedToWindowï¼Œæ¥ç€ä¼šåœ¨dispatchLayout2è¿‡ç¨‹ä¸­ä¼šåˆ›å»ºè¡¨é¡¹0ï¼ˆå› ä¸ºè¡¨é¡¹0å­˜åœ¨äº†changeScrapç¼“å­˜ä¸­ï¼‰ï¼Œæ‰€ä»¥ä¼šèµ°è¡¨é¡¹0çš„onViewAttachedToWindowã€‚\nAdapter.onViewDetachedFromWindow æ»‘åŠ¨è¿‡ç¨‹ä¸­ï¼Œåˆ’å‡ºå±å¹•çš„è¡¨é¡¹ä¼šè°ƒç”¨onViewDetachedFromWindowã€‚\nfindViewHolderForAdapterPositionå’ŒfindViewHolderForLayoutPositionåŒºåˆ«ï¼š ç»“è®ºï¼šæ­£å¸¸æƒ…å†µä¸‹adapterPostionå’ŒlayoutPositionæ˜¯ç›¸ç­‰çš„ï¼Œå½“æœ‰addã€removeã€moveçš„æ—¶å€™ä¸¤è€…æ˜¯ä¸ä¸€æ ·çš„ã€‚adapterPostionä¼šç®—ä¸Šè¦æ”¹å˜çš„è¡¨é¡¹ï¼Œæ¯”å¦‚ä¸Šé¢æˆ‘è¦åˆ é™¤ç¬¬ä¸€ä¸ªè¡¨é¡¹ï¼Œé‚£ä¹ˆæ‹¿åˆ°çš„è¡¨é¡¹å°±æ˜¯ç¬¬äºŒä¸ªã€‚è€ŒlayoutPostionæ˜¯é¡µé¢æœ€ç»ˆå‘ˆç°çš„è¡¨é¡¹ï¼Œä¸Šé¢ä¾‹å­ä¸­ç­‰åˆ°postå®Œåï¼Œæ‰ä¼šçœŸæ­£çš„åˆ é™¤æ‰ã€‚æ‰€ä»¥postï¼ˆç»˜åˆ¶åï¼‰ålayoutpositionè·å–åˆ°çš„æ˜¯åŸæ¥çš„ç¬¬äºŒä¸ªè¡¨é¡¹ã€‚\nnotifydatasetChangeé—®é¢˜ å…ˆæ˜¯æŠŠé¡µé¢ä¸Šæ‰€æœ‰çš„éƒ½detachæ‰ï¼Œç„¶ååˆèµ°äº†æ‰€æœ‰çš„viewholderçš„onbindè¿‡ç¨‹ï¼Œä»ç´¢å¼•ä¸º5çš„viewholderèµ°äº†oncreateviewholderã€‚ä¸‹é¢çœ‹ä¸‹traceï¼š layoutè¿‡ç¨‹åªèµ°äº†dispatchLayout2ï¼Œåœ¨é‡Œé¢èµ°åˆ°äº†linearlayoutManager.onLayoutChildrenï¼Œé‡Œé¢ä¼šè§¦å‘fillã€‚åœ¨fillä¹‹å‰ä¼šèµ°detaché€»è¾‘ï¼Œé‡Œé¢ä¼šåå‘éå†å¯è§çš„å­viewï¼Œå¹¶è°ƒç”¨scrapOrRecylerviewï¼š æ¯ä¸€ä¸ªå­viewå›æ”¶éƒ½èµ°äº†removeViewAt: æ­¤å¤„ç”±äºæ‰€æœ‰çš„viewholderéƒ½æ˜¯invalidçŠ¶æ€äº†ï¼Œå› ä¸ºåœ¨notifyDatasetChangeåœ¨è°ƒç”¨requestLayoutä¹‹å‰æŠŠé¡µé¢ä¸Šçš„å­viewéƒ½è®¾ç½®æˆinvalidçŠ¶æ€äº†ï¼š æ‰€ä»¥åœ¨fillä¹‹å‰éƒ½ä¼šè°ƒç”¨removeViewAtï¼Œè€Œè¯¥æ–¹æ³•ä¼šè§¦å‘onViewDetachedFromWindowï¼Œå› æ­¤å¯ä»¥çœ‹åˆ°å‰é¢æ—¥å¿—ä¸­å…ˆåå‘æ‰“å°äº†9-\u0026gt;0çš„onViewDetachedFromWindowã€‚æ¥ç€ä¼šè°ƒç”¨recycler.recycleViewHolderInternalï¼Œè¯¥æ–¹æ³•æ˜¯æŠŠviewholderåŠ å…¥åˆ°cacheæˆ–è€…æ˜¯recyclerpoolä¸­ï¼š å¦‚æœå­˜åœ¨invalidçŠ¶æ€ï¼Œåˆ™ä¼šæŠŠviewholderåŠ å…¥åˆ°poolç¼“å­˜ä¸­ï¼ŒtraceéªŒè¯ä¸‹ï¼š è€Œpoolç¼“å­˜æ˜¯5ä¸ªï¼Œå› æ­¤å…ˆæŠŠ9-\u0026gt;5å­˜åˆ°pooä¸­æ—¶ï¼Œå‘ç°poolæ»¡äº†ï¼Œåˆ™æŠŠ9ç»™ç§»é™¤æ‰ï¼Œå› æ­¤æœ€ååªå‰©ä¸‹5ä¸ªviewholderåœ¨poolä¸­ã€‚æ¥ç€åœ¨layoutChunké˜¶æ®µï¼Œä¼šä»ç¼“å­˜ä¸­æ‹¿viewholderçš„æ—¶å€™ï¼Œåªæœ‰poolä¸­5ä¸ªviewholdçš„ç¼“å­˜ï¼Œå–å®Œä¸€ä¸ªremoveæ‰ä¸€ä¸ªï¼Œå½“ç´¢å¼•ä¸º5çš„æ—¶å€™ï¼Œpoolä¸­å·²ç»æ‹¿å®Œäº†ï¼Œå› æ­¤5-9ä¼šå»åˆ›å»ºviewholderã€‚\nå‚è€ƒï¼š\nRecyclerView ç¼“å­˜æœºåˆ¶ | å¦‚ä½•å¤ç”¨è¡¨é¡¹ï¼Ÿ RecyclerView ç¼“å­˜æœºåˆ¶ | å›æ”¶äº›ä»€ä¹ˆï¼Ÿ RecyclerView ç¼“å­˜æœºåˆ¶ | å›æ”¶åˆ°å“ªå»ï¼Ÿ RecyclerViewç¼“å­˜æœºåˆ¶ | scrap view çš„ç”Ÿå‘½å‘¨æœŸ ","date":"2025-01-02T00:00:00Z","permalink":"https://example.com/p/recyclerview%E6%BA%90%E7%A0%81%E8%B5%B0%E8%AF%BB/","title":"RecyclerViewæºç èµ°è¯»"},{"content":"suspendCoroutine åœ¨androidä¸­æ— å¤„ä¸åœ¨è·å–viewçš„å®½é«˜ï¼Œè€Œè·å–å®½é«˜æ˜¯éœ€è¦åœ¨viewç»˜åˆ¶å®Œåæ‰èƒ½è·å–ï¼Œæ‰€ä»¥è¿™æ˜¯ä¸€ä¸ªæ—¶æœºé—®é¢˜ï¼Œé€šå¸¸é€šè¿‡view.postæ¥è·å–ï¼Œé‚£ä¹ˆç”¨åç¨‹å¦‚ä½•å½¢å¦‚åŒæ­¥è·å–å®½é«˜å‘¢ï¼Ÿä¸‹é¢æ¥è¯•è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 GlobalScope.launch { val wh = getViewWh(view) Log.d(TAG, \u0026#34;width:${wh.first}\u0026#34;) Log.d(TAG, \u0026#34;height:${wh.second}\u0026#34;) } Log.d(TAG, \u0026#34;outer coroutine\u0026#34;) private suspend fun getViewWh(view: View) = suspendCoroutine\u0026lt;Pair\u0026lt;Int, Int\u0026gt;\u0026gt; { continuation -\u0026gt; view.post { val width = view.width val height = view.height continuation.resume(Pair(width, height)) } } æ—¥å¿—å¦‚ä¸‹ï¼š\n1 2 3 11:00:57.708 D outer coroutine 11:00:57.810 D width:1080 11:00:57.810 D height:2206 ä½¿ç”¨äº†suspendCoroutineæ–¹æ³•ï¼Œæ–¹æ³•çš„è¿”å›å€¼ï¼Œæ˜¯suspendCoroutineæŒ‡å®šçš„æ³›å‹ã€‚ å¯ä»¥çœ‹åˆ°æ—¥å¿—æ­£å¸¸è·å–ï¼Œä¸‹é¢æ¥çœ‹çœ‹å­—èŠ‚ç æ˜¯å¦‚ä½•å®ç°çš„ï¼š launchå¯åŠ¨çš„æ—¶å€™ï¼Œå†…éƒ¨çš„åç¨‹ä»£ç å—ç¼–è¯‘ç»“æœæ˜¯SuspendCoroutineActivity$onCreate$1ï¼š è°ƒç”¨äº†SuspendCoroutineActivityçš„é™æ€æ–¹æ³•access$getViewWhï¼š\né™æ€æ–¹æ³•æ˜¯ç›´æ¥è°ƒç”¨äº†æˆå‘˜æ–¹æ³•getViewWhï¼Œå®ƒæ˜¯æœ¬æ¬¡çš„é‡è¦å®ç°ï¼š\nä¼ è¿›æ¥çš„Continuationå¯¹åº”äº†SuspendCoroutineActivity$onCreate$1ï¼Œå®ƒæ˜¯ä¼ ç»™äº†SafeContinuationï¼Œæ­¤å¤„æ³¨æ„åˆ°è°ƒç”¨äº†continuationçš„interceptedæ–¹æ³•ï¼Œå®ƒæ˜¯continuationçš„æ‰©å±•æ–¹æ³•ï¼Œå®ƒæ˜¯åœ¨continuationImplä¸­å®ç°äº†ï¼Œå®ƒå®é™…æ˜¯çœ‹contextä¸­æ˜¯å¦æœ‰dispatcherï¼Œè¿™å—åœ¨åç¨‹åˆ‡æ¢çº¿ç¨‹ä¸­è®²è¿‡ï¼Œå®ƒå®é™…æ˜¯ç”Ÿæˆäº†ä¸€ä¸ªCoroutineDispatcherã€‚\næ¥ç€çœ‹åˆè°ƒç”¨äº†SuspendCoroutineActivity$getViewWh$2$1è¿™ä¸ªsuspendLambdaï¼Œå¹¶æŠŠSafeContinuationä¼ è¿›å»äº†ï¼š æ­¤å¤„çš„Runnableå°±å¯¹åº”äº†postä¸­çš„ä»£ç å—ï¼Œæœ€ç»ˆåœ¨runæ–¹æ³•ä¸­è°ƒç”¨äº†continuationçš„resumeWithæ–¹æ³•ï¼Œå¹¶æŠŠå®½é«˜å›è°ƒå‡ºå»äº†ã€‚æ­¤å¤„çš„continuationæ˜¯SafeContinuationï¼Œçœ‹ä¸‹å®ƒçš„resumeWithæ–¹æ³•ï¼š æ­¤å¤„çš„resulté»˜è®¤å€¼æ˜¯UNDECIDEDï¼š ç”±äºé»˜è®¤å€¼æ˜¯UNDECIDEDï¼Œåœ¨ä¸Šé¢getViewWhä¸­å…ˆè°ƒç”¨äº†safeContinuationçš„getOrThrowæ–¹æ³•ï¼š æ‰€ä»¥ä¼šç»™resultè®¾ç½®ä¸Šäº†COROUTINE_SUSPENDEDæ ‡è®°ï¼Œæ‰€ä»¥åœ¨ç¬¬ä¸€ä¸ªsuspendLambdaçš„invokeSuspendæ–¹æ³•ä¸­èƒ½è¢«æŒ‚èµ·ï¼Œç­‰åˆ°æ‰§è¡ŒsafeContinuationçš„resumeWithçš„æ—¶å€™ï¼Œç¬¬ä¸€ä¸ªsuspendLambdaå°±æ¢å¤äº†ã€‚æœ€ç»ˆè·å–åˆ°ç»“æœï¼Œæ•´ä¸ªæµç¨‹å°±ç»“æŸã€‚\nsuspendCoroutineçš„å›è°ƒä¸­è¿˜æœ‰ä¸€ä¸ªresumeWithExceptionæ–¹æ³•ï¼Œç”¨äºè¿”å›å¤±è´¥çš„ç»“æœï¼Œå¦‚æœè¿”å›å¤±è´¥çš„æ—¶å€™ï¼Œéœ€è¦æ•æ‰å¼‚å¸¸ã€‚\nsuspendCancellableCoroutine å®ƒå’ŒsuspendCoroutineåŒºåˆ«æ˜¯å›è°ƒä¸­æ˜¯ä¸€ä¸ªCancellableContinuationImplï¼Œå®ƒæä¾›äº†cancelæ–¹æ³•ï¼Œå½“cancelçš„æ—¶å€™ï¼Œç¨‹åºä¸ä¼šå´©æºƒã€‚å®ƒä¼šæŠŠcancelçš„ç»“æœåˆ†å‘åˆ°delegateä¸­ï¼Œæ­¤å¤„çš„delegateå…¶å®å°±æ˜¯å¯¹åº”äº†GlobalScope.launchå¯åŠ¨æ—¶çš„suspendLambdaï¼Œæœ€åå®ƒä¼šåˆ†å‘åˆ°çˆ¶jobä¸­ã€‚çœ‹ä¸‹CancellableContinuationImplçš„cancelæ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 public override fun cancel(cause: Throwable?): Boolean { _state.loop { state -\u0026gt; if (state !is NotCompleted) return false // false if already complete or cancelling // Active -- update to final state val update = CancelledContinuation(this, cause, handled = state is CancelHandler || state is Segment\u0026lt;*\u0026gt;) if (!_state.compareAndSet(state, update)) return@loop // retry on cas failure // Invoke cancel handler if it was present when (state) { is CancelHandler -\u0026gt; callCancelHandler(state, cause) is Segment\u0026lt;*\u0026gt; -\u0026gt; callSegmentOnCancellation(state, cause) } // Complete state update detachChildIfNonResuable() dispatchResume(resumeMode) // no need for additional cancellation checks return true } } æ­¤å¤„ä¼šæ„é€ å‡ºCancelledContinuationï¼Œå®ƒæ˜¯CompletedExceptionallyå¯¹è±¡ï¼Œè¿™ä¸ªå…¶å®å°±æ˜¯åç¨‹å¼‚å¸¸çš„æ‰©å±•ç±»ï¼Œæœ€ç»ˆæŠŠè¯¥å¯¹è±¡è®¾ç½®åˆ°CancellableContinuationImplçš„stateä¸Šã€‚ ä¸€è·¯è·Ÿåˆ°DispatchedTaskçš„dispatchæ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 internal fun \u0026lt;T\u0026gt; DispatchedTask\u0026lt;T\u0026gt;.dispatch(mode: Int) { assert { mode != MODE_UNINITIALIZED } // invalid mode value for this method val delegate = this.delegate val undispatched = mode == MODE_UNDISPATCHED if (!undispatched \u0026amp;\u0026amp; delegate is DispatchedContinuation\u0026lt;*\u0026gt; \u0026amp;\u0026amp; mode.isCancellableMode == resumeMode.isCancellableMode) { // dispatch directly using this instance\u0026#39;s Runnable implementation val dispatcher = delegate.dispatcher val context = delegate.context if (dispatcher.isDispatchNeeded(context)) { dispatcher.dispatch(context, this) } else { resumeUnconfined() } } else { // delegate is coming from 3rd-party interceptor implementation (and does not support cancellation) // or undispatched mode was requested resume(delegate, undispatched) } } æ­¤å¤„ä¼šèµ°dispatcher.dispatché€»è¾‘ï¼Œå› ä¸ºä¸Šé¢çš„GlobalScope.launchå…¶å®åˆ›å»ºçš„dispatcheræ˜¯ä¸€ä¸ªDispatcher.Defaultç±»å‹çš„ã€‚DispatchedTaskæ˜¯ä¸€ä¸ªrunnableæ¥å£ï¼Œçœ‹ä¸‹å®ƒçš„runæ–¹æ³•ï¼š æœ€ç»ˆä¹Ÿæ˜¯é€šè¿‡continuationçš„resumeWithExceptionæ–¹æ³•å›è°ƒå‡ºå»ï¼Œç„¶åäº¤ç»™äº†çˆ¶jobå»å¤„ç†ï¼Œæ­¤æ—¶çš„exceptionæ˜¯ä¸€ä¸ªCancellationExceptionï¼Œå…¶å®ä¸Šé¢çš„suspendCoroutineä¹Ÿå¯ä»¥é€šè¿‡resumeWithExceptionå›è°ƒä¸€ä¸ªCancellationExceptionï¼Œç¨‹åºä¹Ÿä¸ä¼šå´©æºƒã€‚\nå‚è€ƒï¼šhttps://juejin.cn/post/7121517604644061192\n","date":"2024-12-30T00:00:00Z","permalink":"https://example.com/p/%E5%8D%8F%E7%A8%8B%E5%A6%82%E4%BD%95%E4%BC%98%E9%9B%85%E7%9A%84%E5%A4%84%E7%90%86%E5%BC%82%E6%AD%A5%E5%9B%9E%E8%B0%83/","title":"åç¨‹å¦‚ä½•ä¼˜é›…çš„å¤„ç†å¼‚æ­¥å›è°ƒ"},{"content":"æ¡ˆä¾‹ä¸€ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 private fun demo1() { val handler = CoroutineExceptionHandler { coroutineContext, throwable -\u0026gt; Log.d(TAG, \u0026#34;onCreate: CoroutineExceptionHandler:${throwable.message}\u0026#34;) } GlobalScope.launch(handler) { Log.d(TAG, \u0026#34;onCreate: parentJob start\u0026#34;) withContext(Dispatchers.IO) { throw RuntimeException(\u0026#34;runtime exception\u0026#34;) delay(1000) Log.d(TAG, \u0026#34;onCreate: withContext end\u0026#34;) } Log.d(TAG, \u0026#34;onCreate: parentJob end\u0026#34;) } } å…ˆä¸Šæ—¥å¿—ï¼š\n1 2 com.example.coroutinescopedemo D onCreate: parentJob start com.example.coroutinescopedemo D onCreate: CoroutineExceptionHandler:withContext runtime exception å¼‚å¸¸èƒ½è¢«launchæŒ‡å®šçš„handleræ‰€æ•æ‰ã€‚ åˆ†æï¼š launchå¯åŠ¨çš„åç¨‹ç”¨åˆ°çš„coroutineScopeæ˜¯ä¸€ä¸ªStandaloneCoroutineï¼ŒwithContextå¯åŠ¨çš„åç¨‹å¯¹åº”çš„coroutineScopeæ˜¯ä¸€ä¸ªDispatchedCoroutineã€‚ åœ¨withContextä¸­å‘ç”Ÿå¼‚å¸¸çš„æ—¶å€™ï¼Œé¦–å…ˆä¼šå›è°ƒåˆ°DispatchedCoroutineçš„resumeWithï¼Œæœ€ç»ˆä¼šèµ°åˆ°finalizeFinishingStateæ–¹æ³•ï¼Œè¯¥æ–¹æ³•é‡Œé¢ä¼šåˆ¤æ–­æ˜¯å¦å­˜åœ¨å¼‚å¸¸ï¼Œå¦‚æœæœ‰å¼‚å¸¸ä¼šè°ƒç”¨cancelParentæ–¹æ³•ï¼š\nå¯ä»¥çœ‹åˆ°å¦‚æœisScopedCoroutineä¸ºtrueçš„æ—¶å€™ï¼ŒcancelParentç›´æ¥è¿”å›trueï¼Œå¦‚æœè¿”å›trueï¼Œé‚£ä¹ˆå°±ä¸è§¦å‘è‡ªå·±çš„ä¸Šé¢çš„handleJobExceptionï¼Œä¹Ÿå°±æ˜¯æŠŠå¼‚å¸¸ç»§ç»­å¾€ä¸ŠæŠ›äº†ã€‚ä¾‹å­ä¸­ä¹Ÿå°±æ˜¯launchå¯¹åº”çš„StandaloneCoroutineã€‚è€Œåœ¨StandaloneCoroutineä¸­ä¸ä¼šå»cancelParentï¼Œæ‰€ä»¥ä¼šæŠŠå¼‚å¸¸äº¤ç»™äº†handleJobExceptionäº†ï¼Œæ‰€ä»¥ä¸Šé¢çš„launchä¸­ä¼ å…¥çš„CoroutineExceptionHandlerèƒ½æ•è·åˆ°è¯¥å¼‚å¸¸ã€‚\næ€»ç»“ï¼šå¦‚æœå­jobä¸­åœ¨å¤„ç†å¼‚å¸¸çš„æ—¶å€™ï¼ŒcancelParentä¸­å¦‚æœisScopedCoroutineä¸ºtrueçš„æ—¶å€™ï¼Œåˆ™ä¸è§¦å‘è‡ªå·±çš„handleJobExceptionï¼Œä¹Ÿå°±æ˜¯æŠŠå¼‚å¸¸äº¤ç»™äº†çˆ¶jobï¼Œå¦‚æœçˆ¶jobä¸å¤„ç†è¯¥å¼‚å¸¸ï¼Œåˆ™ä¼šç¨‹åºå´©æºƒã€‚\næ¡ˆä¾‹äºŒ ä¸Šé¢ä»£ç å¦‚æœæŠŠwithContextä¸­çš„å¼‚å¸¸é€šè¿‡try-catchä½ï¼Œçˆ¶jobå°±æ”¶ä¸åˆ°è¯¥å¼‚å¸¸äº†ï¼š å­æºç¨‹æŠŠå¼‚å¸¸catchä½åï¼Œçˆ¶åç¨‹çš„handleræ•æ‰ä¸åˆ°å¼‚å¸¸ï¼Œå¹¶ä¸”çˆ¶åç¨‹çš„invokeOnCompletionæ”¶ä¸åˆ°å¼‚å¸¸ï¼Œå¹¶ä¸”çˆ¶åç¨‹ä¹‹åçš„ä»£ç ä¹Ÿèƒ½æ­£å¸¸æ‰§è¡Œã€‚\næ¡ˆä¾‹ä¸‰ å­åç¨‹ç»™contextä¼ é€’coroutineExceptionHandlerï¼š å­åç¨‹æŠ›äº†å¼‚å¸¸ï¼Œç„¶åå­åç¨‹ä¹Ÿä¼ äº†CoroutineExceptionHandlerï¼Œä½†æ˜¯å­åç¨‹çš„CoroutineExceptionHandlerä¸èµ·ä½œç”¨ï¼Œè¿˜æ˜¯æŠŠå¼‚å¸¸ä¼ ç»™äº†çˆ¶åç¨‹ã€‚å¹¶ä¸”çˆ¶åç¨‹çš„invokeOnCompletionæ”¶åˆ°äº†å¼‚å¸¸å›è°ƒï¼Œè€Œä¸”å‘ç°çˆ¶åç¨‹çš„invokeSuspendæ–¹æ³•ä¹Ÿæ²¡èµ°å®Œï¼Œæ‰€ä»¥onCreate: parentJob endæ²¡æœ‰è¾“å‡ºã€‚\nåˆ†æï¼šå‰é¢å·²ç»åˆ†æè¿‡withContextå¼€å¯çš„åç¨‹å¯¹åº”çš„coroutineScopeæ˜¯ä¸€ä¸ªDispatchedCoroutineé‡å†™äº†isScopedCoroutine=trueï¼Œå¦‚æœå®ƒä¸ºtrueï¼ŒcancelParentæ–¹æ³•åˆ™è¿”å›trueï¼Œé‚£ä¹ˆå®ƒè‡ªå·±çš„handleJobExceptionå°±ä¸ä¼šè§¦å‘ï¼Œæ‰€ä»¥å°±ä¸ä¼šèµ°åˆ°è‡ªå·±çš„CoroutineExceptionHandlerå›è°ƒäº†ã€‚\næ¡ˆä¾‹å›› å½“å­åç¨‹æŠ›çš„æ˜¯CancellationExceptionï¼Œçˆ¶åç¨‹æ•æ‰ä¸åˆ°è¯¥å¼‚å¸¸ï¼š æ­¤å¤„handleræ²¡æœ‰æ•æ‰åˆ°å¼‚å¸¸ï¼Œå¹¶ä¸”ç¨‹åºä¹Ÿæ²¡å´©æºƒï¼Œè¿™æ˜¯å› ä¸ºåœ¨å­åç¨‹æŠŠå¼‚å¸¸å›è°ƒç»™çˆ¶åç¨‹åï¼Œçˆ¶åç¨‹å¯¹åº”çš„scopeï¼Œä¹Ÿå°±æ˜¯StandaloneCoroutineåœ¨cancelParentä¸­åˆ¤æ–­æ˜¯CancelationExceptionï¼Œå®ƒç›´æ¥è¿”å›trueï¼Œæ‰€ä»¥ä¸ä¼šè°ƒç”¨handleJobExceptionæ–¹æ³•ï¼Œè€Œå‘å¤–æŠ›å¼‚å¸¸çš„æ­£æ˜¯è¯¥æ–¹æ³•ã€‚æ‰€ä»¥å½“å­åç¨‹æŠ›å‡ºCancellationExceptionæ—¶å€™ä¸ä¼šä½¿çˆ¶åç¨‹å´©æºƒã€‚\næ¡ˆä¾‹äº” 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 private fun demo2() { val handler = CoroutineExceptionHandler { coroutineContext, throwable -\u0026gt; Log.d(TAG, \u0026#34;handler:${throwable.message}\u0026#34;) } val job = Job() val coroutineScope = CoroutineScope(job + handler) val job1 = coroutineScope.launch { delay(100) Log.d(TAG, \u0026#34;job1 end\u0026#34;) throw RuntimeException(\u0026#34;runtime exception\u0026#34;) } job1.invokeOnCompletion { Log.d(TAG, \u0026#34;job1 invokeOnCompletion:${it?.message}\u0026#34;) } val job2 = coroutineScope.launch { delay(200) Log.d(TAG, \u0026#34;job2 end\u0026#34;) } job2.invokeOnCompletion { Log.d(TAG, \u0026#34;job2 invokeOnCompletion:${it?.message}\u0026#34;) } val job3 = coroutineScope.launch { delay(300) Log.d(TAG, \u0026#34;job3 end\u0026#34;) } job3.invokeOnCompletion { Log.d(TAG, \u0026#34;job3 invokeOnCompletion:${it?.javaClass?.simpleName}\u0026#34;) Log.d(TAG, \u0026#34;job3 invokeOnCompletion:${it?.message}\u0026#34;) } } æ—¥å¿—å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 com.example.coroutinescopedemo D job1 end com.example.coroutinescopedemo D handler:runtime exception com.example.coroutinescopedemo D job2 invokeOnCompletion:Parent job is Cancelling com.example.coroutinescopedemo D job1 invokeOnCompletion:runtime exception com.example.coroutinescopedemo D job3 invokeOnCompletion:JobCancellationException com.example.coroutinescopedemo D job3 invokeOnCompletion:Parent job is Cancelling æ•°æ®ç»“æ„:çˆ¶åç¨‹çš„jobå¯åŠ¨äº†ä¸‰ä¸ªå­åç¨‹ï¼Œåœ¨job1ä¸­æŠ›å‡ºå¼‚å¸¸ï¼Œjob2å’Œjob3æ”¶åˆ°äº†JobCancellationExceptionã€‚å…¶ä¸­çˆ¶jobæ˜¯ä¸€ä¸ªJobImplå¯¹è±¡ï¼Œåœ¨æ¯ä¸ªå­åç¨‹å¯åŠ¨è¿‡ç¨‹ä¸­éƒ½ä¼šåˆ›å»ºä¸€ä¸ªChildHandleNodeå¯¹è±¡ï¼Œå…¶ä¸­jobæŒ‡å‘äº†çˆ¶Jobï¼Œä¹Ÿå°±æ˜¯JobImplï¼ŒchildJobæŒ‡å‘äº†å½“å‰å­jobï¼Œä¹Ÿå°±æ˜¯StandaloneCoroutineï¼Œæœ€ååœ¨å­Jobä¸­é€šè¿‡parentHandleæŒ‡å‘äº†çˆ¶jobï¼ŒstateæŒ‡å‘äº†InvokeOnCompletion(æ˜¯é€šè¿‡invokeOnCompletionæ·»åŠ çš„)ã€‚çˆ¶jobä¸­é€šè¿‡stateæŒ‡å‘äº†ä¸€ä¸ªNodeListï¼Œæ¯ä¸€ä¸ªnextèŠ‚ç‚¹æŒ‡å‘äº†ä¸‰ä¸ªå­jobã€‚\nå¼‚å¸¸å¤„ç†:å½“ç¬¬ä¸€ä¸ªjobå‘ç”Ÿå¼‚å¸¸åï¼Œä¼šé€šçŸ¥è‡ªå·±çš„stateä¸­çš„InvokeOnCompleteæ¥å£ï¼Œæ‰€ä»¥job1ä¸­æ”¶åˆ°äº†runtime exceptionçš„ä¿¡æ¯ï¼Œå®ƒæ˜¯åŸå§‹çš„å¤±è´¥ä¿¡æ¯ã€‚æ¥ç€ä¼šè°ƒç”¨åˆ°job1çš„cancelParenté€»è¾‘ï¼Œè¯¥æ–¹æ³•ä¸­ä¼šè°ƒç”¨åˆ°parentHandleçš„childCancelledé€»è¾‘ï¼Œå®ƒæ˜¯ä¸€ä¸ªChildHandleNodeå¯¹è±¡ï¼Œåœ¨å®ƒçš„childCancelledæ–¹æ³•ä¸­ï¼Œä¼šè§¦å‘çˆ¶jobçš„childCancelledæ–¹æ³•ï¼Œæœ€ç»ˆä¼šæ¥åˆ°çˆ¶jobçš„cancelImplæ–¹æ³•ã€‚è¯¥æ–¹æ³•é‡Œé¢ä¼šå»å–æ¶ˆå­jobï¼Œæ˜¯é€šè¿‡éå†stateèŠ‚ç‚¹ï¼Œè°ƒç”¨é‡Œé¢çš„æ¯ä¸€ä¸ªChildHandleNodeçš„invokeæ–¹æ³•ï¼Œåœ¨invokeé‡Œé¢ä¼šè°ƒç”¨åˆ°childJobçš„parentCancelledæ–¹æ³•ï¼Œé‡Œé¢ä¼šç»™æ¯ä¸€ä¸ªjobçš„stateè®¾ç½®ä¸ŠJobCancellationExceptionï¼Œå½“è®©ç¬¬ä¸€ä¸ªjobç”±äºå·²ç»æœ‰exceptionäº†ï¼Œä¹Ÿå°±æ˜¯åŸå§‹exceptionï¼Œæ‰€ä»¥job2å’Œjob3ä¼šè®¾ç½®ä¸ŠJobCancellationExceptionå¼‚å¸¸ã€‚æ¥ç€å­åç¨‹ä¼šé€’å½’è°ƒç”¨notifyHandlersé€šçŸ¥å­åç¨‹å‘ç”Ÿå¼‚å¸¸äº†ï¼Œç›´åˆ°æ²¡æœ‰å­åç¨‹ä¸ºæ­¢ã€‚ å½“æ‰€æœ‰çš„å­åç¨‹å¤„ç†å®Œå¼‚å¸¸åï¼Œä¼šè°ƒç”¨åˆ°è‡ªå·±çš„CoroutineExceptionHandlerçš„å›è°ƒã€‚å½“å›è°ƒå®Œåï¼Œä¼šç»™è‡ªå·±çš„stateæ·»åŠ å¼‚å¸¸ï¼Œé˜²æ­¢åœ¨resumeWithä¸­å¾€ä¸‹æ‰§è¡Œé€»è¾‘ã€‚å…¶ä¸­ç»™stateæ·»åŠ å¼‚å¸¸æ˜¯é€šè¿‡Finishing.addExceptionLockedæ·»åŠ å¼‚å¸¸ä¿¡æ¯ã€‚\nå­åç¨‹invokeOnCompletionæ¥å£å›è°ƒæ‰§è¡Œæ—¶æœºï¼Ÿ åœ¨å¼‚å¸¸å¤„ç†é˜¶æ®µï¼Œçˆ¶åç¨‹ä¼šè°ƒç”¨åˆ°ChildHandleNodeä¸­çš„invokeæ–¹æ³•ï¼Œç»§è€Œä¼šè§¦å‘childJobçš„parentCancelledæ–¹æ³•ï¼Œæœ€ç»ˆä¼šåœ¨notifyHandlersä¸­è§¦å‘invokeOnCompletionçš„å›è°ƒï¼Ÿ\nå­åç¨‹çš„jobä¸ºä»€ä¹ˆåœ¨æ·»åŠ å®Œå¼‚å¸¸åresumeWithä¸ä¼šè¢«æ‰§è¡Œï¼Ÿ åœ¨åç¨‹jobä¸­åœ¨æ‰§è¡ŒresumeWithçš„æ—¶å€™ï¼Œè°ƒç”¨åˆ°tryMakeCompletingæ—¶ï¼Œä¼šåˆ¤æ–­stateï¼Œå¦‚æœä¸æ˜¯IncompleteçŠ¶æ€ï¼Œåˆ™ç›´æ¥è¿”å›ï¼Œä¸ä¼šå¾€ä¸‹æ‰§è¡Œã€‚\nçˆ¶åç¨‹åœ¨cancelImplçš„æ—¶å€™é™¤äº†å–æ¶ˆå­åç¨‹è¿˜åšäº†ä»€ä¹ˆï¼Ÿ åœ¨å–æ¶ˆå®Œå­åç¨‹çš„æ—¶å€™ï¼Œç»™ç¬¬ä¸€ä¸ªchildæ·»åŠ äº†ChildCompletionå›è°ƒï¼Œè¯¥å›è°ƒæ‰§è¡Œçš„æ—¶å€™ä¼šæ‰§è¡Œåˆ°continueCompletingï¼Œæœ€ç»ˆä¼šå›åˆ°è‡ªå·±å¤„ç†å¼‚å¸¸çš„é€»è¾‘ã€‚\næ¡ˆä¾‹å…­ æŠŠæ¡ˆä¾‹äº”ä¸­çš„Job()æ¢æˆSupervisorJob()\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 private fun demo3() { val handler = CoroutineExceptionHandler { coroutineContext, throwable -\u0026gt; Log.d(TAG, \u0026#34;handler:${throwable.message}\u0026#34;) } val coroutineScope = CoroutineScope(SupervisorJob() + handler) val job1 = coroutineScope.launch { delay(100) Log.d(TAG, \u0026#34;job1 end\u0026#34;) throw RuntimeException(\u0026#34;runtime exception\u0026#34;) } job1.invokeOnCompletion { Log.d(TAG, \u0026#34;job1 invokeOnCompletion:${it?.message}\u0026#34;) } val job2 = coroutineScope.launch { delay(200) Log.d(TAG, \u0026#34;job2 end\u0026#34;) } job2.invokeOnCompletion { Log.d(TAG, \u0026#34;job2 invokeOnCompletion:${it?.message}\u0026#34;) } val job3 = coroutineScope.launch { delay(300) Log.d(TAG, \u0026#34;job3 end\u0026#34;) } job3.invokeOnCompletion { Log.d(TAG, \u0026#34;job3 invokeOnCompletion:${it?.javaClass?.simpleName}\u0026#34;) Log.d(TAG, \u0026#34;job3 invokeOnCompletion:${it?.message}\u0026#34;) } } åªæ˜¯æ¢äº†ä¸ªjobï¼Œjob1è¿˜æ˜¯ä¸€æ ·æ”¶åˆ°äº†åŸå§‹å¼‚å¸¸ï¼Œjob2å’Œjob3æ­£å¸¸æ‰§è¡Œï¼Œå¹¶èƒ½æ‰§è¡Œå®Œã€‚æŒ‰ç…§ä¸Šé¢åˆ†æï¼Œå½“job1å‘ç”Ÿå¼‚å¸¸çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨åˆ°cancelParentï¼Œå®ƒä¼šåˆ†å‘åˆ°çˆ¶jobçš„childCancelledæ–¹æ³•ï¼Œè€ŒSupervisorJobé‡å†™äº†è¯¥æ–¹æ³•ç›´æ¥è¿”å›falseã€‚æ‰€ä»¥å¼‚å¸¸ä¸ä¼šåˆ†å‘åˆ°å­åç¨‹ä¸­ï¼Œå½“job1çš„cancelParentè¿”å›falseçš„æ—¶å€™ï¼Œä¼šæ‰§è¡Œåˆ°handleJobExceptionï¼Œè€Œjob1ä½¿ç”¨çš„contextä¸­çš„CoroutineExceptionHandleræ˜¯ä½¿ç”¨çš„çˆ¶jobä¸­æŒ‡å®šçš„CoroutineExceptionHandlerã€‚å› ä¸ºcontextæ˜¯pluså åŠ çš„æ–¹å¼ã€‚æ‰€ä»¥æœ€åhandlerä¸­æ”¶åˆ°äº†å¼‚å¸¸ã€‚\nä»¥ä¸‹çš„æ¡ˆä¾‹æ¥è‡ªäºhttps://juejin.cn/post/7049537608262615070\næ¡ˆä¾‹ä¸ƒ ç»“æœï¼štry-catchç«Ÿç„¶æ•è·ä¸ä½ï¼Œç¨‹åºç›´æ¥æŠ›å¼‚å¸¸äº†\næ­¤å¤„try-catchçš„ä½ç½®ä¸åœ¨å­åç¨‹çš„SuspendInvokeä½ç½®ï¼Œå®ƒæ˜¯åœ¨ä¸»åç¨‹çš„launchä½ç½®ï¼Œå…¶å®å®ƒæ˜¯åœ¨invokeSuspendä¸­è°ƒç”¨å†…éƒ¨launchçš„æ—¶å€™åŠ äº†try-catchï¼Œå¯¹åº”çš„classä»£ç å¦‚ä¸‹ï¼š\nä»å­—èŠ‚ç æ¥çœ‹ï¼Œåªæ˜¯å¯åŠ¨å­åç¨‹çš„æ—¶å€™ç»™try-catchï¼Œä»åŸç†ä¸Šåˆ†æï¼Œå½“å­åç¨‹å‘ç”Ÿå¼‚å¸¸åï¼Œä¼šè°ƒç”¨çˆ¶åç¨‹çš„cancelChildï¼Œåœ¨çˆ¶jobé‡Œé¢ä¼šè°ƒç”¨åˆ°cancelParentï¼Œè€Œçˆ¶job(shi ä¹Ÿå°±æ˜¯JobImpl)ï¼Œå®ƒçš„parentHandleæ˜¯ç©ºï¼Œæ‰€ä»¥cancelParentçš„æ–¹æ³•è¿”å›falseï¼Œå› æ­¤ä¼šè°ƒç”¨åˆ°handleJobExceptionï¼Œè€Œçˆ¶jobæ²¡æœ‰ä¼ handlerï¼Œå› æ­¤ç¨‹åºä¼šå´©æºƒã€‚ ä¸Šé¢çš„æ¡ˆä¾‹ï¼Œå…¶å®å¯ä»¥ç†è§£ä¸ºlaunchå¯åŠ¨çš„åç¨‹ä¸­å†å¯åŠ¨ä¸€ä¸ªlanuchåç¨‹ï¼Œç„¶åtry-catchæ•æ‰ä½ç½®åœ¨å¤–å±‚lauchä¸Šï¼Œæ­¤æ—¶æ˜¯æ•æ‰ä¸åˆ°å¼‚å¸¸çš„\næ¡ˆä¾‹å…« ç»“æœï¼šæ­¤å¤„ä¸ä¼šå‘ç”Ÿå¼‚å¸¸ï¼Œå¼‚å¸¸è¢«exceptionHandleræ•æ‰ å› æ­¤å½“çˆ¶jobæ¥æ”¶åˆ°å¼‚å¸¸åï¼Œä¼šå°†å¼‚å¸¸ä¼ é€’åˆ°handleJobExceptionæ–¹æ³•ä¸­ï¼Œè€Œçˆ¶jobæ˜¯æœ‰handlerçš„ï¼Œæ‰€ä»¥å°†å¼‚å¸¸å›è°ƒåˆ°äº†handlerä¸­ï¼Œç¨‹åºä¸ä¼šå´©æºƒã€‚\næ¡ˆä¾‹ä¹ ç»“æœï¼šç¨‹åºå´©æºƒäº†ï¼Œä¸ä¼šè¢«å­åç¨‹çš„handleræ•æ‰åˆ°å¼‚å¸¸\nå› ä¸ºå½“å­åç¨‹å¼‚å¸¸çš„æ—¶å€™ï¼Œä¼šæŠŠå¼‚å¸¸æŠ›ç»™äº†çˆ¶jobï¼Œè€Œçˆ¶jobåˆæ²¡æœ‰å¤„ç†è¯¥å¼‚å¸¸ï¼Œæ‰€ä»¥ç¨‹åºå´©æºƒäº†\næ¡ˆä¾‹å ç»“æœï¼šç¨‹åºä¸ä¼šå´©æºƒï¼Œå¼‚å¸¸è¢«try catchæ•è·ä½ï¼Œè€Œä¸æ˜¯è¢«exceptionHandleræ•è·ä½ã€‚\nå‰é¢åˆ†æè¿‡å½“å­åç¨‹å‘ç”Ÿå¼‚å¸¸åï¼Œä¼šæŠŠå¼‚å¸¸åˆ†å‘ç»™åˆ°çˆ¶jobï¼Œåœ¨çˆ¶jobä¸­éœ€è¦ç­‰å­jobéƒ½å¤„ç†å®Œå¼‚å¸¸äº†ï¼Œæ‰ä¼šå¾€ä¸‹èµ°ï¼Œè¯¥å¤„é€»è¾‘ä¸»è¦ä½“ç°åœ¨å­jobä¸­æ·»åŠ äº†ä¸€ä¸ªChildCompletionèŠ‚ç‚¹åˆ°stateä¸­ï¼Œåœ¨invokeä¸­ä¼šæ‰§è¡Œåˆ°parent.continueCompletionæ–¹æ³•ï¼š æ­¤å¤„çš„parentå®é™…æ˜¯coroutineScopeå¯åŠ¨çš„åç¨‹å¯¹åº”çš„jobï¼Œå®ƒæ˜¯ScopeCoroutineï¼Œçœ‹ä¸‹å®ƒçš„continueCompletingå®ç°ï¼š æœ€ç»ˆä¼šæŠŠç»“æœå›è°ƒç»™åˆ°äº†ä¼ é€’è¿›æ¥çš„continuationï¼Œä¹Ÿå°±æ˜¯æœ€å¤–å±‚launchå¯åŠ¨çš„æ—¶å€™çš„SuspendLambdaï¼Œæœ€ç»ˆä¼šè°ƒç”¨å®ƒçš„invokeSuspendæ–¹æ³•ï¼š æ‰€ä»¥æœ€ç»ˆè¢«try-catchæ•æ‰åˆ°å¼‚å¸¸ã€‚\næ¡ˆä¾‹åä¸€ ç»“æœï¼šç¨‹åºè¢«å†…å±‚launchæŒ‡å®šçš„exceptionHandleræ•æ‰äº† supervisorScopeç”¨åˆ°çš„jobæ˜¯SupervisorCoroutineï¼Œå®ƒé‡å†™äº†childCancelæ–¹æ³•ï¼Œå¹¶è¿”å›falseï¼Œæ‰€ä»¥å½“å­jobå‘ç”Ÿå¼‚å¸¸çš„æ—¶å€™ï¼Œä¸ä¼šæŠ›ç»™çˆ¶jobï¼Œå¹¶æ‰§è¡Œè‡ªå·±çš„handleJobExceptionæ–¹æ³•ï¼Œæ‰€ä»¥è¢«è‡ªå·±çš„handleræ•è·åˆ°ã€‚\næ¡ˆä¾‹åäºŒ æ­¤æ—¶è¢«å¤–å±‚launchçš„handleræ‰€æ•æ‰ï¼ŒåŸå› æ˜¯å¼‚å¸¸æŠ›ç»™äº†çˆ¶jobã€‚\næ¡ˆä¾‹åä¸‰ æ­¤æ—¶è¢«å†…å±‚launchçš„handleræ‰€æ•æ‰ï¼ŒåŸå› æ˜¯supervisorScopeå¯åŠ¨çš„åç¨‹ä¸ä¼šå¾€ä¸ŠæŠ›ï¼Œäº¤ç»™äº†å­åç¨‹è‡ªå·±å¤„ç†ã€‚\n","date":"2024-12-17T00:00:00Z","image":"https://example.com/p/%E5%8D%8F%E7%A8%8B%E4%B8%AD%E5%AD%90%E5%8D%8F%E7%A8%8B%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/cover_hu17536845123992820283.jpg","permalink":"https://example.com/p/%E5%8D%8F%E7%A8%8B%E4%B8%AD%E5%AD%90%E5%8D%8F%E7%A8%8B%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/","title":"åç¨‹ä¸­å­åç¨‹å¼‚å¸¸å¤„ç†"},{"content":"invokeOnCompletionç›‘å¬åç¨‹çŠ¶æ€ åœ¨äº†è§£åç¨‹çš„å¼‚å¸¸å¤„ç†ä¹‹å‰ï¼Œå…ˆæ¥ç†Ÿæ‚‰ä¸‹åç¨‹ä¹‹é—´jobæ˜¯å¦‚ä½•ç»‘å®šå…³ç³»ï¼Œè¿˜æ˜¯é€šè¿‡ä¸€ä¸ªä¾‹å­æ¥ç†Ÿæ‚‰ä»–ä»¬ä¹‹é—´çš„å…³ç³»ï¼š\n1 2 3 4 5 6 7 8 private fun demo(){ val job = GlobalScope.launch { Log.d(TAG, \u0026#34;demo: launchä»£ç \u0026#34;) } job.invokeOnCompletion { Log.d(TAG, \u0026#34;demo: invokeOnCompletion\u0026#34;) } } æ‰§è¡Œç»“æœï¼š\n1 2 CoroutineJobActivity com.example.coroutinescopedemo D demo: launchä»£ç  CoroutineJobActivity com.example.coroutinescopedemo D demo: invokeOnCompletion å¯ä»¥çœ‹å‡ºæ¥invokeOnCompletionæ˜¯jobæ‰§è¡Œå®Œæ¯•çš„å›è°ƒã€‚\né€šè¿‡launchåˆ›å»ºåç¨‹å†…éƒ¨ä¼šæ„é€ ä¸€ä¸ªStandaloneCoroutineï¼Œå®ƒå°±æ˜¯ä¸€ä¸ªjobï¼Œå¹¶ä¸”launchè¿”å›çš„å°±æ˜¯è¯¥jobï¼š StandaloneCoroutineç»§æ‰¿è‡ªAbstractCoroutineï¼š å› æ­¤parentHandleä¸ºNonDisposableHandleï¼Œç„¶åæ–¹æ³•ç»“æŸã€‚ æ­¤æ—¶æ‰§è¡Œå®Œlaunchåï¼Œç»§ç»­æ‰§è¡Œäº†jobçš„invokeOnCompletionæ–¹æ³•ï¼Œå®ƒæ˜¯ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œå®ç°æ–¹æ³•åœ¨jobSupportç±»ï¼š æˆ‘ä»¬çœ‹ä¸‹makeNodeæ–¹æ³•å®ç°ï¼š ä»è°ƒç”¨é“¾ä¸Šçœ‹onCancellingä¼ è¿›æ¥çš„æ˜¯falseï¼Œå¹¶ä¸”æ­¤æ—¶çš„handlerè¿˜ä¸æ˜¯ä¸€ä¸ªJobNodeèŠ‚ç‚¹ï¼Œæ‰€ä»¥ä¼šåˆ›å»ºäº†ä¸€ä¸ªInvokeOnCompletionå¯¹è±¡ï¼Œå¹¶æŠŠå¤–é¢ä¼ è¿›æ¥çš„ComppletionHandlerä¼ åˆ°InvokeOnCompletionä¸­ï¼Œçœ‹ä¸‹InvokeOnCompletionå¯¹è±¡ï¼š\n1 2 3 4 5 private class InvokeOnCompletion( private val handler: CompletionHandler ) : JobNode() { override fun invoke(cause: Throwable?) = handler.invoke(cause) } InvokeOnCompletionæ˜¯ä¸€ä¸ªJobNodeèŠ‚ç‚¹ï¼š\n1 2 3 4 5 6 7 8 9 10 internal abstract class JobNode : CompletionHandlerBase(), DisposableHandle, Incomplete { /** * Initialized by [JobSupport.makeNode]. */ lateinit var job: JobSupport override val isActive: Boolean get() = true override val list: NodeList? get() = null override fun dispose() = job.removeNode(this) override fun toString() = \u0026#34;$classSimpleName@$hexAddress[job@${job.hexAddress}]\u0026#34; } JobNodeå®ç°äº†CompletionHandlerBaseæŠ½è±¡ç±»ï¼š\n1 2 3 internal actual abstract class CompletionHandlerBase actual constructor() : LockFreeLinkedListNode(), CompletionHandler { actual abstract override fun invoke(cause: Throwable?) } å®ƒä¹Ÿæ˜¯å®ç°äº†CompletionHandleræ¥å£ï¼ŒCompletionHandleræ˜¯ä¸€ä¸ªé—­åŒ…ï¼Œä»ä¸Šé¢ç»§æ‰¿ä»¥åŠJobNodeå®ç°æ¥çœ‹ï¼Œåœ¨å®ƒçš„invokeå®ç°é‡Œé¢ï¼Œä¼šè§¦å‘ä¼ è¿›æ¥çš„CompletionHandlerçš„invokeå®ç°ï¼Œä»å®ç°æ¥çœ‹å…¶å®è¿™å°±æ˜¯ä¸ªé™æ€ä»£ç†çš„æ¨¡å¼ã€‚\nç»“è®ºï¼š makeNodeå†…éƒ¨ä¼šè¿”å›ä¸€ä¸ªInvokeOnCompletionå¯¹è±¡ï¼Œå®ƒæ˜¯ä¸€ä¸ªJobNodeèŠ‚ç‚¹ã€‚\nå›åˆ°ä¸Šé¢çš„invokeOnComletionçš„å®ç°ï¼Œåˆ›å»ºäº†InvokeOnCompletionåï¼Œä¼šèµ°åˆ°loopOnStateçš„å‡½æ•°ï¼Œå®ƒæ˜¯éå†stateï¼Œå®ƒçš„åˆå§‹çŠ¶æ€æ˜¯ä¸€ä¸ªEmptyçŠ¶æ€ï¼Œå¹¶ä¸”state.isActive=trueã€‚æ‰€ä»¥æœ€ç»ˆæŠŠåˆšæ‰åˆ›å»ºçš„InvokeOnCompletionè®¾ç½®åˆ°äº†stateä¸Šï¼Œå¹¶ä¸”è¿”å›äº†è¯¥InvokeOnCompletionã€‚\nç»“è®ºï¼š å½“è°ƒç”¨äº†jobçš„invokeOnCompletionæ–¹æ³•åï¼Œä¼šæŠŠå¤–ç•Œåˆ›å»ºå¥½çš„CompletionHandlerä¼ ç»™äº†InvokeCompletionï¼ŒInvokeCompletionæ˜¯ä¸€ä¸ªJobNodeï¼Œåœ¨å®ƒçš„invokeå®ç°ä¸­ï¼Œä¼šå›è°ƒåˆ°å¤–ç•Œçš„CompletionHandlerä¸­ã€‚å¹¶ä¸”æŠŠåˆ›å»ºçš„InvokeCompletionè®¾ç½®åˆ°å½“å‰jobçš„stateä¸Šäº†ã€‚\nåç¨‹ä½“æ‰§è¡Œå®Œjobçš„æ‰§è¡Œï¼š åœ¨ä¹‹å‰åˆ†æåç¨‹ä½“å…¶å®æ˜¯ä¸€ä¸ªSuspendLambdaï¼Œåœ¨å®ƒçš„invokeSuspendè°ƒç”¨å®Œåï¼Œä¼šæ‰§è¡Œå®ƒçš„continuationçš„resumeWithæ–¹æ³•ï¼Œåœ¨ä¸Šé¢ä¾‹å­ä¸­å…¶å®æ˜¯StandaloneCoroutineï¼Œå®ƒæ˜¯ä¸€ä¸ªjobï¼Œæ‰€ä»¥çœ‹ä¸‹å®ƒçš„resumeWithå®ç°ï¼š\n1 2 3 4 5 public final override fun resumeWith(result: Result\u0026lt;T\u0026gt;) { val state = makeCompletingOnce(result.toState()) if (state === COMPLETING_WAITING_CHILDREN) return afterResume(state) } å°†åç¨‹ä½“çš„ç»“æœä¼ åˆ°äº†makeCompletingOnceæ–¹æ³•ä¸­ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 internal fun makeCompletingOnce(proposedUpdate: Any?): Any? { loopOnState { state -\u0026gt; val finalState = tryMakeCompleting(state, proposedUpdate) when { finalState === COMPLETING_ALREADY -\u0026gt; throw IllegalStateException( \u0026#34;Job $this is already complete or completing, \u0026#34; + \u0026#34;but is being completed with $proposedUpdate\u0026#34;, proposedUpdate.exceptionOrNull ) finalState === COMPLETING_RETRY -\u0026gt; return@loopOnState else -\u0026gt; return finalState // COMPLETING_WAITING_CHILDREN or final state } } } è½®è®­è·å–stateï¼Œå¹¶è°ƒç”¨äº†tryMakeCompletingæ–¹æ³•ï¼š ä»ä¸Šé¢çš„åˆ†æçŸ¥é“stateå®ƒæ˜¯ä¸€ä¸ªJobNodeï¼Œå®ƒæ˜¯ä¸€ä¸ªInvokeCompletionï¼Œå®ƒä¸æ˜¯ä¸€ä¸ªChildHandleNodeï¼Œå¹¶ä¸”proposedUpdateä¸æ˜¯CompletedExceptionallyï¼Œæ‰€ä»¥ä¼šæ‰§è¡ŒtryFinalizeSimpleStateï¼š å†…éƒ¨è°ƒç”¨äº†completeStateFinalizationæ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 private fun completeStateFinalization(state: Incomplete, update: Any?) { /* * Now the job in THE FINAL state. We need to properly handle the resulting state. * Order of various invocations here is important. * * 1) Unregister from parent job. */ parentHandle?.let { it.dispose() // volatile read parentHandle _after_ state was updated parentHandle = NonDisposableHandle // release it just in case, to aid GC } val cause = (update as? CompletedExceptionally)?.cause /* * 2) Invoke completion handlers: .join(), callbacks etc. * It\u0026#39;s important to invoke them only AFTER exception handling and everything else, see #208 */ if (state is JobNode) { // SINGLE/SINGLE+ state -- one completion handler (common case) try { state.invoke(cause) } catch (ex: Throwable) { handleOnCompletionException(CompletionHandlerException(\u0026#34;Exception in completion handler $state for $this\u0026#34;, ex)) } } else { state.list?.notifyCompletion(cause) } } è¯¥æ–¹æ³•ä¸­åˆ¤æ–­stateæ˜¯å¦æ˜¯JobNodeï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œä¼šè°ƒç”¨invokeæ–¹æ³•ã€‚åœ¨ä¸Šé¢åˆ†æè¿‡stateæ˜¯ä¸€ä¸ªInvokeOnCompletionå¯¹è±¡ï¼Œåœ¨å®ƒçš„invokeé‡Œé¢ä¼šå›è°ƒåˆ°ä¼ è¿›æ¥çš„CompletionHandlerçš„invokeä¸­ï¼Œæ‰€ä»¥åœ¨ä¸Šé¢ä¾‹å­ä¸­æ‰“å°äº†jobæ‰§è¡Œå®Œæˆçš„æ—¥å¿—ã€‚\ninvokeOnCompletionç›‘å¬jobçš„å¼‚å¸¸ è¿˜æ˜¯é€šè¿‡ä¸€ä¸ªä¾‹å­æ¥åˆ†æä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 private fun demo3(){ val exceptionHandler =CoroutineExceptionHandler{ coroutineContext, throwable -\u0026gt; Log.d(TAG, \u0026#34;demo3: CoroutineExceptionHandler--å¼‚å¸¸ä¿¡æ¯ï¼š${throwable?.message}\u0026#34;) } val job = GlobalScope.launch(exceptionHandler) { Log.d(TAG, \u0026#34;demo3: launchä»£ç \u0026#34;) throw RuntimeException(\u0026#34;åç¨‹ä½“é‡Œé¢å‘ç”Ÿå¼‚å¸¸äº†\u0026#34;) } job.invokeOnCompletion { Log.d(TAG, \u0026#34;demo3: invokeOnCompletion--å¼‚å¸¸ä¿¡æ¯ï¼š${it?.message}\u0026#34;) } } æ­¤å¤„ç”¨äº†ä¸€ä¸ªCoroutineExceptionHandleræ–¹æ³•ï¼Œæ¥åˆ›å»ºCoroutineExceptionHandlerå¯¹è±¡æ¥æ‹¦æˆªå¼‚å¸¸çš„ï¼Œè¿™å—å…ˆä¸ç”¨ç®¡ï¼Œæˆ‘ä»¬çœ‹ä¸‹æ—¥å¿—ï¼š\n1 2 3 com.example.coroutinescopedemo D demo3: launchä»£ç  com.example.coroutinescopedemo D demo3: CoroutineExceptionHandler--å¼‚å¸¸ä¿¡æ¯ï¼šåç¨‹ä½“é‡Œé¢å‘ç”Ÿå¼‚å¸¸äº† com.example.coroutinescopedemo D demo3: invokeOnCompletion--å¼‚å¸¸ä¿¡æ¯ï¼šåç¨‹ä½“é‡Œé¢å‘ç”Ÿå¼‚å¸¸äº† å¯ä»¥çœ‹å‡ºæ¥ï¼ŒinvokeOnCompletionä¸­ä¹Ÿèƒ½æ”¶åˆ°å¼‚å¸¸çš„æ¶ˆæ¯ã€‚ ä½†æ˜¯å¼‚å¸¸å’Œæ­£å¸¸æ”¶æ•°æ®å¯èƒ½ä¸å¤ªä¸€æ ·ï¼Œä¸»è¦åŒºåˆ«æ˜¯åœ¨resumeWithä¹‹åçš„å¤„ç†ä¸å¤ªä¸€æ ·ï¼š å¦‚æœæ˜¯éå¼‚å¸¸çš„è¯ï¼Œä¼šèµ°tryFinalizeSimpleStateï¼›å¦‚æœæ˜¯å¼‚å¸¸çš„æ—¶å€™ä¼šèµ°tryMakeCompletingSlowPathï¼Œåœ¨è¯¥æ–¹æ³•é‡Œé¢ä¼šè§¦å‘finalizeFinishingStateæ–¹æ³•ï¼Œè¯¥æ–¹æ³•æœ‰ä¸ªå¾ˆé‡è¦é€»è¾‘ï¼š ç”±äºcancelParentè¿”å›falseï¼Œæ‰€ä»¥ä¼šè§¦å‘handleJobExceptionï¼ŒStandaloneCoroutineé‡å†™äº†è¯¥æ–¹æ³•ï¼š handleCoroutineExceptionï¼š å¦‚æœcontextä¸­CoroutineExceptionHandlerä¸ä¸ºç©ºï¼Œåˆ™å¼‚å¸¸ä¸ä¼šå¾€ä¸ŠæŠ›äº†ï¼Œæ‰€ä»¥æ­¤ä¾‹ä¸­å®šä¹‰äº†contextçš„CoroutineExceptionHandlerç¨‹åºä¸ä¼šå´©æºƒã€‚ å›åˆ°ä¸Šé¢å†æ¥çœ‹invokeOnCompletionçš„CompletionHandlerè§¦å‘æ—¶æœºï¼Œå®ƒæ˜¯åœ¨finalizeFinishingStateä¸­è§¦å‘ï¼Œæ¥ç€ä¼šè°ƒç”¨åˆ°completeStateFinalizationï¼Œæœ€ç»ˆåœ¨é‡Œé¢è§¦å‘äº†invokeOnCompletionä¼ è¿›æ¥çš„CompletionHandlerã€‚\nåç¨‹å¼‚å¸¸tryä½ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 private fun demo4() { val exceptionHandler = CoroutineExceptionHandler { coroutineContext, throwable -\u0026gt; Log.d(TAG, \u0026#34;demo4: CoroutineExceptionHandler--å¼‚å¸¸ä¿¡æ¯ï¼š${throwable?.message}\u0026#34;) } val job = GlobalScope.launch(exceptionHandler) { try { Log.d(TAG, \u0026#34;demo4: launchä»£ç \u0026#34;) throw RuntimeException(\u0026#34;åç¨‹ä½“é‡Œé¢å‘ç”Ÿå¼‚å¸¸äº†\u0026#34;) } catch (e: Exception) { Log.d(TAG, \u0026#34;demo4: catchä¸­ä»£ç \u0026#34;) } } job.invokeOnCompletion { Log.d(TAG, \u0026#34;demo4: invokeOnCompletion--å¼‚å¸¸ä¿¡æ¯ï¼š${it?.message}\u0026#34;) } } æ—¥å¿—å¦‚ä¸‹ï¼š\n1 2 3 com.example.coroutinescopedemo D demo4: launchä»£ç  com.example.coroutinescopedemo D demo4: catchä¸­ä»£ç  com.example.coroutinescopedemo D demo4: invokeOnCompletion--å¼‚å¸¸ä¿¡æ¯ï¼šnull ä»æ—¥å¿—ä¸­çœ‹ï¼Œæ­¤å¤„çš„CoroutineExceptionHandlerä¸å›è°ƒï¼Œå¹¶ä¸”invokeOnCompletionæ”¶ä¸åˆ°å¼‚å¸¸ä¿¡æ¯ã€‚ æˆ‘ä»¬é€šè¿‡å­—èŠ‚ç å¯ä»¥çœ‹åˆ°åŸå› ï¼š æ­¤å¤„çš„å¼‚å¸¸catchä½åï¼Œç»™åˆ°JobSupportå°±ä¸æ˜¯å¼‚å¸¸äº†ï¼Œæ‰€ä»¥æŒ‰ç…§æˆåŠŸçš„å¤„ç†æ–¹å¼ä¸€æ ·ã€‚\n","date":"2024-12-16T00:00:00Z","permalink":"https://example.com/p/%E5%8D%8F%E7%A8%8B%E7%9A%84%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/","title":"åç¨‹çš„å¼‚å¸¸å¤„ç†"},{"content":"é¦–å…ˆçœ‹ä¸€ä¸ªä¾‹å­ï¼š æ—¥å¿—å¦‚ä¸‹ï¼š å­—èŠ‚ç å¦‚ä¸‹ï¼š launchéƒ¨åˆ†å¯åŠ¨çš„åç¨‹çš„invokeSuspendé€»è¾‘é‡Œé¢ï¼Œåªæœ‰label0çš„é€»è¾‘ï¼Œå’ŒwithContextä¸åŒçš„æ˜¯ä¼šæœ‰æŒ‚èµ·éƒ¨åˆ†çš„åˆ¤æ–­ï¼Œæ‰€ä»¥æ˜¯åŒæ­¥æ‰§è¡Œçš„ã€‚\nasyncçš„å¼‚æ­¥æ‰§è¡Œï¼š æ—¥å¿—å¦‚ä¸‹ï¼š å¯ä»¥çœ‹åˆ°async2æ˜¯å…ˆæ‰§è¡Œçš„ï¼Œå› ä¸ºå®ƒæ²¡æœ‰è¿›è¡Œdelayï¼Œç­‰åˆ°ä¸¤ä¸ªasyncæ‰§è¡Œå®Œäº†åï¼Œæ‰ä¼šæ‰§è¡Œlaunché‡Œé¢çš„ä»£ç ã€‚ å­—èŠ‚ç å¦‚ä¸‹ï¼š ç¼–è¯‘åçš„ä»£ç ï¼š label=0çš„æ—¶å€™ï¼Œé€šè¿‡asyncå¯åŠ¨äº†ä¸¤ä¸ªåç¨‹ï¼Œæˆ‘ä»¬è¿™é‡Œå«async1å’Œasync2ï¼Œå¹¶ä¸”åœ¨é‡Œé¢é€šè¿‡awaitæŒ‚èµ·äº†launchå¯åŠ¨çš„åç¨‹ã€‚ åˆ†æï¼šasync1è°ƒç”¨awaitåï¼Œç”±äºçŠ¶æ€æ˜¯COROUTINE_SUSPENDEDï¼Œæ‰€ä»¥ç¬¬ä¸€æ¬¡invokeSuspendæ–¹æ³•ç»“æŸï¼Œæ­¤æ—¶label=1ã€‚ç­‰åˆ°awaité€»è¾‘æ‰§è¡Œå®Œåï¼Œåˆä¼šç¬¬äºŒæ¬¡æ‰§è¡ŒinvokeSuspendæ–¹æ³•ï¼Œæ­¤æ—¶ç”±äºlable=1ï¼Œä¼šæ‰§è¡Œasync2çš„awaitæ–¹æ³•ï¼Œæ­¤æ—¶è¿”å›COROUTINE_SUSPENDEDï¼Œæ‰€ä»¥invokeSuspendç¬¬äºŒæ¬¡ç»“æŸï¼Œæ­¤æ—¶label=2ã€‚ç­‰åˆ°async2çš„awaitæ‰§è¡Œå®Œåï¼Œç¬¬ä¸‰æ¬¡æ‰§è¡ŒinvokeSuspendæ–¹æ³•ï¼Œç”±äºæ­¤æ—¶label=2ï¼Œæ‰€ä»¥æ­¤æ—¶åˆ‡å›åˆ°è‡ªå·±çš„çº¿ç¨‹ï¼Œæ‰§è¡Œlaunchéƒ¨åˆ†çš„ä»£ç é€»è¾‘ã€‚\n","date":"2024-11-28T00:00:00Z","permalink":"https://example.com/p/%E5%8D%8F%E7%A8%8B%E7%9A%84%E5%90%8C%E6%AD%A5%E6%89%A7%E8%A1%8C%E5%8E%9F%E7%90%86/","title":"åç¨‹çš„åŒæ­¥æ‰§è¡ŒåŸç†"},{"content":"å…ˆæ¥ä¸€ä¸ªä¾‹å­ï¼š æ—¥å¿—å¦‚ä¸‹ï¼š å¯ä»¥çœ‹åˆ°ä¸Šé¢å…ˆæ˜¯æ‰§è¡Œäº†withContextä¸­çš„ä»£ç ï¼Œç„¶åæ‰§è¡Œäº†launchä¸­çš„ä»£ç ï¼Œæ³¨æ„åˆ°launchä¸­ä¹Ÿæ˜¯åœ¨å•ç‹¬çº¿ç¨‹ä¸­æ‰§è¡Œçš„ï¼Œå…¶ä¸­launchä¸­ä½¿ç”¨çš„Dispatcheræ˜¯Dispatchers.Defaultç±»å‹çš„ã€‚å‰é¢åˆ†æè¿‡launchè°ƒåº¦æƒ…å†µï¼Œæœ€åä¼šæ‰§è¡Œåˆ°continuationçš„resumeWithï¼Œç„¶åè°ƒç”¨å®ƒçš„invokeSuspendæ–¹æ³•ï¼š å¯ä»¥çœ‹åˆ°å…ˆæ‰§è¡ŒwithContextï¼Œå› ä¸ºwithContextå¯åŠ¨çš„æ—¶å€™ï¼Œé»˜è®¤çš„çŠ¶æ€æ˜¯COROUTINE_SUSPENDEDï¼Œæ‰€ä»¥é€€å‡ºäº†ï¼Œè¿”å›äº†var2ï¼Œæ­¤æ—¶çš„label=1äº†ã€‚å½“æ‰§è¡Œå®ŒwithContextçš„æ—¶å€™ï¼Œä¼šé€šçŸ¥ä¼ ç»™withContextçš„continuationï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢çš„CoroutineDispatchersActivity$demo2$1è¿™ä¸ªSuspendLambdaã€‚æ‰€ä»¥ä¼šå†æ¬¡æ‰§è¡Œå®ƒçš„invokeSuspendæ–¹æ³•ï¼Œæ­¤æ—¶lable=1ï¼Œæ‰€ä»¥æœ€åè¿”å›äº†Unit.INSTANCEï¼Œæ•´ä¸ªinvokeSuspendç»“æŸï¼Œè¿™å°±æ˜¯æŒ‚èµ·çš„åŸå› ã€‚ è‡³äºä¸ºä»€ä¹ˆåœ¨CoroutineDispatchersActivity$demo2$1ä¸­é‡åˆ°äº†è¿”å›å€¼ä¸ºCOROUTINE_SUSPENDEDæ—¶å€™ï¼Œä¸ä¼šç»§ç»­æ‰§è¡Œäº†å‘¢ï¼Ÿçœ‹ä¸‹BaseContinuationImplä¸­çš„resumeWithé€»è¾‘ï¼š åœ¨BaseContinuationImplä¸­çš„resumeWithä¸­ï¼Œå¦‚æœinvokeSuspendè¿”å›å€¼æ˜¯COROUTINE_SUSPENDEDï¼Œåˆ™ç›´æ¥returnäº†ï¼Œä¸å¾€ä¸Šå±‚çš„continuationè°ƒç”¨äº†ã€‚\nè‡³äºå†æ¬¡æ‰§è¡ŒCoroutineDispatchersActivity$demo2$1çš„invokeSuspendæ–¹æ³•æ˜¯åœ¨ä»€ä¹ˆæ—¶å€™ï¼Œå¯ä»¥è¿½æº¯åˆ°withContextä¸­ï¼š æ‰§è¡Œäº†blockçš„startCoroutineCancellableï¼š æ­¤å¤„å¾ˆç†Ÿæ‚‰å•Šï¼Œè¿™ä¸åˆå¯åŠ¨äº†ä¸€ä¸ªåç¨‹å—ï¼Ÿåç¨‹å¥—åç¨‹å•Šã€‚å¥½å§ï¼Œæˆ‘ä»¬ç›´æ¥çœ‹completionçš„å›è°ƒï¼Œåœ¨åç¨‹æŒ‚èµ·å‡½æ•°æ‰§è¡Œå®Œåï¼Œä¼šæ‰§è¡Œcompleteçš„resumeWithæ–¹æ³•ï¼Œæ­¤å¤„æ˜¯DispatchedCoroutineå¯¹è±¡ï¼Œç»§æ‰¿è‡ªScopeCoroutineï¼š å®ƒæ˜¯å…ˆå–continuationä¸­contextçš„ContinuationInterceptorï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢launchå¯åŠ¨çš„dispatchersï¼Œå¯¹åº”çš„æ˜¯Dispatchers.Defaultï¼Œæœ€ç»ˆæ‰§è¡ŒDispatchersçš„resumeCancellableWithæ–¹æ³•ï¼Œåœ¨è¯¥æ–¹æ³•é‡Œé¢æœ€ç»ˆä¼šåœ¨åç¨‹æŒ‡å®šçš„çº¿ç¨‹ä¸­æ‰§è¡Œåç¨‹ä»£ç å—ã€‚æ‰€ä»¥åœ¨ä¸Šé¢æ—¥å¿—ä¸­èƒ½çœ‹åˆ°withContextæ‰§è¡Œå®Œåï¼Œlaunchä¹‹åçš„ä»£ç èƒ½å›åˆ°æŒ‡å®šçš„çº¿ç¨‹ä¸­æ‰§è¡Œã€‚\nwithcontextæ‰§è¡Œå®Œäº†åä¼šæ‰§è¡Œå¤–é¢åç¨‹çš„resumeWithï¼Œæ‰€ä»¥launchçš„invokeSuspendå†æ¬¡æ‰§è¡Œã€‚å†æ¬¡æ‰§è¡Œçš„æ—¶å€™ä¼šå›åˆ°è‡ªå·±çš„çº¿ç¨‹ã€‚çœŸç›¸å¤§ç™½äº†ï¼\n","date":"2024-11-15T00:00:00Z","permalink":"https://example.com/p/%E5%8D%8F%E7%A8%8B%E6%8C%82%E8%B5%B7%E5%8E%9F%E7%90%86/","title":"åç¨‹æŒ‚èµ·åŸç†"},{"content":"åœ¨ä¸Šä¸€èŠ‚ä»‹ç»è¿‡Dispatchers.IOï¼Œå®ƒæ˜¯ä¸€ä¸ªCoroutineDispatcherå¯¹è±¡ï¼ŒCoroutineDispatcherçš„æ‰§è¡Œæ˜¯åœ¨DispatchedContinuationä¸­çš„resumeCancellableWithæ–¹æ³•ï¼Œå¦‚æœCoroutineDispatcherçš„isDispatchNeededè¿”å›trueï¼Œåˆ™ä¼šæ‰§è¡ŒCoroutineDispatcherçš„dispatchæ–¹æ³•ã€‚å¦åˆ™ç›´æ¥æ‰§è¡Œè¯¥runnableã€‚\nDispatchers.Main åœ¨å®‰å“å¹³å°ä¸‹ï¼Œå®ƒå…¶å®æ˜¯ä¸€ä¸ªHandlerContextå¯¹è±¡ï¼š çœ‹ä¸‹å®ƒçš„isDispatchNeededå’Œdispatchæ–¹æ³•ï¼š æ­¤æ—¶invokeImmediatelyé»˜è®¤æ˜¯falseï¼Œå› æ­¤isDispatchNeededè¿”å›trueã€‚æ‰€ä»¥ä¼šæ‰§è¡Œå®ƒçš„dispatchæ–¹æ³•ã€‚åœ¨dispatchæ–¹æ³•ä¸­å°†runnableç»™åˆ°äº†ä¸»çº¿ç¨‹çš„æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œç„¶åç­‰ä¸»çº¿ç¨‹ä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­å–è¯¥runnableã€‚æ‰€ä»¥åœ¨ä¸Šä¸€èŠ‚ä¾‹å­ä¸­å®ƒæ˜¯æ™šäºonCreateæ–¹æ³•æ‰§è¡Œçš„ã€‚\nDispatchers.Main.immediate å®ƒæ˜¯HandlerContextä¸­çš„immediateå˜é‡: å¯ä»¥çœ‹åˆ°å®ƒæ˜¯æ–°åˆ›å»ºäº†ä¸€ä¸ªHandlerContextï¼Œå¹¶ä¸”invokeImmediatelyæ˜¯trueã€‚åœ¨ä¸Šä¸€èŠ‚çš„ä¾‹å­ä¸­ï¼Œå®ƒçš„isDispatchNeededè¿”å›falseã€‚æ‰€ä»¥å®ƒæ˜¯ç›´æ¥æ‰§è¡ŒSuspendLambdaçš„resumeWithæ–¹æ³•ï¼Œå› æ­¤ä¸Šä¸€èŠ‚ä¾‹å­ä¸­å®ƒæ˜¯è¦æ—©äºDispatchs.Mainæ‰§è¡Œçš„ã€‚\nDispatchers.IO çœ‹ä¸‹å®ƒçš„CoroutineDispatcherï¼Œå¯¹åº”çš„å­ç±»æ˜¯DefaultIoSchedulerï¼ŒCoroutineDispatcherçš„isDispatchNeededæ–¹æ³•é»˜è®¤è¿”å›trueï¼Œæ‰€ä»¥ä¼šæ‰§è¡Œå®ƒçš„dispatchæ–¹æ³•ï¼š åœ¨dispatchæ–¹æ³•ä¸­è°ƒç”¨äº†defaultçš„dispatchæ–¹æ³•ï¼Œdefaultå®é™…æ˜¯ä¸€ä¸ªLimitedDispatcheræ–¹æ³•ï¼Œçœ‹ä¸‹å®ƒçš„dispatchæ–¹æ³•ï¼š åœ¨ä¸Šé¢2å¤„ï¼Œåˆ¤æ–­å½“å‰runningWokersçš„æ•°é‡ï¼Œå¦‚æœå¤§äºparallelismçš„æ—¶å€™ï¼Œåˆ™ä¸åˆ›å»ºWorkerï¼Œæ­¤å¤„çš„parallelismçš„å¤§å°æ˜¯64ã€‚ä»æ­¤å¤„ä¹Ÿèƒ½çœ‹å‡ºæ¥Dispatchers.IOçš„çº¿ç¨‹æ•°é‡ä¸ä¼šè¶…è¿‡64ä¸ªã€‚ æœ€ç»ˆè¯¥æ–¹æ³•é‡Œé¢ä¼šé€šè¿‡DefaultScheduler.dispatchWithContextæ¥åˆ›å»ºCoroutineSchedulerï¼Œæ¥çœ‹ä¸‹åˆ›å»ºçº¿ç¨‹æ± çš„å‡ ä¸ªå‚æ•°ï¼š æ ¸å¿ƒçº¿ç¨‹æ•°ï¼š æœ€å°2ä¸ªï¼Œæœ€å¤§æ˜¯cpuçš„æ ¸æ•° æœ€å¤§çº¿ç¨‹æ•°ï¼š æœ€å¤§çº¿ç¨‹æ•°å–å€¼(1 shl BLOCKING_SHIFT) - 2ï¼šæœ€ç»ˆå¾—åˆ°çš„å€¼æ˜¯2^21-2 = 2097150ã€‚ éæ ¸å¿ƒçº¿ç¨‹ç©ºé—²æ—¶é—´æ˜¯60sã€‚\nç»“è®ºï¼šDispatchers.IOåˆ›å»ºçš„æœ€å¤§çš„çº¿ç¨‹ä¸ªæ•°ä¸º:Math.max(64,cpuæ ¸æ•°)\nDispatchers.Default å®ƒæ˜¯ç”±DefaultScheduleræ„å»ºçš„çº¿ç¨‹æ± ï¼Œå®ƒæ‰€åˆ›å»ºçš„æœ€å¤§çš„çº¿ç¨‹ä¸ªæ•°ä¸º:Math.max(2,cpuæ ¸æ•°)\nDispatchers.IOå’ŒDispatchers.Defaultéƒ½æ˜¯ç”±DefaultScheduleræ„å»ºçš„ï¼Œè€ŒDefaultSchedulerå…¶å®æ˜¯ä¸€ä¸ªå•ä¾‹ï¼Œå› æ­¤ä¸éš¾çœ‹å‡ºå®ƒä¸¤æ˜¯å…±ç”¨ä¸€ä¸ªçº¿ç¨‹æ± çš„ï¼Œåªä¸è¿‡å½“Dispatchers.IOæ—¶å€™ï¼Œæœ€å¤§çº¿ç¨‹ä¸ªæ•°æ§åˆ¶åœ¨Math.min(64,cpuæ ¸æ•°)ï¼Œæœ€å¤šä¸ä¼šè¶…è¿‡64ä¸ªï¼ŒDispatchers.Defaultæ§åˆ¶åœ¨cpuæ ¸æ•°ä¸ªæ•°ä¸Šã€‚Dispatchers.Defaultå¸¸ç”¨ä½œcpuå¯†é›†å‹çš„ä»»åŠ¡ï¼Œæ¯”å¦‚å›¾ç‰‡æ¨¡ç³Šå¤„ç†ã€ç¹æ‚çš„è®¡ç®—å‹å¯ä»¥ç”¨è¿™ç§ç±»å‹çš„çº¿ç¨‹æ± ã€‚Dispatchers.IOç”±äºå®ƒçš„çº¿ç¨‹æ•°é‡å¤šï¼Œå¹¶ä¸”å®ƒä¸èƒ½æ¶ˆè€—cpuèµ„æºï¼Œå› æ­¤å¸¸ç”¨ä½œioå¤„ç†ï¼Œæ–‡ä»¶è¯»å†™ç­‰æ“ä½œä¸Šã€‚ å…³äºè¿™ç‚¹ï¼Œå¯ä»¥çœ‹è¿™ç¯‡æ–‡ç« ï¼šdispatcheræ‹†è§£\n","date":"2024-11-13T00:00:00Z","image":"https://example.com/p/%E5%8D%8F%E7%A8%8B%E4%B8%AD%E7%9A%84%E7%BA%BF%E7%A8%8B/cover_hu17536845123992820283.jpg","permalink":"https://example.com/p/%E5%8D%8F%E7%A8%8B%E4%B8%AD%E7%9A%84%E7%BA%BF%E7%A8%8B/","title":"åç¨‹ä¸­çš„çº¿ç¨‹"},{"content":"åœ¨è®²è§£å¦‚ä½•åˆ‡æ¢çº¿ç¨‹ä¹‹å‰ï¼Œæœ‰å¿…è¦å…ˆäº†è§£ä¸‹CoroutineScopeã€‚åç¨‹ä½œç”¨åŸŸï¼Œå®ƒé‡Œé¢æŒæœ‰CoroutineContextï¼Œç”¨æ¥ç®¡ç†å®ƒçš„ä½œç”¨åŸŸèŒƒå›´å†…çš„æ‰€æœ‰åç¨‹ã€‚\nCoroutineScope(åç¨‹ä½œç”¨åŸŸ) CoroutineScopeç»„æˆ å¯è§å®ƒåªæ˜¯ä¸€ä¸ªæ¥å£ï¼Œé‡Œé¢å®šä¹‰äº†ä¸€ä¸ªcoroutineContextã€‚å‰é¢ä»‹ç»è¿‡coroutineContextæ˜¯åç¨‹çš„ä¸Šä¸‹æ–‡ï¼Œå®ƒé‡Œé¢æ˜¯ç”±Elementæ‹¼æ¥è€Œæˆçš„ï¼Œè€ŒElementä¸»è¦åˆ†ä¸ºå¦‚ä¸‹å‡ ç§ï¼š\nCoroutineDispatcherï¼šå®ƒæ˜¯çº¿ç¨‹åˆ†å‘å™¨ã€‚å…¶ä¸­Dispatcher.IOå’ŒDispatcher.Mainã€Dispatchers.Main.immediateéƒ½æ˜¯ç»§æ‰¿è‡ªäºå®ƒ Jobï¼šå®ƒæ˜¯ç”¨æ¥å–æ¶ˆåç¨‹ã€çˆ¶åç¨‹ä¸å­åç¨‹å–å¾—è”ç³»çš„æ¡¥æ¢ã€‚å¸¸è§çš„æœ‰SupervisorJob CoroutineNameï¼šç”¨æ¥ç»™åç¨‹èµ·åå­—çš„ä½œç”¨ CoroutineExceptionHandlerï¼šå®ƒæ˜¯ç”¨æ¥æ•æ‰åç¨‹å¼‚å¸¸çš„å›è°ƒå™¨ æ‰€ä»¥å®Œæ•´çš„CoroutineContextç»„æˆéƒ¨åˆ†å¦‚ä¸‹ï¼š job+dispatchers+CoroutineName+CoroutineExceptionHandler\nCoroutineScopeåˆ†ç±» ç›®å‰kotlinå·²ç»å†…ç½®äº†å„ç§CoroutineScopeï¼Œä¸‹é¢æ¥è¯´ä¸‹ä»–ä»¬çš„åŒºåˆ«\nGlobalScope ä¸Šé¢ç”¨åˆ°çš„GlobalScopeå°±æ˜¯ä¸€ä¸ªåç¨‹ä½œç”¨åŸŸï¼š å¯ä»¥çœ‹å‡ºæ¥å®ƒæ˜¯ä¸€ä¸ªå•ä¾‹çš„scopeï¼Œç”Ÿå‘½å‘¨æœŸå’Œappä¿æŒä¸€è‡´ï¼Œå¹¶ä¸”å®ƒçš„contextæ˜¯ä¸€ä¸ªEmptyCoroutineContextã€‚å¹³æ—¶å¼€å‘æ—¶å€™ä¸ä¼šå»ç”¨å®ƒ\nrunBlocking æ˜¯ä¸€ä¸ªé˜»å¡å¼çš„åç¨‹ä½œç”¨åŸŸï¼Œä¼šé˜»å¡åç¨‹å¤–é¢çš„çº¿ç¨‹ï¼Œå†…éƒ¨æ˜¯é€šè¿‡javaçš„LockSupport.parké˜»å¡ä½çº¿ç¨‹æ¥å®ç°çš„ã€‚ MainScope å®ƒæ˜¯ä¸€ä¸ªæŒ‡å®šåç¨‹åˆ†å‘åœ¨ä¸»çº¿ç¨‹ä¸­ï¼Œå¹¶ä¸”ä½¿ç”¨åˆ°çš„Jobæ˜¯SupervisorJobï¼Œå®ƒçš„ä½œç”¨æ˜¯å½“å­åç¨‹å‡ºé”™çš„æ—¶å€™ï¼Œä¸å½±å“åˆ°çˆ¶åç¨‹ä¸­çš„å…¶ä»–å­åç¨‹ å®ƒæ˜¯ä¸€ä¸ªContextScopeï¼Œç»§æ‰¿è‡ªCoroutineScopeï¼Œå¹¶ä¸”å®ƒçš„contextæ˜¯ç”±SupervisorJob()å’ŒDispatchers.Mainç»„æˆçš„ä¸€ä¸ªcontextã€‚æˆ‘ä»¬ä¸€èˆ¬è‡ªå®šä¹‰CoroutineScopeçš„æ—¶å€™ä¹Ÿæ˜¯å®šä¹‰ä¸€ä¸ªContextScopeï¼Œä»–çš„æ„é€ æ–¹æ³•éœ€è¦ä¼ å…¥ä¸€ä¸ªCoroutineContextã€‚ CoroutineScopeé¡¶çº§æ–¹æ³• å®ƒä¹Ÿæ˜¯ä¸€ä¸ªContextScopeï¼Œå®ƒçš„ä¸Šä¸‹æ–‡å…ˆçœ‹ä¼ è¿›æ¥çš„contextä¸­çš„jobæ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºï¼Œåˆ™åˆå§‹åŒ–ä¸€ä¸ªjobã€‚å¦‚æœä¸ä¸ºç©ºï¼Œåˆ™ä½¿ç”¨ä¼ è¿›æ¥çš„contextã€‚\ncoroutineScopeé¡¶çº§æ–¹æ³• å®ƒæ˜¯ä¸€ä¸ªsuspendæ–¹æ³•ï¼Œå®ƒæ˜¯é€šè¿‡é—­åŒ…çš„å½¢å¼è¿”å›ä¸€ä¸ªCoroutineScopeï¼Œå¯¹åº”çš„å­—èŠ‚ç å¦‚ä¸‹ï¼š ä¼šå°†ScopeCoroutineç»™åˆ°blockï¼Œä¹Ÿå°±æ˜¯é—­åŒ…ä¸­çš„CoroutineScopeï¼Œæ¥ç€ä¼šè°ƒç”¨UndispatchedKt.startUndispatchedOrReturn: æœ€ç»ˆè°ƒç”¨äº†block.invokeæ–¹æ³•ï¼Œå†™ä¸ªdemoçœ‹ä¸‹æ•ˆæœï¼š æ—¥å¿—å¦‚ä¸‹ï¼š ä»æ—¥å¿—å¯ä»¥çœ‹å‡ºæ¥ï¼Œå®ƒæ˜¯å…ˆç­‰åˆ°coroutineScopeé‡Œé¢delayæ‰§è¡Œå®Œäº†ï¼Œæ‰æ‰§è¡Œå¤–é¢çš„é€»è¾‘ã€‚åœ¨å­—èŠ‚ç å±‚é¢ï¼Œå®ƒä¼šæŠŠcoroutineScopeå¤–é¢çš„ä»£ç ç¼–è¯‘æˆSuspendLambdaï¼Œå®ƒä¹Ÿæ˜¯ä¸ªContinuationï¼Œç­‰åˆ°æ‰§è¡Œå®Œäº†coroutineScopeå†…éƒ¨çš„ä»£ç ï¼Œæ‰ä¼šå›è°ƒåˆ°coroutineScopeå¤–é¢çš„SuspendLambdaä¸­æ¥ï¼š ä¸Šé¢åˆ†æè¿‡UndispatchedKt.startUndispatchedOrReturnä¸­è°ƒç”¨äº†blockçš„invokeæ–¹æ³•ï¼Œæ­¤å¤„çš„blockæ­£å¯¹åº”äº†CoroutineDispatchersActivity$demo7$1è¿™ä¸ªSuspendLambdaå¯¹è±¡ï¼š åœ¨demo7ä¸­å°†CoroutineDispatchersActivity$demo7$1è¿™ä¸ªcontinuationä¼ é€’åˆ°coroutineScopeä¸­ï¼Œè€Œå®ƒçš„invokeæ–¹æ³•å¦‚ä¸‹ï¼š åˆ›å»ºäº†CoroutineDispatchersActivity$demo7$1åï¼Œç»§è€Œè°ƒç”¨äº†invokeSuspendæ–¹æ³•ï¼Œè€ŒinvokeSuspendé‡Œé¢æ˜¯è¦ç­‰åˆ°coroutineScopeé—­åŒ…ä¸­çš„delayæŒ‚èµ·ç»“æŸåï¼Œæ‰ä¼šå†æ¬¡å›åˆ°invokeSuspendæ–¹æ³•ï¼Œæœ€åæ‰ä¼šè¾“å‡ºã€Œdemo7: coroutineScope outsideã€çš„æ—¥å¿—ï¼Œè¿™ä¹Ÿæ˜¯åç¨‹æŒ‚èµ·çš„è°ƒç”¨é¡ºåºã€‚\nsupervisorScopeé¡¶çº§æ–¹æ³• å®ƒå’Œä¸Šé¢çš„coroutineScopeé¡¶çº§æ–¹æ³•å·®ä¸å¤šï¼Œä¹Ÿæ˜¯å…ˆè°ƒç”¨å®Œé—­åŒ…ä¸­çš„é€»è¾‘ï¼Œç„¶åæ‰æ‰§è¡ŒsupervisorScopeå¤–é¢çš„ä»£ç ã€‚çœ‹ä¸‹å®ƒçš„å®ç°å°±çŸ¥é“åŒºåˆ«äº†ï¼š ä»–æ‰€ä½¿ç”¨çš„CoroutineScopeæ˜¯ä¸€ä¸ªSupervisorCoroutineï¼Œå®ƒå’Œä¸Šé¢ç”¨åˆ°çš„ScopeCoroutineåŒºåˆ«æ˜¯é‡å†™äº†childCancelledæ–¹æ³•ï¼Œå¹¶è¿”å›falseï¼Œæ­¤æ–¹æ³•æ˜¯å­åç¨‹å‘ç”Ÿå¼‚å¸¸åï¼Œè¯¥ä¸è¯¥å–æ¶ˆå…¶å®ƒçš„å­åç¨‹ï¼Œä¸‹é¢æ¥éªŒè¯ä¸‹ï¼š åœ¨supervisorScopeé—­åŒ…ä¸­launch1å‘ç”Ÿå¼‚å¸¸äº†ï¼Œç”±äºsupervisorScopeä¸ä¼šå»å¤„ç†å¼‚å¸¸ï¼Œå°†å¼‚å¸¸äº¤ç»™äº†launch1å¤„ç†ï¼Œæ‰€ä»¥launch2ä¸­çš„ä»£ç èƒ½ç»§ç»­æ‰§è¡Œã€‚è€Œåœ¨coroutineScopeä¸­ï¼Œå½“launch1å‘ç”Ÿå¼‚å¸¸çš„æ—¶å€™ï¼Œä¼šå°†å¼‚å¸¸äº¤ç»™äº†coroutineScopeï¼Œæœ€ç»ˆå¯¼è‡´launch2çš„åç¨‹æ— æ³•ç»§ç»­æ‰§è¡Œã€‚\nJob Jobå®ç°äº†CoroutineContext.Elementï¼Œå¯ä»¥ç”¨æ¥å–æ¶ˆã€å¯åŠ¨ä¸€ä¸ªåç¨‹ï¼Œå¹¶ä¸”å’Œçˆ¶åç¨‹ç»‘å®šäº†å…³ç³»ï¼š å®ƒä¸‹é¢æœ‰å‡ ä¸ªå…³é”®çš„å­ç±»ï¼š ä»å›¾ä¸Šå¯ä»¥çœ‹å‡ºæ¥å‰é¢åˆ†æçš„coroutineScopeå’ŒsupervisorScopeä¸¤ä¸ªé¡¶çº§æ–¹æ³•æ‰€ä½¿ç”¨çš„ä½œç”¨åŸŸScopeCoroutineæœ€ç»ˆä¹Ÿæ˜¯ä¸€ä¸ªJobã€‚\nçº¿ç¨‹ä¾‹å­ å…ˆçœ‹ä¸€ä¸ªä¾‹å­ï¼š åˆ†åˆ«æŒ‡å®šäº†å››ç§çº¿ç¨‹çš„ç”¨æ³•ï¼Œæ—¥å¿—å¦‚ä¸‹ï¼š ç¬¬ä¸€æ¬¡ï¼š ç¬¬äºŒæ¬¡ï¼š Dispatchers.Main.immediateï¼šæŒ‡å®šçš„ä¸»çº¿ç¨‹ä¼šæœ€å…ˆæ‰§è¡Œ Dispatchers.Mainï¼šæŒ‡å®šçš„ä¸»çº¿ç¨‹ä¼šæ™šäºåç¨‹å¤–é¢çš„ä¸»çº¿ç¨‹ Dispatchers.IOå’ŒDispatchers.Defaultï¼šæŒ‡å®šçš„çº¿ç¨‹æ²¡æœ‰å…ˆåä¹‹åˆ†\nCoroutineScope.lanuch lanuchæ–¹æ³•æ˜¯åç¨‹ä½œç”¨åŸŸçš„æ‰©å±•æ–¹æ³•ï¼Œæ¯”å¦‚ä¸Šé¢ä¾‹å­ä¸­çš„GlobalScopeå®ƒå°±æ˜¯ç»§æ‰¿è‡ªCoroutineScope:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 public fun CoroutineScope.launch( context: CoroutineContext = EmptyCoroutineContext, start: CoroutineStart = CoroutineStart.DEFAULT, block: suspend CoroutineScope.() -\u0026gt; Unit ): Job { //â‘  val newContext = newCoroutineContext(context) //â‘¡ val coroutine = if (start.isLazy) LazyStandaloneCoroutine(newContext, block) else StandaloneCoroutine(newContext, active = true) //â‘¢ coroutine.start(start, coroutine, block) //â‘£ return coroutine } å‚æ•°ï¼š contextï¼šlauncä¼ è¿›æ¥çš„contextï¼Œæ¯”å¦‚ä¸Šé¢ä¾‹å­ä¸­ä¼ è¿›æ¥çš„Dispatchers.Mainã€Dispatchers.IOè¿™äº›éƒ½æ˜¯CoroutineContextã€‚å¦‚æœæ²¡ä¼ å°±ç”¨EmptyCoroutineContextã€‚ startï¼šCoroutineStartçš„æšä¸¾ç±»ï¼Œè¡¨ç¤ºå¯åŠ¨æ¨¡å¼ï¼Œé»˜è®¤æ˜¯DEFAULT blockï¼šåç¨‹ä»£ç å—ï¼Œæ˜¯ä¸€ä¸ªCoroutineScopeçš„æ‰©å±•æŒ‚èµ·å‡½æ•° å°†å¤–ç•Œä¼ è¿›æ¥çš„contextå’Œå½“å‰CoroutineScopeçš„contextè¿›è¡Œåˆå¹¶å¤„ç† é»˜è®¤æ˜¯DEFAULTæ¨¡å¼ï¼Œæ‰€ä»¥ä¼šåˆå§‹åŒ–ä¸€ä¸ªStandaloneCoroutineï¼Œä¼šæŠŠnewContextä½œä¸ºè‡ªå·±çš„parentContextï¼Œå®ƒæ—¢æ˜¯ä¸€ä¸ªContinuationï¼Œä¹Ÿæ˜¯ä¸€ä¸ªCoroutineScope è°ƒç”¨StandaloneCoroutineçš„startæ–¹æ³•ï¼Œå¹¶æŠŠå¯åŠ¨æ¨¡å¼ï¼ŒStandaloneCoroutineï¼Œåç¨‹æŒ‚èµ·å‡½æ•°ä¼ è¿›å»äº† StandaloneCoroutineä½œä¸ºlauchçš„è¿”å›å€¼ StandaloneCoroutineå®ƒæ˜¯ä¸€ä¸ªJobç±»å‹ï¼Œä¹Ÿæ˜¯ç»§æ‰¿è‡ªAbstractCoroutineï¼Œçœ‹ä¸‹å®ƒçš„startæ–¹æ³•ï¼š è¿™é‡Œè°ƒç”¨äº†startå˜é‡çš„invokeæ–¹æ³•ï¼Œå› ä¸ºCoroutineStarté‡å†™äº†invokeæ–¹æ³•ï¼Œæ‰€ä»¥èƒ½ç›´æ¥è¿™ä¹ˆè°ƒï¼Œç›¸å½“äºæ˜¯ä¸€ä¸ªé—­åŒ…çš„è°ƒç”¨æ–¹å¼ï¼Œè¿™é‡Œè°ƒç”¨äº†ä¸‰å‚çš„invokeï¼š ç¬¬ä¸€ä¸ªå‚æ•°ï¼šæŒ‚èµ·å‡½æ•°é—­åŒ…ï¼Œä¹Ÿå°±æ˜¯åç¨‹è¦æ‰§è¡Œçš„ä»£ç å— ç¬¬äºŒä¸ªå‚æ•°ï¼šstartæ–¹æ³•ä¼ è¿›æ¥çš„StandaloneCoroutine ç¬¬ä¸‰ä¸ªå‚æ•°ï¼šstartæ–¹æ³•ä¼ è¿›æ¥çš„thisï¼Œä¹Ÿæ˜¯StandaloneCoroutine CoroutineStartæ˜¯DEFAULTç±»å‹ï¼Œæ‰€ä»¥ä¼šè°ƒç”¨æŒ‚èµ·å‡½æ•°çš„startCoroutineCancellableæ–¹æ³•ï¼š åœ¨ä¸Šé¢åˆ†æcreateCoroutineæ—¶å€™ä¹Ÿæ˜¯é€šè¿‡createCoroutineUnintercepted(receiver, completion).intercepted()ï¼Œåˆ›å»ºäº†delegateï¼Œæœ€ç»ˆæ˜¯ä¸€ä¸ªContinuationï¼Œä¹Ÿæ˜¯ä¸€ä¸ªsuspendLambdaã€‚æˆ‘ä»¬ç›´æ¥çœ‹ContinuationImplçš„interceptedæ–¹æ³•ï¼š interceptedæ–¹æ³•é‡Œé¢å–contextå˜é‡ä¸­çš„keyä¸ºContinuationInterceptorçš„contextï¼Œè€Œcontextæœ€ç»ˆæ˜¯completionçš„contextï¼Œcompletionæ˜¯å‰é¢startæ–¹æ³•ä¼ è¿›æ¥çš„StandaloneCoroutineï¼Œå®ƒæ˜¯ç»§æ‰¿è‡ªAbstractCoroutineï¼š parentContextæ˜¯launchæ–¹æ³•ä¼ è¿›æ¥çš„context+CoroutineScopeè‡ªå·±çš„contextæ‹¼æ¥çš„ä¸€ä¸ªcontext thisï¼šAbstractCoroutineå®ç°äº†jobæ¥å£ï¼Œjobä¹Ÿæ˜¯ä¸€ä¸ªCoroutineContext åœ¨ä¸Šé¢ä¾‹å­ä¸­lauchæ–¹æ³•æ˜¯é€šè¿‡GlobalScopeå¯åŠ¨çš„ï¼Œå®ƒçš„contextæ˜¯ä¸€ä¸ªEmptyCoroutineContextï¼Œæ‰€ä»¥ä¼ ç»™AbstractCoroutineçš„parentContextå…¶å®å°±æ˜¯launchæ–¹æ³•ä¼ è¿›å»çš„contextï¼Œä¹Ÿå°±æ˜¯Dispatchers.ioã€Dispatchers.mainç­‰ã€‚ å›åˆ°ContinuationImplçš„interceptedæ–¹æ³•ï¼Œå–contextçš„ContinuationInterceptor,ç„¶åè°ƒç”¨interceptContinuationæ–¹æ³•ï¼Œçœ‹ä¸‹Dispatchers.ioï¼Œå®ƒæœ€ç»ˆç»§æ‰¿è‡ªCoroutineDispatcherï¼š ç»“è®ºï¼š å¦‚æœlauchä¼ çš„æ˜¯Dispatchers.ioï¼Œåˆ™lauchå…ˆåˆ›å»ºDispatchedContinuationï¼Œç„¶åè°ƒç”¨resumeCancellableWithæ–¹æ³•ï¼š å¦‚æœdispatcher.isDispatchNeededï¼ˆé»˜è®¤æ˜¯trueï¼‰ï¼Œæ‰ä¼šè¿›å…¥åˆ°dispatché€»è¾‘ï¼Œçœ‹ä¸‹dispatchers.ioï¼š è°ƒç”¨äº†default.dispatchæ–¹æ³•ï¼Œdiefaultæ˜¯ç”±UnlimitedIoScheduler.limitedParallelismåˆ›å»ºçš„LimitedDispatcherï¼Œæœ€ç»ˆä¼šæ‰§è¡Œåˆ°UnlimitedIoScheduler.dispatchæ–¹æ³•ï¼š DefaultSchedulerçš„dispatchWithContextæ–¹æ³•å¦‚ä¸‹ï¼š coroutineScheduleråˆ›å»ºå¦‚ä¸‹ï¼š æœ€ç»ˆä¼šæ‰§è¡Œåˆ°CoroutineSchedulerçš„dispatchæ–¹æ³•ï¼Œé‡Œé¢çš„ä»£ç å°±ä¸ç»†çœ‹äº†ï¼Œæ˜¯çº¿ç¨‹æ± éƒ¨åˆ†æ‰§è¡Œblockï¼Œå…³äºè¿™éƒ¨åˆ†åé¢å¯ä»¥æ·±ç©¶ä¸‹ï¼Œè€Œblockæ˜¯åœ¨DispatchedContinuationä¸­resumeCancellableWithæ–¹æ³•é‡Œé¢æŠŠthisç»™åˆ°äº†dispatcherçš„dispatchæ–¹æ³•ï¼Œè¯´æ˜DispatchedContinuationå®ç°äº†Runnableæ¥å£ï¼Œç›´æ¥çœ‹å®ƒçš„runæ–¹æ³•ï¼Œè¯¥æ–¹æ³•å®šä¹‰åœ¨å®ƒçš„çˆ¶ç±»DispatchedTaskä¸­ï¼š æ­¤å¤„æ‰§è¡Œäº†delegateçš„resumeæ–¹æ³•ï¼Œresumeæ–¹æ³•æ‰§è¡Œäº†resumeWithï¼Œæ³¨æ„æ­¤å¤„çš„delegateæ˜¯DispatchedContinuationä¸­ä¼ è¿›æ¥çš„continuationï¼Œå®ƒæ˜¯createCoroutineUnintercepted(receiver, completion).intercepted()åˆ›å»ºçš„delegateï¼Œæ˜¯ä¸€ä¸ªcontinuationå¯¹è±¡ï¼Œä¹Ÿæ˜¯suspendlambdaï¼Œåœ¨ä¸Šé¢åˆ›å»ºåç¨‹åˆ†æè¿‡baseContinuationImplçš„resumeWithæ–¹æ³•ï¼Œé‡Œé¢ä¼šæ‰§è¡Œåç¨‹çš„invokeSuspendæ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„åç¨‹æ‰§è¡Œä»£ç ã€‚æ‰§è¡Œå®Œäº†åä¼šæ‰§è¡Œcompleteçš„resumeWithï¼Œè€Œé€šè¿‡lauchåˆ›å»ºçš„åç¨‹ï¼Œæ­¤å¤„çš„completeæ˜¯launchæ–¹æ³•æ„é€ çš„StandaloneCoroutineå¯¹è±¡ï¼Œå®ƒçš„resumeWithæ–¹æ³•å®šä¹‰åœ¨AbstractCoroutineä¸­ï¼š AbstractCoroutineçš„afterCompletionï¼š æ­¤å¤„æ²¡æœ‰é€»è¾‘æ‰§è¡Œã€‚ æˆ‘ä»¬æ³¨æ„åˆ°åœ¨è®²è§£åç¨‹å¯åŠ¨çš„æ—¶å€™ï¼Œåˆ›å»ºdelegateçš„continuationæ—¶å€™è°ƒç”¨createCoroutineUninterceptedåªä¼ äº†completeï¼Œæ²¡æœ‰ä¼ receiverã€‚è€Œåœ¨launchå¯åŠ¨åç¨‹æ—¶å€™ï¼Œå°†StandaloneCoroutineä½œä¸ºreceiverä¼ ç»™äº†createCoroutineUninterceptedæ–¹æ³•ï¼š é»˜è®¤çš„æŒ‚èµ·å‡½æ•°çš„createæ–¹æ³•æ˜¯æŠ›å¼‚å¸¸çš„ï¼Œéœ€è¦SuspendLambdaçš„å­ç±»è‡ªå·±å»å®ç°ï¼š ç¼–è¯‘åçš„SuspendLambdaçš„å­ç±»createå®ç°ï¼š æ­¤å¤„å°†receiverä¼ åˆ°createä¸­æ²¡æœ‰ç”¨åˆ°ï¼Œæ‰€ä»¥å…¶å®è·Ÿå•å‚æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«å•Šã€‚\næ€»ç»“ ç»“è®ºï¼šåç¨‹åœ¨å¯åŠ¨è¿‡ç¨‹ä¸­ä¼šå–CoroutineContextä¸­çš„ContinuationInterceptorï¼Œç„¶åæ‰§è¡ŒinterceptContinuationã€‚è€Œæ­¤æ—¶å¦‚æœæ˜¯ä¸€ä¸ªDispatchers.IOï¼Œå®ƒåˆæ˜¯ç»§æ‰¿è‡ªCoroutineDispatcherï¼Œæ‰€ä»¥ä¼šæ‰§è¡Œåˆ°äº†CoroutineDispatcherçš„interceptContinuationã€‚æ­¤æ—¶å¾—åˆ°çš„æ˜¯ä¸€ä¸ªDispatchedContinuationå¯¹è±¡ï¼Œå¹¶æŠŠå½“å‰çš„CoroutineDispatcherå’Œåç¨‹å¯åŠ¨è¿‡ç¨‹ä¸­åˆ›å»ºçš„StandaloneCoroutineä¼ ç»™äº†ã€‚æ¥ç€ä¼šæ‰§è¡ŒDispatchedContinuationçš„resumeCancellableWithæ–¹æ³•ï¼Œåœ¨è¯¥æ–¹æ³•é‡Œé¢ä¼šåˆ¤æ–­CoroutineDispatcher.isDispatchNeededï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œä¼šè°ƒç”¨CoroutineDispatcherçš„dispatchæ–¹æ³•ï¼Œæœ€ç»ˆä¼šé€šè¿‡çº¿ç¨‹æ± ä¼šæ‰§è¡Œåˆ°DispatchedContinuationçš„runæ–¹æ³•ï¼Œå› ä¸ºå®ƒæ˜¯ä¸€ä¸ªRunnableå¯¹è±¡ã€‚åœ¨runæ–¹æ³•é‡Œé¢ï¼Œä¼šæ‰§è¡Œcontinuationçš„resumeæ–¹æ³•ï¼Œè€Œæ­¤å¤„çš„continuationæ˜¯ç¼–è¯‘å™¨ç»™æˆ‘ä»¬åˆ›å»ºçš„SuspendLambdaçš„å­ç±»ï¼Œæœ€ç»ˆä¼šæ‰§è¡Œå®ƒçš„invokeSuspendæ–¹æ³•ã€‚æ‰§è¡Œå®Œåä¼šæ‰§è¡Œåç¨‹å¯åŠ¨è¿‡ç¨‹ä¸­çš„StandaloneCoroutineçš„resumeWithæ–¹æ³•ã€‚ æ—¶åºå›¾: ","date":"2024-11-05T00:00:00Z","permalink":"https://example.com/p/%E5%8D%8F%E7%A8%8B%E5%A6%82%E4%BD%95%E5%88%87%E6%8D%A2%E7%BA%BF%E7%A8%8B/","title":"åç¨‹å¦‚ä½•åˆ‡æ¢çº¿ç¨‹"},{"content":" åœ¨è®²åç¨‹çš„å¦‚ä½•åˆ‡æ¢çº¿ç¨‹ä¹‹å‰ï¼Œæœ‰å¿…è¦å…ˆäº†è§£ä¸‹åç¨‹çš„ä¸Šä¸‹æ–‡æ˜¯ä»€ä¹ˆï¼Ÿå®ƒçš„ç»“æ„æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿä»¥åŠæˆ‘ä»¬å¦‚ä½•ä½¿ç”¨å®ƒï¼Ÿä»Šå¤©å¸¦ç€è¯¥é—®é¢˜æ¥è®¤è¯†å®ƒã€‚\nCoroutineContext åç¨‹ä¸Šä¸‹æ–‡éƒ½æ˜¯ç»§æ‰¿è‡ªCoroutineContextï¼Œå®ƒæ˜¯ä¸€ä¸ªæ¥å£ï¼Œå†…éƒ¨æ–¹æ³•ä»¥åŠå†…éƒ¨ç±»å¦‚ä¸‹ï¼š\nå®ƒçš„å®ç°å­ç±»æœ‰å¦‚ä¸‹ï¼š\næ¯”å¦‚æˆ‘ä»¬å¸¸è§çš„EmptyCoroutineContextï¼Œå®ƒçš„å†…éƒ¨å®ç°å¦‚ä¸‹ï¼š\nå¯ä»¥çœ‹åˆ°å®ƒçš„getã€foldã€plusã€minusKeyå‡ ä¸ªæ–¹æ³•éƒ½æ˜¯é»˜è®¤å®ç°ï¼Œä½ å¯ä»¥ç†è§£å®ƒå°±æ˜¯ä¸ªç©ºå£³å­çš„contextã€‚\nElement åœ¨è®²CoroutineContextå†…éƒ¨ç»“æ„ä¹‹å‰ï¼Œå…ˆæ¥è®¤è¯†ä¸‹Elementï¼Œå®ƒä¹Ÿå®ç°äº†CoroutineContextæ¥å£ï¼š\nElementä¸­æœ‰ä¸€ä¸ªkeyçš„å±æ€§ï¼Œè¿™é‡Œå¯ä»¥ç†è§£keyå°±æ˜¯å½“å‰Elementçš„å”¯ä¸€æ ‡è¯†ã€‚å®ç°ä¸€ä¸ªcontextçš„æ—¶å€™éœ€è¦æŒ‡æ˜å®ƒçš„keyæ˜¯å•¥ï¼Œæ­¤å¤„å°±æ˜¯ç”¨è¯¥keyæ¥æ ‡è¯† getï¼šå¦‚æœä¼ è¿›æ¥çš„keyå’Œè‡ªå·±çš„keyç›¸ç­‰ï¼Œåˆ™è¿”å›è‡ªå·±ï¼Œå¦åˆ™è¿”å›null foldï¼šå°†åˆå§‹å€¼å’Œå½“å‰elementè¿”å›ç»™lambdaï¼Œè®©lambdaè‡ªå·±å»å¤„ç† minusKeyï¼šå¦‚æœä¼ è¿›æ¥çš„keyå’Œè‡ªå·±ç›¸åŒï¼Œåˆ™è¿”å›EmptyCoroutineContextï¼Œå¦åˆ™è¿”å›è‡ªå·±ï¼Œå…¶å®æ˜¯åˆ é™¤å¯¹åº”keyçš„context.\nå†™äº†3ä¸ªcontextï¼Œç„¶åç”¨\u0026quot;+\u0026ldquo;æ‹¼æ¥ï¼š\nè‡ªå®šä¹‰contextçš„æ—¶å€™ï¼Œéœ€è¦ç»§æ‰¿è‡ªAbstractCoroutineContextElementï¼Œå®ƒæ˜¯ç»§æ‰¿è‡ªElementï¼Œå› ä¸ºå®ƒå¼ºåˆ¶è¦æ±‚éœ€è¦ä¸€ä¸ªkeyä½œä¸ºcontextçš„æ ‡è¯†ï¼Œä¸€èˆ¬keyçš„elementæ ‡è¯†æ˜¯å½“å‰contextï¼Œçœ‹ä¸Šé¢çš„Oneè¿™ä¸ªcontextï¼Œå®ƒçš„keyæ‹¥æœ‰çš„elementæ˜¯Oneã€‚\nè¾“å‡ºæ—¥å¿—å¦‚ä¸‹ï¼š\nOne()+Two()+Three()å¾—åˆ°çš„æ˜¯ä¸€ä¸ªCombinedContextï¼Œgetæ–¹æ³•é€šè¿‡Oneè¿™ä¸ªkeyå–åˆ°äº†Oneè¿™ä¸ªå–å¯¹åº”çš„Context\næ—¥å¿—å¦‚ä¸‹ï¼š å¯ä»¥çœ‹åˆ°æˆ‘ç»™Oneçš„contextæ‹¼æ¥äº†ä¸€ä¸ªEmptyCoroutineContextæ—¶å€™ï¼Œå¾—åˆ°çš„æ˜¯å®ƒè‡ªå·±ï¼Œ\u0026quot;+\u0026ldquo;æ˜¯é‡è½½äº†contextçš„plusæ–¹æ³•ï¼Œçœ‹ä¸‹plusæ–¹æ³•çš„å®ç°ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 public operator fun plus(context: CoroutineContext): CoroutineContext = //â‘  if (context === EmptyCoroutineContext) this else // fast path -- avoid lambda creation //â‘¡ context.fold(this) { acc, element -\u0026gt; //â‘¢ val removed = acc.minusKey(element.key) //â‘¢.1 if (removed === EmptyCoroutineContext) element else { // make sure interceptor is always last in the context (and thus is fast to get when present) //â‘£ val interceptor = removed[ContinuationInterceptor] //â‘¤ if (interceptor == null) CombinedContext(removed, element) else { //â‘¥ val left = removed.minusKey(ContinuationInterceptor) //â‘¦ if (left === EmptyCoroutineContext) CombinedContext(element, interceptor) else //â‘§ CombinedContext(CombinedContext(left, element), interceptor) } } } 1.å¦‚æœä¼ è¿›æ¥çš„contextæ˜¯EmptyCoroutineContextï¼Œåˆ™è¿”å›è‡ªå·±ï¼Œæ‰€ä»¥ä¸Šé¢çš„One()+EmptyCoroutineContextï¼Œå¾—åˆ°çš„æ˜¯Oneè¿™ä¸ªcontext 2.context.foldï¼Œä¼šæŠŠåˆå§‹å€¼å’Œcontextä¼ ç»™é—­åŒ…ï¼Œæ‰€ä»¥accæ˜¯å½“å‰contextï¼Œelementæ˜¯ä¼ è¿›æ¥çš„context 3.acc.minuskey(element.key)ï¼Œå¦‚æœä¼ è¿›æ¥çš„contextçš„keyå’Œå½“å‰contextçš„keyç›¸ç­‰ï¼Œåˆ™è¿”å›ä¼ è¿›æ¥çš„contextï¼Œæ‰€ä»¥æ–°çš„contextä¼šæŠŠæ—§çš„contextç»™è¦†ç›–æ‰äº† 4.å¦‚æœä¼ è¿›æ¥çš„contextçš„keyå’Œå½“å‰contextçš„keyä¸ç›¸ç­‰ï¼Œremovedåˆ™æ˜¯å½“å‰contextï¼ŒæŸ¥çœ‹å½“å‰contextä¸­æ˜¯å¦æœ‰ContinuationInterceptorç±»å‹çš„contextï¼Œæˆ‘ä»¬çš„dispatcheréƒ½æ˜¯å±äºè¯¥ç±»å‹ï¼Œéœ€è¦å•ç‹¬å¤„ç† 5.å¦‚æœcontextä¸­æ²¡æœ‰ContinuationInterceptorç±»å‹çš„contextï¼Œåˆ™åˆå§‹åŒ–å‡ºä¸€ä¸ªCombinedContextçš„contextï¼Œæ‰€ä»¥ä¸Šé¢çš„One()+Two()+Three()æ˜¯ä¸€ä¸ªCombinedContextçš„context 6.å¦‚æœå½“å‰contextä¸­å­˜åœ¨ContinuationInterceptorç±»å‹çš„contextï¼Œåˆ™ç»§ç»­åˆ¤æ–­å½“å‰contextæ˜¯ä¸æ˜¯ContinuationInterceptorç±»å‹çš„context 7.å¦‚æœæ˜¯ContinuationInterceptorç±»å‹çš„contextï¼Œåˆ™æŠŠä¼ è¿›æ¥çš„contextå’Œå½“å‰çš„contextç»„åˆæˆCombinedContextçš„context 8.å¦‚æœå½“å‰çš„contextä¸æ˜¯ä¸€ä¸ªContinuationInterceptorç±»å‹çš„contextï¼Œåˆ™æŠŠå½“å‰å½“å‰çš„contextå’Œä¼ è¿›æ¥çš„contextæ–°ç»„åˆæˆä¸€ä¸ªCombinedContextçš„contextï¼Œå†å’Œå‰é¢çš„ContinuationInterceptorç»„åˆæˆä¸€ä¸ªæ–°çš„CombinedContextçš„context\nCombinedContext 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 internal class CombinedContext( private val left: CoroutineContext, private val element: Element ) : CoroutineContext, Serializable { override fun \u0026lt;E : Element\u0026gt; get(key: Key\u0026lt;E\u0026gt;): E? { var cur = this while (true) { cur.element[key]?.let { return it } val next = cur.left if (next is CombinedContext) { cur = next } else { return next[key] } } } public override fun \u0026lt;R\u0026gt; fold(initial: R, operation: (R, Element) -\u0026gt; R): R = operation(left.fold(initial, operation), element) public override fun minusKey(key: Key\u0026lt;*\u0026gt;): CoroutineContext { //â‘  element[key]?.let { return left } //â‘¡ val newLeft = left.minusKey(key) return when { //â‘¢ newLeft === left -\u0026gt; this //â‘£ newLeft === EmptyCoroutineContext -\u0026gt; element //â‘¤ else -\u0026gt; CombinedContext(newLeft, element) } } override fun toString(): String = \u0026#34;[\u0026#34; + fold(\u0026#34;\u0026#34;) { acc, element -\u0026gt; if (acc.isEmpty()) element.toString() else \u0026#34;$acc, $element\u0026#34; } + \u0026#34;]\u0026#34; } å®ƒæ˜¯ç›´æ¥ç»§æ‰¿è‡ªCoroutineContextï¼Œæœ‰ä¸¤ä¸ªæ¯”è¾ƒé‡è¦çš„å±æ€§ï¼š\nleftï¼šCoroutineContextï¼Œå®ƒæ˜¯å·¦è¾¹çš„èŠ‚ç‚¹\nelementï¼šElementï¼Œå½“å‰èŠ‚ç‚¹\nå…¶å®å’Œé“¾è¡¨çš„ç»“æ„æœ‰ç‚¹ç±»ä¼¼ï¼Œleftç›¸å½“äºnextèŠ‚ç‚¹ã€‚\ngetï¼šé€’å½’èŠ‚ç‚¹ï¼Œç›´åˆ°leftèŠ‚ç‚¹ä¸æ˜¯CombinedContextç±»å‹çš„\nfoldï¼šå…ˆæŠŠleftå’Œåˆå§‹å€¼ç»„æˆä¸€ä¸ªåˆå§‹å€¼ï¼Œç„¶åå†æŠŠè¿™ä¸ªåˆå§‹å€¼å’Œå½“å‰èŠ‚ç‚¹ä¼ ç»™é—­åŒ…\nminusKeyï¼š\n1.å¦‚æœå½“å‰èŠ‚ç‚¹ä¸­æ‰¾åˆ°äº†è¯¥keyï¼Œåˆ™è¿”å›leftèŠ‚ç‚¹\n2.å¦‚æœæ‰¾ä¸åˆ°ï¼Œåˆ™ç»§ç»­åœ¨leftèŠ‚ç‚¹ä¸­æ‰¾\n3.å¦‚æœæ‰¾ä¸åˆ°è¿”å›this\n4.å¦‚æœæ‰¾åˆ°äº†åˆ™è¿”å›å½“å‰èŠ‚ç‚¹\n5.å¦åˆ™ç»§ç»­å¾€å·¦è¾¹å†æ‰¾\næ•´ä¸ªåˆ†ææ¥çœ‹ï¼Œåç¨‹ä¸­çš„contextå¦‚æœæ˜¯å¤šä¸ªcontextæ‹¼æ¥çš„æ—¶å€™å¦‚æœä¼ è¿›æ¥çš„æ˜¯EmptyCoroutineContextï¼Œåˆ™åªä¿å­˜è‡ªå·±ã€‚å¦‚æœä¼ è¿›æ¥çš„contextçš„keyå’Œå½“å‰contextçš„keyä¸€æ ·ï¼Œåˆ™ä¼šè¦†ç›–æ‰åŸæ¥çš„contextã€‚å¦‚æœéƒ½ä¸æ»¡è¶³ï¼Œåˆ™é‡‡ç”¨é“¾è¡¨çš„å½¢å¼æ’å…¥åˆ°åŸæ¥çš„contextå¤´èŠ‚ç‚¹ä¸Šï¼Œå¦‚æœä¼ è¿›æ¥çš„æ˜¯ContinuationInterceptorç±»å‹çš„ï¼Œåˆ™ä¼šæŠŠè¯¥ç±»å‹æ”¾åˆ°å¤´èŠ‚ç‚¹ã€‚\nç±»å›¾ å†æ¥ä¸€å¼ æœ¬æ¬¡è®²è§£çš„contextç±»å›¾ï¼š\n","date":"2024-11-04T00:00:00Z","permalink":"https://example.com/p/%E5%8D%8F%E7%A8%8B%E4%B8%8A%E4%B8%8B%E6%96%87/","title":"åç¨‹ä¸Šä¸‹æ–‡"},{"content":"kotlinä¸­inlineï¼Œnoinlineï¼ŒcrossinlineåŒºåˆ«ï¼Ÿ é»˜è®¤å‡½æ•°ä¸­å¦‚æœæ²¡åŠ inlineï¼Œé‚£å°±æ˜¯éå†…è”å‡½æ•°ï¼Œæ­¤æ—¶lambdaä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„ç±»ï¼Œè¯¥ç±»æ˜¯ç»§æ‰¿è‡ªLambdaæŠ½è±¡ç±»ï¼Œå¹¶å®ç°äº†Functionæ¥å£ï¼Œå…¶ä¸­invokeæ–¹æ³•å°±æ˜¯Functionæ¥å£çš„æ–¹æ³•ï¼Œinvokeä¸­çš„æ–¹æ³•å°±æ˜¯lambdaä»£ç å—çš„ä»£ç ã€‚ å†…è”å‡½æ•°(åŠ inlineå…³é”®å­—)çš„lambdaå¦‚æœæ²¡åŠ noinlineæˆ–crossinlineï¼Œé»˜è®¤ä¼šæŠŠlambdaçš„ä»£ç å—ç»™å¹³é“ºåˆ°è°ƒç”¨å¤„ï¼Œæ‰€ä»¥æ­¤æ—¶å¦‚æœåœ¨lambdaä¸­åŠ returnçš„è¯ï¼Œä¼šç›´æ¥ä¸æ‰§è¡Œå¤–å±‚å‡½æ•°åç»­ä»£ç ã€‚å¦‚æœæ˜¯éå†…è”å‡½æ•°çš„è¯ï¼Œç”±äºå®ƒæ˜¯ç”Ÿæˆä¸€ä¸ªå•ç‹¬çš„ç±»ï¼Œä¸å­˜åœ¨å¹³é“ºä»£ç ï¼Œæ‰€ä»¥returnæ˜¯ç¼–è¯‘ä¸è¿‡å»çš„ã€‚ noinlineå’Œinlineæ˜¯å¯¹ç«‹å…³ç³»ï¼Œå®ƒæ˜¯å°†lambdaä¸å†…è”å¤„ç†ï¼Œå¦‚æœä½ éœ€è¦å¯¹è¯¥lambdaä½œä¸ºå¯¹è±¡æ¥ä½¿ç”¨çš„æ—¶å€™ï¼Œæ­¤æ—¶éœ€è¦ç”¨åˆ°noinlineï¼Œå¦‚æœä¸€ä¸ªå†…è”å‡½æ•°éƒ½æ˜¯noinlineçš„lambdaè¡¨è¾¾å¼ï¼Œé‚£ä¹ˆæ­¤æ—¶asä¼šæç¤ºä½ æ­¤å¤„å¯ä»¥å»æ‰inlineå…³é”®å­—äº†ï¼Œå½“åšæ™®é€šçš„é«˜é˜¶å‡½æ•°æ¥å¤„ç†å°±è¡Œã€‚ crossinlineç®—æ˜¯åœ¨å†…è”å’Œéå†…è”ä¹‹é—´åšæ™ºèƒ½åŒ–é€‰æ‹©ï¼Œå¦‚æœä½ å°†lambdaè¡¨è¾¾å¼å½“åšå˜é‡æ¥ä½¿ç”¨ï¼Œæ­¤æ—¶ç¼–è¯‘å™¨ä¸ä¼šå†…è”è¯¥lambdaï¼Œæ¯”å¦‚ï¼š 1 2 3 4 5 6 7 8 9 10 11 inline fun hello4(run1: () -\u0026gt; Unit, crossinline run: () -\u0026gt; Unit) { run1() hello5 { run() } println(\u0026#34;hello4åç»­ä»£ç \u0026#34;) } fun hello5(run: () -\u0026gt; Unit) { run() println(\u0026#34;hello5åç»­ä»£ç \u0026#34;) } ä¸Šé¢æˆ‘å°†hello4ä¸­çš„runè¡¨è¾¾å¼ä¼ ç»™äº†hello5ï¼Œè€Œhello5ä¸æ˜¯ä¸€ä¸ªå†…è”å‡½æ•°ï¼Œæ‰€ä»¥æ­¤æ—¶ä¼šæŠŠlambdaä½œä¸ºä¸€ä¸ªå˜é‡ä¼ åˆ°hello5ä¸­ï¼š å¦‚æœæ”¹æˆå¦‚ä¸‹æ–¹å¼ï¼š\n1 2 3 4 5 6 7 8 9 10 11 inline fun hello4(run1: () -\u0026gt; Unit, crossinline run: () -\u0026gt; Unit) { run1() hello5 { run() } println(\u0026#34;hello4åç»­ä»£ç \u0026#34;) } inline fun hello5(run: () -\u0026gt; Unit) { run() println(\u0026#34;hello5åç»­ä»£ç \u0026#34;) } ç›¸å…³æ–‡æ¡£ï¼šhttps://juejin.cn/post/6869954460634841101\njava lambdaå’Œkotlin lambdaåŒºåˆ« åœ¨javaä¸­å¦‚æœä½¿ç”¨åŒ¿åå†…éƒ¨ç±»çš„å½¢å¼ï¼Œåœ¨ç¼–è¯‘æ—¶å®ƒæ˜¯ä¼šå•ç‹¬ç”Ÿæˆä¸€ä¸ªç±»ï¼Œå…¶ä¸­ç±»åæ˜¯ã€Œå¤–éƒ¨ç±»å$index.classã€è¿™ç§å½¢å¼ã€‚å¦‚æœä½¿ç”¨lambdaçš„å½¢å¼ï¼Œå®ƒä¸ä¼šåœ¨ç¼–è¯‘æ—¶å•ç‹¬ç”Ÿæˆä¸€ä¸ªç±»ï¼Œå®ƒæ˜¯æ‰§è¡Œäº†invokedynamicæŒ‡ä»¤ï¼Œåœ¨è¿è¡Œæ—¶åŠ¨æ€ç”Ÿæˆlambdaçš„ç±»ï¼Œå…¶ä¸­ç±»åæ˜¯ã€Œå¤–éƒ¨ç±»å$Lambda$index.classã€è¿™ç§å½¢å¼ã€‚ å‚è€ƒ:https://juejin.cn/post/7004642395060961310 kotlin lambdaå®ƒæ˜¯åœ¨ç¼–è¯‘æ—¶çœ‹æ˜¯å¦éœ€è¦ç”Ÿæˆå•ç‹¬çš„ç±»ï¼Œå¦‚æœæ˜¯å†…è”çš„æ—¶å€™å°±ç›´æ¥å¹³é“ºä»£ç ï¼Œå¦‚æœæ˜¯éå†…è”çš„æ—¶å€™æ‰ç”Ÿæˆå•ç‹¬çš„ç±»ã€‚ åç¨‹æ˜¯æ€ä¹ˆæŒ‚èµ·çš„ï¼Ÿæ€ä¹ˆæ¢å¤çš„ï¼Ÿ é¦–å…ˆæ¯ä¸€ä¸ªåç¨‹ä»£ç å—éƒ½ä¼šè¢«ç¼–è¯‘æˆSuspendLambdaå¯¹è±¡ï¼Œå®ƒä¹Ÿæ˜¯ä¸€ä¸ªContinuationå¯¹è±¡ï¼Œæ¯æ¬¡åœ¨æ‰§è¡Œåˆ°SuspendLambdaçš„resumeæ—¶å€™ï¼Œéƒ½ä¼šå»æ‰§è¡ŒinvokeSuspendæ–¹æ³•ï¼Œè€Œè¯¥æ–¹æ³•é‡Œé¢ä¼šå»æ‰§è¡Œå­åç¨‹ï¼Œå¦‚æœå­åç¨‹è¿”å›SUSPEND_COROUTINEçŠ¶æ€çš„æ—¶å€™ï¼Œçˆ¶åç¨‹çš„resumeæ–¹æ³•ä¼šç›´æ¥returnäº†ã€‚å½“å­åç¨‹æ‰§è¡Œå®Œåï¼Œä¼šé€šçŸ¥çˆ¶åç¨‹ï¼Œæ­¤æ—¶çˆ¶åç¨‹çš„çš„invokeSuspendæ–¹æ³•å†æ¬¡è¢«æ‰§è¡Œï¼Œè€Œæ­¤æ—¶çš„çŠ¶æ€æœºä¼šå‘ç”Ÿå˜åŒ–ï¼Œå¦‚æœæ­¤æ—¶çŠ¶æ€æ¢å¤åï¼Œä¼šæ‰§è¡Œçˆ¶åç¨‹ä¸­çš„Continuationï¼Œä¹Ÿå°±æ˜¯çˆ¶çˆ¶åç¨‹çš„æ‰§è¡Œã€‚ åç¨‹ä¸­çš„dispatheræ˜¯æ€ä¹ˆæŒ‡å®šåœ¨å“ªä¸ªçº¿ç¨‹ä¸Šæ‰§è¡Œçš„ï¼Ÿ é¦–å…ˆdispatherå®ƒæ˜¯CoroutineContextï¼ˆä¸Šä¸‹æ–‡ï¼‰çš„ä¸€éƒ¨åˆ†ï¼Œåœ¨åç¨‹å¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œä¼šå–CoroutineContextä¸­çš„CoroutineDispathceréƒ¨åˆ†ã€‚æ­¤æ—¶ä¼šæ„é€ ä¸€ä¸ªDispathedContinuationå¯¹è±¡ï¼Œå¹¶æŠŠå‰é¢å–åˆ°çš„Dispatherä¼ åˆ°DispathedContinuationä¸­ï¼Œæ­¤æ—¶ä¼šå°†DispathedContinuationæ‰”åˆ°çº¿ç¨‹æ± ä¸­ï¼Œæœ€ç»ˆä¼šæ‰§è¡ŒDispathedContinuationçš„runæ–¹æ³•ï¼Œåœ¨runé‡Œé¢ä¼šæ‰§è¡Œåˆ°SuspendLambdaï¼Œä¹Ÿå°±æ˜¯åç¨‹çš„ä»£ç å—ï¼Œæœ€ç»ˆä¼šæ‰§è¡Œå®ƒçš„invokeSuspendæ–¹æ³•ã€‚æ‰€ä»¥åç¨‹ä»£ç å—ä¸­ä»£ç è¦æ‰§è¡Œåœ¨å“ªä¸ªçº¿ç¨‹æ˜¯åç¨‹ä¸Šä¸‹æ–‡çš„dispatheréƒ¨åˆ†æŒ‡å®šçš„çº¿ç¨‹ã€‚ ç›¸å…³æ–‡æ¡£ï¼šhttps://www.xiangcman.fun/p/%E5%8D%8F%E7%A8%8B%E5%A6%82%E4%BD%95%E5%88%87%E6%8D%A2%E7%BA%BF%E7%A8%8B/\nLinkedListç‰¹æ€§ LinkedListç»§æ‰¿è‡ªDequeï¼Œå®ƒæ˜¯ä¸€ä¸ªåŒç«¯é˜Ÿåˆ—ï¼Œå…è®¸åœ¨é˜Ÿåˆ—çš„ä¸¤ç«¯æ’å…¥å’Œåˆ é™¤å…ƒç´ ã€‚å¯ä»¥ä½œä¸ºæ ˆï¼ˆLIFOï¼‰æˆ–é˜Ÿåˆ—ï¼ˆFIFOï¼‰ä½¿ç”¨ã€‚åŸºäºé“¾è¡¨ï¼ˆåŒå‘é“¾è¡¨ï¼‰å®ç°ï¼Œå¯ä»¥é«˜æ•ˆåœ°æ’å…¥å’Œåˆ é™¤å…ƒç´ ã€‚ offerï¼šç»™é“¾è¡¨å°¾éƒ¨æ’å…¥å…ƒç´ ï¼Œè¿”å›å€¼è¡¨ç¤ºæ˜¯å¦æ’å…¥æˆåŠŸ peekï¼šå–å‡ºå¤´éƒ¨èŠ‚ç‚¹ï¼Œå¦‚æœæ²¡æœ‰åˆ™è¿”å›null pollï¼šå–å‡ºå¤´éƒ¨èŠ‚ç‚¹ï¼Œå¦‚æœæ²¡æœ‰åˆ™è¿”å›nullï¼Œå–å®Œåå¹¶æŠŠå¤´éƒ¨èŠ‚ç‚¹ä»é˜Ÿåˆ—ä¸­ç§»é™¤ removeï¼šç§»é™¤å¤´éƒ¨èŠ‚ç‚¹ï¼Œå¦‚æœæ²¡æœ‰å¤´éƒ¨èŠ‚ç‚¹åˆ™æŠ›å¼‚å¸¸ï¼Œæœ‰çš„è¯ï¼Œåˆ™è¿”å› pushï¼šç»™é“¾è¡¨å¤´éƒ¨æ’å…¥å…ƒç´ ï¼Œæ²¡æœ‰è¿”å›å€¼ popï¼šå’Œremoveä¸€æ ·çš„ï¼Œéƒ½æ˜¯ç§»é™¤å¤´éƒ¨èŠ‚ç‚¹ï¼Œå¦‚æœæ²¡æœ‰å¤´éƒ¨èŠ‚ç‚¹åˆ™æŠ›å¼‚å¸¸ï¼Œæœ‰çš„è¯ï¼Œåˆ™è¿”å›\nå¦‚æœæƒ³å®ç°é˜Ÿåˆ—çš„è¯ï¼Œåˆ™ä½¿ç”¨offerå’Œpollè¿™ä¸€å¯¹æ–¹æ³•ï¼›å¦‚æœæƒ³å®ç°æ ˆçš„è¯ï¼Œå¯ä»¥é€šè¿‡offerLastå’ŒpollLastæ¥å®ç°ï¼Œæˆ–è€…é€šè¿‡offerFirstå’ŒpollFirstæ¥å®ç°ã€‚\nArrayDequeç‰¹æ€§ å®ƒä¹Ÿæ˜¯ç»§æ‰¿è‡ªDequeï¼Œå’ŒLinkedListçš„ç‰¹æ€§ä¸€æ ·çš„ï¼Œåªä¸è¿‡ArrayDequeæ˜¯é€šè¿‡æ•°ç»„å®ç°çš„åŒç«¯é˜Ÿåˆ—ï¼Œå†…éƒ¨ç”¨ä¸€ä¸ªæ•°ç»„æ¥æ”¾æ‰€æœ‰çš„èŠ‚ç‚¹ï¼Œå¹¶ä¸”æœ‰ä¸¤ä¸ªintå€¼ç”¨æ¥å­˜æ”¾å¤´ç»“ç‚¹å’Œå°¾ç»“ç‚¹çš„ç´¢å¼•ã€‚å¹¶ä¸”ArrayDequeå†…éƒ¨çš„é»˜è®¤èŠ‚ç‚¹å®¹é‡æ˜¯16ä¸ªï¼Œä¹Ÿå¯ä»¥åˆå§‹åŒ–å®¹é‡å¤§å°ã€‚\nåŒºåˆ«ï¼šå¦‚æœé¢‘ç¹è¦æ’å…¥å’Œåˆ é™¤æ“ä½œï¼Œé‚£ä¹ˆä½¿ç”¨LinkedListï¼Œå¦‚æœæ˜¯æŸ¥è¯¢æƒ…å†µæ¯”è¾ƒå¤šï¼Œå¯ä»¥ä¼˜å…ˆä½¿ç”¨ArrayDequeã€‚\nPools.Pool 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 class Pools private constructor() { /** * Interface for managing a pool of objects. * * @param T The pooled type. */ interface Pool\u0026lt;T : Any\u0026gt; { /** * @return An instance from the pool if such, null otherwise. */ fun acquire(): T? /** * Release an instance to the pool. * * @param instance The instance to release. * @return Whether the instance was put in the pool. * * @throws IllegalStateException If the instance is already in the pool. */ fun release(instance: T): Boolean } /** * Simple (non-synchronized) pool of objects. * * @param maxPoolSize The maximum pool size * @param T The pooled type. */ open class SimplePool\u0026lt;T : Any\u0026gt;( /** * The max pool size */ @IntRange(from = 1) maxPoolSize: Int ) : Pool\u0026lt;T\u0026gt; { private val pool: Array\u0026lt;Any?\u0026gt; private var poolSize = 0 init { require(maxPoolSize \u0026gt; 0) { \u0026#34;The max pool size must be \u0026gt; 0\u0026#34; } pool = arrayOfNulls(maxPoolSize) } override fun acquire(): T? { if (poolSize \u0026gt; 0) { val lastPooledIndex = poolSize - 1 @Suppress(\u0026#34;UNCHECKED_CAST\u0026#34;) val instance = pool[lastPooledIndex] as T pool[lastPooledIndex] = null poolSize-- return instance } return null } override fun release(instance: T): Boolean { check(!isInPool(instance)) { \u0026#34;Already in the pool!\u0026#34; } if (poolSize \u0026lt; pool.size) { pool[poolSize] = instance poolSize++ return true } return false } private fun isInPool(instance: T): Boolean { for (i in 0 until poolSize) { if (pool[i] === instance) { return true } } return false } } /** * Synchronized pool of objects. * * @param maxPoolSize The maximum pool size * @param T The pooled type. */ open class SynchronizedPool\u0026lt;T : Any\u0026gt;(maxPoolSize: Int) : SimplePool\u0026lt;T\u0026gt;(maxPoolSize) { private val lock = Any() override fun acquire(): T? { synchronized(lock) { return super.acquire() } } override fun release(instance: T): Boolean { synchronized(lock) { return super.release(instance) } } } } å¾ˆæ˜æ˜¾è¿™æ˜¯ä¸€ä¸ªå¯¹è±¡æ± ï¼ŒSimplePoolç»§æ‰¿è‡ªPoolï¼Œå¹¶ä¸”å¯ä»¥æŒ‡å®šå¯¹è±¡æ± çš„å¤§å°ã€‚æ¯æ¬¡è¦å›æ”¶çš„æ—¶å€™è°ƒç”¨releaseï¼Œåªæœ‰å½“å‰sizeå°äºå¯¹è±¡æ± æœ€å¤§å®¹é‡çš„æ—¶å€™æ‰èƒ½å›æ”¶ï¼Œæ¯æ¬¡é€šè¿‡acquireæ¥è¿›è¡Œè·å–å¯¹è±¡æ± ä¸­çš„å…ƒç´ ã€‚ å…¶ä¸­åœ¨recyclerviewåŠ¨ç”»ç¯‡ç« ä¸­ï¼Œåˆ†æåˆ°InfoRecordå¯¹è±¡ä¸­ä¼šä½¿ç”¨Pools.SimplePoolï¼ŒInfoRecordå­˜å‚¨çš„æ˜¯ViewHolderåœ¨pre-layouté˜¶æ®µçš„åæ ‡ä¿¡æ¯å’Œpost-layouté˜¶æ®µçš„åæ ‡ä¿¡æ¯ï¼Œä»¥åŠViewHolderçš„flagä¿¡æ¯ã€‚å› ä¸ºViewHolderçš„è¿™äº›ä¿¡æ¯åœ¨åŠ¨ç”»å¤„ç†è¿‡ç¨‹ä¸­ä¼šé¢‘ç¹ä½¿ç”¨ï¼Œæ‰€ä»¥æ­¤å¤„ä½¿ç”¨äº†å¯¹è±¡æ± æ¥ç®¡ç†ã€‚\n","date":"2024-11-04T00:00:00Z","permalink":"https://example.com/p/%E7%AC%94%E8%AE%B0%E6%95%B4%E7%90%86/","title":"ç¬”è®°æ•´ç†"},{"content":"åç¨‹åˆ›å»º demo 1 2 3 4 5 6 7 8 9 10 11 12 suspend { Log.d(TAG, \u0026#34;suspend block:\u0026#34;) \u0026#34;123\u0026#34; }.createCoroutine(object : Continuation\u0026lt;String\u0026gt; { override val context: CoroutineContext get() = EmptyCoroutineContext override fun resumeWith(result: Result\u0026lt;String\u0026gt;) { val value = result.getOrNull() Log.d(TAG, \u0026#34;resumeWith:$value\u0026#34;) } }).resume(Unit) Log.d(TAG, \u0026#34;onCreate\u0026#34;) ä¸Šé¢æ—¥å¿—å…ˆæ‰“å°suspendä¸­çš„ä»£ç å—ï¼Œç„¶åæ‰§è¡ŒContinuationçš„resumeWithï¼Œæœ€åæ‰§è¡Œä¸»çº¿ç¨‹çš„ä»£ç ã€‚\ncreateCoroutine æ˜¯æŒ‚èµ·å‡½æ•°çš„æ‰©å±•æ–¹æ³•ï¼Œæ–¹æ³•å‚æ•°æ˜¯Continuationç±»å‹ï¼Œå¯¹åº”ä¸Šé¢çš„åŒ¿åå†…éƒ¨ç±»ã€‚åˆ›å»ºäº†ä¸€ä¸ªSafeContinuationå¯¹è±¡ï¼Œå®ƒä¹Ÿæ˜¯ä¸€ä¸ªContinuationç±»å‹ï¼Œå¹¶ä¼ é€’ä¸¤ä¸ªå‚æ•°ã€‚\nresume resumeæ–¹æ³•ä¼šè°ƒç”¨resumeWithï¼Œçœ‹ä¸‹SafeContinuationçš„resumeWithæ–¹æ³•ï¼š æ­¤å¤„æé†’ä¸‹ï¼Œkotlinçš„æºç éœ€è¦åˆ°å¯¹åº”çš„** Jvmç±»ä¸‹æ‰¾ï¼Œè¦ä¸ç„¶æ–¹æ³•åªæ˜¯ä¸€ä¸ªç”³æ˜ã€‚æ­¤å¤„çš„resultæ˜¯æ„é€ SafeContinuationä¼ é€’è¿›æ¥çš„COROUTINE_SUSPENDEDï¼Œå› æ­¤ä¼šæ‰§è¡Œdelegate.resumeWith(result)ï¼Œæ­¤å¤„çš„delegateæ˜¯createCoroutineUnintercepted(completion).intercepted()åˆ›å»ºçš„ã€‚\ncreateCoroutineUnintercepted å®ƒæ˜¯æŒ‚èµ·å‡½æ•°çš„æ‰©å±•æ–¹æ³•ï¼š\nåˆ¤æ–­å½“å‰æŒ‚èµ·å‡½æ•°æ˜¯ä¸æ˜¯BaseContinuationImplç±»å‹ï¼Œå¦‚æœæ˜¯åˆ™è°ƒç”¨createæ–¹æ³•ã€‚\næ­¤æ—¶å¯ä»¥æ‰“å¼€å­—èŠ‚ç ï¼Œçœ‹ä¸‹ä¸Šé¢çš„(suspend () -\u0026gt; T)æ˜¯ä»€ä¹ˆå¯¹è±¡ï¼Ÿ\nå¯ä»¥çœ‹åˆ°createCoroutineæ–¹æ³•ä¼ å…¥äº†ä¸¤ä¸ªå‚æ•°ï¼Œæˆ‘ä»¬éƒ½çŸ¥é“æ‰©å±•å‡½æ•°æœ€ç»ˆç¼–è¯‘å‡ºæ¥çš„æ–¹æ³•ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯è¢«æ‰©å±•å¯¹è±¡ï¼Œæ‰€ä»¥æ­¤å¤„çš„CoroutineActivity$onCreate$1å°±æ˜¯(suspend () -\u0026gt; T)ï¼ŒCoroutineActivity$onCreate$2å¯¹åº”çš„æ˜¯ä¾‹å­ä¸­çš„ContinuationåŒ¿åå†…éƒ¨ç±»ã€‚æˆ‘ä»¬æ³¨æ„ä¸‹ï¼Œæ­¤æ—¶ä¼ å…¥CoroutineActivity$onCreate$1ä¸­çš„Continuationå‚æ•°æ˜¯nullã€‚\nè€ŒSuspendLambdaçš„ç»§æ‰¿å…³ç³»å¦‚ä¸‹ï¼š\næ‰€ä»¥ä¼šè°ƒç”¨æŒ‚èµ·å‡½æ•°çš„createæ–¹æ³•ï¼š\nçˆ¶ç±»ä¸­è¦æ±‚å­ç±»å¿…é¡»é‡å†™è¯¥æ–¹æ³•ï¼Œæˆ‘ä»¬çœ‹CoroutineActivity$onCreate$1çš„createæ–¹æ³•ï¼š\næ­¤æ—¶é‡æ–°newäº†ä¸€ä¸ªCoroutineActivity$onCreate$1ï¼Œå¹¶æŠŠcompletionä¼ å…¥å…¶ä¸­ï¼Œè€Œæ­¤å¤„çš„completionå°±æ˜¯ä¸Šé¢çš„CoroutineActivity$onCreate$2ï¼Œå®ƒæ˜¯ä¸€ä¸ªContinuationã€‚è€Œå¼€ç«¯åœ¨åˆ†æcreateCoroutineçš„æ—¶å€™ï¼Œåˆ›å»ºCoroutineActivity$onCreate$1ä¼ å…¥çš„Continuationæ˜¯nullã€‚\nä¸å¤ªæ˜ç™½ï¼Œä¸ºä»€ä¹ˆä¸åœ¨createCoroutineæ—¶å€™ç›´æ¥ç›´æ¥æŠŠCoroutineActivity$onCreate$2ä¼ å…¥åˆ°CoroutineActivity$onCreate$1ä¸­ï¼Œè€Œéè¦é€šè¿‡createæ–¹æ³•å†åˆ›å»ºä¸€ä¸ªCoroutineActivity$onCreate$1ã€‚\næˆ‘ä»¬å†æ¥çœ‹interceptedæ–¹æ³•ã€‚\nintercepted æ˜¯Continueationçš„æ‰©å±•æ–¹æ³•ï¼Œå½“ç„¶äº†ï¼Œåˆšåˆšcreateåˆ›å»ºçš„CoroutineActivity$onCreate$1æ˜¯ä¸€ä¸ªsuspendLambdaå¯¹è±¡ï¼Œæ‰€ä»¥å®ƒä¹Ÿæ˜¯ContinueationImplï¼Œæ‰€ä»¥ä¼šèµ°ContinueationImplçš„interceptedæ–¹æ³•ï¼š\næ­¤å¤„çœ‹contextä¸­æœ‰æ²¡æœ‰ContinuationInterceptorç±»å‹çš„Elementï¼Œå¦‚æœæ²¡æœ‰åˆ™è¿”å›è‡ªå·±ï¼Œæˆ‘ä»¬åªè¦çŸ¥é“å…ˆè¿”å›è‡ªå·±ã€‚å› ä¸ºè¿™ä¸ªæ¶‰åŠåˆ°contextçš„ç»“æ„ï¼Œåé¢å†è®²ã€‚\nå°èŠ‚ï¼š â‘ ã€createCoroutineåˆ›å»ºäº†ä¸€ä¸ªSafeContinuationï¼Œå¹¶æŠŠCoroutineActivity$onCreate$1å’Œä¸€ä¸ªæ ‡å¿—ä½COROUTINE_SUSPENDEDä¼ å…¥å…¶ä¸­ã€‚CoroutineActivity$onCreate$1ç»§æ‰¿è‡ªSuspendLambdaï¼Œå¹¶ä¸”æ˜¯ä¸€ä¸ªFunctionæ¥å£çš„å®ä¾‹ã€‚SuspendLambdaç»§æ‰¿è‡ªContinuationImplï¼ŒContinuationImplç»§æ‰¿è‡ªBaseContinuationImplï¼ŒBaseContinuationImplç»§æ‰¿è‡ªContinuationï¼ŒCoroutineActivity$onCreate$1ç»§æ‰¿è‡ªSuspendLambdaï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢çš„åæˆè¦æ‰§è¡Œçš„é—­åŒ…ã€‚CoroutineActivity$onCreate$1æŒæœ‰äº†CoroutineActivity$onCreate$2ï¼Œå®ƒå®ç°äº†Continuationã€‚CoroutineActivity$onCreate$1é‡å†™äº†createæ–¹æ³•ï¼Œè¿”å›äº†ä¸€ä¸ªæ–°çš„CoroutineActivity$onCreate$1å¯¹è±¡ã€‚ â‘¡ã€resumeæ–¹æ³•ä¸­ä¼šè°ƒç”¨åˆ°SafeContinuationçš„resumeWithæ–¹æ³•ï¼Œæœ€ç»ˆä¼šè§¦å‘CoroutineActivity$onCreate$1çš„resumeWithæ–¹æ³•ã€‚\nåç¨‹æ‰§è¡Œ CoroutineActivity$onCreate$1ç»§æ‰¿è‡ªSuspendLambdaï¼Œæœ€ç»ˆä¼šç»§æ‰¿è‡ªBaseContinuationImplï¼Œæ¥çœ‹ä¸‹å®ƒçš„resumeWithï¼š\nresumeWithä¸­é¦–å…ˆè°ƒç”¨invokeSuspendæ–¹æ³•ï¼Œå¦‚æœinvokeSuspendæ–¹æ³•è¿”å›COROUTINE_SUSPENDEDï¼Œåˆ™resumeWithç›´æ¥ä¸å¾€ä¸‹æ‰§è¡Œã€‚å¦åˆ™çœ‹comppletionæ˜¯ä¸æ˜¯BaseContinuationImplï¼Œæ˜¯çš„è¯ï¼Œåˆ™ç»§ç»­è½®è®­ï¼Œç›´åˆ°comppletionä¸æ˜¯BaseContinuationImplï¼Œåˆ™æ‰§è¡Œå®ƒçš„resumeWithæ–¹æ³•ã€‚æ­¤å¤„çš„completionå®é™…æ˜¯CoroutineActivity$onCreate$2ï¼Œæ‰€ä»¥ä¼šæ‰§è¡Œå®ƒçš„resumeWithæ–¹æ³•ã€‚æˆ‘ä»¬çœ‹ä¸‹CoroutineActivity$onCreate$1çš„invokeSuspendæ–¹æ³•ï¼š\nå®ƒçš„è¿”å›å€¼ä¸æ˜¯COROUTINE_SUSPENDEDï¼Œæ‰€æœ‰ä¸Šé¢çš„invokeSuspendæ–¹æ³•è¿˜ä¼šç»§ç»­å¾€ä¸‹æ‰§è¡Œã€‚æ‰€ä»¥æœ€ç»ˆä¼šæ‰§è¡Œäº†CoroutineActivity$onCreate$2ï¼Œä¹Ÿå°±æ˜¯ä¾‹å­ä¸­çš„åŒ¿åå†…éƒ¨ç±»çš„resumeWithæ–¹æ³•ã€‚\næ­¤æ—¶æˆ‘ä»¬å†åˆ†æä¾‹å­ä¸­æ—¥å¿—çš„æ‰“å°ï¼š\nå¯ä»¥çœ‹åˆ°æ‰§è¡ŒSafeContinuationçš„resumeWithçš„æ—¶å€™æ˜¯ä¸€ä¸ªwhile(true)ï¼Œä¼ å…¥çš„this.resumeæ˜¯ä¸€ä¸ªCOROUTINE_SUSPENDEDæ ‡å¿—ä½ï¼Œæ‰€ä»¥ä¼šæŠŠCoroutineActivity$onCreate$1çš„resumeWithæ‰§è¡Œå®Œåï¼Œæ‰è·³å‡ºwhileå¾ªç¯ã€‚å› æ­¤æ—¥å¿—æœ€åè¾“å‡ºåæˆå¤–çš„ä»£ç ã€‚\nç±»å›¾æ€»ç»“ æœ€åè¾“å‡ºæ­¤æ¬¡çš„ç±»å›¾ç»“æ„ï¼Œä»¥ä½œå›é¡¾ï¼š\n","date":"2024-11-02T00:00:00Z","image":"https://example.com/p/android-%E5%8D%8F%E7%A8%8B%E5%90%AF%E5%8A%A8%E5%88%B0%E6%89%A7%E8%A1%8C/cover_hu17536845123992820283.jpg","permalink":"https://example.com/p/android-%E5%8D%8F%E7%A8%8B%E5%90%AF%E5%8A%A8%E5%88%B0%E6%89%A7%E8%A1%8C/","title":"Android åç¨‹å¯åŠ¨åˆ°æ‰§è¡Œ"},{"content":"Bytecode-viewer ä¸€æ¬¾æŸ¥çœ‹classæ–‡ä»¶çš„å·¥å…·\nä½¿ç”¨ï¼š ç›®å½•å®šä½åˆ°è¯¥jaråŒ…ä¸‹é¢ï¼Œç„¶åä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ï¼š\njava -jar Bytecode-Viewer-2.12.jar\nshè„šæœ¬æ‰§è¡Œæ–‡ä»¶ï¼š Bytecode-Viewer.sh\nè„šæœ¬æ–‡ä»¶ï¼š\nBytecode-Viewer-2.12.jar\næ¥æº:https://github.com/Konloch/bytecode-viewer\nRectangleçª—å£å¤§å°è°ƒæ•´ Rectangleæ˜¯ä¸€ä¸ªåœ¨macä¸ŠåŠ¨æ€è°ƒæ•´åº”ç”¨çª—å£çš„å·¥å…·ï¼Œæ¯”å¦‚æˆ‘æƒ³åœ¨å±å¹•ä¸ŠåŒæ—¶å±•ç¤ºå¤šä¸ªåº”ç”¨ï¼Œè¿™ä¸ªå·¥å…·ä½¿ç”¨ä¸Šéå¸¸å¥½ç”¨ã€‚ Rectangleä¸‹è½½ Alfredå·¥å…· Alfredæ˜¯ä¸€æ¬¾åœ¨macä¸Šå…¨å±€æœç´¢çš„å·¥å…·ï¼Œèƒ½æŒ‡å®šæœç´¢æ–‡ä»¶ã€æ–‡ä»¶å¤¹ã€åº”ç”¨çš„ä¸€æ¬¾å·¥å…·ã€‚ å»ºè®®ä½ åœ¨è®¾ç½®ä¸­å°†è¦æœç´¢çš„æ–‡ä»¶ç±»å‹ç»™å‹¾é€‰ä½ï¼š å…³äºæ›´å¤šä½¿ç”¨çœ‹å®˜ç½‘ï¼Œæˆ‘çš„å¿«æ·é”®æ˜¯åŒå‡»commandï¼š åŠ¨ç”»å·®å€¼å™¨ åœ¨çº¿é¢„è§ˆï¼šhttps://inloop.github.io/interpolator/\n","date":"2024-11-02T00:00:00Z","permalink":"https://example.com/p/%E5%B7%A5%E5%85%B7%E6%95%B4%E7%90%86/","title":"å·¥å…·æ•´ç†"},{"content":"ç±»å›¾ Contextåˆ›å»º Activityç»§æ‰¿è‡ªContextThemeWrapperï¼ŒContextThemeWrapperç»§æ‰¿è‡ªContextWrapperï¼Œå½“activityåˆ›å»ºçš„ä¹‹å‰ï¼Œä¼šå…ˆåˆ›å»ºcontextimpl ActivityThread.performLaunchActivity\næ¥ç€ä¼šè°ƒç”¨contextimplçš„setOuterContextï¼Œä¼ å…¥çš„æ˜¯activityã€‚\nç»“è®ºï¼šcontextImplä¸­çš„outerContextæŒ‡å‘äº†activityã€‚\nContextä¼ é€’ attachè°ƒç”¨äº†attachBaseContextï¼Œå¹¶æŠŠcontextimplä¼ è¿›å»äº†ï¼š\nè¯¥æ–¹æ³•æ˜¯ContextWrapperä¸­çš„æ–¹æ³•ï¼Œå¹¶æŒ‡å‘äº†mBaseå˜é‡ã€‚Activityä¸­getBaseContextå’ŒgetApplicationContextåŒºåˆ«ï¼š\ngetBaseContextæŒ‡å‘äº†åˆšåˆšattachæ–¹æ³•ä¼ è¿›æ¥çš„contextimplã€‚\næŒ‡å‘äº†mBase.getApplicationContextï¼š\nmPackageInfoæ˜¯åœ¨åˆ›å»ºcontextimplçš„æ—¶å€™ä¼ å…¥çš„ï¼Œå®ƒæ˜¯loadedApkå¯¹è±¡ï¼Œå®ƒçš„getApplicationæ–¹æ³•æ˜¯è·å–åº”ç”¨çš„Applicationå¯¹è±¡ï¼š\nç»“è®ºï¼šgetBaseContextè·å–çš„æ˜¯contextimplå¯¹è±¡ï¼ŒgetApplicationContextè·å–çš„æ˜¯Applicationå¯¹è±¡ã€‚\nä¸»é¢˜è®¾ç½® å›åˆ°performLaunchActivityï¼Œç»™activityè®¾ç½®ä¸»é¢˜ï¼š\nå°†themeçš„residä¼ è¿›æ¥ï¼Œæœ€ç»ˆä¼šæŠŠresidè¿™ä¸ªthemeè¿½åŠ åˆ°mThemeä¸Šã€‚è¿™é‡Œç‰µæ‰¯åˆ°èµ„æºåŠ è½½ï¼Œåé¢å†è¯´ã€‚\nLayoutInflaterä¸­çš„context LayoutInflater.from(context)ï¼š æ­¤å¤„çš„contextä¸€èˆ¬æ˜¯activityï¼Œçœ‹activity.getSystemServiceæ–¹æ³•ï¼Œå¦‚æœä¼ å…¥çš„ä¸æ˜¯activityï¼Œæ¯”å¦‚æ˜¯ContextThemeWrapperï¼ŒApplicationä¼šæ€ä¹ˆæ ·ï¼š\né€šè¿‡baseè°ƒç”¨getSystemServiceï¼Œè€Œbaseå…¶å®ä¹Ÿæ˜¯activityã€‚Applicationæ˜¯ç»§æ‰¿è‡ªContextWrapperï¼š\nbaseæ˜¯contextimplï¼Œæœ€ç»ˆè°ƒç”¨çš„æ˜¯contextimplçš„getSystemServiceï¼Œactivityäº¦æ˜¯å¦‚æ­¤ï¼š\nä»SYSTEM_SERVICE_FETCHERSä¸­è·å–ï¼š\næœ€ç»ˆæ˜¯åœ¨æ­¤å¤„æ·»åŠ äº†ä¸€ä¸ªPhoneLayoutInflaterå¯¹è±¡ï¼Œå¹¶æŠŠcontextimpl.getOuterContextä¼ è¿›å»äº†ï¼Œæ­¤å¤„ä¼ è¿›å»çš„æ˜¯Activityå¯¹è±¡ã€‚\nlayoutinflater.inflate: æ­¤è¿‡ç¨‹è°ƒç”¨createViewFromTagæ¥åˆ›å»ºviewï¼š\næ­¤å¤„çœ‹viewæœ‰æ²¡æœ‰themeå±æ€§ï¼Œæœ‰çš„è¯ï¼Œåˆ™æ„é€ ä¸€ä¸ªcontextthemeWrapperå‡ºæ¥ï¼Œä¸¾ä¸ªä¾‹å­ï¼š\næ­¤å¤„å®šä¹‰äº†ä¸€ä¸ªthemeå±æ€§ï¼Œé‚£ä¹ˆç»™è¯¥viewçš„æ„é€ å™¨ä¼ å…¥çš„contextå°±æ˜¯ä¸€ä¸ªcontextThemeWrapperå¯¹è±¡ã€‚\nåœ¨fromæ–¹æ³•é‡Œé¢ï¼Œä¼ å…¥ä¸€ä¸ªcontextthemewrapperå¯¹è±¡ï¼Œå¹¶æºå¸¦ä¸€ä¸ªstyleã€‚æ ¹æ®ä¸Šé¢åˆ†æfromæ–¹æ³•æ—¶ï¼Œcontextthemewrapperæ˜¯é€šè¿‡base.getSystemServiceã€‚æ­¤å¤„çš„baseåˆæ˜¯activityï¼Œåˆå› ä¸ºactivity.getSystemServiceï¼Œè°ƒç”¨base.getSystemServiceï¼Œæ‰€ä»¥æœ€ç»ˆåˆå›åˆ°äº†contextimpl.getSystemServiceã€‚è€Œåœ¨åˆ›å»ºPhoneLayoutInflaterçš„æ—¶å€™ï¼Œåˆé€šè¿‡contextimpl.getOuterContextä¼ å…¥åˆ°PhoneLayoutInflateræ„é€ å™¨ä¸­ï¼Œä½†æ˜¯åœ¨contextthemewrapperä¸­æœ€ååˆè°ƒäº†PhoneLayoutInflaterçš„cloneInContextï¼š\næ‰€ä»¥æ­¤ç§æƒ…å†µä¸‹ï¼Œæœ€ç»ˆç»™viewä¼ çš„contextä¹Ÿæ˜¯ä¸€ä¸ªcontextthemewrapperçš„contextã€‚\nAttréƒ¨åˆ† ä»ä¸»é¢˜ä¸­è·å–å±æ€§ï¼š\næœ€ç»ˆè¿™äº›å±æ€§æ˜¯é€šè¿‡contextçš„obtainStyledAttributesè·å–å±æ€§å€¼ã€‚å¸¸è§çš„æ–¹æ³•æ˜¯ï¼š\nAttributeSetè¡¨ç¤ºæ‰€æœ‰çš„å±æ€§é›†ï¼Œå®ƒæ˜¯åœ¨inflateè¿‡ç¨‹ä¸­è§£æåˆ°viewçš„å±æ€§é›†ã€‚ attrsè¡¨ç¤ºçš„æ˜¯è¦ä»å“ªä¸ªå±æ€§é›†ä¸­å–åˆ°å±æ€§ã€‚ ä¾‹å¦‚ï¼š\nattrsæ–‡ä»¶ä¸­å®šä¹‰ä¸€ä¸ªdeclare-styleableå±æ€§é›†ï¼Œaaptå·¥å…·ä¼šç”Ÿæˆå¯¹åº”çš„R.classï¼Œä½†æ˜¯æ­¤æ—¶æ˜¯ä¸€ä¸ªR.jaræ–‡ä»¶ï¼š\nè¯¥æ–‡ä»¶åœ¨app/build/intermediates/compile_and_runtime_not_namespaced_r_class_jar/debug/R.jarï¼Œåç¼–è¯‘è¯¥jaræ–‡ä»¶ï¼š\næœ€ç»ˆæ‰€æœ‰çš„èµ„æºç±»å‹éƒ½ä¼šç”Ÿæˆä¸€ä¸ªR$**.classçš„ç±»ï¼Œè€ŒR.classå…¶å®æ˜¯ä¸€ä¸ªç©ºå£³ï¼š\nçœ‹åˆšæ‰å®šä¹‰çš„declare-styleableç”Ÿæˆå¦‚ä¸‹ï¼š\nå¹¶ä¸”ä¼šåœ¨R$attr.classä¸‹é¢ä¹Ÿä¼šç”Ÿæˆä¸€ä¸ªä¸¤ä¸ªintå€¼ï¼š\nå¯ä»¥çœ‹å‡ºæ¥ç”Ÿå‡ºæ¥ä¸€ä¸ªR.styleable.TestViewçš„æ•°ç»„å’Œä¸¤ä¸ªintå€¼ï¼Œåˆ†åˆ«æ˜¯R.styleable.TestView_attr1å’ŒR.styleable.TestView_attr2ï¼Œå®ƒä¸¤åˆ†åˆ«ä»£è¡¨TestViewæ•°ç»„çš„ç´¢å¼•ï¼Œè€Œå¯¹åº”çš„å€¼æ˜¯å®šä¹‰åœ¨resource.arscæ–‡ä»¶ä¸­ï¼š\næ‰€ä»¥æœ€ç»ˆå¾—å‡ºç»“è®ºæ˜¯ï¼šé€šè¿‡context.obtainStyledAttributesä¼ å…¥attrbutesetå’Œattrsæ•°ç»„ï¼Œå¾—åˆ°äº†typearrayï¼Œç„¶åé€šè¿‡typearrayçš„ç´¢å¼•å¾—åˆ°æ‰€æœ‰çš„å±æ€§ï¼š\ndefStyleAttrã€defStyleRes æ–°å¢ä¸€ä¸ªä¸åœ¨declare-styleableæ•°ç»„ä¸­çš„attr11ï¼Œè§Ræ–‡ä»¶ï¼š\nåœ¨R.styleableç±»ä¸­æ²¡æœ‰attr11çš„å®šä¹‰ï¼Œå®ƒåœ¨R.attrç±»ä¸­å®šä¹‰äº†ï¼š\nåœ¨ä¸Šé¢å±æ€§ä¸­attr7å’Œattr11æ˜¯å¼•ç”¨ç±»å‹çš„ï¼Œä»–ä»¬å¯ä»¥æŒ‡å‘å¦å¤–ä¸€ä¸ªå¼•ç”¨ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 public class TestView1 extends View { public TestView1(Context context) { this(context, null); } public TestView1(Context context, @Nullable AttributeSet attrs) { this(context, attrs, R.attr.attr11); } public TestView1(Context context, @Nullable AttributeSet attrs, int defStyleAttr) { this(context, attrs, defStyleAttr, R.style.DefStyleRes); } public TestView1(Context context, @Nullable AttributeSet attrs, int defStyleAttr, int defStyleRes) { super(context, attrs, defStyleAttr, defStyleRes); TypedArray ta = context.obtainStyledAttributes(attrs, R.styleable.gui, defStyleAttr, defStyleRes); log(\u0026#34;TypedArray lengthï¼š\u0026#34; + ta.length()); for (int i = 0; i \u0026lt; ta.length(); i++) { int attrIndex = ta.getIndex(i); switch (attrIndex) { case R.styleable.gui_attr1: log(ta.getString(attrIndex)); break; case R.styleable.gui_attr2: log(ta.getString(attrIndex)); break; case R.styleable.gui_attr3: log(ta.getString(attrIndex)); break; case R.styleable.gui_attr4: log(ta.getString(attrIndex)); break; case R.styleable.gui_attr5: log(ta.getString(attrIndex)); break; case R.styleable.gui_attr6: log(ta.getString(attrIndex)); break; case R.styleable.gui_attr7: log(ta.getString(attrIndex)); break; default: break; } } ta.recycle(); } private void log(String msg) { Log.v(getClass().getSimpleName(), \u0026#34;\u0026#34; + msg); } } TestView1ä¸­defStyleAtträ¼ å…¥R.attr.attr11ï¼ŒdefStyleResä¼ å…¥R.style.DefStyleResã€‚ å¸ƒå±€æ–‡ä»¶å¦‚ä¸‹ï¼š\nå…¶ä¸­themeä¸­å¼•ç”¨äº†attr11çš„å¼•ç”¨ï¼Œè€Œthemestyleä¸­å¼•ç”¨äº†attr1-attr4ï¼ŒDefStyleResä¸­ä¹Ÿå¼•ç”¨äº†attr1-attr4ã€‚æ—¥å¿—å¦‚ä¸‹ï¼š\nR.styleable.guiæ€»å…±é•¿åº¦æ˜¯7ï¼Œattr1ç”¨çš„xmlä¸­å®šä¹‰çš„ï¼Œattr2æ˜¯å¸ƒå±€ä¸­å®šä¹‰çš„styleä¸­çš„å±æ€§ï¼Œattr3å’Œattr4å–çš„æ˜¯themeä¸­attr11å®šä¹‰çš„attr3å’Œattr4ï¼Œç”±äºattr5æ²¡æœ‰åœ¨attr11ä¸­çš„styleä¸­å®šä¹‰ï¼Œæ‰€ä»¥å–çš„æ˜¯themeä¸­çš„attr5å±æ€§ã€‚ ä¼˜å…ˆçº§ï¼šå¸ƒå±€ä¸­çš„attr\u0026gt;å¸ƒå±€ä¸­çš„styleä¸­çš„attr\u0026gt;defStyleAtträ¸­çš„attr\u0026gt;themeä¸­çš„attr æ­¤æ—¶æ— è®ºæ€ä¹ˆåœ¨DefStyleResä¸­å®šä¹‰å±æ€§ï¼Œéƒ½ä¸ä¼šåœ¨è¯¥styleé‡Œé¢çš„attrå–å€¼ï¼Œå› ä¸ºæ­¤æ—¶å®šä¹‰äº†defStyleAttr æ­¤æ—¶å¦‚æœå»æ‰defStyleAttrï¼Œåˆ™ä¼šåœ¨DefStyleResä¸­å–å€¼ï¼š\nç»“æœå¦‚ä¸‹ï¼š\næ€»ç»“ï¼šdefStyleAttrå®šä¹‰äº†åï¼ŒdefStyleResä¸­çš„attrå°±ä¸èµ·ä½œç”¨äº†ã€‚\nå‚è€ƒï¼šhttps://blog.csdn.net/GracefulGuigui/article/details/104069265\n","date":"2024-10-25T00:00:00Z","permalink":"https://example.com/p/android-context%E6%80%BB%E7%BB%93/","title":"Android contextæ€»ç»“"}]